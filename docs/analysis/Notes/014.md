⏺ Troubleshooting Session Summary

  Topics Discussed

  Main Issues Addressed:

  - Foreign Key Constraint Violations: Database constraint errors when linking data imports to master flows
  - Missing API Router Warnings: Data Cleansing and Emergency Control routers failing to load at startup
  - Legacy Code Pattern Usage: AI-generated code using deleted repository patterns from July 6, 2025
  - Database ID Architecture: Clarification of multi-ID structure (flow_id vs primary key)
  - Rate Limiting Spam: Excessive LLM initialization logs during module imports

  Components Involved:

  - Master Flow Orchestrator system
  - CrewAI flow state management
  - Data import and field mapping models
  - API v1 routing system
  - Multi-tenant database architecture

  Code Modifications

  1. Foreign Key Constraint Fix

  File: /backend/app/services/data_import/storage_manager.py
  - Lines: 402-421 in update_all_records_with_flow() method
  - Change: Query both id (PK) and flow_id, use PK for foreign key references
  - Purpose: Fix constraint violations by using correct primary key instead of flow_id

  2. Flow Lifecycle Manager

  File: /backend/app/services/flow_orchestration/lifecycle_manager.py
  - Change: Set auto_commit=True in master flow creation
  - Purpose: Ensure immediate transaction commit for foreign key visibility

  3. Data Cleansing Router Import Fixes

  File: /backend/app/api/v1/endpoints/data_cleansing.py
  - Changes:
    - from app.models.user import User → from app.models.client_account import User
    - from app.core.auth import get_current_user → from app.api.v1.auth.auth_utils import get_current_user
    - Removed repository imports, replaced with direct SQLAlchemy queries
  - Purpose: Fix import errors from using non-existent modules

  4. Emergency Router Import Fix

  File: /backend/app/api/v1/endpoints/system/emergency.py
  - Change: from app.core.auth.dependencies import get_current_active_user → from app.api.v1.auth.auth_utils import get_current_active_user
  - Purpose: Correct auth dependency import path

  5. BYPASS_CREWAI Removal

  File: /backend/main.py
  - Lines: 100-102
  - Change: Commented out BYPASS_CREWAI_FOR_FIELD_MAPPING environment variable
  - Purpose: Enable full CrewAI functionality for testing without fallbacks

  6. CLAUDE.md Enhancement

  File: /Users/chocka/CursorProjects/migrate-ui-orchestrator/CLAUDE.md
  - Major additions:
    - Prominent warnings section at top
    - "DELETED CODE" section listing all removed repositories
    - Correct import paths guide
    - Quick reference for AI agents
  - Purpose: Prevent future AI agents from using outdated patterns

  Patterns Identified

  Patterns to Use:

  1. Direct SQLAlchemy Queries:
  from sqlalchemy import select
  from app.models.data_import.core import DataImport

  data_imports = await db.execute(
      select(DataImport).where(DataImport.client_account_id == context.client_account_id)
  )
  2. Correct Import Paths:
    - User model: from app.models.client_account import User
    - Auth utilities: from app.api.v1.auth.auth_utils import get_current_user
  3. Foreign Key References:
    - Always use primary key (id) for foreign key constraints
    - flow_id is for CrewAI operations, not database relationships
  4. Docker-Only Development:
    - All commands via: docker exec migration_backend <command>

  Patterns to Avoid:

  1. Deleted Repository Pattern (removed July 6, 2025):
    - ❌ DataImportRepository, FieldMappingRepository
    - ❌ All V3 API infrastructure
    - ❌ Pseudo-agent patterns
  2. Wrong Import Paths:
    - ❌ from app.models.user import User
    - ❌ from app.core.auth import get_current_user
  3. Local Execution:
    - ❌ Never run Python/Node commands locally
    - ❌ Never install packages locally

  User Preferences and Requirements

  1. No Fallbacks/Shortcuts: User wants to test actual app logic without heuristics or bypasses
  2. Docker-Only Development: All code execution must be in containers
  3. Full CrewAI Functionality: No pseudo-agents or simplified patterns
  4. Testing Focus: Breaking points should be exposed, not masked

  Critical Outcomes and Decisions

  Resolved Issues:

  1. ✅ Foreign key constraint violations fixed
  2. ✅ Data Cleansing and Emergency routers now load successfully
  3. ✅ BYPASS_CREWAI fallback removed
  4. ✅ Import path errors corrected

  Key Discoveries:

  1. AI-Generated Code Issue: The data_cleansing.py file was created on July 11 (5 days after repositories were deleted) with outdated imports
  2. Database Architecture: The system intentionally uses dual IDs (flow_id for CrewAI, id for database PKs)
  3. Rate Limiting Logs: CrewAI initialization creates hundreds of log entries during imports

  Unresolved Issues:

  - Rate limiting spam during startup (cosmetic issue, doesn't affect functionality)

  Lessons Learned

  1. AI Agents Use Stale Context: Claude created code on July 11 using patterns deleted on July 6
  2. Foreign Keys Must Reference PKs: The database schema requires primary keys, not unique columns
  3. Import Errors Cascade: Missing User model import caused both router failures
  4. Documentation Critical: CLAUDE.md needed stronger warnings to prevent pattern reuse

  Next Steps

  1. Monitor for Legacy Pattern Usage: Check any new AI-generated code for deleted repositories
  2. Rate Limiting Investigation: Determine why CrewAI creates hundreds of LLM instances on import
  3. Verify Other Endpoints: Check if other API endpoints have similar import issues
  4. Test Full Discovery Flow: Ensure the foreign key fix works end-to-end
  5. Update AI Context: Ensure all AI agents reference the updated CLAUDE.md before coding