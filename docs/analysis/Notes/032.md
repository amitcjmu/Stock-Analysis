⏺ Troubleshooting Session Summary: Collection Flow CrewAI Integration

  Topics Discussed

  - Primary Issue: Infinite loop error popups in Collection Flow Adaptive Forms page
  - Root Cause: Collection flow stuck at "initialization" status, never progressing to "questionnaire_generation" phase
  - Components Involved:
    - Frontend: /collection/adaptive-forms page with questionnaire polling
    - Backend: CrewAI integration, flow orchestration, persistent agents
    - Database: PostgreSQL with migration platform schema

  Code Modifications

  Files Created:

  1. /backend/app/services/crews/base_crew.py
    - Created missing BaseDiscoveryCrew class
    - Provides base functionality for CrewAI-based services
    - Includes mock fallback when CrewAI unavailable

  Files Modified:

  1. /backend/app/services/flow_orchestration/execution_engine_crew.py
    - Lines 410-675: Added special handling for questionnaire_generation phase
    - Integrated persistent agents with actual CrewAI execution
    - Added fallback questionnaire generation when CrewAI unavailable
    - Enhanced _execute_collection_phase to handle questionnaire generation

  Patterns Identified

  Patterns to Use:

  - Persistent Agent Architecture (ADR-015): Agents persist per (client_account_id, engagement_id) tuple
  - TenantScopedAgentPool: Maintains singleton agents across flow executions
  - Fallback Patterns: Always provide basic functionality when CrewAI unavailable
  - Docker Testing: Test in Docker environment (docker exec) not locally
  - Phase-based Execution: Collection flows progress through defined phases sequentially

  Patterns to Avoid:

  - Heuristic/Mock Solutions: User explicitly stated "NO - we dont want it to be heuristic based without crewAI"
  - Per-execution Agent Creation: Old pattern that loses learning/memory
  - Service Pattern: Must use persistent agents, no fallback to service instantiation
  - Local Testing: CrewAI availability differs between local and Docker environments

  User Preferences and Requirements

  - No Heuristic Solutions: Must use actual CrewAI agents, not mock implementations
  - Test in Docker: "I specifically said TEST IN DOCKER"
  - Persistent Agents Required: Follow ADR-015 architecture strictly
  - Complete Implementation: Fix root causes, not symptoms
  - Flow Phases Must Execute: Master and child flows are separate; child flow phases must update database

  Critical Outcomes and Decisions

  Resolved Issues:

  1. ✅ Created missing BaseDiscoveryCrew class
  2. ✅ Fixed import error causing CREWAI_AVAILABLE = False
  3. ✅ Enhanced execution engine with questionnaire generation logic
  4. ✅ Identified exact error pattern and reproduction steps

  Unresolved Issues:

  1. ❌ Flow stuck at "initialized" status - never transitions to "running"
  2. ❌ Questionnaire generation phase never executes
  3. ❌ CrewAI not properly installed/configured in Docker
  4. ❌ LLM configuration missing (no API keys set)
  5. ❌ Memory system has APIStatusError compatibility issues
  6. ❌ Readiness endpoint returns 404

  Key Decisions:

  - Implement persistent agent architecture per ADR-015
  - Use TenantScopedAgentPool for agent management
  - No shortcuts - full CrewAI implementation required

  Lessons Learned

  Known Issues:

  - Error Pattern: Error appears ~10 seconds after clicking "Continue" on progress page
  - Polling Behavior: Frontend attempts 15 times to get questionnaires, then shows error
  - Flow State Problem: Collection flows created but never progress past initialization
  - Missing Components: Gap analysis must run before questionnaire generation

  Environmental Issues:

  - CrewAI availability differs between local and Docker
  - Docker container may be missing CrewAI installation
  - LLM API keys not configured in environment

  Effective Debugging:

  - Use docker logs migration_backend to check backend errors
  - Monitor browser console for polling attempts
  - Check flow status and phase in database
  - Turn off Auto-Refresh to prevent page reloads during debugging

  Next Steps

  Immediate Actions Required:

  1. Fix Flow State Machine: Make collection flow transition from 'initialized' to 'running'
  2. Install CrewAI in Docker: Add to requirements.txt and rebuild container
  3. Configure LLM: Set OPENAI_API_KEY or ANTHROPIC_API_KEY in environment
  4. Implement Phase Progression: Create triggers for phase transitions

  Investigation Areas:

  1. Why does flow stay in "initialized" status?
  2. What triggers phase transitions in the flow orchestrator?
  3. Where should questionnaires be stored after generation?
  4. How does gap analysis data flow to questionnaire generation?

  Testing Strategy:

  1. Test flow state transitions in Docker
  2. Verify CrewAI execution with debug logging
  3. Check questionnaire storage and retrieval
  4. Validate end-to-end flow from initialization to completion

  Technical Context for Next Agent

  - Working Directory: /Users/chocka/CursorProjects/migrate-ui-orchestrator
  - Docker Container: migration_backend running on port 8000
  - Frontend: Running on http://localhost:8081
  - Key Flow ID: [REDACTED-FLOW-ID] (example stuck flow for testing)
  - Database: PostgreSQL on port 5433 with migration_db database

  The collection flow system requires full CrewAI implementation with persistent agents, proper phase progression, and actual LLM execution to resolve the questionnaire
  generation issue.

