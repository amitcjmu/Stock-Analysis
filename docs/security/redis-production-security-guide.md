# Redis Production Security Configuration Guide

**Project:** AI Force Migration Platform  
**Generated by:** CC DevSecOps Engineer  
**Date:** 2025-08-02  
**Purpose:** Production-ready Redis security implementation guide

## Overview

This guide provides step-by-step instructions for implementing secure Redis configurations for production deployment. All recommendations are based on OWASP Redis Security guidelines and industry best practices.

## Prerequisites

- Docker and Docker Compose installed
- Access to secure secret management system
- SSL certificate generation capability
- Network infrastructure planning completed

## Security Implementation Plan

### Phase 1: Environment Variables and Authentication

#### 1.1 Generate Secure Passwords

Use the provided script to generate cryptographically secure passwords:

```bash
#!/bin/bash
# scripts/generate-redis-passwords.sh

echo "Generating secure Redis passwords..."

# Generate 32-character base64 passwords
export REDIS_PASSWORD="$(openssl rand -base64 32)"
export REDIS_APP_PASSWORD="$(openssl rand -base64 32)"
export REDIS_ADMIN_PASSWORD="$(openssl rand -base64 32)"
export REDIS_CACHE_PASSWORD="$(openssl rand -base64 32)"
export REDIS_FLOW_PASSWORD="$(openssl rand -base64 32)"
export REDIS_SSE_PASSWORD="$(openssl rand -base64 32)"
export REDIS_MONITOR_PASSWORD="$(openssl rand -base64 32)"
export REDIS_BACKUP_PASSWORD="$(openssl rand -base64 32)"

# Generate TLS passwords
export REDIS_TLS_KEY_PASSWORD="$(openssl rand -base64 32)"

echo "Passwords generated successfully."
echo "IMPORTANT: Store these passwords in your secure secret management system!"
echo "NEVER commit these passwords to version control!"

# Optionally save to secure file (ensure proper permissions)
cat > .env.redis.secure << EOF
# Redis Production Passwords - Generated $(date)
# CRITICAL: Store in secure secret management system

REDIS_PASSWORD=${REDIS_PASSWORD}
REDIS_APP_PASSWORD=${REDIS_APP_PASSWORD}
REDIS_ADMIN_PASSWORD=${REDIS_ADMIN_PASSWORD}
REDIS_CACHE_PASSWORD=${REDIS_CACHE_PASSWORD}
REDIS_FLOW_PASSWORD=${REDIS_FLOW_PASSWORD}
REDIS_SSE_PASSWORD=${REDIS_SSE_PASSWORD}
REDIS_MONITOR_PASSWORD=${REDIS_MONITOR_PASSWORD}
REDIS_BACKUP_PASSWORD=${REDIS_BACKUP_PASSWORD}
REDIS_TLS_KEY_PASSWORD=${REDIS_TLS_KEY_PASSWORD}
EOF

chmod 600 .env.redis.secure
echo "Passwords saved to .env.redis.secure (600 permissions)"
```

#### 1.2 Production Environment Variables Template

Create `.env.production.redis` with the following structure:

```bash
# Redis Production Configuration
# Generated by CC DevSecOps Engineer

# =====================================
# REDIS AUTHENTICATION
# =====================================

# Primary Redis instance password
REDIS_PASSWORD=${VAULT_REDIS_PASSWORD}

# Service-specific user passwords
REDIS_APP_PASSWORD=${VAULT_REDIS_APP_PASSWORD}
REDIS_ADMIN_PASSWORD=${VAULT_REDIS_ADMIN_PASSWORD}
REDIS_CACHE_PASSWORD=${VAULT_REDIS_CACHE_PASSWORD}
REDIS_FLOW_PASSWORD=${VAULT_REDIS_FLOW_PASSWORD}
REDIS_SSE_PASSWORD=${VAULT_REDIS_SSE_PASSWORD}
REDIS_MONITOR_PASSWORD=${VAULT_REDIS_MONITOR_PASSWORD}
REDIS_BACKUP_PASSWORD=${VAULT_REDIS_BACKUP_PASSWORD}

# =====================================
# NETWORK SECURITY
# =====================================

# Redis connection configuration
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_DB=0

# TLS/SSL Configuration
REDIS_TLS_ENABLED=true
REDIS_TLS_PORT=6380
REDIS_TLS_CERT_FILE=/certs/redis-server.crt
REDIS_TLS_KEY_FILE=/certs/redis-server.key
REDIS_TLS_CA_FILE=/certs/redis-ca.crt
REDIS_TLS_KEY_PASSWORD=${VAULT_REDIS_TLS_KEY_PASSWORD}

# Client certificate authentication
REDIS_TLS_AUTH_CLIENTS=true
REDIS_TLS_PROTOCOLS=TLSv1.2,TLSv1.3

# =====================================
# PERFORMANCE AND LIMITS
# =====================================

# Connection pool settings
REDIS_MAX_CONNECTIONS=100
REDIS_CONNECTION_TIMEOUT=10
REDIS_SOCKET_TIMEOUT=10
REDIS_RETRY_ON_TIMEOUT=true
REDIS_HEALTH_CHECK_INTERVAL=30

# Memory management
REDIS_MAX_MEMORY=1gb
REDIS_MEMORY_POLICY=allkeys-lru

# =====================================
# MONITORING AND LOGGING
# =====================================

# Security monitoring
REDIS_SECURITY_MONITORING=true
REDIS_ACL_LOG_MAX_LEN=256
REDIS_SLOW_LOG_THRESHOLD=10000
REDIS_SLOW_LOG_MAX_LEN=256

# Audit logging
REDIS_AUDIT_ENABLED=true
REDIS_AUDIT_LOG_FILE=/var/log/redis/redis-audit.log
REDIS_SYSLOG_ENABLED=true
REDIS_SYSLOG_FACILITY=local0

# =====================================
# BACKUP AND PERSISTENCE
# =====================================

# Backup configuration
REDIS_BACKUP_ENABLED=true
REDIS_BACKUP_ENCRYPTION=true
REDIS_BACKUP_ENCRYPTION_KEY=${VAULT_REDIS_BACKUP_ENCRYPTION_KEY}
REDIS_BACKUP_SCHEDULE="0 2 * * *"
REDIS_BACKUP_RETENTION_DAYS=30

# Persistence settings
REDIS_AOF_ENABLED=true
REDIS_RDB_ENABLED=true
REDIS_DATA_DIR=/data/redis

# =====================================
# COMPLIANCE AND GOVERNANCE
# =====================================

# Data classification
REDIS_DATA_CLASSIFICATION=confidential
REDIS_ENCRYPT_SENSITIVE_DATA=true
REDIS_PII_ENCRYPTION_REQUIRED=true

# Compliance flags
REDIS_GDPR_COMPLIANCE=true
REDIS_HIPAA_COMPLIANCE=false
REDIS_SOC2_COMPLIANCE=true
```

### Phase 2: TLS/SSL Certificate Configuration

#### 2.1 Generate TLS Certificates

```bash
#!/bin/bash
# scripts/generate-redis-tls-certs.sh

CERT_DIR="redis/certs"
mkdir -p $CERT_DIR
cd $CERT_DIR

# Generate CA private key
openssl genrsa -out redis-ca.key 4096

# Generate CA certificate
openssl req -new -x509 -days 3650 -key redis-ca.key -out redis-ca.crt \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=Redis-CA"

# Generate server private key
openssl genrsa -out redis-server.key 4096

# Generate server certificate signing request
openssl req -new -key redis-server.key -out redis-server.csr \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=redis-server"

# Generate server certificate
openssl x509 -req -days 365 -in redis-server.csr \
    -CA redis-ca.crt -CAkey redis-ca.key -CAcreateserial \
    -out redis-server.crt

# Generate client private key (for mutual TLS)
openssl genrsa -out redis-client.key 4096

# Generate client certificate signing request
openssl req -new -key redis-client.key -out redis-client.csr \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=redis-client"

# Generate client certificate
openssl x509 -req -days 365 -in redis-client.csr \
    -CA redis-ca.crt -CAkey redis-ca.key -CAcreateserial \
    -out redis-client.crt

# Set proper permissions
chmod 600 *.key
chmod 644 *.crt

# Clean up CSR files
rm *.csr

echo "TLS certificates generated successfully in $CERT_DIR"
echo "IMPORTANT: Secure these certificate files properly!"
```

#### 2.2 Production Redis Configuration with TLS

Update `redis/redis.prod.conf`:

```redis
# Redis Production Configuration with TLS
# Generated by CC DevSecOps Engineer

# =====================================
# NETWORK AND TLS CONFIGURATION
# =====================================

# Disable non-TLS port in production
port 0

# Enable TLS port
tls-port 6379

# TLS certificate configuration
tls-cert-file /certs/redis-server.crt
tls-key-file /certs/redis-server.key
tls-ca-cert-file /certs/redis-ca.crt

# TLS security settings
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphers "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
tls-prefer-server-ciphers yes
tls-session-caching no

# Client certificate authentication (mutual TLS)
tls-auth-clients yes

# Network binding
bind 127.0.0.1 ::1
protected-mode yes

# =====================================
# AUTHENTICATION AND AUTHORIZATION
# =====================================

# Require password authentication
requirepass ${REDIS_PASSWORD}

# Load ACL configuration
aclfile /usr/local/etc/redis/users.acl

# Enhanced ACL logging
acllog-max-len 256

# =====================================
# SECURITY HARDENING
# =====================================

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
rename-command DEBUG ""
rename-command EVAL ""
rename-command SCRIPT ""
rename-command MONITOR ""
rename-command CLIENT ""
rename-command SAVE ""

# Rename admin commands for security obscurity
rename-command SHUTDOWN REDIS_SHUTDOWN_SECURE_PROD
rename-command DEL REDIS_DEL_SECURE_PROD
rename-command BGSAVE REDIS_BGSAVE_SECURE_PROD
rename-command BGREWRITEAOF REDIS_BGREWRITEAOF_SECURE_PROD
rename-command INFO REDIS_INFO_SECURE_PROD
rename-command MEMORY REDIS_MEMORY_SECURE_PROD

# =====================================
# MEMORY AND PERFORMANCE
# =====================================

# Memory management
maxmemory 1gb
maxmemory-policy allkeys-lru

# Connection limits
maxclients 1000
timeout 300
tcp-keepalive 300
tcp-backlog 511

# =====================================
# PERSISTENCE AND BACKUP
# =====================================

# Working directory
dir /data

# RDB snapshots
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# AOF persistence
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes

# =====================================
# LOGGING AND MONITORING
# =====================================

# Logging configuration
loglevel notice
logfile /var/log/redis/redis.log
syslog-enabled yes
syslog-ident redis-prod
syslog-facility local0

# Slow query logging
slowlog-log-slower-than 10000
slowlog-max-len 256

# Latency monitoring
latency-monitor-threshold 100

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =====================================
# REPLICATION AND CLUSTERING
# =====================================

# Replication settings (for future scaling)
repl-diskless-sync no
repl-diskless-sync-delay 5

# Multi-database support
databases 16

# =====================================
# PERFORMANCE TUNING
# =====================================

# Background task frequency
hz 10
dynamic-hz yes

# Active rehashing
activerehashing yes

# =====================================
# COMPLIANCE AND AUDIT
# =====================================

# Enhanced command auditing (use with caution - performance impact)
# Uncomment for high-security environments
# notify-keyspace-events "AKE"

# Data integrity
rdbchecksum yes
```

### Phase 3: Production Docker Configuration

#### 3.1 Secure Docker Compose Configuration

Update `docker-compose.prod.yml` Redis service:

```yaml
# Production Redis Service Configuration
redis:
  image: redis:7-alpine
  container_name: migration_redis_prod
  
  # Network Security
  ports:
    - "127.0.0.1:6379:6379"  # TLS port
  networks:
    - redis_network
  
  # Volume Configuration
  volumes:
    - redis_prod_data:/data
    - ./redis/redis.prod.conf:/usr/local/etc/redis/redis.conf:ro
    - ./redis/users.acl:/usr/local/etc/redis/users.acl:ro
    - ./redis/certs:/certs:ro
    - redis_logs:/var/log/redis
  
  # Environment Variables
  env_file:
    - .env.production.redis
  environment:
    - REDIS_PASSWORD=${REDIS_PASSWORD}
    - REDIS_APP_PASSWORD=${REDIS_APP_PASSWORD}
    - REDIS_ADMIN_PASSWORD=${REDIS_ADMIN_PASSWORD}
    - REDIS_CACHE_PASSWORD=${REDIS_CACHE_PASSWORD}
    - REDIS_FLOW_PASSWORD=${REDIS_FLOW_PASSWORD}
    - REDIS_SSE_PASSWORD=${REDIS_SSE_PASSWORD}
    - REDIS_MONITOR_PASSWORD=${REDIS_MONITOR_PASSWORD}
    - REDIS_BACKUP_PASSWORD=${REDIS_BACKUP_PASSWORD}
  
  # Security Configuration
  security_opt:
    - no-new-privileges:true
    - seccomp:unconfined
  
  # Container hardening
  read_only: false  # Redis needs write access to /data
  tmpfs:
    - /tmp:noexec,nosuid,size=100m
    - /var/run:noexec,nosuid,size=50m
  
  # Resource limits
  deploy:
    resources:
      limits:
        memory: 2G
        cpus: '1.0'
      reservations:
        memory: 1G
        cpus: '0.5'
  
  # Health check
  healthcheck:
    test: ["CMD", "redis-cli", "--tls", "--cert", "/certs/redis-client.crt", "--key", "/certs/redis-client.key", "--cacert", "/certs/redis-ca.crt", "--pass", "${REDIS_PASSWORD}", "ping"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 60s
  
  # Startup command
  command: >
    sh -c "
      echo 'Starting Redis with production security configuration...' &&
      mkdir -p /var/log/redis &&
      chown redis:redis /var/log/redis &&
      chmod 750 /var/log/redis &&
      redis-server /usr/local/etc/redis/redis.conf --aclfile /usr/local/etc/redis/users.acl
    "
  
  # Restart policy
  restart: unless-stopped
  
  # Logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"
  
  # System configuration
  sysctls:
    - net.core.somaxconn=65535
  ulimits:
    memlock: -1
    nofile:
      soft: 65535
      hard: 65535

# Dedicated Redis network
networks:
  redis_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-redis-prod
    ipam:
      config:
        - subnet: 172.21.0.0/16

# Persistent volumes
volumes:
  redis_prod_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${REDIS_DATA_PATH:-./data/redis/prod}
  redis_logs:
    driver: local
```

#### 3.2 Redis Monitoring Service

Add Redis monitoring to production:

```yaml
# Redis Exporter for Prometheus monitoring
redis-exporter:
  image: oliver006/redis_exporter:latest
  container_name: redis_exporter_prod
  
  environment:
    - REDIS_ADDR=rediss://monitor_user:${REDIS_MONITOR_PASSWORD}@redis:6379
    - REDIS_EXPORTER_TLS_CLIENT_CERT_FILE=/certs/redis-client.crt
    - REDIS_EXPORTER_TLS_CLIENT_KEY_FILE=/certs/redis-client.key
    - REDIS_EXPORTER_TLS_CA_CERT_FILE=/certs/redis-ca.crt
    - REDIS_EXPORTER_LOG_FORMAT=json
    - REDIS_EXPORTER_CHECK_KEYS=cache:*,flow:*,agent:*
    - REDIS_EXPORTER_CHECK_SINGLE_KEYS=v1:system:health,v1:system:metrics
  
  ports:
    - "127.0.0.1:9121:9121"
  
  volumes:
    - ./redis/certs:/certs:ro
  
  depends_on:
    redis:
      condition: service_healthy
  
  networks:
    - redis_network
  
  security_opt:
    - no-new-privileges:true
  
  deploy:
    resources:
      limits:
        memory: 256M
        cpus: '0.2'
  
  restart: unless-stopped
  
  logging:
    driver: "json-file"
    options:
      max-size: "5m"
      max-file: "3"
```

### Phase 4: Backup and Recovery Configuration

#### 4.1 Encrypted Backup Script

Create `scripts/backup-redis-secure.sh`:

```bash
#!/bin/bash
# Redis Secure Backup Script
# Generated by CC DevSecOps Engineer

set -euo pipefail

# Configuration
BACKUP_DIR="/backups/redis"
ENCRYPTION_KEY="${REDIS_BACKUP_ENCRYPTION_KEY}"
RETENTION_DAYS="${REDIS_BACKUP_RETENTION_DAYS:-30}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="redis_backup_${TIMESTAMP}.rdb"
ENCRYPTED_FILE="${BACKUP_FILE}.enc"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$BACKUP_DIR/backup.log"
}

log "Starting Redis secure backup..."

# Create Redis snapshot
docker exec migration_redis_prod redis-cli \
    --tls \
    --cert /certs/redis-client.crt \
    --key /certs/redis-client.key \
    --cacert /certs/redis-ca.crt \
    --pass "$REDIS_PASSWORD" \
    REDIS_BGSAVE_SECURE_PROD

# Wait for backup to complete
while [ "$(docker exec migration_redis_prod redis-cli --tls --cert /certs/redis-client.crt --key /certs/redis-client.key --cacert /certs/redis-ca.crt --pass "$REDIS_PASSWORD" REDIS_INFO_SECURE_PROD persistence | grep rdb_bgsave_in_progress:1)" ]; do
    log "Waiting for backup to complete..."
    sleep 5
done

# Copy backup file from container
docker cp migration_redis_prod:/data/dump.rdb "$BACKUP_DIR/$BACKUP_FILE"

# Encrypt backup file
openssl enc -aes-256-cbc -salt -in "$BACKUP_DIR/$BACKUP_FILE" -out "$BACKUP_DIR/$ENCRYPTED_FILE" -pass pass:"$ENCRYPTION_KEY"

# Remove unencrypted backup
rm "$BACKUP_DIR/$BACKUP_FILE"

# Verify backup integrity
if openssl enc -d -aes-256-cbc -in "$BACKUP_DIR/$ENCRYPTED_FILE" -pass pass:"$ENCRYPTION_KEY" | head -c 5 | grep -q "REDIS"; then
    log "Backup integrity verified: $ENCRYPTED_FILE"
else
    log "ERROR: Backup integrity check failed!"
    exit 1
fi

# Clean up old backups
find "$BACKUP_DIR" -name "redis_backup_*.rdb.enc" -mtime +$RETENTION_DAYS -delete

log "Redis secure backup completed successfully: $ENCRYPTED_FILE"
```

#### 4.2 Backup Verification Script

Create `scripts/verify-redis-backup.sh`:

```bash
#!/bin/bash
# Redis Backup Verification Script

BACKUP_FILE="$1"
ENCRYPTION_KEY="${REDIS_BACKUP_ENCRYPTION_KEY}"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <encrypted_backup_file>"
    exit 1
fi

echo "Verifying Redis backup: $BACKUP_FILE"

# Decrypt and verify structure
if openssl enc -d -aes-256-cbc -in "$BACKUP_FILE" -pass pass:"$ENCRYPTION_KEY" | redis-check-rdb; then
    echo "‚úÖ Backup verification successful"
    exit 0
else
    echo "‚ùå Backup verification failed"
    exit 1
fi
```

### Phase 5: Security Monitoring and Alerting

#### 5.1 Security Monitoring Configuration

Create `monitoring/redis-security-rules.yml`:

```yaml
# Redis Security Monitoring Rules
# Generated by CC DevSecOps Engineer

groups:
  - name: redis_security
    rules:
      # Authentication failures
      - alert: RedisAuthenticationFailures
        expr: increase(redis_auth_errors_total[5m]) > 10
        for: 1m
        labels:
          severity: high
          service: redis
        annotations:
          summary: "High number of Redis authentication failures"
          description: "{{ $value }} authentication failures in the last 5 minutes"

      # Connection anomalies
      - alert: RedisConnectionSpike
        expr: redis_connected_clients > 500
        for: 2m
        labels:
          severity: medium
          service: redis
        annotations:
          summary: "Unusual number of Redis connections"
          description: "{{ $value }} active connections (threshold: 500)"

      # Memory usage
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: high
          service: redis
        annotations:
          summary: "Redis memory usage critical"
          description: "Memory usage is {{ $value | humanizePercentage }}"

      # Slow queries
      - alert: RedisSlowQueries
        expr: increase(redis_slowlog_length[10m]) > 50
        for: 1m
        labels:
          severity: medium
          service: redis
        annotations:
          summary: "High number of slow Redis queries"
          description: "{{ $value }} slow queries in the last 10 minutes"

      # TLS certificate expiration
      - alert: RedisTLSCertExpiring
        expr: redis_tls_cert_expiry_days < 30
        for: 1h
        labels:
          severity: high
          service: redis
        annotations:
          summary: "Redis TLS certificate expiring soon"
          description: "Certificate expires in {{ $value }} days"
```

#### 5.2 Log Analysis Configuration

Create `monitoring/redis-log-analysis.yml`:

```yaml
# Redis Log Analysis Configuration
# For use with ELK Stack or similar

input:
  file:
    paths:
      - /var/log/redis/redis.log
      - /var/log/redis/redis-audit.log
    tags: ["redis", "security"]

filter:
  grok:
    patterns:
      # Redis authentication failures
      - pattern: "%{TIMESTAMP_ISO8601:timestamp}.*WRONGPASS invalid username-password pair"
        tag: "auth_failure"
      
      # Redis connection patterns
      - pattern: "%{TIMESTAMP_ISO8601:timestamp}.*Accepted connection.*from %{IP:client_ip}:%{INT:client_port}"
        tag: "connection_accepted"
      
      # Redis command execution
      - pattern: "%{TIMESTAMP_ISO8601:timestamp}.*%{WORD:command} executed by %{WORD:user}"
        tag: "command_execution"

output:
  elasticsearch:
    hosts: ["elasticsearch:9200"]
    index: "redis-security-%{+YYYY.MM.dd}"

alerts:
  - name: "redis_auth_failures"
    condition: "tags:auth_failure AND @timestamp:[now-5m TO now]"
    threshold: 10
    action: "webhook"
    webhook_url: "https://alerts.company.com/redis-security"
```

### Phase 6: Deployment Validation

#### 6.1 Pre-deployment Security Checklist

Create `scripts/validate-redis-security.sh`:

```bash
#!/bin/bash
# Redis Security Validation Script
# Generated by CC DevSecOps Engineer

set -euo pipefail

echo "üîç Redis Security Validation Starting..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Validation results
PASSED=0
FAILED=0

# Function to check validation
check() {
    local description="$1"
    local command="$2"
    
    echo -n "Checking: $description... "
    
    if eval "$command" &>/dev/null; then
        echo -e "${GREEN}PASS${NC}"
        ((PASSED++))
    else
        echo -e "${RED}FAIL${NC}"
        ((FAILED++))
    fi
}

echo "=================================="
echo "ENVIRONMENT VARIABLES VALIDATION"
echo "=================================="

check "REDIS_PASSWORD is set" '[ ! -z "${REDIS_PASSWORD:-}" ]'
check "REDIS_APP_PASSWORD is set" '[ ! -z "${REDIS_APP_PASSWORD:-}" ]'
check "REDIS_ADMIN_PASSWORD is set" '[ ! -z "${REDIS_ADMIN_PASSWORD:-}" ]'
check "REDIS_CACHE_PASSWORD is set" '[ ! -z "${REDIS_CACHE_PASSWORD:-}" ]'
check "REDIS_FLOW_PASSWORD is set" '[ ! -z "${REDIS_FLOW_PASSWORD:-}" ]'
check "REDIS_SSE_PASSWORD is set" '[ ! -z "${REDIS_SSE_PASSWORD:-}" ]'
check "REDIS_MONITOR_PASSWORD is set" '[ ! -z "${REDIS_MONITOR_PASSWORD:-}" ]'
check "REDIS_BACKUP_PASSWORD is set" '[ ! -z "${REDIS_BACKUP_PASSWORD:-}" ]'

echo ""
echo "=========================="
echo "TLS CERTIFICATE VALIDATION"
echo "=========================="

check "Redis CA certificate exists" '[ -f redis/certs/redis-ca.crt ]'
check "Redis server certificate exists" '[ -f redis/certs/redis-server.crt ]'
check "Redis server key exists" '[ -f redis/certs/redis-server.key ]'
check "Redis client certificate exists" '[ -f redis/certs/redis-client.crt ]'
check "Redis client key exists" '[ -f redis/certs/redis-client.key ]'

# Validate certificate expiration
if [ -f redis/certs/redis-server.crt ]; then
    EXPIRY_DATE=$(openssl x509 -enddate -noout -in redis/certs/redis-server.crt | cut -d= -f2)
    EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
    CURRENT_EPOCH=$(date +%s)
    DAYS_UNTIL_EXPIRY=$(( (EXPIRY_EPOCH - CURRENT_EPOCH) / 86400 ))
    
    check "Certificate valid for >30 days" "[ $DAYS_UNTIL_EXPIRY -gt 30 ]"
fi

echo ""
echo "======================="
echo "CONFIGURATION VALIDATION"
echo "======================="

check "Redis production config exists" '[ -f redis/redis.prod.conf ]'
check "Redis ACL config exists" '[ -f redis/users.acl ]'
check "Docker Compose prod config exists" '[ -f docker-compose.prod.yml ]'

# Validate Redis configuration
if [ -f redis/redis.prod.conf ]; then
    check "TLS port configured" 'grep -q "tls-port 6379" redis/redis.prod.conf'
    check "Non-TLS port disabled" 'grep -q "port 0" redis/redis.prod.conf'
    check "Password authentication enabled" 'grep -q "requirepass" redis/redis.prod.conf'
    check "ACL file configured" 'grep -q "aclfile" redis/redis.prod.conf'
    check "Dangerous commands disabled" 'grep -q "rename-command FLUSHALL" redis/redis.prod.conf'
fi

echo ""
echo "==================="
echo "NETWORK VALIDATION"
echo "==================="

if [ -f docker-compose.prod.yml ]; then
    check "Redis port bound to localhost" 'grep -q "127.0.0.1:6379:6379" docker-compose.prod.yml'
    check "Security options configured" 'grep -q "no-new-privileges:true" docker-compose.prod.yml'
    check "Resource limits set" 'grep -q "limits:" docker-compose.prod.yml'
fi

echo ""
echo "====================="
echo "BACKUP VALIDATION"
echo "====================="

check "Backup script exists" '[ -f scripts/backup-redis-secure.sh ]'
check "Backup verification script exists" '[ -f scripts/verify-redis-backup.sh ]'
check "Backup directory writable" '[ -w $(dirname ${BACKUP_DIR:-/tmp}) ]'

echo ""
echo "================="
echo "VALIDATION SUMMARY"
echo "================="

echo "Passed: ${GREEN}$PASSED${NC}"
echo "Failed: ${RED}$FAILED${NC}"

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All security validations passed!${NC}"
    echo "Redis is ready for production deployment."
    exit 0
else
    echo -e "${RED}‚ùå $FAILED security validations failed!${NC}"
    echo "Please fix the failed validations before deployment."
    exit 1
fi
```

#### 6.2 Post-deployment Security Test

Create `scripts/test-redis-security.sh`:

```bash
#!/bin/bash
# Redis Post-deployment Security Test
# Generated by CC DevSecOps Engineer

set -euo pipefail

echo "üîí Testing Redis Security Configuration..."

# Test TLS connection
echo "Testing TLS connection..."
docker exec migration_redis_prod redis-cli \
    --tls \
    --cert /certs/redis-client.crt \
    --key /certs/redis-client.key \
    --cacert /certs/redis-ca.crt \
    --pass "$REDIS_PASSWORD" \
    ping

echo "‚úÖ TLS connection successful"

# Test ACL users
echo "Testing ACL user authentication..."
docker exec migration_redis_prod redis-cli \
    --tls \
    --cert /certs/redis-client.crt \
    --key /certs/redis-client.key \
    --cacert /certs/redis-ca.crt \
    -u app_backend \
    --pass "$REDIS_APP_PASSWORD" \
    ping

echo "‚úÖ ACL user authentication successful"

# Test command restrictions
echo "Testing dangerous command restrictions..."
if docker exec migration_redis_prod redis-cli \
    --tls \
    --cert /certs/redis-client.crt \
    --key /certs/redis-client.key \
    --cacert /certs/redis-ca.crt \
    --pass "$REDIS_PASSWORD" \
    FLUSHALL 2>/dev/null; then
    echo "‚ùå ERROR: FLUSHALL command not properly disabled!"
    exit 1
else
    echo "‚úÖ Dangerous commands properly restricted"
fi

# Test monitoring user permissions
echo "Testing monitoring user permissions..."
docker exec migration_redis_prod redis-cli \
    --tls \
    --cert /certs/redis-client.crt \
    --key /certs/redis-client.key \
    --cacert /certs/redis-ca.crt \
    -u monitoring_service \
    --pass "$REDIS_MONITOR_PASSWORD" \
    REDIS_INFO_SECURE_PROD memory

echo "‚úÖ Monitoring user permissions working"

echo "üîí All security tests passed!"
```

## Deployment Instructions

### Step 1: Generate Certificates and Passwords
```bash
# Generate TLS certificates
chmod +x scripts/generate-redis-tls-certs.sh
./scripts/generate-redis-tls-certs.sh

# Generate secure passwords
chmod +x scripts/generate-redis-passwords.sh
./scripts/generate-redis-passwords.sh
```

### Step 2: Configure Secret Management
```bash
# Store passwords in your secret management system
# Examples for different systems:

# AWS Secrets Manager
aws secretsmanager create-secret --name "redis/passwords" --secret-string file://.env.redis.secure

# HashiCorp Vault
vault kv put secret/redis @.env.redis.secure

# Kubernetes Secrets
kubectl create secret generic redis-passwords --from-env-file=.env.redis.secure
```

### Step 3: Validate Configuration
```bash
# Run security validation
chmod +x scripts/validate-redis-security.sh
./scripts/validate-redis-security.sh
```

### Step 4: Deploy to Production
```bash
# Deploy with production configuration
docker-compose -f docker-compose.prod.yml up -d redis

# Wait for service to be ready
docker-compose -f docker-compose.prod.yml ps redis

# Run post-deployment security tests
chmod +x scripts/test-redis-security.sh
./scripts/test-redis-security.sh
```

### Step 5: Configure Monitoring
```bash
# Deploy monitoring services
docker-compose -f docker-compose.prod.yml --profile monitoring up -d

# Verify monitoring is working
curl -s http://localhost:9121/metrics | grep redis_up
```

## Security Maintenance

### Daily Tasks
- Monitor authentication failure alerts
- Check TLS certificate status
- Review slow query logs
- Verify backup completion

### Weekly Tasks
- Review ACL user permissions
- Analyze security metrics
- Test backup recovery procedures
- Update security patches

### Monthly Tasks
- Rotate Redis passwords
- Review and update ACL configurations
- Conduct security assessments
- Update TLS certificates if needed

### Quarterly Tasks
- Full penetration testing
- Security configuration review
- Disaster recovery testing
- Compliance audit

## Troubleshooting

### Common Issues

1. **TLS Connection Failures**
   ```bash
   # Check certificate validity
   openssl x509 -in redis/certs/redis-server.crt -text -noout
   
   # Verify certificate chain
   openssl verify -CAfile redis/certs/redis-ca.crt redis/certs/redis-server.crt
   ```

2. **ACL Authentication Issues**
   ```bash
   # Check ACL configuration
   docker exec migration_redis_prod redis-cli --tls --cert /certs/redis-client.crt --key /certs/redis-client.key --cacert /certs/redis-ca.crt --pass "$REDIS_PASSWORD" ACL LIST
   ```

3. **Performance Issues**
   ```bash
   # Check slow queries
   docker exec migration_redis_prod redis-cli --tls --cert /certs/redis-client.crt --key /certs/redis-client.key --cacert /certs/redis-ca.crt --pass "$REDIS_PASSWORD" SLOWLOG GET 10
   ```

## Conclusion

This production security guide provides comprehensive Redis security implementation with:

- ‚úÖ Strong authentication and authorization
- ‚úÖ TLS/SSL encryption for data in transit
- ‚úÖ Encrypted backups and secure recovery
- ‚úÖ Network security and isolation
- ‚úÖ Container security hardening
- ‚úÖ Comprehensive monitoring and alerting
- ‚úÖ Security validation and testing

Follow all steps in order and validate each phase before proceeding to deployment. Store all passwords and certificates securely and never commit them to version control.

For questions or additional security requirements, consult your security team and follow your organization's specific security policies.