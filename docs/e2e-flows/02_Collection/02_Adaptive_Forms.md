# Collection Flow: 02 - Adaptive Forms

This document provides a complete, end-to-end data flow analysis for the `Adaptive Forms` page in the Collection phase of the AI Modernize Migration Platform.

**Analysis Date:** 2024-08-01 (Updated)

**Assumptions:**
*   The analysis focuses on the `src/pages/collection/AdaptiveForms.tsx` page and its core hook, `useAdaptiveFormFlow`.
*   The platform operates entirely within a Docker environment.
*   All API calls require authentication and multi-tenant context headers.

---

## 1. Frontend: Components and API Calls

The Adaptive Forms page provides a dynamic, questionnaire-based approach to data collection. It polls the backend for a questionnaire that is generated by a background CrewAI process.

### Key Components & Hooks
*   **Page Component:** `src/pages/collection/AdaptiveForms.tsx`
*   **Core Logic Hook:** `useAdaptiveFormFlow` from `src/hooks/collection/useAdaptiveFormFlow.ts` encapsulates all the logic for managing the adaptive form flow.
*   **API Client:** `collectionFlowApi` from `src/services/api/collection-flow.ts` is used for all API interactions.
*   **UI Components:**
    *   `CollectionPageLayout`: Provides the basic layout for the page.
    *   `AdaptiveFormContainer`: Renders the dynamic form based on the data received from the backend.
    *   `CollectionUploadBlocker`: A UI component that blocks the user from proceeding if there are other incomplete collection flows.

### API Call Summary

| # | Method | Endpoint                                      | Trigger                                   | Description                                      |
|---|--------|-----------------------------------------------|-------------------------------------------|--------------------------------------------------|
| 1 | `GET`  | `/collection/flows/incomplete`                | `useIncompleteCollectionFlows` hook       | Fetches a list of incomplete flows to check for blockers. |
| 2 | `POST` | `/collection/flows`                           | `initializeFlow` in `useAdaptiveFormFlow` | Creates a new collection flow if one doesn't exist. |
| 3 | `GET`  | `/collection/flows/{flow_id}`                 | `initializeFlow` in `useAdaptiveFormFlow` | Fetches the details of an existing flow.         |
| 4 | `GET`  | `/collection/flows/status`                    | `initializeFlow` in `useAdaptiveFormFlow` | Gets the status of the current collection flow.  |
| 5 | `GET`  | `/collection/flows/{flow_id}/questionnaires`  | Polling in `initializeFlow`               | Fetches the adaptive questionnaires for the flow.|
| 6 | `POST` | `/collection/flows/{flow_id}/questionnaires/{questionnaire_id}/submit` | `handleSubmit` in `useAdaptiveFormFlow` | Submits the user's answers to the questionnaire. |
| 7 | `DELETE`| `/collection/flows/{flow_id}`                 | `handleDeleteFlow` in `AdaptiveForms.tsx` | Deletes a collection flow.                       |

---

## 2. Backend, CrewAI, ORM, and Database Trace

The backend for the Adaptive Forms page is responsible for generating the questionnaires in the background, processing the responses, and managing the overall state of the collection flow.

### CrewAI Phase: `QUESTIONNAIRE_GENERATION`

*   **Trigger:** This phase is triggered in the background as part of the `UnifiedCollectionFlow` after the `GAP_ANALYSIS` is complete.
*   **CrewAI Interaction:** A `QuestionnaireGenerator` agent is tasked with creating the `AdaptiveQuestionnaire` based on the identified data gaps.
*   **ORM Layer:**
    *   **Operation:** Creates a new `AdaptiveQuestionnaire` record.
    *   **Model:** `app.models.collection_flow.AdaptiveQuestionnaire`
*   **Database:**
    *   **Table:** `adaptive_questionnaires`
    *   **Query:** `INSERT INTO adaptive_questionnaires (...) VALUES (...);`

### API Endpoint: `POST /flows/{flow_id}/questionnaires/{questionnaire_id}/submit`

*   **FastAPI Route:** `submit_questionnaire_response` function in `collection_crud_update_commands.py`.
*   **CrewAI Interaction:**
    *   **Resume Flow:** This call resumes the `MasterFlow` using the `resume_mfo_flow` utility. The submitted responses are passed as part of the `resume_context`.
    *   **Next Phase:** This triggers the `DATA_VALIDATION` phase of the `UnifiedCollectionFlow`, where CrewAI agents will process and validate the submitted data.
*   **ORM Layer:**
    *   **Operation:** Updates the `responses_collected`, `completion_status`, and `completed_at` fields of the `AdaptiveQuestionnaire` record.
*   **Database:**
    *   **Table:** `adaptive_questionnaires`
    *   **Query:** `UPDATE adaptive_questionnaires SET responses_collected = ?, ... WHERE id = ?;`

---

## 3. End-to-End Flow Sequence: Filling Out an Adaptive Form

1.  **Page Load:** The `AdaptiveForms.tsx` component mounts and calls the `useAdaptiveFormFlow` hook.
2.  **Blocker Check:** The `useIncompleteCollectionFlows` hook is called to check for any other active flows that might block the current one.
3.  **Flow Initialization:** If no `flowId` is in the URL, `initializeFlow` creates a new collection flow via `POST /collection/flows`. The backend starts the flow as a background process.
4.  **Fetch Questionnaires (Polling):** The frontend polls the `GET /collection/flows/{flow_id}/questionnaires` endpoint until the background CrewAI process has generated the questionnaires.
5.  **Render Form:** Once the questionnaires are fetched, the `AdaptiveFormContainer` component renders the dynamic form.
6.  **User Submits Form:** The user fills out the form and clicks "Submit," which triggers the `handleSubmit` function.
7.  **API Call:** A `POST` request is sent to `/collection/flows/{flow_id}/questionnaires/{questionnaire_id}/submit`.
8.  **Backend Processes Responses:** The backend updates the questionnaire record and resumes the background CrewAI flow, which proceeds to the data validation phase.

---

## 4. Troubleshooting Breakpoints

| Breakpoint                        | Diagnostic Check                                                                                               | Platform-Specific Fix                                                                                             |
|-----------------------------------|----------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| **Page is Stuck Loading**         | Check the network tab for polling requests to `/questionnaires`. If these requests are failing or returning empty after a long time, the background process may have failed. | Check the logs for the `migration_backend` container. Look for errors in the `UnifiedCollectionFlow`, specifically in the `GAP_ANALYSIS` or `QUESTIONNAIRE_GENERATION` phases. The new `flow_health_monitor` should also provide insights. |
| **Form Submission Fails**         | Look for errors in the console on the `POST .../submit` call. A 400 error might indicate invalid data, while a 500 error suggests a problem with the backend processing. | Verify that the data being submitted matches the expected format. For backend errors, check the logs to see why the `resume_mfo_flow` call failed. |
| **"Multiple active flows" error** | This error indicates that the database contains more than one non-completed collection flow for the current engagement. | Use the "Manage Flows" button to navigate to the flow management page and delete any unnecessary or stuck flows. If the issue persists, there may be a bug in the flow cleanup logic. |
