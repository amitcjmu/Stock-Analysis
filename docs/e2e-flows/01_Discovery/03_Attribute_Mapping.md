
# E2E Data Flow Analysis: Attribute Mapping

**Analysis Date:** 2025-08-12
**Status:** Enhanced with Critical Attributes Assessment for 6R Migration Readiness

This document provides a complete, end-to-end data flow analysis for the `Attribute Mapping` page, a critical phase in the discovery workflow where AI-powered agents:
1. Suggest mappings between source data and the platform's schema
2. Assess coverage of 22 critical attributes needed for 6R migration decisions
3. Calculate migration readiness scores
4. Recommend optimal migration strategies based on available data

**Core Architecture:**
*   **Persistent Agents (ADR-015):** Field mapping uses persistent, tenant-scoped agents with specialized tools for critical attributes assessment
*   **22 Critical Attributes:** The system evaluates coverage of essential attributes across 4 categories (Infrastructure, Application, Business Context, Technical Debt)
*   **Migration Readiness Scoring:** Calculates readiness scores for each 6R strategy (Rehost, Replatform, Refactor, Rearchitect, Replace, Rewrite)
*   **Orchestrator-Driven Phases:** The entire attribute mapping process is a distinct phase managed by the `MasterFlowOrchestrator`
*   **Phase Controller Execution:** Uses PhaseController to manage phase execution with pause/resume capabilities for user approval
*   **Asynchronous Suggestion & Approval:** The flow first runs in a "suggestions-only" mode to populate the UI, then pauses for user approval

**RECENT ENHANCEMENTS (2025-08-12):**
1. Added Critical Attributes Assessment Tool for evaluating 22 essential migration attributes
2. Implemented Migration Readiness Scorer for 6R strategy recommendations
3. Enhanced field_mapper agent with specialized tools for comprehensive attribute coverage
4. Integrated attribute mapping suggestions that prioritize critical attributes for migration success

---

## 1. Frontend: Review and Approval Interface

The `AttributeMapping` page is a user interface for reviewing, approving, or modifying the field mapping suggestions generated by the backend CrewAI agents.

### Key Components & Hooks
*   **Page Component:** `src/pages/discovery/AttributeMapping/index.tsx`
*   **Core Business Logic:** `src/hooks/discovery/useAttributeMappingLogic.ts`
*   **Flow Detection & State:** `useAttributeMappingFlowDetection` and `useUnifiedDiscoveryFlow` hooks.

### API Call Mapping Table

| #  | HTTP Call                                                           | Trigger                                                        | Key Parameters              | Expected Response                                                             | Current Status |
|----|---------------------------------------------------------------------|----------------------------------------------------------------|-----------------------------|-------------------------------------------------------------------------------|----------------|
| 1  | `GET /api/v1/data-import/latest-import`                             | Page load - gets the latest import for context                | `clientAccountId`, `engagementId` | Latest data import information                                          | ✅ Working     |
| 2  | `GET /api/v1/data-import/flow/{flowId}/import-data`                 | `useAttributeMappingLogic` (after flow detection).             | `flowId`                    | JSON object with import metadata and sample data for the identified flow.     | ✅ Fixed - DiscoveryFlow now created |
| 3  | `GET /api/v1/unified-discovery/flows/active`                                | Page load - gets active discovery flows                        | `clientAccountId`, `engagementId` | Active flows list                                                    | ✅ Working     |
| 4  | `GET /api/v1/data-import/critical-attributes-status`                | Gets field mapping status and critical attributes              | Context headers             | Field mapping analysis and agent insights                                     | ⚠️ Partial - Falls back to re-analysis |
| 5  | `GET /api/v1/agents/discovery/agent-questions?page=attribute_mapping` | Gets agent questions for the page                             | `page` param                | Agent questions for user guidance                                              | ✅ Working     |

---

## 2. Critical Attributes for 6R Migration

The system evaluates 22 critical attributes essential for making informed 6R migration decisions:

### Infrastructure Attributes (6)
- `operating_system_version` - OS and version information
- `cpu_memory_storage_specs` - Hardware specifications
- `network_configuration` - Network setup and connectivity
- `virtualization_platform` - Hypervisor and virtualization details
- `performance_baseline` - Performance metrics and utilization
- `availability_requirements` - SLA and uptime requirements

### Application Attributes (8)
- `technology_stack` - Languages, frameworks, and runtimes
- `architecture_pattern` - Monolithic, microservices, n-tier
- `integration_dependencies` - APIs and service dependencies
- `data_volume_characteristics` - Data size and growth patterns
- `user_load_patterns` - Concurrent users and traffic patterns
- `business_logic_complexity` - Rules and workflow complexity
- `configuration_complexity` - Settings and environment configs
- `security_compliance_requirements` - Regulatory and security needs

### Business Context Attributes (4)
- `business_criticality_score` - Business impact rating
- `change_tolerance` - Maintenance window flexibility
- `compliance_constraints` - Regulatory requirements
- `stakeholder_impact` - Affected teams and departments

### Technical Debt Attributes (4)
- `code_quality_metrics` - Code coverage and quality scores
- `security_vulnerabilities` - Known CVEs and security issues
- `eol_technology_assessment` - End-of-life components
- `documentation_quality` - Documentation completeness

## 3. Backend: Agentic Mapping and Decision-Making

The backend execution is a multi-step process orchestrated by the `MasterFlowOrchestrator`.

### Phase 1: Generating Suggestions with Optimized Persistent Field Mapper

**PERFORMANCE OPTIMIZATION (2025-08-14):** Replaced 3-agent crew with single persistent field_mapper agent, reducing execution time from 86+ seconds to <10 seconds.

1.  **Phase Controller Trigger:** When the discovery flow reaches the `field_mapping_suggestions` phase, the PhaseController executes the field mapping phase.
2.  **Optimized Persistent Agent Execution:**
    *   **NEW:** Uses `PersistentFieldMapping` class instead of creating new crews
    *   Single persistent `field_mapper` agent retrieved from TenantScopedAgentPool
    *   **Performance:** 1-2 LLM calls instead of 8+ sequential calls
    *   **Memory:** Agent accumulates mapping patterns over time for better accuracy
    *   Agent has access to specialized tools:
        - `mapping_confidence_tool` - Standard field mapping confidence scoring
        - `critical_attributes_assessor` - Evaluates coverage of 22 critical attributes
        - `migration_readiness_scorer` - Calculates 6R strategy readiness scores
        - `attribute_mapping_suggester` - Suggests mappings for missing critical attributes
3.  **Direct Agent Execution (No Crew Overhead):**
    *   Agent directly executes mapping task without crew coordination
    *   Uses accumulated memory from past mappings for same tenant
    *   Simple JSON task description with source fields and sample values
    *   Returns structured mapping results with confidence scores
4.  **Critical Attributes Assessment:**
    *   Agent analyzes raw data for coverage of all 22 critical attributes
    *   Calculates migration readiness score (0-100%)
    *   Identifies missing required attributes that block migration
    *   Generates recommendations for data enrichment
5.  **6R Strategy Scoring:**
    *   Calculates readiness scores for each migration strategy
    *   Identifies blockers for complex strategies (Refactor, Rearchitect, Rewrite)
    *   Recommends optimal strategy based on available data
6.  **Phase Result:**
    *   Returns PhaseExecutionResult with `requires_user_input=True`
    *   Includes critical attributes coverage report
    *   Provides migration readiness assessment
7.  **State Update & Pause:**
    *   Suggestions saved to `import_field_mappings` with confidence scores
    *   Critical attributes assessment stored in phase_data
    *   Flow pauses for user review and approval

### Phase 2: Applying User Approval

1.  **Frontend Action:** The user reviews the suggestions in the UI and clicks "Approve Mappings."
2.  **API Call:** The frontend sends a resume request via `/api/v1/master-flows/{flowId}/resume`.
3.  **Flow Resumption:**
    *   The PhaseController resumes from `field_mapping_approval` phase.
    *   User input with approved mappings is provided.
    *   The flow proceeds to `data_cleansing` phase.

### Database Schema

| ORM Model         | PostgreSQL Table            | Relevant Columns                                                                     | Purpose in This Flow                                                                       | Current Status |
|-------------------|-----------------------------|--------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------|----------------|
| `ImportFieldMapping`| `import_field_mappings`     | `source_field`, `target_field`, `confidence_score`, `status`, `master_flow_id` | Stores the suggestions from the agents and tracks user approvals.                           | ✅ Working     |
| `CrewAIFlowStateExtensions`| `crewai_flow_state_extensions` | `flow_id`, `flow_status` (`processing`, `waiting_for_approval`), `current_phase`, `phase_data` | The master record for the flow, used by the orchestrator to manage state.                  | ✅ Working     |
| `DiscoveryFlow`   | `discovery_flows`           | `flow_id`, `data_import_id`, `master_flow_id`, `field_mapping_completed` | Discovery-specific tracking table - part of MFO two-table design                           | ✅ Working     |
| `DataImport`      | `data_imports`              | `id`, `master_flow_id`, `status`                                                    | Links import data to the master flow                                                        | ✅ Working     |

### Migration Readiness Scoring

The system calculates readiness scores for each 6R strategy based on attribute coverage:

| Strategy | Required Attributes | Complexity | Typical Score Adjustment |
|----------|-------------------|------------|------------------------|
| **Rehost** | Basic infrastructure (4+) | Low | +20% (easiest path) |
| **Replatform** | Infrastructure (5+) + basic app | Medium | +10% |
| **Refactor** | Application (6+) + tech debt | High | -10% |
| **Rearchitect** | All application (7+) + dependencies | Very High | -20% |
| **Replace** | Business context (3+) | Variable | Neutral |
| **Rewrite** | All attributes + complete assessment | Highest | -30% |

---

## 4. End-to-End Flow Sequence

### Enhanced Flow with Critical Attributes:
1.  **Backend (Initial Analysis):** 
    - PhaseController executes field mapping phase with persistent field_mapper agent
    - Agent assesses coverage of 22 critical attributes
    - Calculates migration readiness scores for all 6R strategies
    - Generates mapping suggestions prioritizing critical attributes
    - Flow pauses with `waiting_for_approval`
2.  **Frontend (Page Load):** 
    - User sees field mapping suggestions with confidence scores
    - Critical attributes coverage report displayed
    - Migration readiness dashboard shows 6R strategy scores
    - Missing critical attributes highlighted with recommendations
3.  **Frontend (User Action):** 
    - User reviews mappings and critical attributes assessment
    - Can modify mappings to improve coverage
    - Approves mappings with understanding of migration readiness
4.  **Backend (Resumption):** 
    - PhaseController resumes with approved mappings
    - Updates asset records with critical attribute mappings
    - Proceeds to data cleansing with migration context

### MFO Two-Table Design:
- **Master Table** (`crewai_flow_state_extensions`): Stores orchestration state, flow status, and phase data
- **Child Table** (`discovery_flows`): Stores discovery-specific fields like `data_import_id` and phase completion flags
- Both records are created during flow initialization to ensure proper operation

---

## 5. Troubleshooting Breakpoints

| Stage      | Potential Failure Point                                                                                               | Diagnostic Checks                                                                                                                                                                                                                                                                                  |
|------------|-----------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Frontend** | **No Suggestions Shown:** The page loads, but the mapping table is empty. <br/> **"Discovery flow not found" errors:** Multiple API calls fail with flow lookup errors.                                                                  | **Browser DevTools (Network Tab):** Check responses from `/flow/{flowId}/import-data` - returns 200 but with error message about discovery flow not found. The critical-attributes-status endpoint shows fallback behavior. |
| **Backend**  | **DiscoveryFlow lookup fails:** The code looks in wrong table (discovery_flows instead of crewai_flow_state_extensions). <br/> **Multiple fallback attempts:** System tries data_import_id, master_flow_id, and configuration lookups. | **Docker Logs:** See "Discovery flow not found" warnings followed by multiple lookup attempts. <br/> **Database:** Check `crewai_flow_state_extensions` table for the actual flow with given flow_id. The discovery_flows table may be empty or not have matching records. |
| **Database** | **Mappings Not Saved:** The suggestions from the agent crew are not correctly written to the `import_field_mappings` table. | **Direct DB Query:** Connect to the database (`docker exec -it migration_db psql ...`) and run `SELECT * FROM import_field_mappings WHERE data_import_id = 'your-import-id';` to see if the suggestions exist. |

---

## 6. Technical Implementation Details

### Critical Attributes Tool Implementation

The field_mapper agent uses specialized tools to assess critical attributes:

```python
# backend/app/services/crewai_flows/tools/critical_attributes_tool.py
class CriticalAttributesAssessmentTool(BaseTool):
    """Assesses coverage of 22 critical attributes"""
    - Analyzes raw data fields against attribute patterns
    - Calculates coverage percentage and confidence scores
    - Identifies missing required attributes
    - Generates data enrichment recommendations

class MigrationReadinessScoreTool(BaseTool):
    """Calculates 6R strategy readiness scores"""
    - Scores each migration strategy based on attribute coverage
    - Identifies blockers for complex strategies
    - Recommends optimal migration path
    - Provides confidence levels for recommendations

class AttributeMappingSuggestionTool(BaseTool):
    """Suggests mappings for critical attributes"""
    - Maps source fields to critical attributes
    - Prioritizes required attributes
    - Provides confidence scores for suggestions
    - Calculates coverage improvement potential
```

### Persistent Field Mapping Implementation (2025-08-14)

The field mapping phase now uses an optimized persistent agent approach:

```python
# backend/app/services/crewai_flows/crews/persistent_field_mapping.py
class PersistentFieldMapping:
    """Use persistent field_mapper agent for efficient field mapping"""
    
    async def map_fields(self, raw_data: List[Dict[str, Any]]) -> Dict[str, Any]:
        # Get or create persistent field_mapper agent
        agent = await TenantScopedAgentPool.get_or_create_agent(
            client_id=self.client_id,
            engagement_id=self.engagement_id,
            agent_type="field_mapper"
        )
        
        # Direct agent execution (single LLM call)
        result = await self._execute_agent_task(agent, task_description)
        
        # Update agent memory for future reference
        await self._update_agent_memory(agent, headers, mapping_result)
        
        return mapping_result
```

**Performance Improvements:**
- **Before:** 3 agents (Data Analyst, Schema Expert, Synthesis Specialist) with 8+ LLM calls
- **After:** 1 persistent agent with 1-2 LLM calls
- **Execution Time:** 86+ seconds → <10 seconds (94% reduction)
- **Memory:** Agent accumulates mapping patterns over time
- **Fallback:** Automatically falls back to standard crew if persistent agents unavailable

### Agent Tool Distribution

| Agent | Critical Attributes Tools | Purpose |
|-------|-------------------------|---------|
| **field_mapper** | All 3 tools + mapping_confidence_tool | Primary responsibility for attribute assessment |
| **data_analyst** | Assessment tools via validation suite | Can evaluate data quality for attributes |
| **pattern_discovery_agent** | Indirect via asset creation tools | Discovers patterns that map to attributes |

### MFO Two-Table Design Pattern

The Discovery flow follows the Master Flow Orchestrator's two-table design pattern:

1. **Master Flow Creation**: The MasterFlowOrchestrator creates the orchestration record in `crewai_flow_state_extensions`
   ```python
   # In MasterFlowOrchestrator
   flow_result = await orchestrator.create_flow(
       flow_type="discovery",
       configuration=configuration,
       initial_state=initial_state,
       atomic=True
   )
   ```

2. **Child Flow Creation**: The flow-specific service creates the child record in `discovery_flows`
   ```python
   # In FlowTriggerService
   discovery_service = DiscoveryFlowService(db, context)
   await discovery_service.create_discovery_flow(
       flow_id=str(master_flow_id),
       master_flow_id=str(master_flow_id),
       data_import_id=data_import_id,
       raw_data=file_data
   )
   ```

3. **API Data Access**: The import storage handler queries the child table for discovery-specific data:
   ```python
   from app.models.discovery_flow import DiscoveryFlow
   flow_query = select(DiscoveryFlow).where(DiscoveryFlow.flow_id == flow_id)
   ```

### Why Both Tables Are Required

The two-table design serves specific purposes:
- **Master Table**: Generic flow orchestration, status tracking, phase management
- **Child Table**: Flow-type-specific data that doesn't fit the generic model
- **Separation of Concerns**: Keeps the master table clean while allowing flow-specific extensions

### Data Flow for Attribute Mapping

1. **PhaseController** reads from master table for orchestration state
2. **Import Storage Handler** reads from child table for `data_import_id`
3. **Field Mapping Service** reads from `import_field_mappings` using master flow ID
4. **UI Components** combine data from multiple sources for display 