
# E2E Data Flow Analysis: Attribute Mapping

**Analysis Date:** 2025-08-29  
**Status:** Fully Operational - Field mapping approval workflow restored with database schema fixes

This document provides a complete, end-to-end data flow analysis for the `Attribute Mapping` page, a critical phase in the discovery workflow where AI-powered agents:
1. Suggest mappings between source data and the platform's schema
2. Assess coverage of 22 critical attributes needed for 6R migration decisions
3. Calculate migration readiness scores
4. Recommend optimal migration strategies based on available data

**Core Architecture:**
*   **Persistent Agents (ADR-015):** Field mapping uses persistent, tenant-scoped agents with specialized tools for critical attributes assessment
*   **22 Critical Attributes:** The system evaluates coverage of essential attributes across 4 categories (Infrastructure, Application, Business Context, Technical Debt)
*   **Migration Readiness Scoring:** Calculates readiness scores for each 6R strategy (Rehost, Replatform, Refactor, Rearchitect, Replace, Rewrite)
*   **Orchestrator-Driven Phases:** The entire attribute mapping process is a distinct phase managed by the `MasterFlowOrchestrator`
*   **Phase Controller Execution:** Uses PhaseController to manage phase execution with pause/resume capabilities for user approval
*   **Asynchronous Suggestion & Approval:** The flow first runs in a "suggestions-only" mode to populate the UI, then pauses for user approval

**CRITICAL FIXES (2025-08-29):**
1. **‚úÖ Field Mapping Status Issue**: Fixed approved mappings not appearing in "Approved" column
   - **Root Cause**: Frontend transformation functions were hardcoding status as 'pending' instead of using backend response
   - **Database Fix**: Added missing `field_type` and `agent_reasoning` columns via migration 040
   - **Frontend Fix**: Updated `transformToFrontendMapping()` to use actual `status` field from backend
   - **Result**: Approved mappings now properly display in correct UI columns
2. **‚úÖ Backend Enum Casting**: Fixed PostgreSQL enum comparison errors in learned patterns queries
   - **Root Cause**: SQLAlchemy comparing enum columns with string parameters without casting
   - **Fix**: Added `::patterntype` casting and updated model imports to use correct enum types
   - **Result**: Eliminated 500 errors in pattern learning endpoints

**PREVIOUS FIXES (2025-08-19):**
1. Fixed attribute mapping showing 0 fields issue by updating frontend to use Master Flow Orchestrator (MFO) endpoint
2. Eliminated frontend/backend duplication by having frontend use `/api/v1/unified-discovery/flows/{flow_id}/field-mappings`
3. Fixed flow detection to include 'waiting_for_approval' status as active
4. Fixed backend unified-discovery endpoint field names (target_field, confidence_score)
5. Field mappings now correctly show all 9 fields from CSV imports

**PREVIOUS ENHANCEMENTS (2025-08-12):**
1. Added Critical Attributes Assessment Tool for evaluating 22 essential migration attributes
2. Implemented Migration Readiness Scorer for 6R strategy recommendations
3. Enhanced field_mapper agent with specialized tools for comprehensive attribute coverage
4. Integrated attribute mapping suggestions that prioritize critical attributes for migration success

---

## 1. Frontend: Review and Approval Interface

The `AttributeMapping` page is a user interface for reviewing, approving, or modifying the field mapping suggestions generated by the backend CrewAI agents.

### Key Components & Hooks
*   **Page Component:** `src/pages/discovery/AttributeMapping/index.tsx`
*   **Core Business Logic:** `src/hooks/discovery/useAttributeMappingLogic.ts`
*   **Flow Detection & State:** `useAttributeMappingFlowDetection` and `useUnifiedDiscoveryFlow` hooks.

### API Call Mapping Table

| #  | HTTP Call                                                           | Trigger                                                        | Key Parameters              | Expected Response                                                             | Current Status |
|----|---------------------------------------------------------------------|----------------------------------------------------------------|-----------------------------|-------------------------------------------------------------------------------|----------------|
| 1  | `GET /api/v1/unified-discovery/flows/active`                                | Page load - gets active discovery flows (includes 'waiting_for_approval')                       | `clientAccountId`, `engagementId` | Active flows list including paused flows                                                   | ‚úÖ Working     |
| 2  | `GET /api/v1/unified-discovery/flows/{flow_id}/field-mappings`      | `useAttributeMappingLogic` - gets field mappings via MFO endpoint            | `flow_id`                    | Field mappings with target_field and confidence_score for the flow     | ‚úÖ Fixed - Now uses MFO endpoint |
| 3  | `GET /api/v1/data-import/latest-import`                             | Page load - gets the latest import for context                | `clientAccountId`, `engagementId` | Latest data import information                                          | ‚úÖ Working     |
| 4  | `GET /api/v1/data-import/critical-attributes-status`                | Gets field mapping status and critical attributes              | Context headers             | Field mapping analysis and agent insights                                     | ‚ö†Ô∏è Partial - Falls back to re-analysis |
| 5  | `GET /api/v1/agents/discovery/agent-questions?page=attribute_mapping` | Gets agent questions for the page                             | `page` param                | Agent questions for user guidance                                              | ‚úÖ Working     |

---

## 2. Critical Attributes for 6R Migration

The system evaluates 22 critical attributes essential for making informed 6R migration decisions:

### Infrastructure Attributes (6)
- `operating_system_version` - OS and version information
- `cpu_memory_storage_specs` - Hardware specifications
- `network_configuration` - Network setup and connectivity
- `virtualization_platform` - Hypervisor and virtualization details
- `performance_baseline` - Performance metrics and utilization
- `availability_requirements` - SLA and uptime requirements

### Application Attributes (8)
- `technology_stack` - Languages, frameworks, and runtimes
- `architecture_pattern` - Monolithic, microservices, n-tier
- `integration_dependencies` - APIs and service dependencies
- `data_volume_characteristics` - Data size and growth patterns
- `user_load_patterns` - Concurrent users and traffic patterns
- `business_logic_complexity` - Rules and workflow complexity
- `configuration_complexity` - Settings and environment configs
- `security_compliance_requirements` - Regulatory and security needs

### Business Context Attributes (4)
- `business_criticality_score` - Business impact rating
- `change_tolerance` - Maintenance window flexibility
- `compliance_constraints` - Regulatory requirements
- `stakeholder_impact` - Affected teams and departments

### Technical Debt Attributes (4)
- `code_quality_metrics` - Code coverage and quality scores
- `security_vulnerabilities` - Known CVEs and security issues
- `eol_technology_assessment` - End-of-life components
- `documentation_quality` - Documentation completeness

## 3. Backend: Agentic Mapping and Decision-Making

The backend execution is a multi-step process orchestrated by the `MasterFlowOrchestrator`.

### Phase 1: Generating Suggestions with Optimized Persistent Field Mapper

**PERFORMANCE OPTIMIZATION (2025-08-14):** Replaced 3-agent crew with single persistent field_mapper agent, reducing execution time from 86+ seconds to <10 seconds.

1.  **Phase Controller Trigger:** When the discovery flow reaches the `field_mapping_suggestions` phase, the PhaseController executes the field mapping phase.
2.  **Optimized Persistent Agent Execution:**
    *   **NEW:** Uses `PersistentFieldMapping` class instead of creating new crews
    *   Single persistent `field_mapper` agent retrieved from TenantScopedAgentPool
    *   **Performance:** 1-2 LLM calls instead of 8+ sequential calls
    *   **Memory:** Agent accumulates mapping patterns over time for better accuracy
    *   Agent has access to specialized tools:
        - `mapping_confidence_tool` - Standard field mapping confidence scoring
        - `critical_attributes_assessor` - Evaluates coverage of 22 critical attributes
        - `migration_readiness_scorer` - Calculates 6R strategy readiness scores
        - `attribute_mapping_suggester` - Suggests mappings for missing critical attributes
3.  **Direct Agent Execution (No Crew Overhead):**
    *   Agent directly executes mapping task without crew coordination
    *   Uses accumulated memory from past mappings for same tenant
    *   Simple JSON task description with source fields and sample values
    *   Returns structured mapping results with confidence scores
4.  **Critical Attributes Assessment:**
    *   Agent analyzes raw data for coverage of all 22 critical attributes
    *   Calculates migration readiness score (0-100%)
    *   Identifies missing required attributes that block migration
    *   Generates recommendations for data enrichment
5.  **6R Strategy Scoring:**
    *   Calculates readiness scores for each migration strategy
    *   Identifies blockers for complex strategies (Refactor, Rearchitect, Rewrite)
    *   Recommends optimal strategy based on available data
6.  **Phase Result:**
    *   Returns PhaseExecutionResult with `requires_user_input=True`
    *   Includes critical attributes coverage report
    *   Provides migration readiness assessment
7.  **State Update & Pause:**
    *   Suggestions saved to `import_field_mappings` with confidence scores
    *   Critical attributes assessment stored in phase_data
    *   Flow pauses for user review and approval

### Phase 2: Applying User Approval

1.  **Frontend Action:** The user reviews the suggestions in the UI and clicks "Approve Mappings."
2.  **API Call:** The frontend sends a resume request via `/api/v1/master-flows/{flowId}/resume`.
3.  **Flow Resumption:**
    *   The PhaseController resumes from `field_mapping_approval` phase.
    *   User input with approved mappings is provided.
    *   The flow proceeds to `data_cleansing` phase.

### Database Schema

| ORM Model         | PostgreSQL Table            | Relevant Columns                                                                     | Purpose in This Flow                                                                       | Current Status |
|-------------------|-----------------------------|--------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------|----------------|
| `ImportFieldMapping`| `migration.import_field_mappings`     | `source_field`, `target_field`, `confidence_score`, `status`, `master_flow_id`, `field_type`, `agent_reasoning` | Stores the suggestions from the agents and tracks user approvals. **Updated 2025-08-29**: Added missing `field_type` and `agent_reasoning` columns via migration 040 | ‚úÖ Working (Fixed) |
| `CrewAIFlowStateExtensions`| `crewai_flow_state_extensions` | `flow_id`, `flow_status` (`processing`, `waiting_for_approval`), `current_phase`, `phase_data` | The master record for the flow, used by the orchestrator to manage state.                  | ‚úÖ Working     |
| `DiscoveryFlow`   | `discovery_flows`           | `flow_id`, `data_import_id`, `master_flow_id`, `field_mapping_completed` | Discovery-specific tracking table - part of MFO two-table design                           | ‚úÖ Working     |
| `DataImport`      | `data_imports`              | `id`, `master_flow_id`, `status`                                                    | Links import data to the master flow                                                        | ‚úÖ Working     |
| `AgentDiscoveredPattern`| `migration.agent_discovered_patterns` | `pattern_type` (enum), `pattern_name`, `confidence_score`, `insight_type` | Stores learned patterns from AI agents. **Updated 2025-08-29**: Fixed enum casting issues | ‚úÖ Working (Fixed) |

### Migration Readiness Scoring

The system calculates readiness scores for each 6R strategy based on attribute coverage:

| Strategy | Required Attributes | Complexity | Typical Score Adjustment |
|----------|-------------------|------------|------------------------|
| **Rehost** | Basic infrastructure (4+) | Low | +20% (easiest path) |
| **Replatform** | Infrastructure (5+) + basic app | Medium | +10% |
| **Refactor** | Application (6+) + tech debt | High | -10% |
| **Rearchitect** | All application (7+) + dependencies | Very High | -20% |
| **Replace** | Business context (3+) | Variable | Neutral |
| **Rewrite** | All attributes + complete assessment | Highest | -30% |

---

## 4. End-to-End Flow Sequence

### Enhanced Flow with MFO Architecture Fix:
1.  **Backend (Initial Analysis):** 
    - PhaseController executes field mapping phase with persistent field_mapper agent
    - Agent assesses coverage of 22 critical attributes
    - Calculates migration readiness scores for all 6R strategies
    - Generates mapping suggestions prioritizing critical attributes
    - Flow pauses with `waiting_for_approval` status
2.  **Frontend (Page Load - Fixed Architecture):** 
    - Frontend queries active flows including 'waiting_for_approval' status
    - Uses flow_id to call MFO endpoint: `/api/v1/unified-discovery/flows/{flow_id}/field-mappings`
    - Backend returns properly formatted field mappings with target_field and confidence_score
    - All 9 fields from CSV imports now correctly displayed in the UI
    - Critical attributes coverage report displayed
    - Migration readiness dashboard shows 6R strategy scores
3.  **Frontend (User Action):** 
    - User reviews all field mappings (no longer shows 0 fields)
    - Can modify mappings to improve coverage
    - Approves mappings with understanding of migration readiness
4.  **Backend (Resumption):** 
    - PhaseController resumes with approved mappings
    - Updates asset records with critical attribute mappings
    - Proceeds to data cleansing with migration context

### MFO Two-Table Design:
- **Master Table** (`crewai_flow_state_extensions`): Stores orchestration state, flow status, and phase data
- **Child Table** (`discovery_flows`): Stores discovery-specific fields like `data_import_id` and phase completion flags
- Both records are created during flow initialization to ensure proper operation

---

## 5. Troubleshooting Breakpoints

| Stage      | Potential Failure Point                                                                                               | Diagnostic Checks                                                                                                                                                                                                                                                                                  |
|------------|-----------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Frontend (FIXED)** | **‚úÖ Approved Mappings Not Showing:** RESOLVED - Status field was hardcoded as 'pending' instead of using backend response. <br/> **~~No Suggestions Shown~~:** ‚úÖ RESOLVED - The page now correctly loads all field mappings using MFO endpoint. <br/> **~~"Discovery flow not found" errors~~:** ‚úÖ RESOLVED - Frontend now uses proper flow_id with MFO endpoint. | **Browser DevTools (Network Tab):** Check responses from `/api/v1/unified-discovery/flows/{flow_id}/field-mappings` - should return 200 with field mappings showing actual status values ('approved', 'pending', 'rejected'). **Fixed Files**: `src/types/api/discovery/field-mapping-types.ts` and `src/hooks/discovery/attribute-mapping/useFieldMappings.ts` |
| **Backend (FIXED)**  | **‚úÖ Database Column Errors:** RESOLVED - Missing `field_type` and `agent_reasoning` columns in `import_field_mappings` table. <br/> **‚úÖ Enum Casting Errors:** RESOLVED - PostgreSQL enum comparison failing without proper type casting. <br/> **Flow status detection:** Fixed to include 'waiting_for_approval' as active flow status. | **Docker Logs:** Check for 500 errors related to missing columns or enum casting. **Database Schema Check**: `docker exec migration_postgres psql -U postgres -d migration_db -c "SELECT column_name FROM information_schema.columns WHERE table_name = 'import_field_mappings';"` **Fixed Migration**: `040_add_missing_field_mapping_columns.py` |
| **Database** | **‚úÖ Schema Consistency:** RESOLVED - Database table and SQLAlchemy model mismatch for missing columns. <br/> **Mappings Not Saved:** The suggestions from the agent crew are not correctly written to the `import_field_mappings` table. | **Direct DB Query:** `docker exec migration_postgres psql -U postgres -d migration_db -c "SELECT source_field, target_field, status FROM migration.import_field_mappings WHERE client_account_id = '11111111-1111-1111-1111-111111111111';"` **Status Check**: Look for 'approved', 'pending', 'rejected' values in status column. |

---

## 6. Recent Critical Fixes (2025-08-29)

### Field Mapping Status Workflow Fix

**Problem**: Approved field mappings were not appearing in the "Approved" column despite being correctly stored in the database with status 'approved'.

**Root Cause Analysis**:
1. Database correctly stored mappings with status 'approved' after user approval
2. Backend API correctly returned status field from database
3. Frontend transformation functions were hardcoding status as 'pending'/'unmapped' instead of using backend response
4. Missing database columns (`field_type`, `agent_reasoning`) caused backend getattr() calls to fail silently

**Files Modified**:
```
üìÅ backend/
‚îú‚îÄ‚îÄ alembic/versions/040_add_missing_field_mapping_columns.py (NEW)
‚îú‚îÄ‚îÄ app/models/data_import/mapping.py (Updated - Added missing columns)
‚îú‚îÄ‚îÄ app/api/v1/endpoints/unified_discovery/field_mapping_handlers.py (Cleaned up debug logs)
‚îî‚îÄ‚îÄ app/utils/vector_utils.py (Fixed enum casting)

üìÅ frontend/src/
‚îú‚îÄ‚îÄ types/api/discovery/field-mapping-types.ts (Fixed transformToFrontendMapping status)
‚îî‚îÄ‚îÄ hooks/discovery/attribute-mapping/useFieldMappings.ts (Fixed fallback transformation)
```

**Technical Changes**:

1. **Database Migration 040**:
   ```sql
   -- Added missing columns
   ALTER TABLE migration.import_field_mappings 
   ADD COLUMN field_type VARCHAR(50),
   ADD COLUMN agent_reasoning TEXT;
   ```

2. **Frontend Transformation Fix**:
   ```typescript
   // BEFORE (hardcoded status)
   status: backendItem.target_field ? 'pending' : 'unmapped',
   
   // AFTER (uses actual backend status)
   status: backendItem.status || (backendItem.target_field ? 'pending' : 'unmapped'),
   ```

3. **Enum Casting Fix**:
   ```python
   # BEFORE (enum comparison error)
   type_filter = "AND pattern_type = :pattern_type"
   
   # AFTER (proper type casting)
   type_filter = "AND pattern_type = :pattern_type::patterntype"
   ```

**Validation Steps**:
```bash
# 1. Check approved mappings in database
docker exec migration_postgres psql -U postgres -d migration_db -c \
  "SELECT source_field, target_field, status FROM migration.import_field_mappings 
   WHERE status = 'approved' LIMIT 5;"

# 2. Test API endpoint response
curl -s http://localhost:8081/api/v1/unified-discovery/flows/{flow_id}/field-mappings \
  -H "X-Client-Account-ID: 11111111-1111-1111-1111-111111111111" \
  -H "X-Engagement-ID: 22222222-2222-2222-2222-222222222222" | \
  jq '.field_mappings | map(select(.status == "approved")) | length'

# 3. Verify no enum casting errors
docker logs migration_backend 2>&1 | grep -E "ERROR.*patterntype" | tail -5
```

**Result**: Field mappings now correctly display in their respective columns based on actual database status, and enum comparison errors are eliminated.

---

## 7. Technical Implementation Details

### Critical Attributes Tool Implementation

The field_mapper agent uses specialized tools to assess critical attributes:

```python
# backend/app/services/crewai_flows/tools/critical_attributes_tool.py
class CriticalAttributesAssessmentTool(BaseTool):
    """Assesses coverage of 22 critical attributes"""
    - Analyzes raw data fields against attribute patterns
    - Calculates coverage percentage and confidence scores
    - Identifies missing required attributes
    - Generates data enrichment recommendations

class MigrationReadinessScoreTool(BaseTool):
    """Calculates 6R strategy readiness scores"""
    - Scores each migration strategy based on attribute coverage
    - Identifies blockers for complex strategies
    - Recommends optimal migration path
    - Provides confidence levels for recommendations

class AttributeMappingSuggestionTool(BaseTool):
    """Suggests mappings for critical attributes"""
    - Maps source fields to critical attributes
    - Prioritizes required attributes
    - Provides confidence scores for suggestions
    - Calculates coverage improvement potential
```

### Persistent Field Mapping Implementation (2025-08-14)

The field mapping phase now uses an optimized persistent agent approach:

```python
# backend/app/services/crewai_flows/crews/persistent_field_mapping.py
class PersistentFieldMapping:
    """Use persistent field_mapper agent for efficient field mapping"""
    
    async def map_fields(self, raw_data: List[Dict[str, Any]]) -> Dict[str, Any]:
        # Get or create persistent field_mapper agent
        agent = await TenantScopedAgentPool.get_or_create_agent(
            client_id=self.client_id,
            engagement_id=self.engagement_id,
            agent_type="field_mapper"
        )
        
        # Direct agent execution (single LLM call)
        result = await self._execute_agent_task(agent, task_description)
        
        # Update agent memory for future reference
        await self._update_agent_memory(agent, headers, mapping_result)
        
        return mapping_result
```

**Performance Improvements:**
- **Before:** 3 agents (Data Analyst, Schema Expert, Synthesis Specialist) with 8+ LLM calls
- **After:** 1 persistent agent with 1-2 LLM calls
- **Execution Time:** 86+ seconds ‚Üí <10 seconds (94% reduction)
- **Memory:** Agent accumulates mapping patterns over time
- **Fallback:** Automatically falls back to standard crew if persistent agents unavailable

### Agent Tool Distribution

| Agent | Critical Attributes Tools | Purpose |
|-------|-------------------------|---------|
| **field_mapper** | All 3 tools + mapping_confidence_tool | Primary responsibility for attribute assessment |
| **data_analyst** | Assessment tools via validation suite | Can evaluate data quality for attributes |
| **pattern_discovery_agent** | Indirect via asset creation tools | Discovers patterns that map to attributes |

### MFO Two-Table Design Pattern

The Discovery flow follows the Master Flow Orchestrator's two-table design pattern:

1. **Master Flow Creation**: The MasterFlowOrchestrator creates the orchestration record in `crewai_flow_state_extensions`
   ```python
   # In MasterFlowOrchestrator
   flow_result = await orchestrator.create_flow(
       flow_type="discovery",
       configuration=configuration,
       initial_state=initial_state,
       atomic=True
   )
   ```

2. **Child Flow Creation**: The flow-specific service creates the child record in `discovery_flows`
   ```python
   # In FlowTriggerService
   discovery_service = DiscoveryFlowService(db, context)
   await discovery_service.create_discovery_flow(
       flow_id=str(master_flow_id),
       master_flow_id=str(master_flow_id),
       data_import_id=data_import_id,
       raw_data=file_data
   )
   ```

3. **API Data Access**: The import storage handler queries the child table for discovery-specific data:
   ```python
   from app.models.discovery_flow import DiscoveryFlow
   flow_query = select(DiscoveryFlow).where(DiscoveryFlow.flow_id == flow_id)
   ```

### Why Both Tables Are Required

The two-table design serves specific purposes:
- **Master Table**: Generic flow orchestration, status tracking, phase management
- **Child Table**: Flow-type-specific data that doesn't fit the generic model
- **Separation of Concerns**: Keeps the master table clean while allowing flow-specific extensions

### Data Flow for Attribute Mapping (Updated 2025-08-19)

**NEW ARCHITECTURE - MFO ENDPOINT APPROACH:**
1. **Frontend** uses `flow_id` to query active flows including 'waiting_for_approval' status
2. **Frontend** calls MFO endpoint: `/api/v1/unified-discovery/flows/{flow_id}/field-mappings`
3. **Backend** returns standardized field mappings with `target_field` and `confidence_score`
4. **Frontend** displays all 9 fields from CSV imports correctly in the UI

**BACKEND DATA FLOW:**
1. **PhaseController** reads from master table (`crewai_flow_state_extensions`) for orchestration state
2. **Import Storage Handler** reads from child table (`discovery_flows`) for `data_import_id`
3. **Field Mapping Service** reads from `import_field_mappings` using `master_flow_id`
4. **MFO Endpoint** combines data from multiple sources and formats response consistently
5. **UI Components** receive properly formatted data with standardized field names

**KEY IMPROVEMENTS:**
- Eliminated import_id based approach that caused 0 fields display issue
- Centralized data access through unified discovery endpoints
- Standardized API response format across all field mapping operations
- Enhanced flow status detection to include paused flows awaiting approval 