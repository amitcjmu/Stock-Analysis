
# E2E Data Flow Analysis: Attribute Mapping

**Analysis Date:** 2025-07-13

This document provides a complete, end-to-end data flow analysis for the `Attribute Mapping` page, a critical phase in the discovery workflow where AI-powered agents suggest mappings between source data and the platform's schema.

**Core Architecture:**
*   **Orchestrator-Driven Phases:** The entire attribute mapping process is a distinct phase managed by the `MasterFlowOrchestrator`. The frontend does not drive phase transitions; it only provides input when requested.
*   **Agent-Driven Decisions:** A dedicated `FieldMappingDecisionAgent` analyzes the results from the primary mapping crew to decide whether to proceed automatically, pause for user review, or fail the phase.
*   **Asynchronous Suggestion & Approval:** The flow first runs in a "suggestions-only" mode to populate the UI, then pauses. It only resumes and applies the mappings after receiving explicit user approval.

---

## 1. Frontend: Review and Approval Interface

The `AttributeMapping` page is a user interface for reviewing, approving, or modifying the field mapping suggestions generated by the backend CrewAI agents.

### Key Components & Hooks
*   **Page Component:** `src/pages/discovery/AttributeMapping/index.tsx`
*   **Core Business Logic:** `src/hooks/discovery/useAttributeMappingLogic.ts`
*   **Flow Detection & State:** `useAttributeMappingFlowDetection` and `useUnifiedDiscoveryFlow` hooks.

### API Call Mapping Table

| #  | HTTP Call                                                           | Trigger                                                        | Key Parameters              | Expected Response                                                             |
|----|---------------------------------------------------------------------|----------------------------------------------------------------|-----------------------------|-------------------------------------------------------------------------------|
| 1  | `GET /api/v1/master-flows/active?flowType=discovery`                | `useAttributeMappingFlowDetection` on page load.               | `clientAccountId`           | A list of active discovery flows to identify the correct context.             |
| 2  | `GET /api/v1/data-import/flow/{flowId}/import-data`                 | `useAttributeMappingLogic` (after flow detection).             | `flowId`                    | JSON object with import metadata and sample data for the identified flow.     |
| 3  | `GET /api/v1/data-import/field-mapping/imports/{importId}/field-mappings` | `useAttributeMappingLogic` (after import data is fetched).       | `importId`                  | An array of AI-generated field mapping suggestions with confidence scores.    |
| 4  | `POST /api/v1/master-flows/{flowId}/resume`                         | User clicks "Approve Mappings" (`resumeFlow` mutation).        | `flowId`, `phase`, `approved_mappings` | Confirmation that the flow has resumed and is proceeding to the next phase.     |
| 5  | `POST /api/v1/data-import/field-mapping/approval/approve-mapping/{mappingId}` | User clicks "Approve" on a single mapping (`handleApproveMapping`). | `mappingId`                 | Success message. This updates the DB but may not resume the flow on its own.  |

---

## 2. Backend: Agentic Mapping and Decision-Making

The backend execution is a multi-step process orchestrated by the `MasterFlowOrchestrator`.

### Phase 1: Generating Suggestions (`suggestions_only` mode)

1.  **Orchestrator Trigger:** When the discovery flow reaches the `attribute_mapping` phase, the `MasterFlowOrchestrator` calls the `FieldMappingExecutor`.
2.  **CrewAI Execution:**
    *   The executor creates the `attribute_mapping` crew. This crew consists of specialized agents like a **Schema Analysis Expert** and an **Attribute Mapping Specialist**.
    *   The crew is executed in `suggestions_only` mode. Its goal is to analyze the source data and produce a list of suggested mappings with confidence scores, as well as any clarification questions for the user.
3.  **Intelligent Analysis (`FieldMappingDecisionAgent`):**
    *   The suggestions and confidence scores from the crew are passed to the `FieldMappingDecisionAgent`.
    *   This agent analyzes the results. If confidence is high, it may recommend proceeding automatically. If confidence is low or ambiguities exist, it recommends pausing for user review.
4.  **State Update & Pause:**
    *   The suggestions are saved to the `import_field_mappings` table.
    *   The flow's status is updated to `waiting_for_approval`, and the orchestrator pauses execution.

### Phase 2: Applying User Approval

1.  **Frontend Action:** The user reviews the suggestions in the UI and clicks "Approve Mappings."
2.  **API Call:** The frontend sends a `POST` request to `/api/v1/master-flows/{flowId}/resume`.
3.  **Orchestrator Resumption:**
    *   The `MasterFlowOrchestrator` receives the resume signal.
    *   It updates the approved mappings in the `import_field_mappings` table.
    *   It changes the flow's status back to `processing`.
    *   It triggers the next phase in the discovery workflow (e.g., `data_cleansing`).

### Database Schema

| ORM Model         | PostgreSQL Table            | Relevant Columns                                                                     | Purpose in This Flow                                                                       |
|-------------------|-----------------------------|--------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------|
| `ImportFieldMapping`| `import_field_mappings`     | `source_field`, `target_field`, `confidence_score`, `status` (`suggested`, `approved`) | Stores the suggestions from the agents and tracks user approvals.                           |
| `CrewAIFlowStateExtensions`| `crewai_flow_state_extensions` | `flow_id`, `flow_status` (`processing`, `waiting_for_approval`), `current_phase` | The master record for the flow, used by the orchestrator to manage state.                  |

---

## 3. End-to-End Flow Sequence: Approving Mappings

1.  **Backend (Initial Analysis):** The `MasterFlowOrchestrator` runs the `attribute_mapping` crew in `suggestions_only` mode. The results are stored, and the flow is paused with a status of `waiting_for_approval`.
2.  **Frontend (Page Load):** The user navigates to the Attribute Mapping page. The `useAttributeMappingLogic` hook fetches the flow state and sees that it's waiting for approval.
3.  **Frontend (Display):** The hook fetches the stored mapping suggestions from `/api/v1/data-import/field-mapping/imports/{importId}/field-mappings` and displays them in the UI.
4.  **Frontend (User Action):** The user reviews the suggestions and clicks "Approve Mappings."
5.  **Frontend (API Call):** The frontend calls the `resumeFlow` mutation, which sends a `POST` request to `/api/v1/master-flows/{flowId}/resume`.
6.  **Backend (Resumption):** The `MasterFlowOrchestrator` receives the request, updates the status of the mappings to `approved`, sets the flow status to `processing`, and triggers the next phase.
7.  **Frontend (UI Update):** The `useUnifiedDiscoveryFlow` hook detects the change in the flow's state and automatically navigates the user to the next appropriate page in the discovery journey.

---

## 4. Troubleshooting Breakpoints

| Stage      | Potential Failure Point                                                                                               | Diagnostic Checks                                                                                                                                                                                                                                                                                  |
|------------|-----------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Frontend** | **No Suggestions Shown:** The page loads, but the mapping table is empty. This means the initial agentic phase failed or returned no results. <br/> **Approval Fails:** Clicking "Approve Mappings" results in an error.                                                                  | **Browser DevTools (Network Tab):** Check the response from `/field-mappings`. Is it empty? Check for errors on the `POST` to `/resume`. A 403 error means a permissions issue, while a 409 might mean the flow is not in a resumable state. |
| **Backend**  | **Agent Failure:** The `attribute_mapping` crew fails during the suggestion phase. <br/> **Decision Agent Error:** The `FieldMappingDecisionAgent` makes an incorrect recommendation, causing the flow to proceed with bad data or get stuck. | **Docker Logs:** Check `migration_backend` logs for errors from `FieldMappingExecutor` or `FieldMappingDecisionAgent`. <br/> **Database:** Check the `flow_status` in the `crewai_flow_state_extensions` table. Is it `waiting_for_approval`? If not, the UI can't resume it. |
| **Database** | **Mappings Not Saved:** The suggestions from the agent crew are not correctly written to the `import_field_mappings` table. | **Direct DB Query:** Connect to the database (`docker exec -it migration_db psql ...`) and run `SELECT * FROM import_field_mappings WHERE data_import_id = 'your-import-id';` to see if the suggestions exist. | 