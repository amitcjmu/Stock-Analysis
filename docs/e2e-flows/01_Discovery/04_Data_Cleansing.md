
# E2E Data Flow Analysis: Data Cleansing

**Analysis Date:** 2025-07-13

This document provides a complete, end-to-end data flow analysis for the `Data Cleansing` phase of the discovery workflow, which has evolved into a sophisticated, agent-driven asset enrichment process.

**Core Architecture:**
*   **Orchestrator-Driven:** The entire phase is managed by the `MasterFlowOrchestrator`. The frontend's only role is to send the signal to begin this phase.
	*   **Agentic Enrichment Only (Fail-Fast):** The system exclusively uses a sophisticated crew of agents for asset enrichment. There is no fallback to a simpler or rule-based cleansing mechanism. This design choice ensures that only high-quality, AI-driven results are produced, and it avoids the complexity and potential for misleading results from a separate fallback system.
*   **State-Based Results:** All results, including quality metrics and enriched data, are stored directly within the flow's state object in the database, not in separate tables.

---

## 1. Frontend: Initiating the Phase and Displaying Results

The `DataCleansing` page allows a user to trigger the next phase of the discovery flow and view the results of the backend agentic analysis.

### Key Components & Hooks
*   **Page Component:** `src/pages/discovery/DataCleansing.tsx`
*   **Core Hooks:**
    *   `useDiscoveryFlowAutoDetection`: To identify the active discovery flow.
    *   `useUnifiedDiscoveryFlow`: To interact with the flow (trigger phases) and read its state.

### API Call Summary

| #  | Method | Endpoint                                | Trigger                                       | Description                                                                                               |
|----|--------|-----------------------------------------|-----------------------------------------------|---------------------------------------------------------------------------------------------------------------------------|
| 1  | `POST` | `/api/v1/master-flows/{flowId}/resume`  | User clicks "Trigger Cleansing" (`updatePhase('data_cleansing')`). | This is the unified endpoint to signal the `MasterFlowOrchestrator` to advance to the `data_cleansing` phase. |
| 2  | `GET`  | (WebSocket or Polling)                  | `useUnifiedDiscoveryFlow` hook.               | Listens for updates to the flow's state to display the results of the agentic enrichment process.         |

---

## 2. Backend: Agentic Asset Enrichment

When the orchestrator transitions the flow to the `data_cleansing` phase, it triggers a sophisticated backend process managed by the `DataCleansingExecutor`.

### Execution Flow

1.  **Executor Invocation:** The `MasterFlowOrchestrator` calls the `DataCleansingExecutor`.
2.  **Primary Strategy: Agentic Enrichment:**
    *   The executor's first choice is to call the `enrich_assets_with_agentic_intelligence` service.
    *   This service converts the raw data records from the previous phase into structured asset profiles.
    *   It then deploys a specialized crew of agents (e.g., **Data Validation Expert**, **Data Standardization Specialist**) to analyze and enrich these profiles in parallel. The agents fill in missing information, standardize values, and calculate quality scores.
3.  **Error Handling: Fail-Fast:**
    *   If the primary agentic enrichment process fails for any reason (e.g., LLM timeout, data format issue), the executor is designed to **fail fast**. It will raise an exception and halt the flow, preventing the system from proceeding with low-quality data.
4.  **State Persistence:**
    *   The results of the process (either the enriched assets or the cleansed data) are saved back into the `crewai_flow_state_extensions` table as part of the flow's JSON state object.
    *   Specifically, the results are stored in attributes like `cleaned_data` and `data_quality_metrics`. There is no separate `data_quality_issues` table.

### Database Interaction

*   **Table:** `crewai_flow_state_extensions`
*   **Operation:** The executor performs an `UPDATE` on the `state` column for the specific `flow_id`. The JSONB `state` object is updated with the `cleaned_data` and `data_quality_metrics` generated by the agents.

---

## 3. End-to-End Flow Sequence: Triggering Data Cleansing

1.  **Frontend (User Action):** The user, having completed the attribute mapping phase, clicks the "Trigger Data Cleansing" button on the `DataCleansing` page.
2.  **Frontend (API Call):** The `useUnifiedDiscoveryFlow` hook sends a `POST` request to `/api/v1/master-flows/{flowId}/resume` with the instruction to advance to the `data_cleansing` phase.
3.  **Backend (Orchestrator):** The `MasterFlowOrchestrator` receives the request and invokes the `DataCleansingExecutor`.
4.  **Backend (Agent Execution):** The executor runs the agentic asset enrichment process.
5.  **Backend (Database Update):** The results of the enrichment are saved to the `state` column of the `crewai_flow_state_extensions` table for the active flow.
6.  **Frontend (Polling/WebSockets):** The `useUnifiedDiscoveryFlow` hook on the frontend receives the updated flow state.
7.  **Frontend (UI Update):** The UI, which reads from the `flowState` object, automatically updates to display the enriched data, quality scores, and any new insights generated by the agents.

---

## 4. Troubleshooting Breakpoints

| Stage      | Potential Failure Point                                                                                                      | Diagnostic Checks                                                                                                                                                                                                                                                                        |
|------------|------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Frontend** | **"Trigger" button is disabled or does not advance:** The frontend state does not recognize that the previous phase (`attribute_mapping`) is complete. | **React DevTools:** Inspect the `flowState` object provided by the `useUnifiedDiscoveryFlow` hook. Check the `current_phase` and `phase_completion` properties to ensure the flow is ready to be advanced.                                                              |
| **Backend**  | **Agentic Enrichment Fails:** The primary enrichment crew fails. <br/> **Incorrect Results:** The agents produce incorrect or poorly formatted data. | **Docker Logs:** Monitor `migration_backend` logs for errors from the `DataCleansingExecutor` or the `enrich_assets_with_agentic_intelligence` service. The system is designed to fail fast, so any error here should be investigated as a critical issue. |
| **Database** | **State Object Not Updating:** The `state` JSON object in the `crewai_flow_state_extensions` table is not being updated with the `cleaned_data`. | **Direct DB Query:** Connect to the database and inspect the `state` column for the `flow_id`: `SELECT state -> 'cleaned_data' FROM crewai_flow_state_extensions WHERE flow_id = 'your-flow-id';`. Check if the JSON is present and correctly structured. | 