# Redis Security Configuration for AI Force Migration Platform
# Based on production security best practices and CC security guidelines

# =====================================
# SECURITY CONFIGURATION
# =====================================

# Authentication - REQUIRED for production
requirepass ${REDIS_PASSWORD}

# Network Security
bind 127.0.0.1 ::1  # Only accept connections from localhost and IPv6 loopback
protected-mode yes  # Enable protected mode to prevent external access
port 6379

# Access Control Lists (ACL) - Future expansion for per-service access
# aclfile /usr/local/etc/redis/users.acl

# =====================================
# PERSISTENCE CONFIGURATION
# =====================================

# RDB Snapshots
save 900 1      # Save after 900 sec (15 min) if at least 1 key changed
save 300 10     # Save after 300 sec (5 min) if at least 10 keys changed
save 60 10000   # Save after 60 sec if at least 10000 keys changed

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes

# Working directory
dir /data

# =====================================
# MEMORY MANAGEMENT
# =====================================

# Memory limits and eviction policy
maxmemory 256mb
maxmemory-policy allkeys-lru

# Memory optimization
activerehashing yes

# =====================================
# SECURITY LIMITS & TIMEOUTS
# =====================================

# Connection timeouts
timeout 300
tcp-keepalive 300
tcp-backlog 511

# Client limits
maxclients 10000

# =====================================
# DANGEROUS COMMANDS DISABLED
# =====================================

# Disable commands that could be used maliciously
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""        # Can cause performance issues
rename-command CONFIG ""      # Prevent runtime config changes
rename-command DEBUG ""       # Debug commands disabled
rename-command EVAL ""        # Disable Lua scripting for security
rename-command SCRIPT ""      # Disable script management

# Rename critical commands to obscure names (optional, uncomment if needed)
# rename-command SHUTDOWN REDIS_SHUTDOWN_b840fc02d524045429941cc15f59e41cb7be6c52
# rename-command DEL REDIS_DEL_b840fc02d524045429941cc15f59e41cb7be6c89

# =====================================
# LOGGING CONFIGURATION
# =====================================

# Logging
loglevel notice
logfile /var/log/redis/redis.log
syslog-enabled yes
syslog-ident redis
syslog-facility local0

# Slow query log for performance monitoring
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128

# =====================================
# PERFORMANCE TUNING
# =====================================

# Performance settings
hz 10                    # Background task frequency
dynamic-hz yes          # Adapt hz based on clients

# Replication settings (for future scaling)
repl-diskless-sync no
repl-diskless-sync-delay 5

# =====================================
# MONITORING & OBSERVABILITY
# =====================================

# Enable latency monitoring
latency-monitor-threshold 100

# Client output buffer limits to prevent memory exhaustion
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =====================================
# MULTI-TENANT SECURITY
# =====================================

# Database separation for tenants (0-15 available)
databases 16

# Note: Real multi-tenancy should be enforced at application layer
# with proper key prefixing and access controls

# =====================================
# TLS/SSL CONFIGURATION (Commented - for future implementation)
# =====================================

# Uncomment and configure for TLS encryption in production
# port 0
# tls-port 6379
# tls-cert-file /certs/redis.crt
# tls-key-file /certs/redis.key
# tls-ca-cert-file /certs/ca.crt
# tls-dh-params-file /certs/redis.dh
# tls-protocols "TLSv1.2 TLSv1.3"
# tls-ciphers "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
# tls-prefer-server-ciphers yes

# =====================================
# END CONFIGURATION
# =====================================
