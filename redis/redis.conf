# Redis Security Configuration for AI Force Migration Platform
# Generated by CC DevSecOps Engineer
# Based on production security best practices and OWASP Redis Security guidelines

# =====================================
# SECURITY CONFIGURATION - CRITICAL
# =====================================

# Authentication - REQUIRED for production
# Use strong password from environment variable
requirepass ${REDIS_PASSWORD}

# Network Security - Strict binding
# Accept connections from any interface (necessary for Docker networking)
bind 0.0.0.0
# Enable protected mode to prevent external access
protected-mode yes
port 6379

# Connection Security
# Close idle connections after 5 minutes
timeout 300
# TCP keepalive for connection health
tcp-keepalive 300
# TCP listen backlog
tcp-backlog 511
# Maximum concurrent clients
maxclients 10000

# Access Control Lists (ACL) - Enhanced Security
# aclfile /usr/local/etc/redis/users.acl
# Enable ACL logging
acllog-max-len 128

# User security - default user restrictions
# The default user should be disabled in production
# user default off

# =====================================
# PERSISTENCE CONFIGURATION
# =====================================

# RDB Snapshots
# Save after 900 sec (15 min) if at least 1 key changed
save 900 1
# Save after 300 sec (5 min) if at least 10 keys changed
save 300 10
# Save after 60 sec if at least 10000 keys changed
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes

# Working directory
dir /data

# =====================================
# MEMORY MANAGEMENT
# =====================================

# Memory limits and eviction policy
maxmemory 256mb
maxmemory-policy allkeys-lru

# Memory optimization
activerehashing yes

# =====================================
# SECURITY LIMITS & TIMEOUTS
# =====================================

# Connection timeouts
timeout 300
tcp-keepalive 300
tcp-backlog 511

# Client limits
maxclients 10000

# =====================================
# DANGEROUS COMMANDS DISABLED - CRITICAL
# =====================================

# Disable commands that could be used maliciously or cause performance issues
# Prevent database wiping
rename-command FLUSHDB ""
# Prevent all databases wiping
rename-command FLUSHALL ""
# Can cause performance issues, use SCAN instead
rename-command KEYS ""
# Prevent runtime config changes
rename-command CONFIG ""
# Debug commands disabled for security
rename-command DEBUG ""
# Disable Lua scripting for security
rename-command EVAL ""
# Disable script management
rename-command SCRIPT ""
# Obscure shutdown command
rename-command SHUTDOWN REDIS_SHUTDOWN_SECURE
# Obscure delete command for critical operations
rename-command DEL REDIS_DEL_SECURE

# Additional dangerous commands to disable
# Disable monitoring (performance impact)
rename-command MONITOR ""
# Disable client management commands
rename-command CLIENT ""
# Force async saves only
rename-command SAVE ""
# Secure background save
rename-command BGSAVE REDIS_BGSAVE_SECURE
# Secure AOF rewrite
rename-command BGREWRITEAOF REDIS_BGREWRITEAOF_SECURE

# Admin commands - rename for security through obscurity
rename-command INFO REDIS_INFO_SECURE
rename-command MEMORY REDIS_MEMORY_SECURE

# =====================================
# LOGGING CONFIGURATION
# =====================================

# Logging
loglevel notice
logfile /var/log/redis/redis.log
syslog-enabled yes
syslog-ident redis
syslog-facility local0

# Slow query log for performance monitoring
# Log queries slower than 10ms
slowlog-log-slower-than 10000
slowlog-max-len 128

# =====================================
# PERFORMANCE TUNING
# =====================================

# Performance settings
# Background task frequency
hz 10
# Adapt hz based on clients
dynamic-hz yes

# Replication settings (for future scaling)
repl-diskless-sync no
repl-diskless-sync-delay 5

# =====================================
# MONITORING & OBSERVABILITY
# =====================================

# Enable latency monitoring
latency-monitor-threshold 100

# Client output buffer limits to prevent memory exhaustion
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =====================================
# MULTI-TENANT SECURITY
# =====================================

# Database separation for tenants (0-15 available)
databases 16

# Note: Real multi-tenancy should be enforced at application layer
# with proper key prefixing and access controls

# =====================================
# TLS/SSL CONFIGURATION - PRODUCTION READY
# =====================================

# TLS/SSL encryption for production deployments
# Uncomment and configure certificates for production use
# port 0                              # Disable non-TLS port
# tls-port 6379                       # Enable TLS on standard port
# tls-cert-file /certs/redis.crt      # Server certificate
# tls-key-file /certs/redis.key       # Server private key
# tls-ca-cert-file /certs/ca.crt      # Certificate Authority
# tls-dh-params-file /certs/redis.dh  # Diffie-Hellman parameters
# tls-protocols "TLSv1.2 TLSv1.3"     # Only secure TLS versions
# tls-ciphers "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
# tls-prefer-server-ciphers yes       # Server cipher preference
# tls-session-caching no              # Disable session caching for security
# tls-session-cache-size 5000         # Session cache size if enabled
# tls-session-cache-timeout 60        # Session timeout

# Client certificate authentication (mutual TLS)
# tls-auth-clients yes                # Require client certificates
# tls-protocols "TLSv1.2 TLSv1.3"     # Force secure protocols only

# =====================================
# SECURITY AUDITING AND COMPLIANCE
# =====================================

# Command auditing for security compliance
# Enable slow log for security monitoring
# Log commands slower than 1ms
slowlog-log-slower-than 1000
# Keep more slow log entries
slowlog-max-len 256

# Enhanced logging for security events
syslog-enabled yes
syslog-ident redis-secure
syslog-facility local0

# Log all commands for security auditing (use with caution - performance impact)
# This should only be enabled in high-security environments
# logfile /var/log/redis/redis-audit.log

# =====================================
# END CONFIGURATION
# =====================================
