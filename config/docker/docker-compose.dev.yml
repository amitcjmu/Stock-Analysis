# Development Environment Configuration
# Use: docker-compose -f docker-compose.dev.yml up -d

services:
  # PostgreSQL Database with pgvector (Development)
  postgres:
    image: pgvector/pgvector:pg17
    container_name: migration_postgres_dev
    environment:
      POSTGRES_DB: migration_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ../../backend/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ../scripts/dev-init.sql:/docker-entrypoint-initdb.d/99-dev-init.sql
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - migration_dev

  # FastAPI Backend (Development)
  backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    env_file:
      - ./backend/.env.dev
    container_name: migration_backend_dev
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/migration_db
      - PYTHONUNBUFFERED=1
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-pro}
      - FRONTEND_URL=http://localhost:3001
      - ENVIRONMENT=development
      - DEBUG=true
      - PYTHONPATH=/app
      - LOG_LEVEL=DEBUG
      - DEMO_DATA=true
      - AUTO_SEED_DATA=true
      # Development-specific settings
      - RELOAD_ON_CHANGE=true
      - ENABLE_PROFILING=true
      - CORS_ALLOW_ALL=true
      # Disable telemetry for dev
      - OTEL_SDK_DISABLED=true
      - OTEL_TRACES_EXPORTER=none
      - OTEL_METRICS_EXPORTER=none
      - OTEL_LOGS_EXPORTER=none
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../../backend:/app
      - dev_logs:/app/logs
    working_dir: /app
    command: >
      sh -c "
        echo 'ðŸš€ Starting development backend...' &&
        python -m alembic upgrade head &&
        echo 'âš ï¸ Skipping demo data seeding to avoid import issues' &&
        echo 'âœ… Starting FastAPI server...' &&
        uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
      "
    networks:
      - migration_dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend (Development)
  frontend:
    build:
      context: ../..
      dockerfile: config/docker/Dockerfile.frontend
    container_name: migration_frontend_dev
    working_dir: /app
    environment:
      - VITE_BACKEND_URL=http://localhost:8000
      - VITE_WS_BASE_URL=ws://localhost:8000/ws
      - VITE_ENVIRONMENT=development
      - VITE_DEBUG=true
      - VITE_DEMO_MODE=true
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true  # For file watching in containers
    ports:
      - "8081:8081"  # Frontend on 8081 as per architecture docs
    volumes:
      - ../..:/app
      - /app/node_modules
      - dev_frontend_cache:/app/.vite
    command: >
      sh -c "
        echo 'ðŸš€ Starting development frontend...' &&
        npm install &&
        npm run dev -- --host 0.0.0.0 --port 8081
      "
    depends_on:
      - backend
    networks:
      - migration_dev

  # Redis (Development - Secure Configuration)
  redis:
    image: redis:7-alpine
    container_name: migration_redis_dev
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
      - ../redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ../redis/logs:/var/log/redis
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-secure_dev_password_change_in_production}
    networks:
      - migration_dev
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD:-secure_dev_password_change_in_production}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    command: >
      sh -c "
        mkdir -p /var/log/redis &&
        chown redis:redis /var/log/redis &&
        redis-server /usr/local/etc/redis/redis.conf
      "
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp
      - /var/run

  # Adminer (Database Management UI)
  adminer:
    image: adminer
    container_name: migration_adminer_dev
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    networks:
      - migration_dev
    environment:
      - ADMINER_DEFAULT_SERVER=postgres

  # Redis Commander (Development GUI)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: migration_redis_commander_dev
    environment:
      - REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD:-secure_dev_password_change_in_production}
      - HTTP_USER=admin
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD:-admin123}
      - PORT=8082
    ports:
      - "8082:8082"
    networks:
      - migration_dev
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - debug
    restart: unless-stopped

volumes:
  postgres_dev_data:
    name: migration_dev_postgres_data
  redis_dev_data:
    name: migration_dev_redis_data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ../data/redis
  dev_logs:
    name: migration_dev_logs
  dev_frontend_cache:
    name: migration_dev_frontend_cache

networks:
  migration_dev:
    name: migration_dev_network
    driver: bridge
