version: '3.8'

services:
  # Frontend with fixed volume mounting
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: migration_frontend
    working_dir: /app
    environment:
      # Use Vite proxy (configured to use http://backend:8000)
      - VITE_WS_BASE_URL=ws://localhost:8000/ws
      - NODE_ENV=development
      # Fix npm path issues
      - NPM_CONFIG_CACHE=/tmp/.npm-cache
      - NPM_CONFIG_PREFIX=/tmp/.npm-global
      - NPM_CONFIG_LOGLEVEL=verbose
      # Ensure npm uses proper paths
      - HOME=/tmp
    ports:
      - "8081:8081"
    volumes:
      # Mount source code but NOT node_modules
      - ./src:/app/src:ro
      - ./public:/app/public:ro
      - ./index.html:/app/index.html:ro
      - ./vite.config.ts:/app/vite.config.ts:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./tsconfig.app.json:/app/tsconfig.app.json:ro
      - ./tsconfig.node.json:/app/tsconfig.node.json:ro
      - ./tailwind.config.ts:/app/tailwind.config.ts:ro
      - ./postcss.config.js:/app/postcss.config.js:ro
      - ./components.json:/app/components.json:ro
      # Use named volume for node_modules to avoid conflicts
      - frontend_node_modules:/app/node_modules
      # Cache directories
      - frontend_npm_cache:/tmp/.npm-cache
    command: sh -c "npm install --legacy-peer-deps && npm run dev -- --host 0.0.0.0 --port 8081"
    depends_on:
      - backend

volumes:
  frontend_node_modules:
  frontend_npm_cache: