"""Fix crewai flow state extensions for flow coordination

Revision ID: a1409a6c4f88
Revises: f410c7d36d82
Create Date: 2025-06-30 03:56:39.719292

"""

import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

from alembic import op

# revision identifiers, used by Alembic.
revision = "a1409a6c4f88"
down_revision = "f410c7d36d82"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("assets", sa.Column("flow_id", sa.UUID(), nullable=True))
    op.create_index(op.f("ix_assets_flow_id"), "assets", ["flow_id"], unique=False)
    # Note: Skip foreign key for now - discovery_flows.flow_id needs unique constraint first
    # op.create_foreign_key(None, 'assets', 'discovery_flows', ['flow_id'], ['flow_id'], ondelete='CASCADE')
    # Add columns with default values for existing rows
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "client_account_id",
            sa.UUID(),
            nullable=False,
            server_default=sa.text("'11111111-1111-1111-1111-111111111111'::uuid"),
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "engagement_id",
            sa.UUID(),
            nullable=False,
            server_default=sa.text("'22222222-2222-2222-2222-222222222222'::uuid"),
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "user_id", sa.String(length=255), nullable=False, server_default="system"
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "flow_type",
            sa.String(length=50),
            nullable=False,
            server_default="discovery",
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("flow_name", sa.String(length=255), nullable=True),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "flow_status",
            sa.String(length=50),
            nullable=False,
            server_default="initialized",
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "flow_configuration",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            nullable=False,
        ),
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_discovery_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        unique=True,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_client_account_id"),
        "crewai_flow_state_extensions",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_engagement_id"),
        "crewai_flow_state_extensions",
        ["engagement_id"],
        unique=False,
    )
    op.drop_constraint(
        op.f("crewai_flow_state_extensions_discovery_flow_id_fkey"),
        "crewai_flow_state_extensions",
        type_="foreignkey",
    )
    op.drop_column("crewai_flow_state_extensions", "discovery_flow_id")
    op.drop_constraint(
        op.f("data_imports_engagement_id_fkey"), "data_imports", type_="foreignkey"
    )
    op.create_index(
        op.f("ix_discovery_flows_flow_id"), "discovery_flows", ["flow_id"], unique=True
    )
    op.create_index(
        op.f("ix_discovery_flows_status"), "discovery_flows", ["status"], unique=False
    )
    op.alter_column(
        "flow_deletion_audit", "session_id", existing_type=sa.UUID(), nullable=True
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_flow_id"),
        "flow_deletion_audit",
        ["flow_id"],
        unique=False,
    )
    op.drop_index(
        op.f("idx_raw_import_records_master_flow_id"), table_name="raw_import_records"
    )
    op.alter_column(
        "v3_data_imports", "status", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "v3_data_imports",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.alter_column(
        "v3_data_imports",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.create_index(
        op.f("ix_v3_data_imports_client_account_id"),
        "v3_data_imports",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_v3_data_imports_engagement_id"),
        "v3_data_imports",
        ["engagement_id"],
        unique=False,
    )
    op.alter_column(
        "v3_discovery_flows", "status", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "v3_discovery_flows",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.alter_column(
        "v3_discovery_flows",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.create_index(
        op.f("ix_v3_discovery_flows_client_account_id"),
        "v3_discovery_flows",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_v3_discovery_flows_engagement_id"),
        "v3_discovery_flows",
        ["engagement_id"],
        unique=False,
    )
    op.alter_column(
        "v3_field_mappings", "status", existing_type=sa.VARCHAR(), nullable=True
    )
    op.alter_column(
        "v3_field_mappings",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.alter_column(
        "v3_field_mappings",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    op.create_index(
        op.f("ix_v3_field_mappings_client_account_id"),
        "v3_field_mappings",
        ["client_account_id"],
        unique=False,
    )
    op.alter_column(
        "v3_raw_import_records",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=True,
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column(
        "v3_raw_import_records",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.drop_index(
        op.f("ix_v3_field_mappings_client_account_id"), table_name="v3_field_mappings"
    )
    op.alter_column(
        "v3_field_mappings",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "v3_field_mappings",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "v3_field_mappings", "status", existing_type=sa.VARCHAR(), nullable=False
    )
    op.drop_index(
        op.f("ix_v3_discovery_flows_engagement_id"), table_name="v3_discovery_flows"
    )
    op.drop_index(
        op.f("ix_v3_discovery_flows_client_account_id"), table_name="v3_discovery_flows"
    )
    op.alter_column(
        "v3_discovery_flows",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "v3_discovery_flows",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "v3_discovery_flows", "status", existing_type=sa.VARCHAR(), nullable=False
    )
    op.drop_index(
        op.f("ix_v3_data_imports_engagement_id"), table_name="v3_data_imports"
    )
    op.drop_index(
        op.f("ix_v3_data_imports_client_account_id"), table_name="v3_data_imports"
    )
    op.alter_column(
        "v3_data_imports",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "v3_data_imports",
        "created_at",
        existing_type=postgresql.TIMESTAMP(),
        nullable=False,
    )
    op.alter_column(
        "v3_data_imports", "status", existing_type=sa.VARCHAR(), nullable=False
    )
    op.create_index(
        op.f("idx_raw_import_records_master_flow_id"),
        "raw_import_records",
        ["master_flow_id"],
        unique=False,
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_flow_id"), table_name="flow_deletion_audit"
    )
    op.alter_column(
        "flow_deletion_audit", "session_id", existing_type=sa.UUID(), nullable=False
    )
    op.drop_index(op.f("ix_discovery_flows_status"), table_name="discovery_flows")
    op.drop_index(op.f("ix_discovery_flows_flow_id"), table_name="discovery_flows")
    op.create_foreign_key(
        op.f("data_imports_engagement_id_fkey"),
        "data_imports",
        "engagements",
        ["engagement_id"],
        ["id"],
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("discovery_flow_id", sa.UUID(), autoincrement=False, nullable=False),
    )
    op.create_foreign_key(
        op.f("crewai_flow_state_extensions_discovery_flow_id_fkey"),
        "crewai_flow_state_extensions",
        "discovery_flows",
        ["discovery_flow_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_engagement_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_client_account_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_discovery_flow_id"),
        "crewai_flow_state_extensions",
        ["discovery_flow_id"],
        unique=False,
    )
    op.drop_column("crewai_flow_state_extensions", "flow_configuration")
    op.drop_column("crewai_flow_state_extensions", "flow_status")
    op.drop_column("crewai_flow_state_extensions", "flow_name")
    op.drop_column("crewai_flow_state_extensions", "flow_type")
    op.drop_column("crewai_flow_state_extensions", "user_id")
    op.drop_column("crewai_flow_state_extensions", "engagement_id")
    op.drop_column("crewai_flow_state_extensions", "client_account_id")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_index(op.f("ix_assets_flow_id"), table_name="assets")
    op.drop_column("assets", "flow_id")
    # ### end Alembic commands ###
