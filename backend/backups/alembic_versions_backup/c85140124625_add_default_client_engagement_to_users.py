"""add_default_client_engagement_to_users

Revision ID: c85140124625
Revises: enhanced_client_accounts
Create Date: 2025-06-27 17:55:02.257647

"""

import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

from alembic import op

# Import pgvector for vector columns
try:
    import pgvector.sqlalchemy
except ImportError:
    pgvector = None

# revision identifiers, used by Alembic.
revision = "c85140124625"
down_revision = "enhanced_client_accounts"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # Create enum types needed ONLY for add_column and alter_column operations (others auto-created by table creation)
    sa.Enum(
        "DISCOVERED",
        "ASSESSED",
        "PLANNED",
        "MIGRATING",
        "MIGRATED",
        "FAILED",
        "EXCLUDED",
        name="assetstatus",
    ).create(op.get_bind(), checkfirst=True)
    sa.Enum(
        "SERVER",
        "DATABASE",
        "APPLICATION",
        "NETWORK",
        "LOAD_BALANCER",
        "STORAGE",
        "SECURITY_GROUP",
        "VIRTUAL_MACHINE",
        "CONTAINER",
        "OTHER",
        name="assettype",
    ).create(op.get_bind(), checkfirst=True)

    op.create_table(
        "llm_model_pricing",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("provider", sa.String(length=100), nullable=False),
        sa.Column("model_name", sa.String(length=255), nullable=False),
        sa.Column("model_version", sa.String(length=100), nullable=True),
        sa.Column(
            "input_cost_per_1k_tokens",
            sa.Numeric(precision=10, scale=6),
            nullable=False,
        ),
        sa.Column(
            "output_cost_per_1k_tokens",
            sa.Numeric(precision=10, scale=6),
            nullable=False,
        ),
        sa.Column("currency", sa.String(length=10), nullable=False),
        sa.Column("effective_from", sa.DateTime(timezone=True), nullable=False),
        sa.Column("effective_to", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("source", sa.String(length=255), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "provider",
            "model_name",
            "model_version",
            "effective_from",
            name="uq_model_pricing_version_date",
        ),
    )
    op.create_index(
        "idx_model_pricing_active",
        "llm_model_pricing",
        ["is_active", "effective_from", "effective_to"],
        unique=False,
    )
    op.create_index(
        "idx_model_pricing_provider_model",
        "llm_model_pricing",
        ["provider", "model_name"],
        unique=False,
    )
    op.create_table(
        "migrations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "PLANNING",
                "IN_PROGRESS",
                "COMPLETED",
                "PAUSED",
                "CANCELLED",
                name="migrationstatus",
            ),
            nullable=True,
        ),
        sa.Column(
            "current_phase",
            sa.Enum(
                "DISCOVERY",
                "ASSESS",
                "PLAN",
                "EXECUTE",
                "MODERNIZE",
                "FINOPS",
                "OBSERVABILITY",
                "DECOMMISSION",
                name="migrationphase",
            ),
            nullable=True,
        ),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("target_completion_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_completion_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("source_environment", sa.String(length=100), nullable=True),
        sa.Column("target_environment", sa.String(length=100), nullable=True),
        sa.Column("migration_strategy", sa.String(length=50), nullable=True),
        sa.Column("progress_percentage", sa.Integer(), nullable=True),
        sa.Column("total_assets", sa.Integer(), nullable=True),
        sa.Column("migrated_assets", sa.Integer(), nullable=True),
        sa.Column("ai_recommendations", sa.JSON(), nullable=True),
        sa.Column("risk_assessment", sa.JSON(), nullable=True),
        sa.Column("cost_estimates", sa.JSON(), nullable=True),
        sa.Column("settings", sa.JSON(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_migrations_id"), "migrations", ["id"], unique=False)
    op.create_index(op.f("ix_migrations_name"), "migrations", ["name"], unique=False)
    op.create_table(
        "sixr_parameters",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("parameter_key", sa.String(length=255), nullable=False),
        sa.Column("value", sa.JSON(), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_parameters_parameter_key"),
        "sixr_parameters",
        ["parameter_key"],
        unique=True,
    )
    op.create_table(
        "sixr_questions",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("question_id", sa.String(length=100), nullable=False),
        sa.Column("question_text", sa.Text(), nullable=False),
        sa.Column(
            "question_type",
            sa.Enum(
                "TEXT",
                "SELECT",
                "MULTISELECT",
                "FILE_UPLOAD",
                "BOOLEAN",
                "NUMERIC",
                name="questiontype",
            ),
            nullable=False,
        ),
        sa.Column("category", sa.String(length=100), nullable=False),
        sa.Column("priority", sa.Integer(), nullable=True),
        sa.Column("required", sa.Boolean(), nullable=True),
        sa.Column("active", sa.Boolean(), nullable=True),
        sa.Column("options", sa.JSON(), nullable=True),
        sa.Column("validation_rules", sa.JSON(), nullable=True),
        sa.Column("help_text", sa.Text(), nullable=True),
        sa.Column("depends_on", sa.String(length=100), nullable=True),
        sa.Column("show_conditions", sa.JSON(), nullable=True),
        sa.Column("skip_conditions", sa.JSON(), nullable=True),
        sa.Column("created_by", sa.String(length=100), nullable=True),
        sa.Column("updated_by", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("version", sa.String(length=20), nullable=True),
        sa.Column("parent_question_id", sa.String(length=100), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_questions_id"), "sixr_questions", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_sixr_questions_question_id"),
        "sixr_questions",
        ["question_id"],
        unique=True,
    )
    op.create_table(
        "cmdb_sixr_analyses",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("analysis_name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("status", sa.String(length=50), nullable=True),
        sa.Column("total_assets", sa.Integer(), nullable=True),
        sa.Column("rehost_count", sa.Integer(), nullable=True),
        sa.Column("replatform_count", sa.Integer(), nullable=True),
        sa.Column("refactor_count", sa.Integer(), nullable=True),
        sa.Column("rearchitect_count", sa.Integer(), nullable=True),
        sa.Column("retire_count", sa.Integer(), nullable=True),
        sa.Column("retain_count", sa.Integer(), nullable=True),
        sa.Column("total_current_cost", sa.Float(), nullable=True),
        sa.Column("total_estimated_cost", sa.Float(), nullable=True),
        sa.Column("potential_savings", sa.Float(), nullable=True),
        sa.Column("analysis_results", sa.JSON(), nullable=True),
        sa.Column("recommendations", sa.JSON(), nullable=True),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("created_by", sa.UUID(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["users.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_cmdb_sixr_analyses_client_account_id"),
        "cmdb_sixr_analyses",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cmdb_sixr_analyses_engagement_id"),
        "cmdb_sixr_analyses",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cmdb_sixr_analyses_id"), "cmdb_sixr_analyses", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_cmdb_sixr_analyses_is_mock"),
        "cmdb_sixr_analyses",
        ["is_mock"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cmdb_sixr_analyses_status"),
        "cmdb_sixr_analyses",
        ["status"],
        unique=False,
    )
    op.create_table(
        "custom_target_fields",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("field_name", sa.String(), nullable=False),
        sa.Column("field_type", sa.String(), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("is_required", sa.Boolean(), nullable=True),
        sa.Column("is_critical", sa.Boolean(), nullable=True),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("created_by", sa.UUID(), nullable=True),
        sa.Column("validation_schema", sa.JSON(), nullable=True),
        sa.Column("default_value", sa.String(), nullable=True),
        sa.Column("allowed_values", sa.JSON(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["users.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "discovery_assets",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("discovery_flow_id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("asset_name", sa.String(length=255), nullable=False),
        sa.Column("asset_type", sa.String(length=100), nullable=True),
        sa.Column("asset_subtype", sa.String(length=100), nullable=True),
        sa.Column("raw_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column(
            "normalized_data", postgresql.JSONB(astext_type=sa.Text()), nullable=True
        ),
        sa.Column("discovered_in_phase", sa.String(length=50), nullable=False),
        sa.Column("discovery_method", sa.String(length=100), nullable=True),
        sa.Column("confidence_score", sa.Float(), nullable=True),
        sa.Column("migration_ready", sa.Boolean(), nullable=False),
        sa.Column("migration_complexity", sa.String(length=20), nullable=True),
        sa.Column("migration_priority", sa.Integer(), nullable=True),
        sa.Column("asset_status", sa.String(length=20), nullable=False),
        sa.Column("validation_status", sa.String(length=20), nullable=False),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["discovery_flow_id"], ["discovery_flows.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_discovery_assets_asset_status"),
        "discovery_assets",
        ["asset_status"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_assets_asset_type"),
        "discovery_assets",
        ["asset_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_assets_client_account_id"),
        "discovery_assets",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_assets_discovery_flow_id"),
        "discovery_assets",
        ["discovery_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_assets_engagement_id"),
        "discovery_assets",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_assets_id"), "discovery_assets", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_assets_is_mock"),
        "discovery_assets",
        ["is_mock"],
        unique=False,
    )
    op.create_table(
        "feedback",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("feedback_type", sa.String(length=50), nullable=False),
        sa.Column("page", sa.String(length=255), nullable=True),
        sa.Column("rating", sa.Integer(), nullable=True),
        sa.Column("comment", sa.Text(), nullable=True),
        sa.Column("category", sa.String(length=50), nullable=True),
        sa.Column("breadcrumb", sa.String(length=500), nullable=True),
        sa.Column("filename", sa.String(length=255), nullable=True),
        sa.Column("original_analysis", sa.JSON(), nullable=True),
        sa.Column("user_corrections", sa.JSON(), nullable=True),
        sa.Column("asset_type_override", sa.String(length=100), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=True),
        sa.Column("processed", sa.Boolean(), nullable=True),
        sa.Column("user_agent", sa.String(length=500), nullable=True),
        sa.Column("user_timestamp", sa.String(length=50), nullable=True),
        sa.Column("client_ip", sa.String(length=45), nullable=True),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column("learning_patterns_extracted", sa.JSON(), nullable=True),
        sa.Column("confidence_impact", sa.Float(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("processed_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_feedback_feedback_type"), "feedback", ["feedback_type"], unique=False
    )
    op.create_index(op.f("ix_feedback_id"), "feedback", ["id"], unique=False)
    op.create_index(op.f("ix_feedback_page"), "feedback", ["page"], unique=False)
    op.create_table(
        "feedback_summaries",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("feedback_type", sa.String(length=50), nullable=False),
        sa.Column("page", sa.String(length=255), nullable=True),
        sa.Column("time_period", sa.String(length=20), nullable=True),
        sa.Column("total_feedback", sa.Integer(), nullable=True),
        sa.Column("average_rating", sa.Float(), nullable=True),
        sa.Column("status_counts", sa.JSON(), nullable=True),
        sa.Column("rating_distribution", sa.JSON(), nullable=True),
        sa.Column("category_counts", sa.JSON(), nullable=True),
        sa.Column("feedback_trend", sa.JSON(), nullable=True),
        sa.Column("rating_trend", sa.JSON(), nullable=True),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column(
            "last_calculated",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("calculation_duration_ms", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_feedback_summaries_feedback_type"),
        "feedback_summaries",
        ["feedback_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_feedback_summaries_id"), "feedback_summaries", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_feedback_summaries_page"), "feedback_summaries", ["page"], unique=False
    )
    op.create_table(
        "llm_usage_logs",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column("username", sa.String(length=255), nullable=True),
        sa.Column("session_id", sa.String(length=255), nullable=True),
        sa.Column("request_id", sa.String(length=255), nullable=True),
        sa.Column("endpoint", sa.String(length=500), nullable=True),
        sa.Column("page_context", sa.String(length=255), nullable=True),
        sa.Column("feature_context", sa.String(length=255), nullable=True),
        sa.Column("llm_provider", sa.String(length=100), nullable=False),
        sa.Column("model_name", sa.String(length=255), nullable=False),
        sa.Column("model_version", sa.String(length=100), nullable=True),
        sa.Column("input_tokens", sa.Integer(), nullable=True),
        sa.Column("output_tokens", sa.Integer(), nullable=True),
        sa.Column("total_tokens", sa.Integer(), nullable=True),
        sa.Column("input_cost", sa.Numeric(precision=10, scale=6), nullable=True),
        sa.Column("output_cost", sa.Numeric(precision=10, scale=6), nullable=True),
        sa.Column("total_cost", sa.Numeric(precision=10, scale=6), nullable=True),
        sa.Column("cost_currency", sa.String(length=10), nullable=False),
        sa.Column("response_time_ms", sa.Integer(), nullable=True),
        sa.Column("success", sa.Boolean(), nullable=False),
        sa.Column("error_type", sa.String(length=255), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column(
            "request_data", postgresql.JSONB(astext_type=sa.Text()), nullable=True
        ),
        sa.Column(
            "response_data", postgresql.JSONB(astext_type=sa.Text()), nullable=True
        ),
        sa.Column(
            "additional_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
        ),
        sa.Column("ip_address", sa.String(length=45), nullable=True),
        sa.Column("user_agent", sa.String(length=500), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        "idx_llm_usage_client_account",
        "llm_usage_logs",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        "idx_llm_usage_cost_analysis",
        "llm_usage_logs",
        ["client_account_id", "llm_provider", "model_name", "created_at"],
        unique=False,
    )
    op.create_index(
        "idx_llm_usage_created_at", "llm_usage_logs", ["created_at"], unique=False
    )
    op.create_index(
        "idx_llm_usage_engagement", "llm_usage_logs", ["engagement_id"], unique=False
    )
    op.create_index(
        "idx_llm_usage_feature_context",
        "llm_usage_logs",
        ["feature_context"],
        unique=False,
    )
    op.create_index(
        "idx_llm_usage_page_context", "llm_usage_logs", ["page_context"], unique=False
    )
    op.create_index(
        "idx_llm_usage_provider_model",
        "llm_usage_logs",
        ["llm_provider", "model_name"],
        unique=False,
    )
    op.create_index(
        "idx_llm_usage_reporting",
        "llm_usage_logs",
        ["client_account_id", "created_at", "success"],
        unique=False,
    )
    op.create_index(
        "idx_llm_usage_success", "llm_usage_logs", ["success"], unique=False
    )
    op.create_index("idx_llm_usage_user", "llm_usage_logs", ["user_id"], unique=False)
    op.create_table(
        "llm_usage_summary",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("period_type", sa.String(length=20), nullable=False),
        sa.Column("period_start", sa.DateTime(timezone=True), nullable=False),
        sa.Column("period_end", sa.DateTime(timezone=True), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column("llm_provider", sa.String(length=100), nullable=True),
        sa.Column("model_name", sa.String(length=255), nullable=True),
        sa.Column("page_context", sa.String(length=255), nullable=True),
        sa.Column("feature_context", sa.String(length=255), nullable=True),
        sa.Column("total_requests", sa.Integer(), nullable=False),
        sa.Column("successful_requests", sa.Integer(), nullable=False),
        sa.Column("failed_requests", sa.Integer(), nullable=False),
        sa.Column("total_input_tokens", sa.BigInteger(), nullable=False),
        sa.Column("total_output_tokens", sa.BigInteger(), nullable=False),
        sa.Column("total_tokens", sa.BigInteger(), nullable=False),
        sa.Column("total_cost", sa.Numeric(precision=12, scale=6), nullable=False),
        sa.Column("avg_response_time_ms", sa.Integer(), nullable=True),
        sa.Column("min_response_time_ms", sa.Integer(), nullable=True),
        sa.Column("max_response_time_ms", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "period_type",
            "period_start",
            "client_account_id",
            "engagement_id",
            "user_id",
            "llm_provider",
            "model_name",
            "page_context",
            "feature_context",
            name="uq_usage_summary_period_context",
        ),
    )
    op.create_index(
        "idx_usage_summary_client",
        "llm_usage_summary",
        ["client_account_id", "period_start"],
        unique=False,
    )
    op.create_index(
        "idx_usage_summary_model",
        "llm_usage_summary",
        ["llm_provider", "model_name", "period_start"],
        unique=False,
    )
    op.create_index(
        "idx_usage_summary_period",
        "llm_usage_summary",
        ["period_type", "period_start", "period_end"],
        unique=False,
    )
    op.create_table(
        "mapping_learning_patterns",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("source_column", sa.String(length=255), nullable=False),
        sa.Column("target_column", sa.String(length=255), nullable=False),
        sa.Column(
            "pattern_type",
            sa.String(length=50),
            nullable=False,
            comment="e.g., 'regex', 'value_map', 'synonym'",
        ),
        sa.Column(
            "pattern_details",
            sa.JSON(),
            nullable=False,
            comment="Details of the learned pattern, e.g., the regex string or a value mapping dictionary",
        ),
        sa.Column("confidence_score", sa.JSON(), nullable=True),
        sa.Column(
            "created_by",
            sa.String(length=100),
            nullable=False,
            comment="Identifier for the agent or user who created the pattern",
        ),
        sa.Column(
            "last_used_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("usage_count", sa.JSON(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_mapping_learning_patterns_engagement_id"),
        "mapping_learning_patterns",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_mapping_learning_patterns_source_column"),
        "mapping_learning_patterns",
        ["source_column"],
        unique=False,
    )
    op.create_index(
        op.f("ix_mapping_learning_patterns_target_column"),
        "mapping_learning_patterns",
        ["target_column"],
        unique=False,
    )
    op.create_table(
        "migration_logs",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("migration_id", sa.UUID(), nullable=False),
        sa.Column(
            "timestamp",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("level", sa.String(length=20), nullable=True),
        sa.Column("message", sa.Text(), nullable=False),
        sa.Column("details", sa.JSON(), nullable=True),
        sa.Column(
            "phase",
            sa.Enum(
                "DISCOVERY",
                "ASSESS",
                "PLAN",
                "EXECUTE",
                "MODERNIZE",
                "FINOPS",
                "OBSERVABILITY",
                "DECOMMISSION",
                name="migrationphase",
            ),
            nullable=True,
        ),
        sa.Column("user_id", sa.String(length=100), nullable=True),
        sa.Column("action", sa.String(length=100), nullable=True),
        sa.ForeignKeyConstraint(
            ["migration_id"],
            ["migrations.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_migration_logs_id"), "migration_logs", ["id"], unique=False
    )
    op.create_table(
        "migration_waves",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("wave_number", sa.Integer(), nullable=False),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("status", sa.String(length=50), nullable=True),
        sa.Column("planned_start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("planned_end_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_end_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("total_assets", sa.Integer(), nullable=True),
        sa.Column("completed_assets", sa.Integer(), nullable=True),
        sa.Column("failed_assets", sa.Integer(), nullable=True),
        sa.Column("estimated_cost", sa.Float(), nullable=True),
        sa.Column("actual_cost", sa.Float(), nullable=True),
        sa.Column("estimated_effort_hours", sa.Float(), nullable=True),
        sa.Column("actual_effort_hours", sa.Float(), nullable=True),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("created_by", sa.UUID(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["users.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_migration_waves_client_account_id"),
        "migration_waves",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_waves_engagement_id"),
        "migration_waves",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_waves_id"), "migration_waves", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_migration_waves_is_mock"), "migration_waves", ["is_mock"], unique=False
    )
    op.create_index(
        op.f("ix_migration_waves_status"), "migration_waves", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_migration_waves_wave_number"),
        "migration_waves",
        ["wave_number"],
        unique=False,
    )
    op.create_table(
        "sixr_analyses",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("migration_id", sa.UUID(), nullable=True),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "IN_PROGRESS",
                "COMPLETED",
                "FAILED",
                "REQUIRES_INPUT",
                name="analysisstatus",
            ),
            nullable=False,
        ),
        sa.Column("priority", sa.Integer(), nullable=True),
        sa.Column("application_ids", sa.JSON(), nullable=True),
        sa.Column("application_data", sa.JSON(), nullable=True),
        sa.Column("current_iteration", sa.Integer(), nullable=True),
        sa.Column("progress_percentage", sa.Float(), nullable=True),
        sa.Column("estimated_completion", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "final_recommendation",
            sa.Enum(
                "REHOST",
                "REPLATFORM",
                "REFACTOR",
                "REARCHITECT",
                "REPLACE",
                "REPURCHASE",
                "RETIRE",
                "RETAIN",
                name="sixrstrategy",
            ),
            nullable=True,
        ),
        sa.Column("confidence_score", sa.Float(), nullable=True),
        sa.Column("created_by", sa.String(length=100), nullable=True),
        sa.Column("updated_by", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("analysis_config", sa.JSON(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["migration_id"],
            ["migrations.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_analyses_client_account_id"),
        "sixr_analyses",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_sixr_analyses_engagement_id"),
        "sixr_analyses",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(op.f("ix_sixr_analyses_id"), "sixr_analyses", ["id"], unique=False)
    op.create_index(
        op.f("ix_sixr_analyses_name"), "sixr_analyses", ["name"], unique=False
    )
    op.create_table(
        "tags",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column("category", sa.String(length=50), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "reference_embedding",
            pgvector.sqlalchemy.vector.VECTOR(dim=1536),
            nullable=True,
        ),
        sa.Column("confidence_threshold", sa.Float(), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=True),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column("usage_count", sa.Integer(), nullable=True),
        sa.Column("last_used", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_tags_category"), "tags", ["category"], unique=False)
    op.create_index(
        op.f("ix_tags_client_account_id"), "tags", ["client_account_id"], unique=False
    )
    op.create_index(op.f("ix_tags_id"), "tags", ["id"], unique=False)
    op.create_index(op.f("ix_tags_is_active"), "tags", ["is_active"], unique=False)
    op.create_index(op.f("ix_tags_is_mock"), "tags", ["is_mock"], unique=False)
    op.create_index(op.f("ix_tags_name"), "tags", ["name"], unique=True)
    op.create_table(
        "wave_plans",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("migration_id", sa.UUID(), nullable=False),
        sa.Column("wave_number", sa.Integer(), nullable=False),
        sa.Column("wave_name", sa.String(length=255), nullable=True),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("planned_start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("planned_end_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_end_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("total_assets", sa.Integer(), nullable=True),
        sa.Column("completed_assets", sa.Integer(), nullable=True),
        sa.Column("estimated_effort_hours", sa.Integer(), nullable=True),
        sa.Column("estimated_cost", sa.Float(), nullable=True),
        sa.Column("prerequisites", sa.JSON(), nullable=True),
        sa.Column("dependencies", sa.JSON(), nullable=True),
        sa.Column("constraints", sa.JSON(), nullable=True),
        sa.Column(
            "overall_risk_level",
            sa.Enum("LOW", "MEDIUM", "HIGH", "CRITICAL", name="risklevel"),
            nullable=True,
        ),
        sa.Column("complexity_score", sa.Float(), nullable=True),
        sa.Column("success_criteria", sa.JSON(), nullable=True),
        sa.Column("status", sa.String(length=50), nullable=True),
        sa.Column("progress_percentage", sa.Float(), nullable=True),
        sa.Column("ai_recommendations", sa.JSON(), nullable=True),
        sa.Column("optimization_score", sa.Float(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["migration_id"],
            ["migrations.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_wave_plans_client_account_id"),
        "wave_plans",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_wave_plans_engagement_id"),
        "wave_plans",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(op.f("ix_wave_plans_id"), "wave_plans", ["id"], unique=False)
    op.create_table(
        "sixr_analysis_parameters",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("analysis_id", sa.UUID(), nullable=False),
        sa.Column("iteration_number", sa.Integer(), nullable=False),
        sa.Column("business_value", sa.Float(), nullable=False),
        sa.Column("technical_complexity", sa.Float(), nullable=False),
        sa.Column("migration_urgency", sa.Float(), nullable=False),
        sa.Column("compliance_requirements", sa.Float(), nullable=False),
        sa.Column("cost_sensitivity", sa.Float(), nullable=False),
        sa.Column("risk_tolerance", sa.Float(), nullable=False),
        sa.Column("innovation_priority", sa.Float(), nullable=False),
        sa.Column("application_type", sa.String(length=20), nullable=True),
        sa.Column("parameter_source", sa.String(length=50), nullable=True),
        sa.Column("confidence_level", sa.Float(), nullable=True),
        sa.Column("created_by", sa.String(length=100), nullable=True),
        sa.Column("updated_by", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("parameter_notes", sa.Text(), nullable=True),
        sa.Column("validation_status", sa.String(length=20), nullable=True),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_analysis_parameters_id"),
        "sixr_analysis_parameters",
        ["id"],
        unique=False,
    )
    op.create_table(
        "sixr_iterations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("analysis_id", sa.UUID(), nullable=False),
        sa.Column("iteration_number", sa.Integer(), nullable=False),
        sa.Column("iteration_name", sa.String(length=255), nullable=True),
        sa.Column("iteration_reason", sa.Text(), nullable=True),
        sa.Column("stakeholder_feedback", sa.Text(), nullable=True),
        sa.Column("parameter_changes", sa.JSON(), nullable=True),
        sa.Column("question_responses", sa.JSON(), nullable=True),
        sa.Column("recommendation_data", sa.JSON(), nullable=True),
        sa.Column("confidence_score", sa.Float(), nullable=True),
        sa.Column("analysis_duration", sa.Float(), nullable=True),
        sa.Column("agent_insights", sa.JSON(), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=True),
        sa.Column("error_details", sa.JSON(), nullable=True),
        sa.Column("created_by", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("completed_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_iterations_id"), "sixr_iterations", ["id"], unique=False
    )
    op.create_table(
        "sixr_question_responses",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("analysis_id", sa.UUID(), nullable=False),
        sa.Column("iteration_number", sa.Integer(), nullable=False),
        sa.Column("question_id", sa.String(length=100), nullable=False),
        sa.Column("response_value", sa.JSON(), nullable=True),
        sa.Column("response_text", sa.Text(), nullable=True),
        sa.Column("confidence", sa.Float(), nullable=True),
        sa.Column("source", sa.String(length=50), nullable=True),
        sa.Column("response_time", sa.Float(), nullable=True),
        sa.Column("validation_status", sa.String(length=20), nullable=True),
        sa.Column("validation_errors", sa.JSON(), nullable=True),
        sa.Column("created_by", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
        ),
        sa.ForeignKeyConstraint(
            ["question_id"],
            ["sixr_questions.question_id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_question_responses_id"),
        "sixr_question_responses",
        ["id"],
        unique=False,
    )
    op.create_table(
        "sixr_recommendations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("analysis_id", sa.UUID(), nullable=False),
        sa.Column("iteration_number", sa.Integer(), nullable=True),
        sa.Column(
            "recommended_strategy",
            sa.Enum(
                "REHOST",
                "REPLATFORM",
                "REFACTOR",
                "REARCHITECT",
                "REPLACE",
                "REPURCHASE",
                "RETIRE",
                "RETAIN",
                name="sixrstrategy",
            ),
            nullable=False,
        ),
        sa.Column("confidence_score", sa.Float(), nullable=False),
        sa.Column("strategy_scores", sa.JSON(), nullable=True),
        sa.Column("key_factors", sa.JSON(), nullable=True),
        sa.Column("assumptions", sa.JSON(), nullable=True),
        sa.Column("next_steps", sa.JSON(), nullable=True),
        sa.Column("estimated_effort", sa.String(length=50), nullable=True),
        sa.Column("estimated_timeline", sa.String(length=100), nullable=True),
        sa.Column("estimated_cost_impact", sa.String(length=50), nullable=True),
        sa.Column("risk_factors", sa.JSON(), nullable=True),
        sa.Column("business_benefits", sa.JSON(), nullable=True),
        sa.Column("technical_benefits", sa.JSON(), nullable=True),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("created_by", sa.String(length=100), nullable=True),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_sixr_recommendations_id"), "sixr_recommendations", ["id"], unique=False
    )
    op.create_table(
        "assessments",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("migration_id", sa.UUID(), nullable=False),
        sa.Column("asset_id", sa.UUID(), nullable=True),
        sa.Column(
            "assessment_type",
            sa.Enum(
                "SIX_R_ANALYSIS",
                "RISK_ASSESSMENT",
                "COST_ANALYSIS",
                "TECHNICAL_ASSESSMENT",
                "BUSINESS_IMPACT",
                "SECURITY_ASSESSMENT",
                "COMPLIANCE_REVIEW",
                name="assessmenttype",
            ),
            nullable=False,
        ),
        sa.Column(
            "status",
            sa.Enum(
                "PENDING",
                "IN_PROGRESS",
                "COMPLETED",
                "REVIEWED",
                "APPROVED",
                "REJECTED",
                name="assessmentstatus",
            ),
            nullable=True,
        ),
        sa.Column("title", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("overall_score", sa.Float(), nullable=True),
        sa.Column(
            "risk_level",
            sa.Enum("LOW", "MEDIUM", "HIGH", "CRITICAL", name="risklevel"),
            nullable=True,
        ),
        sa.Column("confidence_level", sa.Float(), nullable=True),
        sa.Column("recommended_strategy", sa.String(length=50), nullable=True),
        sa.Column("alternative_strategies", sa.JSON(), nullable=True),
        sa.Column("strategy_rationale", sa.Text(), nullable=True),
        sa.Column("current_cost", sa.Float(), nullable=True),
        sa.Column("estimated_migration_cost", sa.Float(), nullable=True),
        sa.Column("estimated_target_cost", sa.Float(), nullable=True),
        sa.Column("cost_savings_potential", sa.Float(), nullable=True),
        sa.Column("roi_months", sa.Integer(), nullable=True),
        sa.Column("identified_risks", sa.JSON(), nullable=True),
        sa.Column("risk_mitigation", sa.JSON(), nullable=True),
        sa.Column("blockers", sa.JSON(), nullable=True),
        sa.Column("dependencies_impact", sa.JSON(), nullable=True),
        sa.Column("technical_complexity", sa.String(length=20), nullable=True),
        sa.Column("compatibility_score", sa.Float(), nullable=True),
        sa.Column("modernization_opportunities", sa.JSON(), nullable=True),
        sa.Column("performance_impact", sa.JSON(), nullable=True),
        sa.Column("business_criticality", sa.String(length=20), nullable=True),
        sa.Column("downtime_requirements", sa.JSON(), nullable=True),
        sa.Column("user_impact", sa.Text(), nullable=True),
        sa.Column("compliance_considerations", sa.JSON(), nullable=True),
        sa.Column("ai_insights", sa.JSON(), nullable=True),
        sa.Column("ai_confidence", sa.Float(), nullable=True),
        sa.Column("ai_model_version", sa.String(length=50), nullable=True),
        sa.Column("estimated_effort_hours", sa.Integer(), nullable=True),
        sa.Column("estimated_duration_days", sa.Integer(), nullable=True),
        sa.Column("recommended_wave", sa.Integer(), nullable=True),
        sa.Column("prerequisites", sa.JSON(), nullable=True),
        sa.Column("assessor", sa.String(length=100), nullable=True),
        sa.Column(
            "assessment_date",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("review_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("approval_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["asset_id"],
            ["assets.id"],
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["migration_id"],
            ["migrations.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_assessments_client_account_id"),
        "assessments",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assessments_engagement_id"),
        "assessments",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(op.f("ix_assessments_id"), "assessments", ["id"], unique=False)
    op.create_table(
        "asset_dependencies",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("asset_id", sa.UUID(), nullable=False),
        sa.Column("depends_on_asset_id", sa.UUID(), nullable=False),
        sa.Column("dependency_type", sa.String(length=50), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.ForeignKeyConstraint(["asset_id"], ["assets.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(
            ["depends_on_asset_id"], ["assets.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_table(
        "asset_embeddings",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("asset_id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column(
            "embedding", pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True
        ),
        sa.Column("source_text", sa.Text(), nullable=True),
        sa.Column("embedding_model", sa.String(length=100), nullable=True),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(["asset_id"], ["assets.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_asset_embeddings_asset_id"),
        "asset_embeddings",
        ["asset_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_asset_embeddings_client_account_id"),
        "asset_embeddings",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_asset_embeddings_engagement_id"),
        "asset_embeddings",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_asset_embeddings_id"), "asset_embeddings", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_asset_embeddings_is_mock"),
        "asset_embeddings",
        ["is_mock"],
        unique=False,
    )
    op.create_table(
        "asset_tags",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("asset_id", sa.UUID(), nullable=False),
        sa.Column("tag_id", sa.UUID(), nullable=False),
        sa.Column("confidence_score", sa.Float(), nullable=True),
        sa.Column("assigned_method", sa.String(length=50), nullable=True),
        sa.Column("assigned_by", sa.UUID(), nullable=True),
        sa.Column("is_validated", sa.Boolean(), nullable=True),
        sa.Column("validated_by", sa.UUID(), nullable=True),
        sa.Column("validated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_mock", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(["asset_id"], ["assets.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(
            ["assigned_by"],
            ["users.id"],
        ),
        sa.ForeignKeyConstraint(["tag_id"], ["tags.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(
            ["validated_by"],
            ["users.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_asset_tags_asset_id"), "asset_tags", ["asset_id"], unique=False
    )
    op.create_index(
        op.f("ix_asset_tags_is_mock"), "asset_tags", ["is_mock"], unique=False
    )
    op.create_index(
        op.f("ix_asset_tags_tag_id"), "asset_tags", ["tag_id"], unique=False
    )
    op.create_table(
        "import_processing_steps",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("data_import_id", sa.UUID(), nullable=False),
        sa.Column("step_name", sa.String(length=100), nullable=False),
        sa.Column("step_order", sa.Integer(), nullable=False),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("input_data", sa.JSON(), nullable=True),
        sa.Column("output_data", sa.JSON(), nullable=True),
        sa.Column("error_details", sa.JSON(), nullable=True),
        sa.Column("records_processed", sa.Integer(), nullable=True),
        sa.Column("duration_seconds", sa.Float(), nullable=True),
        sa.Column(
            "started_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("completed_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["data_import_id"], ["data_imports.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        comment="Tracks individual processing steps within a data import job for observability.",
    )
    op.create_table(
        "data_quality_issues",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("data_import_id", sa.UUID(), nullable=False),
        sa.Column("raw_record_id", sa.UUID(), nullable=True),
        sa.Column("issue_type", sa.String(length=50), nullable=False),
        sa.Column("field_name", sa.String(length=255), nullable=True),
        sa.Column("current_value", sa.Text(), nullable=True),
        sa.Column("suggested_value", sa.Text(), nullable=True),
        sa.Column("severity", sa.String(length=20), nullable=True),
        sa.Column("confidence_score", sa.Float(), nullable=True),
        sa.Column("reasoning", sa.Text(), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=True),
        sa.Column("resolution_method", sa.String(length=50), nullable=True),
        sa.Column("resolved_by", sa.UUID(), nullable=True),
        sa.Column("resolution_notes", sa.Text(), nullable=True),
        sa.Column(
            "detected_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("resolved_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["data_import_id"], ["data_imports.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["raw_record_id"],
            ["raw_import_records.id"],
        ),
        sa.ForeignKeyConstraint(
            ["resolved_by"],
            ["users.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        comment="Tracks data quality issues identified during the import process.",
    )
    op.drop_index(op.f("ix_role_permissions_role_level"), table_name="role_permissions")
    op.drop_table("role_permissions")
    op.drop_index(
        op.f("ix_enhanced_access_audit_log_action"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("ix_enhanced_access_audit_log_client_account_id"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("ix_enhanced_access_audit_log_created_at"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("ix_enhanced_access_audit_log_rbac_decision"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("ix_enhanced_access_audit_log_user_id"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_table("enhanced_access_audit_log")
    op.alter_column(
        "access_audit_log", "user_id", existing_type=sa.UUID(), nullable=False
    )
    op.alter_column(
        "access_audit_log",
        "details",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "access_audit_log",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        op.f("ix_access_audit_log_client_account_id"), table_name="access_audit_log"
    )
    op.drop_index(
        op.f("ix_access_audit_log_resource_type"), table_name="access_audit_log"
    )
    op.drop_index(op.f("ix_access_audit_log_result"), table_name="access_audit_log")
    op.create_index(
        op.f("ix_access_audit_log_id"), "access_audit_log", ["id"], unique=False
    )
    op.create_foreign_key(
        None, "access_audit_log", "data_import_sessions", ["session_id"], ["id"]
    )
    op.create_foreign_key(None, "access_audit_log", "users", ["user_id"], ["id"])
    op.add_column("assets", sa.Column("session_id", sa.UUID(), nullable=True))
    op.add_column("assets", sa.Column("migration_id", sa.UUID(), nullable=True))
    op.add_column("assets", sa.Column("phase_context", sa.JSON(), nullable=True))
    op.add_column(
        "assets", sa.Column("asset_name", sa.String(length=255), nullable=True)
    )
    op.add_column("assets", sa.Column("hostname", sa.String(length=255), nullable=True))
    op.add_column(
        "assets", sa.Column("ip_address", sa.String(length=45), nullable=True)
    )
    op.add_column("assets", sa.Column("fqdn", sa.String(length=255), nullable=True))
    op.add_column(
        "assets", sa.Column("mac_address", sa.String(length=17), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("environment", sa.String(length=50), nullable=True)
    )
    op.add_column("assets", sa.Column("location", sa.String(length=100), nullable=True))
    op.add_column(
        "assets", sa.Column("datacenter", sa.String(length=100), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("rack_location", sa.String(length=50), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("availability_zone", sa.String(length=50), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("operating_system", sa.String(length=100), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("os_version", sa.String(length=50), nullable=True)
    )
    op.add_column("assets", sa.Column("cpu_cores", sa.Integer(), nullable=True))
    op.add_column("assets", sa.Column("memory_gb", sa.Float(), nullable=True))
    op.add_column("assets", sa.Column("storage_gb", sa.Float(), nullable=True))
    op.add_column(
        "assets", sa.Column("business_owner", sa.String(length=255), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("technical_owner", sa.String(length=255), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("department", sa.String(length=100), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("application_name", sa.String(length=255), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("technology_stack", sa.String(length=255), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("criticality", sa.String(length=20), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("business_criticality", sa.String(length=20), nullable=True)
    )
    op.add_column("assets", sa.Column("custom_attributes", sa.JSON(), nullable=True))
    op.add_column(
        "assets",
        sa.Column(
            "six_r_strategy",
            sa.Enum(
                "REHOST",
                "REPLATFORM",
                "REFACTOR",
                "REARCHITECT",
                "REPLACE",
                "REPURCHASE",
                "RETIRE",
                "RETAIN",
                name="sixrstrategy",
            ),
            nullable=True,
        ),
    )
    op.add_column(
        "assets", sa.Column("mapping_status", sa.String(length=20), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("migration_priority", sa.Integer(), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("migration_complexity", sa.String(length=20), nullable=True)
    )
    op.add_column("assets", sa.Column("migration_wave", sa.Integer(), nullable=True))
    op.add_column(
        "assets", sa.Column("sixr_ready", sa.String(length=50), nullable=True)
    )
    op.add_column("assets", sa.Column("status", sa.String(length=50), nullable=True))
    op.add_column(
        "assets",
        sa.Column(
            "migration_status",
            sa.Enum(
                "DISCOVERED",
                "ASSESSED",
                "PLANNED",
                "MIGRATING",
                "MIGRATED",
                "FAILED",
                "EXCLUDED",
                name="assetstatus",
            ),
            nullable=True,
        ),
    )
    op.add_column("assets", sa.Column("dependencies", sa.JSON(), nullable=True))
    op.add_column("assets", sa.Column("related_assets", sa.JSON(), nullable=True))
    op.add_column(
        "assets", sa.Column("discovery_method", sa.String(length=50), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("discovery_source", sa.String(length=100), nullable=True)
    )
    op.add_column(
        "assets",
        sa.Column("discovery_timestamp", sa.DateTime(timezone=True), nullable=True),
    )
    op.add_column(
        "assets", sa.Column("cpu_utilization_percent", sa.Float(), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("memory_utilization_percent", sa.Float(), nullable=True)
    )
    op.add_column("assets", sa.Column("disk_iops", sa.Float(), nullable=True))
    op.add_column(
        "assets", sa.Column("network_throughput_mbps", sa.Float(), nullable=True)
    )
    op.add_column("assets", sa.Column("completeness_score", sa.Float(), nullable=True))
    op.add_column("assets", sa.Column("quality_score", sa.Float(), nullable=True))
    op.add_column(
        "assets", sa.Column("current_monthly_cost", sa.Float(), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("estimated_cloud_cost", sa.Float(), nullable=True)
    )
    op.add_column("assets", sa.Column("imported_by", sa.UUID(), nullable=True))
    op.add_column(
        "assets", sa.Column("imported_at", sa.DateTime(timezone=True), nullable=True)
    )
    op.add_column(
        "assets", sa.Column("source_filename", sa.String(length=255), nullable=True)
    )
    op.add_column("assets", sa.Column("raw_data", sa.JSON(), nullable=True))
    op.add_column("assets", sa.Column("field_mappings_used", sa.JSON(), nullable=True))
    op.add_column("assets", sa.Column("is_mock", sa.Boolean(), nullable=False))
    op.add_column("assets", sa.Column("created_by", sa.UUID(), nullable=True))
    op.add_column("assets", sa.Column("updated_by", sa.UUID(), nullable=True))
    op.alter_column(
        "assets",
        "asset_type",
        existing_type=sa.VARCHAR(),
        type_=sa.Enum(
            "SERVER",
            "DATABASE",
            "APPLICATION",
            "NETWORK",
            "LOAD_BALANCER",
            "STORAGE",
            "SECURITY_GROUP",
            "VIRTUAL_MACHINE",
            "CONTAINER",
            "OTHER",
            name="assettype",
        ),
        nullable=False,
        postgresql_using="asset_type::assettype",
    )
    op.drop_index(op.f("idx_assets_current_phase"), table_name="assets")
    op.drop_index(op.f("idx_assets_discovery_flow_id"), table_name="assets")
    op.drop_index(op.f("idx_assets_master_flow_id"), table_name="assets")
    op.drop_index(op.f("idx_assets_source_phase"), table_name="assets")
    op.create_index(
        op.f("ix_assets_assessment_flow_id"),
        "assets",
        ["assessment_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assets_asset_type"), "assets", ["asset_type"], unique=False
    )
    op.create_index(
        op.f("ix_assets_current_phase"), "assets", ["current_phase"], unique=False
    )
    op.create_index(
        op.f("ix_assets_discovery_flow_id"),
        "assets",
        ["discovery_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assets_environment"), "assets", ["environment"], unique=False
    )
    op.create_index(
        op.f("ix_assets_execution_flow_id"),
        "assets",
        ["execution_flow_id"],
        unique=False,
    )
    op.create_index(op.f("ix_assets_hostname"), "assets", ["hostname"], unique=False)
    op.create_index(op.f("ix_assets_is_mock"), "assets", ["is_mock"], unique=False)
    op.create_index(
        op.f("ix_assets_mapping_status"), "assets", ["mapping_status"], unique=False
    )
    op.create_index(
        op.f("ix_assets_master_flow_id"), "assets", ["master_flow_id"], unique=False
    )
    op.create_index(
        op.f("ix_assets_migration_status"), "assets", ["migration_status"], unique=False
    )
    op.create_index(
        op.f("ix_assets_planning_flow_id"), "assets", ["planning_flow_id"], unique=False
    )
    op.create_index(
        op.f("ix_assets_session_id"), "assets", ["session_id"], unique=False
    )
    op.create_index(
        op.f("ix_assets_source_phase"), "assets", ["source_phase"], unique=False
    )
    op.create_index(op.f("ix_assets_status"), "assets", ["status"], unique=False)
    op.drop_constraint(op.f("fk_assets_master_flow_id"), "assets", type_="foreignkey")
    op.drop_constraint(op.f("assets_engagement_id_fkey"), "assets", type_="foreignkey")
    op.drop_constraint(
        op.f("fk_assets_discovery_flow_id"), "assets", type_="foreignkey"
    )
    op.drop_constraint(
        op.f("assets_client_account_id_fkey"), "assets", type_="foreignkey"
    )
    op.create_foreign_key(None, "assets", "migrations", ["migration_id"], ["id"])
    op.create_foreign_key(
        None,
        "assets",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(None, "assets", "users", ["imported_by"], ["id"])
    op.create_foreign_key(None, "assets", "users", ["created_by"], ["id"])
    op.create_foreign_key(
        None,
        "assets",
        "data_import_sessions",
        ["session_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(None, "assets", "users", ["updated_by"], ["id"])
    op.create_foreign_key(
        None, "assets", "engagements", ["engagement_id"], ["id"], ondelete="CASCADE"
    )
    op.drop_column("assets", "metadata")
    op.drop_column("assets", "phase_progression")
    op.alter_column(
        "client_access",
        "permissions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_export_data": false, "can_import_data": false, '
            '"can_manage_engagements": false, "can_manage_client_users": false, '
            '"can_configure_client_settings": false}\'::jsonb'
        ),
    )
    op.alter_column(
        "client_access",
        "restricted_environments",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
    )
    op.alter_column(
        "client_access",
        "restricted_data_types",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
    )
    op.alter_column(
        "client_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "client_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "client_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "client_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("ix_client_access_granted_by"), table_name="client_access")
    op.create_index(op.f("ix_client_access_id"), "client_access", ["id"], unique=False)
    op.alter_column(
        "client_accounts", "slug", existing_type=sa.VARCHAR(length=100), nullable=False
    )
    op.drop_constraint(
        op.f("client_accounts_slug_key"), "client_accounts", type_="unique"
    )
    op.drop_index(op.f("ix_client_accounts_name"), table_name="client_accounts")
    op.alter_column(
        "crewai_flow_state_extensions",
        "discovery_flow_id",
        existing_type=sa.UUID(),
        nullable=False,
    )
    op.drop_index(
        op.f("idx_crewai_extensions_current_phase"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("idx_crewai_extensions_master_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("idx_crewai_extensions_phase_flow_id"),
        table_name="crewai_flow_state_extensions",
    )

    # Drop dependent foreign key constraints BEFORE dropping the unique constraint they depend on
    # Use if_exists=True to safely drop constraints that may not exist
    op.drop_constraint(
        op.f("discovery_flows_master_flow_id_fkey"),
        "discovery_flows",
        type_="foreignkey",
        if_exists=True,
    )
    op.drop_constraint(
        op.f("data_imports_master_flow_id_fkey"),
        "data_imports",
        type_="foreignkey",
        if_exists=True,
    )
    op.drop_constraint(
        op.f("data_import_sessions_master_flow_id_fkey"),
        "data_import_sessions",
        type_="foreignkey",
        if_exists=True,
    )
    op.drop_constraint(
        op.f("import_field_mappings_master_flow_id_fkey"),
        "import_field_mappings",
        type_="foreignkey",
        if_exists=True,
    )
    op.drop_constraint(
        op.f("raw_import_records_master_flow_id_fkey"),
        "raw_import_records",
        type_="foreignkey",
        if_exists=True,
    )
    op.drop_constraint(
        op.f("workflow_progress_master_flow_id_fkey"),
        "workflow_progress",
        type_="foreignkey",
        if_exists=True,
    )

    op.drop_constraint(
        op.f("uq_crewai_extensions_flow_id"),
        "crewai_flow_state_extensions",
        type_="unique",
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_discovery_flow_id"),
        "crewai_flow_state_extensions",
        ["discovery_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        unique=False,
    )
    op.create_foreign_key(
        None,
        "crewai_flow_state_extensions",
        "discovery_flows",
        ["discovery_flow_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_column("crewai_flow_state_extensions", "execution_flow_id")
    op.drop_column("crewai_flow_state_extensions", "cross_phase_context")
    op.drop_column("crewai_flow_state_extensions", "current_phase")
    op.drop_column("crewai_flow_state_extensions", "planning_flow_id")
    op.drop_column("crewai_flow_state_extensions", "flow_metadata")
    op.drop_column("crewai_flow_state_extensions", "phase_flow_id")
    op.drop_column("crewai_flow_state_extensions", "assessment_flow_id")
    op.drop_column("crewai_flow_state_extensions", "phase_progression")
    op.add_column(
        "data_import_sessions",
        sa.Column("session_name", sa.String(length=255), nullable=False),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("session_display_name", sa.String(length=255), nullable=True),
    )
    op.add_column(
        "data_import_sessions", sa.Column("description", sa.Text(), nullable=True)
    )
    op.add_column(
        "data_import_sessions", sa.Column("is_default", sa.Boolean(), nullable=False)
    )
    op.add_column(
        "data_import_sessions", sa.Column("parent_session_id", sa.UUID(), nullable=True)
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("session_type", sa.String(length=50), nullable=False),
    )
    op.add_column(
        "data_import_sessions", sa.Column("auto_created", sa.Boolean(), nullable=False)
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("source_filename", sa.String(length=255), nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("progress_percentage", sa.Integer(), nullable=True),
    )
    op.add_column(
        "data_import_sessions", sa.Column("total_imports", sa.Integer(), nullable=True)
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("total_assets_processed", sa.Integer(), nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("total_records_imported", sa.Integer(), nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("data_quality_score", sa.Integer(), nullable=True),
    )
    op.add_column(
        "data_import_sessions", sa.Column("session_config", sa.JSON(), nullable=True)
    )
    op.add_column(
        "data_import_sessions", sa.Column("business_context", sa.JSON(), nullable=True)
    )
    op.add_column(
        "data_import_sessions", sa.Column("agent_insights", sa.JSON(), nullable=True)
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "last_activity_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
    )
    op.add_column(
        "data_import_sessions", sa.Column("created_by", sa.UUID(), nullable=False)
    )
    op.add_column(
        "data_import_sessions", sa.Column("is_mock", sa.Boolean(), nullable=False)
    )
    op.alter_column(
        "data_import_sessions",
        "status",
        existing_type=sa.VARCHAR(length=50),
        type_=sa.String(length=20),
        existing_nullable=False,
    )
    op.alter_column(
        "data_import_sessions",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "data_import_sessions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        op.f("ix_data_import_sessions_created_at"), table_name="data_import_sessions"
    )
    op.drop_index(
        op.f("ix_data_import_sessions_filename"), table_name="data_import_sessions"
    )
    op.drop_index(
        op.f("ix_data_import_sessions_user_id"), table_name="data_import_sessions"
    )
    op.create_index(
        op.f("ix_data_import_sessions_id"), "data_import_sessions", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_data_import_sessions_is_default"),
        "data_import_sessions",
        ["is_default"],
        unique=False,
    )
    op.create_index(
        op.f("ix_data_import_sessions_is_mock"),
        "data_import_sessions",
        ["is_mock"],
        unique=False,
    )
    op.create_index(
        op.f("ix_data_import_sessions_session_name"),
        "data_import_sessions",
        ["session_name"],
        unique=False,
    )
    op.drop_constraint(
        op.f("data_import_sessions_client_account_id_fkey"),
        "data_import_sessions",
        type_="foreignkey",
    )
    # op.drop_constraint(op.f('data_import_sessions_master_flow_id_fkey'),
    # 'data_import_sessions', type_='foreignkey')  # Already dropped earlier
    op.drop_constraint(
        op.f("data_import_sessions_engagement_id_fkey"),
        "data_import_sessions",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "data_import_sessions",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(None, "data_import_sessions", "users", ["created_by"], ["id"])
    op.create_foreign_key(
        None,
        "data_import_sessions",
        "data_import_sessions",
        ["parent_session_id"],
        ["id"],
        ondelete="SET NULL",
    )
    op.create_foreign_key(
        None,
        "data_import_sessions",
        "engagements",
        ["engagement_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.drop_column("data_import_sessions", "original_filename")
    op.drop_column("data_import_sessions", "processing_log")
    op.drop_column("data_import_sessions", "filename")
    op.drop_column("data_import_sessions", "master_flow_id")
    op.drop_column("data_import_sessions", "user_email")
    op.drop_column("data_import_sessions", "processed_rows")
    op.drop_column("data_import_sessions", "field_mappings")
    op.drop_column("data_import_sessions", "successful_rows")
    op.drop_column("data_import_sessions", "file_size")
    op.drop_column("data_import_sessions", "error_rows")
    op.drop_column("data_import_sessions", "validation_errors")
    op.drop_column("data_import_sessions", "total_rows")
    op.drop_column("data_import_sessions", "agent_analysis")
    op.drop_column("data_import_sessions", "file_hash")
    op.drop_column("data_import_sessions", "data_quality_metrics")
    op.drop_column("data_import_sessions", "user_id")
    op.add_column(
        "data_imports", sa.Column("import_name", sa.String(length=255), nullable=False)
    )
    op.add_column(
        "data_imports", sa.Column("import_type", sa.String(length=50), nullable=False)
    )
    op.add_column("data_imports", sa.Column("description", sa.Text(), nullable=True))
    op.add_column(
        "data_imports",
        sa.Column("source_filename", sa.String(length=255), nullable=False),
    )
    op.add_column(
        "data_imports", sa.Column("file_size_bytes", sa.Integer(), nullable=True)
    )
    op.add_column(
        "data_imports", sa.Column("file_type", sa.String(length=100), nullable=True)
    )
    op.add_column(
        "data_imports", sa.Column("file_hash", sa.String(length=64), nullable=True)
    )
    op.add_column(
        "data_imports", sa.Column("progress_percentage", sa.Float(), nullable=True)
    )
    op.add_column(
        "data_imports", sa.Column("total_records", sa.Integer(), nullable=True)
    )
    op.add_column(
        "data_imports", sa.Column("processed_records", sa.Integer(), nullable=True)
    )
    op.add_column(
        "data_imports", sa.Column("failed_records", sa.Integer(), nullable=True)
    )
    op.add_column("data_imports", sa.Column("import_config", sa.JSON(), nullable=True))
    op.add_column("data_imports", sa.Column("imported_by", sa.UUID(), nullable=False))
    op.add_column(
        "data_imports",
        sa.Column(
            "started_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
    )
    op.add_column("data_imports", sa.Column("is_mock", sa.Boolean(), nullable=False))
    op.alter_column(
        "data_imports", "client_account_id", existing_type=sa.UUID(), nullable=True
    )
    op.alter_column(
        "data_imports", "engagement_id", existing_type=sa.UUID(), nullable=True
    )
    op.drop_index(op.f("idx_data_imports_master_flow_id"), table_name="data_imports")
    op.drop_index(op.f("ix_data_imports_client_account_id"), table_name="data_imports")
    op.drop_index(op.f("ix_data_imports_engagement_id"), table_name="data_imports")
    op.drop_index(op.f("ix_data_imports_filename"), table_name="data_imports")
    op.drop_index(op.f("ix_data_imports_id"), table_name="data_imports")
    op.drop_index(op.f("ix_data_imports_status"), table_name="data_imports")
    op.drop_index(op.f("ix_data_imports_user_id"), table_name="data_imports")
    op.drop_constraint(
        op.f("data_imports_client_account_id_fkey"), "data_imports", type_="foreignkey"
    )
    # op.drop_constraint(op.f('data_imports_engagement_id_fkey'), 'data_imports', type_='foreignkey')
    # op.drop_constraint(op.f('data_imports_master_flow_id_fkey'), 'data_imports', type_='foreignkey')
    op.create_foreign_key(None, "data_imports", "users", ["imported_by"], ["id"])
    op.create_foreign_key(
        None,
        "data_imports",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "data_imports",
        "engagements",
        ["engagement_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "data_imports",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_table_comment(
        "data_imports",
        "Tracks data import jobs and their metadata, with multi-tenancy.",
        existing_comment=None,
        schema=None,
    )
    op.drop_column("data_imports", "processing_log")
    op.drop_column("data_imports", "filename")
    op.drop_column("data_imports", "agent_insights")
    op.drop_column("data_imports", "error_count")
    op.drop_column("data_imports", "field_mappings")
    op.drop_column("data_imports", "processed_rows")
    op.drop_column("data_imports", "file_size")
    op.drop_column("data_imports", "validation_results")
    op.drop_column("data_imports", "total_rows")
    op.drop_column("data_imports", "user_id")
    op.add_column(
        "discovery_flows", sa.Column("data_import_id", sa.UUID(), nullable=True)
    )
    op.add_column(
        "discovery_flows", sa.Column("flow_name", sa.String(length=255), nullable=False)
    )
    op.add_column(
        "discovery_flows", sa.Column("flow_description", sa.Text(), nullable=True)
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "crewai_state_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
    )
    op.add_column("discovery_flows", sa.Column("is_mock", sa.Boolean(), nullable=False))
    op.drop_column("discovery_flows", "flow_id")
    op.add_column("discovery_flows", sa.Column("flow_id", sa.UUID(), nullable=False))
    op.alter_column(
        "discovery_flows", "master_flow_id", existing_type=sa.UUID(), nullable=True
    )
    op.alter_column(
        "discovery_flows",
        "user_id",
        existing_type=sa.UUID(),
        type_=sa.String(),
        existing_nullable=False,
    )
    op.drop_column("discovery_flows", "crewai_persistence_id")
    op.add_column(
        "discovery_flows", sa.Column("crewai_persistence_id", sa.UUID(), nullable=True)
    )
    op.alter_column(
        "discovery_flows",
        "assessment_package",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
    )
    op.drop_index(
        op.f("idx_discovery_flows_master_flow_id"), table_name="discovery_flows"
    )
    # op.drop_index(op.f('ix_discovery_flows_crewai_persistence_id'), table_name='discovery_flows')
    op.drop_index(op.f("ix_discovery_flows_user_id"), table_name="discovery_flows")
    op.create_index(
        op.f("ix_discovery_flows_data_import_id"),
        "discovery_flows",
        ["data_import_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_flows_id"), "discovery_flows", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_flows_is_mock"), "discovery_flows", ["is_mock"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_flows_master_flow_id"),
        "discovery_flows",
        ["master_flow_id"],
        unique=False,
    )
    # op.create_index(op.f('ix_discovery_flows_status'), 'discovery_flows', ['status'], unique=False)
    # op.drop_constraint(op.f('discovery_flows_master_flow_id_fkey'), 'discovery_flows', type_='foreignkey')
    op.drop_column("discovery_flows", "warnings")
    op.drop_column("discovery_flows", "started_at")
    op.drop_column("discovery_flows", "dependencies")
    op.drop_column("discovery_flows", "agent_insights")
    op.drop_column("discovery_flows", "crewai_flow_state")
    op.drop_column("discovery_flows", "field_mappings")
    op.drop_column("discovery_flows", "current_phase")
    op.drop_column("discovery_flows", "crew_status")
    op.drop_column("discovery_flows", "workflow_log")
    op.drop_column("discovery_flows", "asset_inventory")
    op.drop_column("discovery_flows", "tech_debt")
    op.drop_column("discovery_flows", "cleaned_data")
    op.drop_column("discovery_flows", "errors")
    op.drop_column("discovery_flows", "knowledge_base_refs")
    op.drop_column("discovery_flows", "raw_data")
    op.drop_column("discovery_flows", "shared_memory_refs")
    op.drop_column("discovery_flows", "crew_performance_metrics")
    op.alter_column(
        "engagement_access",
        "permissions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_export_data": false, "can_import_data": false, '
            '"can_manage_sessions": false, "can_configure_agents": false, '
            '"can_access_sensitive_data": false, "can_approve_migration_decisions": false}\'::jsonb'
        ),
    )
    op.alter_column(
        "engagement_access",
        "restricted_sessions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
    )
    op.alter_column(
        "engagement_access",
        "allowed_session_types",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text('\'["data_import", "validation_run"]\'::jsonb'),
    )
    op.alter_column(
        "engagement_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "engagement_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "engagement_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "engagement_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        op.f("ix_engagement_access_granted_by"), table_name="engagement_access"
    )
    op.create_index(
        op.f("ix_engagement_access_id"), "engagement_access", ["id"], unique=False
    )
    op.alter_column(
        "engagements", "slug", existing_type=sa.VARCHAR(length=100), nullable=False
    )
    op.alter_column(
        "engagements",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("true"),
    )
    op.drop_index(op.f("ix_engagements_name"), table_name="engagements")
    op.drop_constraint(
        op.f("engagements_client_account_id_fkey"), "engagements", type_="foreignkey"
    )
    op.create_foreign_key(
        None,
        "engagements",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.add_column(
        "flow_deletion_audit", sa.Column("session_id", sa.UUID(), nullable=False)
    )
    op.add_column(
        "flow_deletion_audit", sa.Column("flow_id", sa.UUID(), nullable=False)
    )
    op.add_column(
        "flow_deletion_audit", sa.Column("user_id", sa.String(), nullable=False)
    )
    op.add_column(
        "flow_deletion_audit", sa.Column("deletion_type", sa.String(), nullable=False)
    )
    op.add_column(
        "flow_deletion_audit", sa.Column("deletion_method", sa.String(), nullable=False)
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "data_deleted", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "deletion_impact", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "cleanup_summary", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column("shared_memory_cleaned", sa.Boolean(), nullable=False),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "knowledge_base_refs_cleaned",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column("agent_memory_cleaned", sa.Boolean(), nullable=False),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "deleted_at",
            sa.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
    )
    op.add_column(
        "flow_deletion_audit", sa.Column("deleted_by", sa.String(), nullable=False)
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column("deletion_duration_ms", sa.Integer(), nullable=True),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column("recovery_possible", sa.Boolean(), nullable=False),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "recovery_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
    )
    op.alter_column(
        "flow_deletion_audit",
        "client_account_id",
        existing_type=sa.UUID(),
        nullable=False,
    )
    op.alter_column(
        "flow_deletion_audit", "engagement_id", existing_type=sa.UUID(), nullable=False
    )
    op.alter_column(
        "flow_deletion_audit",
        "deletion_reason",
        existing_type=sa.VARCHAR(length=200),
        type_=sa.Text(),
        existing_nullable=True,
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_created_at"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deleted_by_user_id"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deleted_flow_id"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_flow_type"), table_name="flow_deletion_audit"
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deleted_at"),
        "flow_deletion_audit",
        ["deleted_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deletion_type"),
        "flow_deletion_audit",
        ["deletion_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_engagement_id"),
        "flow_deletion_audit",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_session_id"),
        "flow_deletion_audit",
        ["session_id"],
        unique=False,
    )
    op.drop_constraint(
        op.f("flow_deletion_audit_client_account_id_fkey"),
        "flow_deletion_audit",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("flow_deletion_audit_engagement_id_fkey"),
        "flow_deletion_audit",
        type_="foreignkey",
    )
    op.drop_column("flow_deletion_audit", "cleanup_actions_taken")
    op.drop_column("flow_deletion_audit", "deleted_by_user_email")
    op.drop_column("flow_deletion_audit", "flow_type")
    op.drop_column("flow_deletion_audit", "created_at")
    op.drop_column("flow_deletion_audit", "deleted_by_user_id")
    op.drop_column("flow_deletion_audit", "flow_data_snapshot")
    op.drop_column("flow_deletion_audit", "related_assets_count")
    op.drop_column("flow_deletion_audit", "deleted_flow_id")
    op.add_column(
        "import_field_mappings", sa.Column("data_import_id", sa.UUID(), nullable=False)
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("mapping_type", sa.String(length=50), nullable=False),
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("confidence_score", sa.Float(), nullable=True),
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("is_user_defined", sa.Boolean(), nullable=True),
    )
    op.add_column(
        "import_field_mappings", sa.Column("is_validated", sa.Boolean(), nullable=True)
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("validation_method", sa.String(length=50), nullable=True),
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("status", sa.String(length=20), nullable=True),
    )
    op.add_column(
        "import_field_mappings", sa.Column("user_feedback", sa.Text(), nullable=True)
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("original_ai_suggestion", sa.String(length=255), nullable=True),
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("correction_reason", sa.Text(), nullable=True),
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("transformation_logic", sa.JSON(), nullable=True),
    )
    op.add_column(
        "import_field_mappings", sa.Column("sample_values", sa.JSON(), nullable=True)
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("suggested_by", sa.String(length=50), nullable=True),
    )
    op.add_column(
        "import_field_mappings", sa.Column("validated_by", sa.UUID(), nullable=True)
    )
    op.add_column(
        "import_field_mappings",
        sa.Column("validated_at", sa.DateTime(timezone=True), nullable=True),
    )
    op.alter_column(
        "import_field_mappings",
        "validation_rules",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
    )
    op.drop_index(
        op.f("idx_import_field_mappings_master_flow_id"),
        table_name="import_field_mappings",
    )
    # Constraint already dropped earlier before uq_crewai_extensions_flow_id
    op.create_foreign_key(
        None,
        "import_field_mappings",
        "data_imports",
        ["data_import_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None, "import_field_mappings", "users", ["validated_by"], ["id"]
    )
    op.create_table_comment(
        "import_field_mappings",
        "Manages field mappings for data imports, including AI suggestions and user overrides.",
        existing_comment=None,
        schema=None,
    )
    op.drop_column("import_field_mappings", "mapping_confidence")
    op.drop_column("import_field_mappings", "master_flow_id")
    op.add_column(
        "raw_import_records", sa.Column("data_import_id", sa.UUID(), nullable=False)
    )
    op.add_column(
        "raw_import_records", sa.Column("client_account_id", sa.UUID(), nullable=True)
    )
    op.add_column(
        "raw_import_records", sa.Column("engagement_id", sa.UUID(), nullable=True)
    )
    op.add_column(
        "raw_import_records", sa.Column("row_number", sa.Integer(), nullable=False)
    )
    op.add_column(
        "raw_import_records",
        sa.Column("record_id", sa.String(length=255), nullable=True),
    )
    op.add_column(
        "raw_import_records", sa.Column("processing_notes", sa.Text(), nullable=True)
    )
    op.add_column(
        "raw_import_records", sa.Column("is_processed", sa.Boolean(), nullable=True)
    )
    op.add_column(
        "raw_import_records", sa.Column("is_valid", sa.Boolean(), nullable=True)
    )
    op.add_column("raw_import_records", sa.Column("asset_id", sa.UUID(), nullable=True))
    op.add_column(
        "raw_import_records",
        sa.Column("processed_at", sa.DateTime(timezone=True), nullable=True),
    )
    op.alter_column(
        "raw_import_records", "master_flow_id", existing_type=sa.UUID(), nullable=True
    )
    op.alter_column(
        "raw_import_records",
        "raw_data",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=False,
    )
    op.alter_column(
        "raw_import_records",
        "processed_data",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
    )
    op.alter_column(
        "raw_import_records",
        "validation_errors",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
    )
    # op.drop_index(op.f('idx_raw_import_records_master_flow_id'), table_name='raw_import_records')
    # op.drop_constraint(op.f('raw_import_records_master_flow_id_fkey'), 'raw_import_records', type_='foreignkey')
    op.create_foreign_key(
        None,
        "raw_import_records",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["id"],
    )
    op.create_foreign_key(
        None, "raw_import_records", "client_accounts", ["client_account_id"], ["id"]
    )
    op.create_foreign_key(
        None,
        "raw_import_records",
        "data_imports",
        ["data_import_id"],
        ["id"],
        ondelete="CASCADE",
    )
    op.create_foreign_key(None, "raw_import_records", "assets", ["asset_id"], ["id"])
    op.create_foreign_key(
        None, "raw_import_records", "engagements", ["engagement_id"], ["id"]
    )
    op.create_table_comment(
        "raw_import_records",
        "Stores individual raw data records from imported files before processing.",
        existing_comment=None,
        schema=None,
    )
    op.drop_column("raw_import_records", "row_index")
    op.drop_column("raw_import_records", "validation_status")
    op.drop_index(
        op.f("ix_role_change_approvals_status"), table_name="role_change_approvals"
    )
    op.alter_column(
        "security_audit_logs",
        "is_suspicious",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "security_audit_logs",
        "requires_review",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "security_audit_logs",
        "is_blocked",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.create_index(
        op.f("ix_security_audit_logs_event_category"),
        "security_audit_logs",
        ["event_category"],
        unique=False,
    )
    op.alter_column(
        "user_account_associations",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_account_associations",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_constraint(
        op.f("uq_user_account_associations_user_client"),
        "user_account_associations",
        type_="unique",
    )
    op.create_unique_constraint(
        "_user_client_account_uc",
        "user_account_associations",
        ["user_id", "client_account_id"],
    )
    op.alter_column(
        "user_profiles",
        "notification_preferences",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"system_alerts": true, "weekly_reports": true, '
            '"learning_updates": false, "email_notifications": true}\'::jsonb'
        ),
    )
    op.alter_column(
        "user_profiles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_profiles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("ix_user_profiles_approved_by"), table_name="user_profiles")
    op.alter_column(
        "user_roles",
        "permissions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_export_data": true, "can_import_data": true, "can_manage_users": false, '
            '"can_create_clients": false, "can_view_analytics": true, "can_configure_agents": false, '
            '"can_manage_engagements": false, "can_access_admin_console": false}\'::jsonb'
        ),
    )
    op.alter_column(
        "user_roles",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "user_roles",
        "assigned_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_roles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_roles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(op.f("ix_user_roles_role_type"), table_name="user_roles")
    op.drop_index(op.f("ix_user_roles_scope_type"), table_name="user_roles")
    op.add_column("users", sa.Column("default_client_id", sa.UUID(), nullable=True))
    op.add_column("users", sa.Column("default_engagement_id", sa.UUID(), nullable=True))
    op.alter_column(
        "users",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "users",
        "is_verified",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "users",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "users",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
    )
    op.drop_constraint(op.f("uq_users_email"), "users", type_="unique")
    op.create_foreign_key(
        None, "users", "engagements", ["default_engagement_id"], ["id"]
    )
    op.create_foreign_key(
        None, "users", "client_accounts", ["default_client_id"], ["id"]
    )
    op.add_column("workflow_progress", sa.Column("asset_id", sa.UUID(), nullable=False))
    op.add_column(
        "workflow_progress", sa.Column("stage", sa.String(length=50), nullable=False)
    )
    op.add_column("workflow_progress", sa.Column("notes", sa.Text(), nullable=True))
    op.add_column(
        "workflow_progress", sa.Column("is_mock", sa.Boolean(), nullable=False)
    )
    op.add_column(
        "workflow_progress",
        sa.Column("started_at", sa.DateTime(timezone=True), nullable=True),
    )
    # op.drop_index(op.f('idx_workflow_progress_master_flow_id'), table_name='workflow_progress')
    # op.drop_constraint(op.f('workflow_progress_master_flow_id_fkey'), 'workflow_progress', type_='foreignkey')
    op.create_foreign_key(
        None, "workflow_progress", "assets", ["asset_id"], ["id"], ondelete="CASCADE"
    )
    op.drop_column("workflow_progress", "progress_percentage")
    op.drop_column("workflow_progress", "phase")
    op.drop_column("workflow_progress", "master_flow_id")
    op.drop_column("workflow_progress", "step")
    op.drop_column("workflow_progress", "created_at")
    op.drop_column("workflow_progress", "step_data")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "workflow_progress",
        sa.Column(
            "step_data",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "workflow_progress",
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "workflow_progress",
        sa.Column("step", sa.VARCHAR(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "workflow_progress",
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "workflow_progress",
        sa.Column("phase", sa.VARCHAR(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "workflow_progress",
        sa.Column(
            "progress_percentage",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_constraint(None, "workflow_progress", type_="foreignkey")
    op.create_foreign_key(
        op.f("workflow_progress_master_flow_id_fkey"),
        "workflow_progress",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.create_index(
        op.f("idx_workflow_progress_master_flow_id"),
        "workflow_progress",
        ["master_flow_id"],
        unique=False,
    )
    op.drop_column("workflow_progress", "started_at")
    op.drop_column("workflow_progress", "is_mock")
    op.drop_column("workflow_progress", "notes")
    op.drop_column("workflow_progress", "stage")
    op.drop_column("workflow_progress", "asset_id")
    op.drop_constraint(None, "users", type_="foreignkey")
    op.drop_constraint(None, "users", type_="foreignkey")
    op.create_unique_constraint(
        op.f("uq_users_email"), "users", ["email"], postgresql_nulls_not_distinct=False
    )
    op.alter_column(
        "users",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "users",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "users",
        "is_verified",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "users",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("true"),
    )
    op.drop_column("users", "default_engagement_id")
    op.drop_column("users", "default_client_id")
    op.create_index(
        op.f("ix_user_roles_scope_type"), "user_roles", ["scope_type"], unique=False
    )
    op.create_index(
        op.f("ix_user_roles_role_type"), "user_roles", ["role_type"], unique=False
    )
    op.alter_column(
        "user_roles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_roles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_roles",
        "assigned_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_roles",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "user_roles",
        "permissions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_export_data": true, "can_import_data": true, "can_manage_users": false, '
            '"can_create_clients": false, "can_view_analytics": true, "can_configure_agents": false, '
            '"can_manage_engagements": false, "can_access_admin_console": false}\'::jsonb'
        ),
    )
    op.create_index(
        op.f("ix_user_profiles_approved_by"),
        "user_profiles",
        ["approved_by"],
        unique=False,
    )
    op.alter_column(
        "user_profiles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_profiles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_profiles",
        "notification_preferences",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"system_alerts": true, "weekly_reports": true, '
            '"learning_updates": false, "email_notifications": true}\'::jsonb'
        ),
    )
    op.drop_constraint(
        "_user_client_account_uc", "user_account_associations", type_="unique"
    )
    op.create_unique_constraint(
        op.f("uq_user_account_associations_user_client"),
        "user_account_associations",
        ["user_id", "client_account_id"],
        postgresql_nulls_not_distinct=False,
    )
    op.alter_column(
        "user_account_associations",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "user_account_associations",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.drop_index(
        op.f("ix_security_audit_logs_event_category"), table_name="security_audit_logs"
    )
    op.alter_column(
        "security_audit_logs",
        "is_blocked",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "security_audit_logs",
        "requires_review",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.alter_column(
        "security_audit_logs",
        "is_suspicious",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
    )
    op.create_index(
        op.f("ix_role_change_approvals_status"),
        "role_change_approvals",
        ["status"],
        unique=False,
    )
    op.add_column(
        "raw_import_records",
        sa.Column(
            "validation_status", sa.VARCHAR(), autoincrement=False, nullable=False
        ),
    )
    op.add_column(
        "raw_import_records",
        sa.Column("row_index", sa.INTEGER(), autoincrement=False, nullable=False),
    )
    op.drop_table_comment(
        "raw_import_records",
        existing_comment="Stores individual raw data records from imported files before processing.",
        schema=None,
    )
    op.drop_constraint(None, "raw_import_records", type_="foreignkey")
    op.drop_constraint(None, "raw_import_records", type_="foreignkey")
    op.drop_constraint(None, "raw_import_records", type_="foreignkey")
    op.drop_constraint(None, "raw_import_records", type_="foreignkey")
    op.drop_constraint(None, "raw_import_records", type_="foreignkey")
    op.create_foreign_key(
        op.f("raw_import_records_master_flow_id_fkey"),
        "raw_import_records",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.create_index(
        op.f("idx_raw_import_records_master_flow_id"),
        "raw_import_records",
        ["master_flow_id"],
        unique=False,
    )
    op.alter_column(
        "raw_import_records",
        "validation_errors",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
    )
    op.alter_column(
        "raw_import_records",
        "processed_data",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
    )
    op.alter_column(
        "raw_import_records",
        "raw_data",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=False,
    )
    op.alter_column(
        "raw_import_records", "master_flow_id", existing_type=sa.UUID(), nullable=False
    )
    op.drop_column("raw_import_records", "processed_at")
    op.drop_column("raw_import_records", "asset_id")
    op.drop_column("raw_import_records", "is_valid")
    op.drop_column("raw_import_records", "is_processed")
    op.drop_column("raw_import_records", "processing_notes")
    op.drop_column("raw_import_records", "record_id")
    op.drop_column("raw_import_records", "row_number")
    op.drop_column("raw_import_records", "engagement_id")
    op.drop_column("raw_import_records", "client_account_id")
    op.drop_column("raw_import_records", "data_import_id")
    op.add_column(
        "import_field_mappings",
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "import_field_mappings",
        sa.Column(
            "mapping_confidence",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_table_comment(
        "import_field_mappings",
        existing_comment="Manages field mappings for data imports, including AI suggestions and user overrides.",
        schema=None,
    )
    op.drop_constraint(None, "import_field_mappings", type_="foreignkey")
    op.drop_constraint(None, "import_field_mappings", type_="foreignkey")
    op.create_foreign_key(
        op.f("import_field_mappings_master_flow_id_fkey"),
        "import_field_mappings",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.create_index(
        op.f("idx_import_field_mappings_master_flow_id"),
        "import_field_mappings",
        ["master_flow_id"],
        unique=False,
    )
    op.alter_column(
        "import_field_mappings",
        "validation_rules",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
    )
    op.drop_column("import_field_mappings", "validated_at")
    op.drop_column("import_field_mappings", "validated_by")
    op.drop_column("import_field_mappings", "suggested_by")
    op.drop_column("import_field_mappings", "sample_values")
    op.drop_column("import_field_mappings", "transformation_logic")
    op.drop_column("import_field_mappings", "correction_reason")
    op.drop_column("import_field_mappings", "original_ai_suggestion")
    op.drop_column("import_field_mappings", "user_feedback")
    op.drop_column("import_field_mappings", "status")
    op.drop_column("import_field_mappings", "validation_method")
    op.drop_column("import_field_mappings", "is_validated")
    op.drop_column("import_field_mappings", "is_user_defined")
    op.drop_column("import_field_mappings", "confidence_score")
    op.drop_column("import_field_mappings", "mapping_type")
    op.drop_column("import_field_mappings", "data_import_id")
    op.add_column(
        "flow_deletion_audit",
        sa.Column("deleted_flow_id", sa.UUID(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "related_assets_count", sa.INTEGER(), autoincrement=False, nullable=True
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "flow_data_snapshot",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column("deleted_by_user_id", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "flow_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "deleted_by_user_email",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "flow_deletion_audit",
        sa.Column(
            "cleanup_actions_taken",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.create_foreign_key(
        op.f("flow_deletion_audit_engagement_id_fkey"),
        "flow_deletion_audit",
        "engagements",
        ["engagement_id"],
        ["id"],
    )
    op.create_foreign_key(
        op.f("flow_deletion_audit_client_account_id_fkey"),
        "flow_deletion_audit",
        "client_accounts",
        ["client_account_id"],
        ["id"],
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_session_id"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_engagement_id"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deletion_type"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deleted_at"), table_name="flow_deletion_audit"
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_flow_type"),
        "flow_deletion_audit",
        ["flow_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deleted_flow_id"),
        "flow_deletion_audit",
        ["deleted_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deleted_by_user_id"),
        "flow_deletion_audit",
        ["deleted_by_user_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_created_at"),
        "flow_deletion_audit",
        ["created_at"],
        unique=False,
    )
    op.alter_column(
        "flow_deletion_audit",
        "deletion_reason",
        existing_type=sa.Text(),
        type_=sa.VARCHAR(length=200),
        existing_nullable=True,
    )
    op.alter_column(
        "flow_deletion_audit", "engagement_id", existing_type=sa.UUID(), nullable=True
    )
    op.alter_column(
        "flow_deletion_audit",
        "client_account_id",
        existing_type=sa.UUID(),
        nullable=True,
    )
    op.drop_column("flow_deletion_audit", "recovery_data")
    op.drop_column("flow_deletion_audit", "recovery_possible")
    op.drop_column("flow_deletion_audit", "deletion_duration_ms")
    op.drop_column("flow_deletion_audit", "deleted_by")
    op.drop_column("flow_deletion_audit", "deleted_at")
    op.drop_column("flow_deletion_audit", "agent_memory_cleaned")
    op.drop_column("flow_deletion_audit", "knowledge_base_refs_cleaned")
    op.drop_column("flow_deletion_audit", "shared_memory_cleaned")
    op.drop_column("flow_deletion_audit", "cleanup_summary")
    op.drop_column("flow_deletion_audit", "deletion_impact")
    op.drop_column("flow_deletion_audit", "data_deleted")
    op.drop_column("flow_deletion_audit", "deletion_method")
    op.drop_column("flow_deletion_audit", "deletion_type")
    op.drop_column("flow_deletion_audit", "user_id")
    op.drop_column("flow_deletion_audit", "flow_id")
    op.drop_column("flow_deletion_audit", "session_id")
    op.drop_constraint(None, "engagements", type_="foreignkey")
    op.create_foreign_key(
        op.f("engagements_client_account_id_fkey"),
        "engagements",
        "client_accounts",
        ["client_account_id"],
        ["id"],
    )
    op.create_index(op.f("ix_engagements_name"), "engagements", ["name"], unique=False)
    op.alter_column(
        "engagements",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "engagements", "slug", existing_type=sa.VARCHAR(length=100), nullable=True
    )
    op.drop_index(op.f("ix_engagement_access_id"), table_name="engagement_access")
    op.create_index(
        op.f("ix_engagement_access_granted_by"),
        "engagement_access",
        ["granted_by"],
        unique=False,
    )
    op.alter_column(
        "engagement_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "engagement_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "engagement_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "engagement_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "engagement_access",
        "allowed_session_types",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text('\'["data_import", "validation_run"]\'::jsonb'),
    )
    op.alter_column(
        "engagement_access",
        "restricted_sessions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
    )
    op.alter_column(
        "engagement_access",
        "permissions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_export_data": false, "can_import_data": false, '
            '"can_manage_sessions": false, "can_configure_agents": false, '
            '"can_access_sensitive_data": false, "can_approve_migration_decisions": false}\'::jsonb'
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "crew_performance_metrics",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "shared_memory_refs",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "raw_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "knowledge_base_refs",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "errors",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "cleaned_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "tech_debt",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "asset_inventory",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "workflow_log",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "crew_status",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "current_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "field_mappings",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "crewai_flow_state",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "agent_insights",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "dependencies",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "started_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "discovery_flows",
        sa.Column(
            "warnings",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.create_foreign_key(
        op.f("discovery_flows_master_flow_id_fkey"),
        "discovery_flows",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.drop_index(op.f("ix_discovery_flows_status"), table_name="discovery_flows")
    op.drop_index(
        op.f("ix_discovery_flows_master_flow_id"), table_name="discovery_flows"
    )
    op.drop_index(op.f("ix_discovery_flows_is_mock"), table_name="discovery_flows")
    op.drop_index(op.f("ix_discovery_flows_id"), table_name="discovery_flows")
    op.drop_index(
        op.f("ix_discovery_flows_data_import_id"), table_name="discovery_flows"
    )
    op.create_index(
        op.f("ix_discovery_flows_user_id"), "discovery_flows", ["user_id"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_flows_crewai_persistence_id"),
        "discovery_flows",
        ["crewai_persistence_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_discovery_flows_master_flow_id"),
        "discovery_flows",
        ["master_flow_id"],
        unique=False,
    )
    op.alter_column(
        "discovery_flows",
        "assessment_package",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=postgresql.JSON(astext_type=sa.Text()),
        existing_nullable=True,
    )
    op.alter_column(
        "discovery_flows",
        "crewai_persistence_id",
        existing_type=sa.UUID(),
        type_=sa.VARCHAR(length=255),
        existing_nullable=True,
    )
    op.alter_column(
        "discovery_flows",
        "user_id",
        existing_type=sa.String(),
        type_=sa.UUID(),
        existing_nullable=False,
    )
    op.alter_column(
        "discovery_flows", "master_flow_id", existing_type=sa.UUID(), nullable=False
    )
    op.alter_column(
        "discovery_flows",
        "flow_id",
        existing_type=sa.UUID(),
        type_=sa.VARCHAR(length=255),
        existing_nullable=False,
    )
    op.drop_column("discovery_flows", "is_mock")
    op.drop_column("discovery_flows", "crewai_state_data")
    op.drop_column("discovery_flows", "flow_description")
    op.drop_column("discovery_flows", "flow_name")
    op.drop_column("discovery_flows", "data_import_id")
    op.add_column(
        "data_imports",
        sa.Column("user_id", sa.VARCHAR(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "data_imports",
        sa.Column("total_rows", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_imports",
        sa.Column(
            "validation_results",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_imports",
        sa.Column("file_size", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_imports",
        sa.Column("processed_rows", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_imports",
        sa.Column(
            "field_mappings",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_imports",
        sa.Column("error_count", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_imports",
        sa.Column(
            "agent_insights",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_imports",
        sa.Column("filename", sa.VARCHAR(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "data_imports",
        sa.Column(
            "processing_log",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_table_comment(
        "data_imports",
        existing_comment="Tracks data import jobs and their metadata, with multi-tenancy.",
        schema=None,
    )
    op.drop_constraint(None, "data_imports", type_="foreignkey")
    op.drop_constraint(None, "data_imports", type_="foreignkey")
    op.drop_constraint(None, "data_imports", type_="foreignkey")
    op.drop_constraint(None, "data_imports", type_="foreignkey")
    op.create_foreign_key(
        op.f("data_imports_master_flow_id_fkey"),
        "data_imports",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.create_foreign_key(
        op.f("data_imports_engagement_id_fkey"),
        "data_imports",
        "engagements",
        ["engagement_id"],
        ["id"],
    )
    op.create_foreign_key(
        op.f("data_imports_client_account_id_fkey"),
        "data_imports",
        "client_accounts",
        ["client_account_id"],
        ["id"],
    )
    op.create_index(
        op.f("ix_data_imports_user_id"), "data_imports", ["user_id"], unique=False
    )
    op.create_index(
        op.f("ix_data_imports_status"), "data_imports", ["status"], unique=False
    )
    op.create_index(op.f("ix_data_imports_id"), "data_imports", ["id"], unique=False)
    op.create_index(
        op.f("ix_data_imports_filename"), "data_imports", ["filename"], unique=False
    )
    op.create_index(
        op.f("ix_data_imports_engagement_id"),
        "data_imports",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_data_imports_client_account_id"),
        "data_imports",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_data_imports_master_flow_id"),
        "data_imports",
        ["master_flow_id"],
        unique=False,
    )
    op.alter_column(
        "data_imports", "engagement_id", existing_type=sa.UUID(), nullable=False
    )
    op.alter_column(
        "data_imports", "client_account_id", existing_type=sa.UUID(), nullable=False
    )
    op.drop_column("data_imports", "is_mock")
    op.drop_column("data_imports", "started_at")
    op.drop_column("data_imports", "imported_by")
    op.drop_column("data_imports", "import_config")
    op.drop_column("data_imports", "failed_records")
    op.drop_column("data_imports", "processed_records")
    op.drop_column("data_imports", "total_records")
    op.drop_column("data_imports", "progress_percentage")
    op.drop_column("data_imports", "file_hash")
    op.drop_column("data_imports", "file_type")
    op.drop_column("data_imports", "file_size_bytes")
    op.drop_column("data_imports", "source_filename")
    op.drop_column("data_imports", "description")
    op.drop_column("data_imports", "import_type")
    op.drop_column("data_imports", "import_name")
    op.add_column(
        "data_import_sessions",
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "data_quality_metrics",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "file_hash", sa.VARCHAR(length=64), autoincrement=False, nullable=True
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "agent_analysis",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("total_rows", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "validation_errors",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("error_rows", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("file_size", sa.BIGINT(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("successful_rows", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "field_mappings",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("processed_rows", sa.INTEGER(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "user_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "filename", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "processing_log",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "data_import_sessions",
        sa.Column(
            "original_filename",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_constraint(None, "data_import_sessions", type_="foreignkey")
    op.drop_constraint(None, "data_import_sessions", type_="foreignkey")
    op.drop_constraint(None, "data_import_sessions", type_="foreignkey")
    op.drop_constraint(None, "data_import_sessions", type_="foreignkey")
    op.create_foreign_key(
        op.f("data_import_sessions_engagement_id_fkey"),
        "data_import_sessions",
        "engagements",
        ["engagement_id"],
        ["id"],
    )
    op.create_foreign_key(
        op.f("data_import_sessions_master_flow_id_fkey"),
        "data_import_sessions",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.create_foreign_key(
        op.f("data_import_sessions_client_account_id_fkey"),
        "data_import_sessions",
        "client_accounts",
        ["client_account_id"],
        ["id"],
    )
    op.drop_index(
        op.f("ix_data_import_sessions_session_name"), table_name="data_import_sessions"
    )
    op.drop_index(
        op.f("ix_data_import_sessions_is_mock"), table_name="data_import_sessions"
    )
    op.drop_index(
        op.f("ix_data_import_sessions_is_default"), table_name="data_import_sessions"
    )
    op.drop_index(op.f("ix_data_import_sessions_id"), table_name="data_import_sessions")
    op.create_index(
        op.f("ix_data_import_sessions_user_id"),
        "data_import_sessions",
        ["user_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_data_import_sessions_filename"),
        "data_import_sessions",
        ["filename"],
        unique=False,
    )
    op.create_index(
        op.f("ix_data_import_sessions_created_at"),
        "data_import_sessions",
        ["created_at"],
        unique=False,
    )
    op.alter_column(
        "data_import_sessions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "data_import_sessions",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "data_import_sessions",
        "status",
        existing_type=sa.String(length=20),
        type_=sa.VARCHAR(length=50),
        existing_nullable=False,
    )
    op.drop_column("data_import_sessions", "is_mock")
    op.drop_column("data_import_sessions", "created_by")
    op.drop_column("data_import_sessions", "last_activity_at")
    op.drop_column("data_import_sessions", "agent_insights")
    op.drop_column("data_import_sessions", "business_context")
    op.drop_column("data_import_sessions", "session_config")
    op.drop_column("data_import_sessions", "data_quality_score")
    op.drop_column("data_import_sessions", "total_records_imported")
    op.drop_column("data_import_sessions", "total_assets_processed")
    op.drop_column("data_import_sessions", "total_imports")
    op.drop_column("data_import_sessions", "progress_percentage")
    op.drop_column("data_import_sessions", "source_filename")
    op.drop_column("data_import_sessions", "auto_created")
    op.drop_column("data_import_sessions", "session_type")
    op.drop_column("data_import_sessions", "parent_session_id")
    op.drop_column("data_import_sessions", "is_default")
    op.drop_column("data_import_sessions", "description")
    op.drop_column("data_import_sessions", "session_display_name")
    op.drop_column("data_import_sessions", "session_name")
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "phase_progression",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("assessment_flow_id", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("phase_flow_id", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "flow_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("planning_flow_id", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "current_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "cross_phase_context",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("execution_flow_id", sa.UUID(), autoincrement=False, nullable=True),
    )
    op.drop_constraint(None, "crewai_flow_state_extensions", type_="foreignkey")
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_discovery_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.create_unique_constraint(
        op.f("uq_crewai_extensions_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("idx_crewai_extensions_phase_flow_id"),
        "crewai_flow_state_extensions",
        ["phase_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_crewai_extensions_master_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_crewai_extensions_current_phase"),
        "crewai_flow_state_extensions",
        ["current_phase"],
        unique=False,
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "discovery_flow_id",
        existing_type=sa.UUID(),
        nullable=True,
    )
    op.create_index(
        op.f("ix_client_accounts_name"), "client_accounts", ["name"], unique=True
    )
    op.create_unique_constraint(
        op.f("client_accounts_slug_key"),
        "client_accounts",
        ["slug"],
        postgresql_nulls_not_distinct=False,
    )
    op.alter_column(
        "client_accounts", "slug", existing_type=sa.VARCHAR(length=100), nullable=True
    )
    op.drop_index(op.f("ix_client_access_id"), table_name="client_access")
    op.create_index(
        op.f("ix_client_access_granted_by"),
        "client_access",
        ["granted_by"],
        unique=False,
    )
    op.alter_column(
        "client_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "client_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "client_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("true"),
    )
    op.alter_column(
        "client_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "client_access",
        "restricted_data_types",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
    )
    op.alter_column(
        "client_access",
        "restricted_environments",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
    )
    op.alter_column(
        "client_access",
        "permissions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_export_data": false, "can_import_data": false, '
            '"can_manage_engagements": false, "can_manage_client_users": false, '
            '"can_configure_client_settings": false}\'::jsonb'
        ),
    )
    op.add_column(
        "assets",
        sa.Column(
            "phase_progression",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "assets",
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.drop_constraint(None, "assets", type_="foreignkey")
    op.create_foreign_key(
        op.f("assets_client_account_id_fkey"),
        "assets",
        "client_accounts",
        ["client_account_id"],
        ["id"],
    )
    op.create_foreign_key(
        op.f("fk_assets_discovery_flow_id"),
        "assets",
        "discovery_flows",
        ["discovery_flow_id"],
        ["id"],
    )
    op.create_foreign_key(
        op.f("assets_engagement_id_fkey"),
        "assets",
        "engagements",
        ["engagement_id"],
        ["id"],
    )
    op.create_foreign_key(
        op.f("fk_assets_master_flow_id"),
        "assets",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
    )
    op.drop_index(op.f("ix_assets_status"), table_name="assets")
    op.drop_index(op.f("ix_assets_source_phase"), table_name="assets")
    op.drop_index(op.f("ix_assets_session_id"), table_name="assets")
    op.drop_index(op.f("ix_assets_planning_flow_id"), table_name="assets")
    op.drop_index(op.f("ix_assets_migration_status"), table_name="assets")
    op.drop_index(op.f("ix_assets_master_flow_id"), table_name="assets")
    op.drop_index(op.f("ix_assets_mapping_status"), table_name="assets")
    op.drop_index(op.f("ix_assets_is_mock"), table_name="assets")
    op.drop_index(op.f("ix_assets_hostname"), table_name="assets")
    op.drop_index(op.f("ix_assets_execution_flow_id"), table_name="assets")
    op.drop_index(op.f("ix_assets_environment"), table_name="assets")
    op.drop_index(op.f("ix_assets_discovery_flow_id"), table_name="assets")
    op.drop_index(op.f("ix_assets_current_phase"), table_name="assets")
    op.drop_index(op.f("ix_assets_asset_type"), table_name="assets")
    op.drop_index(op.f("ix_assets_assessment_flow_id"), table_name="assets")
    op.create_index(
        op.f("idx_assets_source_phase"), "assets", ["source_phase"], unique=False
    )
    op.create_index(
        op.f("idx_assets_master_flow_id"), "assets", ["master_flow_id"], unique=False
    )
    op.create_index(
        op.f("idx_assets_discovery_flow_id"),
        "assets",
        ["discovery_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_assets_current_phase"), "assets", ["current_phase"], unique=False
    )
    op.alter_column(
        "assets",
        "asset_type",
        existing_type=sa.Enum(
            "SERVER",
            "DATABASE",
            "APPLICATION",
            "NETWORK",
            "LOAD_BALANCER",
            "STORAGE",
            "SECURITY_GROUP",
            "VIRTUAL_MACHINE",
            "CONTAINER",
            "OTHER",
            name="assettype",
        ),
        type_=sa.VARCHAR(),
        nullable=True,
    )
    op.drop_column("assets", "updated_by")
    op.drop_column("assets", "created_by")
    op.drop_column("assets", "is_mock")
    op.drop_column("assets", "field_mappings_used")
    op.drop_column("assets", "raw_data")
    op.drop_column("assets", "source_filename")
    op.drop_column("assets", "imported_at")
    op.drop_column("assets", "imported_by")
    op.drop_column("assets", "estimated_cloud_cost")
    op.drop_column("assets", "current_monthly_cost")
    op.drop_column("assets", "quality_score")
    op.drop_column("assets", "completeness_score")
    op.drop_column("assets", "network_throughput_mbps")
    op.drop_column("assets", "disk_iops")
    op.drop_column("assets", "memory_utilization_percent")
    op.drop_column("assets", "cpu_utilization_percent")
    op.drop_column("assets", "discovery_timestamp")
    op.drop_column("assets", "discovery_source")
    op.drop_column("assets", "discovery_method")
    op.drop_column("assets", "related_assets")
    op.drop_column("assets", "dependencies")
    op.drop_column("assets", "migration_status")
    op.drop_column("assets", "status")
    op.drop_column("assets", "sixr_ready")
    op.drop_column("assets", "migration_wave")
    op.drop_column("assets", "migration_complexity")
    op.drop_column("assets", "migration_priority")
    op.drop_column("assets", "mapping_status")
    op.drop_column("assets", "six_r_strategy")
    op.drop_column("assets", "custom_attributes")
    op.drop_column("assets", "business_criticality")
    op.drop_column("assets", "criticality")
    op.drop_column("assets", "technology_stack")
    op.drop_column("assets", "application_name")
    op.drop_column("assets", "department")
    op.drop_column("assets", "technical_owner")
    op.drop_column("assets", "business_owner")
    op.drop_column("assets", "storage_gb")
    op.drop_column("assets", "memory_gb")
    op.drop_column("assets", "cpu_cores")
    op.drop_column("assets", "os_version")
    op.drop_column("assets", "operating_system")
    op.drop_column("assets", "availability_zone")
    op.drop_column("assets", "rack_location")
    op.drop_column("assets", "datacenter")
    op.drop_column("assets", "location")
    op.drop_column("assets", "environment")
    op.drop_column("assets", "mac_address")
    op.drop_column("assets", "fqdn")
    op.drop_column("assets", "ip_address")
    op.drop_column("assets", "hostname")
    op.drop_column("assets", "asset_name")
    op.drop_column("assets", "phase_context")
    op.drop_column("assets", "migration_id")
    op.drop_column("assets", "session_id")
    op.drop_constraint(None, "access_audit_log", type_="foreignkey")
    op.drop_constraint(None, "access_audit_log", type_="foreignkey")
    op.drop_index(op.f("ix_access_audit_log_id"), table_name="access_audit_log")
    op.create_index(
        op.f("ix_access_audit_log_result"), "access_audit_log", ["result"], unique=False
    )
    op.create_index(
        op.f("ix_access_audit_log_resource_type"),
        "access_audit_log",
        ["resource_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_access_audit_log_client_account_id"),
        "access_audit_log",
        ["client_account_id"],
        unique=False,
    )
    op.alter_column(
        "access_audit_log",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
    )
    op.alter_column(
        "access_audit_log",
        "details",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
    )
    op.alter_column(
        "access_audit_log", "user_id", existing_type=sa.UUID(), nullable=True
    )
    op.create_table(
        "enhanced_access_audit_log",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "user_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "action", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "resource", sa.VARCHAR(length=200), autoincrement=False, nullable=False
        ),
        sa.Column("resource_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "permission_required",
            sa.VARCHAR(length=200),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "permissions_checked",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "roles_at_time",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "rbac_decision", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "rbac_decision_reason", sa.TEXT(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "context_data",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "request_path", sa.VARCHAR(length=500), autoincrement=False, nullable=True
        ),
        sa.Column(
            "request_method", sa.VARCHAR(length=10), autoincrement=False, nullable=True
        ),
        sa.Column("response_status", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "response_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("enhanced_access_audit_log_client_account_id_fkey"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("enhanced_access_audit_log_engagement_id_fkey"),
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name=op.f("enhanced_access_audit_log_master_flow_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("enhanced_access_audit_log_pkey")),
    )
    op.create_index(
        op.f("ix_enhanced_access_audit_log_user_id"),
        "enhanced_access_audit_log",
        ["user_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_enhanced_access_audit_log_rbac_decision"),
        "enhanced_access_audit_log",
        ["rbac_decision"],
        unique=False,
    )
    op.create_index(
        op.f("ix_enhanced_access_audit_log_created_at"),
        "enhanced_access_audit_log",
        ["created_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_enhanced_access_audit_log_client_account_id"),
        "enhanced_access_audit_log",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_enhanced_access_audit_log_action"),
        "enhanced_access_audit_log",
        ["action"],
        unique=False,
    )
    op.create_table(
        "role_permissions",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "role_level", sa.VARCHAR(length=30), autoincrement=False, nullable=False
        ),
        sa.Column(
            "can_manage_platform_settings",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_manage_all_clients",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_manage_all_users",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_purge_deleted_data",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_view_system_logs",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_create_clients",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_modify_client_settings",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_manage_client_users",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_delete_client_data",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_create_engagements",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_modify_engagement_settings",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_manage_engagement_users",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_delete_engagement_data",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_import_data",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_export_data",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_view_analytics",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_modify_data",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_configure_agents",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_view_agent_insights",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "can_approve_agent_decisions",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("role_permissions_pkey")),
    )
    op.create_index(
        op.f("ix_role_permissions_role_level"),
        "role_permissions",
        ["role_level"],
        unique=False,
    )
    op.drop_table("data_quality_issues")
    op.drop_table("import_processing_steps")
    op.drop_index(op.f("ix_asset_tags_tag_id"), table_name="asset_tags")
    op.drop_index(op.f("ix_asset_tags_is_mock"), table_name="asset_tags")
    op.drop_index(op.f("ix_asset_tags_asset_id"), table_name="asset_tags")
    op.drop_table("asset_tags")
    op.drop_index(op.f("ix_asset_embeddings_is_mock"), table_name="asset_embeddings")
    op.drop_index(op.f("ix_asset_embeddings_id"), table_name="asset_embeddings")
    op.drop_index(
        op.f("ix_asset_embeddings_engagement_id"), table_name="asset_embeddings"
    )
    op.drop_index(
        op.f("ix_asset_embeddings_client_account_id"), table_name="asset_embeddings"
    )
    op.drop_index(op.f("ix_asset_embeddings_asset_id"), table_name="asset_embeddings")
    op.drop_table("asset_embeddings")
    op.drop_table("asset_dependencies")
    op.drop_index(op.f("ix_assessments_id"), table_name="assessments")
    op.drop_index(op.f("ix_assessments_engagement_id"), table_name="assessments")
    op.drop_index(op.f("ix_assessments_client_account_id"), table_name="assessments")
    op.drop_table("assessments")
    op.drop_index(op.f("ix_sixr_recommendations_id"), table_name="sixr_recommendations")
    op.drop_table("sixr_recommendations")
    op.drop_index(
        op.f("ix_sixr_question_responses_id"), table_name="sixr_question_responses"
    )
    op.drop_table("sixr_question_responses")
    op.drop_index(op.f("ix_sixr_iterations_id"), table_name="sixr_iterations")
    op.drop_table("sixr_iterations")
    op.drop_index(
        op.f("ix_sixr_analysis_parameters_id"), table_name="sixr_analysis_parameters"
    )
    op.drop_table("sixr_analysis_parameters")
    op.drop_index(op.f("ix_wave_plans_id"), table_name="wave_plans")
    op.drop_index(op.f("ix_wave_plans_engagement_id"), table_name="wave_plans")
    op.drop_index(op.f("ix_wave_plans_client_account_id"), table_name="wave_plans")
    op.drop_table("wave_plans")
    op.drop_index(op.f("ix_tags_name"), table_name="tags")
    op.drop_index(op.f("ix_tags_is_mock"), table_name="tags")
    op.drop_index(op.f("ix_tags_is_active"), table_name="tags")
    op.drop_index(op.f("ix_tags_id"), table_name="tags")
    op.drop_index(op.f("ix_tags_client_account_id"), table_name="tags")
    op.drop_index(op.f("ix_tags_category"), table_name="tags")
    op.drop_table("tags")
    op.drop_index(op.f("ix_sixr_analyses_name"), table_name="sixr_analyses")
    op.drop_index(op.f("ix_sixr_analyses_id"), table_name="sixr_analyses")
    op.drop_index(op.f("ix_sixr_analyses_engagement_id"), table_name="sixr_analyses")
    op.drop_index(
        op.f("ix_sixr_analyses_client_account_id"), table_name="sixr_analyses"
    )
    op.drop_table("sixr_analyses")
    op.drop_index(op.f("ix_migration_waves_wave_number"), table_name="migration_waves")
    op.drop_index(op.f("ix_migration_waves_status"), table_name="migration_waves")
    op.drop_index(op.f("ix_migration_waves_is_mock"), table_name="migration_waves")
    op.drop_index(op.f("ix_migration_waves_id"), table_name="migration_waves")
    op.drop_index(
        op.f("ix_migration_waves_engagement_id"), table_name="migration_waves"
    )
    op.drop_index(
        op.f("ix_migration_waves_client_account_id"), table_name="migration_waves"
    )
    op.drop_table("migration_waves")
    op.drop_index(op.f("ix_migration_logs_id"), table_name="migration_logs")
    op.drop_table("migration_logs")
    op.drop_index(
        op.f("ix_mapping_learning_patterns_target_column"),
        table_name="mapping_learning_patterns",
    )
    op.drop_index(
        op.f("ix_mapping_learning_patterns_source_column"),
        table_name="mapping_learning_patterns",
    )
    op.drop_index(
        op.f("ix_mapping_learning_patterns_engagement_id"),
        table_name="mapping_learning_patterns",
    )
    op.drop_table("mapping_learning_patterns")
    op.drop_index("idx_usage_summary_period", table_name="llm_usage_summary")
    op.drop_index("idx_usage_summary_model", table_name="llm_usage_summary")
    op.drop_index("idx_usage_summary_client", table_name="llm_usage_summary")
    op.drop_table("llm_usage_summary")
    op.drop_index("idx_llm_usage_user", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_success", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_reporting", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_provider_model", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_page_context", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_feature_context", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_engagement", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_created_at", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_cost_analysis", table_name="llm_usage_logs")
    op.drop_index("idx_llm_usage_client_account", table_name="llm_usage_logs")
    op.drop_table("llm_usage_logs")
    op.drop_index(op.f("ix_feedback_summaries_page"), table_name="feedback_summaries")
    op.drop_index(op.f("ix_feedback_summaries_id"), table_name="feedback_summaries")
    op.drop_index(
        op.f("ix_feedback_summaries_feedback_type"), table_name="feedback_summaries"
    )
    op.drop_table("feedback_summaries")
    op.drop_index(op.f("ix_feedback_page"), table_name="feedback")
    op.drop_index(op.f("ix_feedback_id"), table_name="feedback")
    op.drop_index(op.f("ix_feedback_feedback_type"), table_name="feedback")
    op.drop_table("feedback")
    op.drop_index(op.f("ix_discovery_assets_is_mock"), table_name="discovery_assets")
    op.drop_index(op.f("ix_discovery_assets_id"), table_name="discovery_assets")
    op.drop_index(
        op.f("ix_discovery_assets_engagement_id"), table_name="discovery_assets"
    )
    op.drop_index(
        op.f("ix_discovery_assets_discovery_flow_id"), table_name="discovery_assets"
    )
    op.drop_index(
        op.f("ix_discovery_assets_client_account_id"), table_name="discovery_assets"
    )
    op.drop_index(op.f("ix_discovery_assets_asset_type"), table_name="discovery_assets")
    op.drop_index(
        op.f("ix_discovery_assets_asset_status"), table_name="discovery_assets"
    )
    op.drop_table("discovery_assets")
    op.drop_table("custom_target_fields")
    op.drop_index(op.f("ix_cmdb_sixr_analyses_status"), table_name="cmdb_sixr_analyses")
    op.drop_index(
        op.f("ix_cmdb_sixr_analyses_is_mock"), table_name="cmdb_sixr_analyses"
    )
    op.drop_index(op.f("ix_cmdb_sixr_analyses_id"), table_name="cmdb_sixr_analyses")
    op.drop_index(
        op.f("ix_cmdb_sixr_analyses_engagement_id"), table_name="cmdb_sixr_analyses"
    )
    op.drop_index(
        op.f("ix_cmdb_sixr_analyses_client_account_id"), table_name="cmdb_sixr_analyses"
    )
    op.drop_table("cmdb_sixr_analyses")
    op.drop_index(op.f("ix_sixr_questions_question_id"), table_name="sixr_questions")
    op.drop_index(op.f("ix_sixr_questions_id"), table_name="sixr_questions")
    op.drop_table("sixr_questions")
    op.drop_index(
        op.f("ix_sixr_parameters_parameter_key"), table_name="sixr_parameters"
    )
    op.drop_table("sixr_parameters")
    op.drop_index(op.f("ix_migrations_name"), table_name="migrations")
    op.drop_index(op.f("ix_migrations_id"), table_name="migrations")
    op.drop_table("migrations")
    op.drop_index("idx_model_pricing_provider_model", table_name="llm_model_pricing")
    op.drop_index("idx_model_pricing_active", table_name="llm_model_pricing")
    op.drop_table("llm_model_pricing")

    # Note: Enum types will be automatically dropped by SQLAlchemy when dropping tables that use them
    # ### end Alembic commands ###
