#!/usr/bin/env python3
"""
Tenant Data Seeding Module - Client Accounts, Users, Engagements, Discovery Flows
Generated by CC for comprehensive seed script modularization
"""

import random
import uuid
from datetime import datetime, timezone, timedelta

from sqlalchemy import text
from sqlalchemy.ext.asyncio import AsyncSession

from .base import TENANT_CONFIG


async def seed_core_entities(session: AsyncSession):
    """Seed core entities: client accounts, users, engagements"""
    print("ðŸŒ± Seeding core entities...")

    for tenant_id, config in TENANT_CONFIG.items():
        # Create client account
        await session.execute(
            text(
                """
                INSERT INTO migration.client_accounts (
                    id, name, slug, industry,
                    company_size, primary_contact_name, primary_contact_email,
                    is_active, created_at, updated_at
                ) VALUES (
                    :id, :name, :domain, :industry,
                    :size, :contact_name, :contact_email,
                    true, NOW(), NOW()
                )
                ON CONFLICT (id) DO NOTHING
            """
            ),
            {
                "id": str(tenant_id),
                "name": config["name"],
                "domain": config["domain"],
                "industry": config["industry"],
                "size": config["size"],
                "contact_name": f"{config['name']} Admin",
                "contact_email": f"admin@{config['domain']}",
            },
        )

        # Create engagement
        await session.execute(
            text(
                """
                INSERT INTO migration.engagements (
                    id, client_account_id, name, engagement_type,
                    start_date, status, created_at, updated_at
                ) VALUES (
                    :id, :client_id, :name, 'MIGRATION_ASSESSMENT',
                    :start_date, 'ACTIVE', NOW(), NOW()
                )
                ON CONFLICT (id) DO NOTHING
            """
            ),
            {
                "id": str(config["engagement_id"]),
                "client_id": str(tenant_id),
                "name": f"{config['name']} Cloud Migration 2025",
                "start_date": datetime.now(timezone.utc) - timedelta(days=30),
            },
        )

        # Create users for this tenant
        for role, user_id in config["users"].items():
            await session.execute(
                text(
                    """
                    INSERT INTO migration.users (
                        id, email, username, full_name,
                        is_active, is_verified, hashed_password,
                        default_client_account_id, default_engagement_id,
                        created_at, updated_at
                    ) VALUES (
                        :id, :email, :username, :full_name,
                        true, true, :password,
                        :client_id, :engagement_id,
                        NOW(), NOW()
                    )
                    ON CONFLICT (id) DO NOTHING
                """
                ),
                {
                    "id": str(user_id),
                    "email": f"{role}@{config['domain']}",
                    "username": f"{config['domain'].split('.')[0]}_{role}",
                    "full_name": f"{config['name']} {role.title()}",
                    "password": "$2b$12$dummy.hashed.password.for.testing",
                    "client_id": str(tenant_id),
                    "engagement_id": str(config["engagement_id"]),
                },
            )

            # Create user profile
            await session.execute(
                text(
                    """
                    INSERT INTO migration.user_profiles (
                        id, user_id, client_account_id, role,
                        is_active, created_at, updated_at
                    ) VALUES (
                        :id, :user_id, :client_id, :role,
                        true, NOW(), NOW()
                    )
                    ON CONFLICT (id) DO NOTHING
                """
                ),
                {
                    "id": str(uuid.uuid4()),
                    "user_id": str(user_id),
                    "client_id": str(tenant_id),
                    "role": role.upper(),
                },
            )

    await session.commit()
    print("âœ… Core entities seeded\n")


async def seed_discovery_flows(session: AsyncSession):
    """Seed discovery flows with various states"""
    print("ðŸŒ± Seeding discovery flows...")

    flow_states = [
        "initialization",
        "data_import",
        "field_mapping",
        "asset_analysis",
        "complete",
        "failed",
    ]

    for tenant_id, config in TENANT_CONFIG.items():
        for i, state in enumerate(flow_states[:4]):  # Create 4 flows per tenant
            flow_id = uuid.uuid4()
            progress = min(i * 25 + random.randint(0, 20), 100)

            await session.execute(
                text(
                    """
                    INSERT INTO migration.discovery_flows (
                        id, client_account_id, engagement_id, flow_name,
                        flow_type, status, current_phase, progress_percentage,
                        created_by, created_at, updated_at
                    ) VALUES (
                        :id, :client_id, :engagement_id, :name,
                        'STANDARD', :status, :phase, :progress,
                        :created_by, NOW(), NOW()
                    )
                """
                ),
                {
                    "id": str(flow_id),
                    "client_id": str(tenant_id),
                    "engagement_id": str(config["engagement_id"]),
                    "name": f"{state.title()} Discovery Flow",
                    "status": "completed" if state == "complete" else "in_progress",
                    "phase": f"{state}_phase",
                    "progress": progress,
                    "created_by": str(config["users"]["analyst"]),
                },
            )

            # Create flow state extension
            await session.execute(
                text(
                    """
                    INSERT INTO migration.crewai_flow_state_extensions (
                        id, flow_id, flow_type, client_account_id, engagement_id,
                        master_flow_id, parent_flow_id, state_data,
                        created_at, updated_at
                    ) VALUES (
                        :id, :flow_id, 'discovery', :client_id, :engagement_id,
                        :master_id, NULL, :state_data,
                        NOW(), NOW()
                    )
                """
                ),
                {
                    "id": str(uuid.uuid4()),
                    "flow_id": str(flow_id),
                    "client_id": str(tenant_id),
                    "engagement_id": str(config["engagement_id"]),
                    "master_id": str(uuid.uuid4()),
                    "state_data": {
                        "phase": state,
                        "progress": progress,
                        "metrics": {
                            "assets_discovered": random.randint(50, 200),
                            "fields_mapped": random.randint(20, 100),
                        },
                    },
                },
            )

    await session.commit()
    print("âœ… Discovery flows seeded\n")


async def seed_llm_usage(session: AsyncSession):
    """Seed LLM usage logs"""
    print("ðŸŒ± Seeding LLM usage logs...")

    from .base import LLM_INTERACTIONS

    models = ["gpt-4", "gpt-3.5-turbo", "claude-2", "llama-2-70b"]

    for tenant_id, config in TENANT_CONFIG.items():
        for interaction in LLM_INTERACTIONS * 3:  # Create multiple entries
            await session.execute(
                text(
                    """
                    INSERT INTO migration.llm_usage_logs (
                        id, client_account_id, engagement_id,
                        user_id, model_name, endpoint, feature_context,
                        prompt_tokens, completion_tokens, total_tokens,
                        input_cost, output_cost, total_cost,
                        prompt_text, completion_text, success,
                        created_at
                    ) VALUES (
                        :id, :client_id, :engagement_id,
                        :user_id, :model, :endpoint, :feature,
                        :prompt_tokens, :completion_tokens, :total_tokens,
                        :input_cost, :output_cost, :total_cost,
                        :prompt, :response, true,
                        NOW() - INTERVAL :hours_ago
                    )
                """
                ),
                {
                    "id": str(uuid.uuid4()),
                    "client_id": str(tenant_id),
                    "engagement_id": str(config["engagement_id"]),
                    "user_id": str(random.choice(list(config["users"].values()))),
                    "model": random.choice(models),
                    "endpoint": "/api/v1/agent/process",
                    "feature": interaction["feature"],
                    "prompt_tokens": interaction["tokens"]["input"],
                    "completion_tokens": interaction["tokens"]["output"],
                    "total_tokens": sum(interaction["tokens"].values()),
                    "input_cost": interaction["tokens"]["input"] * 0.00003,
                    "output_cost": interaction["tokens"]["output"] * 0.00006,
                    "total_cost": (
                        interaction["tokens"]["input"] * 0.00003
                        + interaction["tokens"]["output"] * 0.00006
                    ),
                    "prompt": interaction["prompt"],
                    "response": interaction["response"],
                    "hours_ago": f"{random.randint(1, 168)} hours",
                },
            )

    await session.commit()
    print("âœ… LLM usage logs seeded\n")
