#!/usr/bin/env python3
"""
Agent Data Seeding Module - Agent Tasks, Patterns, and Performance
Generated by CC for comprehensive seed script modularization
"""

import random
import uuid
from datetime import datetime, timedelta

from sqlalchemy import text
from sqlalchemy.ext.asyncio import AsyncSession

from .base import TENANT_CONFIG, AGENT_PATTERNS, generate_dummy_embedding


async def seed_agent_data(session: AsyncSession):
    """Seed agent-related data: tasks, patterns, performance"""
    print("ðŸŒ± Seeding agent data...")

    agents = [
        "discovery_agent",
        "field_mapper_agent",
        "asset_analyzer_agent",
        "risk_assessor_agent",
    ]
    task_statuses = ["completed", "failed", "in_progress"]

    for tenant_id, config in TENANT_CONFIG.items():
        # Get a flow_id for agent tasks (use first discovery flow or create dummy)
        flow_result = await session.execute(
            text(
                """
                SELECT id FROM migration.discovery_flows
                WHERE client_account_id = :client_id
                LIMIT 1
            """
            ),
            {"client_id": str(tenant_id)},
        )
        flow_id_row = flow_result.fetchone()
        if flow_id_row:
            flow_id = flow_id_row[0]
        else:
            # If no flow exists yet, create a dummy flow_id (we'll seed flows later)
            flow_id = str(uuid.uuid4())

        # Seed agent task history
        for _ in range(20):  # 20 tasks per tenant
            agent = random.choice(agents)
            status = random.choice(task_statuses)
            duration_seconds = random.randint(1, 60)  # 1s to 60s
            task_id = str(uuid.uuid4())

            await session.execute(
                text(
                    """
                    INSERT INTO migration.agent_task_history (
                        id, flow_id, client_account_id, engagement_id,
                        agent_name, agent_type, task_id, task_name, task_description,
                        status, duration_seconds, started_at, completed_at,
                        success, error_message
                    ) VALUES (
                        :id, :flow_id, :client_id, :engagement_id,
                        :agent, :agent_type, :task_id, :task_name, :description,
                        :status, :duration, NOW() - INTERVAL '1 hour', NOW(),
                        :success, :error
                    )
                """
                ),
                {
                    "id": str(uuid.uuid4()),
                    "flow_id": str(flow_id),
                    "client_id": str(tenant_id),
                    "engagement_id": str(config["engagement_id"]),
                    "agent": agent,
                    "agent_type": "crew_member",
                    "task_id": task_id,
                    "task_name": f"{agent.split('_')[0]}_task",
                    "description": f"Process {random.choice(['assets', 'fields', 'data', 'risks'])}",
                    "status": status,
                    "duration": duration_seconds,
                    "success": status == "completed",
                    "error": "Task timeout" if status == "failed" else None,
                },
            )

        # Seed agent discovered patterns with embeddings
        for pattern_type_data in AGENT_PATTERNS:
            for pattern_text in pattern_type_data["patterns"][
                :2
            ]:  # 2 patterns per type
                pattern_id = uuid.uuid4()

                await session.execute(
                    text(
                        """
                        INSERT INTO migration.agent_discovered_patterns (
                            id, client_account_id, engagement_id,
                            pattern_id, pattern_type, pattern_name,
                            pattern_description, discovered_by_agent,
                            confidence_score, evidence_count, times_referenced,
                            pattern_data, embedding, insight_type,
                            created_at, updated_at
                        ) VALUES (
                            :id, :client_id, :engagement_id,
                            :pattern_id, :pattern_type, :name,
                            :description, :agent,
                            :confidence, :evidence, :references,
                            :data, :embedding, :insight_type,
                            NOW(), NOW()
                        )
                    """
                    ),
                    {
                        "id": str(pattern_id),
                        "client_id": str(tenant_id),
                        "engagement_id": str(config["engagement_id"]),
                        "pattern_id": f"PAT-{pattern_id.hex[:8]}",
                        "pattern_type": pattern_type_data["type"],
                        "name": pattern_text[:50],
                        "description": pattern_text,
                        "agent": random.choice(agents),
                        "confidence": round(random.uniform(0.7, 0.95), 2),
                        "evidence": random.randint(5, 50),
                        "references": random.randint(0, 20),
                        "data": {
                            "source": "automated_discovery",
                            "context": {"phase": "analysis"},
                        },
                        "embedding": generate_dummy_embedding(),
                        "insight_type": pattern_type_data["type"],
                    },
                )

        # Seed agent performance daily
        for agent in agents:
            for days_ago in range(7):  # Last 7 days
                await session.execute(
                    text(
                        """
                        INSERT INTO migration.agent_performance_daily (
                            id, client_account_id, engagement_id,
                            agent_name, performance_date, total_tasks,
                            successful_tasks, failed_tasks, avg_duration_ms,
                            total_tokens_used, avg_confidence_score,
                            created_at, updated_at
                        ) VALUES (
                            :id, :client_id, :engagement_id,
                            :agent, :date, :total,
                            :success, :failed, :avg_duration,
                            :tokens, :confidence,
                            NOW(), NOW()
                        )
                    """
                    ),
                    {
                        "id": str(uuid.uuid4()),
                        "client_id": str(tenant_id),
                        "engagement_id": str(config["engagement_id"]),
                        "agent": agent,
                        "date": (datetime.now().date() - timedelta(days=days_ago)),
                        "total": random.randint(50, 200),
                        "success": random.randint(40, 180),
                        "failed": random.randint(0, 20),
                        "avg_duration": random.randint(2000, 10000),
                        "tokens": random.randint(5000, 50000),
                        "confidence": round(random.uniform(0.75, 0.92), 2),
                    },
                )

    await session.commit()
    print("âœ… Agent data seeded\n")
