"""Add seed data for user_roles

Revision ID: e3c32f125929
Revises: 508e8589c9d0
Create Date: 2024-07-29 18:24:43.766324

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
import uuid

# revision identifiers, used by Alembic.
revision: str = 'e3c32f125929'
down_revision: Union[str, None] = '508e8589c9d0'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Create a temporary 'system' user to own the roles
    # In a real application, you would have a proper system user or use the ID of an initial admin user.
    system_user_id = str(uuid.uuid4())
    op.execute(
        f"INSERT INTO users (id, email, password_hash, first_name, is_active, is_verified, is_mock) VALUES ('{system_user_id}', 'system@internal.ai-force.com', 'system_hash', 'System', true, true, true)"
    )

    user_roles_table = sa.table(
        'user_roles',
        sa.column('id', postgresql.UUID(as_uuid=True)),
        sa.column('user_id', postgresql.UUID(as_uuid=True)),
        sa.column('role_type', sa.String),
        sa.column('role_name', sa.String),
        sa.column('description', sa.Text),
        sa.column('permissions', sa.JSON),
        sa.column('scope_type', sa.String),
        sa.column('assigned_by', postgresql.UUID(as_uuid=True)),
        sa.column('is_active', sa.Boolean)
    )

    roles_to_seed = [
        {
            'id': uuid.uuid4(), 'user_id': system_user_id, 'role_type': 'PLATFORM_ADMIN', 'role_name': 'Platform Administrator',
            'description': 'Has full access to all platform features, client accounts, and system settings.',
            'permissions': {
                "can_create_clients": True, "can_manage_engagements": True, "can_import_data": True,
                "can_export_data": True, "can_view_analytics": True, "can_manage_users": True,
                "can_configure_agents": True, "can_access_admin_console": True
            },
            'scope_type': 'platform', 'assigned_by': system_user_id, 'is_active': True
        },
        {
            'id': uuid.uuid4(), 'user_id': system_user_id, 'role_type': 'CLIENT_ADMIN', 'role_name': 'Client Administrator',
            'description': 'Manages a specific client account, including its users, engagements, and data.',
            'permissions': {
                "can_create_clients": False, "can_manage_engagements": True, "can_import_data": True,
                "can_export_data": True, "can_view_analytics": True, "can_manage_users": True,
                "can_configure_agents": False, "can_access_admin_console": False
            },
            'scope_type': 'client', 'assigned_by': system_user_id, 'is_active': True
        },
        {
            'id': uuid.uuid4(), 'user_id': system_user_id, 'role_type': 'ANALYST', 'role_name': 'Analyst',
            'description': 'Can access and analyze data within assigned engagements.',
            'permissions': {
                "can_create_clients": False, "can_manage_engagements": False, "can_import_data": True,
                "can_export_data": True, "can_view_analytics": True, "can_manage_users": False,
                "can_configure_agents": False, "can_access_admin_console": False
            },
            'scope_type': 'engagement', 'assigned_by': system_user_id, 'is_active': True
        },
        {
            'id': uuid.uuid4(), 'user_id': system_user_id, 'role_type': 'VIEWER', 'role_name': 'Viewer',
            'description': 'Has read-only access to data within assigned engagements.',
            'permissions': {
                "can_create_clients": False, "can_manage_engagements": False, "can_import_data": False,
                "can_export_data": False, "can_view_analytics": True, "can_manage_users": False,
                "can_configure_agents": False, "can_access_admin_console": False
            },
            'scope_type': 'engagement', 'assigned_by': system_user_id, 'is_active': True
        }
    ]

    # The user_id is a placeholder for roles that are templates, 
    # but the FK requires a valid user. When a role is assigned to a real user, a new record will be created.
    # We assign these template roles to the system user.
    for role in roles_to_seed:
        role['user_id'] = system_user_id

    op.bulk_insert(user_roles_table, roles_to_seed)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("DELETE FROM user_roles WHERE role_name IN ('Platform Administrator', 'Client Administrator', 'Analyst', 'Viewer')")
    op.execute("DELETE FROM users WHERE email = 'system@internal.ai-force.com'")
    # ### end Alembic commands ### 