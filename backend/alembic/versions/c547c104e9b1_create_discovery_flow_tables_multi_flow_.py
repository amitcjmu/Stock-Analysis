"""create_discovery_flow_tables_multi_flow_architecture

Revision ID: c547c104e9b1
Revises: 39181c8d85b8
Create Date: 2025-06-23 16:03:23.719862

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'c547c104e9b1'
down_revision = '39181c8d85b8'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('discovery_flows',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('flow_id', sa.String(length=255), nullable=False),
    sa.Column('client_account_id', sa.UUID(), nullable=False),
    sa.Column('engagement_id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('current_phase', sa.String(length=100), nullable=False),
    sa.Column('progress_percentage', sa.Float(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('crewai_flow_state', sa.JSON(), nullable=True),
    sa.Column('crewai_persistence_id', sa.String(length=255), nullable=True),
    sa.Column('import_session_id', sa.UUID(), nullable=True),
    sa.Column('raw_data', sa.JSON(), nullable=True),
    sa.Column('field_mappings', sa.JSON(), nullable=True),
    sa.Column('cleaned_data', sa.JSON(), nullable=True),
    sa.Column('asset_inventory', sa.JSON(), nullable=True),
    sa.Column('dependencies', sa.JSON(), nullable=True),
    sa.Column('tech_debt', sa.JSON(), nullable=True),
    sa.Column('data_import_completed', sa.Boolean(), nullable=False),
    sa.Column('attribute_mapping_completed', sa.Boolean(), nullable=False),
    sa.Column('data_cleansing_completed', sa.Boolean(), nullable=False),
    sa.Column('inventory_completed', sa.Boolean(), nullable=False),
    sa.Column('dependencies_completed', sa.Boolean(), nullable=False),
    sa.Column('tech_debt_completed', sa.Boolean(), nullable=False),
    sa.Column('crew_status', sa.JSON(), nullable=True),
    sa.Column('agent_insights', sa.JSON(), nullable=True),
    sa.Column('crew_performance_metrics', sa.JSON(), nullable=True),
    sa.Column('learning_scope', sa.String(length=50), nullable=False),
    sa.Column('memory_isolation_level', sa.String(length=20), nullable=False),
    sa.Column('shared_memory_refs', sa.JSON(), nullable=True),
    sa.Column('knowledge_base_refs', sa.JSON(), nullable=True),
    sa.Column('errors', sa.JSON(), nullable=True),
    sa.Column('warnings', sa.JSON(), nullable=True),
    sa.Column('workflow_log', sa.JSON(), nullable=True),
    sa.Column('assessment_ready', sa.Boolean(), nullable=False),
    sa.Column('assessment_package', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_discovery_flows_client_account_id'), 'discovery_flows', ['client_account_id'], unique=False)
    op.create_index(op.f('ix_discovery_flows_crewai_persistence_id'), 'discovery_flows', ['crewai_persistence_id'], unique=False)
    op.create_index(op.f('ix_discovery_flows_engagement_id'), 'discovery_flows', ['engagement_id'], unique=False)
    op.create_index(op.f('ix_discovery_flows_flow_id'), 'discovery_flows', ['flow_id'], unique=True)
    op.create_index(op.f('ix_discovery_flows_import_session_id'), 'discovery_flows', ['import_session_id'], unique=False)
    op.create_index(op.f('ix_discovery_flows_user_id'), 'discovery_flows', ['user_id'], unique=False)
    op.create_table('discovery_assets',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('discovery_flow_id', sa.UUID(), nullable=False),
    sa.Column('client_account_id', sa.UUID(), nullable=False),
    sa.Column('engagement_id', sa.UUID(), nullable=False),
    sa.Column('asset_name', sa.String(length=255), nullable=False),
    sa.Column('asset_type', sa.String(length=100), nullable=False),
    sa.Column('asset_subtype', sa.String(length=100), nullable=True),
    sa.Column('asset_data', sa.JSON(), nullable=False),
    sa.Column('original_source_data', sa.JSON(), nullable=True),
    sa.Column('discovered_in_phase', sa.String(length=50), nullable=False),
    sa.Column('discovery_method', sa.String(length=100), nullable=True),
    sa.Column('quality_score', sa.Float(), nullable=True),
    sa.Column('validation_status', sa.String(length=20), nullable=False),
    sa.Column('validation_results', sa.JSON(), nullable=True),
    sa.Column('confidence_score', sa.Float(), nullable=True),
    sa.Column('agent_classification', sa.JSON(), nullable=True),
    sa.Column('agent_insights', sa.JSON(), nullable=True),
    sa.Column('crew_analysis', sa.JSON(), nullable=True),
    sa.Column('hosting_relationships', sa.JSON(), nullable=True),
    sa.Column('hosted_by_relationships', sa.JSON(), nullable=True),
    sa.Column('application_dependencies', sa.JSON(), nullable=True),
    sa.Column('tech_debt_score', sa.Float(), nullable=True),
    sa.Column('modernization_priority', sa.String(length=20), nullable=True),
    sa.Column('six_r_recommendation', sa.String(length=50), nullable=True),
    sa.Column('modernization_complexity', sa.String(length=20), nullable=True),
    sa.Column('migration_ready', sa.Boolean(), nullable=False),
    sa.Column('migration_blockers', sa.JSON(), nullable=True),
    sa.Column('migration_dependencies', sa.JSON(), nullable=True),
    sa.Column('learning_tags', sa.JSON(), nullable=True),
    sa.Column('knowledge_base_matches', sa.JSON(), nullable=True),
    sa.Column('asset_status', sa.String(length=20), nullable=False),
    sa.Column('last_updated_in_source', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['discovery_flow_id'], ['discovery_flows.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_discovery_assets_asset_name'), 'discovery_assets', ['asset_name'], unique=False)
    op.create_index(op.f('ix_discovery_assets_asset_subtype'), 'discovery_assets', ['asset_subtype'], unique=False)
    op.create_index(op.f('ix_discovery_assets_asset_type'), 'discovery_assets', ['asset_type'], unique=False)
    op.create_index(op.f('ix_discovery_assets_client_account_id'), 'discovery_assets', ['client_account_id'], unique=False)
    op.create_index(op.f('ix_discovery_assets_discovered_in_phase'), 'discovery_assets', ['discovered_in_phase'], unique=False)
    op.create_index(op.f('ix_discovery_assets_discovery_flow_id'), 'discovery_assets', ['discovery_flow_id'], unique=False)
    op.create_index(op.f('ix_discovery_assets_engagement_id'), 'discovery_assets', ['engagement_id'], unique=False)
    op.drop_table('test_table')
    op.alter_column('crewai_flow_state_extensions', 'agent_collaboration_log',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'memory_usage_metrics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'knowledge_base_analytics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'phase_execution_times',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'agent_performance_metrics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'crew_coordination_analytics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'learning_patterns',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'user_feedback_history',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'adaptation_metrics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=True)
    op.alter_column('crewai_flow_state_extensions', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.alter_column('crewai_flow_state_extensions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=True,
               existing_server_default=sa.text('now()'))
    op.drop_index(op.f('ix_crewai_flow_state_extensions_updated_at'), table_name='crewai_flow_state_extensions')
    op.drop_index(op.f('ix_crewai_flow_state_extensions_workflow_state_id'), table_name='crewai_flow_state_extensions')
    op.drop_constraint(op.f('crewai_flow_state_extensions_workflow_state_id_fkey'), 'crewai_flow_state_extensions', type_='foreignkey')
    # Note: Skipping foreign key creation for session_id as it's not unique in workflow_states table
    op.drop_column('crewai_flow_state_extensions', 'resumption_checkpoints')
    op.drop_column('crewai_flow_state_extensions', 'state_snapshots')
    op.drop_column('crewai_flow_state_extensions', 'workflow_state_id')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('crewai_flow_state_extensions', sa.Column('workflow_state_id', sa.UUID(), autoincrement=False, nullable=False))
    op.add_column('crewai_flow_state_extensions', sa.Column('state_snapshots', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False))
    op.add_column('crewai_flow_state_extensions', sa.Column('resumption_checkpoints', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False))
    # Note: No foreign key constraint to drop for session_id
    op.create_foreign_key(op.f('crewai_flow_state_extensions_workflow_state_id_fkey'), 'crewai_flow_state_extensions', 'workflow_states', ['workflow_state_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_crewai_flow_state_extensions_workflow_state_id'), 'crewai_flow_state_extensions', ['workflow_state_id'], unique=False)
    op.create_index(op.f('ix_crewai_flow_state_extensions_updated_at'), 'crewai_flow_state_extensions', ['updated_at'], unique=False)
    op.alter_column('crewai_flow_state_extensions', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('crewai_flow_state_extensions', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('crewai_flow_state_extensions', 'adaptation_metrics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'user_feedback_history',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'learning_patterns',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'crew_coordination_analytics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'agent_performance_metrics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'phase_execution_times',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'knowledge_base_analytics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'memory_usage_metrics',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.alter_column('crewai_flow_state_extensions', 'agent_collaboration_log',
               existing_type=postgresql.JSONB(astext_type=sa.Text()),
               nullable=False)
    op.create_table('test_table',
    sa.Column('id', sa.INTEGER(), autoincrement=False, nullable=True)
    )
    op.drop_index(op.f('ix_discovery_assets_engagement_id'), table_name='discovery_assets')
    op.drop_index(op.f('ix_discovery_assets_discovery_flow_id'), table_name='discovery_assets')
    op.drop_index(op.f('ix_discovery_assets_discovered_in_phase'), table_name='discovery_assets')
    op.drop_index(op.f('ix_discovery_assets_client_account_id'), table_name='discovery_assets')
    op.drop_index(op.f('ix_discovery_assets_asset_type'), table_name='discovery_assets')
    op.drop_index(op.f('ix_discovery_assets_asset_subtype'), table_name='discovery_assets')
    op.drop_index(op.f('ix_discovery_assets_asset_name'), table_name='discovery_assets')
    op.drop_table('discovery_assets')
    op.drop_index(op.f('ix_discovery_flows_user_id'), table_name='discovery_flows')
    op.drop_index(op.f('ix_discovery_flows_import_session_id'), table_name='discovery_flows')
    op.drop_index(op.f('ix_discovery_flows_flow_id'), table_name='discovery_flows')
    op.drop_index(op.f('ix_discovery_flows_engagement_id'), table_name='discovery_flows')
    op.drop_index(op.f('ix_discovery_flows_crewai_persistence_id'), table_name='discovery_flows')
    op.drop_index(op.f('ix_discovery_flows_client_account_id'), table_name='discovery_flows')
    op.drop_table('discovery_flows')
    # ### end Alembic commands ### 