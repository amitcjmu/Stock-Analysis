"""Change asset primary key to UUID

Revision ID: ece91ac47b79
Revises: fa1e81c600b0
Create Date: 2025-06-07 14:07:57.142708

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = 'ece91ac47b79'
down_revision = 'fa1e81c600b0'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Manually reordered to fix dependency issues.
    # Step 1: Drop all dependent foreign keys
    op.drop_constraint('assessments_asset_id_fkey', 'assessments', type_='foreignkey')
    op.drop_constraint('asset_dependencies_source_asset_id_fkey', 'asset_dependencies', type_='foreignkey')
    op.drop_constraint('asset_dependencies_target_asset_id_fkey', 'asset_dependencies', type_='foreignkey')
    op.drop_constraint('workflow_progress_asset_id_fkey', 'workflow_progress', type_='foreignkey')
    op.drop_constraint('raw_import_records_asset_id_fkey', 'raw_import_records', type_='foreignkey')
    # asset_tags FK was already handled

    # Step 2: Alter the primary table (assets)
    op.alter_column('assets', 'id', server_default=None) # Drop the old default
    op.alter_column('assets', 'id',
               existing_type=sa.INTEGER(),
               type_=sa.UUID(),
               existing_nullable=False,
               postgresql_using='gen_random_uuid()',
               server_default=sa.text('gen_random_uuid()')) # Set the new default

    # Step 3: Alter all referencing columns
    op.alter_column('assessments', 'asset_id', type_=sa.UUID(), postgresql_using='gen_random_uuid()')
    op.alter_column('asset_dependencies', 'source_asset_id', type_=sa.UUID(), postgresql_using='gen_random_uuid()')
    op.alter_column('asset_dependencies', 'target_asset_id', type_=sa.UUID(), postgresql_using='gen_random_uuid()')
    op.alter_column('workflow_progress', 'asset_id', type_=sa.UUID(), postgresql_using='gen_random_uuid()')
    op.alter_column('raw_import_records', 'asset_id', type_=sa.UUID(), postgresql_using='gen_random_uuid()')
    
    # asset_tags column change was already handled, just need to create the FK
    op.add_column('asset_tags', sa.Column('asset_id', sa.UUID(), nullable=True)) # Temporarily nullable
    
    # Step 3.5: Nuke existing data in dependent tables to ensure integrity
    op.execute('DELETE FROM assessments')
    op.execute('DELETE FROM asset_dependencies')
    op.execute('DELETE FROM workflow_progress')
    op.execute('DELETE FROM raw_import_records')
    op.execute('DELETE FROM asset_tags')

    # Step 4: Recreate all foreign keys
    op.create_foreign_key('fk_assessments_asset_id', 'assessments', 'assets', ['asset_id'], ['id'])
    op.create_foreign_key('fk_asset_dependencies_source_asset_id', 'asset_dependencies', 'assets', ['source_asset_id'], ['id'])
    op.create_foreign_key('fk_asset_dependencies_target_asset_id', 'asset_dependencies', 'assets', ['target_asset_id'], ['id'])
    op.create_foreign_key('fk_workflow_progress_asset_id', 'workflow_progress', 'assets', ['asset_id'], ['id'])
    op.create_foreign_key('fk_raw_import_records_asset_id', 'raw_import_records', 'assets', ['asset_id'], ['id'])
    op.create_foreign_key('fk_asset_tags_asset_id', 'asset_tags', 'assets', ['asset_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_asset_tags_asset_id'), 'asset_tags', ['asset_id'], unique=False)

    
    op.create_table('asset_embeddings',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('asset_id', sa.UUID(), nullable=False),
    sa.Column('client_account_id', sa.UUID(), nullable=False),
    sa.Column('engagement_id', sa.UUID(), nullable=False),
    sa.Column('embedding', sa.Text(), nullable=True),
    sa.Column('source_text', sa.Text(), nullable=True),
    sa.Column('embedding_model', sa.String(length=100), nullable=True),
    sa.Column('is_mock', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['asset_id'], ['assets.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['client_account_id'], ['client_accounts.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['engagement_id'], ['engagements.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_asset_embeddings_asset_id'), 'asset_embeddings', ['asset_id'], unique=False)
    op.create_index(op.f('ix_asset_embeddings_client_account_id'), 'asset_embeddings', ['client_account_id'], unique=False)
    op.create_index(op.f('ix_asset_embeddings_engagement_id'), 'asset_embeddings', ['engagement_id'], unique=False)
    op.create_index(op.f('ix_asset_embeddings_id'), 'asset_embeddings', ['id'], unique=False)
    op.create_index(op.f('ix_asset_embeddings_is_mock'), 'asset_embeddings', ['is_mock'], unique=False)
    op.drop_table('cmdb_asset_embeddings_backup_20250606_195249')
    op.drop_table('asset_tags_backup_20250606_195249')
    op.drop_table('mapping_learning_patterns_backup')
    op.drop_table('learning_statistics')
    op.drop_table('raw_import_records_backup_20250606_195249')
    op.drop_index(op.f('ix_cmdb_asset_embeddings_client_account_id'), table_name='cmdb_asset_embeddings')
    op.drop_index(op.f('ix_cmdb_asset_embeddings_engagement_id'), table_name='cmdb_asset_embeddings')
    op.drop_index(op.f('ix_cmdb_asset_embeddings_id'), table_name='cmdb_asset_embeddings')
    op.drop_index(op.f('ix_cmdb_asset_embeddings_is_mock'), table_name='cmdb_asset_embeddings')
    op.drop_table('cmdb_asset_embeddings')
    op.drop_index(op.f('ix_cmdb_sixr_analyses_client_account_id'), table_name='cmdb_sixr_analyses')
    op.drop_index(op.f('ix_cmdb_sixr_analyses_engagement_id'), table_name='cmdb_sixr_analyses')
    op.drop_index(op.f('ix_cmdb_sixr_analyses_id'), table_name='cmdb_sixr_analyses')
    op.drop_index(op.f('ix_cmdb_sixr_analyses_is_mock'), table_name='cmdb_sixr_analyses')
    op.drop_index(op.f('ix_cmdb_sixr_analyses_status'), table_name='cmdb_sixr_analyses')
    op.drop_table('cmdb_sixr_analyses')
    op.drop_index(op.f('idx_confidence_thresholds_client_operation'), table_name='confidence_thresholds')
    op.drop_table('confidence_thresholds')
    op.drop_index(op.f('ix_migration_waves_client_account_id'), table_name='migration_waves')
    op.drop_index(op.f('ix_migration_waves_engagement_id'), table_name='migration_waves')
    op.drop_index(op.f('ix_migration_waves_id'), table_name='migration_waves')
    op.drop_index(op.f('ix_migration_waves_is_mock'), table_name='migration_waves')
    op.drop_index(op.f('ix_migration_waves_status'), table_name='migration_waves')
    op.drop_index(op.f('ix_migration_waves_wave_number'), table_name='migration_waves')
    op.drop_table('migration_waves')
    op.drop_index(op.f('idx_classification_patterns_metadata_embedding'), table_name='asset_classification_patterns', postgresql_using='ivfflat')
    op.drop_index(op.f('idx_classification_patterns_name_embedding'), table_name='asset_classification_patterns', postgresql_using='ivfflat')
    op.drop_table('asset_classification_patterns')
    op.drop_index(op.f('idx_feedback_events_client_type'), table_name='user_feedback_events')
    op.drop_table('user_feedback_events')
    op.drop_table('cmdb_assets_backup_20250606_195249')
    op.drop_column('mapping_learning_patterns', 'confidence_score')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('mapping_learning_patterns', sa.Column('confidence_score', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('learning_source', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('source_sample_embedding', sa.NullType(), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('target_field_type', sa.VARCHAR(length=100), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('source_field_name', sa.VARCHAR(length=255), autoincrement=False, nullable=False))
    op.add_column('mapping_learning_patterns', sa.Column('source_field_embedding', sa.NullType(), autoincrement=False, nullable=False))
    op.add_column('mapping_learning_patterns', sa.Column('pattern_context', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('source_sample_values', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('target_field_name', sa.VARCHAR(length=255), autoincrement=False, nullable=False))
    op.add_column('mapping_learning_patterns', sa.Column('last_used_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('learned_from_user', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('created_by', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.add_column('mapping_learning_patterns', sa.Column('engagement_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True))
    op.drop_constraint(None, 'mapping_learning_patterns', type_='foreignkey')
    op.drop_constraint(None, 'mapping_learning_patterns', type_='foreignkey')
    op.drop_index(op.f('ix_mapping_learning_patterns_target_field'), table_name='mapping_learning_patterns')
    op.drop_index(op.f('ix_mapping_learning_patterns_source_field_pattern'), table_name='mapping_learning_patterns')
    op.drop_index(op.f('ix_mapping_learning_patterns_id'), table_name='mapping_learning_patterns')
    op.create_index(op.f('idx_mapping_patterns_target'), 'mapping_learning_patterns', ['target_field_name'], unique=False)
    op.create_index(op.f('idx_mapping_patterns_embedding'), 'mapping_learning_patterns', ['source_field_embedding'], unique=False, postgresql_using='ivfflat')
    op.create_index(op.f('idx_mapping_patterns_confidence'), 'mapping_learning_patterns', ['confidence_score'], unique=False)
    op.create_index(op.f('idx_mapping_patterns_client_source'), 'mapping_learning_patterns', ['client_account_id', 'source_field_name'], unique=False)
    op.alter_column('mapping_learning_patterns', 'client_account_id',
               existing_type=sa.UUID(),
               type_=sa.VARCHAR(length=255),
               existing_nullable=False)
    op.drop_column('mapping_learning_patterns', 'last_applied_at')
    op.drop_column('mapping_learning_patterns', 'times_applied')
    op.drop_column('mapping_learning_patterns', 'quality_checks')
    op.drop_column('mapping_learning_patterns', 'transformation_hints')
    op.drop_column('mapping_learning_patterns', 'matching_rules')
    op.drop_column('mapping_learning_patterns', 'user_feedback')
    op.drop_column('mapping_learning_patterns', 'learned_from_mapping_id')
    op.drop_column('mapping_learning_patterns', 'pattern_confidence')
    op.drop_column('mapping_learning_patterns', 'target_field')
    op.drop_column('mapping_learning_patterns', 'content_pattern')
    op.drop_column('mapping_learning_patterns', 'source_field_pattern')
    op.drop_constraint(None, 'assets', type_='foreignkey')
    op.create_index(op.f('ix_assets_id'), 'assets', ['id'], unique=False)
    op.alter_column('assets', 'id',
               existing_type=sa.UUID(),
               type_=sa.INTEGER(),
               existing_nullable=False,
               existing_server_default=sa.text("nextval('assets_id_seq'::regclass)"))
    op.drop_constraint(None, 'asset_tags', type_='foreignkey')
    op.drop_index(op.f('ix_asset_tags_asset_id'), table_name='asset_tags')
    op.drop_column('asset_tags', 'asset_id')
    op.create_table('cmdb_assets_backup_20250606_195249',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('client_account_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('engagement_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('session_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('hostname', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('asset_type', postgresql.ENUM('SERVER', 'DATABASE', 'APPLICATION', 'NETWORK', 'STORAGE', 'CONTAINER', 'VIRTUAL_MACHINE', 'LOAD_BALANCER', 'SECURITY_GROUP', 'OTHER', name='assettype'), autoincrement=False, nullable=True),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('ip_address', sa.VARCHAR(length=45), autoincrement=False, nullable=True),
    sa.Column('fqdn', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('mac_address', sa.VARCHAR(length=17), autoincrement=False, nullable=True),
    sa.Column('environment', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('location', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('datacenter', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('rack_location', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('availability_zone', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('operating_system', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('os_version', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('cpu_cores', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('memory_gb', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('storage_gb', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('business_owner', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('department', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('application_name', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('technology_stack', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('criticality', sa.VARCHAR(length=20), autoincrement=False, nullable=True),
    sa.Column('status', postgresql.ENUM('DISCOVERED', 'ASSESSED', 'PLANNED', 'MIGRATING', 'MIGRATED', 'FAILED', 'EXCLUDED', name='assetstatus'), autoincrement=False, nullable=True),
    sa.Column('six_r_strategy', postgresql.ENUM('REHOST', 'REPLATFORM', 'REFACTOR', 'REARCHITECT', 'RETIRE', 'RETAIN', name='sixrstrategy'), autoincrement=False, nullable=True),
    sa.Column('migration_priority', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('migration_complexity', sa.VARCHAR(length=20), autoincrement=False, nullable=True),
    sa.Column('migration_wave', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('sixr_ready', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('dependencies', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('related_assets', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('discovery_method', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('discovery_source', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('discovery_timestamp', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('cpu_utilization_percent', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('memory_utilization_percent', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('disk_iops', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('network_throughput_mbps', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('current_monthly_cost', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('estimated_cloud_cost', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('imported_by', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('imported_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('source_filename', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('raw_data', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('field_mappings_used', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('is_mock', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_by', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('updated_by', sa.UUID(), autoincrement=False, nullable=True)
    )
    op.create_table('user_feedback_events',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('feedback_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('operation_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('original_suggestion', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('original_confidence', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('user_correction', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('correction_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('related_patterns', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('pattern_updates_applied', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('threshold_updates_applied', sa.BOOLEAN(), server_default=sa.text('false'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('created_by', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('user_feedback_events_pkey'))
    )
    op.create_index(op.f('idx_feedback_events_client_type'), 'user_feedback_events', ['client_account_id', 'feedback_type'], unique=False)
    op.create_table('asset_classification_patterns',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('pattern_name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('pattern_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('asset_name_pattern', sa.VARCHAR(length=500), autoincrement=False, nullable=True),
    sa.Column('metadata_patterns', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('predicted_asset_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('predicted_application_type', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('predicted_technology_stack', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('confidence_score', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('success_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('failure_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('accuracy_rate', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('learned_from_assets', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('learning_source', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('last_applied_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_by', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('asset_name_embedding', sa.NullType(), autoincrement=False, nullable=True),
    sa.Column('metadata_embedding', sa.NullType(), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('asset_classification_patterns_pkey'))
    )
    op.create_index(op.f('idx_classification_patterns_name_embedding'), 'asset_classification_patterns', ['asset_name_embedding'], unique=False, postgresql_using='ivfflat')
    op.create_index(op.f('idx_classification_patterns_metadata_embedding'), 'asset_classification_patterns', ['metadata_embedding'], unique=False, postgresql_using='ivfflat')
    op.create_table('migration_waves',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('wave_number', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('planned_start_date', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('planned_end_date', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('actual_start_date', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('actual_end_date', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('total_assets', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('completed_assets', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('failed_assets', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('estimated_cost', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('actual_cost', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('estimated_effort_hours', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('actual_effort_hours', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('is_mock', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_by', sa.UUID(), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['client_account_id'], ['client_accounts.id'], name=op.f('migration_waves_client_account_id_fkey'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('migration_waves_created_by_fkey')),
    sa.ForeignKeyConstraint(['engagement_id'], ['engagements.id'], name=op.f('migration_waves_engagement_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('migration_waves_pkey'))
    )
    op.create_index(op.f('ix_migration_waves_wave_number'), 'migration_waves', ['wave_number'], unique=False)
    op.create_index(op.f('ix_migration_waves_status'), 'migration_waves', ['status'], unique=False)
    op.create_index(op.f('ix_migration_waves_is_mock'), 'migration_waves', ['is_mock'], unique=False)
    op.create_index(op.f('ix_migration_waves_id'), 'migration_waves', ['id'], unique=False)
    op.create_index(op.f('ix_migration_waves_engagement_id'), 'migration_waves', ['engagement_id'], unique=False)
    op.create_index(op.f('ix_migration_waves_client_account_id'), 'migration_waves', ['client_account_id'], unique=False)
    op.create_table('confidence_thresholds',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('operation_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('threshold_name', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('threshold_value', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=False),
    sa.Column('initial_value', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=False),
    sa.Column('adjustment_count', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('last_adjustment', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('true_positives', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('false_positives', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('true_negatives', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('false_negatives', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('precision', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('recall', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('f1_score', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_by', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('confidence_thresholds_pkey'))
    )
    op.create_index(op.f('idx_confidence_thresholds_client_operation'), 'confidence_thresholds', ['client_account_id', 'operation_type'], unique=False)
    op.create_table('cmdb_sixr_analyses',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('analysis_name', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('description', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('status', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('total_assets', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('rehost_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('replatform_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('refactor_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('rearchitect_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('retire_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('retain_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('total_current_cost', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('total_estimated_cost', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('potential_savings', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('analysis_results', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('recommendations', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('is_mock', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_by', sa.UUID(), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['client_account_id'], ['client_accounts.id'], name=op.f('cmdb_sixr_analyses_client_account_id_fkey'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], name=op.f('cmdb_sixr_analyses_created_by_fkey')),
    sa.ForeignKeyConstraint(['engagement_id'], ['engagements.id'], name=op.f('cmdb_sixr_analyses_engagement_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('cmdb_sixr_analyses_pkey'))
    )
    op.create_index(op.f('ix_cmdb_sixr_analyses_status'), 'cmdb_sixr_analyses', ['status'], unique=False)
    op.create_index(op.f('ix_cmdb_sixr_analyses_is_mock'), 'cmdb_sixr_analyses', ['is_mock'], unique=False)
    op.create_index(op.f('ix_cmdb_sixr_analyses_id'), 'cmdb_sixr_analyses', ['id'], unique=False)
    op.create_index(op.f('ix_cmdb_sixr_analyses_engagement_id'), 'cmdb_sixr_analyses', ['engagement_id'], unique=False)
    op.create_index(op.f('ix_cmdb_sixr_analyses_client_account_id'), 'cmdb_sixr_analyses', ['client_account_id'], unique=False)
    op.create_table('cmdb_asset_embeddings',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('embedding', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('source_text', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('embedding_model', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('is_mock', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.ForeignKeyConstraint(['client_account_id'], ['client_accounts.id'], name=op.f('cmdb_asset_embeddings_client_account_id_fkey'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['engagement_id'], ['engagements.id'], name=op.f('cmdb_asset_embeddings_engagement_id_fkey'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('cmdb_asset_embeddings_pkey'))
    )
    op.create_index(op.f('ix_cmdb_asset_embeddings_is_mock'), 'cmdb_asset_embeddings', ['is_mock'], unique=False)
    op.create_index(op.f('ix_cmdb_asset_embeddings_id'), 'cmdb_asset_embeddings', ['id'], unique=False)
    op.create_index(op.f('ix_cmdb_asset_embeddings_engagement_id'), 'cmdb_asset_embeddings', ['engagement_id'], unique=False)
    op.create_index(op.f('ix_cmdb_asset_embeddings_client_account_id'), 'cmdb_asset_embeddings', ['client_account_id'], unique=False)
    op.create_table('raw_import_records_backup_20250606_195249',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('data_import_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('row_number', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('record_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('raw_data', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('processed_data', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('validation_errors', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('processing_notes', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('is_processed', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('is_valid', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('cmdb_asset_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('processed_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True)
    )
    op.create_table('learning_statistics',
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), autoincrement=False, nullable=False),
    sa.Column('client_account_id', sa.VARCHAR(length=255), autoincrement=False, nullable=False),
    sa.Column('engagement_id', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('statistic_type', sa.VARCHAR(length=100), autoincrement=False, nullable=False),
    sa.Column('time_period', sa.VARCHAR(length=50), autoincrement=False, nullable=False),
    sa.Column('period_start', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=False),
    sa.Column('period_end', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=False),
    sa.Column('total_operations', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('successful_operations', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('failed_operations', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('user_corrections', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('accuracy_rate', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('improvement_rate', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('patterns_created', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('patterns_updated', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('patterns_retired', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('average_confidence', sa.DOUBLE_PRECISION(precision=53), server_default=sa.text('0.0'), autoincrement=False, nullable=True),
    sa.Column('threshold_adjustments', sa.INTEGER(), server_default=sa.text('0'), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), server_default=sa.text('now()'), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('learning_statistics_pkey'))
    )
    op.create_table('mapping_learning_patterns_backup',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('client_account_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('source_field_pattern', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('content_pattern', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('target_field', sa.VARCHAR(length=255), autoincrement=False, nullable=True),
    sa.Column('pattern_confidence', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('success_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('failure_count', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('learned_from_mapping_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('user_feedback', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('matching_rules', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('transformation_hints', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('quality_checks', postgresql.JSON(astext_type=sa.Text()), autoincrement=False, nullable=True),
    sa.Column('times_applied', sa.INTEGER(), autoincrement=False, nullable=True),
    sa.Column('last_applied_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True)
    )
    op.create_table('asset_tags_backup_20250606_195249',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('cmdb_asset_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('tag_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('confidence_score', sa.DOUBLE_PRECISION(precision=53), autoincrement=False, nullable=True),
    sa.Column('assigned_method', sa.VARCHAR(length=50), autoincrement=False, nullable=True),
    sa.Column('assigned_by', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('is_validated', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('validated_by', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('validated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('is_mock', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True)
    )
    op.create_table('cmdb_asset_embeddings_backup_20250606_195249',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('cmdb_asset_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('client_account_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('engagement_id', sa.UUID(), autoincrement=False, nullable=True),
    sa.Column('embedding', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('source_text', sa.TEXT(), autoincrement=False, nullable=True),
    sa.Column('embedding_model', sa.VARCHAR(length=100), autoincrement=False, nullable=True),
    sa.Column('is_mock', sa.BOOLEAN(), autoincrement=False, nullable=True),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True)
    )
    op.drop_index(op.f('ix_asset_embeddings_is_mock'), table_name='asset_embeddings')
    op.drop_index(op.f('ix_asset_embeddings_id'), table_name='asset_embeddings')
    op.drop_index(op.f('ix_asset_embeddings_engagement_id'), table_name='asset_embeddings')
    op.drop_index(op.f('ix_asset_embeddings_client_account_id'), table_name='asset_embeddings')
    op.drop_index(op.f('ix_asset_embeddings_asset_id'), table_name='asset_embeddings')
    op.drop_table('asset_embeddings')
    # ### end Alembic commands ### 