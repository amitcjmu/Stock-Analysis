"""add_is_default_and_parent_session_id_to_sessions

Revision ID: b8659187d828
Revises: e3c32f125929
Create Date: 2025-06-10 16:13:14.592853

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = 'b8659187d828'
down_revision = 'e3c32f125929'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('data_import_sessions', sa.Column('session_display_name', sa.String(length=255), nullable=True))
    op.add_column('data_import_sessions', sa.Column('is_default', sa.Boolean(), nullable=False, server_default='false'))
    op.add_column('data_import_sessions', sa.Column('parent_session_id', sa.UUID(), nullable=True))
    
    # Add other columns with proper server defaults
    op.add_column('data_import_sessions', sa.Column('session_type', sa.String(length=50), server_default='data_import', nullable=False))
    op.add_column('data_import_sessions', sa.Column('auto_created', sa.Boolean(), server_default='true', nullable=False))
    op.add_column('data_import_sessions', sa.Column('source_filename', sa.String(length=255), nullable=True))
    op.add_column('data_import_sessions', sa.Column('progress_percentage', sa.Integer(), server_default='0', nullable=False))
    op.add_column('data_import_sessions', sa.Column('total_imports', sa.Integer(), server_default='0', nullable=False))
    op.add_column('data_import_sessions', sa.Column('total_assets_processed', sa.Integer(), server_default='0', nullable=False))
    op.add_column('data_import_sessions', sa.Column('total_records_imported', sa.Integer(), server_default='0', nullable=False))
    op.add_column('data_import_sessions', sa.Column('data_quality_score', sa.Integer(), server_default='0', nullable=False))
    op.add_column('data_import_sessions', sa.Column('session_config', sa.JSON(), server_default='{}', nullable=False))
    op.add_column('data_import_sessions', sa.Column('business_context', sa.JSON(), server_default='{}', nullable=False))
    op.add_column('data_import_sessions', sa.Column('agent_insights', sa.JSON(), server_default='{}', nullable=False))
    op.add_column('data_import_sessions', sa.Column('started_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True))
    op.add_column('data_import_sessions', sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True))
    op.add_column('data_import_sessions', sa.Column('last_activity_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True))
    op.add_column('data_import_sessions', sa.Column('is_mock', sa.Boolean(), server_default='false', nullable=False))
    
    # Create indexes
    op.create_index(op.f('ix_data_import_sessions_client_account_id'), 'data_import_sessions', ['client_account_id'], unique=False)
    op.create_index(op.f('ix_data_import_sessions_engagement_id'), 'data_import_sessions', ['engagement_id'], unique=False)
    op.create_index(op.f('ix_data_import_sessions_id'), 'data_import_sessions', ['id'], unique=False)
    op.create_index(op.f('ix_data_import_sessions_is_default'), 'data_import_sessions', ['is_default'], unique=False)
    op.create_index(op.f('ix_data_import_sessions_is_mock'), 'data_import_sessions', ['is_mock'], unique=False)
    op.create_index(op.f('ix_data_import_sessions_session_name'), 'data_import_sessions', ['session_name'], unique=False)
    op.create_index(op.f('ix_data_import_sessions_status'), 'data_import_sessions', ['status'], unique=False)
    
    # Drop and recreate foreign keys with proper names
    op.drop_constraint('data_import_sessions_engagement_id_fkey', 'data_import_sessions', type_='foreignkey')
    op.drop_constraint('data_import_sessions_client_account_id_fkey', 'data_import_sessions', type_='foreignkey')
    
    # Create foreign keys with proper names
    op.create_foreign_key(
        'fk_data_import_sessions_parent_session_id',
        'data_import_sessions', 'data_import_sessions',
        ['parent_session_id'], ['id'],
        ondelete='SET NULL'
    )
    
    op.create_foreign_key(
        'fk_data_import_sessions_client_account_id',
        'data_import_sessions', 'client_accounts',
        ['client_account_id'], ['id'],
        ondelete='CASCADE'
    )
    
    op.create_foreign_key(
        'fk_data_import_sessions_engagement_id',
        'data_import_sessions', 'engagements',
        ['engagement_id'], ['id'],
        ondelete='CASCADE'
    )
    
    # Create a unique partial index to ensure only one default session per engagement
    op.create_index(
        'idx_engagement_default_session',
        'data_import_sessions',
        ['engagement_id'],
        unique=True,
        postgresql_where=sa.text("is_default = true"),
        postgresql_ops={'engagement_id': 'uuid_ops'}
    )
    
    # Create a function to handle setting default sessions
    op.execute("""
    CREATE OR REPLACE FUNCTION set_default_session()
    RETURNS TRIGGER AS $$
    BEGIN
        -- If this is being set as default, unset any other default for this engagement
        IF NEW.is_default = true THEN
            UPDATE data_import_sessions
            SET is_default = false
            WHERE engagement_id = NEW.engagement_id
            AND id != NEW.id;
        END IF;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    """)
    
    # Create a trigger to ensure only one default session per engagement
    op.execute("""
    DROP TRIGGER IF EXISTS trigger_set_default_session ON data_import_sessions;
    """)
    
    op.execute("""
    CREATE TRIGGER trigger_set_default_session
    BEFORE INSERT OR UPDATE OF is_default ON data_import_sessions
    FOR EACH ROW
    EXECUTE FUNCTION set_default_session();
    """)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    
    # Drop the trigger and function first
    op.execute("""
    DROP TRIGGER IF EXISTS trigger_set_default_session ON data_import_sessions;
    DROP FUNCTION IF EXISTS set_default_session();
    """)
    
    # Drop the unique partial index
    op.drop_index('idx_engagement_default_session', table_name='data_import_sessions')
    
    # Drop foreign keys with proper names
    op.drop_constraint('fk_data_import_sessions_engagement_id', 'data_import_sessions', type_='foreignkey')
    op.drop_constraint('fk_data_import_sessions_client_account_id', 'data_import_sessions', type_='foreignkey')
    op.drop_constraint('fk_data_import_sessions_parent_session_id', 'data_import_sessions', type_='foreignkey')
    
    # Recreate original foreign keys
    op.create_foreign_key(
        'data_import_sessions_engagement_id_fkey',
        'data_import_sessions', 'engagements',
        ['engagement_id'], ['id'],
        ondelete='CASCADE'
    )
    
    op.create_foreign_key(
        'data_import_sessions_client_account_id_fkey',
        'data_import_sessions', 'client_accounts',
        ['client_account_id'], ['id'],
        ondelete='CASCADE'
    )
    
    # Drop indexes
    op.drop_index(op.f('ix_data_import_sessions_status'), table_name='data_import_sessions')
    op.drop_index(op.f('ix_data_import_sessions_session_name'), table_name='data_import_sessions')
    op.drop_index(op.f('ix_data_import_sessions_is_mock'), table_name='data_import_sessions')
    op.drop_index(op.f('ix_data_import_sessions_is_default'), table_name='data_import_sessions')
    op.drop_index(op.f('ix_data_import_sessions_id'), table_name='data_import_sessions')
    op.drop_index(op.f('ix_data_import_sessions_engagement_id'), table_name='data_import_sessions')
    op.drop_index(op.f('ix_data_import_sessions_client_account_id'), table_name='data_import_sessions')
    
    # Drop columns in reverse order of creation
    op.drop_column('data_import_sessions', 'is_mock')
    op.drop_column('data_import_sessions', 'last_activity_at')
    op.drop_column('data_import_sessions', 'completed_at')
    op.drop_column('data_import_sessions', 'started_at')
    op.drop_column('data_import_sessions', 'agent_insights')
    op.drop_column('data_import_sessions', 'business_context')
    op.drop_column('data_import_sessions', 'session_config')
    op.drop_column('data_import_sessions', 'data_quality_score')
    op.drop_column('data_import_sessions', 'total_records_imported')
    op.drop_column('data_import_sessions', 'total_assets_processed')
    op.drop_column('data_import_sessions', 'total_imports')
    op.drop_column('data_import_sessions', 'progress_percentage')
    op.drop_column('data_import_sessions', 'source_filename')
    op.drop_column('data_import_sessions', 'auto_created')
    op.drop_column('data_import_sessions', 'session_type')
    op.drop_column('data_import_sessions', 'parent_session_id')
    op.drop_column('data_import_sessions', 'is_default')
    op.drop_column('data_import_sessions', 'session_display_name')
    # ### end Alembic commands ### 