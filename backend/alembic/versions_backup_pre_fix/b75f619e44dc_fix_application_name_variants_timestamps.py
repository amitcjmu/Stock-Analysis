"""fix_application_name_variants_timestamps

Revision ID: b75f619e44dc
Revises: 041_add_hybrid_properties
Create Date: 2025-09-02 21:59:59.015918

"""

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
import pgvector.sqlalchemy

# revision identifiers, used by Alembic.
revision = "b75f619e44dc"
down_revision = "041_add_hybrid_properties"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "llm_model_pricing",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("provider", sa.String(length=100), nullable=False),
        sa.Column("model_name", sa.String(length=255), nullable=False),
        sa.Column("model_version", sa.String(length=100), nullable=True),
        sa.Column(
            "input_cost_per_1k_tokens",
            sa.Numeric(precision=10, scale=6),
            nullable=False,
        ),
        sa.Column(
            "output_cost_per_1k_tokens",
            sa.Numeric(precision=10, scale=6),
            nullable=False,
        ),
        sa.Column("currency", sa.String(length=10), nullable=False),
        sa.Column("effective_from", sa.DateTime(timezone=True), nullable=False),
        sa.Column("effective_to", sa.DateTime(timezone=True), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=False),
        sa.Column("source", sa.String(length=255), nullable=True),
        sa.Column("notes", sa.Text(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "provider",
            "model_name",
            "model_version",
            "effective_from",
            name="uq_model_pricing_version_date",
        ),
        schema="migration",
    )
    op.create_index(
        "idx_model_pricing_active",
        "llm_model_pricing",
        ["is_active", "effective_from", "effective_to"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_model_pricing_provider_model",
        "llm_model_pricing",
        ["provider", "model_name"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "migrations",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "status",
            sa.Enum(
                "PLANNING",
                "IN_PROGRESS",
                "COMPLETED",
                "PAUSED",
                "CANCELLED",
                name="migrationstatus",
            ),
            nullable=True,
        ),
        sa.Column(
            "current_phase",
            sa.Enum(
                "DISCOVERY",
                "ASSESS",
                "PLAN",
                "EXECUTE",
                "MODERNIZE",
                "FINOPS",
                "OBSERVABILITY",
                "DECOMMISSION",
                name="migrationphase",
            ),
            nullable=True,
        ),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("target_completion_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_completion_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("source_environment", sa.String(length=100), nullable=True),
        sa.Column("target_environment", sa.String(length=100), nullable=True),
        sa.Column("migration_strategy", sa.String(length=50), nullable=True),
        sa.Column("progress_percentage", sa.Integer(), nullable=True),
        sa.Column("total_assets", sa.Integer(), nullable=True),
        sa.Column("migrated_assets", sa.Integer(), nullable=True),
        sa.Column("ai_recommendations", sa.JSON(), nullable=True),
        sa.Column("risk_assessment", sa.JSON(), nullable=True),
        sa.Column("cost_estimates", sa.JSON(), nullable=True),
        sa.Column("settings", sa.JSON(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migrations_id"),
        "migrations",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migrations_name"),
        "migrations",
        ["name"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "role_change_approvals",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("requested_by", sa.String(length=36), nullable=False),
        sa.Column("target_user_id", sa.String(length=36), nullable=False),
        sa.Column("current_role", sa.String(length=50), nullable=False),
        sa.Column("requested_role", sa.String(length=50), nullable=False),
        sa.Column("justification", sa.Text(), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("approved_by", sa.String(length=36), nullable=True),
        sa.Column("approval_notes", sa.Text(), nullable=True),
        sa.Column(
            "requested_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("approved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("expires_at", sa.DateTime(timezone=True), nullable=True),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_role_change_approvals_requested_by"),
        "role_change_approvals",
        ["requested_by"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_role_change_approvals_target_user_id"),
        "role_change_approvals",
        ["target_user_id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "asset_embeddings",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("asset_id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column(
            "embedding", pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True
        ),
        sa.Column("source_text", sa.Text(), nullable=True),
        sa.Column("embedding_model", sa.String(length=100), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["asset_id"], ["migration.assets.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["migration.client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["migration.engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_asset_embeddings_asset_id"),
        "asset_embeddings",
        ["asset_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_asset_embeddings_client_account_id"),
        "asset_embeddings",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_asset_embeddings_engagement_id"),
        "asset_embeddings",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_asset_embeddings_id"),
        "asset_embeddings",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "cmdb_sixr_analyses",
        sa.Column(
            "id",
            sa.UUID(),
            nullable=False,
            comment="Unique identifier for the 6R analysis run.",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            nullable=False,
            comment="The client account this analysis belongs to.",
        ),
        sa.Column(
            "engagement_id",
            sa.UUID(),
            nullable=False,
            comment="The engagement this analysis is for.",
        ),
        sa.Column(
            "analysis_name",
            sa.String(length=255),
            nullable=False,
            comment="A user-defined name for the analysis.",
        ),
        sa.Column(
            "description",
            sa.Text(),
            nullable=True,
            comment="A description of the analysis goals or scope.",
        ),
        sa.Column(
            "status",
            sa.String(length=50),
            nullable=True,
            comment="The status of the analysis run (e.g., 'in_progress', 'completed', 'failed').",
        ),
        sa.Column(
            "total_assets",
            sa.Integer(),
            nullable=True,
            comment="The total number of assets included in this analysis.",
        ),
        sa.Column(
            "rehost_count",
            sa.Integer(),
            nullable=True,
            comment="The number of assets recommended for Rehosting.",
        ),
        sa.Column(
            "replatform_count",
            sa.Integer(),
            nullable=True,
            comment="The number of assets recommended for Replatforming.",
        ),
        sa.Column(
            "refactor_count",
            sa.Integer(),
            nullable=True,
            comment="The number of assets recommended for Refactoring.",
        ),
        sa.Column(
            "rearchitect_count",
            sa.Integer(),
            nullable=True,
            comment="The number of assets recommended for Rearchitecting.",
        ),
        sa.Column(
            "retire_count",
            sa.Integer(),
            nullable=True,
            comment="The number of assets recommended for Retiring.",
        ),
        sa.Column(
            "retain_count",
            sa.Integer(),
            nullable=True,
            comment="The number of assets recommended for Retaining.",
        ),
        sa.Column(
            "total_current_cost",
            sa.Float(),
            nullable=True,
            comment="The total estimated current monthly cost of all analyzed assets.",
        ),
        sa.Column(
            "total_estimated_cost",
            sa.Float(),
            nullable=True,
            comment="The total estimated future monthly cost after applying the recommendations.",
        ),
        sa.Column(
            "potential_savings",
            sa.Float(),
            nullable=True,
            comment="The estimated potential monthly savings.",
        ),
        sa.Column(
            "analysis_results",
            sa.JSON(),
            nullable=True,
            comment="A JSON blob containing the detailed analysis results for each individual asset.",
        ),
        sa.Column(
            "recommendations",
            sa.JSON(),
            nullable=True,
            comment="A JSON blob containing the high-level summary and overall recommendations from the analysis.",
        ),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
            comment="Timestamp when the analysis was created.",
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Timestamp of the last update to the analysis.",
        ),
        sa.Column(
            "created_by",
            sa.UUID(),
            nullable=True,
            comment="The user who initiated the analysis.",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["migration.client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["migration.users.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["migration.engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_cmdb_sixr_analyses_client_account_id"),
        "cmdb_sixr_analyses",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_cmdb_sixr_analyses_engagement_id"),
        "cmdb_sixr_analyses",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_cmdb_sixr_analyses_id"),
        "cmdb_sixr_analyses",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_cmdb_sixr_analyses_status"),
        "cmdb_sixr_analyses",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "custom_target_fields",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("field_name", sa.String(), nullable=False),
        sa.Column("field_type", sa.String(), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("is_required", sa.Boolean(), nullable=True),
        sa.Column("is_critical", sa.Boolean(), nullable=True),
        sa.Column("created_at", sa.DateTime(), nullable=True),
        sa.Column("updated_at", sa.DateTime(), nullable=True),
        sa.Column("created_by", sa.UUID(), nullable=True),
        sa.Column("validation_schema", sa.JSON(), nullable=True),
        sa.Column("default_value", sa.String(), nullable=True),
        sa.Column("allowed_values", sa.JSON(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["migration.users.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_table(
        "feedback",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("feedback_type", sa.String(length=50), nullable=False),
        sa.Column("page", sa.String(length=255), nullable=True),
        sa.Column("rating", sa.Integer(), nullable=True),
        sa.Column("comment", sa.Text(), nullable=True),
        sa.Column("category", sa.String(length=50), nullable=True),
        sa.Column("breadcrumb", sa.String(length=500), nullable=True),
        sa.Column("filename", sa.String(length=255), nullable=True),
        sa.Column("original_analysis", sa.JSON(), nullable=True),
        sa.Column("user_corrections", sa.JSON(), nullable=True),
        sa.Column("asset_type_override", sa.String(length=100), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=True),
        sa.Column("processed", sa.Boolean(), nullable=True),
        sa.Column("user_agent", sa.String(length=500), nullable=True),
        sa.Column("user_timestamp", sa.String(length=50), nullable=True),
        sa.Column("client_ip", sa.String(length=45), nullable=True),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column("learning_patterns_extracted", sa.JSON(), nullable=True),
        sa.Column("confidence_impact", sa.Float(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("processed_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["migration.client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["migration.engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_feedback_feedback_type"),
        "feedback",
        ["feedback_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_feedback_id"),
        "feedback",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_feedback_page"),
        "feedback",
        ["page"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "feedback_summaries",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("feedback_type", sa.String(length=50), nullable=False),
        sa.Column("page", sa.String(length=255), nullable=True),
        sa.Column("time_period", sa.String(length=20), nullable=True),
        sa.Column("total_feedback", sa.Integer(), nullable=True),
        sa.Column("average_rating", sa.Float(), nullable=True),
        sa.Column("status_counts", sa.JSON(), nullable=True),
        sa.Column("rating_distribution", sa.JSON(), nullable=True),
        sa.Column("category_counts", sa.JSON(), nullable=True),
        sa.Column("feedback_trend", sa.JSON(), nullable=True),
        sa.Column("rating_trend", sa.JSON(), nullable=True),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column(
            "last_calculated",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("calculation_duration_ms", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["migration.client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["migration.engagements.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_feedback_summaries_feedback_type"),
        "feedback_summaries",
        ["feedback_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_feedback_summaries_id"),
        "feedback_summaries",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_feedback_summaries_page"),
        "feedback_summaries",
        ["page"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "llm_usage_logs",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column("username", sa.String(length=255), nullable=True),
        sa.Column("flow_id", sa.String(length=255), nullable=True),
        sa.Column("request_id", sa.String(length=255), nullable=True),
        sa.Column("endpoint", sa.String(length=500), nullable=True),
        sa.Column("page_context", sa.String(length=255), nullable=True),
        sa.Column("feature_context", sa.String(length=255), nullable=True),
        sa.Column("llm_provider", sa.String(length=100), nullable=False),
        sa.Column("model_name", sa.String(length=255), nullable=False),
        sa.Column("model_version", sa.String(length=100), nullable=True),
        sa.Column("input_tokens", sa.Integer(), nullable=True),
        sa.Column("output_tokens", sa.Integer(), nullable=True),
        sa.Column("total_tokens", sa.Integer(), nullable=True),
        sa.Column("input_cost", sa.Numeric(precision=10, scale=6), nullable=True),
        sa.Column("output_cost", sa.Numeric(precision=10, scale=6), nullable=True),
        sa.Column("total_cost", sa.Numeric(precision=10, scale=6), nullable=True),
        sa.Column("cost_currency", sa.String(length=10), nullable=False),
        sa.Column("response_time_ms", sa.Integer(), nullable=True),
        sa.Column("success", sa.Boolean(), nullable=False),
        sa.Column("error_type", sa.String(length=255), nullable=True),
        sa.Column("error_message", sa.Text(), nullable=True),
        sa.Column(
            "request_data", postgresql.JSONB(astext_type=sa.Text()), nullable=True
        ),
        sa.Column(
            "response_data", postgresql.JSONB(astext_type=sa.Text()), nullable=True
        ),
        sa.Column(
            "additional_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=True,
        ),
        sa.Column("ip_address", sa.String(length=45), nullable=True),
        sa.Column("user_agent", sa.String(length=500), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["migration.engagements.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_client_account",
        "llm_usage_logs",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_cost_analysis",
        "llm_usage_logs",
        ["client_account_id", "llm_provider", "model_name", "created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_created_at",
        "llm_usage_logs",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_engagement",
        "llm_usage_logs",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_feature_context",
        "llm_usage_logs",
        ["feature_context"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_page_context",
        "llm_usage_logs",
        ["page_context"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_provider_model",
        "llm_usage_logs",
        ["llm_provider", "model_name"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_reporting",
        "llm_usage_logs",
        ["client_account_id", "created_at", "success"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_success",
        "llm_usage_logs",
        ["success"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_llm_usage_user",
        "llm_usage_logs",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "llm_usage_summary",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("period_type", sa.String(length=20), nullable=False),
        sa.Column("period_start", sa.DateTime(timezone=True), nullable=False),
        sa.Column("period_end", sa.DateTime(timezone=True), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=True),
        sa.Column("engagement_id", sa.UUID(), nullable=True),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column("llm_provider", sa.String(length=100), nullable=True),
        sa.Column("model_name", sa.String(length=255), nullable=True),
        sa.Column("page_context", sa.String(length=255), nullable=True),
        sa.Column("feature_context", sa.String(length=255), nullable=True),
        sa.Column("total_requests", sa.Integer(), nullable=False),
        sa.Column("successful_requests", sa.Integer(), nullable=False),
        sa.Column("failed_requests", sa.Integer(), nullable=False),
        sa.Column("total_input_tokens", sa.BigInteger(), nullable=False),
        sa.Column("total_output_tokens", sa.BigInteger(), nullable=False),
        sa.Column("total_tokens", sa.BigInteger(), nullable=False),
        sa.Column("total_cost", sa.Numeric(precision=12, scale=6), nullable=False),
        sa.Column("avg_response_time_ms", sa.Integer(), nullable=True),
        sa.Column("min_response_time_ms", sa.Integer(), nullable=True),
        sa.Column("max_response_time_ms", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["migration.engagements.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "period_type",
            "period_start",
            "client_account_id",
            "engagement_id",
            "user_id",
            "llm_provider",
            "model_name",
            "page_context",
            "feature_context",
            name="uq_usage_summary_period_context",
        ),
        schema="migration",
    )
    op.create_index(
        "idx_usage_summary_client",
        "llm_usage_summary",
        ["client_account_id", "period_start"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_usage_summary_model",
        "llm_usage_summary",
        ["llm_provider", "model_name", "period_start"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_usage_summary_period",
        "llm_usage_summary",
        ["period_type", "period_start", "period_end"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "migration_logs",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("migration_id", sa.UUID(), nullable=False),
        sa.Column(
            "timestamp",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("level", sa.String(length=20), nullable=True),
        sa.Column("message", sa.Text(), nullable=False),
        sa.Column("details", sa.JSON(), nullable=True),
        sa.Column(
            "phase",
            sa.Enum(
                "DISCOVERY",
                "ASSESS",
                "PLAN",
                "EXECUTE",
                "MODERNIZE",
                "FINOPS",
                "OBSERVABILITY",
                "DECOMMISSION",
                name="migrationphase",
            ),
            nullable=True,
        ),
        sa.Column("user_id", sa.String(length=100), nullable=True),
        sa.Column("action", sa.String(length=100), nullable=True),
        sa.ForeignKeyConstraint(
            ["migration_id"],
            ["migration.migrations.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migration_logs_id"),
        "migration_logs",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "tags",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("name", sa.String(length=100), nullable=False),
        sa.Column("category", sa.String(length=50), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column(
            "reference_embedding",
            pgvector.sqlalchemy.vector.VECTOR(dim=1536),
            nullable=True,
        ),
        sa.Column("confidence_threshold", sa.Float(), nullable=True),
        sa.Column("is_active", sa.Boolean(), nullable=True),
        sa.Column("usage_count", sa.Integer(), nullable=True),
        sa.Column("last_used", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["migration.client_accounts.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_tags_category"),
        "tags",
        ["category"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_tags_client_account_id"),
        "tags",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_tags_id"), "tags", ["id"], unique=False, schema="migration"
    )
    op.create_index(
        op.f("ix_migration_tags_is_active"),
        "tags",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_tags_name"),
        "tags",
        ["name"],
        unique=True,
        schema="migration",
    )
    op.create_table(
        "user_active_flows",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("user_id", sa.UUID(), nullable=False),
        sa.Column("flow_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column(
            "activated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("is_current", sa.Boolean(), nullable=False),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["migration.engagements.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["migration.users.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "user_id", "flow_id", name="uq_user_active_flows_user_flow"
        ),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_active_flows_engagement_id"),
        "user_active_flows",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_active_flows_flow_id"),
        "user_active_flows",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_active_flows_id"),
        "user_active_flows",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_active_flows_is_current"),
        "user_active_flows",
        ["is_current"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_active_flows_user_id"),
        "user_active_flows",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "wave_plans",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("client_account_id", sa.UUID(), nullable=False),
        sa.Column("engagement_id", sa.UUID(), nullable=False),
        sa.Column("migration_id", sa.UUID(), nullable=False),
        sa.Column("wave_number", sa.Integer(), nullable=False),
        sa.Column("wave_name", sa.String(length=255), nullable=True),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("planned_start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("planned_end_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_start_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("actual_end_date", sa.DateTime(timezone=True), nullable=True),
        sa.Column("total_assets", sa.Integer(), nullable=True),
        sa.Column("completed_assets", sa.Integer(), nullable=True),
        sa.Column("estimated_effort_hours", sa.Integer(), nullable=True),
        sa.Column("estimated_cost", sa.Float(), nullable=True),
        sa.Column("prerequisites", sa.JSON(), nullable=True),
        sa.Column("dependencies", sa.JSON(), nullable=True),
        sa.Column("constraints", sa.JSON(), nullable=True),
        sa.Column(
            "overall_risk_level",
            sa.Enum("LOW", "MEDIUM", "HIGH", "CRITICAL", name="risklevel"),
            nullable=True,
        ),
        sa.Column("complexity_score", sa.Float(), nullable=True),
        sa.Column("success_criteria", sa.JSON(), nullable=True),
        sa.Column("status", sa.String(length=50), nullable=True),
        sa.Column("progress_percentage", sa.Float(), nullable=True),
        sa.Column("ai_recommendations", sa.JSON(), nullable=True),
        sa.Column("optimization_score", sa.Float(), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"], ["migration.client_accounts.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"], ["migration.engagements.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["migration_id"],
            ["migration.migrations.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_wave_plans_client_account_id"),
        "wave_plans",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_wave_plans_engagement_id"),
        "wave_plans",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_wave_plans_id"),
        "wave_plans",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "workflow_progress",
        sa.Column(
            "id",
            sa.UUID(),
            nullable=False,
            comment="Unique identifier for the progress record.",
        ),
        sa.Column(
            "asset_id",
            sa.UUID(),
            nullable=False,
            comment="Foreign key to the asset this progress record belongs to.",
        ),
        sa.Column(
            "stage",
            sa.String(length=50),
            nullable=False,
            comment="The workflow stage being tracked (e.g., 'Discovery', 'Assessment', 'Migration').",
        ),
        sa.Column(
            "status",
            sa.String(length=50),
            nullable=False,
            comment="The status within that stage (e.g., 'Not Started', 'In Progress', 'Completed').",
        ),
        sa.Column(
            "notes",
            sa.Text(),
            nullable=True,
            comment="Any notes or logs related to this specific progress step.",
        ),
        sa.Column(
            "started_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Timestamp when this stage was started.",
        ),
        sa.Column(
            "completed_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Timestamp when this stage was completed.",
        ),
        sa.ForeignKeyConstraint(
            ["asset_id"], ["migration.assets.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_table(
        "asset_tags",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("asset_id", sa.UUID(), nullable=False),
        sa.Column("tag_id", sa.UUID(), nullable=False),
        sa.Column("confidence_score", sa.Float(), nullable=True),
        sa.Column("assigned_method", sa.String(length=50), nullable=True),
        sa.Column("assigned_by", sa.UUID(), nullable=True),
        sa.Column("is_validated", sa.Boolean(), nullable=True),
        sa.Column("validated_by", sa.UUID(), nullable=True),
        sa.Column("validated_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["asset_id"], ["migration.assets.id"], ondelete="CASCADE"
        ),
        sa.ForeignKeyConstraint(
            ["assigned_by"],
            ["migration.users.id"],
        ),
        sa.ForeignKeyConstraint(["tag_id"], ["migration.tags.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(
            ["validated_by"],
            ["migration.users.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_asset_tags_asset_id"),
        "asset_tags",
        ["asset_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_asset_tags_tag_id"),
        "asset_tags",
        ["tag_id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "import_processing_steps",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            nullable=False,
            comment="Unique identifier for the processing step log.",
        ),
        sa.Column(
            "data_import_id",
            sa.UUID(),
            nullable=False,
            comment="Foreign key to the parent data import job.",
        ),
        sa.Column(
            "step_name",
            sa.String(length=100),
            nullable=False,
            comment="The name of the processing step (e.g., 'validation', 'field_mapping').",
        ),
        sa.Column(
            "step_order",
            sa.Integer(),
            nullable=False,
            comment="The sequential order of this step in the workflow.",
        ),
        sa.Column(
            "status",
            sa.String(length=20),
            nullable=False,
            comment="The execution status of this step (e.g., 'pending', 'running', 'completed', 'failed').",
        ),
        sa.Column(
            "description",
            sa.Text(),
            nullable=True,
            comment="A description of what this processing step does.",
        ),
        sa.Column(
            "input_data",
            sa.JSON(),
            nullable=True,
            comment="A snapshot of the input data for this step, for debugging.",
        ),
        sa.Column(
            "output_data",
            sa.JSON(),
            nullable=True,
            comment="A snapshot of the output data from this step, for debugging.",
        ),
        sa.Column(
            "error_details",
            sa.JSON(),
            nullable=True,
            comment="A JSON blob containing detailed error information if the step failed.",
        ),
        sa.Column(
            "records_processed",
            sa.Integer(),
            nullable=True,
            comment="The number of records processed in this step.",
        ),
        sa.Column(
            "duration_seconds",
            sa.Float(),
            nullable=True,
            comment="The duration of this step in seconds.",
        ),
        sa.Column(
            "started_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
            comment="Timestamp when this step started execution.",
        ),
        sa.Column(
            "completed_at",
            sa.DateTime(timezone=True),
            nullable=True,
            comment="Timestamp when this step completed or failed.",
        ),
        sa.ForeignKeyConstraint(
            ["data_import_id"], ["migration.data_imports.id"], ondelete="CASCADE"
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
        comment="Tracks the execution and outcome of individual steps in a data import workflow.",
    )
    op.create_table(
        "tech_debt_analyses",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("assessment_flow_id", sa.UUID(), nullable=False),
        sa.Column("application_id", sa.UUID(), nullable=False),
        sa.Column("component_id", sa.UUID(), nullable=True),
        sa.Column("debt_type", sa.String(length=100), nullable=False),
        sa.Column("debt_category", sa.String(length=100), nullable=False),
        sa.Column("severity", sa.String(length=50), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("root_cause", sa.Text(), nullable=True),
        sa.Column(
            "impact_analysis", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        sa.Column("debt_score", sa.Float(), nullable=True),
        sa.Column("impact_score", sa.Float(), nullable=True),
        sa.Column("effort_score", sa.Float(), nullable=True),
        sa.Column("priority_score", sa.Float(), nullable=True),
        sa.Column("remediation_strategy", sa.Text(), nullable=True),
        sa.Column("estimated_effort", sa.String(length=100), nullable=True),
        sa.Column("recommended_timeline", sa.String(length=100), nullable=True),
        sa.Column(
            "prerequisites", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        sa.Column(
            "risk_factors", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        sa.Column(
            "dependencies", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        sa.Column(
            "affected_components",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        sa.Column("analysis_method", sa.String(length=100), nullable=True),
        sa.Column("confidence_level", sa.Float(), nullable=True),
        sa.Column("evidence", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column("status", sa.String(length=50), nullable=False),
        sa.Column("resolution_status", sa.String(length=50), nullable=True),
        sa.Column(
            "risk_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        sa.Column("resolved_at", sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(
            ["assessment_flow_id"],
            ["migration.assessment_flows.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        schema="migration",
    )
    op.drop_table("pii_data_registry", schema="migration")
    op.drop_table("engagements")
    op.drop_index(op.f("ix_migration_sixr_questions_id"), table_name="sixr_questions")
    op.drop_index(
        op.f("ix_migration_sixr_questions_question_id"), table_name="sixr_questions"
    )
    op.drop_index(op.f("ix_sixr_questions_category"), table_name="sixr_questions")
    op.drop_index(op.f("ix_sixr_questions_question_id"), table_name="sixr_questions")
    op.drop_table("sixr_questions")
    op.drop_table("alembic_version")
    op.drop_table("failure_journal", schema="migration")
    op.drop_index(
        op.f("idx_security_audit_logs_actor_user_id"), table_name="security_audit_logs"
    )
    op.drop_index(
        op.f("idx_security_audit_logs_created_at"), table_name="security_audit_logs"
    )
    op.drop_index(
        op.f("idx_security_audit_logs_event_type"), table_name="security_audit_logs"
    )
    op.drop_index(
        op.f("idx_security_audit_logs_is_suspicious"), table_name="security_audit_logs"
    )
    op.drop_index(
        op.f("idx_security_audit_logs_severity"), table_name="security_audit_logs"
    )
    op.drop_index(
        op.f("idx_security_audit_logs_target_user_id"), table_name="security_audit_logs"
    )
    op.drop_table("security_audit_logs")
    op.drop_index(
        op.f("ix_migration_sixr_analysis_parameters_id"),
        table_name="sixr_analysis_parameters",
    )
    op.drop_index(
        op.f("ix_sixr_analysis_parameters_analysis_id"),
        table_name="sixr_analysis_parameters",
    )
    op.drop_table("sixr_analysis_parameters")
    op.drop_table("users")
    op.drop_index(
        op.f("ix_discovery_flows_client_account_id"), table_name="discovery_flows"
    )
    op.drop_index(
        op.f("ix_discovery_flows_data_import_id"), table_name="discovery_flows"
    )
    op.drop_index(
        op.f("ix_discovery_flows_engagement_id"), table_name="discovery_flows"
    )
    op.drop_index(op.f("ix_discovery_flows_flow_id"), table_name="discovery_flows")
    op.drop_index(op.f("ix_discovery_flows_id"), table_name="discovery_flows")
    op.drop_index(
        op.f("ix_discovery_flows_master_flow_id"), table_name="discovery_flows"
    )
    op.drop_index(op.f("ix_discovery_flows_status"), table_name="discovery_flows")
    op.drop_table("discovery_flows")
    op.drop_table("application_components")
    op.drop_index(
        op.f("ix_migration_sixr_parameters_parameter_key"), table_name="sixr_parameters"
    )
    op.drop_index(
        op.f("ix_sixr_parameters_parameter_key"), table_name="sixr_parameters"
    )
    op.drop_table("sixr_parameters")
    op.drop_index(
        op.f("ix_application_architecture_overrides_application_id"),
        table_name="application_architecture_overrides",
    )
    op.drop_index(
        op.f("ix_application_architecture_overrides_assessment_flow_id"),
        table_name="application_architecture_overrides",
    )
    op.drop_table("application_architecture_overrides")
    op.drop_index(op.f("idx_queue_items_queue_id"), table_name="analysis_queue_items")
    op.drop_table("analysis_queue_items")
    op.drop_index(
        op.f("ix_collected_data_inventory_collection_flow_id"),
        table_name="collected_data_inventory",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_credential_id"),
        table_name="collected_data_inventory",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_data_type"),
        table_name="collected_data_inventory",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_platform"),
        table_name="collected_data_inventory",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_validation_status"),
        table_name="collected_data_inventory",
    )
    op.drop_table("collected_data_inventory")
    op.drop_table("component_treatments")
    op.drop_table("user_profiles")
    op.drop_index(
        op.f("ix_cache_invalidation_metadata"), table_name="cache_invalidation_logs"
    )
    op.drop_index(
        op.f("ix_cache_invalidation_time_series"), table_name="cache_invalidation_logs"
    )
    op.drop_index(
        op.f("ix_cache_invalidation_trigger"), table_name="cache_invalidation_logs"
    )
    op.drop_table("cache_invalidation_logs")
    op.drop_index(
        op.f("ix_flow_deletion_audit_client_account_id"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deleted_at"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deletion_type"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_engagement_id"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_flow_id"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_tenant_flow"), table_name="flow_deletion_audit"
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_client_account_id"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_deleted_at"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_deletion_type"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_engagement_id"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_flow_id"),
        table_name="flow_deletion_audit",
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_id"), table_name="flow_deletion_audit"
    )
    op.drop_table("flow_deletion_audit")
    op.drop_index(
        op.f("ix_collection_flows_automation_tier"), table_name="collection_flows"
    )
    op.drop_index(
        op.f("ix_collection_flows_client_account_id"), table_name="collection_flows"
    )
    op.drop_index(
        op.f("ix_collection_flows_engagement_id"), table_name="collection_flows"
    )
    op.drop_index(op.f("ix_collection_flows_flow_id"), table_name="collection_flows")
    op.drop_index(op.f("ix_collection_flows_id"), table_name="collection_flows")
    op.drop_index(
        op.f("ix_collection_flows_master_flow_id"), table_name="collection_flows"
    )
    op.drop_index(op.f("ix_collection_flows_status"), table_name="collection_flows")
    op.drop_table("collection_flows")
    op.drop_index(
        op.f("idx_canonical_apps_dedup_workflow"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("idx_canonical_apps_fulltext_search"),
        table_name="canonical_applications",
        postgresql_using="gin",
    )
    op.drop_index(
        op.f("idx_canonical_apps_hash_exact_match"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("idx_canonical_apps_hash_lookup"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("idx_canonical_apps_high_usage_only"),
        table_name="canonical_applications",
        postgresql_where="(usage_count >= 5)",
    )
    op.drop_index(
        op.f("idx_canonical_apps_normalized_pattern"),
        table_name="canonical_applications",
    )
    op.drop_index(
        op.f("idx_canonical_apps_quality_assessment"),
        table_name="canonical_applications",
    )
    op.drop_index(
        op.f("idx_canonical_apps_tenant_isolation"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("idx_canonical_apps_tenant_search_ranked"),
        table_name="canonical_applications",
    )
    op.drop_index(
        op.f("idx_canonical_apps_tenant_security"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("idx_canonical_apps_unverified_only"),
        table_name="canonical_applications",
        postgresql_where="(is_verified = false)",
    )
    op.drop_index(op.f("idx_canonical_apps_usage"), table_name="canonical_applications")
    op.drop_index(
        op.f("idx_canonical_apps_usage_stats"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("idx_canonical_apps_vector_similarity"),
        table_name="canonical_applications",
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.drop_index(
        op.f("idx_canonical_apps_verification"), table_name="canonical_applications"
    )
    op.drop_index(
        op.f("ix_migration_canonical_applications_client_account_id"),
        table_name="canonical_applications",
    )
    op.drop_index(
        op.f("ix_migration_canonical_applications_engagement_id"),
        table_name="canonical_applications",
    )
    op.drop_index(
        op.f("ix_migration_canonical_applications_name_hash"),
        table_name="canonical_applications",
    )
    op.drop_index(
        op.f("ix_migration_canonical_applications_normalized_name"),
        table_name="canonical_applications",
    )
    op.drop_table("canonical_applications")
    op.drop_index(
        op.f("idx_queue_items_queue_id"),
        table_name="analysis_queue_items",
        schema="migration",
    )
    op.drop_table("analysis_queue_items", schema="migration")
    op.drop_index(
        op.f("ix_cache_invalidation_metadata"),
        table_name="cache_invalidation_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_invalidation_time_series"),
        table_name="cache_invalidation_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_invalidation_trigger"),
        table_name="cache_invalidation_logs",
        schema="migration",
    )
    op.drop_table("cache_invalidation_logs", schema="migration")
    op.drop_index(
        op.f("ix_credential_rotation_history_credential_id"),
        table_name="credential_rotation_history",
    )
    op.drop_index(
        op.f("ix_credential_rotation_history_rotated_at"),
        table_name="credential_rotation_history",
    )
    op.drop_index(
        op.f("ix_credential_rotation_history_rotation_type"),
        table_name="credential_rotation_history",
    )
    op.drop_table("credential_rotation_history")
    op.drop_index(
        op.f("ix_migration_sixr_question_responses_id"),
        table_name="sixr_question_responses",
    )
    op.drop_index(
        op.f("ix_sixr_question_responses_analysis_id"),
        table_name="sixr_question_responses",
    )
    op.drop_table("sixr_question_responses")
    op.drop_index(
        op.f("ix_platform_adapters_adapter_name"), table_name="platform_adapters"
    )
    op.drop_index(
        op.f("ix_platform_adapters_adapter_type"), table_name="platform_adapters"
    )
    op.drop_index(op.f("ix_platform_adapters_status"), table_name="platform_adapters")
    op.drop_table("platform_adapters")
    op.drop_index(op.f("ix_migration_sixr_iterations_id"), table_name="sixr_iterations")
    op.drop_index(op.f("ix_sixr_iterations_analysis_id"), table_name="sixr_iterations")
    op.drop_table("sixr_iterations")
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_action_type"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_client_account_id"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_created_at"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_engagement_id"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_resource_type"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_result"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_user_id"),
        table_name="enhanced_access_audit_log",
    )
    op.drop_table("enhanced_access_audit_log")
    op.drop_table("tech_debt_analysis")
    op.drop_index(
        op.f("ix_cache_perf_metadata_lookup"), table_name="cache_performance_logs"
    )
    op.drop_index(
        op.f("ix_cache_perf_tenant_analytics"), table_name="cache_performance_logs"
    )
    op.drop_index(
        op.f("ix_cache_perf_time_series"), table_name="cache_performance_logs"
    )
    op.drop_table("cache_performance_logs")
    op.drop_index(
        op.f("ix_credential_access_logs_access_type"),
        table_name="credential_access_logs",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_accessed_at"),
        table_name="credential_access_logs",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_accessed_by"),
        table_name="credential_access_logs",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_credential_id"),
        table_name="credential_access_logs",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_success"), table_name="credential_access_logs"
    )
    op.drop_table("credential_access_logs")
    op.drop_index(
        op.f("ix_platform_credentials_client_account_id"),
        table_name="platform_credentials",
    )
    op.drop_index(
        op.f("ix_platform_credentials_credential_type"),
        table_name="platform_credentials",
    )
    op.drop_index(
        op.f("ix_platform_credentials_expires_at"), table_name="platform_credentials"
    )
    op.drop_index(
        op.f("ix_platform_credentials_platform_adapter_id"),
        table_name="platform_credentials",
    )
    op.drop_index(
        op.f("ix_platform_credentials_status"), table_name="platform_credentials"
    )
    op.drop_table("platform_credentials")
    op.drop_table("import_field_mappings")
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_action_type"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_client_account_id"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_created_at"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_engagement_id"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_resource_type"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_result"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_enhanced_access_audit_log_user_id"),
        table_name="enhanced_access_audit_log",
        schema="migration",
    )
    op.drop_table("enhanced_access_audit_log", schema="migration")
    op.drop_table("cache_configurations")
    op.drop_table("tech_debt_analysis", schema="migration")
    op.drop_table("data_imports")
    op.drop_index(op.f("ix_user_roles_id"), table_name="user_roles")
    op.drop_index(op.f("ix_user_roles_is_active"), table_name="user_roles")
    op.drop_index(op.f("ix_user_roles_user_id"), table_name="user_roles")
    op.drop_table("user_roles")
    op.drop_index(
        op.f("idx_app_variants_canonical_rel"), table_name="application_name_variants"
    )
    op.drop_index(
        op.f("idx_app_variants_hash_exact_match"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("idx_app_variants_hash_lookup"), table_name="application_name_variants"
    )
    op.drop_index(
        op.f("idx_app_variants_lookup_optimization"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("idx_app_variants_normalized_pattern"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("idx_app_variants_tenant_isolation"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("idx_app_variants_tenant_security"), table_name="application_name_variants"
    )
    op.drop_index(
        op.f("idx_app_variants_usage_stats"), table_name="application_name_variants"
    )
    op.drop_index(
        op.f("idx_app_variants_vector_similarity"),
        table_name="application_name_variants",
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.drop_index(
        op.f("ix_migration_application_name_variants_client_account_id"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("ix_migration_application_name_variants_engagement_id"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("ix_migration_application_name_variants_normalized_variant"),
        table_name="application_name_variants",
    )
    op.drop_index(
        op.f("ix_migration_application_name_variants_variant_hash"),
        table_name="application_name_variants",
    )
    op.drop_table("application_name_variants")
    op.drop_table("client_access")
    op.drop_index(
        op.f("ix_agent_performance_daily_agent"), table_name="agent_performance_daily"
    )
    op.drop_index(
        op.f("ix_agent_performance_daily_client"), table_name="agent_performance_daily"
    )
    op.drop_index(
        op.f("ix_agent_performance_daily_date"), table_name="agent_performance_daily"
    )
    op.drop_table("agent_performance_daily")
    op.drop_index(
        op.f("idx_asset_dependencies_asset_id"), table_name="asset_dependencies"
    )
    op.drop_index(
        op.f("idx_asset_dependencies_depends_on_asset_id"),
        table_name="asset_dependencies",
    )
    op.drop_index(op.f("idx_asset_dependencies_type"), table_name="asset_dependencies")
    op.drop_table("asset_dependencies")
    op.drop_index(
        op.f("ix_collection_gap_analysis_client_account_id"),
        table_name="collection_gap_analysis",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_collection_flow_id"),
        table_name="collection_gap_analysis",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_engagement_id"),
        table_name="collection_gap_analysis",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_id"), table_name="collection_gap_analysis"
    )
    op.drop_table("collection_gap_analysis")
    op.drop_index(
        op.f("ix_agent_discovered_patterns_agent"),
        table_name="agent_discovered_patterns",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_client"),
        table_name="agent_discovered_patterns",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_confidence"),
        table_name="agent_discovered_patterns",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_pattern_id"),
        table_name="agent_discovered_patterns",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_pattern_type"),
        table_name="agent_discovered_patterns",
    )
    op.drop_index(
        op.f("ix_agent_patterns_client_insight_type"),
        table_name="agent_discovered_patterns",
    )
    op.drop_index(
        op.f("ix_agent_patterns_insight_type"), table_name="agent_discovered_patterns"
    )
    op.drop_table("agent_discovered_patterns")
    op.drop_index(
        op.f("idx_collection_flow_apps"), table_name="collection_flow_applications"
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_canonical"),
        table_name="collection_flow_applications",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_canonical_rel"),
        table_name="collection_flow_applications",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_status"),
        table_name="collection_flow_applications",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_tenant_security"),
        table_name="collection_flow_applications",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_variant_rel"),
        table_name="collection_flow_applications",
        postgresql_where="(name_variant_id IS NOT NULL)",
    )
    op.drop_table("collection_flow_applications")
    op.drop_index(
        op.f("ix_engagement_access_engagement_id"), table_name="engagement_access"
    )
    op.drop_index(op.f("ix_engagement_access_id"), table_name="engagement_access")
    op.drop_index(
        op.f("ix_engagement_access_is_active"), table_name="engagement_access"
    )
    op.drop_index(
        op.f("ix_engagement_access_user_profile_id"), table_name="engagement_access"
    )
    op.drop_table("engagement_access")
    op.drop_table("cache_configurations", schema="migration")
    op.drop_index(
        op.f("ix_cache_perf_metadata_lookup"),
        table_name="cache_performance_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_perf_tenant_analytics"),
        table_name="cache_performance_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_perf_time_series"),
        table_name="cache_performance_logs",
        schema="migration",
    )
    op.drop_table("cache_performance_logs", schema="migration")
    op.drop_index(
        op.f("ix_user_account_associations_client_account_id"),
        table_name="user_account_associations",
    )
    op.drop_index(
        op.f("ix_user_account_associations_user_id"),
        table_name="user_account_associations",
    )
    op.drop_table("user_account_associations")
    op.drop_index(
        op.f("ix_adaptive_questionnaires_client_account_id"),
        table_name="adaptive_questionnaires",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_collection_flow_id"),
        table_name="adaptive_questionnaires",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_engagement_id"),
        table_name="adaptive_questionnaires",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_id"), table_name="adaptive_questionnaires"
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_template_type"),
        table_name="adaptive_questionnaires",
    )
    op.drop_table("adaptive_questionnaires")
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_asset_id"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_collection_flow_id"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_flow_asset"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_gap_id"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_question_category"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_questionnaire_type"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_validation_status"),
        table_name="collection_questionnaire_responses",
    )
    op.drop_table("collection_questionnaire_responses")
    op.drop_table("failure_journal")
    op.drop_table("raw_import_records")
    op.drop_index(
        op.f("ix_credential_permissions_credential_id"),
        table_name="credential_permissions",
    )
    op.drop_index(
        op.f("ix_credential_permissions_permission_type"),
        table_name="credential_permissions",
    )
    op.drop_index(
        op.f("ix_credential_permissions_role"), table_name="credential_permissions"
    )
    op.drop_index(
        op.f("ix_credential_permissions_user_id"), table_name="credential_permissions"
    )
    op.drop_table("credential_permissions")
    op.drop_index(
        op.f("ix_migration_sixr_analyses_client_account_id"), table_name="sixr_analyses"
    )
    op.drop_index(
        op.f("ix_migration_sixr_analyses_engagement_id"), table_name="sixr_analyses"
    )
    op.drop_index(op.f("ix_migration_sixr_analyses_id"), table_name="sixr_analyses")
    op.drop_index(op.f("ix_migration_sixr_analyses_name"), table_name="sixr_analyses")
    op.drop_index(
        op.f("ix_sixr_analyses_client_account_id"), table_name="sixr_analyses"
    )
    op.drop_index(op.f("ix_sixr_analyses_engagement_id"), table_name="sixr_analyses")
    op.drop_index(op.f("ix_sixr_analyses_name"), table_name="sixr_analyses")
    op.drop_index(op.f("ix_sixr_analyses_status"), table_name="sixr_analyses")
    op.drop_table("sixr_analyses")
    op.drop_table("assessments")
    op.drop_index(
        op.f("idx_access_audit_log_action_type"), table_name="access_audit_log"
    )
    op.drop_index(
        op.f("idx_access_audit_log_client_account_id"), table_name="access_audit_log"
    )
    op.drop_index(
        op.f("idx_access_audit_log_created_at"), table_name="access_audit_log"
    )
    op.drop_index(
        op.f("idx_access_audit_log_engagement_id"), table_name="access_audit_log"
    )
    op.drop_index(
        op.f("idx_access_audit_log_resource_type"), table_name="access_audit_log"
    )
    op.drop_index(op.f("idx_access_audit_log_result"), table_name="access_audit_log")
    op.drop_index(op.f("idx_access_audit_log_user_id"), table_name="access_audit_log")
    op.drop_table("access_audit_log")
    op.drop_index(op.f("idx_assets_client_engagement"), table_name="assets")
    op.drop_index(op.f("idx_assets_client_engagement_created"), table_name="assets")
    op.drop_index(op.f("idx_assets_created_at_desc"), table_name="assets")
    op.drop_index(op.f("idx_assets_status"), table_name="assets")
    op.drop_index(op.f("idx_assets_type"), table_name="assets")
    op.drop_index(op.f("ix_assets_assessment_readiness"), table_name="assets")
    op.drop_index(op.f("ix_assets_client_engagement_readiness"), table_name="assets")
    op.drop_index(op.f("ix_assets_discovery_status"), table_name="assets")
    op.drop_index(
        op.f("ix_assets_unique_hostname_per_context"),
        table_name="assets",
        postgresql_where="((hostname IS NOT NULL) AND ((hostname)::text <> ''::text))",
    )
    op.drop_index(
        op.f("ix_assets_unique_ip_per_context"),
        table_name="assets",
        postgresql_where="((ip_address IS NOT NULL) AND ((ip_address)::text <> ''::text))",
    )
    op.drop_index(
        op.f("ix_assets_unique_name_per_context"),
        table_name="assets",
        postgresql_where="((name IS NOT NULL) AND ((name)::text <> ''::text))",
    )
    op.drop_table("assets")
    op.drop_table("sixr_decisions")
    op.drop_index(
        op.f("ix_cache_metadata_access_patterns"), table_name="cache_metadata"
    )
    op.drop_index(
        op.f("ix_cache_metadata_active_keys"),
        table_name="cache_metadata",
        postgresql_where="(is_active = true)",
    )
    op.drop_index(op.f("ix_cache_metadata_cache_key"), table_name="cache_metadata")
    op.drop_index(
        op.f("ix_cache_metadata_client_account_id"), table_name="cache_metadata"
    )
    op.drop_index(op.f("ix_cache_metadata_entity_lookup"), table_name="cache_metadata")
    op.drop_index(op.f("ix_cache_metadata_expiration"), table_name="cache_metadata")
    op.drop_index(op.f("ix_cache_metadata_tenant_active"), table_name="cache_metadata")
    op.drop_table("cache_metadata")
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_automation_tier"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_collection_flow_id"),
        table_name="crewai_flow_state_extensions",
    )
    op.drop_table("crewai_flow_state_extensions")
    op.drop_index(
        op.f("ix_agent_execution_history_agent_name"),
        table_name="agent_execution_history",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_client_account_id"),
        table_name="agent_execution_history",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_composite"),
        table_name="agent_execution_history",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_created_at"),
        table_name="agent_execution_history",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_engagement_id"),
        table_name="agent_execution_history",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_task_id"), table_name="agent_execution_history"
    )
    op.drop_table("agent_execution_history")
    op.drop_index(
        op.f("ix_engagement_architecture_standards_client_account"),
        table_name="engagement_architecture_standards",
    )
    op.drop_table("engagement_architecture_standards")
    op.drop_index(
        op.f("ix_assessment_flows_current_phase"), table_name="assessment_flows"
    )
    op.drop_index(
        op.f("ix_assessment_flows_engagement_id"), table_name="assessment_flows"
    )
    op.drop_index(
        op.f("ix_assessment_flows_master_flow_id"), table_name="assessment_flows"
    )
    op.drop_index(op.f("ix_assessment_flows_next_phase"), table_name="assessment_flows")
    op.drop_index(op.f("ix_assessment_flows_status"), table_name="assessment_flows")
    op.drop_table("assessment_flows")
    op.drop_index(
        op.f("ix_migration_sixr_recommendations_id"), table_name="sixr_recommendations"
    )
    op.drop_index(
        op.f("ix_sixr_recommendations_analysis_id"), table_name="sixr_recommendations"
    )
    op.drop_table("sixr_recommendations")
    op.drop_index(
        op.f("ix_collection_data_gaps_collection_flow_id"),
        table_name="collection_data_gaps",
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_gap_category"), table_name="collection_data_gaps"
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_gap_type"), table_name="collection_data_gaps"
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_priority"), table_name="collection_data_gaps"
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_resolution_status"),
        table_name="collection_data_gaps",
    )
    op.drop_table("collection_data_gaps")
    op.drop_table("client_accounts")
    op.drop_index(
        op.f("ix_cache_metadata_access_patterns"),
        table_name="cache_metadata",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_metadata_active_keys"),
        table_name="cache_metadata",
        schema="migration",
        postgresql_where="(is_active = true)",
    )
    op.drop_index(
        op.f("ix_cache_metadata_cache_key"),
        table_name="cache_metadata",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_metadata_client_account_id"),
        table_name="cache_metadata",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_metadata_entity_lookup"),
        table_name="cache_metadata",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_metadata_expiration"),
        table_name="cache_metadata",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_cache_metadata_tenant_active"),
        table_name="cache_metadata",
        schema="migration",
    )
    op.drop_table("cache_metadata", schema="migration")
    op.drop_index(op.f("idx_analysis_queues_context"), table_name="analysis_queues")
    op.drop_table("analysis_queues")
    op.drop_index(
        op.f("ix_migration_waves_client_account_id"), table_name="migration_waves"
    )
    op.drop_index(
        op.f("ix_migration_waves_engagement_id"), table_name="migration_waves"
    )
    op.drop_index(op.f("ix_migration_waves_id"), table_name="migration_waves")
    op.drop_index(op.f("ix_migration_waves_status"), table_name="migration_waves")
    op.drop_index(op.f("ix_migration_waves_wave_number"), table_name="migration_waves")
    op.drop_table("migration_waves")
    op.drop_index(
        op.f("ix_agent_task_history_agent_name"), table_name="agent_task_history"
    )
    op.drop_index(op.f("ix_agent_task_history_client"), table_name="agent_task_history")
    op.drop_index(
        op.f("ix_agent_task_history_flow_id"), table_name="agent_task_history"
    )
    op.drop_index(op.f("ix_agent_task_history_status"), table_name="agent_task_history")
    op.drop_index(
        op.f("ix_agent_task_history_task_id"), table_name="agent_task_history"
    )
    op.drop_table("agent_task_history")
    op.drop_index(
        op.f("ix_agent_execution_history_agent_name"),
        table_name="agent_execution_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_client_account_id"),
        table_name="agent_execution_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_composite"),
        table_name="agent_execution_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_created_at"),
        table_name="agent_execution_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_engagement_id"),
        table_name="agent_execution_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_execution_history_task_id"),
        table_name="agent_execution_history",
        schema="migration",
    )
    op.drop_table("agent_execution_history", schema="migration")
    op.drop_table("pii_data_registry")
    op.drop_table("assessment_learning_feedback")
    op.drop_index(
        op.f("idx_analysis_queues_context"),
        table_name="analysis_queues",
        schema="migration",
    )
    op.drop_table("analysis_queues", schema="migration")
    op.alter_column(
        "access_audit_log",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the audit log entry.",
        existing_nullable=False,
        existing_server_default=sa.text("gen_random_uuid()"),
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "user_id",
        existing_type=sa.UUID(),
        comment="The user who performed the action or was the subject of the event.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "action_type",
        existing_type=sa.VARCHAR(length=100),
        type_=sa.String(length=50),
        comment="The type of action being logged (e.g., 'login', 'access_granted', 'resource_deleted').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "resource_type",
        existing_type=sa.VARCHAR(length=100),
        type_=sa.String(length=50),
        comment="The type of resource that was affected (e.g., 'client', 'engagement', 'user_profile').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "resource_id",
        existing_type=sa.VARCHAR(length=36),
        type_=sa.String(length=255),
        comment="The ID of the specific resource that was affected.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="The client account context in which the action occurred.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="The engagement context in which the action occurred.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "result",
        existing_type=sa.VARCHAR(length=20),
        comment="The outcome of the action (e.g., 'success', 'denied', 'error').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "reason",
        existing_type=sa.TEXT(),
        comment="A human-readable reason for the outcome (e.g., 'insufficient_permissions').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "ip_address",
        existing_type=sa.VARCHAR(length=45),
        comment="The source IP address of the request.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "user_agent",
        existing_type=sa.TEXT(),
        comment="The user agent string of the client that made the request.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "details",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob for storing any other relevant details about the event.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        comment="The timestamp when the event occurred.",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_action_type"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_client_account_id"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_created_at"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_engagement_id"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_resource_type"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_result"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_access_audit_log_user_id"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_access_audit_log_action_type"),
        "access_audit_log",
        ["action_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_access_audit_log_created_at"),
        "access_audit_log",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_access_audit_log_id"),
        "access_audit_log",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_access_audit_log_user_id"),
        "access_audit_log",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_foreign_key(
        None,
        "access_audit_log",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "access_audit_log",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "access_audit_log",
        "users",
        ["user_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_client_account_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_collection_flow_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_engagement_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_adaptive_questionnaires_template_type"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_adaptive_questionnaires_client_account_id"),
        "adaptive_questionnaires",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_adaptive_questionnaires_collection_flow_id"),
        "adaptive_questionnaires",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_adaptive_questionnaires_engagement_id"),
        "adaptive_questionnaires",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_adaptive_questionnaires_id"),
        "adaptive_questionnaires",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_adaptive_questionnaires_template_type"),
        "adaptive_questionnaires",
        ["template_type"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "pattern_type",
        existing_type=postgresql.ENUM(
            "technology_correlation",
            "business_value_indicator",
            "risk_factor",
            "modernization_opportunity",
            "dependency_pattern",
            "security_vulnerability",
            "performance_bottleneck",
            "compliance_requirement",
            "field_mapping_approval",
            "field_mapping_rejection",
            "field_mapping_suggestion",
            name="patterntype",
        ),
        type_=sa.String(length=100),
        existing_comment="Type of pattern discovered",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "embedding",
        existing_type=postgresql.ARRAY(sa.DOUBLE_PRECISION(precision=53)),
        type_=postgresql.ARRAY(sa.DECIMAL(), dimensions=1536),
        comment="Vector embedding for similarity search (OpenAI dimensions)",
        existing_comment="Vector embedding for similarity search",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_comment="When this pattern was discovered",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_comment="When this record was last updated",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_agent"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_client"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_confidence"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_pattern_id"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_discovered_patterns_pattern_type"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_patterns_client_insight_type"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_patterns_insight_type"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_discovered_patterns_client_account_id"),
        "agent_discovered_patterns",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_discovered_patterns_discovered_by_agent"),
        "agent_discovered_patterns",
        ["discovered_by_agent"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_discovered_patterns_engagement_id"),
        "agent_discovered_patterns",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_discovered_patterns_pattern_id"),
        "agent_discovered_patterns",
        ["pattern_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_discovered_patterns_pattern_type"),
        "agent_discovered_patterns",
        ["pattern_type"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_agent_discovered_patterns_engagement_id"),
        "agent_discovered_patterns",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_agent_discovered_patterns_client_account_id"),
        "agent_discovered_patterns",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_table_comment(
        "agent_discovered_patterns",
        existing_comment="Patterns discovered by agents during task execution for learning and optimization",
        schema="migration",
    )
    op.drop_column("agent_discovered_patterns", "evidence_assets", schema="migration")
    op.drop_column("agent_discovered_patterns", "validation_status", schema="migration")
    op.drop_column("agent_discovered_patterns", "supporting_data", schema="migration")
    op.alter_column(
        "agent_performance_daily",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_comment="When this record was created",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "agent_performance_daily",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_comment="When this record was last updated",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_performance_daily_agent"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_performance_daily_client"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_performance_daily_date"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_performance_daily_agent_name"),
        "agent_performance_daily",
        ["agent_name"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_performance_daily_client_account_id"),
        "agent_performance_daily",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_performance_daily_date_recorded"),
        "agent_performance_daily",
        ["date_recorded"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_performance_daily_engagement_id"),
        "agent_performance_daily",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_agent_performance_daily_client_account_id"),
        "agent_performance_daily",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_agent_performance_daily_engagement_id"),
        "agent_performance_daily",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_table_comment(
        "agent_performance_daily",
        existing_comment="Daily aggregated performance metrics for each agent",
        schema="migration",
    )
    op.alter_column(
        "agent_task_history",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_comment="When this record was created",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_task_history_agent_name"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_task_history_client"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_task_history_flow_id"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_task_history_status"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_agent_task_history_task_id"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_task_history_agent_name"),
        "agent_task_history",
        ["agent_name"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_task_history_client_account_id"),
        "agent_task_history",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_task_history_engagement_id"),
        "agent_task_history",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_task_history_flow_id"),
        "agent_task_history",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_agent_task_history_task_id"),
        "agent_task_history",
        ["task_id"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_agent_task_history_client_account_id"),
        "agent_task_history",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_agent_task_history_engagement_id"),
        "agent_task_history",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_agent_task_history_flow_id"),
        "agent_task_history",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_table_comment(
        "agent_task_history",
        existing_comment="Detailed history of all agent task executions for performance tracking and analysis",
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("requirement_type", sa.String(length=100), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column(
            "original_value", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column(
            "override_value", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("reason", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("business_justification", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("technical_justification", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("approved", sa.Boolean(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("approved_at", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column(
            "impact_assessment", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("risk_level", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column(
            "override_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.alter_column(
        "application_architecture_overrides",
        "approved_by",
        existing_type=sa.VARCHAR(length=100),
        type_=sa.String(length=255),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "application_architecture_overrides",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_application_architecture_overrides_application_id"),
        table_name="application_architecture_overrides",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_application_architecture_overrides_assessment_flow_id"),
        table_name="application_architecture_overrides",
        schema="migration",
    )
    op.drop_constraint(
        op.f("application_architecture_overrides_standard_id_fkey"),
        "application_architecture_overrides",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("application_architecture_overrides_assessment_flow_id_fkey"),
        "application_architecture_overrides",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "application_architecture_overrides",
        "assessment_flows",
        ["assessment_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_column(
        "application_architecture_overrides", "override_type", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "override_details", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "rationale", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "standard_id", schema="migration"
    )
    op.add_column(
        "application_components",
        sa.Column("assessment_flow_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("application_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("description", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("current_technology", sa.String(length=255), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("version", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column(
            "configuration", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column(
            "dependencies", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("complexity_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("business_criticality", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("technical_debt_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("migration_readiness", sa.String(length=50), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("recommended_approach", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("estimated_effort", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("assessment_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("assessment_progress", sa.Float(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("discovered_by", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column(
            "discovery_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column(
            "component_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.alter_column(
        "application_components",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "application_components",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_constraint(
        op.f("application_components_engagement_id_fkey"),
        "application_components",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "application_components",
        "assessment_flows",
        ["assessment_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_column("application_components", "engagement_id", schema="migration")
    op.drop_column("application_components", "component_config", schema="migration")
    op.add_column(
        "application_name_variants",
        sa.Column("created_at", sa.DateTime(timezone=True), nullable=False),
        schema="migration",
    )
    op.add_column(
        "application_name_variants",
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=False),
        schema="migration",
    )
    op.alter_column(
        "application_name_variants",
        "similarity_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="Cosine similarity score to canonical name embedding (0.0-1.0)",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "application_name_variants",
        "match_method",
        existing_type=sa.VARCHAR(length=50),
        nullable=False,
        comment=None,
        existing_comment="How this variant was matched: exact, fuzzy_text, vector_similarity, manual_verification",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_canonical_rel"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_hash_exact_match"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_hash_lookup"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_lookup_optimization"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_normalized_pattern"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_tenant_isolation"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_tenant_security"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_usage_stats"),
        table_name="application_name_variants",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_app_variants_vector_similarity"),
        table_name="application_name_variants",
        schema="migration",
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.create_index(
        "idx_app_variants_hash_tenant",
        "application_name_variants",
        ["variant_hash", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_unique_constraint(
        "uq_app_variants_tenant_name",
        "application_name_variants",
        ["client_account_id", "engagement_id", "normalized_variant"],
        schema="migration",
    )
    op.drop_table_comment(
        "application_name_variants",
        existing_comment="All name variations that resolve to canonical applications, with similarity metrics",
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column("description", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "phase_progress", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "configuration", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "runtime_state", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "flow_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column("last_error", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column("error_count", sa.Integer(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column("started_at", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment="Reference to master flow orchestrator for cross-phase coordination",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "current_phase",
        existing_type=sa.VARCHAR(length=100),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "progress",
        existing_type=sa.INTEGER(),
        type_=sa.Float(),
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_assessment_flows_current_phase"),
        table_name="assessment_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_assessment_flows_engagement_id"),
        table_name="assessment_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_assessment_flows_master_flow_id"),
        table_name="assessment_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_assessment_flows_next_phase"),
        table_name="assessment_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_assessment_flows_status"),
        table_name="assessment_flows",
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_assessment_flows_master_flow_id"),
        "assessment_flows",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "assessment_flows",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_column("assessment_flows", "next_phase", schema="migration")
    op.drop_column("assessment_flows", "flow_configuration", schema="migration")
    op.drop_column("assessment_flows", "flow_status", schema="migration")
    op.drop_column("assessment_flows", "architecture_captured", schema="migration")
    op.drop_column("assessment_flows", "apps_ready_for_planning", schema="migration")
    op.drop_column("assessment_flows", "user_inputs", schema="migration")
    op.drop_column("assessment_flows", "selected_application_ids", schema="migration")
    op.drop_column("assessment_flows", "last_user_interaction", schema="migration")
    op.drop_column("assessment_flows", "phase_results", schema="migration")
    op.drop_column("assessment_flows", "pause_points", schema="migration")
    op.drop_column("assessment_flows", "agent_insights", schema="migration")
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("assessment_flow_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("category", sa.String(length=100), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("source", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("title", sa.String(length=255), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("description", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("insights", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column(
            "recommendations", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column(
            "context_data", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column(
            "affected_components",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("scope", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("quality_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("impact_level", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("actionability_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("processing_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("review_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("implementation_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column(
            "recommendation_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("tags", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("reviewed_at", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.alter_column(
        "assessment_learning_feedback",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assessment_learning_feedback",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_constraint(
        op.f("assessment_learning_feedback_engagement_id_fkey"),
        "assessment_learning_feedback",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "assessment_learning_feedback",
        "assessment_flows",
        ["assessment_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_column("assessment_learning_feedback", "engagement_id", schema="migration")
    op.drop_column("assessment_learning_feedback", "feedback_data", schema="migration")
    op.add_column(
        "assessments",
        sa.Column("migration_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("asset_id", sa.UUID(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("title", sa.String(length=255), nullable=False),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("description", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("overall_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("confidence_level", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("recommended_strategy", sa.String(length=50), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("alternative_strategies", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("strategy_rationale", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("current_cost", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("estimated_migration_cost", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("estimated_target_cost", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("cost_savings_potential", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("roi_months", sa.Integer(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("identified_risks", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("risk_mitigation", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("blockers", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("dependencies_impact", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("technical_complexity", sa.String(length=20), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("compatibility_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("modernization_opportunities", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("performance_impact", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("business_criticality", sa.String(length=20), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("downtime_requirements", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("user_impact", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("compliance_considerations", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("ai_insights", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("ai_confidence", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("ai_model_version", sa.String(length=50), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("estimated_effort_hours", sa.Integer(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("estimated_duration_days", sa.Integer(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("recommended_wave", sa.Integer(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("prerequisites", sa.JSON(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("assessor", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column(
            "assessment_date",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("review_date", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("approval_date", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column(
            "created_at",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("updated_at", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assessments_client_account_id"),
        "assessments",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assessments_engagement_id"),
        "assessments",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assessments_id"),
        "assessments",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_assessments_master_flow_id_crewai_flow_state_extensions"),
        "assessments",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_assessments_client_account_id_client_accounts"),
        "assessments",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_assessments_engagement_id_engagements"),
        "assessments",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "assessments",
        "assets",
        ["asset_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "assessments",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "assessments",
        "migrations",
        ["migration_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "assessments",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.drop_column("assessments", "summary", schema="migration")
    op.drop_column("assessments", "recommendations", schema="migration")
    op.drop_column("assessments", "master_flow_id", schema="migration")
    op.drop_column("assessments", "report_url", schema="migration")
    op.alter_column(
        "asset_dependencies",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the dependency relationship.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "asset_id",
        existing_type=sa.UUID(),
        comment="The asset that has the dependency.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "depends_on_asset_id",
        existing_type=sa.UUID(),
        comment="The asset that is being depended upon.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "dependency_type",
        existing_type=sa.VARCHAR(),
        nullable=False,
        comment="The type of dependency (e.g., 'database', 'application', 'storage').",
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "description",
        existing_type=sa.TEXT(),
        comment="A description of the dependency relationship.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        comment="Timestamp of when the dependency was recorded.",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("idx_asset_dependencies_asset_id"),
        table_name="asset_dependencies",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_asset_dependencies_depends_on_asset_id"),
        table_name="asset_dependencies",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_asset_dependencies_type"),
        table_name="asset_dependencies",
        schema="migration",
    )
    op.drop_constraint(
        op.f("uq_asset_dependencies_asset_depends_on"),
        "asset_dependencies",
        schema="migration",
        type_="unique",
    )
    op.drop_column("asset_dependencies", "updated_at", schema="migration")
    op.alter_column(
        "assets",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the asset.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the client account this asset belongs to.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the engagement this asset is part of.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "flow_id",
        existing_type=sa.UUID(),
        comment="Legacy field linking to a discovery flow. Use master_flow_id for new logic.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_id",
        existing_type=sa.UUID(),
        comment="Identifier for a specific migration activity this asset is involved in.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment="The master flow ID that is currently processing this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_flow_id",
        existing_type=sa.UUID(),
        comment="The specific discovery flow that created or updated this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_flow_id",
        existing_type=sa.UUID(),
        comment="The assessment flow that analyzed this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "planning_flow_id",
        existing_type=sa.UUID(),
        comment="The planning flow that has included this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "execution_flow_id",
        existing_type=sa.UUID(),
        comment="The execution flow that is migrating this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "source_phase",
        existing_type=sa.VARCHAR(length=50),
        comment="The phase in which the asset was originally created (e.g., 'discovery').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "current_phase",
        existing_type=sa.VARCHAR(length=50),
        comment="The current workflow phase this asset is in (e.g., 'assessment', 'planning').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "phase_context",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob for storing phase-specific data or state about the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment="The primary name of the asset.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "asset_name",
        existing_type=sa.VARCHAR(length=255),
        comment="Alternative or display name for the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "hostname",
        existing_type=sa.VARCHAR(length=255),
        comment="The hostname of the asset, if applicable.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "asset_type",
        existing_type=sa.VARCHAR(length=50),
        comment="The type of the asset, from the AssetType enum (e.g., 'server', 'database').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "description",
        existing_type=sa.TEXT(),
        comment="A detailed description of the asset and its function.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "ip_address",
        existing_type=sa.VARCHAR(length=45),
        comment="The primary IP address of the asset (supports IPv6).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "fqdn",
        existing_type=sa.VARCHAR(length=255),
        comment="The fully qualified domain name of the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "mac_address",
        existing_type=sa.VARCHAR(length=17),
        comment="The MAC address of the asset's primary network interface.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "environment",
        existing_type=sa.VARCHAR(length=50),
        comment="The operational environment (e.g., 'Production', 'Development', 'Test').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "location",
        existing_type=sa.VARCHAR(length=100),
        comment="The geographical location or region of the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "datacenter",
        existing_type=sa.VARCHAR(length=100),
        comment="The datacenter where the asset is hosted.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "rack_location",
        existing_type=sa.VARCHAR(length=50),
        comment="The specific rack location within the datacenter.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "availability_zone",
        existing_type=sa.VARCHAR(length=50),
        comment="The cloud availability zone, if applicable.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "operating_system",
        existing_type=sa.VARCHAR(length=100),
        comment="The operating system running on the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "os_version",
        existing_type=sa.VARCHAR(length=50),
        comment="The version of the operating system.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "cpu_cores",
        existing_type=sa.INTEGER(),
        comment="The number of CPU cores allocated to the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "memory_gb",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The amount of RAM in gigabytes allocated to the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "storage_gb",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The total storage in gigabytes allocated to the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "business_owner",
        existing_type=sa.VARCHAR(length=255),
        comment="The name of the business owner or department responsible for the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "technical_owner",
        existing_type=sa.VARCHAR(length=255),
        comment="The name of the technical owner or team responsible for the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "department",
        existing_type=sa.VARCHAR(length=100),
        comment="The business department or unit that uses this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "application_name",
        existing_type=sa.VARCHAR(length=255),
        comment="The primary application or service this asset supports.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "technology_stack",
        existing_type=sa.VARCHAR(length=255),
        comment="A summary of the technology stack running on the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "criticality",
        existing_type=sa.VARCHAR(length=20),
        comment="The technical criticality of the asset (e.g., 'Low', 'Medium', 'High').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "business_criticality",
        existing_type=sa.VARCHAR(length=20),
        comment="The business impact or criticality of the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "custom_attributes",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob for storing any custom fields or attributes not in the standard schema.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "six_r_strategy",
        existing_type=sa.VARCHAR(length=50),
        comment="The recommended 6R migration strategy (e.g., 'Rehost', 'Refactor').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "mapping_status",
        existing_type=sa.VARCHAR(length=20),
        comment="The status of the asset's field mapping during import.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_priority",
        existing_type=sa.INTEGER(),
        comment="A priority score (1-10) for migrating this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_complexity",
        existing_type=sa.VARCHAR(length=20),
        comment="The assessed complexity of migrating this asset (e.g., 'Low', 'Medium', 'High').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_wave",
        existing_type=sa.INTEGER(),
        comment="The migration wave this asset is assigned to.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "sixr_ready",
        existing_type=sa.VARCHAR(length=50),
        comment="Indicates if the asset is ready for 6R analysis (e.g., 'Ready', 'Needs Analysis').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "status",
        existing_type=sa.VARCHAR(length=50),
        comment="The operational status of the asset (e.g., 'active', 'decommissioned', 'maintenance').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_status",
        existing_type=sa.VARCHAR(length=50),
        comment="The status of the asset within the migration lifecycle (e.g., 'discovered', 'assessed', 'migrated').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "dependencies",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON array of assets that this asset depends on.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "related_assets",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON array of other related assets or CIs.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_method",
        existing_type=sa.VARCHAR(length=50),
        comment="How the asset was discovered (e.g., 'network_scan', 'agent', 'import').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_source",
        existing_type=sa.VARCHAR(length=100),
        comment="The specific tool or system that discovered the asset (e.g., 'ServiceNow', 'Azure Migrate').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_timestamp",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the asset was last discovered or updated.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "cpu_utilization_percent",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The average CPU utilization percentage.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "memory_utilization_percent",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The average memory utilization percentage.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "disk_iops",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The average disk Input/Output Operations Per Second.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "network_throughput_mbps",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The average network throughput in megabits per second.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "completeness_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="A score indicating how complete the asset's data is.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "quality_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="An overall data quality score for the asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "current_monthly_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The estimated current monthly cost of running the asset on-premises.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "estimated_cloud_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The estimated monthly cost of running the asset in the cloud.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "imported_by",
        existing_type=sa.UUID(),
        comment="The user who imported the data that created this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "imported_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the asset was imported.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "source_filename",
        existing_type=sa.VARCHAR(length=255),
        comment="The original filename from which this asset was imported.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "raw_data",
        existing_type=sa.TEXT(),
        type_=sa.JSON(),
        comment="A JSON blob of the original, raw data for this asset from the import source.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "field_mappings_used",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="The specific field mappings that were applied to create this asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "raw_import_records_id",
        existing_type=sa.UUID(),
        comment="The raw import record this asset was created from.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_status",
        existing_type=sa.VARCHAR(length=50),
        comment="Discovery lifecycle status for this asset (e.g., 'completed').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_completed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when discovery completed for this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_readiness",
        existing_type=sa.VARCHAR(length=50),
        comment="Assessment readiness status for this asset (e.g., 'ready', 'not_ready').",
        existing_nullable=True,
        existing_server_default=sa.text("'not_ready'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_readiness_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="Optional readiness score (0-100 or 0-1 depending on configuration).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_blockers",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="List of identified blockers preventing assessment readiness.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_recommendations",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="List of recommendations to achieve assessment readiness.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the asset record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assets",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "created_by",
        existing_type=sa.UUID(),
        comment="The user who originally created this asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "updated_by",
        existing_type=sa.UUID(),
        comment="The user who last updated this asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("idx_assets_client_engagement"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("idx_assets_client_engagement_created"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_assets_created_at_desc"), table_name="assets", schema="migration"
    )
    op.drop_index(op.f("idx_assets_status"), table_name="assets", schema="migration")
    op.drop_index(op.f("idx_assets_type"), table_name="assets", schema="migration")
    op.drop_index(
        op.f("ix_assets_assessment_readiness"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_assets_client_engagement_readiness"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_assets_discovery_status"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_assets_unique_hostname_per_context"),
        table_name="assets",
        schema="migration",
        postgresql_where="((hostname IS NOT NULL) AND ((hostname)::text <> ''::text))",
    )
    op.drop_index(
        op.f("ix_assets_unique_ip_per_context"),
        table_name="assets",
        schema="migration",
        postgresql_where="((ip_address IS NOT NULL) AND ((ip_address)::text <> ''::text))",
    )
    op.drop_index(
        op.f("ix_assets_unique_name_per_context"),
        table_name="assets",
        schema="migration",
        postgresql_where="((name IS NOT NULL) AND ((name)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_migration_assets_assessment_flow_id"),
        "assets",
        ["assessment_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_assessment_readiness"),
        "assets",
        ["assessment_readiness"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_asset_type"),
        "assets",
        ["asset_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_client_account_id"),
        "assets",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_current_phase"),
        "assets",
        ["current_phase"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_discovery_flow_id"),
        "assets",
        ["discovery_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_discovery_status"),
        "assets",
        ["discovery_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_engagement_id"),
        "assets",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_environment"),
        "assets",
        ["environment"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_execution_flow_id"),
        "assets",
        ["execution_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_flow_id"),
        "assets",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_hostname"),
        "assets",
        ["hostname"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_id"),
        "assets",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_mapping_status"),
        "assets",
        ["mapping_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_master_flow_id"),
        "assets",
        ["master_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_migration_status"),
        "assets",
        ["migration_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_name"),
        "assets",
        ["name"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_planning_flow_id"),
        "assets",
        ["planning_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_source_phase"),
        "assets",
        ["source_phase"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_assets_status"),
        "assets",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_assets_engagement_id_engagements"),
        "assets",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_assets_client_account_id_client_accounts"),
        "assets",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "assets",
        "users",
        ["created_by"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "assets",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "assets",
        "users",
        ["updated_by"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "assets",
        "users",
        ["imported_by"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "assets",
        "migrations",
        ["migration_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "assets",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "assets",
        "discovery_flows",
        ["flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.alter_column(
        "canonical_applications",
        "canonical_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The authoritative, human-readable name for this application",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "normalized_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="Lowercase, trimmed, special-char-removed version for exact matching",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "name_hash",
        existing_type=sa.VARCHAR(length=64),
        comment=None,
        existing_comment="SHA-256 hash of normalized_name for fast lookups",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "name_embedding",
        existing_type=pgvector.sqlalchemy.vector.VECTOR(dim=384),
        comment="Vector embedding for semantic similarity search",
        existing_comment="Vector embedding of canonical_name for fuzzy similarity search (384-dim sentence-transformers)",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "confidence_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="Confidence in canonical name accuracy (0.0-1.0, higher = more confident)",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_dedup_workflow"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_fulltext_search"),
        table_name="canonical_applications",
        schema="migration",
        postgresql_using="gin",
    )
    op.drop_index(
        op.f("idx_canonical_apps_hash_exact_match"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_hash_lookup"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_high_usage_only"),
        table_name="canonical_applications",
        schema="migration",
        postgresql_where="(usage_count >= 5)",
    )
    op.drop_index(
        op.f("idx_canonical_apps_normalized_pattern"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_quality_assessment"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_tenant_isolation"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_tenant_search_ranked"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_tenant_security"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_unverified_only"),
        table_name="canonical_applications",
        schema="migration",
        postgresql_where="(is_verified = false)",
    )
    op.drop_index(
        op.f("idx_canonical_apps_usage"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_vector_similarity"),
        table_name="canonical_applications",
        schema="migration",
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.drop_index(
        op.f("idx_canonical_apps_verification"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_canonical_apps_usage_stats"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.create_index(
        "idx_canonical_apps_usage_stats",
        "canonical_applications",
        ["usage_count", "last_used_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        "idx_canonical_apps_hash_tenant",
        "canonical_applications",
        ["name_hash", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_canonical_applications_canonical_name"),
        "canonical_applications",
        ["canonical_name"],
        unique=False,
        schema="migration",
    )
    op.create_unique_constraint(
        "uq_canonical_apps_tenant_name",
        "canonical_applications",
        ["client_account_id", "engagement_id", "normalized_name"],
        schema="migration",
    )
    op.drop_table_comment(
        "canonical_applications",
        existing_comment="Master registry of canonical application names with multi-tenant isolation and deduplication",
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the client access record.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "user_profile_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the user's profile.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the client account being accessed.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "access_level",
        existing_type=sa.VARCHAR(length=20),
        comment="The general access level for the user within this client (e.g., 'admin', 'read_only').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "permissions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob for fine-grained permission overrides specific to this client.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_import_data": false, "can_export_data": false, "can_manage_engagements": false, "can_configure_client_settings": false, "can_manage_client_users": false}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "restricted_environments",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A list of environments (e.g., 'production') within this client the user CANNOT access.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "restricted_data_types",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A list of data types (e.g., 'financial') within this client the user CANNOT access.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when access was granted.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "granted_by",
        existing_type=sa.UUID(),
        comment="The user ID of the admin who granted this access.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="An optional expiration date for time-bound access.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment="A flag to enable or disable this access record without deleting it.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "last_accessed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last time the user accessed resources in this client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "access_count",
        existing_type=sa.INTEGER(),
        comment="A counter for how many times the user has accessed this client's resources.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the access record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the access record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_client_access_client_account_id"),
        "client_access",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_client_access_id"),
        "client_access",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_client_access_is_active"),
        "client_access",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_client_access_user_profile_id"),
        "client_access",
        ["user_profile_id"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_client_access_user_profile_id_user_profiles"),
        "client_access",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_client_access_client_account_id_client_accounts"),
        "client_access",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "client_access",
        "user_profiles",
        ["user_profile_id"],
        ["user_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "client_access",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.alter_column(
        "client_accounts",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the client account.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment="The official name of the client company.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "slug",
        existing_type=sa.VARCHAR(length=100),
        comment="A URL-friendly slug for the client account, used for identification.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "description",
        existing_type=sa.TEXT(),
        comment="A detailed description of the client account and their business.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "industry",
        existing_type=sa.VARCHAR(length=100),
        comment="The industry vertical of the client (e.g., Finance, Healthcare).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "company_size",
        existing_type=sa.VARCHAR(length=50),
        comment="The approximate size of the client's company (e.g., '1-50', '50-200').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "headquarters_location",
        existing_type=sa.VARCHAR(length=255),
        comment="The geographical location of the client's headquarters.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "primary_contact_name",
        existing_type=sa.VARCHAR(length=255),
        comment="The name of the main point of contact at the client company.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "primary_contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment="The email address of the main point of contact. Considered PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "primary_contact_phone",
        existing_type=sa.VARCHAR(length=50),
        comment="The phone number for the main point of contact.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment="A general contact email for the client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "contact_phone",
        existing_type=sa.VARCHAR(length=50),
        comment="A general contact phone number for the client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "address",
        existing_type=sa.TEXT(),
        comment="The physical mailing address of the client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "timezone",
        existing_type=sa.VARCHAR(length=50),
        comment="The primary timezone for the client to assist in scheduling and timestamps.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "subscription_tier",
        existing_type=sa.VARCHAR(length=50),
        comment="The subscription level for the client (e.g., 'free', 'standard', 'enterprise').",
        existing_nullable=True,
        existing_server_default=sa.text("'standard'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "billing_contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment="The email address for sending billing-related communications. Considered PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "subscription_start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The date when the client's current subscription term began.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "subscription_end_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The date when the client's current subscription term ends.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "max_users",
        existing_type=sa.INTEGER(),
        comment="The maximum number of users allowed under the current subscription.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "max_engagements",
        existing_type=sa.INTEGER(),
        comment="The maximum number of concurrent engagements allowed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "features_enabled",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob to toggle specific features for this client (feature flags).",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "agent_configuration",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Custom configuration for CrewAI agents specific to this client.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "storage_quota_gb",
        existing_type=sa.INTEGER(),
        comment="The total data storage quota in gigabytes allocated to this client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "api_quota_monthly",
        existing_type=sa.INTEGER(),
        comment="The monthly API request quota for this client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "settings",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="General-purpose settings for the client account as a JSON blob.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "branding",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Client-specific branding information, such as logos and colors, for UI customization.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "business_objectives",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Stores the client's strategic business goals and success criteria for migrations.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"primary_goals": [], "timeframe": "", "success_metrics": [], "constraints": []}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "it_guidelines",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Client's internal IT policies, standards, and guidelines for technology adoption.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "decision_criteria",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="The criteria the client uses to make migration decisions (e.g., cost, performance, security).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "agent_preferences",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Client-specific preferences for how the AI agents should operate during analysis.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"discovery_depth": "comprehensive", "automation_level": "assisted", "risk_tolerance": "moderate", "preferred_clouds": [], "compliance_requirements": [], "custom_rules": []}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the client account was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the client account record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "created_by",
        existing_type=sa.UUID(),
        comment="The user ID of the user who created this client account.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment="A soft-delete flag. If false, the account is considered inactive.",
        existing_nullable=False,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.drop_constraint(
        op.f("uq_client_accounts_slug"),
        "client_accounts",
        schema="migration",
        type_="unique",
    )
    op.create_index(
        op.f("ix_migration_client_accounts_id"),
        "client_accounts",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_client_accounts_is_active"),
        "client_accounts",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_client_accounts_slug"),
        "client_accounts",
        ["slug"],
        unique=True,
        schema="migration",
    )
    op.drop_column("client_accounts", "data_retention_days", schema="migration")
    op.drop_column("client_accounts", "pii_data_consent", schema="migration")
    op.drop_column("client_accounts", "pii_consent_date", schema="migration")
    op.drop_index(
        op.f("ix_collected_data_inventory_collection_flow_id"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_credential_id"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_data_type"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_platform"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collected_data_inventory_validation_status"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collected_data_inventory_collection_flow_id"),
        "collected_data_inventory",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collected_data_inventory_data_type"),
        "collected_data_inventory",
        ["data_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collected_data_inventory_platform"),
        "collected_data_inventory",
        ["platform"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collected_data_inventory_validation_status"),
        "collected_data_inventory",
        ["validation_status"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_collected_data_inventory_credential_id_platform_credentials"),
        "collected_data_inventory",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_column("collected_data_inventory", "credential_id", schema="migration")
    op.drop_index(
        op.f("ix_collection_data_gaps_collection_flow_id"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_gap_category"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_gap_type"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_priority"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_data_gaps_resolution_status"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_data_gaps_collection_flow_id"),
        "collection_data_gaps",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_data_gaps_gap_category"),
        "collection_data_gaps",
        ["gap_category"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_data_gaps_gap_type"),
        "collection_data_gaps",
        ["gap_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_data_gaps_priority"),
        "collection_data_gaps",
        ["priority"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_data_gaps_resolution_status"),
        "collection_data_gaps",
        ["resolution_status"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flow_applications",
        "discovery_data_snapshot",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Snapshot of Discovery data at the time of Collection flow creation",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flow_applications",
        "gap_analysis_result",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Result of gap analysis for this specific application",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flow_applications",
        "collection_status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="Status of data collection for this application: pending, in_progress, completed, failed",
        existing_nullable=False,
        existing_server_default=sa.text("'pending'::character varying"),
        schema="migration",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps"),
        table_name="collection_flow_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_canonical"),
        table_name="collection_flow_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_canonical_rel"),
        table_name="collection_flow_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_status"),
        table_name="collection_flow_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_tenant_security"),
        table_name="collection_flow_applications",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_collection_flow_apps_variant_rel"),
        table_name="collection_flow_applications",
        schema="migration",
        postgresql_where="(name_variant_id IS NOT NULL)",
    )
    op.drop_constraint(
        op.f("collection_flow_applications_collection_flow_id_fkey"),
        "collection_flow_applications",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("collection_flow_applications_asset_id_fkey"),
        "collection_flow_applications",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_table_comment(
        "collection_flow_applications",
        existing_comment="Links Collection flows to selected applications from Discovery, tracking per-app collection status",
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "pause_points",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "user_inputs",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "phase_results",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "agent_insights",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "collected_platforms",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "collection_results",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "gap_analysis_results",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "assessment_ready",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "apps_ready_for_assessment",
        existing_type=sa.INTEGER(),
        nullable=False,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "last_user_interaction",
        existing_type=postgresql.TIMESTAMP(),
        type_=sa.DateTime(timezone=True),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_automation_tier"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_client_account_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_engagement_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_flow_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_master_flow_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_flows_status"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_constraint(
        op.f("uq_collection_flows_flow_id"),
        "collection_flows",
        schema="migration",
        type_="unique",
    )
    op.create_index(
        op.f("ix_migration_collection_flows_automation_tier"),
        "collection_flows",
        ["automation_tier"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_flows_client_account_id"),
        "collection_flows",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_flows_engagement_id"),
        "collection_flows",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_flows_flow_id"),
        "collection_flows",
        ["flow_id"],
        unique=True,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_flows_master_flow_id"),
        "collection_flows",
        ["master_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_flows_status"),
        "collection_flows",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_client_account_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_collection_flow_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_engagement_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_gap_analysis_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_gap_analysis_client_account_id"),
        "collection_gap_analysis",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_gap_analysis_collection_flow_id"),
        "collection_gap_analysis",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_gap_analysis_engagement_id"),
        "collection_gap_analysis",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_gap_analysis_id"),
        "collection_gap_analysis",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_asset_id"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_collection_flow_id"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_flow_asset"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_gap_id"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_question_category"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_questionnaire_type"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_collection_questionnaire_responses_validation_status"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_questionnaire_responses_asset_id"),
        "collection_questionnaire_responses",
        ["asset_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_questionnaire_responses_collection_flow_id"),
        "collection_questionnaire_responses",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_questionnaire_responses_gap_id"),
        "collection_questionnaire_responses",
        ["gap_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_questionnaire_responses_questionnaire_type"),
        "collection_questionnaire_responses",
        ["questionnaire_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_questionnaire_responses_question_category"),
        "collection_questionnaire_responses",
        ["question_category"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_collection_questionnaire_responses_validation_status"),
        "collection_questionnaire_responses",
        ["validation_status"],
        unique=False,
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("assessment_flow_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("strategy", sa.String(length=100), nullable=False),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("approach", sa.String(length=255), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("analysis", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("reasoning", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "assumptions", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("confidence_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "risk_assessment", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("risk_level", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "implementation_plan",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "prerequisites", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "success_criteria", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("estimated_effort", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("estimated_duration", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "complexity_factors",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "dependencies", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("execution_order", sa.Integer(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("parallel_execution", sa.Boolean(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column("progress", sa.Float(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "task_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.alter_column(
        "component_treatments",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "component_treatments",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.create_foreign_key(
        None,
        "component_treatments",
        "assessment_flows",
        ["assessment_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_column("component_treatments", "treatment_config", schema="migration")
    op.drop_index(
        op.f("ix_credential_access_logs_access_type"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_accessed_at"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_accessed_by"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_credential_id"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_access_logs_success"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_access_logs_access_type"),
        "credential_access_logs",
        ["access_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_access_logs_accessed_at"),
        "credential_access_logs",
        ["accessed_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_access_logs_accessed_by"),
        "credential_access_logs",
        ["accessed_by"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_access_logs_credential_id"),
        "credential_access_logs",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_access_logs_success"),
        "credential_access_logs",
        ["success"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_permissions_credential_id"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_permissions_permission_type"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_permissions_role"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_permissions_user_id"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_permissions_credential_id"),
        "credential_permissions",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_permissions_permission_type"),
        "credential_permissions",
        ["permission_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_permissions_role"),
        "credential_permissions",
        ["role"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_permissions_user_id"),
        "credential_permissions",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_rotation_history_credential_id"),
        table_name="credential_rotation_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_rotation_history_rotated_at"),
        table_name="credential_rotation_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_credential_rotation_history_rotation_type"),
        table_name="credential_rotation_history",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_rotation_history_credential_id"),
        "credential_rotation_history",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_rotation_history_rotated_at"),
        "credential_rotation_history",
        ["rotated_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_credential_rotation_history_rotation_type"),
        "credential_rotation_history",
        ["rotation_type"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "id",
        existing_type=sa.UUID(),
        comment="Internal primary key for the database record.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_id",
        existing_type=sa.UUID(),
        comment="The unique identifier for a specific CrewAI flow instance. This is the main public ID.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the client account this flow belongs to.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the engagement this flow is part of.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "user_id",
        existing_type=sa.VARCHAR(length=255),
        comment="The user ID of the person who initiated the flow.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_type",
        existing_type=sa.VARCHAR(length=50),
        comment="The type of the flow (e.g., 'discovery', 'assessment', 'planning').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_name",
        existing_type=sa.VARCHAR(length=255),
        comment="A user-friendly name for this flow instance.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_status",
        existing_type=sa.VARCHAR(length=50),
        comment="The current status of the flow (e.g., 'running', 'paused', 'completed', 'failed').",
        existing_nullable=False,
        existing_server_default=sa.text("'initialized'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_configuration",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="The initial configuration and parameters the flow was started with.",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_persistence_data",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A JSON blob containing the complete state of the flow, allowing it to be paused and resumed.",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "agent_collaboration_log",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A log of significant interactions between agents within the crew.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "memory_usage_metrics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Metrics related to the memory consumption of the agents and tools.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "knowledge_base_analytics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Analytics on how the knowledge base was accessed and utilized during the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "phase_execution_times",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A JSON object storing the execution time for each phase of the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "agent_performance_metrics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Performance metrics for individual agents, such as task completion time and token usage.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "crew_coordination_analytics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Analytics on the overall coordination and efficiency of the crew.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "learning_patterns",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Patterns and insights learned by the agents during the flow execution.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "user_feedback_history",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A log of feedback provided by users at various stages of the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "adaptation_metrics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Metrics that track how the crew adapts its behavior based on feedback and learning.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "phase_transitions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="An audit log of all phase transitions (e.g., from 'data_cleansing' to 'asset_inventory').",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "error_history",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A log of all errors that occurred during the flow execution.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "retry_count",
        existing_type=sa.INTEGER(),
        comment="The number of times the flow or a specific phase has been retried after a failure.",
        existing_nullable=False,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "parent_flow_id",
        existing_type=sa.UUID(),
        comment="If this is a sub-flow, this links to the parent flow's ID.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "child_flow_ids",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A list of flow IDs for any sub-flows spawned by this flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_metadata",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="A flexible JSON blob for storing any other metadata related to the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the flow record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to this flow record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_automation_tier"),
        table_name="crewai_flow_state_extensions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_crewai_flow_state_extensions_collection_flow_id"),
        table_name="crewai_flow_state_extensions",
        schema="migration",
    )
    op.drop_constraint(
        op.f("uq_crewai_flow_state_extensions_flow_id"),
        "crewai_flow_state_extensions",
        schema="migration",
        type_="unique",
    )
    op.create_index(
        op.f("ix_migration_crewai_flow_state_extensions_client_account_id"),
        "crewai_flow_state_extensions",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_crewai_flow_state_extensions_engagement_id"),
        "crewai_flow_state_extensions",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_crewai_flow_state_extensions_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        unique=True,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_crewai_flow_state_extensions_engagement_id_engagements"),
        "crewai_flow_state_extensions",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_crewai_flow_state_parent"),
        "crewai_flow_state_extensions",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_crewai_flow_ext_collection_flow_id"),
        "crewai_flow_state_extensions",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_crewai_flow_state_extensions_client_account_id_clien_8877"),
        "crewai_flow_state_extensions",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "crewai_flow_state_extensions",
        "crewai_flow_state_extensions",
        ["parent_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="SET NULL",
    )
    op.drop_column(
        "crewai_flow_state_extensions", "collection_flow_id", schema="migration"
    )
    op.drop_column(
        "crewai_flow_state_extensions", "data_collection_metadata", schema="migration"
    )
    op.drop_column(
        "crewai_flow_state_extensions", "automation_tier", schema="migration"
    )
    op.drop_column(
        "crewai_flow_state_extensions", "collection_quality_score", schema="migration"
    )
    op.alter_column(
        "data_imports",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the data import job.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="The client account this import belongs to.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="The engagement this import is associated with.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment="The master flow ID that was initiated by this data import.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "import_name",
        existing_type=sa.VARCHAR(length=255),
        comment="A user-defined name for the import job for easy identification.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "import_type",
        existing_type=sa.VARCHAR(length=50),
        comment="The type of data being imported (e.g., 'cmdb', 'asset_inventory').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "description",
        existing_type=sa.TEXT(),
        comment="A detailed description of the data import's purpose or contents.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "filename",
        existing_type=sa.VARCHAR(length=255),
        comment="The original name of the imported file.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "file_size",
        existing_type=sa.INTEGER(),
        comment="The size of the imported file in bytes.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "mime_type",
        existing_type=sa.VARCHAR(length=100),
        comment="The MIME type of the imported file (e.g., 'text/csv').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "source_system",
        existing_type=sa.VARCHAR(length=100),
        comment="The system from which the data was exported (e.g., 'ServiceNow', 'Jira').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "status",
        existing_type=sa.VARCHAR(length=20),
        comment="The current status of the import job (e.g., 'pending', 'processing', 'completed', 'failed').",
        existing_nullable=False,
        existing_server_default=sa.text("'pending'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "progress_percentage",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The completion percentage of the import job.",
        existing_nullable=True,
        existing_server_default=sa.text("'0'::double precision"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "total_records",
        existing_type=sa.INTEGER(),
        comment="The total number of records detected in the source file.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "processed_records",
        existing_type=sa.INTEGER(),
        comment="The number of records successfully processed so far.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "failed_records",
        existing_type=sa.INTEGER(),
        comment="The number of records that failed processing.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "imported_by",
        existing_type=sa.UUID(),
        comment="The user ID of the person who initiated the import.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "error_message",
        existing_type=sa.TEXT(),
        comment="A summary of the error if the import job failed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "error_details",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob containing detailed error information, such as stack traces.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "started_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the import job processing began.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "completed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the import job finished (either completed or failed).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the import record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to this record.",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_data_imports_master_flow_id_crewai_flow_state_extensions"),
        "data_imports",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_data_imports_engagement_id_engagements"),
        "data_imports",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_data_imports_client_account_id_client_accounts"),
        "data_imports",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "data_imports",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "data_imports",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "data_imports",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_table_comment(
        "data_imports",
        "Tracks data import jobs, their status, and metadata within a multi-tenant environment.",
        existing_comment=None,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_discovery_flows_client_account_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_discovery_flows_data_import_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_discovery_flows_engagement_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_discovery_flows_flow_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_discovery_flows_id"), table_name="discovery_flows", schema="migration"
    )
    op.drop_index(
        op.f("ix_discovery_flows_master_flow_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_discovery_flows_status"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_constraint(
        op.f("uq_discovery_flows_flow_id"),
        "discovery_flows",
        schema="migration",
        type_="unique",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_client_account_id"),
        "discovery_flows",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_data_import_id"),
        "discovery_flows",
        ["data_import_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_engagement_id"),
        "discovery_flows",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_flow_id"),
        "discovery_flows",
        ["flow_id"],
        unique=True,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_id"),
        "discovery_flows",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_master_flow_id"),
        "discovery_flows",
        ["master_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_discovery_flows_status"),
        "discovery_flows",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the engagement access record.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "user_profile_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the user's profile.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the engagement being accessed.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "access_level",
        existing_type=sa.VARCHAR(length=20),
        comment="The general access level for the user within this engagement.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "engagement_role",
        existing_type=sa.VARCHAR(length=100),
        comment="A descriptive role for the user in this engagement (e.g., 'Project Manager', 'Lead Analyst').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "permissions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob for fine-grained permission overrides specific to this engagement.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_import_data": false, "can_export_data": false, "can_manage_sessions": false, "can_configure_agents": false, "can_approve_migration_decisions": false, "can_access_sensitive_data": false}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "restricted_sessions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A list of specific session IDs within this engagement that the user is barred from accessing.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::json"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "allowed_session_types",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A whitelist of session types the user is allowed to interact with.",
        existing_nullable=True,
        existing_server_default=sa.text('\'["data_import", "validation_run"]\'::json'),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when engagement access was granted.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "granted_by",
        existing_type=sa.UUID(),
        comment="The user ID of the admin who granted this access.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="An optional expiration date for time-bound access.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment="A flag to enable or disable this access record without deleting it.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "last_accessed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last time the user accessed this engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "access_count",
        existing_type=sa.INTEGER(),
        comment="A counter for how many times the user has accessed this engagement.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the access record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the access record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_engagement_access_engagement_id"),
        table_name="engagement_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_engagement_access_id"),
        table_name="engagement_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_engagement_access_is_active"),
        table_name="engagement_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_engagement_access_user_profile_id"),
        table_name="engagement_access",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagement_access_engagement_id"),
        "engagement_access",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagement_access_id"),
        "engagement_access",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagement_access_is_active"),
        "engagement_access",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagement_access_user_profile_id"),
        "engagement_access",
        ["user_profile_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_architecture_standards",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Client account for multi-tenant isolation",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_architecture_standards",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_architecture_standards",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_engagement_architecture_standards_client_account"),
        table_name="engagement_architecture_standards",
        schema="migration",
    )
    op.create_unique_constraint(
        "unique_engagement_standard",
        "engagement_architecture_standards",
        ["engagement_id", "requirement_type", "standard_name"],
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_engagement_architecture_standards_client_account"),
        "engagement_architecture_standards",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("engagement_architecture_standards_engagement_id_fkey"),
        "engagement_architecture_standards",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "engagement_architecture_standards",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "engagement_architecture_standards",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "engagements",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the engagement.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Foreign key linking this engagement to its parent client account.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment="The official name of the engagement (e.g., 'US-East Datacenter Migration').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "slug",
        existing_type=sa.VARCHAR(length=100),
        comment="A URL-friendly slug for the engagement.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "description",
        existing_type=sa.TEXT(),
        comment="A detailed description of the engagement's goals and scope.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "engagement_type",
        existing_type=sa.VARCHAR(length=50),
        comment="The type of engagement (e.g., 'migration', 'discovery', 'assessment').",
        existing_nullable=True,
        existing_server_default=sa.text("'migration'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "status",
        existing_type=sa.VARCHAR(length=50),
        comment="The current status of the engagement (e.g., 'planning', 'active', 'completed', 'on-hold').",
        existing_nullable=True,
        existing_server_default=sa.text("'active'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "priority",
        existing_type=sa.VARCHAR(length=20),
        comment="The priority of the engagement (e.g., 'low', 'medium', 'high').",
        existing_nullable=True,
        existing_server_default=sa.text("'medium'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The official start date of the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "target_completion_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The planned completion date for the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "actual_completion_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The actual date the engagement was completed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "engagement_lead_id",
        existing_type=sa.UUID(),
        comment="The user ID of the person leading the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "client_contact_name",
        existing_type=sa.VARCHAR(length=255),
        comment="The name of the primary contact on the client's side for this engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "client_contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment="The email of the primary client contact for this engagement. Considered PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "settings",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob for any engagement-specific settings.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "migration_scope",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Defines the scope of the migration, including targets, strategies, and exclusions.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"target_clouds": [], "migration_strategies": [], "excluded_systems": [], "included_environments": [], "business_units": [], "geographic_scope": [], "timeline_constraints": {}}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "team_preferences",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="Stores preferences for team collaboration and communication styles for this engagement.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"stakeholders": [], "decision_makers": [], "technical_leads": [], "communication_style": "formal", "reporting_frequency": "weekly", "preferred_meeting_times": [], "escalation_contacts": [], "project_methodology": "agile"}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the engagement was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the engagement record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "created_by",
        existing_type=sa.UUID(),
        comment="The user ID of the person who created the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment="A soft-delete flag. If false, the engagement is considered inactive.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagements_client_account_id"),
        "engagements",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagements_id"),
        "engagements",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagements_is_active"),
        "engagements",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_engagements_status"),
        "engagements",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_engagements_client_account_id_client_accounts"),
        "engagements",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "engagements",
        "users",
        ["created_by"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "engagements",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.alter_column(
        "flow_deletion_audit",
        "deletion_type",
        existing_type=sa.VARCHAR(),
        comment=None,
        existing_comment="user_requested, auto_cleanup, admin_action, batch_operation",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "flow_deletion_audit",
        "deletion_method",
        existing_type=sa.VARCHAR(),
        comment=None,
        existing_comment="manual, api, batch, scheduled",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_client_account_id"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deleted_at"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_deletion_type"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_engagement_id"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_flow_id"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_flow_deletion_audit_tenant_flow"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_flow_deletion_audit_id"),
        table_name="flow_deletion_audit",
        schema="migration",
    )
    op.drop_constraint(
        op.f("flow_deletion_audit_engagement_id_fkey"),
        "flow_deletion_audit",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("flow_deletion_audit_client_account_id_fkey"),
        "flow_deletion_audit",
        schema="migration",
        type_="foreignkey",
    )
    op.alter_column(
        "import_field_mappings",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the field mapping record.",
        existing_nullable=False,
        existing_server_default=sa.text("gen_random_uuid()"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "data_import_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the parent data import job.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Denormalized client account ID for efficient multi-tenant queries.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment="The master flow ID this mapping is associated with.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "source_field",
        existing_type=sa.VARCHAR(length=255),
        comment="The name of the field in the source file (e.g., a CSV column header).",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "target_field",
        existing_type=sa.VARCHAR(length=255),
        comment="The name of the target field in the system's data model (e.g., 'asset.name').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "match_type",
        existing_type=sa.VARCHAR(length=50),
        comment="The type of match (e.g., 'direct', 'inferred', 'manual').",
        existing_nullable=False,
        existing_server_default=sa.text("'direct'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "confidence_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="A score from 0.0 to 1.0 indicating the AI's confidence in a suggested mapping.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "status",
        existing_type=sa.VARCHAR(length=20),
        comment="The current status of the mapping (e.g., 'suggested', 'approved', 'rejected').",
        existing_nullable=True,
        existing_server_default=sa.text("'suggested'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "suggested_by",
        existing_type=sa.VARCHAR(length=50),
        comment="Indicates who suggested the mapping (e.g., 'ai_mapper', 'user').",
        existing_nullable=True,
        existing_server_default=sa.text("'ai_mapper'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "approved_by",
        existing_type=sa.VARCHAR(length=255),
        comment="The user ID of the person who approved this mapping.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "approved_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the mapping was approved.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "transformation_rules",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob defining any transformation logic to be applied to the data (e.g., data type casting, value replacements).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "field_type",
        existing_type=sa.VARCHAR(length=50),
        comment="Data type of the field (e.g., string, number, date).",
        existing_comment="Data type of the field (e.g., string, number, date)",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "agent_reasoning",
        existing_type=sa.TEXT(),
        comment="AI agent reasoning for the mapping suggestion.",
        existing_comment="AI agent reasoning for the mapping suggestion",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the mapping record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to this record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_import_field_mappings_data_import_id_data_imports"),
        "import_field_mappings",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_import_field_mappings_client_account_id_client_accounts"),
        "import_field_mappings",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_import_field_mappings_master_flow_id_crewai_flow_sta_59e6"),
        "import_field_mappings",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "import_field_mappings",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        None,
        "import_field_mappings",
        "data_imports",
        ["data_import_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_table_comment(
        "import_field_mappings",
        "Stores mappings between source data fields and target system fields for data imports.",
        existing_comment=None,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the migration wave.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="The client account this wave belongs to.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="The engagement this wave is part of.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "wave_number",
        existing_type=sa.INTEGER(),
        comment="The sequential number of the wave (e.g., 1, 2, 3).",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment="A user-defined name for the migration wave.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "description",
        existing_type=sa.TEXT(),
        comment="A description of the wave's goals, scope, and included assets.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "status",
        existing_type=sa.VARCHAR(length=50),
        comment="The current status of the wave (e.g., 'planned', 'in_progress', 'completed').",
        existing_nullable=True,
        existing_server_default=sa.text("'planned'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "planned_start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The planned start date for the migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "planned_end_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The planned end date for the migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The actual start date of the wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_end_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="The actual end date of the wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "total_assets",
        existing_type=sa.INTEGER(),
        comment="The total number of assets included in this wave.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "completed_assets",
        existing_type=sa.INTEGER(),
        comment="The number of assets successfully migrated in this wave.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "failed_assets",
        existing_type=sa.INTEGER(),
        comment="The number of assets that failed to migrate in this wave.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "estimated_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The total estimated cost for this migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The total actual cost incurred for this migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "estimated_effort_hours",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The total estimated effort in hours for this wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_effort_hours",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="The total actual effort in hours spent on this wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the wave was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "created_by",
        existing_type=sa.UUID(),
        comment="The user who planned or created this wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_waves_client_account_id"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_waves_engagement_id"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_waves_id"), table_name="migration_waves", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_waves_status"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_waves_wave_number"),
        table_name="migration_waves",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migration_waves_client_account_id"),
        "migration_waves",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migration_waves_engagement_id"),
        "migration_waves",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migration_waves_id"),
        "migration_waves",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migration_waves_status"),
        "migration_waves",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_migration_waves_wave_number"),
        "migration_waves",
        ["wave_number"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_adapters_adapter_name"),
        table_name="platform_adapters",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_adapters_adapter_type"),
        table_name="platform_adapters",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_adapters_status"),
        table_name="platform_adapters",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_adapters_adapter_name"),
        "platform_adapters",
        ["adapter_name"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_adapters_adapter_type"),
        "platform_adapters",
        ["adapter_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_adapters_status"),
        "platform_adapters",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_credentials_client_account_id"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_credentials_credential_type"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_credentials_expires_at"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_credentials_platform_adapter_id"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_platform_credentials_status"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_credentials_client_account_id"),
        "platform_credentials",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_credentials_credential_type"),
        "platform_credentials",
        ["credential_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_credentials_expires_at"),
        "platform_credentials",
        ["expires_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_credentials_platform_adapter_id"),
        "platform_credentials",
        ["platform_adapter_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_platform_credentials_status"),
        "platform_credentials",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.drop_column(
        "platform_credentials", "last_rotation_checked_at", schema="migration"
    )
    op.drop_column("platform_credentials", "key_rotation_required", schema="migration")
    op.drop_column("platform_credentials", "encryption_algorithm", schema="migration")
    op.alter_column(
        "raw_import_records",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the raw record.",
        existing_nullable=False,
        existing_server_default=sa.text("gen_random_uuid()"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "data_import_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the parent data import job.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Denormalized client account ID for efficient multi-tenant queries.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "engagement_id",
        existing_type=sa.UUID(),
        comment="Denormalized engagement ID for efficient scoping.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment="Denormalized master flow ID for linking records to a flow.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "row_number",
        existing_type=sa.INTEGER(),
        comment="The original row number from the source file.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "raw_data",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="The original, unaltered data for this row, stored as a JSON object.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "cleansed_data",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="The data after initial cleansing and type casting, before full processing.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "validation_errors",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON array of validation errors found for this record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "processing_notes",
        existing_type=sa.TEXT(),
        comment="Any notes or warnings generated during the processing of this record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "is_processed",
        existing_type=sa.BOOLEAN(),
        comment="Flag indicating if this record has been successfully processed and transformed.",
        existing_nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "is_valid",
        existing_type=sa.BOOLEAN(),
        comment="Flag indicating if the raw data passed initial validation checks.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "asset_id",
        existing_type=sa.UUID(),
        comment="If an asset is created from this record, this links to it.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the raw record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "processed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the record was successfully processed.",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_raw_import_records_data_import_id_data_imports"),
        "raw_import_records",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        op.f("fk_raw_import_records_master_flow_id_crewai_flow_state__e097"),
        "raw_import_records",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "raw_import_records",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "raw_import_records",
        "data_imports",
        ["data_import_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        None,
        "raw_import_records",
        "assets",
        ["asset_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_table_comment(
        "raw_import_records",
        "Stores individual raw data records from imported files before transformation and loading.",
        existing_comment=None,
        schema="migration",
    )
    op.alter_column(
        "security_audit_logs",
        "is_suspicious",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "security_audit_logs",
        "requires_review",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "security_audit_logs",
        "is_blocked",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.drop_index(
        op.f("idx_security_audit_logs_actor_user_id"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_security_audit_logs_created_at"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_security_audit_logs_event_type"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_security_audit_logs_is_suspicious"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_security_audit_logs_severity"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("idx_security_audit_logs_target_user_id"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_actor_user_id"),
        "security_audit_logs",
        ["actor_user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_created_at"),
        "security_audit_logs",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_event_category"),
        "security_audit_logs",
        ["event_category"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_event_type"),
        "security_audit_logs",
        ["event_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_is_suspicious"),
        "security_audit_logs",
        ["is_suspicious"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_requires_review"),
        "security_audit_logs",
        ["requires_review"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_security_audit_logs_target_user_id"),
        "security_audit_logs",
        ["target_user_id"],
        unique=False,
        schema="migration",
    )
    op.drop_column("security_audit_logs", "request_payload", schema="migration")
    op.drop_column("security_audit_logs", "response_payload", schema="migration")
    op.drop_column("security_audit_logs", "target_details", schema="migration")
    op.alter_column(
        "sixr_analyses",
        "status",
        existing_type=postgresql.ENUM(
            "pending",
            "in_progress",
            "completed",
            "failed",
            "requires_input",
            name="analysis_status",
        ),
        type_=sa.Enum(
            "PENDING",
            "IN_PROGRESS",
            "COMPLETED",
            "FAILED",
            "REQUIRES_INPUT",
            name="analysisstatus",
        ),
        existing_nullable=False,
        existing_server_default=sa.text("'pending'::analysis_status"),
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "application_ids",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "application_data",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "final_recommendation",
        existing_type=postgresql.ENUM(
            "rehost",
            "replatform",
            "refactor",
            "rearchitect",
            "replace",
            "rewrite",
            name="sixr_strategy",
        ),
        type_=sa.Enum(
            "REHOST",
            "REPLATFORM",
            "REFACTOR",
            "REARCHITECT",
            "REPLACE",
            "REWRITE",
            name="sixrstrategy",
        ),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "analysis_config",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_analyses_client_account_id"),
        table_name="sixr_analyses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_analyses_engagement_id"),
        table_name="sixr_analyses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_analyses_name"), table_name="sixr_analyses", schema="migration"
    )
    op.drop_index(
        op.f("ix_sixr_analyses_status"), table_name="sixr_analyses", schema="migration"
    )
    op.create_foreign_key(
        None,
        "sixr_analyses",
        "migrations",
        ["migration_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_analysis_parameters_analysis_id"),
        table_name="sixr_analysis_parameters",
        schema="migration",
    )
    op.drop_constraint(
        op.f("sixr_analysis_parameters_analysis_id_fkey"),
        "sixr_analysis_parameters",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "sixr_analysis_parameters",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("assessment_flow_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("application_id", sa.UUID(), nullable=False),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("component_id", sa.UUID(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("sixr_strategy", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("decision_rationale", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "alternative_strategies",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "analysis_details", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("confidence_score", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "risk_assessment", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("implementation_approach", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("estimated_effort", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("estimated_duration", sa.String(length=100), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("estimated_cost", sa.Float(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "dependencies", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "constraints", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "assumptions", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "success_criteria", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "validation_plan", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("rollback_plan", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("business_value", sa.Text(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("business_priority", sa.Integer(), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "stakeholder_alignment",
            postgresql.JSONB(astext_type=sa.Text()),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("decision_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("implementation_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("approval_status", sa.String(length=50), nullable=False),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "decision_date",
            sa.DateTime(timezone=True),
            server_default=sa.text("now()"),
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("decided_by", sa.String(length=255), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("approved_by", sa.String(length=255), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("approved_at", sa.DateTime(timezone=True), nullable=True),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "decision_metadata", postgresql.JSONB(astext_type=sa.Text()), nullable=False
        ),
        schema="migration",
    )
    op.alter_column(
        "sixr_decisions",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "sixr_decisions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_constraint(
        op.f("sixr_decisions_engagement_id_fkey"),
        "sixr_decisions",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "sixr_decisions",
        "assessment_flows",
        ["assessment_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_column("sixr_decisions", "engagement_id", schema="migration")
    op.drop_column("sixr_decisions", "decision_data", schema="migration")
    op.drop_column("sixr_decisions", "decision_type", schema="migration")
    op.alter_column(
        "sixr_iterations",
        "parameter_changes",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "question_responses",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "recommendation_data",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "agent_insights",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "status",
        existing_type=postgresql.ENUM(
            "pending",
            "in_progress",
            "completed",
            "failed",
            "requires_input",
            name="analysis_status",
        ),
        type_=sa.String(length=20),
        existing_nullable=True,
        existing_server_default=sa.text("'pending'::analysis_status"),
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "error_details",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_iterations_analysis_id"),
        table_name="sixr_iterations",
        schema="migration",
    )
    op.drop_constraint(
        op.f("sixr_iterations_analysis_id_fkey"),
        "sixr_iterations",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "sixr_iterations",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "sixr_parameters",
        "value",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_parameters_parameter_key"),
        table_name="sixr_parameters",
        schema="migration",
    )
    op.alter_column(
        "sixr_question_responses",
        "response_value",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_question_responses",
        "validation_errors",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_question_responses_analysis_id"),
        table_name="sixr_question_responses",
        schema="migration",
    )
    op.drop_constraint(
        op.f("sixr_question_responses_analysis_id_fkey"),
        "sixr_question_responses",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "sixr_question_responses",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "question_type",
        existing_type=postgresql.ENUM(
            "text",
            "select",
            "multiselect",
            "file_upload",
            "boolean",
            "numeric",
            name="question_type",
        ),
        type_=sa.Enum(
            "TEXT",
            "SELECT",
            "MULTISELECT",
            "FILE_UPLOAD",
            "BOOLEAN",
            "NUMERIC",
            name="questiontype",
        ),
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "options",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "validation_rules",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "show_conditions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "skip_conditions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_questions_category"),
        table_name="sixr_questions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_questions_question_id"),
        table_name="sixr_questions",
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "recommended_strategy",
        existing_type=postgresql.ENUM(
            "rehost",
            "replatform",
            "refactor",
            "rearchitect",
            "replace",
            "rewrite",
            name="sixr_strategy",
        ),
        type_=sa.Enum(
            "REHOST",
            "REPLATFORM",
            "REFACTOR",
            "REARCHITECT",
            "REPLACE",
            "REWRITE",
            name="sixrstrategy",
        ),
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "strategy_scores",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "key_factors",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "assumptions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "next_steps",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "risk_factors",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "business_benefits",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "technical_benefits",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        type_=sa.JSON(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        type_=sa.DateTime(),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_sixr_recommendations_analysis_id"),
        table_name="sixr_recommendations",
        schema="migration",
    )
    op.drop_constraint(
        op.f("sixr_recommendations_analysis_id_fkey"),
        "sixr_recommendations",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "sixr_recommendations",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the association record.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "user_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the users table.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the client_accounts table.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "role",
        existing_type=sa.VARCHAR(length=50),
        comment="The user's role within this specific client account (e.g., 'admin', 'member', 'viewer').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the association was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "created_by",
        existing_type=sa.UUID(),
        comment="The user ID of the user who created this association (typically an admin).",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_user_account_associations_client_account_id"),
        table_name="user_account_associations",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_user_account_associations_user_id"),
        table_name="user_account_associations",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_account_associations_client_account_id"),
        "user_account_associations",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_account_associations_user_id"),
        "user_account_associations",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "user_id",
        existing_type=sa.UUID(),
        comment="Foreign key to the users table, serving as the primary key for this profile.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "status",
        existing_type=sa.VARCHAR(length=20),
        comment="The current status of the user's profile (e.g., pending, active, suspended).",
        existing_nullable=False,
        existing_server_default=sa.text("'PENDING_APPROVAL'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "approval_requested_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the user first requested access.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "approved_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when an admin approved the user's access.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "approved_by",
        existing_type=sa.UUID(),
        comment="The user ID of the admin who approved the access request.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "registration_reason",
        existing_type=sa.TEXT(),
        comment="The reason provided by the user for requesting access to the platform.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "organization",
        existing_type=sa.VARCHAR(length=255),
        comment="The organization or company the user belongs to.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "role_description",
        existing_type=sa.VARCHAR(length=255),
        comment="The user's job title or role within their organization.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "requested_access_level",
        existing_type=sa.VARCHAR(length=20),
        comment="The initial access level requested by the user during registration.",
        existing_nullable=True,
        existing_server_default=sa.text("'READ_ONLY'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "phone_number",
        existing_type=sa.VARCHAR(length=20),
        comment="The user's contact phone number. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "manager_email",
        existing_type=sa.VARCHAR(length=255),
        comment="The email address of the user's manager, for verification purposes. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "linkedin_profile",
        existing_type=sa.VARCHAR(length=255),
        comment="A link to the user's LinkedIn profile for identity verification.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "last_login_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the user's last successful login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "login_count",
        existing_type=sa.INTEGER(),
        comment="A counter for the total number of successful logins.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "failed_login_attempts",
        existing_type=sa.INTEGER(),
        comment="A counter for consecutive failed login attempts since the last success.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "last_failed_login",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last failed login attempt.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "notification_preferences",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="User-configurable settings for receiving platform notifications.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"email_notifications": true, "system_alerts": true, "learning_updates": false, "weekly_reports": true}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the profile was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the profile.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_profiles_status"),
        "user_profiles",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(
        op.f("fk_user_profiles_user_id_users"),
        "user_profiles",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        None,
        "user_profiles",
        "users",
        ["user_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.alter_column(
        "user_roles",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the user role assignment.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "user_id",
        existing_type=sa.UUID(),
        comment="Foreign key linking to the user who is assigned this role.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "role_type",
        existing_type=sa.VARCHAR(length=50),
        comment="The type of the role, from the RoleType enum (e.g., 'platform_admin', 'analyst').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "role_name",
        existing_type=sa.VARCHAR(length=100),
        comment="A human-readable name for this specific role instance.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "description",
        existing_type=sa.TEXT(),
        comment="A detailed description of the role's purpose and responsibilities.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "permissions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment="A JSON blob defining the specific permissions granted by this role.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "scope_type",
        existing_type=sa.VARCHAR(length=20),
        comment="The scope at which this role applies (e.g., 'global', 'client', 'engagement').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "scope_client_id",
        existing_type=sa.UUID(),
        comment="If scope is 'client', this links to the relevant client account.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "scope_engagement_id",
        existing_type=sa.UUID(),
        comment="If scope is 'engagement', this links to the relevant engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment="A flag to enable or disable the role assignment without deleting it.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "assigned_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp when the role was assigned to the user.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "assigned_by",
        existing_type=sa.UUID(),
        comment="The user ID of the admin who assigned this role.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="An optional expiration date for time-bound role assignments.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when this role assignment was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to this role assignment.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_index(op.f("ix_user_roles_id"), table_name="user_roles", schema="migration")
    op.drop_index(
        op.f("ix_user_roles_is_active"), table_name="user_roles", schema="migration"
    )
    op.drop_index(
        op.f("ix_user_roles_user_id"), table_name="user_roles", schema="migration"
    )
    op.create_index(
        op.f("ix_migration_user_roles_id"),
        "user_roles",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_roles_is_active"),
        "user_roles",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_user_roles_user_id"),
        "user_roles",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "users",
        "id",
        existing_type=sa.UUID(),
        comment="Unique identifier for the user.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "users",
        "email",
        existing_type=sa.VARCHAR(length=255),
        comment="The user's email address, used for login. This is PII.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "users",
        "password_hash",
        existing_type=sa.VARCHAR(length=255),
        comment="Stores the salted and hashed password for the user.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "first_name",
        existing_type=sa.VARCHAR(length=100),
        comment="The user's first name. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "last_name",
        existing_type=sa.VARCHAR(length=100),
        comment="The user's last name. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment="A soft-delete flag. If false, the user cannot log in.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "is_verified",
        existing_type=sa.BOOLEAN(),
        comment="Indicates if the user has verified their email address.",
        existing_nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "is_admin",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        comment="Indicates if the user is a platform administrator.",
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "default_client_id",
        existing_type=sa.UUID(),
        comment="The default client account to use for the user upon login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "default_engagement_id",
        existing_type=sa.UUID(),
        comment="The default engagement to use for the user upon login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of when the user account was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the last update to the user record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "last_login",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment="Timestamp of the user's last login.",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_constraint(
        op.f("uq_users_email"), "users", schema="migration", type_="unique"
    )
    op.create_index(
        op.f("ix_migration_users_email"),
        "users",
        ["email"],
        unique=True,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_users_id"), "users", ["id"], unique=False, schema="migration"
    )
    op.create_index(
        op.f("ix_migration_users_is_active"),
        "users",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_foreign_key(
        None,
        "users",
        "engagements",
        ["default_engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, "users", schema="migration", type_="foreignkey")
    op.drop_index(
        op.f("ix_migration_users_is_active"), table_name="users", schema="migration"
    )
    op.drop_index(op.f("ix_migration_users_id"), table_name="users", schema="migration")
    op.drop_index(
        op.f("ix_migration_users_email"), table_name="users", schema="migration"
    )
    op.create_unique_constraint(
        op.f("uq_users_email"),
        "users",
        ["email"],
        schema="migration",
        postgresql_nulls_not_distinct=False,
    )
    op.alter_column(
        "users",
        "last_login",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the user's last login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the user record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the user account was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "default_engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The default engagement to use for the user upon login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "default_client_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The default client account to use for the user upon login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "is_admin",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        comment=None,
        existing_comment="Indicates if the user is a platform administrator.",
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "is_verified",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="Indicates if the user has verified their email address.",
        existing_nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="A soft-delete flag. If false, the user cannot log in.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "users",
        "last_name",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The user's last name. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "first_name",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The user's first name. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "password_hash",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="Stores the salted and hashed password for the user.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "users",
        "email",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The user's email address, used for login. This is PII.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "users",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the user.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_roles_user_id"),
        table_name="user_roles",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_roles_is_active"),
        table_name="user_roles",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_roles_id"), table_name="user_roles", schema="migration"
    )
    op.create_index(
        op.f("ix_user_roles_user_id"),
        "user_roles",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_user_roles_is_active"),
        "user_roles",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_user_roles_id"), "user_roles", ["id"], unique=False, schema="migration"
    )
    op.alter_column(
        "user_roles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to this role assignment.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when this role assignment was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="An optional expiration date for time-bound role assignments.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "assigned_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the admin who assigned this role.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "assigned_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the role was assigned to the user.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="A flag to enable or disable the role assignment without deleting it.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "scope_engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="If scope is 'engagement', this links to the relevant engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "scope_client_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="If scope is 'client', this links to the relevant client account.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "scope_type",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The scope at which this role applies (e.g., 'global', 'client', 'engagement').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "permissions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob defining the specific permissions granted by this role.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A detailed description of the role's purpose and responsibilities.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "role_name",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="A human-readable name for this specific role instance.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "role_type",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The type of the role, from the RoleType enum (e.g., 'platform_admin', 'analyst').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "user_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key linking to the user who is assigned this role.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_roles",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the user role assignment.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(None, "user_profiles", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_user_profiles_user_id_users"),
        "user_profiles",
        "users",
        ["user_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_profiles_status"),
        table_name="user_profiles",
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the profile.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the profile was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "notification_preferences",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="User-configurable settings for receiving platform notifications.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"email_notifications": true, "system_alerts": true, "learning_updates": false, "weekly_reports": true}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "last_failed_login",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last failed login attempt.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "failed_login_attempts",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="A counter for consecutive failed login attempts since the last success.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "login_count",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="A counter for the total number of successful logins.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "last_login_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the user's last successful login.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "linkedin_profile",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="A link to the user's LinkedIn profile for identity verification.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "manager_email",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The email address of the user's manager, for verification purposes. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "phone_number",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The user's contact phone number. This is PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "requested_access_level",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The initial access level requested by the user during registration.",
        existing_nullable=True,
        existing_server_default=sa.text("'READ_ONLY'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "role_description",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The user's job title or role within their organization.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "organization",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The organization or company the user belongs to.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "registration_reason",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="The reason provided by the user for requesting access to the platform.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "approved_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the admin who approved the access request.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "approved_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when an admin approved the user's access.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "approval_requested_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the user first requested access.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "status",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The current status of the user's profile (e.g., pending, active, suspended).",
        existing_nullable=False,
        existing_server_default=sa.text("'PENDING_APPROVAL'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "user_profiles",
        "user_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the users table, serving as the primary key for this profile.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_account_associations_user_id"),
        table_name="user_account_associations",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_account_associations_client_account_id"),
        table_name="user_account_associations",
        schema="migration",
    )
    op.create_index(
        op.f("ix_user_account_associations_user_id"),
        "user_account_associations",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_user_account_associations_client_account_id"),
        "user_account_associations",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "created_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the user who created this association (typically an admin).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the association was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "role",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The user's role within this specific client account (e.g., 'admin', 'member', 'viewer').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the client_accounts table.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "user_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the users table.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "user_account_associations",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the association record.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(
        None, "sixr_recommendations", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("sixr_recommendations_analysis_id_fkey"),
        "sixr_recommendations",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("ix_sixr_recommendations_analysis_id"),
        "sixr_recommendations",
        ["analysis_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "updated_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "created_at",
        existing_type=sa.DateTime(),
        type_=postgresql.TIMESTAMP(timezone=True),
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "technical_benefits",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "business_benefits",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "risk_factors",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "next_steps",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "assumptions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "key_factors",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "strategy_scores",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_recommendations",
        "recommended_strategy",
        existing_type=sa.Enum(
            "REHOST",
            "REPLATFORM",
            "REFACTOR",
            "REARCHITECT",
            "REPLACE",
            "REWRITE",
            name="sixrstrategy",
        ),
        type_=postgresql.ENUM(
            "rehost",
            "replatform",
            "refactor",
            "rearchitect",
            "replace",
            "rewrite",
            name="sixr_strategy",
        ),
        existing_nullable=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_sixr_questions_question_id"),
        "sixr_questions",
        ["question_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_sixr_questions_category"),
        "sixr_questions",
        ["category"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "skip_conditions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "show_conditions",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "validation_rules",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "options",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_questions",
        "question_type",
        existing_type=sa.Enum(
            "TEXT",
            "SELECT",
            "MULTISELECT",
            "FILE_UPLOAD",
            "BOOLEAN",
            "NUMERIC",
            name="questiontype",
        ),
        type_=postgresql.ENUM(
            "text",
            "select",
            "multiselect",
            "file_upload",
            "boolean",
            "numeric",
            name="question_type",
        ),
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(
        None, "sixr_question_responses", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("sixr_question_responses_analysis_id_fkey"),
        "sixr_question_responses",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("ix_sixr_question_responses_analysis_id"),
        "sixr_question_responses",
        ["analysis_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_question_responses",
        "validation_errors",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_question_responses",
        "response_value",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.create_index(
        op.f("ix_sixr_parameters_parameter_key"),
        "sixr_parameters",
        ["parameter_key"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_parameters",
        "value",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(None, "sixr_iterations", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("sixr_iterations_analysis_id_fkey"),
        "sixr_iterations",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("ix_sixr_iterations_analysis_id"),
        "sixr_iterations",
        ["analysis_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "error_details",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "status",
        existing_type=sa.String(length=20),
        type_=postgresql.ENUM(
            "pending",
            "in_progress",
            "completed",
            "failed",
            "requires_input",
            name="analysis_status",
        ),
        existing_nullable=True,
        existing_server_default=sa.text("'pending'::analysis_status"),
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "agent_insights",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "recommendation_data",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "question_responses",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_iterations",
        "parameter_changes",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "decision_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column(
            "decision_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "sixr_decisions",
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        schema="migration",
    )
    op.drop_constraint(None, "sixr_decisions", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("sixr_decisions_engagement_id_fkey"),
        "sixr_decisions",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "sixr_decisions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "sixr_decisions",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_column("sixr_decisions", "decision_metadata", schema="migration")
    op.drop_column("sixr_decisions", "approved_at", schema="migration")
    op.drop_column("sixr_decisions", "approved_by", schema="migration")
    op.drop_column("sixr_decisions", "decided_by", schema="migration")
    op.drop_column("sixr_decisions", "decision_date", schema="migration")
    op.drop_column("sixr_decisions", "approval_status", schema="migration")
    op.drop_column("sixr_decisions", "implementation_status", schema="migration")
    op.drop_column("sixr_decisions", "decision_status", schema="migration")
    op.drop_column("sixr_decisions", "stakeholder_alignment", schema="migration")
    op.drop_column("sixr_decisions", "business_priority", schema="migration")
    op.drop_column("sixr_decisions", "business_value", schema="migration")
    op.drop_column("sixr_decisions", "rollback_plan", schema="migration")
    op.drop_column("sixr_decisions", "validation_plan", schema="migration")
    op.drop_column("sixr_decisions", "success_criteria", schema="migration")
    op.drop_column("sixr_decisions", "assumptions", schema="migration")
    op.drop_column("sixr_decisions", "constraints", schema="migration")
    op.drop_column("sixr_decisions", "dependencies", schema="migration")
    op.drop_column("sixr_decisions", "estimated_cost", schema="migration")
    op.drop_column("sixr_decisions", "estimated_duration", schema="migration")
    op.drop_column("sixr_decisions", "estimated_effort", schema="migration")
    op.drop_column("sixr_decisions", "implementation_approach", schema="migration")
    op.drop_column("sixr_decisions", "risk_assessment", schema="migration")
    op.drop_column("sixr_decisions", "confidence_score", schema="migration")
    op.drop_column("sixr_decisions", "analysis_details", schema="migration")
    op.drop_column("sixr_decisions", "alternative_strategies", schema="migration")
    op.drop_column("sixr_decisions", "decision_rationale", schema="migration")
    op.drop_column("sixr_decisions", "sixr_strategy", schema="migration")
    op.drop_column("sixr_decisions", "component_id", schema="migration")
    op.drop_column("sixr_decisions", "application_id", schema="migration")
    op.drop_column("sixr_decisions", "assessment_flow_id", schema="migration")
    op.drop_constraint(
        None, "sixr_analysis_parameters", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("sixr_analysis_parameters_analysis_id_fkey"),
        "sixr_analysis_parameters",
        "sixr_analyses",
        ["analysis_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("ix_sixr_analysis_parameters_analysis_id"),
        "sixr_analysis_parameters",
        ["analysis_id"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(None, "sixr_analyses", schema="migration", type_="foreignkey")
    op.create_index(
        op.f("ix_sixr_analyses_status"),
        "sixr_analyses",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_sixr_analyses_name"),
        "sixr_analyses",
        ["name"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_sixr_analyses_engagement_id"),
        "sixr_analyses",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_sixr_analyses_client_account_id"),
        "sixr_analyses",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "analysis_config",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "final_recommendation",
        existing_type=sa.Enum(
            "REHOST",
            "REPLATFORM",
            "REFACTOR",
            "REARCHITECT",
            "REPLACE",
            "REWRITE",
            name="sixrstrategy",
        ),
        type_=postgresql.ENUM(
            "rehost",
            "replatform",
            "refactor",
            "rearchitect",
            "replace",
            "rewrite",
            name="sixr_strategy",
        ),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "application_data",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "application_ids",
        existing_type=sa.JSON(),
        type_=postgresql.JSONB(astext_type=sa.Text()),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "sixr_analyses",
        "status",
        existing_type=sa.Enum(
            "PENDING",
            "IN_PROGRESS",
            "COMPLETED",
            "FAILED",
            "REQUIRES_INPUT",
            name="analysisstatus",
        ),
        type_=postgresql.ENUM(
            "pending",
            "in_progress",
            "completed",
            "failed",
            "requires_input",
            name="analysis_status",
        ),
        existing_nullable=False,
        existing_server_default=sa.text("'pending'::analysis_status"),
        schema="migration",
    )
    op.add_column(
        "security_audit_logs",
        sa.Column(
            "target_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Sanitized target details for audit purposes",
        ),
        schema="migration",
    )
    op.add_column(
        "security_audit_logs",
        sa.Column(
            "response_payload",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Sanitized response payload data for audit purposes",
        ),
        schema="migration",
    )
    op.add_column(
        "security_audit_logs",
        sa.Column(
            "request_payload",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Sanitized request payload data for audit purposes",
        ),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_target_user_id"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_requires_review"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_is_suspicious"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_event_type"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_event_category"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_created_at"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_security_audit_logs_actor_user_id"),
        table_name="security_audit_logs",
        schema="migration",
    )
    op.create_index(
        op.f("idx_security_audit_logs_target_user_id"),
        "security_audit_logs",
        ["target_user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_security_audit_logs_severity"),
        "security_audit_logs",
        ["severity"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_security_audit_logs_is_suspicious"),
        "security_audit_logs",
        ["is_suspicious"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_security_audit_logs_event_type"),
        "security_audit_logs",
        ["event_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_security_audit_logs_created_at"),
        "security_audit_logs",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_security_audit_logs_actor_user_id"),
        "security_audit_logs",
        ["actor_user_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "security_audit_logs",
        "is_blocked",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "security_audit_logs",
        "requires_review",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "security_audit_logs",
        "is_suspicious",
        existing_type=sa.BOOLEAN(),
        nullable=False,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.drop_table_comment(
        "raw_import_records",
        existing_comment="Stores individual raw data records from imported files before transformation and loading.",
        schema="migration",
    )
    op.drop_constraint(
        None, "raw_import_records", schema="migration", type_="foreignkey"
    )
    op.drop_constraint(
        None, "raw_import_records", schema="migration", type_="foreignkey"
    )
    op.drop_constraint(
        None, "raw_import_records", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("fk_raw_import_records_master_flow_id_crewai_flow_state__e097"),
        "raw_import_records",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_raw_import_records_data_import_id_data_imports"),
        "raw_import_records",
        "data_imports",
        ["data_import_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "processed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the record was successfully processed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the raw record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "asset_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="If an asset is created from this record, this links to it.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "is_valid",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="Flag indicating if the raw data passed initial validation checks.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "is_processed",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="Flag indicating if this record has been successfully processed and transformed.",
        existing_nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "processing_notes",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="Any notes or warnings generated during the processing of this record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "validation_errors",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON array of validation errors found for this record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "cleansed_data",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="The data after initial cleansing and type casting, before full processing.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "raw_data",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="The original, unaltered data for this row, stored as a JSON object.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "row_number",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The original row number from the source file.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Denormalized master flow ID for linking records to a flow.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Denormalized engagement ID for efficient scoping.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Denormalized client account ID for efficient multi-tenant queries.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "data_import_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the parent data import job.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "raw_import_records",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the raw record.",
        existing_nullable=False,
        existing_server_default=sa.text("gen_random_uuid()"),
        schema="migration",
    )
    op.add_column(
        "platform_credentials",
        sa.Column(
            "encryption_algorithm",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "platform_credentials",
        sa.Column(
            "key_rotation_required",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "platform_credentials",
        sa.Column(
            "last_rotation_checked_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_credentials_status"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_credentials_platform_adapter_id"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_credentials_expires_at"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_credentials_credential_type"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_credentials_client_account_id"),
        table_name="platform_credentials",
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_credentials_status"),
        "platform_credentials",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_credentials_platform_adapter_id"),
        "platform_credentials",
        ["platform_adapter_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_credentials_expires_at"),
        "platform_credentials",
        ["expires_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_credentials_credential_type"),
        "platform_credentials",
        ["credential_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_credentials_client_account_id"),
        "platform_credentials",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_adapters_status"),
        table_name="platform_adapters",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_adapters_adapter_type"),
        table_name="platform_adapters",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_platform_adapters_adapter_name"),
        table_name="platform_adapters",
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_adapters_status"),
        "platform_adapters",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_adapters_adapter_type"),
        "platform_adapters",
        ["adapter_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_platform_adapters_adapter_name"),
        "platform_adapters",
        ["adapter_name"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_migration_waves_wave_number"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_migration_waves_status"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_migration_waves_id"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_migration_waves_engagement_id"),
        table_name="migration_waves",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_migration_waves_client_account_id"),
        table_name="migration_waves",
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_waves_wave_number"),
        "migration_waves",
        ["wave_number"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_waves_status"),
        "migration_waves",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_waves_id"),
        "migration_waves",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_waves_engagement_id"),
        "migration_waves",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_migration_waves_client_account_id"),
        "migration_waves",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "created_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user who planned or created this wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the wave was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_effort_hours",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The total actual effort in hours spent on this wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "estimated_effort_hours",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The total estimated effort in hours for this wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The total actual cost incurred for this migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "estimated_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The total estimated cost for this migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "failed_assets",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The number of assets that failed to migrate in this wave.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "completed_assets",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The number of assets successfully migrated in this wave.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "total_assets",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The total number of assets included in this wave.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_end_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The actual end date of the wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "actual_start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The actual start date of the wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "planned_end_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The planned end date for the migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "planned_start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The planned start date for the migration wave.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The current status of the wave (e.g., 'planned', 'in_progress', 'completed').",
        existing_nullable=True,
        existing_server_default=sa.text("'planned'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A description of the wave's goals, scope, and included assets.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="A user-defined name for the migration wave.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "wave_number",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The sequential number of the wave (e.g., 1, 2, 3).",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The engagement this wave is part of.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The client account this wave belongs to.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "migration_waves",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the migration wave.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_table_comment(
        "import_field_mappings",
        existing_comment="Stores mappings between source data fields and target system fields for data imports.",
        schema="migration",
    )
    op.drop_constraint(
        None, "import_field_mappings", schema="migration", type_="foreignkey"
    )
    op.drop_constraint(
        None, "import_field_mappings", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("fk_import_field_mappings_master_flow_id_crewai_flow_sta_59e6"),
        "import_field_mappings",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_import_field_mappings_client_account_id_client_accounts"),
        "import_field_mappings",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_import_field_mappings_data_import_id_data_imports"),
        "import_field_mappings",
        "data_imports",
        ["data_import_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to this record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the mapping record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "agent_reasoning",
        existing_type=sa.TEXT(),
        comment="AI agent reasoning for the mapping suggestion",
        existing_comment="AI agent reasoning for the mapping suggestion.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "field_type",
        existing_type=sa.VARCHAR(length=50),
        comment="Data type of the field (e.g., string, number, date)",
        existing_comment="Data type of the field (e.g., string, number, date).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "transformation_rules",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob defining any transformation logic to be applied to the data (e.g., data type casting, value replacements).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "approved_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the mapping was approved.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "approved_by",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The user ID of the person who approved this mapping.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "suggested_by",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="Indicates who suggested the mapping (e.g., 'ai_mapper', 'user').",
        existing_nullable=True,
        existing_server_default=sa.text("'ai_mapper'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "status",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The current status of the mapping (e.g., 'suggested', 'approved', 'rejected').",
        existing_nullable=True,
        existing_server_default=sa.text("'suggested'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "confidence_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="A score from 0.0 to 1.0 indicating the AI's confidence in a suggested mapping.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "match_type",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The type of match (e.g., 'direct', 'inferred', 'manual').",
        existing_nullable=False,
        existing_server_default=sa.text("'direct'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "target_field",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The name of the target field in the system's data model (e.g., 'asset.name').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "source_field",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The name of the field in the source file (e.g., a CSV column header).",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The master flow ID this mapping is associated with.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Denormalized client account ID for efficient multi-tenant queries.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "data_import_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the parent data import job.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "import_field_mappings",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the field mapping record.",
        existing_nullable=False,
        existing_server_default=sa.text("gen_random_uuid()"),
        schema="migration",
    )
    op.create_foreign_key(
        op.f("flow_deletion_audit_client_account_id_fkey"),
        "flow_deletion_audit",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("flow_deletion_audit_engagement_id_fkey"),
        "flow_deletion_audit",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_id"),
        "flow_deletion_audit",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_tenant_flow"),
        "flow_deletion_audit",
        ["client_account_id", "engagement_id", "flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_flow_id"),
        "flow_deletion_audit",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_engagement_id"),
        "flow_deletion_audit",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deletion_type"),
        "flow_deletion_audit",
        ["deletion_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deleted_at"),
        "flow_deletion_audit",
        ["deleted_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_client_account_id"),
        "flow_deletion_audit",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "flow_deletion_audit",
        "deletion_method",
        existing_type=sa.VARCHAR(),
        comment="manual, api, batch, scheduled",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "flow_deletion_audit",
        "deletion_type",
        existing_type=sa.VARCHAR(),
        comment="user_requested, auto_cleanup, admin_action, batch_operation",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(None, "engagements", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "engagements", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_engagements_client_account_id_client_accounts"),
        "engagements",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagements_status"),
        table_name="engagements",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagements_is_active"),
        table_name="engagements",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagements_id"),
        table_name="engagements",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagements_client_account_id"),
        table_name="engagements",
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="A soft-delete flag. If false, the engagement is considered inactive.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "created_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the person who created the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the engagement record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the engagement was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "team_preferences",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Stores preferences for team collaboration and communication styles for this engagement.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"stakeholders": [], "decision_makers": [], "technical_leads": [], "communication_style": "formal", "reporting_frequency": "weekly", "preferred_meeting_times": [], "escalation_contacts": [], "project_methodology": "agile"}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "migration_scope",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Defines the scope of the migration, including targets, strategies, and exclusions.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"target_clouds": [], "migration_strategies": [], "excluded_systems": [], "included_environments": [], "business_units": [], "geographic_scope": [], "timeline_constraints": {}}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "settings",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob for any engagement-specific settings.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "client_contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The email of the primary client contact for this engagement. Considered PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "client_contact_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The name of the primary contact on the client's side for this engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "engagement_lead_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the person leading the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "actual_completion_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The actual date the engagement was completed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "target_completion_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The planned completion date for the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The official start date of the engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "priority",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The priority of the engagement (e.g., 'low', 'medium', 'high').",
        existing_nullable=True,
        existing_server_default=sa.text("'medium'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The current status of the engagement (e.g., 'planning', 'active', 'completed', 'on-hold').",
        existing_nullable=True,
        existing_server_default=sa.text("'active'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "engagement_type",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The type of engagement (e.g., 'migration', 'discovery', 'assessment').",
        existing_nullable=True,
        existing_server_default=sa.text("'migration'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A detailed description of the engagement's goals and scope.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "slug",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="A URL-friendly slug for the engagement.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The official name of the engagement (e.g., 'US-East Datacenter Migration').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key linking this engagement to its parent client account.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagements",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the engagement.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(
        None,
        "engagement_architecture_standards",
        schema="migration",
        type_="foreignkey",
    )
    op.drop_constraint(
        None,
        "engagement_architecture_standards",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        op.f("engagement_architecture_standards_engagement_id_fkey"),
        "engagement_architecture_standards",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_engagement_architecture_standards_client_account"),
        "engagement_architecture_standards",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.drop_constraint(
        "unique_engagement_standard",
        "engagement_architecture_standards",
        schema="migration",
        type_="unique",
    )
    op.create_index(
        op.f("ix_engagement_architecture_standards_client_account"),
        "engagement_architecture_standards",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_architecture_standards",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_architecture_standards",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_architecture_standards",
        "client_account_id",
        existing_type=sa.UUID(),
        comment="Client account for multi-tenant isolation",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagement_access_user_profile_id"),
        table_name="engagement_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagement_access_is_active"),
        table_name="engagement_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagement_access_id"),
        table_name="engagement_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_engagement_access_engagement_id"),
        table_name="engagement_access",
        schema="migration",
    )
    op.create_index(
        op.f("ix_engagement_access_user_profile_id"),
        "engagement_access",
        ["user_profile_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_engagement_access_is_active"),
        "engagement_access",
        ["is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_engagement_access_id"),
        "engagement_access",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_engagement_access_engagement_id"),
        "engagement_access",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the access record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the access record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "access_count",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="A counter for how many times the user has accessed this engagement.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "last_accessed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last time the user accessed this engagement.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="A flag to enable or disable this access record without deleting it.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="An optional expiration date for time-bound access.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "granted_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the admin who granted this access.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when engagement access was granted.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "allowed_session_types",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A whitelist of session types the user is allowed to interact with.",
        existing_nullable=True,
        existing_server_default=sa.text('\'["data_import", "validation_run"]\'::json'),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "restricted_sessions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A list of specific session IDs within this engagement that the user is barred from accessing.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::json"),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "permissions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob for fine-grained permission overrides specific to this engagement.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_import_data": false, "can_export_data": false, "can_manage_sessions": false, "can_configure_agents": false, "can_approve_migration_decisions": false, "can_access_sensitive_data": false}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "engagement_role",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="A descriptive role for the user in this engagement (e.g., 'Project Manager', 'Lead Analyst').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "access_level",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The general access level for the user within this engagement.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the engagement being accessed.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "user_profile_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the user's profile.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "engagement_access",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the engagement access record.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_status"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_master_flow_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_flow_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_engagement_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_data_import_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_discovery_flows_client_account_id"),
        table_name="discovery_flows",
        schema="migration",
    )
    op.create_unique_constraint(
        op.f("uq_discovery_flows_flow_id"),
        "discovery_flows",
        ["flow_id"],
        schema="migration",
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("ix_discovery_flows_status"),
        "discovery_flows",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_discovery_flows_master_flow_id"),
        "discovery_flows",
        ["master_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_discovery_flows_id"),
        "discovery_flows",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_discovery_flows_flow_id"),
        "discovery_flows",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_discovery_flows_engagement_id"),
        "discovery_flows",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_discovery_flows_data_import_id"),
        "discovery_flows",
        ["data_import_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_discovery_flows_client_account_id"),
        "discovery_flows",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.drop_table_comment(
        "data_imports",
        existing_comment="Tracks data import jobs, their status, and metadata within a multi-tenant environment.",
        schema="migration",
    )
    op.drop_constraint(None, "data_imports", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "data_imports", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "data_imports", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_data_imports_client_account_id_client_accounts"),
        "data_imports",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_data_imports_engagement_id_engagements"),
        "data_imports",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_data_imports_master_flow_id_crewai_flow_state_extensions"),
        "data_imports",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        initially="DEFERRED",
        deferrable=True,
    )
    op.alter_column(
        "data_imports",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to this record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the import record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "completed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the import job finished (either completed or failed).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "started_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the import job processing began.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "error_details",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob containing detailed error information, such as stack traces.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "error_message",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A summary of the error if the import job failed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "imported_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the person who initiated the import.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "failed_records",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The number of records that failed processing.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "processed_records",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The number of records successfully processed so far.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "total_records",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The total number of records detected in the source file.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "progress_percentage",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The completion percentage of the import job.",
        existing_nullable=True,
        existing_server_default=sa.text("'0'::double precision"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "status",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The current status of the import job (e.g., 'pending', 'processing', 'completed', 'failed').",
        existing_nullable=False,
        existing_server_default=sa.text("'pending'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "source_system",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The system from which the data was exported (e.g., 'ServiceNow', 'Jira').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "mime_type",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The MIME type of the imported file (e.g., 'text/csv').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "file_size",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The size of the imported file in bytes.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "filename",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The original name of the imported file.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A detailed description of the data import's purpose or contents.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "import_type",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The type of data being imported (e.g., 'cmdb', 'asset_inventory').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "import_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="A user-defined name for the import job for easy identification.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The master flow ID that was initiated by this data import.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The engagement this import is associated with.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The client account this import belongs to.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "data_imports",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the data import job.",
        existing_nullable=False,
        schema="migration",
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "collection_quality_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "automation_tier", sa.VARCHAR(length=20), autoincrement=False, nullable=True
        ),
        schema="migration",
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column(
            "data_collection_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "crewai_flow_state_extensions",
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.drop_constraint(
        None, "crewai_flow_state_extensions", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("fk_crewai_flow_state_extensions_client_account_id_clien_8877"),
        "crewai_flow_state_extensions",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_crewai_flow_ext_collection_flow_id"),
        "crewai_flow_state_extensions",
        "collection_flows",
        ["collection_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="SET NULL",
    )
    op.create_foreign_key(
        op.f("fk_crewai_flow_state_parent"),
        "crewai_flow_state_extensions",
        "crewai_flow_state_extensions",
        ["parent_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_crewai_flow_state_extensions_engagement_id_engagements"),
        "crewai_flow_state_extensions",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_crewai_flow_state_extensions_flow_id"),
        table_name="crewai_flow_state_extensions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_crewai_flow_state_extensions_engagement_id"),
        table_name="crewai_flow_state_extensions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_crewai_flow_state_extensions_client_account_id"),
        table_name="crewai_flow_state_extensions",
        schema="migration",
    )
    op.create_unique_constraint(
        op.f("uq_crewai_flow_state_extensions_flow_id"),
        "crewai_flow_state_extensions",
        ["flow_id"],
        schema="migration",
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_collection_flow_id"),
        "crewai_flow_state_extensions",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_automation_tier"),
        "crewai_flow_state_extensions",
        ["automation_tier"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to this flow record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when the flow record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_metadata",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A flexible JSON blob for storing any other metadata related to the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "child_flow_ids",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A list of flow IDs for any sub-flows spawned by this flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "parent_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="If this is a sub-flow, this links to the parent flow's ID.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "retry_count",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The number of times the flow or a specific phase has been retried after a failure.",
        existing_nullable=False,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "error_history",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A log of all errors that occurred during the flow execution.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "phase_transitions",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="An audit log of all phase transitions (e.g., from 'data_cleansing' to 'asset_inventory').",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "adaptation_metrics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Metrics that track how the crew adapts its behavior based on feedback and learning.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "user_feedback_history",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A log of feedback provided by users at various stages of the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "learning_patterns",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Patterns and insights learned by the agents during the flow execution.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "crew_coordination_analytics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Analytics on the overall coordination and efficiency of the crew.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "agent_performance_metrics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Performance metrics for individual agents, such as task completion time and token usage.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "phase_execution_times",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON object storing the execution time for each phase of the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "knowledge_base_analytics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Analytics on how the knowledge base was accessed and utilized during the flow.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "memory_usage_metrics",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="Metrics related to the memory consumption of the agents and tools.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "agent_collaboration_log",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A log of significant interactions between agents within the crew.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_persistence_data",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob containing the complete state of the flow, allowing it to be paused and resumed.",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_configuration",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment=None,
        existing_comment="The initial configuration and parameters the flow was started with.",
        existing_nullable=False,
        existing_server_default=sa.text("'{}'::jsonb"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The current status of the flow (e.g., 'running', 'paused', 'completed', 'failed').",
        existing_nullable=False,
        existing_server_default=sa.text("'initialized'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="A user-friendly name for this flow instance.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_type",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The type of the flow (e.g., 'discovery', 'assessment', 'planning').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "user_id",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The user ID of the person who initiated the flow.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the engagement this flow is part of.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the client account this flow belongs to.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The unique identifier for a specific CrewAI flow instance. This is the main public ID.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "crewai_flow_state_extensions",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Internal primary key for the database record.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_rotation_history_rotation_type"),
        table_name="credential_rotation_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_rotation_history_rotated_at"),
        table_name="credential_rotation_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_rotation_history_credential_id"),
        table_name="credential_rotation_history",
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_rotation_history_rotation_type"),
        "credential_rotation_history",
        ["rotation_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_rotation_history_rotated_at"),
        "credential_rotation_history",
        ["rotated_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_rotation_history_credential_id"),
        "credential_rotation_history",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_permissions_user_id"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_permissions_role"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_permissions_permission_type"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_permissions_credential_id"),
        table_name="credential_permissions",
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_permissions_user_id"),
        "credential_permissions",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_permissions_role"),
        "credential_permissions",
        ["role"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_permissions_permission_type"),
        "credential_permissions",
        ["permission_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_permissions_credential_id"),
        "credential_permissions",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_access_logs_success"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_access_logs_credential_id"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_access_logs_accessed_by"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_access_logs_accessed_at"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_credential_access_logs_access_type"),
        table_name="credential_access_logs",
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_access_logs_success"),
        "credential_access_logs",
        ["success"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_access_logs_credential_id"),
        "credential_access_logs",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_access_logs_accessed_by"),
        "credential_access_logs",
        ["accessed_by"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_access_logs_accessed_at"),
        "credential_access_logs",
        ["accessed_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_credential_access_logs_access_type"),
        "credential_access_logs",
        ["access_type"],
        unique=False,
        schema="migration",
    )
    op.add_column(
        "component_treatments",
        sa.Column(
            "treatment_config",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.drop_constraint(
        None, "component_treatments", schema="migration", type_="foreignkey"
    )
    op.alter_column(
        "component_treatments",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "component_treatments",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_column("component_treatments", "task_metadata", schema="migration")
    op.drop_column("component_treatments", "progress", schema="migration")
    op.drop_column("component_treatments", "status", schema="migration")
    op.drop_column("component_treatments", "parallel_execution", schema="migration")
    op.drop_column("component_treatments", "execution_order", schema="migration")
    op.drop_column("component_treatments", "dependencies", schema="migration")
    op.drop_column("component_treatments", "complexity_factors", schema="migration")
    op.drop_column("component_treatments", "estimated_duration", schema="migration")
    op.drop_column("component_treatments", "estimated_effort", schema="migration")
    op.drop_column("component_treatments", "success_criteria", schema="migration")
    op.drop_column("component_treatments", "prerequisites", schema="migration")
    op.drop_column("component_treatments", "implementation_plan", schema="migration")
    op.drop_column("component_treatments", "risk_level", schema="migration")
    op.drop_column("component_treatments", "risk_assessment", schema="migration")
    op.drop_column("component_treatments", "confidence_score", schema="migration")
    op.drop_column("component_treatments", "assumptions", schema="migration")
    op.drop_column("component_treatments", "reasoning", schema="migration")
    op.drop_column("component_treatments", "analysis", schema="migration")
    op.drop_column("component_treatments", "approach", schema="migration")
    op.drop_column("component_treatments", "strategy", schema="migration")
    op.drop_column("component_treatments", "assessment_flow_id", schema="migration")
    op.drop_index(
        op.f("ix_migration_collection_questionnaire_responses_validation_status"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_questionnaire_responses_question_category"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_questionnaire_responses_questionnaire_type"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_questionnaire_responses_gap_id"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_questionnaire_responses_collection_flow_id"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_questionnaire_responses_asset_id"),
        table_name="collection_questionnaire_responses",
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_validation_status"),
        "collection_questionnaire_responses",
        ["validation_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_questionnaire_type"),
        "collection_questionnaire_responses",
        ["questionnaire_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_question_category"),
        "collection_questionnaire_responses",
        ["question_category"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_gap_id"),
        "collection_questionnaire_responses",
        ["gap_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_flow_asset"),
        "collection_questionnaire_responses",
        ["collection_flow_id", "asset_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_collection_flow_id"),
        "collection_questionnaire_responses",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_asset_id"),
        "collection_questionnaire_responses",
        ["asset_id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_gap_analysis_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_gap_analysis_engagement_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_gap_analysis_collection_flow_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_gap_analysis_client_account_id"),
        table_name="collection_gap_analysis",
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_id"),
        "collection_gap_analysis",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_engagement_id"),
        "collection_gap_analysis",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_collection_flow_id"),
        "collection_gap_analysis",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_client_account_id"),
        "collection_gap_analysis",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_flows_status"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_flows_master_flow_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_flows_flow_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_flows_engagement_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_flows_client_account_id"),
        table_name="collection_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_flows_automation_tier"),
        table_name="collection_flows",
        schema="migration",
    )
    op.create_unique_constraint(
        op.f("uq_collection_flows_flow_id"),
        "collection_flows",
        ["flow_id"],
        schema="migration",
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("ix_collection_flows_status"),
        "collection_flows",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_flows_master_flow_id"),
        "collection_flows",
        ["master_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_flows_id"),
        "collection_flows",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_flows_flow_id"),
        "collection_flows",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_flows_engagement_id"),
        "collection_flows",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_flows_client_account_id"),
        "collection_flows",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_flows_automation_tier"),
        "collection_flows",
        ["automation_tier"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "last_user_interaction",
        existing_type=sa.DateTime(timezone=True),
        type_=postgresql.TIMESTAMP(),
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "apps_ready_for_assessment",
        existing_type=sa.INTEGER(),
        nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "assessment_ready",
        existing_type=sa.BOOLEAN(),
        nullable=True,
        existing_server_default=sa.text("false"),
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "gap_analysis_results",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "collection_results",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "collected_platforms",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "agent_insights",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "phase_results",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "user_inputs",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flows",
        "pause_points",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        nullable=True,
        schema="migration",
    )
    op.create_table_comment(
        "collection_flow_applications",
        "Links Collection flows to selected applications from Discovery, tracking per-app collection status",
        existing_comment=None,
        schema="migration",
    )
    op.create_foreign_key(
        op.f("collection_flow_applications_asset_id_fkey"),
        "collection_flow_applications",
        "assets",
        ["asset_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="SET NULL",
    )
    op.create_foreign_key(
        op.f("collection_flow_applications_collection_flow_id_fkey"),
        "collection_flow_applications",
        "collection_flows",
        ["collection_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_variant_rel"),
        "collection_flow_applications",
        ["name_variant_id", "collection_flow_id"],
        unique=False,
        schema="migration",
        postgresql_where="(name_variant_id IS NOT NULL)",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_tenant_security"),
        "collection_flow_applications",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_status"),
        "collection_flow_applications",
        ["collection_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_canonical_rel"),
        "collection_flow_applications",
        ["canonical_application_id", "collection_flow_id", "collection_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_canonical"),
        "collection_flow_applications",
        ["canonical_application_id", "collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_collection_flow_apps"),
        "collection_flow_applications",
        ["collection_flow_id", "application_name"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "collection_flow_applications",
        "collection_status",
        existing_type=sa.VARCHAR(length=50),
        comment="Status of data collection for this application: pending, in_progress, completed, failed",
        existing_nullable=False,
        existing_server_default=sa.text("'pending'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "collection_flow_applications",
        "gap_analysis_result",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Result of gap analysis for this specific application",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "collection_flow_applications",
        "discovery_data_snapshot",
        existing_type=postgresql.JSONB(astext_type=sa.Text()),
        comment="Snapshot of Discovery data at the time of Collection flow creation",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_data_gaps_resolution_status"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_data_gaps_priority"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_data_gaps_gap_type"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_data_gaps_gap_category"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collection_data_gaps_collection_flow_id"),
        table_name="collection_data_gaps",
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_data_gaps_resolution_status"),
        "collection_data_gaps",
        ["resolution_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_data_gaps_priority"),
        "collection_data_gaps",
        ["priority"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_data_gaps_gap_type"),
        "collection_data_gaps",
        ["gap_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_data_gaps_gap_category"),
        "collection_data_gaps",
        ["gap_category"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collection_data_gaps_collection_flow_id"),
        "collection_data_gaps",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.add_column(
        "collected_data_inventory",
        sa.Column("credential_id", sa.UUID(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_collected_data_inventory_credential_id_platform_credentials"),
        "collected_data_inventory",
        "platform_credentials",
        ["credential_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="SET NULL",
    )
    op.drop_index(
        op.f("ix_migration_collected_data_inventory_validation_status"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collected_data_inventory_platform"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collected_data_inventory_data_type"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_collected_data_inventory_collection_flow_id"),
        table_name="collected_data_inventory",
        schema="migration",
    )
    op.create_index(
        op.f("ix_collected_data_inventory_validation_status"),
        "collected_data_inventory",
        ["validation_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collected_data_inventory_platform"),
        "collected_data_inventory",
        ["platform"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collected_data_inventory_data_type"),
        "collected_data_inventory",
        ["data_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collected_data_inventory_credential_id"),
        "collected_data_inventory",
        ["credential_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_collected_data_inventory_collection_flow_id"),
        "collected_data_inventory",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.add_column(
        "client_accounts",
        sa.Column(
            "pii_consent_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "client_accounts",
        sa.Column(
            "pii_data_consent",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "client_accounts",
        sa.Column(
            "data_retention_days",
            sa.INTEGER(),
            server_default=sa.text("365"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_accounts_slug"),
        table_name="client_accounts",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_accounts_is_active"),
        table_name="client_accounts",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_accounts_id"),
        table_name="client_accounts",
        schema="migration",
    )
    op.create_unique_constraint(
        op.f("uq_client_accounts_slug"),
        "client_accounts",
        ["slug"],
        schema="migration",
        postgresql_nulls_not_distinct=False,
    )
    op.alter_column(
        "client_accounts",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="A soft-delete flag. If false, the account is considered inactive.",
        existing_nullable=False,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "created_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the user who created this client account.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the client account record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the client account was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "agent_preferences",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Client-specific preferences for how the AI agents should operate during analysis.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"discovery_depth": "comprehensive", "automation_level": "assisted", "risk_tolerance": "moderate", "preferred_clouds": [], "compliance_requirements": [], "custom_rules": []}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "decision_criteria",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="The criteria the client uses to make migration decisions (e.g., cost, performance, security).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "it_guidelines",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Client's internal IT policies, standards, and guidelines for technology adoption.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "business_objectives",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Stores the client's strategic business goals and success criteria for migrations.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"primary_goals": [], "timeframe": "", "success_metrics": [], "constraints": []}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "branding",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Client-specific branding information, such as logos and colors, for UI customization.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "settings",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="General-purpose settings for the client account as a JSON blob.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "api_quota_monthly",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The monthly API request quota for this client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "storage_quota_gb",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The total data storage quota in gigabytes allocated to this client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "agent_configuration",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="Custom configuration for CrewAI agents specific to this client.",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "features_enabled",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob to toggle specific features for this client (feature flags).",
        existing_nullable=True,
        existing_server_default=sa.text("'{}'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "max_engagements",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The maximum number of concurrent engagements allowed.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "max_users",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The maximum number of users allowed under the current subscription.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "subscription_end_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The date when the client's current subscription term ends.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "subscription_start_date",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="The date when the client's current subscription term began.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "billing_contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The email address for sending billing-related communications. Considered PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "subscription_tier",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The subscription level for the client (e.g., 'free', 'standard', 'enterprise').",
        existing_nullable=True,
        existing_server_default=sa.text("'standard'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "timezone",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The primary timezone for the client to assist in scheduling and timestamps.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "address",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="The physical mailing address of the client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "contact_phone",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="A general contact phone number for the client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="A general contact email for the client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "primary_contact_phone",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The phone number for the main point of contact.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "primary_contact_email",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The email address of the main point of contact. Considered PII.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "primary_contact_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The name of the main point of contact at the client company.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "headquarters_location",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The geographical location of the client's headquarters.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "company_size",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The approximate size of the client's company (e.g., '1-50', '50-200').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "industry",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The industry vertical of the client (e.g., Finance, Healthcare).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A detailed description of the client account and their business.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "slug",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="A URL-friendly slug for the client account, used for identification.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The official name of the client company.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_accounts",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the client account.",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(None, "client_access", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "client_access", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_client_access_client_account_id_client_accounts"),
        "client_access",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_client_access_user_profile_id_user_profiles"),
        "client_access",
        "user_profiles",
        ["user_profile_id"],
        ["user_id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_access_user_profile_id"),
        table_name="client_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_access_is_active"),
        table_name="client_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_access_id"),
        table_name="client_access",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_client_access_client_account_id"),
        table_name="client_access",
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the access record.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the access record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "access_count",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="A counter for how many times the user has accessed this client's resources.",
        existing_nullable=True,
        existing_server_default=sa.text("0"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "last_accessed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last time the user accessed resources in this client.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "is_active",
        existing_type=sa.BOOLEAN(),
        comment=None,
        existing_comment="A flag to enable or disable this access record without deleting it.",
        existing_nullable=True,
        existing_server_default=sa.text("true"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "expires_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="An optional expiration date for time-bound access.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "granted_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user ID of the admin who granted this access.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "granted_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when access was granted.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "restricted_data_types",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A list of data types (e.g., 'financial') within this client the user CANNOT access.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "restricted_environments",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A list of environments (e.g., 'production') within this client the user CANNOT access.",
        existing_nullable=True,
        existing_server_default=sa.text("'[]'::json"),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "permissions",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob for fine-grained permission overrides specific to this client.",
        existing_nullable=True,
        existing_server_default=sa.text(
            '\'{"can_view_data": true, "can_import_data": false, "can_export_data": false, "can_manage_engagements": false, "can_configure_client_settings": false, "can_manage_client_users": false}\'::json'
        ),
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "access_level",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The general access level for the user within this client (e.g., 'admin', 'read_only').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the client account being accessed.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "user_profile_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the user's profile.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "client_access",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the client access record.",
        existing_nullable=False,
        schema="migration",
    )
    op.create_table_comment(
        "canonical_applications",
        "Master registry of canonical application names with multi-tenant isolation and deduplication",
        existing_comment=None,
        schema="migration",
    )
    op.drop_constraint(
        "uq_canonical_apps_tenant_name",
        "canonical_applications",
        schema="migration",
        type_="unique",
    )
    op.drop_index(
        op.f("ix_migration_canonical_applications_canonical_name"),
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        "idx_canonical_apps_hash_tenant",
        table_name="canonical_applications",
        schema="migration",
    )
    op.drop_index(
        "idx_canonical_apps_usage_stats",
        table_name="canonical_applications",
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_usage_stats"),
        "canonical_applications",
        [
            sa.literal_column("usage_count DESC"),
            sa.literal_column("last_used_at DESC"),
            "client_account_id",
            "engagement_id",
        ],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_verification"),
        "canonical_applications",
        [
            "is_verified",
            "verification_source",
            "confidence_score",
            "client_account_id",
            "engagement_id",
        ],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_vector_similarity"),
        "canonical_applications",
        ["name_embedding"],
        unique=False,
        schema="migration",
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.create_index(
        op.f("idx_canonical_apps_usage"),
        "canonical_applications",
        ["usage_count", "last_used_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_unverified_only"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            sa.literal_column("confidence_score DESC"),
            sa.literal_column("usage_count DESC"),
        ],
        unique=False,
        schema="migration",
        postgresql_where="(is_verified = false)",
    )
    op.create_index(
        op.f("idx_canonical_apps_tenant_security"),
        "canonical_applications",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_tenant_search_ranked"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            sa.literal_column("usage_count DESC"),
            "canonical_name",
        ],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_tenant_isolation"),
        "canonical_applications",
        ["client_account_id", "engagement_id", "normalized_name"],
        unique=True,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_quality_assessment"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            "is_verified",
            sa.literal_column("confidence_score DESC"),
            sa.literal_column("usage_count DESC"),
        ],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_normalized_pattern"),
        "canonical_applications",
        ["normalized_name", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_high_usage_only"),
        "canonical_applications",
        ["client_account_id", "engagement_id", sa.literal_column("last_used_at DESC")],
        unique=False,
        schema="migration",
        postgresql_where="(usage_count >= 5)",
    )
    op.create_index(
        op.f("idx_canonical_apps_hash_lookup"),
        "canonical_applications",
        ["name_hash", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_hash_exact_match"),
        "canonical_applications",
        ["name_hash", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_canonical_apps_fulltext_search"),
        "canonical_applications",
        [sa.literal_column("to_tsvector('english'::regconfig, canonical_name::text)")],
        unique=False,
        schema="migration",
        postgresql_using="gin",
    )
    op.create_index(
        op.f("idx_canonical_apps_dedup_workflow"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            "normalized_name",
            sa.literal_column("confidence_score DESC"),
        ],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "confidence_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="Confidence in canonical name accuracy (0.0-1.0, higher = more confident)",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "name_embedding",
        existing_type=pgvector.sqlalchemy.vector.VECTOR(dim=384),
        comment="Vector embedding of canonical_name for fuzzy similarity search (384-dim sentence-transformers)",
        existing_comment="Vector embedding for semantic similarity search",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "name_hash",
        existing_type=sa.VARCHAR(length=64),
        comment="SHA-256 hash of normalized_name for fast lookups",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "normalized_name",
        existing_type=sa.VARCHAR(length=255),
        comment="Lowercase, trimmed, special-char-removed version for exact matching",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "canonical_applications",
        "canonical_name",
        existing_type=sa.VARCHAR(length=255),
        comment="The authoritative, human-readable name for this application",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assets", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_assets_client_account_id_client_accounts"),
        "assets",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_assets_engagement_id_engagements"),
        "assets",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_status"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_source_phase"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_planning_flow_id"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_name"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_migration_status"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_master_flow_id"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_mapping_status"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_id"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_hostname"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_flow_id"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_execution_flow_id"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_environment"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_engagement_id"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_discovery_status"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_discovery_flow_id"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_current_phase"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_client_account_id"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_asset_type"), table_name="assets", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_assets_assessment_readiness"),
        table_name="assets",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assets_assessment_flow_id"),
        table_name="assets",
        schema="migration",
    )
    op.create_index(
        op.f("ix_assets_unique_name_per_context"),
        "assets",
        ["client_account_id", "engagement_id", "name"],
        unique=True,
        schema="migration",
        postgresql_where="((name IS NOT NULL) AND ((name)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_assets_unique_ip_per_context"),
        "assets",
        ["client_account_id", "engagement_id", "ip_address"],
        unique=True,
        schema="migration",
        postgresql_where="((ip_address IS NOT NULL) AND ((ip_address)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_assets_unique_hostname_per_context"),
        "assets",
        ["client_account_id", "engagement_id", "hostname"],
        unique=True,
        schema="migration",
        postgresql_where="((hostname IS NOT NULL) AND ((hostname)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_assets_discovery_status"),
        "assets",
        ["discovery_status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_assets_client_engagement_readiness"),
        "assets",
        ["client_account_id", "engagement_id", "assessment_readiness"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_assets_assessment_readiness"),
        "assets",
        ["assessment_readiness"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_assets_type"),
        "assets",
        ["asset_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_assets_status"),
        "assets",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_assets_created_at_desc"),
        "assets",
        [sa.literal_column("created_at DESC")],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_assets_client_engagement_created"),
        "assets",
        ["client_account_id", "engagement_id", sa.literal_column("created_at DESC")],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_assets_client_engagement"),
        "assets",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "updated_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user who last updated this asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "created_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user who originally created this asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of the last update to the asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the asset record was created.",
        existing_nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_recommendations",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="List of recommendations to achieve assessment readiness.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_blockers",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="List of identified blockers preventing assessment readiness.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_readiness_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="Optional readiness score (0-100 or 0-1 depending on configuration).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_readiness",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="Assessment readiness status for this asset (e.g., 'ready', 'not_ready').",
        existing_nullable=True,
        existing_server_default=sa.text("'not_ready'::character varying"),
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_completed_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp when discovery completed for this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="Discovery lifecycle status for this asset (e.g., 'completed').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "raw_import_records_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The raw import record this asset was created from.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "field_mappings_used",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="The specific field mappings that were applied to create this asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "raw_data",
        existing_type=sa.JSON(),
        type_=sa.TEXT(),
        comment=None,
        existing_comment="A JSON blob of the original, raw data for this asset from the import source.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "source_filename",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The original filename from which this asset was imported.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "imported_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the asset was imported.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "imported_by",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user who imported the data that created this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "estimated_cloud_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The estimated monthly cost of running the asset in the cloud.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "current_monthly_cost",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The estimated current monthly cost of running the asset on-premises.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "quality_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="An overall data quality score for the asset record.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "completeness_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="A score indicating how complete the asset's data is.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "network_throughput_mbps",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The average network throughput in megabits per second.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "disk_iops",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The average disk Input/Output Operations Per Second.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "memory_utilization_percent",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The average memory utilization percentage.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "cpu_utilization_percent",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The average CPU utilization percentage.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_timestamp",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        comment=None,
        existing_comment="Timestamp of when the asset was last discovered or updated.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_source",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The specific tool or system that discovered the asset (e.g., 'ServiceNow', 'Azure Migrate').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_method",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="How the asset was discovered (e.g., 'network_scan', 'agent', 'import').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "related_assets",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON array of other related assets or CIs.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "dependencies",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON array of assets that this asset depends on.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The status of the asset within the migration lifecycle (e.g., 'discovered', 'assessed', 'migrated').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "status",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The operational status of the asset (e.g., 'active', 'decommissioned', 'maintenance').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "sixr_ready",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="Indicates if the asset is ready for 6R analysis (e.g., 'Ready', 'Needs Analysis').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_wave",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The migration wave this asset is assigned to.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_complexity",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The assessed complexity of migrating this asset (e.g., 'Low', 'Medium', 'High').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_priority",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="A priority score (1-10) for migrating this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "mapping_status",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The status of the asset's field mapping during import.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "six_r_strategy",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The recommended 6R migration strategy (e.g., 'Rehost', 'Refactor').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "custom_attributes",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob for storing any custom fields or attributes not in the standard schema.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "business_criticality",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The business impact or criticality of the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "criticality",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The technical criticality of the asset (e.g., 'Low', 'Medium', 'High').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "technology_stack",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="A summary of the technology stack running on the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "application_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The primary application or service this asset supports.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "department",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The business department or unit that uses this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "technical_owner",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The name of the technical owner or team responsible for the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "business_owner",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The name of the business owner or department responsible for the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "storage_gb",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The total storage in gigabytes allocated to the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "memory_gb",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment=None,
        existing_comment="The amount of RAM in gigabytes allocated to the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "cpu_cores",
        existing_type=sa.INTEGER(),
        comment=None,
        existing_comment="The number of CPU cores allocated to the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "os_version",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The version of the operating system.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "operating_system",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The operating system running on the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "availability_zone",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The cloud availability zone, if applicable.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "rack_location",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The specific rack location within the datacenter.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "datacenter",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The datacenter where the asset is hosted.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "location",
        existing_type=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The geographical location or region of the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "environment",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The operational environment (e.g., 'Production', 'Development', 'Test').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "mac_address",
        existing_type=sa.VARCHAR(length=17),
        comment=None,
        existing_comment="The MAC address of the asset's primary network interface.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "fqdn",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The fully qualified domain name of the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "ip_address",
        existing_type=sa.VARCHAR(length=45),
        comment=None,
        existing_comment="The primary IP address of the asset (supports IPv6).",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A detailed description of the asset and its function.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "asset_type",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The type of the asset, from the AssetType enum (e.g., 'server', 'database').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "hostname",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The hostname of the asset, if applicable.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "asset_name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="Alternative or display name for the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "name",
        existing_type=sa.VARCHAR(length=255),
        comment=None,
        existing_comment="The primary name of the asset.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "phase_context",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob for storing phase-specific data or state about the asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "current_phase",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The current workflow phase this asset is in (e.g., 'assessment', 'planning').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "source_phase",
        existing_type=sa.VARCHAR(length=50),
        comment=None,
        existing_comment="The phase in which the asset was originally created (e.g., 'discovery').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "execution_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The execution flow that is migrating this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "planning_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The planning flow that has included this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "assessment_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The assessment flow that analyzed this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "discovery_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The specific discovery flow that created or updated this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The master flow ID that is currently processing this asset.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "migration_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Identifier for a specific migration activity this asset is involved in.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Legacy field linking to a discovery flow. Use master_flow_id for new logic.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the engagement this asset is part of.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Foreign key to the client account this asset belongs to.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assets",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the asset.",
        existing_nullable=False,
        schema="migration",
    )
    op.add_column(
        "asset_dependencies",
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.create_unique_constraint(
        op.f("uq_asset_dependencies_asset_depends_on"),
        "asset_dependencies",
        ["asset_id", "depends_on_asset_id"],
        schema="migration",
        postgresql_nulls_not_distinct=False,
    )
    op.create_index(
        op.f("idx_asset_dependencies_type"),
        "asset_dependencies",
        ["dependency_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_asset_dependencies_depends_on_asset_id"),
        "asset_dependencies",
        ["depends_on_asset_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_asset_dependencies_asset_id"),
        "asset_dependencies",
        ["asset_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        comment=None,
        existing_comment="Timestamp of when the dependency was recorded.",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "description",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A description of the dependency relationship.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "dependency_type",
        existing_type=sa.VARCHAR(),
        nullable=True,
        comment=None,
        existing_comment="The type of dependency (e.g., 'database', 'application', 'storage').",
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "depends_on_asset_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The asset that is being depended upon.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "asset_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The asset that has the dependency.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "asset_dependencies",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the dependency relationship.",
        existing_nullable=False,
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column(
            "report_url", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("recommendations", sa.TEXT(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.add_column(
        "assessments",
        sa.Column("summary", sa.TEXT(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.drop_constraint(None, "assessments", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assessments", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assessments", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "assessments", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_assessments_engagement_id_engagements"),
        "assessments",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_assessments_client_account_id_client_accounts"),
        "assessments",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_assessments_master_flow_id_crewai_flow_state_extensions"),
        "assessments",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assessments_id"),
        table_name="assessments",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assessments_engagement_id"),
        table_name="assessments",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_assessments_client_account_id"),
        table_name="assessments",
        schema="migration",
    )
    op.drop_column("assessments", "updated_at", schema="migration")
    op.drop_column("assessments", "created_at", schema="migration")
    op.drop_column("assessments", "approval_date", schema="migration")
    op.drop_column("assessments", "review_date", schema="migration")
    op.drop_column("assessments", "assessment_date", schema="migration")
    op.drop_column("assessments", "assessor", schema="migration")
    op.drop_column("assessments", "prerequisites", schema="migration")
    op.drop_column("assessments", "recommended_wave", schema="migration")
    op.drop_column("assessments", "estimated_duration_days", schema="migration")
    op.drop_column("assessments", "estimated_effort_hours", schema="migration")
    op.drop_column("assessments", "ai_model_version", schema="migration")
    op.drop_column("assessments", "ai_confidence", schema="migration")
    op.drop_column("assessments", "ai_insights", schema="migration")
    op.drop_column("assessments", "compliance_considerations", schema="migration")
    op.drop_column("assessments", "user_impact", schema="migration")
    op.drop_column("assessments", "downtime_requirements", schema="migration")
    op.drop_column("assessments", "business_criticality", schema="migration")
    op.drop_column("assessments", "performance_impact", schema="migration")
    op.drop_column("assessments", "modernization_opportunities", schema="migration")
    op.drop_column("assessments", "compatibility_score", schema="migration")
    op.drop_column("assessments", "technical_complexity", schema="migration")
    op.drop_column("assessments", "dependencies_impact", schema="migration")
    op.drop_column("assessments", "blockers", schema="migration")
    op.drop_column("assessments", "risk_mitigation", schema="migration")
    op.drop_column("assessments", "identified_risks", schema="migration")
    op.drop_column("assessments", "roi_months", schema="migration")
    op.drop_column("assessments", "cost_savings_potential", schema="migration")
    op.drop_column("assessments", "estimated_target_cost", schema="migration")
    op.drop_column("assessments", "estimated_migration_cost", schema="migration")
    op.drop_column("assessments", "current_cost", schema="migration")
    op.drop_column("assessments", "strategy_rationale", schema="migration")
    op.drop_column("assessments", "alternative_strategies", schema="migration")
    op.drop_column("assessments", "recommended_strategy", schema="migration")
    op.drop_column("assessments", "confidence_level", schema="migration")
    op.drop_column("assessments", "overall_score", schema="migration")
    op.drop_column("assessments", "description", schema="migration")
    op.drop_column("assessments", "title", schema="migration")
    op.drop_column("assessments", "asset_id", schema="migration")
    op.drop_column("assessments", "migration_id", schema="migration")
    op.add_column(
        "assessment_learning_feedback",
        sa.Column(
            "feedback_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_learning_feedback",
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        schema="migration",
    )
    op.drop_constraint(
        None, "assessment_learning_feedback", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("assessment_learning_feedback_engagement_id_fkey"),
        "assessment_learning_feedback",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "assessment_learning_feedback",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assessment_learning_feedback",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_column("assessment_learning_feedback", "reviewed_at", schema="migration")
    op.drop_column("assessment_learning_feedback", "tags", schema="migration")
    op.drop_column(
        "assessment_learning_feedback", "recommendation_metadata", schema="migration"
    )
    op.drop_column(
        "assessment_learning_feedback", "implementation_status", schema="migration"
    )
    op.drop_column("assessment_learning_feedback", "review_status", schema="migration")
    op.drop_column(
        "assessment_learning_feedback", "processing_status", schema="migration"
    )
    op.drop_column(
        "assessment_learning_feedback", "actionability_score", schema="migration"
    )
    op.drop_column("assessment_learning_feedback", "impact_level", schema="migration")
    op.drop_column("assessment_learning_feedback", "quality_score", schema="migration")
    op.drop_column("assessment_learning_feedback", "scope", schema="migration")
    op.drop_column(
        "assessment_learning_feedback", "affected_components", schema="migration"
    )
    op.drop_column("assessment_learning_feedback", "context_data", schema="migration")
    op.drop_column(
        "assessment_learning_feedback", "recommendations", schema="migration"
    )
    op.drop_column("assessment_learning_feedback", "insights", schema="migration")
    op.drop_column("assessment_learning_feedback", "description", schema="migration")
    op.drop_column("assessment_learning_feedback", "title", schema="migration")
    op.drop_column("assessment_learning_feedback", "source", schema="migration")
    op.drop_column("assessment_learning_feedback", "category", schema="migration")
    op.drop_column(
        "assessment_learning_feedback", "assessment_flow_id", schema="migration"
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "agent_insights",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "pause_points",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "phase_results",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "last_user_interaction",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "selected_application_ids",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "user_inputs",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "apps_ready_for_planning",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "architecture_captured", sa.BOOLEAN(), autoincrement=False, nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "flow_status", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "flow_configuration",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "assessment_flows",
        sa.Column(
            "next_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        schema="migration",
    )
    op.drop_constraint(None, "assessment_flows", schema="migration", type_="foreignkey")
    op.create_foreign_key(
        op.f("fk_assessment_flows_master_flow_id"),
        "assessment_flows",
        "crewai_flow_state_extensions",
        ["master_flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_index(
        op.f("ix_assessment_flows_status"),
        "assessment_flows",
        ["status"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_assessment_flows_next_phase"),
        "assessment_flows",
        ["next_phase"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_assessment_flows_master_flow_id"),
        "assessment_flows",
        ["master_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_assessment_flows_engagement_id"),
        "assessment_flows",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_assessment_flows_current_phase"),
        "assessment_flows",
        ["current_phase"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "progress",
        existing_type=sa.Float(),
        type_=sa.INTEGER(),
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "current_phase",
        existing_type=sa.VARCHAR(length=100),
        nullable=True,
        schema="migration",
    )
    op.alter_column(
        "assessment_flows",
        "master_flow_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Reference to master flow orchestrator for cross-phase coordination",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_column("assessment_flows", "started_at", schema="migration")
    op.drop_column("assessment_flows", "error_count", schema="migration")
    op.drop_column("assessment_flows", "last_error", schema="migration")
    op.drop_column("assessment_flows", "flow_metadata", schema="migration")
    op.drop_column("assessment_flows", "runtime_state", schema="migration")
    op.drop_column("assessment_flows", "configuration", schema="migration")
    op.drop_column("assessment_flows", "phase_progress", schema="migration")
    op.drop_column("assessment_flows", "description", schema="migration")
    op.create_table_comment(
        "application_name_variants",
        "All name variations that resolve to canonical applications, with similarity metrics",
        existing_comment=None,
        schema="migration",
    )
    op.drop_constraint(
        "uq_app_variants_tenant_name",
        "application_name_variants",
        schema="migration",
        type_="unique",
    )
    op.drop_index(
        "idx_app_variants_hash_tenant",
        table_name="application_name_variants",
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_vector_similarity"),
        "application_name_variants",
        ["variant_embedding"],
        unique=False,
        schema="migration",
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.create_index(
        op.f("idx_app_variants_usage_stats"),
        "application_name_variants",
        [
            sa.literal_column("usage_count DESC"),
            sa.literal_column("last_used_at DESC"),
            "canonical_application_id",
        ],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_tenant_security"),
        "application_name_variants",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_tenant_isolation"),
        "application_name_variants",
        ["client_account_id", "engagement_id", "normalized_variant"],
        unique=True,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_normalized_pattern"),
        "application_name_variants",
        ["normalized_variant", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_lookup_optimization"),
        "application_name_variants",
        [
            "client_account_id",
            "engagement_id",
            "normalized_variant",
            "canonical_application_id",
        ],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_hash_lookup"),
        "application_name_variants",
        ["variant_hash", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_hash_exact_match"),
        "application_name_variants",
        ["variant_hash", "client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_app_variants_canonical_rel"),
        "application_name_variants",
        [
            "canonical_application_id",
            sa.literal_column("match_confidence DESC"),
            sa.literal_column("similarity_score DESC"),
        ],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "application_name_variants",
        "match_method",
        existing_type=sa.VARCHAR(length=50),
        nullable=True,
        comment="How this variant was matched: exact, fuzzy_text, vector_similarity, manual_verification",
        schema="migration",
    )
    op.alter_column(
        "application_name_variants",
        "similarity_score",
        existing_type=sa.DOUBLE_PRECISION(precision=53),
        comment="Cosine similarity score to canonical name embedding (0.0-1.0)",
        existing_nullable=True,
        schema="migration",
    )
    op.drop_column("application_name_variants", "updated_at", schema="migration")
    op.drop_column("application_name_variants", "created_at", schema="migration")
    op.add_column(
        "application_components",
        sa.Column(
            "component_config",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "application_components",
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        schema="migration",
    )
    op.drop_constraint(
        None, "application_components", schema="migration", type_="foreignkey"
    )
    op.create_foreign_key(
        op.f("application_components_engagement_id_fkey"),
        "application_components",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
    )
    op.alter_column(
        "application_components",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "application_components",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.drop_column("application_components", "component_metadata", schema="migration")
    op.drop_column("application_components", "discovery_metadata", schema="migration")
    op.drop_column("application_components", "discovered_by", schema="migration")
    op.drop_column("application_components", "assessment_progress", schema="migration")
    op.drop_column("application_components", "assessment_status", schema="migration")
    op.drop_column("application_components", "estimated_effort", schema="migration")
    op.drop_column("application_components", "recommended_approach", schema="migration")
    op.drop_column("application_components", "migration_readiness", schema="migration")
    op.drop_column("application_components", "technical_debt_score", schema="migration")
    op.drop_column("application_components", "business_criticality", schema="migration")
    op.drop_column("application_components", "complexity_score", schema="migration")
    op.drop_column("application_components", "dependencies", schema="migration")
    op.drop_column("application_components", "configuration", schema="migration")
    op.drop_column("application_components", "version", schema="migration")
    op.drop_column("application_components", "current_technology", schema="migration")
    op.drop_column("application_components", "description", schema="migration")
    op.drop_column("application_components", "application_id", schema="migration")
    op.drop_column("application_components", "assessment_flow_id", schema="migration")
    op.add_column(
        "application_architecture_overrides",
        sa.Column("standard_id", sa.UUID(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column("rationale", sa.TEXT(), autoincrement=False, nullable=True),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column(
            "override_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "application_architecture_overrides",
        sa.Column(
            "override_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        schema="migration",
    )
    op.drop_constraint(
        None,
        "application_architecture_overrides",
        schema="migration",
        type_="foreignkey",
    )
    op.create_foreign_key(
        op.f("application_architecture_overrides_assessment_flow_id_fkey"),
        "application_architecture_overrides",
        "assessment_flows",
        ["assessment_flow_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("application_architecture_overrides_standard_id_fkey"),
        "application_architecture_overrides",
        "engagement_architecture_standards",
        ["standard_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="SET NULL",
    )
    op.create_index(
        op.f("ix_application_architecture_overrides_assessment_flow_id"),
        "application_architecture_overrides",
        ["assessment_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_application_architecture_overrides_application_id"),
        "application_architecture_overrides",
        ["application_id"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "application_architecture_overrides",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=True,
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "application_architecture_overrides",
        "approved_by",
        existing_type=sa.String(length=255),
        type_=sa.VARCHAR(length=100),
        existing_nullable=True,
        schema="migration",
    )
    op.drop_column(
        "application_architecture_overrides", "override_metadata", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "risk_level", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "impact_assessment", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "approved_at", schema="migration"
    )
    op.drop_column("application_architecture_overrides", "approved", schema="migration")
    op.drop_column(
        "application_architecture_overrides",
        "technical_justification",
        schema="migration",
    )
    op.drop_column(
        "application_architecture_overrides",
        "business_justification",
        schema="migration",
    )
    op.drop_column("application_architecture_overrides", "reason", schema="migration")
    op.drop_column(
        "application_architecture_overrides", "override_value", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "original_value", schema="migration"
    )
    op.drop_column(
        "application_architecture_overrides", "requirement_type", schema="migration"
    )
    op.create_table_comment(
        "agent_task_history",
        "Detailed history of all agent task executions for performance tracking and analysis",
        existing_comment=None,
        schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_agent_task_history_flow_id"),
        "agent_task_history",
        "crewai_flow_state_extensions",
        ["flow_id"],
        ["flow_id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_agent_task_history_engagement_id"),
        "agent_task_history",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_agent_task_history_client_account_id"),
        "agent_task_history",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.drop_index(
        op.f("ix_migration_agent_task_history_task_id"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_task_history_flow_id"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_task_history_engagement_id"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_task_history_client_account_id"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_task_history_agent_name"),
        table_name="agent_task_history",
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_task_history_task_id"),
        "agent_task_history",
        ["task_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_task_history_status"),
        "agent_task_history",
        ["status", sa.literal_column("created_at DESC")],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_task_history_flow_id"),
        "agent_task_history",
        ["flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_task_history_client"),
        "agent_task_history",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_task_history_agent_name"),
        "agent_task_history",
        ["agent_name", sa.literal_column("created_at DESC")],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "agent_task_history",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_comment="When this record was created",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.create_table_comment(
        "agent_performance_daily",
        "Daily aggregated performance metrics for each agent",
        existing_comment=None,
        schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_agent_performance_daily_engagement_id"),
        "agent_performance_daily",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_agent_performance_daily_client_account_id"),
        "agent_performance_daily",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.drop_index(
        op.f("ix_migration_agent_performance_daily_engagement_id"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_performance_daily_date_recorded"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_performance_daily_client_account_id"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_performance_daily_agent_name"),
        table_name="agent_performance_daily",
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_performance_daily_date"),
        "agent_performance_daily",
        ["date_recorded"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_performance_daily_client"),
        "agent_performance_daily",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_performance_daily_agent"),
        "agent_performance_daily",
        ["agent_name", sa.literal_column("date_recorded DESC")],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "agent_performance_daily",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_comment="When this record was last updated",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "agent_performance_daily",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_comment="When this record was created",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.add_column(
        "agent_discovered_patterns",
        sa.Column(
            "supporting_data",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "agent_discovered_patterns",
        sa.Column(
            "validation_status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.add_column(
        "agent_discovered_patterns",
        sa.Column(
            "evidence_assets",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'[]'::json"),
            autoincrement=False,
            nullable=True,
        ),
        schema="migration",
    )
    op.create_table_comment(
        "agent_discovered_patterns",
        "Patterns discovered by agents during task execution for learning and optimization",
        existing_comment=None,
        schema="migration",
    )
    op.create_foreign_key(
        op.f("fk_agent_discovered_patterns_client_account_id"),
        "agent_discovered_patterns",
        "client_accounts",
        ["client_account_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.create_foreign_key(
        op.f("fk_agent_discovered_patterns_engagement_id"),
        "agent_discovered_patterns",
        "engagements",
        ["engagement_id"],
        ["id"],
        source_schema="migration",
        referent_schema="migration",
        ondelete="CASCADE",
    )
    op.drop_index(
        op.f("ix_migration_agent_discovered_patterns_pattern_type"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_discovered_patterns_pattern_id"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_discovered_patterns_engagement_id"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_discovered_patterns_discovered_by_agent"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_agent_discovered_patterns_client_account_id"),
        table_name="agent_discovered_patterns",
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_patterns_insight_type"),
        "agent_discovered_patterns",
        ["insight_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_patterns_client_insight_type"),
        "agent_discovered_patterns",
        ["client_account_id", "insight_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_pattern_type"),
        "agent_discovered_patterns",
        ["pattern_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_pattern_id"),
        "agent_discovered_patterns",
        ["pattern_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_confidence"),
        "agent_discovered_patterns",
        [sa.literal_column("confidence_score DESC")],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_client"),
        "agent_discovered_patterns",
        ["client_account_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_agent"),
        "agent_discovered_patterns",
        ["discovered_by_agent"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "updated_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_comment="When this record was last updated",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        existing_comment="When this pattern was discovered",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "embedding",
        existing_type=postgresql.ARRAY(sa.DECIMAL(), dimensions=1536),
        type_=postgresql.ARRAY(sa.DOUBLE_PRECISION(precision=53)),
        comment="Vector embedding for similarity search",
        existing_comment="Vector embedding for similarity search (OpenAI dimensions)",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "agent_discovered_patterns",
        "pattern_type",
        existing_type=sa.String(length=100),
        type_=postgresql.ENUM(
            "technology_correlation",
            "business_value_indicator",
            "risk_factor",
            "modernization_opportunity",
            "dependency_pattern",
            "security_vulnerability",
            "performance_bottleneck",
            "compliance_requirement",
            "field_mapping_approval",
            "field_mapping_rejection",
            "field_mapping_suggestion",
            name="patterntype",
        ),
        existing_comment="Type of pattern discovered",
        existing_nullable=False,
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_adaptive_questionnaires_template_type"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_adaptive_questionnaires_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_adaptive_questionnaires_engagement_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_adaptive_questionnaires_collection_flow_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_adaptive_questionnaires_client_account_id"),
        table_name="adaptive_questionnaires",
        schema="migration",
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_template_type"),
        "adaptive_questionnaires",
        ["template_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_id"),
        "adaptive_questionnaires",
        ["id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_engagement_id"),
        "adaptive_questionnaires",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_collection_flow_id"),
        "adaptive_questionnaires",
        ["collection_flow_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_client_account_id"),
        "adaptive_questionnaires",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.drop_constraint(None, "access_audit_log", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "access_audit_log", schema="migration", type_="foreignkey")
    op.drop_constraint(None, "access_audit_log", schema="migration", type_="foreignkey")
    op.drop_index(
        op.f("ix_migration_access_audit_log_user_id"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_access_audit_log_id"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_access_audit_log_created_at"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_access_audit_log_action_type"),
        table_name="access_audit_log",
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_user_id"),
        "access_audit_log",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_result"),
        "access_audit_log",
        ["result"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_resource_type"),
        "access_audit_log",
        ["resource_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_engagement_id"),
        "access_audit_log",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_created_at"),
        "access_audit_log",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_client_account_id"),
        "access_audit_log",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_access_audit_log_action_type"),
        "access_audit_log",
        ["action_type"],
        unique=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "created_at",
        existing_type=postgresql.TIMESTAMP(timezone=True),
        nullable=False,
        comment=None,
        existing_comment="The timestamp when the event occurred.",
        existing_server_default=sa.text("now()"),
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "details",
        existing_type=postgresql.JSON(astext_type=sa.Text()),
        comment=None,
        existing_comment="A JSON blob for storing any other relevant details about the event.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "user_agent",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="The user agent string of the client that made the request.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "ip_address",
        existing_type=sa.VARCHAR(length=45),
        comment=None,
        existing_comment="The source IP address of the request.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "reason",
        existing_type=sa.TEXT(),
        comment=None,
        existing_comment="A human-readable reason for the outcome (e.g., 'insufficient_permissions').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "result",
        existing_type=sa.VARCHAR(length=20),
        comment=None,
        existing_comment="The outcome of the action (e.g., 'success', 'denied', 'error').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "engagement_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The engagement context in which the action occurred.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "client_account_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The client account context in which the action occurred.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "resource_id",
        existing_type=sa.String(length=255),
        type_=sa.VARCHAR(length=36),
        comment=None,
        existing_comment="The ID of the specific resource that was affected.",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "resource_type",
        existing_type=sa.String(length=50),
        type_=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The type of resource that was affected (e.g., 'client', 'engagement', 'user_profile').",
        existing_nullable=True,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "action_type",
        existing_type=sa.String(length=50),
        type_=sa.VARCHAR(length=100),
        comment=None,
        existing_comment="The type of action being logged (e.g., 'login', 'access_granted', 'resource_deleted').",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "user_id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="The user who performed the action or was the subject of the event.",
        existing_nullable=False,
        schema="migration",
    )
    op.alter_column(
        "access_audit_log",
        "id",
        existing_type=sa.UUID(),
        comment=None,
        existing_comment="Unique identifier for the audit log entry.",
        existing_nullable=False,
        existing_server_default=sa.text("gen_random_uuid()"),
        schema="migration",
    )
    op.create_table(
        "analysis_queues",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "processing",
                "paused",
                "completed",
                "cancelled",
                "failed",
                name="queuestatus",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("client_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "created_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "started_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "completed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.PrimaryKeyConstraint("id", name="analysis_queues_pkey"),
        schema="migration",
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("idx_analysis_queues_context"),
        "analysis_queues",
        ["client_id", "engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "assessment_learning_feedback",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "feedback_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "feedback_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("assessment_learning_feedback_engagement_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("assessment_learning_feedback_pkey")),
    )
    op.create_table(
        "pii_data_registry",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "table_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "column_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "data_classification",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="PII, SPII, PUBLIC, INTERNAL, CONFIDENTIAL",
        ),
        sa.Column(
            "encryption_required",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("retention_days", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("purpose", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "legal_basis",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
            comment="consent, contract, legal_obligation, legitimate_interest",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pii_data_registry_pkey")),
        sa.UniqueConstraint(
            "table_name",
            "column_name",
            name=op.f("pii_data_registry_table_name_column_name_key"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
    )
    op.create_table(
        "agent_execution_history",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "agent_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "agent_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "agent_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "task_id", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "task_name", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "task_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column("status", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column(
            "start_time", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "end_time", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "duration_seconds",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "memory_usage_mb",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "cpu_usage_percent",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("llm_calls_count", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "result",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "error_details",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("agent_execution_history_pkey")),
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_execution_history_task_id"),
        "agent_execution_history",
        ["task_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_execution_history_engagement_id"),
        "agent_execution_history",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_execution_history_created_at"),
        "agent_execution_history",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_execution_history_composite"),
        "agent_execution_history",
        ["client_account_id", "engagement_id", "agent_name", "created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_execution_history_client_account_id"),
        "agent_execution_history",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_agent_execution_history_agent_name"),
        "agent_execution_history",
        ["agent_name"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "agent_task_history",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
            comment="Unique identifier for the agent task history record",
        ),
        sa.Column(
            "flow_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Reference to the CrewAI flow this task belongs to",
        ),
        sa.Column(
            "agent_name",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
            comment="Name of the agent that executed the task",
        ),
        sa.Column(
            "agent_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Type of agent: individual or crew_member",
        ),
        sa.Column(
            "task_id",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Unique identifier for the task within the flow",
        ),
        sa.Column(
            "task_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Human-readable name of the task",
        ),
        sa.Column(
            "task_description",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Detailed description of what the task accomplished",
        ),
        sa.Column(
            "started_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="When the task execution started",
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
            comment="When the task execution completed (null if still running)",
        ),
        sa.Column(
            "status",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Current status of the task execution",
        ),
        sa.Column(
            "duration_seconds",
            sa.NUMERIC(precision=10, scale=3),
            autoincrement=False,
            nullable=True,
            comment="Total execution time in seconds",
        ),
        sa.Column(
            "success",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=True,
            comment="Whether the task completed successfully",
        ),
        sa.Column(
            "result_preview",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Preview of the task result (truncated for large outputs)",
        ),
        sa.Column(
            "error_message",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Error message if the task failed",
        ),
        sa.Column(
            "llm_calls_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Number of LLM API calls made during task execution",
        ),
        sa.Column(
            "thinking_phases_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Number of thinking/reasoning phases during execution",
        ),
        sa.Column(
            "token_usage",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
            comment="Detailed token usage: {input_tokens, output_tokens, total_tokens}",
        ),
        sa.Column(
            "memory_usage_mb",
            sa.NUMERIC(precision=8, scale=2),
            autoincrement=False,
            nullable=True,
            comment="Peak memory usage during task execution in MB",
        ),
        sa.Column(
            "confidence_score",
            sa.NUMERIC(precision=3, scale=2),
            autoincrement=False,
            nullable=True,
            comment="Agent confidence score for the task result (0-1)",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account this task belongs to",
        ),
        sa.Column(
            "engagement_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Engagement this task is part of",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
            comment="When this record was created",
        ),
        sa.CheckConstraint(
            "agent_type::text = ANY (ARRAY['individual'::character varying, 'crew_member'::character varying]::text[])",
            name=op.f("chk_agent_task_history_agent_type"),
        ),
        sa.CheckConstraint(
            "status::text = ANY (ARRAY['pending'::character varying, 'starting'::character varying, 'running'::character varying, 'thinking'::character varying, 'waiting_llm'::character varying, 'processing_response'::character varying, 'completed'::character varying, 'failed'::character varying, 'timeout'::character varying]::text[])",
            name=op.f("chk_agent_task_history_status"),
        ),
        sa.CheckConstraint(
            "confidence_score >= 0::numeric AND confidence_score <= 1::numeric",
            name=op.f("chk_agent_task_history_confidence_score"),
        ),
        sa.CheckConstraint(
            "duration_seconds >= 0::numeric",
            name=op.f("chk_agent_task_history_duration_seconds"),
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_agent_task_history_client_account_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_agent_task_history_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_agent_task_history_engagement_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_agent_task_history_engagement_id_engagements"),
        ),
        sa.ForeignKeyConstraint(
            ["flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name=op.f("fk_agent_task_history_flow_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name=op.f("fk_agent_task_history_flow_id_crewai_flow_state_extensions"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_agent_task_history")),
        comment="Detailed history of all agent task executions for performance tracking and analysis",
    )
    op.create_index(
        op.f("ix_agent_task_history_task_id"),
        "agent_task_history",
        ["task_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_task_history_status"),
        "agent_task_history",
        ["status", sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_task_history_flow_id"),
        "agent_task_history",
        ["flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_task_history_client"),
        "agent_task_history",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_task_history_agent_name"),
        "agent_task_history",
        ["agent_name", sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_table(
        "migration_waves",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("wave_number", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'planned'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "planned_start_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "planned_end_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "actual_start_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "actual_end_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "total_assets",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "completed_assets",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "failed_assets",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_cost",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "actual_cost",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_effort_hours",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "actual_effort_hours",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_migration_waves_client_account_id_client_accounts"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["users.id"],
            name=op.f("fk_migration_waves_created_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_migration_waves_engagement_id_engagements"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_migration_waves")),
    )
    op.create_index(
        op.f("ix_migration_waves_wave_number"),
        "migration_waves",
        ["wave_number"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_waves_status"), "migration_waves", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_migration_waves_id"), "migration_waves", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_migration_waves_engagement_id"),
        "migration_waves",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_waves_client_account_id"),
        "migration_waves",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "analysis_queues",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "processing",
                "paused",
                "completed",
                "cancelled",
                "failed",
                name="queuestatus",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("client_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "created_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "started_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "completed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.PrimaryKeyConstraint("id", name="analysis_queues_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("idx_analysis_queues_context"),
        "analysis_queues",
        ["client_id", "engagement_id"],
        unique=False,
    )
    op.create_table(
        "cache_metadata",
        sa.Column(
            "id",
            sa.INTEGER(),
            server_default=sa.text(
                "nextval('\"migration\".cache_metadata_id_seq'::regclass)"
            ),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the cache metadata record",
        ),
        sa.Column(
            "cache_key",
            sa.VARCHAR(length=500),
            autoincrement=False,
            nullable=False,
            comment="The full Redis cache key including version and tenant information",
        ),
        sa.Column(
            "cache_key_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Type of cache key for monitoring and metrics (from CacheKeyType enum)",
        ),
        sa.Column(
            "entity_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Type of entity being cached (user, flow, import, etc.)",
        ),
        sa.Column(
            "entity_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
            comment="ID of the primary entity being cached",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account this cache entry belongs to for tenant isolation",
        ),
        sa.Column(
            "engagement_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="Optional engagement context for engagement-scoped cache entries",
        ),
        sa.Column(
            "ttl_seconds",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Time-to-live in seconds for this cache entry",
        ),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="Calculated expiration timestamp for cache cleanup",
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether this cache entry is currently active",
        ),
        sa.Column(
            "access_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of times this cache key has been accessed",
        ),
        sa.Column(
            "hit_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of successful cache hits",
        ),
        sa.Column(
            "miss_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of cache misses (key not found or expired)",
        ),
        sa.Column(
            "last_accessed",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
            comment="Timestamp of last cache access",
        ),
        sa.Column(
            "avg_access_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Average access time in milliseconds for performance monitoring",
        ),
        sa.Column(
            "data_size_bytes",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Size of cached data in bytes for memory usage tracking",
        ),
        sa.Column(
            "compression_ratio",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Compression ratio if data is compressed (0.0-1.0)",
        ),
        sa.Column(
            "parent_cache_keys",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="List of parent cache keys that trigger invalidation of this entry",
        ),
        sa.Column(
            "child_cache_keys",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="List of child cache keys that should be invalidated when this entry changes",
        ),
        sa.Column(
            "invalidation_triggers",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="List of events/operations that should invalidate this cache entry",
        ),
        sa.Column(
            "cache_tags",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Tags for cache organization and batch operations",
        ),
        sa.Column(
            "cache_metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional metadata about the cached content",
        ),
        sa.Column(
            "created_by_user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="User who initiated the cache operation",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache metadata was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache metadata was last updated",
        ),
        sa.CheckConstraint(
            "access_count >= 0", name="ck_cache_metadata_positive_access_count"
        ),
        sa.CheckConstraint(
            "compression_ratio IS NULL OR compression_ratio >= 0.0::double precision AND compression_ratio <= 1.0::double precision",
            name="ck_cache_metadata_valid_compression_ratio",
        ),
        sa.CheckConstraint(
            "hit_count >= 0", name="ck_cache_metadata_positive_hit_count"
        ),
        sa.CheckConstraint(
            "miss_count >= 0", name="ck_cache_metadata_positive_miss_count"
        ),
        sa.CheckConstraint("ttl_seconds > 0", name="ck_cache_metadata_positive_ttl"),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
            name="cache_metadata_client_account_id_fkey",
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["created_by_user_id"],
            ["migration.users.id"],
            name="cache_metadata_created_by_user_id_fkey",
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["migration.engagements.id"],
            name="cache_metadata_engagement_id_fkey",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name="cache_metadata_pkey"),
        sa.UniqueConstraint(
            "cache_key",
            "client_account_id",
            name="uq_cache_metadata_key_tenant",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        schema="migration",
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_tenant_active"),
        "cache_metadata",
        ["client_account_id", "is_active"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_metadata_expiration"),
        "cache_metadata",
        ["expires_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_metadata_entity_lookup"),
        "cache_metadata",
        ["entity_type", "entity_id", "client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_metadata_client_account_id"),
        "cache_metadata",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_metadata_cache_key"),
        "cache_metadata",
        ["cache_key"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_metadata_active_keys"),
        "cache_metadata",
        ["cache_key", "client_account_id"],
        unique=False,
        schema="migration",
        postgresql_where="(is_active = true)",
    )
    op.create_index(
        op.f("ix_cache_metadata_access_patterns"),
        "cache_metadata",
        ["last_accessed", "access_count"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "client_accounts",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("slug", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "industry", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "company_size", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "headquarters_location",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "primary_contact_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "primary_contact_email",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "primary_contact_phone",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "contact_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "contact_phone", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column("address", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "timezone", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "subscription_tier",
            sa.VARCHAR(length=50),
            server_default=sa.text("'standard'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "billing_contact_email",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "subscription_start_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "subscription_end_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("max_users", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("max_engagements", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "features_enabled",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "agent_configuration",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("storage_quota_gb", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "api_quota_monthly", sa.INTEGER(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "settings",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "branding",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "business_objectives",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"primary_goals": [], "timeframe": "", "success_metrics": [], "constraints": []}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "it_guidelines",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "decision_criteria",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "agent_preferences",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"discovery_depth": "comprehensive", "automation_level": "assisted", "risk_tolerance": "moderate", "preferred_clouds": [], "compliance_requirements": [], "custom_rules": []}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "data_retention_days",
            sa.INTEGER(),
            server_default=sa.text("365"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "pii_data_consent",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "pii_consent_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.PrimaryKeyConstraint("id", name="pk_client_accounts"),
        sa.UniqueConstraint(
            "slug",
            name="uq_client_accounts_slug",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_table(
        "collection_data_gaps",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "gap_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "gap_category", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "field_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "impact_on_sixr", sa.VARCHAR(length=20), autoincrement=False, nullable=False
        ),
        sa.Column(
            "priority",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "suggested_resolution", sa.TEXT(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "resolution_status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "resolved_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "resolved_by", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name="fk_collection_data_gaps_collection_flow_id_collection_flows",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name="pk_collection_data_gaps"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_collection_data_gaps_resolution_status"),
        "collection_data_gaps",
        ["resolution_status"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_data_gaps_priority"),
        "collection_data_gaps",
        ["priority"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_data_gaps_gap_type"),
        "collection_data_gaps",
        ["gap_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_data_gaps_gap_category"),
        "collection_data_gaps",
        ["gap_category"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_data_gaps_collection_flow_id"),
        "collection_data_gaps",
        ["collection_flow_id"],
        unique=False,
    )
    op.create_table(
        "sixr_recommendations",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("analysis_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "iteration_number",
            sa.INTEGER(),
            server_default=sa.text("1"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "recommended_strategy",
            postgresql.ENUM(
                "rehost",
                "replatform",
                "refactor",
                "rearchitect",
                "replace",
                "rewrite",
                name="sixr_strategy",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "strategy_scores",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "key_factors",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "assumptions",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "next_steps",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_effort",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_timeline",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_cost_impact",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "risk_factors",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "business_benefits",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "technical_benefits",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
            name=op.f("sixr_recommendations_analysis_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_recommendations_pkey")),
    )
    op.create_index(
        op.f("ix_sixr_recommendations_analysis_id"),
        "sixr_recommendations",
        ["analysis_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_recommendations_id"),
        "sixr_recommendations",
        ["id"],
        unique=False,
    )
    op.create_table(
        "assessment_flows",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "flow_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "flow_status", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "flow_configuration",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "selected_application_ids",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "architecture_captured", sa.BOOLEAN(), autoincrement=False, nullable=False
        ),
        sa.Column("status", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column("progress", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "current_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "next_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "pause_points",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "user_inputs",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "phase_results",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "agent_insights",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "apps_ready_for_planning",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "last_user_interaction",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="assessment_flows_client_account_id_fkey",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="assessment_flows_engagement_id_fkey",
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name="fk_assessment_flows_master_flow_id",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name="assessment_flows_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_assessment_flows_status"), "assessment_flows", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_assessment_flows_next_phase"),
        "assessment_flows",
        ["next_phase"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assessment_flows_master_flow_id"),
        "assessment_flows",
        ["master_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assessment_flows_engagement_id"),
        "assessment_flows",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assessment_flows_current_phase"),
        "assessment_flows",
        ["current_phase"],
        unique=False,
    )
    op.create_table(
        "engagement_architecture_standards",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "requirement_type",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "is_mandatory",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account for multi-tenant isolation",
        ),
        sa.Column(
            "standard_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "minimum_requirements",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "preferred_patterns",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "constraints",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "compliance_level",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("priority", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "business_impact",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("source", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column("version", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column(
            "score_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_engagement_architecture_standards_client_account",
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="engagement_architecture_standards_engagement_id_fkey",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name="engagement_architecture_standards_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_engagement_architecture_standards_client_account"),
        "engagement_architecture_standards",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "agent_execution_history",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "agent_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "agent_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "agent_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "task_id", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "task_name", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "task_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column("status", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column(
            "start_time", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "end_time", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "duration_seconds",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "memory_usage_mb",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "cpu_usage_percent",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("llm_calls_count", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "result",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "error_details",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("agent_execution_history_pkey")),
    )
    op.create_index(
        op.f("ix_agent_execution_history_task_id"),
        "agent_execution_history",
        ["task_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_execution_history_engagement_id"),
        "agent_execution_history",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_execution_history_created_at"),
        "agent_execution_history",
        ["created_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_execution_history_composite"),
        "agent_execution_history",
        ["client_account_id", "engagement_id", "agent_name", "created_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_execution_history_client_account_id"),
        "agent_execution_history",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_execution_history_agent_name"),
        "agent_execution_history",
        ["agent_name"],
        unique=False,
    )
    op.create_table(
        "crewai_flow_state_extensions",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "user_id", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "flow_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "flow_name", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "flow_status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'initialized'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "flow_configuration",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "flow_persistence_data",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "agent_collaboration_log",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "memory_usage_metrics",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "knowledge_base_analytics",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "phase_execution_times",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "agent_performance_metrics",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "crew_coordination_analytics",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "learning_patterns",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "user_feedback_history",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "adaptation_metrics",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "phase_transitions",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "error_history",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "retry_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("parent_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "child_flow_ids",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "flow_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "automation_tier", sa.VARCHAR(length=20), autoincrement=False, nullable=True
        ),
        sa.Column(
            "collection_quality_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "data_collection_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=True,
        ),
        sa.CheckConstraint(
            "flow_type::text = ANY (ARRAY['discovery'::character varying, 'assessment'::character varying, 'collection'::character varying, 'planning'::character varying, 'execution'::character varying, 'modernize'::character varying, 'finops'::character varying, 'observability'::character varying, 'decommission'::character varying]::text[])",
            name="chk_valid_flow_type",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_crewai_flow_state_extensions_client_account_id_clien_8877",
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name="fk_crewai_flow_ext_collection_flow_id",
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="fk_crewai_flow_state_extensions_engagement_id_engagements",
        ),
        sa.ForeignKeyConstraint(
            ["parent_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name="fk_crewai_flow_state_parent",
        ),
        sa.PrimaryKeyConstraint("id", name="pk_crewai_flow_state_extensions"),
        sa.UniqueConstraint(
            "flow_id",
            name="uq_crewai_flow_state_extensions_flow_id",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_collection_flow_id"),
        "crewai_flow_state_extensions",
        ["collection_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_crewai_flow_state_extensions_automation_tier"),
        "crewai_flow_state_extensions",
        ["automation_tier"],
        unique=False,
    )
    op.create_table(
        "cache_metadata",
        sa.Column(
            "id",
            sa.INTEGER(),
            server_default=sa.text("nextval('cache_metadata_id_seq'::regclass)"),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the cache metadata record",
        ),
        sa.Column(
            "cache_key",
            sa.VARCHAR(length=500),
            autoincrement=False,
            nullable=False,
            comment="The full Redis cache key including version and tenant information",
        ),
        sa.Column(
            "cache_key_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Type of cache key for monitoring and metrics (from CacheKeyType enum)",
        ),
        sa.Column(
            "entity_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="Type of entity being cached (user, flow, import, etc.)",
        ),
        sa.Column(
            "entity_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
            comment="ID of the primary entity being cached",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account this cache entry belongs to for tenant isolation",
        ),
        sa.Column(
            "engagement_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="Optional engagement context for engagement-scoped cache entries",
        ),
        sa.Column(
            "ttl_seconds",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Time-to-live in seconds for this cache entry",
        ),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="Calculated expiration timestamp for cache cleanup",
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether this cache entry is currently active",
        ),
        sa.Column(
            "access_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of times this cache key has been accessed",
        ),
        sa.Column(
            "hit_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of successful cache hits",
        ),
        sa.Column(
            "miss_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of cache misses (key not found or expired)",
        ),
        sa.Column(
            "last_accessed",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
            comment="Timestamp of last cache access",
        ),
        sa.Column(
            "avg_access_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Average access time in milliseconds for performance monitoring",
        ),
        sa.Column(
            "data_size_bytes",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Size of cached data in bytes for memory usage tracking",
        ),
        sa.Column(
            "compression_ratio",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Compression ratio if data is compressed (0.0-1.0)",
        ),
        sa.Column(
            "parent_cache_keys",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="List of parent cache keys that trigger invalidation of this entry",
        ),
        sa.Column(
            "child_cache_keys",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="List of child cache keys that should be invalidated when this entry changes",
        ),
        sa.Column(
            "invalidation_triggers",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="List of events/operations that should invalidate this cache entry",
        ),
        sa.Column(
            "cache_tags",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Tags for cache organization and batch operations",
        ),
        sa.Column(
            "cache_metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional metadata about the cached content",
        ),
        sa.Column(
            "created_by_user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="User who initiated the cache operation",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache metadata was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache metadata was last updated",
        ),
        sa.CheckConstraint(
            "access_count >= 0", name="ck_cache_metadata_positive_access_count"
        ),
        sa.CheckConstraint(
            "compression_ratio IS NULL OR compression_ratio >= 0.0::double precision AND compression_ratio <= 1.0::double precision",
            name="ck_cache_metadata_valid_compression_ratio",
        ),
        sa.CheckConstraint(
            "hit_count >= 0", name="ck_cache_metadata_positive_hit_count"
        ),
        sa.CheckConstraint(
            "miss_count >= 0", name="ck_cache_metadata_positive_miss_count"
        ),
        sa.CheckConstraint("ttl_seconds > 0", name="ck_cache_metadata_positive_ttl"),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="cache_metadata_client_account_id_fkey",
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["created_by_user_id"],
            ["users.id"],
            name="cache_metadata_created_by_user_id_fkey",
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="cache_metadata_engagement_id_fkey",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name="cache_metadata_pkey"),
        sa.UniqueConstraint(
            "cache_key",
            "client_account_id",
            name="uq_cache_metadata_key_tenant",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_tenant_active"),
        "cache_metadata",
        ["client_account_id", "is_active"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_expiration"),
        "cache_metadata",
        ["expires_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_entity_lookup"),
        "cache_metadata",
        ["entity_type", "entity_id", "client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_client_account_id"),
        "cache_metadata",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_cache_key"),
        "cache_metadata",
        ["cache_key"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_metadata_active_keys"),
        "cache_metadata",
        ["cache_key", "client_account_id"],
        unique=False,
        postgresql_where="(is_active = true)",
    )
    op.create_index(
        op.f("ix_cache_metadata_access_patterns"),
        "cache_metadata",
        ["last_accessed", "access_count"],
        unique=False,
    )
    op.create_table(
        "sixr_decisions",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "decision_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "decision_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("sixr_decisions_engagement_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_decisions_pkey")),
    )
    op.create_table(
        "assets",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("migration_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("discovery_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("assessment_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("planning_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("execution_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "source_phase", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "current_phase", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "phase_context",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column(
            "asset_name", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "hostname", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "asset_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("fqdn", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column(
            "mac_address", sa.VARCHAR(length=17), autoincrement=False, nullable=True
        ),
        sa.Column(
            "environment", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "location", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "datacenter", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "rack_location", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "availability_zone",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "operating_system",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "os_version", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column("cpu_cores", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "memory_gb",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "storage_gb",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "business_owner", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "technical_owner",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "department", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "application_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "technology_stack",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "criticality", sa.VARCHAR(length=20), autoincrement=False, nullable=True
        ),
        sa.Column(
            "business_criticality",
            sa.VARCHAR(length=20),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "custom_attributes",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "six_r_strategy", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "mapping_status", sa.VARCHAR(length=20), autoincrement=False, nullable=True
        ),
        sa.Column(
            "migration_priority", sa.INTEGER(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "migration_complexity",
            sa.VARCHAR(length=20),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("migration_wave", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "sixr_ready", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column("status", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column(
            "migration_status",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "dependencies",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "related_assets",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "discovery_method",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "discovery_source",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "discovery_timestamp",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "cpu_utilization_percent",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "memory_utilization_percent",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "disk_iops",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "network_throughput_mbps",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "completeness_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "quality_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "current_monthly_cost",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_cloud_cost",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("imported_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "imported_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "source_filename",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("raw_data", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "field_mappings_used",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "raw_import_records_id", sa.UUID(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("updated_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "discovery_status",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "discovery_completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "assessment_readiness",
            sa.VARCHAR(length=50),
            server_default=sa.text("'not_ready'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "assessment_readiness_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "assessment_blockers",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "assessment_recommendations",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="A confidence score (0.0-1.0) indicating reliability of asset data.",
        ),
        sa.Column(
            "technical_details",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="A JSON blob containing technical details and enrichments for the asset.",
        ),
        sa.CheckConstraint(
            "hostname IS NOT NULL OR name IS NOT NULL OR ip_address IS NOT NULL",
            name="ck_assets_has_identifier",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_assets_client_account_id_client_accounts",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="fk_assets_engagement_id_engagements",
        ),
        sa.ForeignKeyConstraint(
            ["raw_import_records_id"],
            ["raw_import_records.id"],
            name="fk_assets_raw_import_records_id_raw_import_records",
        ),
        sa.PrimaryKeyConstraint("id", name="pk_assets"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_assets_unique_name_per_context"),
        "assets",
        ["client_account_id", "engagement_id", "name"],
        unique=True,
        postgresql_where="((name IS NOT NULL) AND ((name)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_assets_unique_ip_per_context"),
        "assets",
        ["client_account_id", "engagement_id", "ip_address"],
        unique=True,
        postgresql_where="((ip_address IS NOT NULL) AND ((ip_address)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_assets_unique_hostname_per_context"),
        "assets",
        ["client_account_id", "engagement_id", "hostname"],
        unique=True,
        postgresql_where="((hostname IS NOT NULL) AND ((hostname)::text <> ''::text))",
    )
    op.create_index(
        op.f("ix_assets_discovery_status"), "assets", ["discovery_status"], unique=False
    )
    op.create_index(
        op.f("ix_assets_client_engagement_readiness"),
        "assets",
        ["client_account_id", "engagement_id", "assessment_readiness"],
        unique=False,
    )
    op.create_index(
        op.f("ix_assets_assessment_readiness"),
        "assets",
        ["assessment_readiness"],
        unique=False,
    )
    op.create_index(op.f("idx_assets_type"), "assets", ["asset_type"], unique=False)
    op.create_index(op.f("idx_assets_status"), "assets", ["status"], unique=False)
    op.create_index(
        op.f("idx_assets_created_at_desc"),
        "assets",
        [sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(
        op.f("idx_assets_client_engagement_created"),
        "assets",
        ["client_account_id", "engagement_id", sa.literal_column("created_at DESC")],
        unique=False,
    )
    op.create_index(
        op.f("idx_assets_client_engagement"),
        "assets",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_table(
        "access_audit_log",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "action_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "resource_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "resource_id", sa.VARCHAR(length=36), autoincrement=False, nullable=True
        ),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("result", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "details",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("access_audit_log_pkey")),
    )
    op.create_index(
        op.f("idx_access_audit_log_user_id"),
        "access_audit_log",
        ["user_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_access_audit_log_result"),
        "access_audit_log",
        ["result"],
        unique=False,
    )
    op.create_index(
        op.f("idx_access_audit_log_resource_type"),
        "access_audit_log",
        ["resource_type"],
        unique=False,
    )
    op.create_index(
        op.f("idx_access_audit_log_engagement_id"),
        "access_audit_log",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_access_audit_log_created_at"),
        "access_audit_log",
        ["created_at"],
        unique=False,
    )
    op.create_index(
        op.f("idx_access_audit_log_client_account_id"),
        "access_audit_log",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_access_audit_log_action_type"),
        "access_audit_log",
        ["action_type"],
        unique=False,
    )
    op.create_table(
        "assessments",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "assessment_type",
            postgresql.ENUM(
                "TECHNICAL",
                "BUSINESS",
                "SECURITY",
                "COMPLIANCE",
                "PERFORMANCE",
                name="assessmenttype",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "PENDING",
                "IN_PROGRESS",
                "COMPLETED",
                "REVIEWED",
                "APPROVED",
                "REJECTED",
                name="assessmentstatus",
            ),
            server_default=sa.text("'PENDING'::assessmentstatus"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "risk_level",
            postgresql.ENUM("LOW", "MEDIUM", "HIGH", "CRITICAL", name="risklevel"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("summary", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("recommendations", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "report_url", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_assessments_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_assessments_engagement_id_engagements"),
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name=op.f("fk_assessments_master_flow_id_crewai_flow_state_extensions"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_assessments")),
    )
    op.create_table(
        "sixr_analyses",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("migration_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "in_progress",
                "completed",
                "failed",
                "requires_input",
                name="analysis_status",
            ),
            server_default=sa.text("'pending'::analysis_status"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "priority",
            sa.INTEGER(),
            server_default=sa.text("3"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "application_ids",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "application_data",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "current_iteration",
            sa.INTEGER(),
            server_default=sa.text("1"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "progress_percentage",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'0'::double precision"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "estimated_completion",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "final_recommendation",
            postgresql.ENUM(
                "rehost",
                "replatform",
                "refactor",
                "rearchitect",
                "replace",
                "rewrite",
                name="sixr_strategy",
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "updated_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "analysis_config",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="sixr_analyses_client_account_id_fkey",
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="sixr_analyses_engagement_id_fkey",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name="sixr_analyses_pkey"),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_sixr_analyses_status"), "sixr_analyses", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_sixr_analyses_name"), "sixr_analyses", ["name"], unique=False
    )
    op.create_index(
        op.f("ix_sixr_analyses_engagement_id"),
        "sixr_analyses",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_sixr_analyses_client_account_id"),
        "sixr_analyses",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_analyses_name"), "sixr_analyses", ["name"], unique=False
    )
    op.create_index(
        op.f("ix_migration_sixr_analyses_id"), "sixr_analyses", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_migration_sixr_analyses_engagement_id"),
        "sixr_analyses",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_analyses_client_account_id"),
        "sixr_analyses",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "credential_permissions",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("credential_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("role", sa.VARCHAR(length=50), autoincrement=False, nullable=True),
        sa.Column(
            "permission_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("granted_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "revoked_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("revoked_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.CheckConstraint(
            "user_id IS NOT NULL OR role IS NOT NULL",
            name=op.f("ck_credential_permissions_user_or_role"),
        ),
        sa.ForeignKeyConstraint(
            ["credential_id"],
            ["platform_credentials.id"],
            name=op.f("fk_credential_permissions_credential_id_platform_credentials"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["granted_by"],
            ["users.id"],
            name=op.f("fk_credential_permissions_granted_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["revoked_by"],
            ["users.id"],
            name=op.f("fk_credential_permissions_revoked_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.id"],
            name=op.f("fk_credential_permissions_user_id_users"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_credential_permissions")),
    )
    op.create_index(
        op.f("ix_credential_permissions_user_id"),
        "credential_permissions",
        ["user_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_permissions_role"),
        "credential_permissions",
        ["role"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_permissions_permission_type"),
        "credential_permissions",
        ["permission_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_permissions_credential_id"),
        "credential_permissions",
        ["credential_id"],
        unique=False,
    )
    op.create_table(
        "raw_import_records",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("data_import_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("row_number", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "raw_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "cleansed_data",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_errors",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("processing_notes", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "is_processed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_valid",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("asset_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "processed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_raw_import_records_client_account_id_client_accounts",
        ),
        sa.ForeignKeyConstraint(
            ["data_import_id"],
            ["data_imports.id"],
            name="fk_raw_import_records_data_import_id_data_imports",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="fk_raw_import_records_engagement_id_engagements",
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name="fk_raw_import_records_master_flow_id_crewai_flow_state__e097",
        ),
        sa.PrimaryKeyConstraint("id", name="pk_raw_import_records"),
        postgresql_ignore_search_path=False,
    )
    op.create_table(
        "failure_journal",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("source", sa.VARCHAR(length=64), autoincrement=False, nullable=False),
        sa.Column(
            "operation", sa.VARCHAR(length=128), autoincrement=False, nullable=False
        ),
        sa.Column(
            "payload",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("trace", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "retry_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("failure_journal_pkey")),
    )
    op.create_table(
        "collection_questionnaire_responses",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("gap_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "questionnaire_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "question_category",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "question_id", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column("question_text", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column(
            "response_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "response_value",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("responded_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "responded_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "asset_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="Foreign key to the asset this questionnaire response is about",
        ),
        sa.ForeignKeyConstraint(
            ["asset_id"],
            ["assets.id"],
            name=op.f("collection_questionnaire_responses_asset_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name=op.f("fk_collection_questionnaire_responses_collection_flow_i_b007"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["gap_id"],
            ["collection_data_gaps.id"],
            name=op.f("fk_collection_questionnaire_responses_gap_id_collection_0417"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["responded_by"],
            ["users.id"],
            name=op.f("fk_collection_questionnaire_responses_responded_by_users"),
        ),
        sa.PrimaryKeyConstraint(
            "id", name=op.f("pk_collection_questionnaire_responses")
        ),
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_validation_status"),
        "collection_questionnaire_responses",
        ["validation_status"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_questionnaire_type"),
        "collection_questionnaire_responses",
        ["questionnaire_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_question_category"),
        "collection_questionnaire_responses",
        ["question_category"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_gap_id"),
        "collection_questionnaire_responses",
        ["gap_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_flow_asset"),
        "collection_questionnaire_responses",
        ["collection_flow_id", "asset_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_collection_flow_id"),
        "collection_questionnaire_responses",
        ["collection_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_questionnaire_responses_asset_id"),
        "collection_questionnaire_responses",
        ["asset_id"],
        unique=False,
    )
    op.create_table(
        "adaptive_questionnaires",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "template_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "template_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "version",
            sa.VARCHAR(length=20),
            server_default=sa.text("'1.0'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "applicable_tiers",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "question_set",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "question_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "estimated_completion_time",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "gap_categories",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "platform_types",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "data_domains",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "scoring_rules",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "validation_rules",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "usage_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "success_rate",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "is_template",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("title", sa.VARCHAR(length=255), autoincrement=False, nullable=True),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "target_gaps",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "questions",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "completion_status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "responses_collected",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_adaptive_questionnaires_client_account_id_client_accounts"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name=op.f("fk_adaptive_questionnaires_collection_flow_id_collection_flows"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_adaptive_questionnaires_engagement_id_engagements"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_adaptive_questionnaires")),
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_template_type"),
        "adaptive_questionnaires",
        ["template_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_id"),
        "adaptive_questionnaires",
        ["id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_engagement_id"),
        "adaptive_questionnaires",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_collection_flow_id"),
        "adaptive_questionnaires",
        ["collection_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_adaptive_questionnaires_client_account_id"),
        "adaptive_questionnaires",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "user_account_associations",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("role", sa.VARCHAR(length=50), autoincrement=False, nullable=False),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_user_account_associations_client_account_id_client_accounts"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["users.id"],
            name=op.f("fk_user_account_associations_created_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.id"],
            name=op.f("fk_user_account_associations_user_id_users"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_user_account_associations")),
        sa.UniqueConstraint(
            "user_id",
            "client_account_id",
            name=op.f("_user_client_account_uc"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
    )
    op.create_index(
        op.f("ix_user_account_associations_user_id"),
        "user_account_associations",
        ["user_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_user_account_associations_client_account_id"),
        "user_account_associations",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "cache_performance_logs",
        sa.Column(
            "id",
            sa.INTEGER(),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the performance log entry",
        ),
        sa.Column(
            "cache_metadata_id",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Reference to the cache metadata entry",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account for tenant isolation",
        ),
        sa.Column(
            "operation_type",
            sa.VARCHAR(length=20),
            autoincrement=False,
            nullable=False,
            comment="Type of cache operation (GET, SET, DELETE, INVALIDATE)",
        ),
        sa.Column(
            "was_hit",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether the cache operation resulted in a hit",
        ),
        sa.Column(
            "response_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
            comment="Response time for the cache operation in milliseconds",
        ),
        sa.Column(
            "data_size_bytes",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Size of data involved in the operation",
        ),
        sa.Column(
            "endpoint",
            sa.VARCHAR(length=200),
            autoincrement=False,
            nullable=True,
            comment="API endpoint that triggered the cache operation",
        ),
        sa.Column(
            "user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="User who initiated the operation",
        ),
        sa.Column(
            "session_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
            comment="Session identifier for request correlation",
        ),
        sa.Column(
            "error_message",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Error message if operation failed",
        ),
        sa.Column(
            "error_code",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Error code for categorization",
        ),
        sa.Column(
            "redis_memory_usage_mb",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Redis memory usage at time of operation",
        ),
        sa.Column(
            "concurrent_operations",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Number of concurrent cache operations",
        ),
        sa.Column(
            "operation_metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional operation metadata",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the performance log was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the performance log was last updated",
        ),
        sa.CheckConstraint(
            "operation_type::text = ANY (ARRAY['GET'::character varying, 'SET'::character varying, 'DELETE'::character varying, 'INVALIDATE'::character varying, 'EXISTS'::character varying]::text[])",
            name=op.f("ck_cache_perf_valid_operation_type"),
        ),
        sa.CheckConstraint(
            "response_time_ms >= 0::double precision",
            name=op.f("ck_cache_perf_positive_response_time"),
        ),
        sa.ForeignKeyConstraint(
            ["cache_metadata_id"],
            ["migration.cache_metadata.id"],
            name=op.f("cache_performance_logs_cache_metadata_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
            name=op.f("cache_performance_logs_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["migration.users.id"],
            name=op.f("cache_performance_logs_user_id_fkey"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("cache_performance_logs_pkey")),
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_perf_time_series"),
        "cache_performance_logs",
        ["created_at", "operation_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_perf_tenant_analytics"),
        "cache_performance_logs",
        ["client_account_id", "created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_perf_metadata_lookup"),
        "cache_performance_logs",
        ["cache_metadata_id", "created_at"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "cache_configurations",
        sa.Column(
            "id",
            sa.INTEGER(),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the cache configuration",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account this configuration applies to",
        ),
        sa.Column(
            "cache_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether caching is enabled for this client",
        ),
        sa.Column(
            "distributed_cache_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether distributed caching features are enabled",
        ),
        sa.Column(
            "cache_analytics_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether cache analytics and logging are enabled",
        ),
        sa.Column(
            "user_context_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for user context cache entries",
        ),
        sa.Column(
            "field_mapping_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for field mapping cache entries",
        ),
        sa.Column(
            "flow_state_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for flow state cache entries",
        ),
        sa.Column(
            "agent_results_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for agent execution results",
        ),
        sa.Column(
            "max_cache_size_mb",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Maximum cache size for this client in MB",
        ),
        sa.Column(
            "eviction_policy",
            sa.VARCHAR(length=20),
            autoincrement=False,
            nullable=False,
            comment="Cache eviction policy (LRU, LFU, TTL)",
        ),
        sa.Column(
            "encryption_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether sensitive cache data should be encrypted",
        ),
        sa.Column(
            "pii_cache_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether PII data can be cached",
        ),
        sa.Column(
            "custom_settings",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Client-specific custom cache settings",
        ),
        sa.Column(
            "alert_hit_ratio_threshold",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Alert when hit ratio falls below this threshold",
        ),
        sa.Column(
            "alert_response_time_threshold_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Alert when average response time exceeds this threshold",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache configuration was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache configuration was last updated",
        ),
        sa.CheckConstraint(
            "eviction_policy::text = ANY (ARRAY['LRU'::character varying, 'LFU'::character varying, 'TTL'::character varying, 'RANDOM'::character varying]::text[])",
            name=op.f("ck_cache_config_valid_eviction_policy"),
        ),
        sa.CheckConstraint(
            "alert_hit_ratio_threshold IS NULL OR alert_hit_ratio_threshold >= 0.0::double precision AND alert_hit_ratio_threshold <= 1.0::double precision",
            name=op.f("ck_cache_config_valid_hit_ratio_threshold"),
        ),
        sa.CheckConstraint(
            "max_cache_size_mb IS NULL OR max_cache_size_mb > 0",
            name=op.f("ck_cache_config_positive_max_size"),
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
            name=op.f("cache_configurations_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("cache_configurations_pkey")),
        sa.UniqueConstraint(
            "client_account_id",
            name=op.f("uq_cache_config_client"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        schema="migration",
    )
    op.create_table(
        "engagement_access",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_profile_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "access_level", sa.VARCHAR(length=20), autoincrement=False, nullable=False
        ),
        sa.Column(
            "engagement_role",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "permissions",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"can_view_data": true, "can_import_data": false, "can_export_data": false, "can_manage_sessions": false, "can_configure_agents": false, "can_approve_migration_decisions": false, "can_access_sensitive_data": false}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "restricted_sessions",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'[]'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "allowed_session_types",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text('\'["data_import", "validation_run"]\'::json'),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "granted_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("granted_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_accessed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "access_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_engagement_access_engagement_id_engagements"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["granted_by"],
            ["users.id"],
            name=op.f("fk_engagement_access_granted_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["user_profile_id"],
            ["user_profiles.user_id"],
            name=op.f("fk_engagement_access_user_profile_id_user_profiles"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_engagement_access")),
    )
    op.create_index(
        op.f("ix_engagement_access_user_profile_id"),
        "engagement_access",
        ["user_profile_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_engagement_access_is_active"),
        "engagement_access",
        ["is_active"],
        unique=False,
    )
    op.create_index(
        op.f("ix_engagement_access_id"), "engagement_access", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_engagement_access_engagement_id"),
        "engagement_access",
        ["engagement_id"],
        unique=False,
    )
    op.create_table(
        "collection_flow_applications",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("asset_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "application_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "discovery_data_snapshot",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Snapshot of Discovery data at the time of Collection flow creation",
        ),
        sa.Column(
            "gap_analysis_result",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Result of gap analysis for this specific application",
        ),
        sa.Column(
            "collection_status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=False,
            comment="Status of data collection for this application: pending, in_progress, completed, failed",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "canonical_application_id", sa.UUID(), autoincrement=False, nullable=True
        ),
        sa.Column("name_variant_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "deduplication_method",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "match_confidence",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["asset_id"],
            ["assets.id"],
            name=op.f("collection_flow_applications_asset_id_fkey"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["canonical_application_id"],
            ["canonical_applications.id"],
            name=op.f("fk_collection_flow_apps_canonical"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name=op.f("collection_flow_applications_collection_flow_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["name_variant_id"],
            ["application_name_variants.id"],
            name=op.f("fk_collection_flow_apps_variant"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("collection_flow_applications_pkey")),
        comment="Links Collection flows to selected applications from Discovery, tracking per-app collection status",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_variant_rel"),
        "collection_flow_applications",
        ["name_variant_id", "collection_flow_id"],
        unique=False,
        postgresql_where="(name_variant_id IS NOT NULL)",
    )
    op.create_index(
        op.f("idx_collection_flow_apps_tenant_security"),
        "collection_flow_applications",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_collection_flow_apps_status"),
        "collection_flow_applications",
        ["collection_status"],
        unique=False,
    )
    op.create_index(
        op.f("idx_collection_flow_apps_canonical_rel"),
        "collection_flow_applications",
        ["canonical_application_id", "collection_flow_id", "collection_status"],
        unique=False,
    )
    op.create_index(
        op.f("idx_collection_flow_apps_canonical"),
        "collection_flow_applications",
        ["canonical_application_id", "collection_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_collection_flow_apps"),
        "collection_flow_applications",
        ["collection_flow_id", "application_name"],
        unique=False,
    )
    op.create_table(
        "agent_discovered_patterns",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
            comment="Unique identifier for the discovered pattern",
        ),
        sa.Column(
            "pattern_id",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Unique identifier for the pattern",
        ),
        sa.Column(
            "pattern_type",
            postgresql.ENUM(
                "technology_correlation",
                "business_value_indicator",
                "risk_factor",
                "modernization_opportunity",
                "dependency_pattern",
                "security_vulnerability",
                "performance_bottleneck",
                "compliance_requirement",
                "field_mapping_approval",
                "field_mapping_rejection",
                "field_mapping_suggestion",
                name="patterntype",
            ),
            autoincrement=False,
            nullable=False,
            comment="Type of pattern discovered",
        ),
        sa.Column(
            "pattern_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Human-readable name of the pattern",
        ),
        sa.Column(
            "pattern_description",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Detailed description of the pattern",
        ),
        sa.Column(
            "discovered_by_agent",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
            comment="Agent that discovered this pattern",
        ),
        sa.Column(
            "confidence_score",
            sa.NUMERIC(precision=3, scale=2),
            autoincrement=False,
            nullable=False,
            comment="Confidence score of the pattern (0-1)",
        ),
        sa.Column(
            "evidence_count",
            sa.INTEGER(),
            server_default=sa.text("1"),
            autoincrement=False,
            nullable=False,
            comment="Number of instances supporting this pattern",
        ),
        sa.Column(
            "times_referenced",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Number of times this pattern has been referenced",
        ),
        sa.Column(
            "pattern_data",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
            comment="Detailed pattern data and parameters",
        ),
        sa.Column(
            "task_id",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
            comment="Task ID where pattern was discovered",
        ),
        sa.Column(
            "execution_context",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
            comment="Context in which pattern was discovered",
        ),
        sa.Column(
            "user_feedback_given",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
            comment="Whether user has provided feedback on this pattern",
        ),
        sa.Column(
            "pattern_effectiveness_score",
            sa.NUMERIC(precision=3, scale=2),
            autoincrement=False,
            nullable=True,
            comment="Effectiveness score based on usage and feedback (0-1)",
        ),
        sa.Column(
            "last_used_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
            comment="Last time this pattern was used",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account this pattern belongs to",
        ),
        sa.Column(
            "engagement_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Engagement this pattern is part of",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
            comment="When this pattern was discovered",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
            comment="When this record was last updated",
        ),
        sa.Column(
            "embedding",
            postgresql.ARRAY(sa.DOUBLE_PRECISION(precision=53)),
            autoincrement=False,
            nullable=True,
            comment="Vector embedding for similarity search",
        ),
        sa.Column(
            "insight_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Structured classification of the pattern type",
        ),
        sa.Column(
            "evidence_assets",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'[]'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "supporting_data",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.CheckConstraint(
            "insight_type IS NULL OR (insight_type::text = ANY (ARRAY['field_mapping_suggestion'::character varying, 'risk_pattern'::character varying, 'optimization_opportunity'::character varying, 'anomaly_detection'::character varying, 'workflow_improvement'::character varying, 'dependency_pattern'::character varying, 'performance_pattern'::character varying, 'error_pattern'::character varying]::text[]))",
            name=op.f("ck_agent_patterns_insight_type"),
        ),
        sa.CheckConstraint(
            "confidence_score >= 0::numeric AND confidence_score <= 1::numeric",
            name=op.f("chk_agent_discovered_patterns_confidence_score"),
        ),
        sa.CheckConstraint(
            "pattern_effectiveness_score >= 0::numeric AND pattern_effectiveness_score <= 1::numeric",
            name=op.f("chk_agent_discovered_patterns_effectiveness_score"),
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_agent_discovered_patterns_client_account_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_agent_discovered_patterns_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_agent_discovered_patterns_engagement_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_agent_discovered_patterns_engagement_id_engagements"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_agent_discovered_patterns")),
        sa.UniqueConstraint(
            "pattern_id",
            "client_account_id",
            "engagement_id",
            name=op.f("uq_agent_discovered_patterns_pattern_client_engagement"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        comment="Patterns discovered by agents during task execution for learning and optimization",
    )
    op.create_index(
        op.f("ix_agent_patterns_insight_type"),
        "agent_discovered_patterns",
        ["insight_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_patterns_client_insight_type"),
        "agent_discovered_patterns",
        ["client_account_id", "insight_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_pattern_type"),
        "agent_discovered_patterns",
        ["pattern_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_pattern_id"),
        "agent_discovered_patterns",
        ["pattern_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_confidence"),
        "agent_discovered_patterns",
        [sa.literal_column("confidence_score DESC")],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_client"),
        "agent_discovered_patterns",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_discovered_patterns_agent"),
        "agent_discovered_patterns",
        ["discovered_by_agent"],
        unique=False,
    )
    op.create_table(
        "collection_gap_analysis",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "total_fields_required",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "fields_collected",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "fields_missing",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "completeness_percentage",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("0.0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "data_quality_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_level",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "automation_coverage",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "critical_gaps",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "optional_gaps",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "gap_categories",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "recommended_actions",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "questionnaire_requirements",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "analyzed_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_collection_gap_analysis_client_account_id_client_accounts"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name=op.f("fk_collection_gap_analysis_collection_flow_id_collection_flows"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_collection_gap_analysis_engagement_id_engagements"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_collection_gap_analysis")),
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_id"),
        "collection_gap_analysis",
        ["id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_engagement_id"),
        "collection_gap_analysis",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_collection_flow_id"),
        "collection_gap_analysis",
        ["collection_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_gap_analysis_client_account_id"),
        "collection_gap_analysis",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "asset_dependencies",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("asset_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "depends_on_asset_id", sa.UUID(), autoincrement=False, nullable=False
        ),
        sa.Column("dependency_type", sa.VARCHAR(), autoincrement=False, nullable=True),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["asset_id"],
            ["assets.id"],
            name=op.f("asset_dependencies_asset_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["depends_on_asset_id"],
            ["assets.id"],
            name=op.f("asset_dependencies_depends_on_asset_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("asset_dependencies_pkey")),
        sa.UniqueConstraint(
            "asset_id",
            "depends_on_asset_id",
            name=op.f("uq_asset_dependencies_asset_depends_on"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
    )
    op.create_index(
        op.f("idx_asset_dependencies_type"),
        "asset_dependencies",
        ["dependency_type"],
        unique=False,
    )
    op.create_index(
        op.f("idx_asset_dependencies_depends_on_asset_id"),
        "asset_dependencies",
        ["depends_on_asset_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_asset_dependencies_asset_id"),
        "asset_dependencies",
        ["asset_id"],
        unique=False,
    )
    op.create_table(
        "agent_performance_daily",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
            comment="Unique identifier for the daily performance record",
        ),
        sa.Column(
            "agent_name",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
            comment="Name of the agent",
        ),
        sa.Column(
            "date_recorded",
            sa.DATE(),
            autoincrement=False,
            nullable=False,
            comment="Date for which metrics are aggregated",
        ),
        sa.Column(
            "tasks_attempted",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Total number of tasks attempted",
        ),
        sa.Column(
            "tasks_completed",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Number of successfully completed tasks",
        ),
        sa.Column(
            "tasks_failed",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Number of failed tasks",
        ),
        sa.Column(
            "avg_duration_seconds",
            sa.NUMERIC(precision=10, scale=3),
            autoincrement=False,
            nullable=True,
            comment="Average task duration in seconds",
        ),
        sa.Column(
            "avg_confidence_score",
            sa.NUMERIC(precision=3, scale=2),
            autoincrement=False,
            nullable=True,
            comment="Average confidence score across all tasks",
        ),
        sa.Column(
            "total_llm_calls",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Total LLM API calls made",
        ),
        sa.Column(
            "total_tokens_used",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
            comment="Total tokens consumed",
        ),
        sa.Column(
            "success_rate",
            sa.NUMERIC(precision=5, scale=2),
            autoincrement=False,
            nullable=True,
            comment="Success rate percentage (0-100)",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account these metrics belong to",
        ),
        sa.Column(
            "engagement_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Engagement these metrics are part of",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
            comment="When this record was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
            comment="When this record was last updated",
        ),
        sa.CheckConstraint(
            "success_rate >= 0::numeric AND success_rate <= 100::numeric",
            name=op.f("chk_agent_performance_daily_success_rate"),
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_agent_performance_daily_client_account_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_agent_performance_daily_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_agent_performance_daily_engagement_id"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("fk_agent_performance_daily_engagement_id_engagements"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_agent_performance_daily")),
        sa.UniqueConstraint(
            "agent_name",
            "date_recorded",
            "client_account_id",
            "engagement_id",
            name=op.f("uq_agent_performance_daily_agent_date_client_engagement"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        comment="Daily aggregated performance metrics for each agent",
    )
    op.create_index(
        op.f("ix_agent_performance_daily_date"),
        "agent_performance_daily",
        ["date_recorded"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_performance_daily_client"),
        "agent_performance_daily",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_agent_performance_daily_agent"),
        "agent_performance_daily",
        ["agent_name", sa.literal_column("date_recorded DESC")],
        unique=False,
    )
    op.create_table(
        "client_access",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_profile_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "access_level", sa.VARCHAR(length=20), autoincrement=False, nullable=False
        ),
        sa.Column(
            "permissions",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"can_view_data": true, "can_import_data": false, "can_export_data": false, "can_manage_engagements": false, "can_configure_client_settings": false, "can_manage_client_users": false}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "restricted_environments",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'[]'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "restricted_data_types",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'[]'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "granted_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("granted_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_accessed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "access_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_client_access_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["granted_by"], ["users.id"], name=op.f("fk_client_access_granted_by_users")
        ),
        sa.ForeignKeyConstraint(
            ["user_profile_id"],
            ["user_profiles.user_id"],
            name=op.f("fk_client_access_user_profile_id_user_profiles"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_client_access")),
    )
    op.create_table(
        "application_name_variants",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "canonical_application_id", sa.UUID(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "variant_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "normalized_variant",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "variant_hash", sa.VARCHAR(length=64), autoincrement=False, nullable=False
        ),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "variant_embedding",
            pgvector.sqlalchemy.vector.VECTOR(dim=384),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "similarity_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Cosine similarity score to canonical name embedding (0.0-1.0)",
        ),
        sa.Column(
            "match_method",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="How this variant was matched: exact, fuzzy_text, vector_similarity, manual_verification",
        ),
        sa.Column(
            "match_confidence",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("usage_count", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "first_seen_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "last_used_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["canonical_application_id"],
            ["canonical_applications.id"],
            name=op.f("application_name_variants_canonical_application_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("application_name_variants_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("application_name_variants_engagement_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("application_name_variants_pkey")),
        comment="All name variations that resolve to canonical applications, with similarity metrics",
    )
    op.create_index(
        op.f("ix_migration_application_name_variants_variant_hash"),
        "application_name_variants",
        ["variant_hash"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_application_name_variants_normalized_variant"),
        "application_name_variants",
        ["normalized_variant"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_application_name_variants_engagement_id"),
        "application_name_variants",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_application_name_variants_client_account_id"),
        "application_name_variants",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_vector_similarity"),
        "application_name_variants",
        ["variant_embedding"],
        unique=False,
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.create_index(
        op.f("idx_app_variants_usage_stats"),
        "application_name_variants",
        [
            sa.literal_column("usage_count DESC"),
            sa.literal_column("last_used_at DESC"),
            "canonical_application_id",
        ],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_tenant_security"),
        "application_name_variants",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_tenant_isolation"),
        "application_name_variants",
        ["client_account_id", "engagement_id", "normalized_variant"],
        unique=True,
    )
    op.create_index(
        op.f("idx_app_variants_normalized_pattern"),
        "application_name_variants",
        ["normalized_variant", "client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_lookup_optimization"),
        "application_name_variants",
        [
            "client_account_id",
            "engagement_id",
            "normalized_variant",
            "canonical_application_id",
        ],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_hash_lookup"),
        "application_name_variants",
        ["variant_hash", "client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_hash_exact_match"),
        "application_name_variants",
        ["variant_hash", "client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_app_variants_canonical_rel"),
        "application_name_variants",
        [
            "canonical_application_id",
            sa.literal_column("match_confidence DESC"),
            sa.literal_column("similarity_score DESC"),
        ],
        unique=False,
    )
    op.create_table(
        "user_roles",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "role_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "role_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "permissions",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "scope_type", sa.VARCHAR(length=20), autoincrement=False, nullable=True
        ),
        sa.Column("scope_client_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("scope_engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("is_active", sa.BOOLEAN(), autoincrement=False, nullable=True),
        sa.Column(
            "assigned_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("assigned_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["assigned_by"], ["users.id"], name=op.f("fk_user_roles_assigned_by_users")
        ),
        sa.ForeignKeyConstraint(
            ["scope_client_id"],
            ["client_accounts.id"],
            name=op.f("fk_user_roles_scope_client_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["scope_engagement_id"],
            ["engagements.id"],
            name=op.f("fk_user_roles_scope_engagement_id_engagements"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.id"],
            name=op.f("fk_user_roles_user_id_users"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_user_roles")),
    )
    op.create_index(
        op.f("ix_user_roles_user_id"), "user_roles", ["user_id"], unique=False
    )
    op.create_index(
        op.f("ix_user_roles_is_active"), "user_roles", ["is_active"], unique=False
    )
    op.create_index(op.f("ix_user_roles_id"), "user_roles", ["id"], unique=False)
    op.create_table(
        "data_imports",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "import_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "import_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "filename", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column("file_size", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "mime_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "source_system", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "progress_percentage",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'0'::double precision"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("total_records", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column(
            "processed_records",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "failed_records",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("imported_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "error_details",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "started_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_data_imports_client_account_id_client_accounts",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="fk_data_imports_engagement_id_engagements",
        ),
        sa.ForeignKeyConstraint(
            ["imported_by"], ["users.id"], name="fk_data_imports_imported_by_users"
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name="fk_data_imports_master_flow_id_crewai_flow_state_extensions",
            initially="DEFERRED",
            deferrable=True,
        ),
        sa.PrimaryKeyConstraint("id", name="pk_data_imports"),
        postgresql_ignore_search_path=False,
    )
    op.create_table(
        "tech_debt_analysis",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "analysis_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "analysis_results",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["migration.engagements.id"],
            name=op.f("tech_debt_analysis_engagement_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("tech_debt_analysis_pkey")),
        schema="migration",
    )
    op.create_table(
        "cache_configurations",
        sa.Column(
            "id",
            sa.INTEGER(),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the cache configuration",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account this configuration applies to",
        ),
        sa.Column(
            "cache_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether caching is enabled for this client",
        ),
        sa.Column(
            "distributed_cache_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether distributed caching features are enabled",
        ),
        sa.Column(
            "cache_analytics_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether cache analytics and logging are enabled",
        ),
        sa.Column(
            "user_context_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for user context cache entries",
        ),
        sa.Column(
            "field_mapping_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for field mapping cache entries",
        ),
        sa.Column(
            "flow_state_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for flow state cache entries",
        ),
        sa.Column(
            "agent_results_ttl",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Custom TTL for agent execution results",
        ),
        sa.Column(
            "max_cache_size_mb",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Maximum cache size for this client in MB",
        ),
        sa.Column(
            "eviction_policy",
            sa.VARCHAR(length=20),
            autoincrement=False,
            nullable=False,
            comment="Cache eviction policy (LRU, LFU, TTL)",
        ),
        sa.Column(
            "encryption_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether sensitive cache data should be encrypted",
        ),
        sa.Column(
            "pii_cache_enabled",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether PII data can be cached",
        ),
        sa.Column(
            "custom_settings",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Client-specific custom cache settings",
        ),
        sa.Column(
            "alert_hit_ratio_threshold",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Alert when hit ratio falls below this threshold",
        ),
        sa.Column(
            "alert_response_time_threshold_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Alert when average response time exceeds this threshold",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache configuration was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the cache configuration was last updated",
        ),
        sa.CheckConstraint(
            "eviction_policy::text = ANY (ARRAY['LRU'::character varying, 'LFU'::character varying, 'TTL'::character varying, 'RANDOM'::character varying]::text[])",
            name=op.f("ck_cache_config_valid_eviction_policy"),
        ),
        sa.CheckConstraint(
            "alert_hit_ratio_threshold IS NULL OR alert_hit_ratio_threshold >= 0.0::double precision AND alert_hit_ratio_threshold <= 1.0::double precision",
            name=op.f("ck_cache_config_valid_hit_ratio_threshold"),
        ),
        sa.CheckConstraint(
            "max_cache_size_mb IS NULL OR max_cache_size_mb > 0",
            name=op.f("ck_cache_config_positive_max_size"),
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("cache_configurations_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("cache_configurations_pkey")),
        sa.UniqueConstraint(
            "client_account_id",
            name=op.f("uq_cache_config_client"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
    )
    op.create_table(
        "enhanced_access_audit_log",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "action_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "resource_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "resource_id", sa.VARCHAR(length=36), autoincrement=False, nullable=True
        ),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("result", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "request_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "performance_metrics",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "security_context",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("enhanced_access_audit_log_pkey")),
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_user_id"),
        "enhanced_access_audit_log",
        ["user_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_result"),
        "enhanced_access_audit_log",
        ["result"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_resource_type"),
        "enhanced_access_audit_log",
        ["resource_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_engagement_id"),
        "enhanced_access_audit_log",
        ["engagement_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_created_at"),
        "enhanced_access_audit_log",
        ["created_at"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_client_account_id"),
        "enhanced_access_audit_log",
        ["client_account_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_action_type"),
        "enhanced_access_audit_log",
        ["action_type"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "import_field_mappings",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("data_import_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "source_field", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "target_field", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "match_type",
            sa.VARCHAR(length=50),
            server_default=sa.text("'direct'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'suggested'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "suggested_by",
            sa.VARCHAR(length=50),
            server_default=sa.text("'ai_mapper'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "approved_by", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "approved_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "transformation_rules",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "field_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Data type of the field (e.g., string, number, date)",
        ),
        sa.Column(
            "agent_reasoning",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="AI agent reasoning for the mapping suggestion",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_import_field_mappings_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["data_import_id"],
            ["data_imports.id"],
            name=op.f("fk_import_field_mappings_data_import_id_data_imports"),
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name=op.f("fk_import_field_mappings_master_flow_id_crewai_flow_sta_59e6"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_import_field_mappings")),
    )
    op.create_table(
        "platform_credentials",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "platform_adapter_id", sa.UUID(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "credential_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "credential_type",
            postgresql.ENUM(
                "api_key",
                "oauth2",
                "basic_auth",
                "service_account",
                "certificate",
                "ssh_key",
                "custom",
                name="credentialtype",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "vault_provider",
            postgresql.ENUM(
                "local",
                "aws_kms",
                "azure_keyvault",
                "gcp_kms",
                "hashicorp_vault",
                name="vaultprovider",
            ),
            server_default=sa.text("'local'::vaultprovider"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "vault_reference",
            sa.VARCHAR(length=500),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("encrypted_data", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column(
            "encryption_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "credential_metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "active",
                "expired",
                "revoked",
                "pending_rotation",
                name="credentialstatus",
            ),
            server_default=sa.text("'active'::credentialstatus"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_rotated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_validated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_errors",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("updated_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "encryption_algorithm",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "key_rotation_required",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_rotation_checked_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.CheckConstraint(
            "encryption_algorithm::text = ANY (ARRAY['AES-256-GCM'::character varying, 'AES-256-CBC'::character varying, 'RSA-4096'::character varying, 'ChaCha20-Poly1305'::character varying]::text[])",
            name="ck_encryption_algorithm",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_platform_credentials_client_account_id_client_accounts",
        ),
        sa.ForeignKeyConstraint(
            ["created_by"],
            ["users.id"],
            name="fk_platform_credentials_created_by_users",
        ),
        sa.ForeignKeyConstraint(
            ["platform_adapter_id"],
            ["platform_adapters.id"],
            name="fk_platform_credentials_platform_adapter_id_platform_adapters",
        ),
        sa.ForeignKeyConstraint(
            ["updated_by"],
            ["users.id"],
            name="fk_platform_credentials_updated_by_users",
        ),
        sa.PrimaryKeyConstraint("id", name="pk_platform_credentials"),
        sa.UniqueConstraint(
            "client_account_id",
            "platform_adapter_id",
            "credential_name",
            name="_client_platform_credential_uc",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_platform_credentials_status"),
        "platform_credentials",
        ["status"],
        unique=False,
    )
    op.create_index(
        op.f("ix_platform_credentials_platform_adapter_id"),
        "platform_credentials",
        ["platform_adapter_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_platform_credentials_expires_at"),
        "platform_credentials",
        ["expires_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_platform_credentials_credential_type"),
        "platform_credentials",
        ["credential_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_platform_credentials_client_account_id"),
        "platform_credentials",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "credential_access_logs",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("credential_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("accessed_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "access_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column("access_purpose", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "success",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "accessed_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["accessed_by"],
            ["users.id"],
            name=op.f("fk_credential_access_logs_accessed_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name=op.f("fk_credential_access_logs_collection_flow_id_collection_flows"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["credential_id"],
            ["platform_credentials.id"],
            name=op.f("fk_credential_access_logs_credential_id_platform_credentials"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_credential_access_logs")),
    )
    op.create_index(
        op.f("ix_credential_access_logs_success"),
        "credential_access_logs",
        ["success"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_access_logs_credential_id"),
        "credential_access_logs",
        ["credential_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_access_logs_accessed_by"),
        "credential_access_logs",
        ["accessed_by"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_access_logs_accessed_at"),
        "credential_access_logs",
        ["accessed_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_access_logs_access_type"),
        "credential_access_logs",
        ["access_type"],
        unique=False,
    )
    op.create_table(
        "cache_performance_logs",
        sa.Column(
            "id",
            sa.INTEGER(),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the performance log entry",
        ),
        sa.Column(
            "cache_metadata_id",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Reference to the cache metadata entry",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account for tenant isolation",
        ),
        sa.Column(
            "operation_type",
            sa.VARCHAR(length=20),
            autoincrement=False,
            nullable=False,
            comment="Type of cache operation (GET, SET, DELETE, INVALIDATE)",
        ),
        sa.Column(
            "was_hit",
            sa.BOOLEAN(),
            autoincrement=False,
            nullable=False,
            comment="Whether the cache operation resulted in a hit",
        ),
        sa.Column(
            "response_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
            comment="Response time for the cache operation in milliseconds",
        ),
        sa.Column(
            "data_size_bytes",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Size of data involved in the operation",
        ),
        sa.Column(
            "endpoint",
            sa.VARCHAR(length=200),
            autoincrement=False,
            nullable=True,
            comment="API endpoint that triggered the cache operation",
        ),
        sa.Column(
            "user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="User who initiated the operation",
        ),
        sa.Column(
            "session_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
            comment="Session identifier for request correlation",
        ),
        sa.Column(
            "error_message",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Error message if operation failed",
        ),
        sa.Column(
            "error_code",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Error code for categorization",
        ),
        sa.Column(
            "redis_memory_usage_mb",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Redis memory usage at time of operation",
        ),
        sa.Column(
            "concurrent_operations",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Number of concurrent cache operations",
        ),
        sa.Column(
            "operation_metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional operation metadata",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the performance log was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the performance log was last updated",
        ),
        sa.CheckConstraint(
            "operation_type::text = ANY (ARRAY['GET'::character varying, 'SET'::character varying, 'DELETE'::character varying, 'INVALIDATE'::character varying, 'EXISTS'::character varying]::text[])",
            name=op.f("ck_cache_perf_valid_operation_type"),
        ),
        sa.CheckConstraint(
            "response_time_ms >= 0::double precision",
            name=op.f("ck_cache_perf_positive_response_time"),
        ),
        sa.ForeignKeyConstraint(
            ["cache_metadata_id"],
            ["cache_metadata.id"],
            name=op.f("cache_performance_logs_cache_metadata_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("cache_performance_logs_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.id"],
            name=op.f("cache_performance_logs_user_id_fkey"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("cache_performance_logs_pkey")),
    )
    op.create_index(
        op.f("ix_cache_perf_time_series"),
        "cache_performance_logs",
        ["created_at", "operation_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_perf_tenant_analytics"),
        "cache_performance_logs",
        ["client_account_id", "created_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_perf_metadata_lookup"),
        "cache_performance_logs",
        ["cache_metadata_id", "created_at"],
        unique=False,
    )
    op.create_table(
        "tech_debt_analysis",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "analysis_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "analysis_results",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("tech_debt_analysis_engagement_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("tech_debt_analysis_pkey")),
    )
    op.create_table(
        "enhanced_access_audit_log",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "action_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "resource_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "resource_id", sa.VARCHAR(length=36), autoincrement=False, nullable=True
        ),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("result", sa.VARCHAR(length=20), autoincrement=False, nullable=False),
        sa.Column("reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "request_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "performance_metrics",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "security_context",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("enhanced_access_audit_log_pkey")),
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_user_id"),
        "enhanced_access_audit_log",
        ["user_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_result"),
        "enhanced_access_audit_log",
        ["result"],
        unique=False,
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_resource_type"),
        "enhanced_access_audit_log",
        ["resource_type"],
        unique=False,
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_engagement_id"),
        "enhanced_access_audit_log",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_created_at"),
        "enhanced_access_audit_log",
        ["created_at"],
        unique=False,
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_client_account_id"),
        "enhanced_access_audit_log",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_enhanced_access_audit_log_action_type"),
        "enhanced_access_audit_log",
        ["action_type"],
        unique=False,
    )
    op.create_table(
        "sixr_iterations",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("analysis_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "iteration_number", sa.INTEGER(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "iteration_name", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column("iteration_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "stakeholder_feedback", sa.TEXT(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "parameter_changes",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "question_responses",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "recommendation_data",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "analysis_duration",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "agent_insights",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "in_progress",
                "completed",
                "failed",
                "requires_input",
                name="analysis_status",
            ),
            server_default=sa.text("'pending'::analysis_status"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "error_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
            name=op.f("sixr_iterations_analysis_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_iterations_pkey")),
    )
    op.create_index(
        op.f("ix_sixr_iterations_analysis_id"),
        "sixr_iterations",
        ["analysis_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_iterations_id"), "sixr_iterations", ["id"], unique=False
    )
    op.create_table(
        "platform_adapters",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "adapter_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "adapter_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "version", sa.VARCHAR(length=20), autoincrement=False, nullable=False
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "active", "inactive", "error", "deprecated", name="adapterstatus"
            ),
            server_default=sa.text("'active'::adapterstatus"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "capabilities",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "configuration_schema",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "supported_platforms",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "required_credentials",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name="pk_platform_adapters"),
        sa.UniqueConstraint(
            "adapter_name",
            "version",
            name="_adapter_name_version_uc",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_platform_adapters_status"),
        "platform_adapters",
        ["status"],
        unique=False,
    )
    op.create_index(
        op.f("ix_platform_adapters_adapter_type"),
        "platform_adapters",
        ["adapter_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_platform_adapters_adapter_name"),
        "platform_adapters",
        ["adapter_name"],
        unique=False,
    )
    op.create_table(
        "sixr_question_responses",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("analysis_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "iteration_number", sa.INTEGER(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "question_id", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "response_value",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("response_text", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "confidence",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'1'::double precision"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "source",
            sa.VARCHAR(length=50),
            server_default=sa.text("'user'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "response_time",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_errors",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
            name=op.f("sixr_question_responses_analysis_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["question_id"],
            ["sixr_questions.question_id"],
            name=op.f("sixr_question_responses_question_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_question_responses_pkey")),
    )
    op.create_index(
        op.f("ix_sixr_question_responses_analysis_id"),
        "sixr_question_responses",
        ["analysis_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_question_responses_id"),
        "sixr_question_responses",
        ["id"],
        unique=False,
    )
    op.create_table(
        "credential_rotation_history",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("credential_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "rotation_type", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "old_expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "new_expires_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("rotation_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("rotated_by", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "success",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "rotated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["credential_id"],
            ["platform_credentials.id"],
            name=op.f("fk_credential_rotation_history_credential_id_platform_c_9e76"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["rotated_by"],
            ["users.id"],
            name=op.f("fk_credential_rotation_history_rotated_by_users"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_credential_rotation_history")),
    )
    op.create_index(
        op.f("ix_credential_rotation_history_rotation_type"),
        "credential_rotation_history",
        ["rotation_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_rotation_history_rotated_at"),
        "credential_rotation_history",
        ["rotated_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_credential_rotation_history_credential_id"),
        "credential_rotation_history",
        ["credential_id"],
        unique=False,
    )
    op.create_table(
        "cache_invalidation_logs",
        sa.Column(
            "id",
            sa.INTEGER(),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the invalidation log entry",
        ),
        sa.Column(
            "cache_metadata_id",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Reference to the cache metadata entry that was invalidated",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account for tenant isolation",
        ),
        sa.Column(
            "invalidation_type",
            sa.VARCHAR(length=30),
            autoincrement=False,
            nullable=False,
            comment="Type of invalidation (EXPLICIT, CASCADE, EXPIRATION, MANUAL)",
        ),
        sa.Column(
            "cache_key_pattern",
            sa.VARCHAR(length=500),
            autoincrement=False,
            nullable=False,
            comment="The cache key or pattern that was invalidated",
        ),
        sa.Column(
            "keys_invalidated_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of cache keys invalidated by this operation",
        ),
        sa.Column(
            "trigger_entity_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Type of entity that triggered the invalidation",
        ),
        sa.Column(
            "trigger_entity_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
            comment="ID of entity that triggered the invalidation",
        ),
        sa.Column(
            "trigger_operation",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Operation that triggered invalidation (CREATE, UPDATE, DELETE)",
        ),
        sa.Column(
            "user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="User who initiated the operation that caused invalidation",
        ),
        sa.Column(
            "endpoint",
            sa.VARCHAR(length=200),
            autoincrement=False,
            nullable=True,
            comment="API endpoint that triggered the invalidation",
        ),
        sa.Column(
            "invalidation_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Time taken to complete the invalidation in milliseconds",
        ),
        sa.Column(
            "cascade_depth",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Depth of cascade invalidation (0 for direct invalidation)",
        ),
        sa.Column(
            "reason",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Human-readable reason for the invalidation",
        ),
        sa.Column(
            "invalidation_metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional invalidation metadata",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the invalidation log was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the invalidation log was last updated",
        ),
        sa.CheckConstraint(
            "invalidation_type::text = ANY (ARRAY['EXPLICIT'::character varying, 'CASCADE'::character varying, 'EXPIRATION'::character varying, 'MANUAL'::character varying, 'BATCH'::character varying]::text[])",
            name=op.f("ck_cache_invalidation_valid_type"),
        ),
        sa.CheckConstraint(
            "cascade_depth >= 0",
            name=op.f("ck_cache_invalidation_positive_cascade_depth"),
        ),
        sa.CheckConstraint(
            "keys_invalidated_count > 0",
            name=op.f("ck_cache_invalidation_positive_count"),
        ),
        sa.ForeignKeyConstraint(
            ["cache_metadata_id"],
            ["migration.cache_metadata.id"],
            name=op.f("cache_invalidation_logs_cache_metadata_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["migration.client_accounts.id"],
            name=op.f("cache_invalidation_logs_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["migration.users.id"],
            name=op.f("cache_invalidation_logs_user_id_fkey"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("cache_invalidation_logs_pkey")),
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_invalidation_trigger"),
        "cache_invalidation_logs",
        ["trigger_entity_type", "trigger_entity_id"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_invalidation_time_series"),
        "cache_invalidation_logs",
        ["created_at", "invalidation_type"],
        unique=False,
        schema="migration",
    )
    op.create_index(
        op.f("ix_cache_invalidation_metadata"),
        "cache_invalidation_logs",
        ["cache_metadata_id", "created_at"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "analysis_queue_items",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("queue_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "application_id",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "processing",
                "completed",
                "failed",
                "cancelled",
                name="itemstatus",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "started_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "completed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.ForeignKeyConstraint(
            ["queue_id"],
            ["migration.analysis_queues.id"],
            name=op.f("analysis_queue_items_queue_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("analysis_queue_items_pkey")),
        schema="migration",
    )
    op.create_index(
        op.f("idx_queue_items_queue_id"),
        "analysis_queue_items",
        ["queue_id"],
        unique=False,
        schema="migration",
    )
    op.create_table(
        "canonical_applications",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "canonical_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="The authoritative, human-readable name for this application",
        ),
        sa.Column(
            "normalized_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
            comment="Lowercase, trimmed, special-char-removed version for exact matching",
        ),
        sa.Column(
            "name_hash",
            sa.VARCHAR(length=64),
            autoincrement=False,
            nullable=False,
            comment="SHA-256 hash of normalized_name for fast lookups",
        ),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "name_embedding",
            pgvector.sqlalchemy.vector.VECTOR(dim=384),
            autoincrement=False,
            nullable=True,
            comment="Vector embedding of canonical_name for fuzzy similarity search (384-dim sentence-transformers)",
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "application_type",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "business_criticality",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "technology_stack",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=False,
            comment="Confidence in canonical name accuracy (0.0-1.0, higher = more confident)",
        ),
        sa.Column("is_verified", sa.BOOLEAN(), autoincrement=False, nullable=False),
        sa.Column(
            "verification_source",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("usage_count", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "last_used_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("updated_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("canonical_applications_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("canonical_applications_engagement_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("canonical_applications_pkey")),
        comment="Master registry of canonical application names with multi-tenant isolation and deduplication",
    )
    op.create_index(
        op.f("ix_migration_canonical_applications_normalized_name"),
        "canonical_applications",
        ["normalized_name"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_canonical_applications_name_hash"),
        "canonical_applications",
        ["name_hash"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_canonical_applications_engagement_id"),
        "canonical_applications",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_canonical_applications_client_account_id"),
        "canonical_applications",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_verification"),
        "canonical_applications",
        [
            "is_verified",
            "verification_source",
            "confidence_score",
            "client_account_id",
            "engagement_id",
        ],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_vector_similarity"),
        "canonical_applications",
        ["name_embedding"],
        unique=False,
        postgresql_with={"m": "16", "ef_construction": "64"},
        postgresql_using="hnsw",
    )
    op.create_index(
        op.f("idx_canonical_apps_usage_stats"),
        "canonical_applications",
        [
            sa.literal_column("usage_count DESC"),
            sa.literal_column("last_used_at DESC"),
            "client_account_id",
            "engagement_id",
        ],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_usage"),
        "canonical_applications",
        ["usage_count", "last_used_at"],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_unverified_only"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            sa.literal_column("confidence_score DESC"),
            sa.literal_column("usage_count DESC"),
        ],
        unique=False,
        postgresql_where="(is_verified = false)",
    )
    op.create_index(
        op.f("idx_canonical_apps_tenant_security"),
        "canonical_applications",
        ["client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_tenant_search_ranked"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            sa.literal_column("usage_count DESC"),
            "canonical_name",
        ],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_tenant_isolation"),
        "canonical_applications",
        ["client_account_id", "engagement_id", "normalized_name"],
        unique=True,
    )
    op.create_index(
        op.f("idx_canonical_apps_quality_assessment"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            "is_verified",
            sa.literal_column("confidence_score DESC"),
            sa.literal_column("usage_count DESC"),
        ],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_normalized_pattern"),
        "canonical_applications",
        ["normalized_name", "client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_high_usage_only"),
        "canonical_applications",
        ["client_account_id", "engagement_id", sa.literal_column("last_used_at DESC")],
        unique=False,
        postgresql_where="(usage_count >= 5)",
    )
    op.create_index(
        op.f("idx_canonical_apps_hash_lookup"),
        "canonical_applications",
        ["name_hash", "client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_hash_exact_match"),
        "canonical_applications",
        ["name_hash", "client_account_id", "engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_canonical_apps_fulltext_search"),
        "canonical_applications",
        [sa.literal_column("to_tsvector('english'::regconfig, canonical_name::text)")],
        unique=False,
        postgresql_using="gin",
    )
    op.create_index(
        op.f("idx_canonical_apps_dedup_workflow"),
        "canonical_applications",
        [
            "client_account_id",
            "engagement_id",
            "normalized_name",
            sa.literal_column("confidence_score DESC"),
        ],
        unique=False,
    )
    op.create_table(
        "collection_flows",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("discovery_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "flow_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "automation_tier",
            postgresql.ENUM(
                "tier_1", "tier_2", "tier_3", "tier_4", name="automationtier"
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "initialized",
                "platform_detection",
                "automated_collection",
                "gap_analysis",
                "manual_collection",
                "completed",
                "failed",
                "cancelled",
                name="collectionflowstatus",
            ),
            server_default=sa.text("'initialized'::collectionflowstatus"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "current_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "progress_percentage",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("0.0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "collection_quality_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "collection_config",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "phase_state",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "error_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "next_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "pause_points",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "user_inputs",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "phase_results",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "agent_insights",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "collected_platforms",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "collection_results",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "gap_analysis_results",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "assessment_ready",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "apps_ready_for_assessment",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_user_interaction",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name="fk_collection_flows_client_account_id_client_accounts",
        ),
        sa.ForeignKeyConstraint(
            ["discovery_flow_id"],
            ["discovery_flows.id"],
            name="fk_collection_flows_discovery_flow_id_discovery_flows",
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name="fk_collection_flows_engagement_id_engagements",
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name="fk_collection_flows_master_flow_id_crewai_flow_state_extensions",
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["users.id"], name="fk_collection_flows_user_id_users"
        ),
        sa.PrimaryKeyConstraint("id", name="pk_collection_flows"),
        sa.UniqueConstraint(
            "flow_id",
            name="uq_collection_flows_flow_id",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_index(
        op.f("ix_collection_flows_status"), "collection_flows", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_collection_flows_master_flow_id"),
        "collection_flows",
        ["master_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_flows_id"), "collection_flows", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_collection_flows_flow_id"),
        "collection_flows",
        ["flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_flows_engagement_id"),
        "collection_flows",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_flows_client_account_id"),
        "collection_flows",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collection_flows_automation_tier"),
        "collection_flows",
        ["automation_tier"],
        unique=False,
    )
    op.create_table(
        "flow_deletion_audit",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column(
            "deletion_type",
            sa.VARCHAR(),
            autoincrement=False,
            nullable=False,
            comment="user_requested, auto_cleanup, admin_action, batch_operation",
        ),
        sa.Column("deletion_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "deletion_method",
            sa.VARCHAR(),
            autoincrement=False,
            nullable=False,
            comment="manual, api, batch, scheduled",
        ),
        sa.Column(
            "data_deleted",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "deletion_impact",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "cleanup_summary",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "shared_memory_cleaned",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "knowledge_base_refs_cleaned",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'[]'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "agent_memory_cleaned",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "deleted_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("deleted_by", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column(
            "deletion_duration_ms", sa.INTEGER(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "recovery_possible",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "recovery_data",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("flow_deletion_audit_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("flow_deletion_audit_engagement_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("flow_deletion_audit_pkey")),
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_id"),
        "flow_deletion_audit",
        ["id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_flow_id"),
        "flow_deletion_audit",
        ["flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_engagement_id"),
        "flow_deletion_audit",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_deletion_type"),
        "flow_deletion_audit",
        ["deletion_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_deleted_at"),
        "flow_deletion_audit",
        ["deleted_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_flow_deletion_audit_client_account_id"),
        "flow_deletion_audit",
        ["client_account_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_tenant_flow"),
        "flow_deletion_audit",
        ["client_account_id", "engagement_id", "flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_flow_id"),
        "flow_deletion_audit",
        ["flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_engagement_id"),
        "flow_deletion_audit",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deletion_type"),
        "flow_deletion_audit",
        ["deletion_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_deleted_at"),
        "flow_deletion_audit",
        ["deleted_at"],
        unique=False,
    )
    op.create_index(
        op.f("ix_flow_deletion_audit_client_account_id"),
        "flow_deletion_audit",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "cache_invalidation_logs",
        sa.Column(
            "id",
            sa.INTEGER(),
            autoincrement=True,
            nullable=False,
            comment="Unique identifier for the invalidation log entry",
        ),
        sa.Column(
            "cache_metadata_id",
            sa.INTEGER(),
            autoincrement=False,
            nullable=True,
            comment="Reference to the cache metadata entry that was invalidated",
        ),
        sa.Column(
            "client_account_id",
            sa.UUID(),
            autoincrement=False,
            nullable=False,
            comment="Client account for tenant isolation",
        ),
        sa.Column(
            "invalidation_type",
            sa.VARCHAR(length=30),
            autoincrement=False,
            nullable=False,
            comment="Type of invalidation (EXPLICIT, CASCADE, EXPIRATION, MANUAL)",
        ),
        sa.Column(
            "cache_key_pattern",
            sa.VARCHAR(length=500),
            autoincrement=False,
            nullable=False,
            comment="The cache key or pattern that was invalidated",
        ),
        sa.Column(
            "keys_invalidated_count",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Number of cache keys invalidated by this operation",
        ),
        sa.Column(
            "trigger_entity_type",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Type of entity that triggered the invalidation",
        ),
        sa.Column(
            "trigger_entity_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
            comment="ID of entity that triggered the invalidation",
        ),
        sa.Column(
            "trigger_operation",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=True,
            comment="Operation that triggered invalidation (CREATE, UPDATE, DELETE)",
        ),
        sa.Column(
            "user_id",
            sa.UUID(),
            autoincrement=False,
            nullable=True,
            comment="User who initiated the operation that caused invalidation",
        ),
        sa.Column(
            "endpoint",
            sa.VARCHAR(length=200),
            autoincrement=False,
            nullable=True,
            comment="API endpoint that triggered the invalidation",
        ),
        sa.Column(
            "invalidation_time_ms",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
            comment="Time taken to complete the invalidation in milliseconds",
        ),
        sa.Column(
            "cascade_depth",
            sa.INTEGER(),
            autoincrement=False,
            nullable=False,
            comment="Depth of cascade invalidation (0 for direct invalidation)",
        ),
        sa.Column(
            "reason",
            sa.TEXT(),
            autoincrement=False,
            nullable=True,
            comment="Human-readable reason for the invalidation",
        ),
        sa.Column(
            "invalidation_metadata",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Additional invalidation metadata",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the invalidation log was created",
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=False,
            comment="Timestamp of when the invalidation log was last updated",
        ),
        sa.CheckConstraint(
            "invalidation_type::text = ANY (ARRAY['EXPLICIT'::character varying, 'CASCADE'::character varying, 'EXPIRATION'::character varying, 'MANUAL'::character varying, 'BATCH'::character varying]::text[])",
            name=op.f("ck_cache_invalidation_valid_type"),
        ),
        sa.CheckConstraint(
            "cascade_depth >= 0",
            name=op.f("ck_cache_invalidation_positive_cascade_depth"),
        ),
        sa.CheckConstraint(
            "keys_invalidated_count > 0",
            name=op.f("ck_cache_invalidation_positive_count"),
        ),
        sa.ForeignKeyConstraint(
            ["cache_metadata_id"],
            ["cache_metadata.id"],
            name=op.f("cache_invalidation_logs_cache_metadata_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("cache_invalidation_logs_client_account_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["users.id"],
            name=op.f("cache_invalidation_logs_user_id_fkey"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("cache_invalidation_logs_pkey")),
    )
    op.create_index(
        op.f("ix_cache_invalidation_trigger"),
        "cache_invalidation_logs",
        ["trigger_entity_type", "trigger_entity_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_invalidation_time_series"),
        "cache_invalidation_logs",
        ["created_at", "invalidation_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_cache_invalidation_metadata"),
        "cache_invalidation_logs",
        ["cache_metadata_id", "created_at"],
        unique=False,
    )
    op.create_table(
        "user_profiles",
        sa.Column("user_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'PENDING_APPROVAL'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "approval_requested_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "approved_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("approved_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("registration_reason", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "organization", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "role_description",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "requested_access_level",
            sa.VARCHAR(length=20),
            server_default=sa.text("'READ_ONLY'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "phone_number", sa.VARCHAR(length=20), autoincrement=False, nullable=True
        ),
        sa.Column(
            "manager_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "linkedin_profile",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_login_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "login_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "failed_login_attempts",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_failed_login",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "notification_preferences",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"email_notifications": true, "system_alerts": true, "learning_updates": false, "weekly_reports": true}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["approved_by"],
            ["users.id"],
            name=op.f("fk_user_profiles_approved_by_users"),
        ),
        sa.ForeignKeyConstraint(
            ["user_id"], ["users.id"], name=op.f("fk_user_profiles_user_id_users")
        ),
        sa.PrimaryKeyConstraint("user_id", name=op.f("pk_user_profiles")),
    )
    op.create_table(
        "component_treatments",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("component_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "treatment_type",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "treatment_config",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["component_id"],
            ["application_components.id"],
            name=op.f("component_treatments_component_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("component_treatments_pkey")),
    )
    op.create_table(
        "collected_data_inventory",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("collection_flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("adapter_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "platform", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "collection_method",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "raw_data",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "normalized_data",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "data_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "resource_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "quality_score",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'pending'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "validation_errors",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "metadata",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "collected_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "processed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("credential_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["adapter_id"],
            ["platform_adapters.id"],
            name=op.f("fk_collected_data_inventory_adapter_id_platform_adapters"),
            ondelete="SET NULL",
        ),
        sa.ForeignKeyConstraint(
            ["collection_flow_id"],
            ["collection_flows.id"],
            name=op.f(
                "fk_collected_data_inventory_collection_flow_id_collection_flows"
            ),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["credential_id"],
            ["platform_credentials.id"],
            name=op.f("fk_collected_data_inventory_credential_id_platform_credentials"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_collected_data_inventory")),
    )
    op.create_index(
        op.f("ix_collected_data_inventory_validation_status"),
        "collected_data_inventory",
        ["validation_status"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collected_data_inventory_platform"),
        "collected_data_inventory",
        ["platform"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collected_data_inventory_data_type"),
        "collected_data_inventory",
        ["data_type"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collected_data_inventory_credential_id"),
        "collected_data_inventory",
        ["credential_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_collected_data_inventory_collection_flow_id"),
        "collected_data_inventory",
        ["collection_flow_id"],
        unique=False,
    )
    op.create_table(
        "analysis_queue_items",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("queue_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "application_id",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "status",
            postgresql.ENUM(
                "pending",
                "processing",
                "completed",
                "failed",
                "cancelled",
                name="itemstatus",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "started_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "completed_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "updated_at", postgresql.TIMESTAMP(), autoincrement=False, nullable=False
        ),
        sa.ForeignKeyConstraint(
            ["queue_id"],
            ["analysis_queues.id"],
            name=op.f("analysis_queue_items_queue_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("analysis_queue_items_pkey")),
    )
    op.create_index(
        op.f("idx_queue_items_queue_id"),
        "analysis_queue_items",
        ["queue_id"],
        unique=False,
    )
    op.create_table(
        "application_architecture_overrides",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("assessment_flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("application_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("standard_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "override_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "override_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("rationale", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "approved_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["assessment_flow_id"],
            ["assessment_flows.id"],
            name=op.f("application_architecture_overrides_assessment_flow_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.ForeignKeyConstraint(
            ["standard_id"],
            ["engagement_architecture_standards.id"],
            name=op.f("application_architecture_overrides_standard_id_fkey"),
            ondelete="SET NULL",
        ),
        sa.PrimaryKeyConstraint(
            "id", name=op.f("application_architecture_overrides_pkey")
        ),
    )
    op.create_index(
        op.f("ix_application_architecture_overrides_assessment_flow_id"),
        "application_architecture_overrides",
        ["assessment_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_application_architecture_overrides_application_id"),
        "application_architecture_overrides",
        ["application_id"],
        unique=False,
    )
    op.create_table(
        "sixr_parameters",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "parameter_key", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "value",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_parameters_pkey")),
    )
    op.create_index(
        op.f("ix_sixr_parameters_parameter_key"),
        "sixr_parameters",
        ["parameter_key"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_parameters_parameter_key"),
        "sixr_parameters",
        ["parameter_key"],
        unique=True,
    )
    op.create_table(
        "application_components",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "component_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "component_type",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "component_config",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["engagement_id"],
            ["engagements.id"],
            name=op.f("application_components_engagement_id_fkey"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("application_components_pkey")),
    )
    op.create_table(
        "discovery_flows",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("flow_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("master_flow_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("user_id", sa.VARCHAR(), autoincrement=False, nullable=False),
        sa.Column("data_import_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "flow_name", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.Column(
            "status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'active'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "progress_percentage",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("0.0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "data_import_completed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "field_mapping_completed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "data_cleansing_completed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "asset_inventory_completed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "dependency_analysis_completed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "tech_debt_assessment_completed",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "learning_scope",
            sa.VARCHAR(length=50),
            server_default=sa.text("'engagement'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "memory_isolation_level",
            sa.VARCHAR(length=20),
            server_default=sa.text("'strict'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "assessment_ready",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "phase_state",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "agent_state",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "flow_type", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "current_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "phases_completed",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "flow_state",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "crew_outputs",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "field_mappings",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "discovered_assets",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "dependencies",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "tech_debt_analysis",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "crewai_persistence_id", sa.UUID(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "crewai_state_data",
            postgresql.JSONB(astext_type=sa.Text()),
            server_default=sa.text("'{}'::jsonb"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "error_phase", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "error_details",
            postgresql.JSON(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "completed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["data_import_id"],
            ["data_imports.id"],
            name=op.f("fk_discovery_flows_data_import_id_data_imports"),
        ),
        sa.ForeignKeyConstraint(
            ["master_flow_id"],
            ["crewai_flow_state_extensions.flow_id"],
            name=op.f("fk_discovery_flows_master_flow_id_crewai_flow_state_extensions"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_discovery_flows")),
        sa.UniqueConstraint(
            "flow_id",
            name=op.f("uq_discovery_flows_flow_id"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
    )
    op.create_index(
        op.f("ix_discovery_flows_status"), "discovery_flows", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_flows_master_flow_id"),
        "discovery_flows",
        ["master_flow_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_flows_id"), "discovery_flows", ["id"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_flows_flow_id"), "discovery_flows", ["flow_id"], unique=False
    )
    op.create_index(
        op.f("ix_discovery_flows_engagement_id"),
        "discovery_flows",
        ["engagement_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_flows_data_import_id"),
        "discovery_flows",
        ["data_import_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_discovery_flows_client_account_id"),
        "discovery_flows",
        ["client_account_id"],
        unique=False,
    )
    op.create_table(
        "users",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("email", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column(
            "password_hash", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "first_name", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "last_name", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_verified",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("default_client_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "default_engagement_id", sa.UUID(), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "last_login",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_admin",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["default_client_id"],
            ["client_accounts.id"],
            name="fk_users_default_client_id_client_accounts",
        ),
        sa.PrimaryKeyConstraint("id", name="pk_users"),
        sa.UniqueConstraint(
            "email",
            name="uq_users_email",
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        postgresql_ignore_search_path=False,
    )
    op.create_table(
        "sixr_analysis_parameters",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("analysis_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "iteration_number", sa.INTEGER(), autoincrement=False, nullable=False
        ),
        sa.Column(
            "business_value",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "technical_complexity",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "migration_urgency",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "compliance_requirements",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "cost_sensitivity",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "risk_tolerance",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "innovation_priority",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'3'::double precision"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "application_type",
            sa.VARCHAR(length=20),
            server_default=sa.text("'custom'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "parameter_source",
            sa.VARCHAR(length=50),
            server_default=sa.text("'initial'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "confidence_level",
            sa.DOUBLE_PRECISION(precision=53),
            server_default=sa.text("'1'::double precision"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "updated_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("parameter_notes", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "validation_status",
            sa.VARCHAR(length=20),
            server_default=sa.text("'valid'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["analysis_id"],
            ["sixr_analyses.id"],
            name=op.f("sixr_analysis_parameters_analysis_id_fkey"),
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_analysis_parameters_pkey")),
    )
    op.create_index(
        op.f("ix_sixr_analysis_parameters_analysis_id"),
        "sixr_analysis_parameters",
        ["analysis_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_migration_sixr_analysis_parameters_id"),
        "sixr_analysis_parameters",
        ["id"],
        unique=False,
    )
    op.create_table(
        "security_audit_logs",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "event_type", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "event_category", sa.VARCHAR(length=50), autoincrement=False, nullable=False
        ),
        sa.Column(
            "severity",
            sa.VARCHAR(length=20),
            server_default=sa.text("'INFO'::character varying"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "actor_user_id", sa.VARCHAR(length=36), autoincrement=False, nullable=False
        ),
        sa.Column(
            "actor_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "actor_role", sa.VARCHAR(length=50), autoincrement=False, nullable=True
        ),
        sa.Column(
            "target_user_id", sa.VARCHAR(length=36), autoincrement=False, nullable=True
        ),
        sa.Column(
            "target_email", sa.VARCHAR(length=255), autoincrement=False, nullable=True
        ),
        sa.Column(
            "ip_address", sa.VARCHAR(length=45), autoincrement=False, nullable=True
        ),
        sa.Column("user_agent", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "request_path", sa.VARCHAR(length=500), autoincrement=False, nullable=True
        ),
        sa.Column(
            "request_method", sa.VARCHAR(length=10), autoincrement=False, nullable=True
        ),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column(
            "details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "is_suspicious",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "requires_review",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "is_blocked",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "reviewed_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "reviewed_by", sa.VARCHAR(length=36), autoincrement=False, nullable=True
        ),
        sa.Column(
            "request_payload",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Sanitized request payload data for audit purposes",
        ),
        sa.Column(
            "response_payload",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Sanitized response payload data for audit purposes",
        ),
        sa.Column(
            "target_details",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
            comment="Sanitized target details for audit purposes",
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("security_audit_logs_pkey")),
    )
    op.create_index(
        op.f("idx_security_audit_logs_target_user_id"),
        "security_audit_logs",
        ["target_user_id"],
        unique=False,
    )
    op.create_index(
        op.f("idx_security_audit_logs_severity"),
        "security_audit_logs",
        ["severity"],
        unique=False,
    )
    op.create_index(
        op.f("idx_security_audit_logs_is_suspicious"),
        "security_audit_logs",
        ["is_suspicious"],
        unique=False,
    )
    op.create_index(
        op.f("idx_security_audit_logs_event_type"),
        "security_audit_logs",
        ["event_type"],
        unique=False,
    )
    op.create_index(
        op.f("idx_security_audit_logs_created_at"),
        "security_audit_logs",
        ["created_at"],
        unique=False,
    )
    op.create_index(
        op.f("idx_security_audit_logs_actor_user_id"),
        "security_audit_logs",
        ["actor_user_id"],
        unique=False,
    )
    op.create_table(
        "failure_journal",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("engagement_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("source", sa.VARCHAR(length=64), autoincrement=False, nullable=False),
        sa.Column(
            "operation", sa.VARCHAR(length=128), autoincrement=False, nullable=False
        ),
        sa.Column(
            "payload",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("error_message", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column("trace", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "retry_count",
            sa.INTEGER(),
            server_default=sa.text("0"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("failure_journal_pkey")),
        schema="migration",
    )
    op.create_table(
        "alembic_version",
        sa.Column(
            "version_num", sa.VARCHAR(length=255), autoincrement=False, nullable=False
        ),
        sa.PrimaryKeyConstraint("version_num", name=op.f("alembic_version_pkc")),
    )
    op.create_table(
        "sixr_questions",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column(
            "question_id", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column("question_text", sa.TEXT(), autoincrement=False, nullable=False),
        sa.Column(
            "question_type",
            postgresql.ENUM(
                "text",
                "select",
                "multiselect",
                "file_upload",
                "boolean",
                "numeric",
                name="question_type",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "category", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "priority",
            sa.INTEGER(),
            server_default=sa.text("1"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "required",
            sa.BOOLEAN(),
            server_default=sa.text("false"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "options",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "validation_rules",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("help_text", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "depends_on", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "show_conditions",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "skip_conditions",
            postgresql.JSONB(astext_type=sa.Text()),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "updated_by", sa.VARCHAR(length=100), autoincrement=False, nullable=True
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "version",
            sa.VARCHAR(length=20),
            server_default=sa.text("'1.0'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "parent_question_id",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("sixr_questions_pkey")),
    )
    op.create_index(
        op.f("ix_sixr_questions_question_id"),
        "sixr_questions",
        ["question_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_sixr_questions_category"), "sixr_questions", ["category"], unique=False
    )
    op.create_index(
        op.f("ix_migration_sixr_questions_question_id"),
        "sixr_questions",
        ["question_id"],
        unique=True,
    )
    op.create_index(
        op.f("ix_migration_sixr_questions_id"), "sixr_questions", ["id"], unique=False
    )
    op.create_table(
        "engagements",
        sa.Column("id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("client_account_id", sa.UUID(), autoincrement=False, nullable=False),
        sa.Column("name", sa.VARCHAR(length=255), autoincrement=False, nullable=False),
        sa.Column("slug", sa.VARCHAR(length=100), autoincrement=False, nullable=False),
        sa.Column("description", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "engagement_type",
            sa.VARCHAR(length=50),
            server_default=sa.text("'migration'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "status",
            sa.VARCHAR(length=50),
            server_default=sa.text("'active'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "priority",
            sa.VARCHAR(length=20),
            server_default=sa.text("'medium'::character varying"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "start_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "target_completion_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "actual_completion_date",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("engagement_lead_id", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "client_contact_name",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "client_contact_email",
            sa.VARCHAR(length=255),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "settings",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text("'{}'::json"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "migration_scope",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"target_clouds": [], "migration_strategies": [], "excluded_systems": [], "included_environments": [], "business_units": [], "geographic_scope": [], "timeline_constraints": {}}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "team_preferences",
            postgresql.JSON(astext_type=sa.Text()),
            server_default=sa.text(
                '\'{"stakeholders": [], "decision_makers": [], "technical_leads": [], "communication_style": "formal", "reporting_frequency": "weekly", "preferred_meeting_times": [], "escalation_contacts": [], "project_methodology": "agile"}\'::json'
            ),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column(
            "updated_at",
            postgresql.TIMESTAMP(timezone=True),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("created_by", sa.UUID(), autoincrement=False, nullable=True),
        sa.Column(
            "is_active",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.ForeignKeyConstraint(
            ["client_account_id"],
            ["client_accounts.id"],
            name=op.f("fk_engagements_client_account_id_client_accounts"),
        ),
        sa.ForeignKeyConstraint(
            ["engagement_lead_id"],
            ["users.id"],
            name=op.f("fk_engagements_engagement_lead_id_users"),
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pk_engagements")),
    )
    op.create_table(
        "pii_data_registry",
        sa.Column(
            "id",
            sa.UUID(),
            server_default=sa.text("gen_random_uuid()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column(
            "table_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "column_name", sa.VARCHAR(length=100), autoincrement=False, nullable=False
        ),
        sa.Column(
            "data_classification",
            sa.VARCHAR(length=50),
            autoincrement=False,
            nullable=False,
            comment="PII, SPII, PUBLIC, INTERNAL, CONFIDENTIAL",
        ),
        sa.Column(
            "encryption_required",
            sa.BOOLEAN(),
            server_default=sa.text("true"),
            autoincrement=False,
            nullable=True,
        ),
        sa.Column("retention_days", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column("purpose", sa.TEXT(), autoincrement=False, nullable=True),
        sa.Column(
            "legal_basis",
            sa.VARCHAR(length=100),
            autoincrement=False,
            nullable=True,
            comment="consent, contract, legal_obligation, legitimate_interest",
        ),
        sa.Column(
            "created_at",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=True,
        ),
        sa.PrimaryKeyConstraint("id", name=op.f("pii_data_registry_pkey")),
        sa.UniqueConstraint(
            "table_name",
            "column_name",
            name=op.f("pii_data_registry_table_name_column_name_key"),
            postgresql_include=[],
            postgresql_nulls_not_distinct=False,
        ),
        schema="migration",
    )
    op.drop_table("tech_debt_analyses", schema="migration")
    op.drop_table("import_processing_steps", schema="migration")
    op.drop_index(
        op.f("ix_migration_asset_tags_tag_id"),
        table_name="asset_tags",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_asset_tags_asset_id"),
        table_name="asset_tags",
        schema="migration",
    )
    op.drop_table("asset_tags", schema="migration")
    op.drop_table("workflow_progress", schema="migration")
    op.drop_index(
        op.f("ix_migration_wave_plans_id"), table_name="wave_plans", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_wave_plans_engagement_id"),
        table_name="wave_plans",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_wave_plans_client_account_id"),
        table_name="wave_plans",
        schema="migration",
    )
    op.drop_table("wave_plans", schema="migration")
    op.drop_index(
        op.f("ix_migration_user_active_flows_user_id"),
        table_name="user_active_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_active_flows_is_current"),
        table_name="user_active_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_active_flows_id"),
        table_name="user_active_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_active_flows_flow_id"),
        table_name="user_active_flows",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_user_active_flows_engagement_id"),
        table_name="user_active_flows",
        schema="migration",
    )
    op.drop_table("user_active_flows", schema="migration")
    op.drop_index(op.f("ix_migration_tags_name"), table_name="tags", schema="migration")
    op.drop_index(
        op.f("ix_migration_tags_is_active"), table_name="tags", schema="migration"
    )
    op.drop_index(op.f("ix_migration_tags_id"), table_name="tags", schema="migration")
    op.drop_index(
        op.f("ix_migration_tags_client_account_id"),
        table_name="tags",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_tags_category"), table_name="tags", schema="migration"
    )
    op.drop_table("tags", schema="migration")
    op.drop_index(
        op.f("ix_migration_migration_logs_id"),
        table_name="migration_logs",
        schema="migration",
    )
    op.drop_table("migration_logs", schema="migration")
    op.drop_index(
        "idx_usage_summary_period", table_name="llm_usage_summary", schema="migration"
    )
    op.drop_index(
        "idx_usage_summary_model", table_name="llm_usage_summary", schema="migration"
    )
    op.drop_index(
        "idx_usage_summary_client", table_name="llm_usage_summary", schema="migration"
    )
    op.drop_table("llm_usage_summary", schema="migration")
    op.drop_index("idx_llm_usage_user", table_name="llm_usage_logs", schema="migration")
    op.drop_index(
        "idx_llm_usage_success", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_reporting", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_provider_model", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_page_context", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_feature_context", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_engagement", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_created_at", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_cost_analysis", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_index(
        "idx_llm_usage_client_account", table_name="llm_usage_logs", schema="migration"
    )
    op.drop_table("llm_usage_logs", schema="migration")
    op.drop_index(
        op.f("ix_migration_feedback_summaries_page"),
        table_name="feedback_summaries",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_feedback_summaries_id"),
        table_name="feedback_summaries",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_feedback_summaries_feedback_type"),
        table_name="feedback_summaries",
        schema="migration",
    )
    op.drop_table("feedback_summaries", schema="migration")
    op.drop_index(
        op.f("ix_migration_feedback_page"), table_name="feedback", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_feedback_id"), table_name="feedback", schema="migration"
    )
    op.drop_index(
        op.f("ix_migration_feedback_feedback_type"),
        table_name="feedback",
        schema="migration",
    )
    op.drop_table("feedback", schema="migration")
    op.drop_table("custom_target_fields", schema="migration")
    op.drop_index(
        op.f("ix_migration_cmdb_sixr_analyses_status"),
        table_name="cmdb_sixr_analyses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_cmdb_sixr_analyses_id"),
        table_name="cmdb_sixr_analyses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_cmdb_sixr_analyses_engagement_id"),
        table_name="cmdb_sixr_analyses",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_cmdb_sixr_analyses_client_account_id"),
        table_name="cmdb_sixr_analyses",
        schema="migration",
    )
    op.drop_table("cmdb_sixr_analyses", schema="migration")
    op.drop_index(
        op.f("ix_migration_asset_embeddings_id"),
        table_name="asset_embeddings",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_asset_embeddings_engagement_id"),
        table_name="asset_embeddings",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_asset_embeddings_client_account_id"),
        table_name="asset_embeddings",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_asset_embeddings_asset_id"),
        table_name="asset_embeddings",
        schema="migration",
    )
    op.drop_table("asset_embeddings", schema="migration")
    op.drop_index(
        op.f("ix_migration_role_change_approvals_target_user_id"),
        table_name="role_change_approvals",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_role_change_approvals_requested_by"),
        table_name="role_change_approvals",
        schema="migration",
    )
    op.drop_table("role_change_approvals", schema="migration")
    op.drop_index(
        op.f("ix_migration_migrations_name"),
        table_name="migrations",
        schema="migration",
    )
    op.drop_index(
        op.f("ix_migration_migrations_id"), table_name="migrations", schema="migration"
    )
    op.drop_table("migrations", schema="migration")
    op.drop_index(
        "idx_model_pricing_provider_model",
        table_name="llm_model_pricing",
        schema="migration",
    )
    op.drop_index(
        "idx_model_pricing_active", table_name="llm_model_pricing", schema="migration"
    )
    op.drop_table("llm_model_pricing", schema="migration")
    # ### end Alembic commands ###
