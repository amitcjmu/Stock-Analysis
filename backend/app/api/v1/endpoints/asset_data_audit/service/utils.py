"""
Asset Data Audit Utility Functions

Helper functions for data processing and column inspection.

Generated by CC (Claude Code) for Asset Data Review feature
"""

import logging
from datetime import datetime
from decimal import Decimal
from typing import Any
from uuid import UUID

logger = logging.getLogger(__name__)


def safe_json_value(value: Any) -> Any:
    """Safely convert a value to JSON-serializable format."""
    if value is None:
        return None
    if isinstance(value, (str, int, float, bool)):
        return value
    if isinstance(value, UUID):
        return str(value)
    if isinstance(value, datetime):
        return value.isoformat()
    if isinstance(value, Decimal):
        return float(value)
    if isinstance(value, dict):
        return {k: safe_json_value(v) for k, v in value.items()}
    if isinstance(value, (list, tuple)):
        return [safe_json_value(v) for v in value]
    if isinstance(value, bytes):
        return value.decode("utf-8", errors="replace")
    return str(value)


def get_column_metadata(column) -> dict:
    """Extract metadata from a SQLAlchemy column."""
    info = getattr(column, "info", {}) or {}
    return {
        "display_name": info.get("display_name", column.name.replace("_", " ").title()),
        "category": info.get("category", "uncategorized"),
        "short_hint": info.get("short_hint"),
        "comment": getattr(column, "comment", None),
        "nullable": getattr(column, "nullable", True),
        "type": str(column.type),
    }


def is_jsonb_column(column) -> bool:
    """Check if a column is a JSONB/JSON type."""
    type_str = str(column.type).upper()
    return "JSON" in type_str


def is_value_populated(value: Any) -> bool:
    """Determine if a value is considered 'populated' (not empty)."""
    if value is None:
        return False
    if isinstance(value, str) and value.strip() == "":
        return False
    if isinstance(value, (list, dict)) and len(value) == 0:
        return False
    return True
