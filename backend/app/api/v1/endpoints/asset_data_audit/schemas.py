"""
Asset Data Audit Schemas

Pydantic models for the Asset Data Audit/Review feature.
Provides comprehensive view of all asset data including:
- Main table columns (categorized)
- Enrichment tables
- JSONB column contents
- Gap analysis metrics

Generated by CC (Claude Code) for Asset Data Review feature
"""

from typing import Any, Dict, List, Optional
from pydantic import BaseModel, Field


class FieldInfo(BaseModel):
    """Information about a single field/column."""

    name: str = Field(..., description="Column/field name")
    display_name: str = Field(..., description="Human-readable display name")
    value: Any = Field(None, description="Current value (JSON-safe)")
    populated: bool = Field(..., description="Whether the field has a value")
    type: str = Field(..., description="SQLAlchemy column type")
    hint: Optional[str] = Field(None, description="Short hint/description")
    comment: Optional[str] = Field(None, description="Column comment from schema")


class CategoryStats(BaseModel):
    """Statistics for a category of fields."""

    fields: List[FieldInfo] = Field(
        default_factory=list, description="Fields in this category"
    )
    populated: int = Field(0, description="Number of populated fields")
    total: int = Field(0, description="Total number of fields")
    completeness_pct: float = Field(0.0, description="Percentage of fields populated")


class EnrichmentRecord(BaseModel):
    """A single record from an enrichment table."""

    # Dynamic fields from the enrichment table
    class Config:
        extra = "allow"


class EnrichmentTableInfo(BaseModel):
    """Information about an enrichment table."""

    exists: bool = Field(..., description="Whether any records exist for this asset")
    record_count: int = Field(0, description="Number of records")
    records: List[Dict[str, Any]] = Field(
        default_factory=list, description="Actual records from the table"
    )
    error: Optional[str] = Field(None, description="Error message if query failed")


class SummaryStats(BaseModel):
    """Summary statistics for a data section."""

    total_fields: int = Field(0, description="Total number of fields")
    populated_fields: int = Field(0, description="Number of populated fields")
    completeness_pct: float = Field(0.0, description="Completeness percentage")


class OverallSummary(BaseModel):
    """Overall summary of asset data completeness."""

    main_table: SummaryStats = Field(..., description="Main asset table stats")
    enrichments: SummaryStats = Field(..., description="Enrichment tables stats")
    overall: SummaryStats = Field(..., description="Combined overall stats")


class LowCompletenessCategory(BaseModel):
    """Category with low completeness for gap reporting."""

    category: str = Field(..., description="Category name")
    completeness_pct: float = Field(..., description="Completeness percentage")


class DataGaps(BaseModel):
    """Summary of data gaps identified."""

    empty_categories: List[str] = Field(
        default_factory=list, description="Categories with 0% completeness"
    )
    low_completeness_categories: List[LowCompletenessCategory] = Field(
        default_factory=list, description="Categories with <50% completeness"
    )
    missing_enrichments: List[str] = Field(
        default_factory=list, description="Enrichment tables with no data"
    )


class AssetDataAuditResponse(BaseModel):
    """Complete asset data audit response."""

    asset_id: str = Field(..., description="Asset UUID")
    asset_name: str = Field(..., description="Asset display name")
    summary: OverallSummary = Field(..., description="Overall summary statistics")
    categories: Dict[str, CategoryStats] = Field(
        ..., description="Fields organized by category"
    )
    enrichments: Dict[str, EnrichmentTableInfo] = Field(
        ..., description="Enrichment table data"
    )
    jsonb_expanded: Dict[str, Any] = Field(
        default_factory=dict, description="Expanded JSONB column contents"
    )
    data_gaps: DataGaps = Field(..., description="Identified data gaps")

    class Config:
        json_schema_extra = {
            "example": {
                "asset_id": "059a1f71-69ef-41cc-8899-3c89cd560497",
                "asset_name": "Analytics Dashboard",
                "summary": {
                    "main_table": {
                        "total_fields": 120,
                        "populated_fields": 45,
                        "completeness_pct": 37.5,
                    },
                    "enrichments": {
                        "total_fields": 61,
                        "populated_fields": 26,
                        "completeness_pct": 42.6,
                    },
                    "overall": {
                        "total_fields": 181,
                        "populated_fields": 71,
                        "completeness_pct": 39.2,
                    },
                },
            }
        }


class AssetListItem(BaseModel):
    """Brief asset info for listing."""

    id: str = Field(..., description="Asset UUID")
    name: str = Field(..., description="Asset name")
    current_phase: Optional[str] = Field(None, description="Current workflow phase")
    assessment_flow_id: Optional[str] = Field(
        None, description="Linked assessment flow"
    )
    completeness_pct: Optional[float] = Field(
        None, description="Quick completeness estimate"
    )


class AssetListResponse(BaseModel):
    """Response for asset listing endpoint."""

    assets: List[AssetListItem] = Field(..., description="List of assets")
    total: int = Field(..., description="Total count")
