"""
Data Transformation Service

This module contains the DataTransformationService class for transforming
raw collected data into standardized formats.

Generated by CC (Claude Code)
"""

import logging
from datetime import datetime
from typing import Any, Dict, Optional

from sqlalchemy.ext.asyncio import AsyncSession

from app.core.context import RequestContext

from .base import DataType, TransformationResult
from .field_mapper import FieldMapper
from .platform_transformers import (
    ServiceNowTransformer,
    VMwareTransformer,
    AWSTransformer,
)
from .rule_engine import TransformationRuleEngine
from .validator import DataValidator

logger = logging.getLogger(__name__)


class DataTransformationService:
    """
    Service for transforming raw collected data into standardized formats.

    This service handles:
    - Field mapping and renaming
    - Value conversions and formatting
    - Data structure transformations
    - Complex rule-based transformations
    """

    def __init__(self, db: AsyncSession, context: RequestContext):
        """
        Initialize the Data Transformation Service.

        Args:
            db: Database session
            context: Request context
        """
        self.db = db
        self.context = context

        # Initialize component services
        self.field_mapper = FieldMapper()
        self.rule_engine = TransformationRuleEngine()
        self.validator = DataValidator()

        # Initialize platform transformers
        self.servicenow_transformer = ServiceNowTransformer()
        self.vmware_transformer = VMwareTransformer()
        self.aws_transformer = AWSTransformer()

    async def transform_data(
        self,
        raw_data: Dict[str, Any],
        data_type: DataType,
        source_platform: str,
        transformation_config: Optional[Dict[str, Any]] = None,
    ) -> TransformationResult:
        """
        Transform raw data into normalized format.

        Args:
            raw_data: Raw data to transform
            data_type: Type of data being transformed
            source_platform: Source platform name
            transformation_config: Optional transformation configuration

        Returns:
            TransformationResult with transformed data
        """
        try:
            # Apply platform-specific transformations
            platform_transformed = await self._apply_platform_transformations(
                raw_data, source_platform
            )

            # Apply standard field mappings
            field_mapped = self.field_mapper.apply_field_mappings(
                platform_transformed, data_type
            )

            # Apply custom transformation rules
            if transformation_config:
                custom_transformed = (
                    await self.rule_engine.apply_custom_transformations(
                        field_mapped, transformation_config
                    )
                )
            else:
                custom_transformed = field_mapped

            # Validate transformed data
            validation_errors = self.validator.validate_transformed_data(
                custom_transformed, data_type
            )

            return TransformationResult(
                success=len(validation_errors) == 0,
                transformed_data=custom_transformed,
                validation_errors=validation_errors,
                transformation_metadata={
                    "source_platform": source_platform,
                    "data_type": data_type.value,
                    "transformation_timestamp": datetime.utcnow().isoformat(),
                    "rules_applied": (
                        transformation_config.get("rules", [])
                        if transformation_config
                        else []
                    ),
                },
            )

        except Exception as e:
            logger.error(f"Data transformation failed: {str(e)}")
            return TransformationResult(
                success=False, validation_errors=[f"Transformation error: {str(e)}"]
            )

    async def _apply_platform_transformations(
        self, data: Dict[str, Any], platform: str
    ) -> Dict[str, Any]:
        """Apply platform-specific transformations."""
        transformed = data.copy()

        # ServiceNow transformations
        if platform.lower() == "servicenow":
            transformed = self.servicenow_transformer.transform(transformed)

        # VMware transformations
        elif platform.lower() in ["vmware", "vcenter", "vmware_vcenter"]:
            transformed = self.vmware_transformer.transform(transformed)

        # AWS transformations
        elif platform.lower() == "aws":
            transformed = self.aws_transformer.transform(transformed)

        # Add more platform-specific transformations as needed

        return transformed
