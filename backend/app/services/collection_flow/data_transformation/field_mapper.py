"""
Field mapping and transformation logic.

Generated by CC (Claude Code)
"""

import logging
from typing import Any, Dict

from .base import DataType

logger = logging.getLogger(__name__)


class FieldMapper:
    """Handles field mapping and standard transformations."""

    # Standard field mappings for common platforms
    STANDARD_FIELD_MAPPINGS = {
        "server": {
            "hostname": ["name", "host_name", "server_name", "computer_name", "fqdn"],
            "ip_address": ["ip", "ipaddress", "ip_addr", "primary_ip", "management_ip"],
            "operating_system": ["os", "os_name", "operating_system_name", "platform"],
            "os_version": ["os_version", "version", "os_release", "kernel_version"],
            "cpu_count": ["cpu", "cpus", "processor_count", "vcpus", "cores"],
            "memory_gb": ["memory", "ram", "total_memory", "memory_size"],
            "status": ["state", "power_state", "operational_status", "status"],
            "environment": ["env", "environment_type", "tier", "stage"],
            "location": ["datacenter", "dc", "site", "region", "zone"],
            "serial_number": ["serial", "service_tag", "asset_tag"],
            "model": ["hardware_model", "server_model", "platform_model"],
            "manufacturer": ["vendor", "make", "manufacturer_name"],
        },
        "application": {
            "app_name": ["name", "application_name", "app", "service_name"],
            "version": ["app_version", "release", "build"],
            "status": ["state", "health", "operational_status"],
            "environment": ["env", "stage", "tier"],
            "owner": ["app_owner", "business_owner", "contact"],
            "criticality": ["priority", "importance", "business_criticality"],
            "technology": ["tech_stack", "platform", "framework"],
            "url": ["endpoint", "base_url", "service_url"],
            "port": ["service_port", "listen_port", "app_port"],
        },
        "database": {
            "db_name": ["database_name", "name", "sid", "instance_name"],
            "db_type": ["engine", "database_type", "platform", "vendor"],
            "version": ["db_version", "engine_version", "release"],
            "host": ["hostname", "server", "db_host"],
            "port": ["db_port", "listen_port", "service_port"],
            "size_gb": ["database_size", "size", "allocated_storage"],
            "status": ["state", "availability", "health_status"],
        },
    }

    def apply_field_mappings(
        self, data: Dict[str, Any], data_type: DataType
    ) -> Dict[str, Any]:
        """Apply standard field mappings based on data type."""
        if data_type.value not in self.STANDARD_FIELD_MAPPINGS:
            return data

        mappings = self.STANDARD_FIELD_MAPPINGS[data_type.value]
        transformed = {}
        used_fields = set()

        # Apply mappings
        for standard_field, possible_fields in mappings.items():
            for field in possible_fields:
                if field in data and field not in used_fields:
                    transformed[standard_field] = data[field]
                    used_fields.add(field)
                    break

        # Include unmapped fields
        for key, value in data.items():
            if key not in used_fields and key not in transformed:
                transformed[key] = value

        return transformed
