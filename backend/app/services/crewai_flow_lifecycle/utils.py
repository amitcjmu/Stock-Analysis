"""
Utility functions for CrewAI Flow Lifecycle Manager

Contains helper methods for context management, flow validation, and data loading.
Generated by CC for modularization while maintaining backward compatibility.
"""

from typing import TYPE_CHECKING, Any, Dict, List, Optional

if TYPE_CHECKING:
    from app.core.context import RequestContext

from .base import logger, TERMINAL_STATUSES
from app.core.exceptions import InvalidFlowStateError


async def ensure_resume_context(
    flow_id: str, resume_context: Optional[Dict[str, Any]]
) -> Dict[str, Any]:
    """Ensure resume_context has all required fields, fetching from database if needed"""
    if resume_context is None:
        logger.info(
            "üîç resume_context is None, need to fetch flow context from database"
        )
        resume_context = {}

    # If context fields are missing, fetch from master flow record
    if not resume_context.get("client_account_id"):
        from app.core.database import AsyncSessionLocal
        from app.repositories.crewai_flow_state_extensions_repository import (
            CrewAIFlowStateExtensionsRepository,
        )

        async with AsyncSessionLocal() as temp_db:
            temp_repo = CrewAIFlowStateExtensionsRepository(temp_db, None, None, None)
            master_flow = await temp_repo.get_by_flow_id(flow_id)
            if master_flow:
                resume_context.update(
                    {
                        "client_account_id": str(master_flow.client_account_id),
                        "engagement_id": str(master_flow.engagement_id),
                        "user_id": master_flow.user_id,
                        "approved_by": master_flow.user_id,
                    }
                )
                logger.info(
                    f"üîç Populated resume_context from master flow: {resume_context}"
                )

    return resume_context


def create_request_context(resume_context: Dict[str, Any]) -> "RequestContext":
    """Create RequestContext from resume_context"""
    from app.core.context import RequestContext

    return RequestContext(
        client_account_id=resume_context.get("client_account_id"),
        engagement_id=resume_context.get("engagement_id"),
        user_id=resume_context.get("approved_by") or resume_context.get("user_id"),
    )


async def get_or_create_flow(
    flow_id: str, resume_context: Dict[str, Any], discovery_service
):
    """Get flow by ID or create missing discovery flow record"""
    flow = await discovery_service.get_flow_by_id(flow_id)

    if not flow:
        # Check if master flow exists and create missing discovery flow record
        from app.core.database import AsyncSessionLocal
        from sqlalchemy import select
        from app.models.crewai_flow_state_extensions import (
            CrewAIFlowStateExtensions,
        )

        async with AsyncSessionLocal() as db:
            master_flow_query = select(CrewAIFlowStateExtensions).where(
                CrewAIFlowStateExtensions.flow_id == flow_id,
                CrewAIFlowStateExtensions.flow_type == "discovery",
            )
            master_flow_result = await db.execute(master_flow_query)
            master_flow = master_flow_result.scalar_one_or_none()

            if master_flow:
                logger.info(
                    "üîß Master flow found but discovery flow missing, creating discovery flow record"
                )
                # Create missing discovery flow record
                from app.models.discovery_flow import DiscoveryFlow

                discovery_flow = DiscoveryFlow(
                    flow_id=master_flow.flow_id,
                    master_flow_id=master_flow.flow_id,
                    client_account_id=master_flow.client_account_id,
                    engagement_id=master_flow.engagement_id,
                    user_id=master_flow.user_id,
                    flow_name=master_flow.flow_name
                    or f"Discovery Flow {str(master_flow.flow_id)[:8]}",
                    status=master_flow.flow_status,
                    current_phase="resuming",
                    created_at=master_flow.created_at,
                    updated_at=master_flow.updated_at,
                )
                db.add(discovery_flow)
                await db.commit()
                logger.info(f"‚úÖ Created discovery flow record for {flow_id}")

                # Retry getting the flow
                flow = await discovery_service.get_flow_by_id(flow_id)

        if not flow:
            raise ValueError(f"Flow not found: {flow_id}")

    return flow


def validate_flow_for_resumption(flow, flow_id: str) -> None:
    """Validate that flow status allows resumption"""
    # Validate flow status - prevent resuming flows in terminal states
    terminal_statuses = TERMINAL_STATUSES.copy()
    # Allow resuming flows with 'error' or 'failed' status if they can be recovered
    terminal_statuses += ["failed"]

    if flow.status in terminal_statuses:
        logger.warning(
            f"‚ùå Cannot resume flow {flow_id} with terminal status '{flow.status}'"
        )
        raise InvalidFlowStateError(
            current_state=flow.status,
            target_state="resuming",
            flow_id=flow_id,
        )

    # For failed flows, check if they can be recovered
    if flow.status == "failed":
        # Check if the last error was recoverable
        # For now, we'll log a warning but allow the attempt
        logger.warning(
            f"‚ö†Ô∏è Attempting to resume failed flow {flow_id} - this may require manual intervention"
        )

    logger.info(f"‚úÖ Flow {flow_id} status '{flow.status}' is valid for resumption")


async def load_raw_data_for_flow(flow) -> List[Any]:
    """Load raw data records for the flow"""
    from app.core.database import AsyncSessionLocal

    raw_data = []
    if flow.data_import_id:
        from sqlalchemy import select
        from app.models.data_import import RawImportRecord

        async with AsyncSessionLocal() as db:
            records_query = (
                select(RawImportRecord)
                .where(RawImportRecord.data_import_id == flow.data_import_id)
                .order_by(RawImportRecord.row_number)
            )

            records_result = await db.execute(records_query)
            raw_records = records_result.scalars().all()
            raw_data = [record.raw_data for record in raw_records]
            logger.info(f"‚úÖ Loaded {len(raw_data)} raw data records for flow")

    return raw_data


async def create_crewai_flow_instance(context: "RequestContext", flow_id: str):
    """Create and initialize CrewAI flow instance"""
    from app.core.database import AsyncSessionLocal
    from app.services.master_flow_orchestrator import MasterFlowOrchestrator
    from app.services.crewai_flows.unified_discovery_flow.base_flow import (
        UnifiedDiscoveryFlow,
    )
    from app.core.exceptions import CrewAIExecutionError

    async with AsyncSessionLocal() as db:
        # Initialize flow through MasterFlowOrchestrator
        orchestrator = MasterFlowOrchestrator(db, context)

        # Resume the flow using the orchestrator
        resume_result = await orchestrator.resume_flow(flow_id)
        logger.info(f"Flow resumed through MasterFlowOrchestrator: {resume_result}")

        # Initialize actual CrewAI flow for resumption
        try:
            # Note: We need to pass crewai_service - this will be injected
            # from the main service that uses this lifecycle manager
            # This is a circular dependency that needs to be handled in manager.py
            crewai_service = None  # Will be set by the manager
            crewai_flow = UnifiedDiscoveryFlow(
                crewai_service=crewai_service,  # Use injected service
                context=context,
            )
            logger.info("‚úÖ Created UnifiedDiscoveryFlow instance for resumption")
        except Exception as e:
            logger.error(f"‚ùå Failed to create UnifiedDiscoveryFlow: {e}")
            raise CrewAIExecutionError(
                f"Failed to initialize CrewAI flow for resumption: {e}"
            )

        # Load existing flow state (don't re-initialize if already exists)
        if crewai_flow and (
            not hasattr(crewai_flow, "_flow_state") or not crewai_flow._flow_state
        ):
            await crewai_flow.initialize_discovery()

        return crewai_flow


async def create_crewai_flow_instance_with_service(
    context: "RequestContext", flow_id: str, crewai_service=None
):
    """Create CrewAI flow instance with proper service injection"""
    # Create the flow instance using the utility function
    crewai_flow = await create_crewai_flow_instance(context, flow_id)

    # Inject the service if available
    if crewai_service and crewai_flow:
        crewai_flow.crewai_service = crewai_service

    return crewai_flow


async def get_discovery_flow_service(db, context: Dict[str, Any]):
    """Get or create discovery flow service with context."""
    # Create a new database session if one wasn't provided
    from app.core.database import AsyncSessionLocal

    if not db:
        logger.info("üîç Creating new database session for V2 Discovery Flow service")
        db = AsyncSessionLocal()

    # Create RequestContext from the context dict
    from app.core.context import RequestContext

    request_context = RequestContext(
        client_account_id=context.get("client_account_id"),
        engagement_id=context.get("engagement_id"),
        user_id=context.get("approved_by") or context.get("user_id"),
    )

    from app.services.discovery_flow_service import DiscoveryFlowService

    return DiscoveryFlowService(db, request_context)
