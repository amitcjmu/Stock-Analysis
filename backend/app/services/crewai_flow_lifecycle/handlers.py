"""
Flow resumption handlers for CrewAI Flow Lifecycle Manager

Contains specialized handlers for different flow resumption scenarios.
Generated by CC for modularization while maintaining backward compatibility.
"""

from datetime import datetime
from typing import TYPE_CHECKING, Any, Dict

if TYPE_CHECKING:
    from app.services.crewai_flows.unified_discovery_flow import UnifiedDiscoveryFlow

from .base import logger, PHASE_METHOD_MAP
from app.core.exceptions import CrewAIExecutionError


async def handle_flow_resumption(
    crewai_flow: "UnifiedDiscoveryFlow",
    flow: Any,
    resume_context: Dict[str, Any],
) -> Dict[str, Any]:
    """
    Handle specific flow resumption scenarios.

    Args:
        crewai_flow: The CrewAI flow instance
        flow: The database flow record
        resume_context: Resume context data

    Returns:
        Dict containing resumption result
    """
    # Resume from field mapping approval using CrewAI event listener system
    # Check for both 'waiting_for_approval' and other paused statuses where approval might be needed
    # Note: The phase might be stored as either 'field_mapping' or 'attribute_mapping'
    if (
        flow.status in ["waiting_for_approval", "processing"]
        and flow.current_phase in ["field_mapping", "attribute_mapping"]
        and resume_context.get("user_approval") is True
    ):
        logger.info(
            f"üîÑ Resuming CrewAI Flow from field mapping approval: {flow.flow_id}"
        )

        # Validate crewai_flow before accessing state
        if not crewai_flow:
            raise CrewAIExecutionError("CrewAI flow is None - cannot update flow state")
        if not hasattr(crewai_flow, "state"):
            raise CrewAIExecutionError("CrewAI flow does not have state attribute")

        # Update the flow state to indicate user approval
        crewai_flow.state.awaiting_user_approval = False
        crewai_flow.state.status = "processing"

        # Add user approval context
        if "user_approval" in resume_context:
            crewai_flow.state.user_approval_data["approved"] = resume_context[
                "user_approval"
            ]
            crewai_flow.state.user_approval_data["approved_at"] = resume_context.get(
                "approval_timestamp"
            )
            crewai_flow.state.user_approval_data["notes"] = resume_context.get(
                "notes", ""
            )

        # First generate field mapping suggestions if they don't exist
        logger.info("üîç Checking if field mappings already exist in state")
        mappings_exist = False
        if (
            hasattr(crewai_flow.state, "field_mappings")
            and crewai_flow.state.field_mappings
        ):
            # Check if actual mappings exist (not just the structure)
            if isinstance(crewai_flow.state.field_mappings, dict):
                mappings = crewai_flow.state.field_mappings.get("mappings", {})
                mappings_exist = len(mappings) > 0
                logger.info(
                    f"üîç TESTING: Field mappings structure check - "
                    f"outer dict len: {len(crewai_flow.state.field_mappings)}, "
                    f"mappings len: {len(mappings)}"
                )

        if not mappings_exist:
            logger.info(
                "ü§ñ No actual field mappings found, generating suggestions first"
            )
            # Generate field mapping suggestions using the CrewAI agents
            suggestion_result = await crewai_flow.generate_field_mapping_suggestions(
                "data_validation_completed"
            )
            logger.info(f"‚úÖ Generated field mapping suggestions: {suggestion_result}")
        else:
            logger.info("‚úÖ Field mappings already exist: actual mappings found")

        # Now apply the approved field mappings
        logger.info("üéØ Triggering apply_approved_field_mappings listener")
        if not crewai_flow:
            raise CrewAIExecutionError(
                "CrewAI flow is None - cannot apply field mappings"
            )
        result = await crewai_flow.apply_approved_field_mappings(
            "field_mapping_approved"
        )
        return result

    else:
        # For other states, use the standard flow resumption
        logger.info(
            f"üîÑ Resuming flow from current state: {flow.status}, phase: {flow.current_phase}"
        )
        if not crewai_flow:
            raise CrewAIExecutionError(
                "CrewAI flow is None - cannot resume flow from state"
            )
        if not hasattr(crewai_flow, "resume_flow_from_state"):
            raise CrewAIExecutionError(
                "CrewAI flow does not support resume_flow_from_state method"
            )
        result = await crewai_flow.resume_flow_from_state(resume_context)
        return result


async def handle_phase_resumption(
    flow_id: str, phase: str, resume_context: Dict[str, Any], discovery_service
) -> Dict[str, Any]:
    """
    Handle resumption at a specific phase.

    Args:
        flow_id: Discovery Flow ID
        phase: Target phase to resume at
        resume_context: Context including human input and phase data
        discovery_service: Discovery flow service instance

    Returns:
        Dict containing phase resume result
    """
    try:
        logger.info(f"‚ñ∂Ô∏è Resuming CrewAI flow at phase: {flow_id} -> {phase}")

        # Get current flow state
        flow = await discovery_service.get_flow_by_id(flow_id)

        if not flow:
            raise ValueError(f"Flow not found: {flow_id}")

        # Execute the specific phase node
        method_name = PHASE_METHOD_MAP.get(
            phase, "execute_attribute_mapping_agent_method"
        )

        result = {
            "status": "resumed_at_phase",
            "flow_id": flow_id,
            "target_phase": phase,
            "resumed_at": datetime.now().isoformat(),
            "method": "crewai_flow_phase_resume",
            "phase_method": method_name,
            "human_input": resume_context.get("human_input"),
            "resume_context": resume_context,
        }

        logger.info(f"‚úÖ CrewAI flow resumed at phase: {flow_id} -> {phase}")
        return result

    except Exception as e:
        logger.warning(f"‚ö†Ô∏è CrewAI phase resume failed: {e}")
        # Fallback to PostgreSQL state management
        return {
            "status": "resumed_at_phase",
            "flow_id": flow_id,
            "target_phase": phase,
            "resumed_at": datetime.now().isoformat(),
            "method": "postgresql_state_phase_resume",
            "error": str(e),
            "note": "CrewAI phase resume failed, using state management",
        }
