"""
System alert management for monitoring dashboard.

Generated by CC (Claude Code)
"""

import time
from collections import deque
from typing import Any, Dict

from app.core.logging import get_logger

from ..base import AlertSeverity, SystemAlert

logger = get_logger(__name__)


class SystemAlertManager:
    """Manages system alerts and alert history."""

    def __init__(self, alert_thresholds: Dict[str, Any]):
        """
        Initialize system alert manager.

        Args:
            alert_thresholds: Alert threshold configuration
        """
        self.alert_thresholds = alert_thresholds
        self.active_alerts: Dict[str, SystemAlert] = {}
        self.alert_history: deque[SystemAlert] = deque(maxlen=1000)

    def process_alerts(
        self,
        auth_stats: Dict[str, Any],
        cache_stats: Dict[str, Any],
        system_stats: Dict[str, Any],
    ) -> None:
        """Process and manage system alerts"""
        current_time = time.time()

        # Check authentication alerts
        auth_success_rate = auth_stats.get("overall_summary", {}).get(
            "overall_success_rate", 100
        )
        if auth_success_rate < self.alert_thresholds.get(
            "auth_success_rate_threshold", 95
        ):
            alert_id = "auth_success_rate_low"
            if alert_id not in self.active_alerts:
                alert = SystemAlert(
                    id=alert_id,
                    title="Low Authentication Success Rate",
                    message=f"Authentication success rate is {auth_success_rate:.1f}%",
                    severity=AlertSeverity.WARNING,
                    timestamp=current_time,
                    metric_value=auth_success_rate,
                    threshold_value=self.alert_thresholds.get(
                        "auth_success_rate_threshold", 95
                    ),
                    component="authentication",
                )
                self.active_alerts[alert_id] = alert
                self.alert_history.append(alert)
                logger.warning(f"Alert triggered: {alert.title}")
        else:
            # Remove alert if condition is resolved
            if "auth_success_rate_low" in self.active_alerts:
                del self.active_alerts["auth_success_rate_low"]

        # Check cache alerts
        cache_hit_rate = cache_stats.get("overall_summary", {}).get(
            "overall_hit_rate", 100
        )
        cache_hit_threshold = self.alert_thresholds.get("cache_hit_rate_threshold", 80)
        if cache_hit_rate < cache_hit_threshold:
            alert_id = "cache_hit_rate_low"
            if alert_id not in self.active_alerts:
                alert = SystemAlert(
                    id=alert_id,
                    title="Low Cache Hit Rate",
                    message=f"Cache hit rate is {cache_hit_rate:.1f}%",
                    severity=AlertSeverity.WARNING,
                    timestamp=current_time,
                    metric_value=cache_hit_rate,
                    threshold_value=cache_hit_threshold,
                    component="cache",
                )
                self.active_alerts[alert_id] = alert
                self.alert_history.append(alert)
                logger.warning(f"Alert triggered: {alert.title}")
        else:
            if "cache_hit_rate_low" in self.active_alerts:
                del self.active_alerts["cache_hit_rate_low"]

        # Check system resource alerts
        cpu_usage = system_stats.get("cpu_usage_percent", 0)
        cpu_threshold = self.alert_thresholds.get("cpu_usage_threshold", 85)
        if cpu_usage > cpu_threshold:
            alert_id = "cpu_usage_high"
            if alert_id not in self.active_alerts:
                alert = SystemAlert(
                    id=alert_id,
                    title="High CPU Usage",
                    message=f"CPU usage is {cpu_usage:.1f}%",
                    severity=(
                        AlertSeverity.CRITICAL
                        if cpu_usage > 95
                        else AlertSeverity.WARNING
                    ),
                    timestamp=current_time,
                    metric_value=cpu_usage,
                    threshold_value=cpu_threshold,
                    component="system",
                )
                self.active_alerts[alert_id] = alert
                self.alert_history.append(alert)
                logger.warning(f"Alert triggered: {alert.title}")
        else:
            if "cpu_usage_high" in self.active_alerts:
                del self.active_alerts["cpu_usage_high"]

        # Check memory usage alerts
        memory_usage = system_stats.get("memory_usage_percent", 0)
        memory_threshold = self.alert_thresholds.get("memory_usage_threshold", 90)
        if memory_usage > memory_threshold:
            alert_id = "memory_usage_high"
            if alert_id not in self.active_alerts:
                alert = SystemAlert(
                    id=alert_id,
                    title="High Memory Usage",
                    message=f"Memory usage is {memory_usage:.1f}%",
                    severity=(
                        AlertSeverity.CRITICAL
                        if memory_usage > 95
                        else AlertSeverity.WARNING
                    ),
                    timestamp=current_time,
                    metric_value=memory_usage,
                    threshold_value=memory_threshold,
                    component="system",
                )
                self.active_alerts[alert_id] = alert
                self.alert_history.append(alert)
                logger.warning(f"Alert triggered: {alert.title}")
        else:
            if "memory_usage_high" in self.active_alerts:
                del self.active_alerts["memory_usage_high"]

        # Check disk usage alerts
        disk_usage = system_stats.get("disk_usage_percent", 0)
        disk_threshold = self.alert_thresholds.get("disk_usage_threshold", 90)
        if disk_usage > disk_threshold:
            alert_id = "disk_usage_high"
            if alert_id not in self.active_alerts:
                alert = SystemAlert(
                    id=alert_id,
                    title="High Disk Usage",
                    message=f"Disk usage is {disk_usage:.1f}%",
                    severity=(
                        AlertSeverity.CRITICAL
                        if disk_usage > 95
                        else AlertSeverity.WARNING
                    ),
                    timestamp=current_time,
                    metric_value=disk_usage,
                    threshold_value=disk_threshold,
                    component="system",
                )
                self.active_alerts[alert_id] = alert
                self.alert_history.append(alert)
                logger.warning(f"Alert triggered: {alert.title}")
        else:
            if "disk_usage_high" in self.active_alerts:
                del self.active_alerts["disk_usage_high"]

    def get_active_alerts(self) -> Dict[str, SystemAlert]:
        """Get all active alerts"""
        return self.active_alerts.copy()

    def get_alert_history(self) -> list[SystemAlert]:
        """Get alert history"""
        return list(self.alert_history)

    def clear_alert(self, alert_id: str) -> bool:
        """Clear a specific alert"""
        if alert_id in self.active_alerts:
            del self.active_alerts[alert_id]
            logger.info(f"Alert cleared: {alert_id}")
            return True
        return False

    def get_alert_summary(self) -> Dict[str, Any]:
        """Get alert summary statistics"""
        severity_counts = {"CRITICAL": 0, "WARNING": 0, "INFO": 0}

        for alert in self.active_alerts.values():
            severity_counts[alert.severity.value] += 1

        return {
            "active_alerts": len(self.active_alerts),
            "total_alerts_today": len(
                [a for a in self.alert_history if time.time() - a.timestamp < 86400]
            ),
            "severity_breakdown": severity_counts,
            "oldest_active_alert": min(
                [alert.timestamp for alert in self.active_alerts.values()], default=None
            ),
        }
