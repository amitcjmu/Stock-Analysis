"""
Health score calculation logic for system monitoring.

Generated by CC (Claude Code)
"""

from typing import Any, Dict

from ..base import HealthScore, HealthStatus


class HealthScoreCalculator:
    """Calculates health scores for various system components."""

    def __init__(self, performance_targets: Dict[str, Any]):
        """
        Initialize health score calculator.

        Args:
            performance_targets: Performance target thresholds
        """
        self.performance_targets = performance_targets

    def calculate_all_health_scores(
        self,
        auth_stats: Dict[str, Any],
        cache_stats: Dict[str, Any],
        system_stats: Dict[str, Any],
    ) -> Dict[str, HealthScore]:
        """Calculate health scores for all components"""
        health_scores = {}

        # Auth performance score
        health_scores["auth_performance"] = self.calculate_auth_health_score(auth_stats)

        # Cache performance score
        health_scores["cache_performance"] = self.calculate_cache_health_score(
            cache_stats
        )

        # System resources score
        health_scores["system_resources"] = self.calculate_system_health_score(
            system_stats
        )

        # Overall health score
        health_scores["overall"] = self.calculate_overall_health(health_scores)

        return health_scores

    def calculate_auth_health_score(self, auth_stats: Dict[str, Any]) -> HealthScore:
        """Calculate authentication performance health score"""
        try:
            factors = {}
            overall_summary = auth_stats.get("overall_summary", {})
            operations = auth_stats.get("operations", {})

            # Success rate factor (40% weight)
            success_rate = overall_summary.get("overall_success_rate", 0)
            success_factor = min(success_rate / 95.0 * 100, 100)  # Target: 95%+
            factors["success_rate"] = success_factor

            # Login performance factor (30% weight)
            login_stats = operations.get("login", {})
            login_p95_ms = login_stats.get("p95_duration_ms", 0)
            if login_p95_ms > 0:
                login_factor = max(
                    0,
                    100
                    - (
                        (login_p95_ms - self.performance_targets["login_target_ms"])
                        / 10
                    ),
                )
            else:
                login_factor = 50  # Neutral score when no data
            factors["login_performance"] = login_factor

            # Context switching factor (20% weight)
            context_stats = operations.get("context_switch", {})
            context_p95_ms = context_stats.get("p95_duration_ms", 0)
            if context_p95_ms > 0:
                context_factor = max(
                    0,
                    100
                    - (
                        (
                            context_p95_ms
                            - self.performance_targets["context_switch_target_ms"]
                        )
                        / 5
                    ),
                )
            else:
                context_factor = 50
            factors["context_switching"] = context_factor

            # Error rate factor (10% weight)
            error_rate = overall_summary.get("overall_error_rate", 0)
            error_factor = max(0, 100 - (error_rate * 10))  # Penalty: 10 points per 1%
            factors["error_rate"] = error_factor

            # Calculate weighted score
            weighted_score = (
                success_factor * 0.4
                + login_factor * 0.3
                + context_factor * 0.2
                + error_factor * 0.1
            )

            # Determine status
            if weighted_score >= 90:
                status = HealthStatus.EXCELLENT
            elif weighted_score >= 75:
                status = HealthStatus.GOOD
            elif weighted_score >= 60:
                status = HealthStatus.WARNING
            else:
                status = HealthStatus.CRITICAL

            return HealthScore(
                score=round(weighted_score, 1),
                status=status,
                factors=factors,
                timestamp=overall_summary.get("collection_time", ""),
            )

        except Exception:
            return HealthScore(
                score=0.0,
                status=HealthStatus.CRITICAL,
                factors={},
                timestamp="",
            )

    def calculate_cache_health_score(self, cache_stats: Dict[str, Any]) -> HealthScore:
        """Calculate cache performance health score"""
        try:
            factors = {}
            overall_summary = cache_stats.get("overall_summary", {})

            # Hit rate factor (50% weight)
            hit_rate = overall_summary.get("overall_hit_rate", 0)
            hit_factor = min(hit_rate / 85.0 * 100, 100)  # Target: 85%+
            factors["hit_rate"] = hit_factor

            # Response time factor (30% weight)
            avg_response_ms = overall_summary.get("average_response_time_ms", 0)
            if avg_response_ms > 0:
                response_factor = max(
                    0,
                    100
                    - (
                        (avg_response_ms - self.performance_targets["cache_target_ms"])
                        / 2
                    ),
                )
            else:
                response_factor = 50
            factors["response_time"] = response_factor

            # Error rate factor (20% weight)
            error_rate = overall_summary.get("overall_error_rate", 0)
            error_factor = max(0, 100 - (error_rate * 20))
            factors["error_rate"] = error_factor

            # Calculate weighted score
            weighted_score = (
                hit_factor * 0.5 + response_factor * 0.3 + error_factor * 0.2
            )

            # Determine status
            if weighted_score >= 90:
                status = HealthStatus.EXCELLENT
            elif weighted_score >= 75:
                status = HealthStatus.GOOD
            elif weighted_score >= 60:
                status = HealthStatus.WARNING
            else:
                status = HealthStatus.CRITICAL

            return HealthScore(
                score=round(weighted_score, 1),
                status=status,
                factors=factors,
                timestamp=overall_summary.get("collection_time", ""),
            )

        except Exception:
            return HealthScore(
                score=0.0,
                status=HealthStatus.CRITICAL,
                factors={},
                timestamp="",
            )

    def calculate_system_health_score(
        self, system_stats: Dict[str, Any]
    ) -> HealthScore:
        """Calculate system resources health score"""
        try:
            factors = {}

            # CPU usage factor (40% weight)
            cpu_usage = system_stats.get("cpu_usage_percent", 0)
            cpu_factor = max(0, 100 - max(0, (cpu_usage - 70) * 2))  # Penalty after 70%
            factors["cpu_usage"] = cpu_factor

            # Memory usage factor (40% weight)
            memory_usage = system_stats.get("memory_usage_percent", 0)
            memory_factor = max(
                0, 100 - max(0, (memory_usage - 80) * 2.5)
            )  # Penalty after 80%
            factors["memory_usage"] = memory_factor

            # Disk usage factor (20% weight)
            disk_usage = system_stats.get("disk_usage_percent", 0)
            disk_factor = max(
                0, 100 - max(0, (disk_usage - 85) * 5)
            )  # Penalty after 85%
            factors["disk_usage"] = disk_factor

            # Calculate weighted score
            weighted_score = cpu_factor * 0.4 + memory_factor * 0.4 + disk_factor * 0.2

            # Determine status
            if weighted_score >= 90:
                status = HealthStatus.EXCELLENT
            elif weighted_score >= 75:
                status = HealthStatus.GOOD
            elif weighted_score >= 60:
                status = HealthStatus.WARNING
            else:
                status = HealthStatus.CRITICAL

            return HealthScore(
                score=round(weighted_score, 1),
                status=status,
                factors=factors,
                timestamp=system_stats.get("collection_time", ""),
            )

        except Exception:
            return HealthScore(
                score=0.0,
                status=HealthStatus.CRITICAL,
                factors={},
                timestamp="",
            )

    def calculate_overall_health(
        self, health_scores: Dict[str, HealthScore]
    ) -> HealthScore:
        """Calculate overall system health from component scores"""
        try:
            # Extract scores
            auth_score = health_scores.get(
                "auth_performance", HealthScore(0.0, HealthStatus.CRITICAL)
            ).score
            cache_score = health_scores.get(
                "cache_performance", HealthScore(0.0, HealthStatus.CRITICAL)
            ).score
            system_score = health_scores.get(
                "system_resources", HealthScore(0.0, HealthStatus.CRITICAL)
            ).score

            # Calculate weighted overall score
            overall_score = (
                auth_score * 0.4  # Auth is critical
                + cache_score * 0.35  # Cache performance is important
                + system_score * 0.25  # System resources baseline
            )

            # Determine overall status (most restrictive approach)
            statuses = [score.status for score in health_scores.values()]
            if HealthStatus.CRITICAL in statuses:
                status = HealthStatus.CRITICAL
            elif HealthStatus.WARNING in statuses:
                status = HealthStatus.WARNING
            elif HealthStatus.GOOD in statuses:
                status = HealthStatus.GOOD
            else:
                status = HealthStatus.EXCELLENT

            return HealthScore(
                score=round(overall_score, 1),
                status=status,
                factors={
                    "auth_weight": 0.4,
                    "cache_weight": 0.35,
                    "system_weight": 0.25,
                },
                timestamp="",
            )

        except Exception:
            return HealthScore(
                score=0.0,
                status=HealthStatus.CRITICAL,
                factors={},
                timestamp="",
            )

    def calculate_user_experience_score(
        self, auth_stats: Dict[str, Any], cache_stats: Dict[str, Any]
    ) -> float:
        """Calculate user experience score based on performance metrics"""
        try:
            factors = []

            # Login experience (40% weight)
            auth_ops = auth_stats.get("operations", {})
            login_p95 = auth_ops.get("login", {}).get("p95_duration_ms", 0)
            if login_p95 > 0:
                login_score = max(0, 100 - (login_p95 - 500) / 10)  # Target: 500ms
                factors.append(login_score * 0.4)

            # Cache responsiveness (35% weight)
            cache_avg_ms = cache_stats.get("overall_summary", {}).get(
                "average_response_time_ms", 0
            )
            if cache_avg_ms > 0:
                cache_score = max(0, 100 - (cache_avg_ms - 10) / 2)  # Target: 10ms
                factors.append(cache_score * 0.35)

            # Context switching speed (25% weight)
            context_p95 = auth_ops.get("context_switch", {}).get("p95_duration_ms", 0)
            if context_p95 > 0:
                context_score = max(0, 100 - (context_p95 - 200) / 5)  # Target: 200ms
                factors.append(context_score * 0.25)

            return sum(factors) if factors else 50.0

        except Exception:
            return 50.0
