"""
CrewAI Security Validator

Validates that all CrewAI flow persistence and agent management components
properly implement security best practices including encryption, tenant isolation,
and secure cache key generation.

Generated by CC (Claude Code)
"""

import logging
from typing import Any, Dict, List, Optional

from app.constants.cache_keys import CacheKeys, SensitiveDataMarkers
from app.core.context import RequestContext
from app.core.security.cache_encryption import cache_encryption, is_sensitive_field

logger = logging.getLogger(__name__)


class SecurityViolation:
    """Represents a security violation found during validation"""

    def __init__(
        self,
        violation_type: str,
        severity: str,
        component: str,
        description: str,
        recommendation: str,
        data_sample: Optional[str] = None,
    ):
        self.violation_type = violation_type
        self.severity = severity  # 'critical', 'high', 'medium', 'low'
        self.component = component
        self.description = description
        self.recommendation = recommendation
        self.data_sample = data_sample

    def to_dict(self) -> Dict[str, Any]:
        return {
            "violation_type": self.violation_type,
            "severity": self.severity,
            "component": self.component,
            "description": self.description,
            "recommendation": self.recommendation,
            "data_sample": self.data_sample,
        }


class CrewAISecurityValidator:
    """
    Validates security implementation across CrewAI components
    """

    def __init__(self):
        self.violations: List[SecurityViolation] = []

    def validate_cache_key_security(self, cache_key: str) -> List[SecurityViolation]:
        """Validate cache key security implementation"""
        violations = []

        # Check version prefix
        if not cache_key.startswith("v1:"):
            violations.append(
                SecurityViolation(
                    violation_type="missing_version_prefix",
                    severity="high",
                    component="cache_keys",
                    description=f"Cache key missing version prefix: {cache_key}",
                    recommendation="All cache keys must start with CACHE_VERSION prefix for schema evolution",
                    data_sample=cache_key,
                )
            )

        # Check tenant isolation
        if ":client:" not in cache_key and not cache_key.startswith("v1:admin:"):
            violations.append(
                SecurityViolation(
                    violation_type="missing_tenant_isolation",
                    severity="critical",
                    component="cache_keys",
                    description=f"Cache key missing tenant isolation: {cache_key}",
                    recommendation="All cache keys must include client_account_id for tenant isolation",
                    data_sample=cache_key,
                )
            )

        # Check if sensitive data requires encryption
        if SensitiveDataMarkers.requires_encryption(cache_key):
            violations.append(
                SecurityViolation(
                    violation_type="sensitive_data_detected",
                    severity="critical",
                    component="cache_keys",
                    description=f"Cache key contains sensitive data requiring encryption: {cache_key}",
                    recommendation="Use SecureCache with force_encrypt=True for this key",
                    data_sample=cache_key,
                )
            )

        return violations

    def validate_flow_state_security(self, flow_state: Dict[str, Any]) -> List[SecurityViolation]:
        """Validate flow state data security"""
        violations = []

        # Check for sensitive fields in flow state
        sensitive_fields_found = []
        for key, value in flow_state.items():
            if is_sensitive_field(key):
                sensitive_fields_found.append(key)

        if sensitive_fields_found:
            violations.append(
                SecurityViolation(
                    violation_type="unencrypted_sensitive_data",
                    severity="critical",
                    component="flow_state",
                    description=f"Flow state contains sensitive fields: {sensitive_fields_found}",
                    recommendation="Use SecureCheckpointManager and encrypt before persistence",
                    data_sample=str(sensitive_fields_found),
                )
            )

        # Check for tenant context
        required_tenant_fields = ["client_account_id", "engagement_id", "user_id"]
        missing_tenant_fields = [field for field in required_tenant_fields if field not in flow_state]

        if missing_tenant_fields:
            violations.append(
                SecurityViolation(
                    violation_type="missing_tenant_context",
                    severity="high",
                    component="flow_state",
                    description=f"Flow state missing tenant context fields: {missing_tenant_fields}",
                    recommendation="Include all tenant context fields for proper isolation",
                    data_sample=str(missing_tenant_fields),
                )
            )

        # Check for raw data exposure
        if "raw_data" in flow_state and isinstance(flow_state["raw_data"], list):
            if len(flow_state["raw_data"]) > 0:
                violations.append(
                    SecurityViolation(
                        violation_type="raw_data_exposure",
                        severity="medium",
                        component="flow_state",
                        description="Flow state contains raw data that should be encrypted",
                        recommendation="Encrypt raw data before storing in flow state",
                        data_sample="raw_data field present",
                    )
                )

        return violations

    def validate_agent_configuration_security(self, agent_config: Dict[str, Any]) -> List[SecurityViolation]:
        """Validate agent configuration security"""
        violations = []

        # Check for tool configurations with sensitive data
        if "tools_config" in agent_config:
            tools_config = agent_config["tools_config"]
            if isinstance(tools_config, dict):
                for tool_name, tool_config in tools_config.items():
                    if isinstance(tool_config, dict):
                        for key, value in tool_config.items():
                            if is_sensitive_field(key):
                                violations.append(
                                    SecurityViolation(
                                        violation_type="unencrypted_tool_credentials",
                                        severity="critical",
                                        component="agent_configuration",
                                        description=f"Tool '{tool_name}' has unencrypted sensitive field '{key}'",
                                        recommendation="Use SecureAgentRegistry to encrypt tool configurations",
                                        data_sample=f"{tool_name}.{key}",
                                    )
                                )

        # Check for agent metadata exposure
        if "metadata" in agent_config:
            metadata = agent_config["metadata"]
            if isinstance(metadata, dict) and "required_tools" in metadata:
                violations.append(
                    SecurityViolation(
                        violation_type="metadata_exposure",
                        severity="low",
                        component="agent_configuration",
                        description="Agent metadata includes tool requirements that could expose capabilities",
                        recommendation="Consider encrypting agent metadata or storing separately",
                        data_sample="metadata.required_tools",
                    )
                )

        return violations

    def validate_checkpoint_security(self, checkpoint_data: Dict[str, Any]) -> List[SecurityViolation]:
        """Validate checkpoint data security"""
        violations = []

        # Check for security context
        if "security_context" not in checkpoint_data:
            violations.append(
                SecurityViolation(
                    violation_type="missing_security_context",
                    severity="high",
                    component="checkpoint",
                    description="Checkpoint missing security context metadata",
                    recommendation="Include security_context with encryption and tenant info",
                    data_sample="security_context field missing",
                )
            )
        else:
            security_context = checkpoint_data["security_context"]
            if not security_context.get("encrypted", False):
                violations.append(
                    SecurityViolation(
                        violation_type="unencrypted_checkpoint",
                        severity="critical",
                        component="checkpoint",
                        description="Checkpoint not marked as encrypted",
                        recommendation="Use SecureCheckpointManager for encrypted checkpoints",
                        data_sample="security_context.encrypted=False",
                    )
                )

        # Check for state snapshot security
        if "state_snapshot" in checkpoint_data:
            state_violations = self.validate_flow_state_security(checkpoint_data["state_snapshot"])
            violations.extend(state_violations)

        return violations

    def validate_cache_implementation(self, cache_client: Any) -> List[SecurityViolation]:
        """Validate cache client implementation"""
        violations = []

        # Check if using SecureCache wrapper
        if not hasattr(cache_client, 'encryption'):
            violations.append(
                SecurityViolation(
                    violation_type="insecure_cache_client",
                    severity="high",
                    component="cache_implementation",
                    description="Cache client not using SecureCache wrapper",
                    recommendation="Use SecureCache wrapper for automatic encryption",
                    data_sample=type(cache_client).__name__,
                )
            )

        # Check encryption availability
        if hasattr(cache_client, 'encryption') and not cache_client.encryption.is_encryption_available():
            violations.append(
                SecurityViolation(
                    violation_type="encryption_unavailable",
                    severity="critical",
                    component="cache_implementation",
                    description="Cache encryption not properly configured",
                    recommendation="Ensure SECRET_KEY is set and CacheEncryption is initialized",
                    data_sample="encryption not available",
                )
            )

        return violations

    def run_comprehensive_validation(
        self,
        context: RequestContext,
        sample_data: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """Run comprehensive security validation"""
        all_violations = []

        # Validate cache encryption setup
        if not cache_encryption.is_encryption_available():
            all_violations.append(
                SecurityViolation(
                    violation_type="encryption_setup_failure",
                    severity="critical",
                    component="cache_encryption",
                    description="Cache encryption system not properly initialized",
                    recommendation="Check SECRET_KEY configuration and CacheEncryption setup",
                    data_sample="encryption unavailable",
                )
            )

        # Validate cache key patterns
        test_keys = [
            CacheKeys.crewai_flow_state("test_flow", "test_phase", str(context.client_account_id), str(context.engagement_id)),
            CacheKeys.agent_configuration("test_agent", "test_type", str(context.client_account_id)),
            CacheKeys.flow_checkpoint("test_flow", "test_checkpoint", str(context.client_account_id), str(context.engagement_id)),
            CacheKeys.agent_memory_context("test_agent", "test_context", str(context.client_account_id)),
        ]

        for key in test_keys:
            key_violations = self.validate_cache_key_security(key)
            all_violations.extend(key_violations)

        # Validate sample data if provided
        if sample_data:
            if "flow_state" in sample_data:
                flow_violations = self.validate_flow_state_security(sample_data["flow_state"])
                all_violations.extend(flow_violations)

            if "agent_config" in sample_data:
                agent_violations = self.validate_agent_configuration_security(sample_data["agent_config"])
                all_violations.extend(agent_violations)

            if "checkpoint" in sample_data:
                checkpoint_violations = self.validate_checkpoint_security(sample_data["checkpoint"])
                all_violations.extend(checkpoint_violations)

        # Categorize violations by severity
        critical_violations = [v for v in all_violations if v.severity == "critical"]
        high_violations = [v for v in all_violations if v.severity == "high"]
        medium_violations = [v for v in all_violations if v.severity == "medium"]
        low_violations = [v for v in all_violations if v.severity == "low"]

        return {
            "total_violations": len(all_violations),
            "critical_violations": len(critical_violations),
            "high_violations": len(high_violations),
            "medium_violations": len(medium_violations),
            "low_violations": len(low_violations),
            "violations": [v.to_dict() for v in all_violations],
            "security_status": "FAIL" if critical_violations or high_violations else "PASS",
            "recommendations": self._generate_recommendations(all_violations),
        }

    def _generate_recommendations(self, violations: List[SecurityViolation]) -> List[str]:
        """Generate prioritized security recommendations"""
        recommendations = []

        # Critical issues first
        critical_violations = [v for v in violations if v.severity == "critical"]
        if critical_violations:
            recommendations.append("CRITICAL: Address encryption and tenant isolation issues immediately")
            for violation in critical_violations[:3]:  # Top 3 critical issues
                recommendations.append(f"- {violation.recommendation}")

        # High priority issues
        high_violations = [v for v in violations if v.severity == "high"]
        if high_violations:
            recommendations.append("HIGH: Implement proper security controls")
            for violation in high_violations[:2]:  # Top 2 high issues
                recommendations.append(f"- {violation.recommendation}")

        # General recommendations
        if any(v.violation_type == "missing_version_prefix" for v in violations):
            recommendations.append("Ensure all cache keys use CACHE_VERSION prefix")

        if any(v.violation_type == "missing_tenant_isolation" for v in violations):
            recommendations.append("Implement proper tenant isolation in all cache keys")

        if any(v.violation_type == "unencrypted_sensitive_data" for v in violations):
            recommendations.append("Use SecureCache and SecureCheckpointManager consistently")

        return recommendations


def validate_crewai_security(context: RequestContext, sample_data: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
    """
    Convenience function to run CrewAI security validation
    
    Args:
        context: Request context for tenant information
        sample_data: Optional sample data to validate
        
    Returns:
        Validation results dictionary
    """
    validator = CrewAISecurityValidator()
    return validator.run_comprehensive_validation(context, sample_data)


def log_security_violations(validation_results: Dict[str, Any]) -> None:
    """Log security violations with appropriate severity levels"""
    if validation_results["critical_violations"] > 0:
        logger.critical(f"CRITICAL SECURITY VIOLATIONS FOUND: {validation_results['critical_violations']}")
        
    if validation_results["high_violations"] > 0:
        logger.error(f"High severity security violations: {validation_results['high_violations']}")
        
    if validation_results["medium_violations"] > 0:
        logger.warning(f"Medium severity security violations: {validation_results['medium_violations']}")
        
    if validation_results["security_status"] == "PASS":
        logger.info("âœ… CrewAI security validation passed")
    else:
        logger.error("âŒ CrewAI security validation failed")
        
    # Log recommendations
    for recommendation in validation_results["recommendations"]:
        logger.info(f"ğŸ’¡ {recommendation}")