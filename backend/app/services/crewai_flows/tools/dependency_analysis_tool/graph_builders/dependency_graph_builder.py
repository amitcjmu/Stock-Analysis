"""
Dependency graph building logic.

Generated by CC (Claude Code)
"""

import uuid
from typing import Any, Dict, List

from ..base import (
    RISK_MEDIUM,
    DEPENDENCY_TYPE_DATA_FLOW,
    DEPENDENCY_TYPE_NETWORK,
)


class DependencyGraphBuilder:
    """Handles building dependency graphs from asset and dependency data."""

    @staticmethod
    def build_dependency_graph(
        assets: List[Dict[str, Any]],
        network_deps: List[Dict[str, Any]],
        config_deps: List[Dict[str, Any]],
        data_deps: List[Dict[str, Any]],
        service_deps: List[Dict[str, Any]],
    ) -> Dict[str, Any]:
        """Build comprehensive dependency graph"""
        nodes = []
        edges = []
        edge_id = 0

        # Create nodes for all assets
        for asset in assets:
            nodes.append(
                {
                    "id": str(asset.get("id", uuid.uuid4())),
                    "label": asset.get("name", "Unknown"),
                    "type": asset.get("asset_type", "unknown"),
                    "environment": asset.get("environment", "unknown"),
                    "criticality": asset.get("business_criticality", RISK_MEDIUM),
                    "metadata": {
                        "department": asset.get("department"),
                        "owner": asset.get("business_owner"),
                        "technology": asset.get("technology_stack"),
                    },
                }
            )

        # Create edges from dependencies

        # Process data dependencies (most reliable)
        for dep in data_deps:
            source_id = dep["asset_id"]
            for flow in dep.get("data_flows", []):
                # Find target asset by name
                target_asset = next(
                    (a for a in assets if a.get("name") == flow["source"]), None
                )
                if target_asset:
                    edge_id += 1
                    edges.append(
                        {
                            "id": f"edge_{edge_id}",
                            "source": str(target_asset.get("id", uuid.uuid4())),
                            "target": source_id,
                            "type": DEPENDENCY_TYPE_DATA_FLOW,
                            "label": flow["flow_type"],
                            "confidence": flow["confidence"],
                        }
                    )

        # Process network dependencies
        for dep in network_deps:
            source_id = dep["asset_id"]
            for conn in dep.get("connections", []):
                if conn["type"] == "explicit":
                    # Try to find target asset
                    target_name = conn["value"]
                    target_asset = next(
                        (a for a in assets if target_name in a.get("name", "")), None
                    )
                    if target_asset:
                        edge_id += 1
                        edges.append(
                            {
                                "id": f"edge_{edge_id}",
                                "source": source_id,
                                "target": str(target_asset.get("id", uuid.uuid4())),
                                "type": DEPENDENCY_TYPE_NETWORK,
                                "label": "network_connection",
                                "confidence": 0.8,
                            }
                        )

        # Process configuration dependencies
        for dep in config_deps:
            source_id = dep["asset_id"]
            for ref in dep.get("references", []):
                # Try to find referenced asset
                target_asset = next(
                    (a for a in assets if ref["value"] in a.get("name", "")), None
                )
                if target_asset:
                    edge_id += 1
                    edges.append(
                        {
                            "id": f"edge_{edge_id}",
                            "source": source_id,
                            "target": str(target_asset.get("id", uuid.uuid4())),
                            "type": "configuration",
                            "label": "config_reference",
                            "confidence": ref["confidence"],
                        }
                    )

        # Process service dependencies
        for dep in service_deps:
            source_id = dep["asset_id"]
            for svc in dep.get("services", []):
                if svc["type"] == "explicit":
                    # Try to find service provider asset
                    target_asset = next(
                        (a for a in assets if svc["service"] in a.get("name", "")), None
                    )
                    if target_asset:
                        edge_id += 1
                        edges.append(
                            {
                                "id": f"edge_{edge_id}",
                                "source": source_id,
                                "target": str(target_asset.get("id", uuid.uuid4())),
                                "type": "service",
                                "label": "service_dependency",
                                "confidence": svc["confidence"],
                            }
                        )

        return {
            "nodes": nodes,
            "edges": edges,
            "node_count": len(nodes),
            "edge_count": len(edges),
            "density": (
                len(edges) / (len(nodes) * (len(nodes) - 1)) if len(nodes) > 1 else 0
            ),
        }
