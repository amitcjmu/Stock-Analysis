"""
Event classes and processing logic for Event-Driven Cache Invalidator

This module contains the event classes and their processing logic for the
cache invalidation system.

Generated by CC (Claude Code)
"""

import json
from dataclasses import dataclass, field
from datetime import datetime
from typing import Any, Dict, Optional, Set

from app.services.caching.invalidation_strategies import (
    InvalidationEvent,
    InvalidationPriority,
    InvalidationTrigger,
)

from .base import EventSource


@dataclass
class CacheInvalidationEvent:
    """Event representing a cache invalidation request with full context"""

    source: EventSource
    trigger: InvalidationTrigger
    entity_type: str
    entity_id: Optional[str] = None
    client_account_id: Optional[str] = None
    engagement_id: Optional[str] = None
    user_id: Optional[str] = None
    operation: Optional[str] = None
    endpoint: Optional[str] = None
    session_id: Optional[str] = None
    old_values: Optional[Dict[str, Any]] = None
    new_values: Optional[Dict[str, Any]] = None
    changed_attributes: Set[str] = field(default_factory=set)
    cache_keys: Set[str] = field(default_factory=set)
    metadata: Dict[str, Any] = field(default_factory=dict)
    timestamp: datetime = field(default_factory=datetime.utcnow)

    def to_invalidation_event(self) -> InvalidationEvent:
        """Convert to standard InvalidationEvent for processing"""
        return InvalidationEvent(
            trigger=self.trigger,
            priority=self._determine_priority(),
            entity_type=self.entity_type,
            entity_id=self.entity_id,
            client_account_id=self.client_account_id,
            engagement_id=self.engagement_id,
            cache_keys=self.cache_keys,
            metadata=self._build_metadata(),
        )

    def _determine_priority(self) -> InvalidationPriority:
        """Determine invalidation priority based on event characteristics"""
        # Authentication and security events are critical
        if self.trigger in [
            InvalidationTrigger.USER_LOGOUT,
            InvalidationTrigger.USER_PASSWORD_CHANGE,
            InvalidationTrigger.SECURITY_VIOLATION,
            InvalidationTrigger.SYSTEM_SHUTDOWN,
        ]:
            return InvalidationPriority.CRITICAL

        # User context and role changes are high priority
        if self.trigger in [
            InvalidationTrigger.USER_CONTEXT_CHANGE,
            InvalidationTrigger.USER_ROLE_CHANGE,
            InvalidationTrigger.USER_PERMISSION_CHANGE,
        ]:
            return InvalidationPriority.HIGH

        # Data modifications and access changes are medium priority
        if self.trigger in [
            InvalidationTrigger.DATA_MODIFICATION,
            InvalidationTrigger.CLIENT_ACCESS_CHANGE,
            InvalidationTrigger.ENGAGEMENT_CHANGE,
        ]:
            return InvalidationPriority.MEDIUM

        return InvalidationPriority.LOW

    def _build_metadata(self) -> Dict[str, Any]:
        """Build metadata dictionary for the invalidation event"""
        metadata = self.metadata.copy()
        metadata.update(
            {
                "source": self.source.value,
                "operation": self.operation,
                "endpoint": self.endpoint,
                "session_id": self.session_id,
            }
        )

        if self.old_values:
            metadata["old_values"] = self.old_values
        if self.new_values:
            metadata["new_values"] = self.new_values

        return metadata
