"""
Base classes, enums, and data structures for Event-Driven Cache Invalidator

This module contains the foundational types and configurations used across
the event-driven cache invalidation system.

Generated by CC (Claude Code)
"""

from collections import defaultdict
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import Dict, TYPE_CHECKING

if TYPE_CHECKING:
    from .events import CacheInvalidationEvent

from app.services.caching.invalidation_strategies import (
    InvalidationTrigger,
)


class EventSource(Enum):
    """Sources of cache invalidation events"""

    DATABASE_ORM = "database_orm"  # SQLAlchemy ORM events
    USER_ACTION = "user_action"  # User interface actions
    SYSTEM_TASK = "system_task"  # Background tasks and system operations
    BULK_OPERATION = "bulk_operation"  # Bulk data operations
    SECURITY_EVENT = "security_event"  # Security-related events


@dataclass
class EventProcessingStats:
    """Statistics for event processing performance"""

    total_events: int = 0
    events_by_source: Dict[EventSource, int] = field(
        default_factory=lambda: defaultdict(int)
    )
    events_by_trigger: Dict[InvalidationTrigger, int] = field(
        default_factory=lambda: defaultdict(int)
    )
    events_by_entity_type: Dict[str, int] = field(
        default_factory=lambda: defaultdict(int)
    )
    total_processing_time_ms: float = 0
    average_processing_time_ms: float = 0
    failed_events: int = 0
    last_reset: datetime = field(default_factory=datetime.utcnow)

    def update(
        self, event: "CacheInvalidationEvent", processing_time_ms: float, success: bool
    ) -> None:
        """Update statistics with processed event"""
        self.total_events += 1
        self.events_by_source[event.source] += 1
        self.events_by_trigger[event.trigger] += 1
        self.events_by_entity_type[event.entity_type] += 1
        self.total_processing_time_ms += processing_time_ms

        if self.total_events > 0:
            self.average_processing_time_ms = (
                self.total_processing_time_ms / self.total_events
            )

        if not success:
            self.failed_events += 1
