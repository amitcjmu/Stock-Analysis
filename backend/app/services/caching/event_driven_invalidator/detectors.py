"""
Change detection logic for Event-Driven Cache Invalidator

This module contains the logic for detecting meaningful changes in entities
that require cache invalidation.

Generated by CC (Claude Code)
"""

from typing import Any, Dict, Set

from sqlalchemy import inspect


class EntityChangeDetector:
    """Detects meaningful changes in entity attributes for cache invalidation"""

    # Define which attributes trigger cache invalidation for each entity type
    CACHE_SENSITIVE_ATTRIBUTES = {
        "User": {
            "email",
            "is_active",
            "role",
            "permissions",
            "client_associations",
            "default_client_id",
            "default_engagement_id",
            "last_login",
        },
        "ClientAccount": {
            "name",
            "is_active",
            "settings",
            "subscription_status",
        },
        "Engagement": {
            "name",
            "status",
            "settings",
            "is_active",
        },
        "DiscoveryFlow": {
            "status",
            "current_phase",
            "completion_percentage",
            "is_active",
        },
        "CollectionFlow": {
            "status",
            "current_phase",
            "completion_percentage",
            "is_active",
        },
        # Add more entity types as needed
    }

    @classmethod
    def has_cache_relevant_changes(
        cls, entity: Any, changed_attributes: Set[str]
    ) -> bool:
        """Check if entity changes are relevant for cache invalidation"""
        entity_type = type(entity).__name__
        sensitive_attrs = cls.CACHE_SENSITIVE_ATTRIBUTES.get(entity_type, set())

        if not sensitive_attrs:
            # If no specific attributes defined, consider all changes relevant
            return bool(changed_attributes)

        return bool(changed_attributes.intersection(sensitive_attrs))

    @classmethod
    def get_changed_attributes(cls, entity: Any) -> Set[str]:
        """Get the set of changed attributes for an entity"""
        entity_state = inspect(entity)
        changed_attrs = set()

        if hasattr(entity_state, "attrs"):
            for attr in entity_state.attrs:
                if attr.history.has_changes():
                    changed_attrs.add(attr.key)

        return changed_attrs
