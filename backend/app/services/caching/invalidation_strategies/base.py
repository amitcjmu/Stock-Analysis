"""
Base classes for cache invalidation strategies.

This module defines the abstract base classes, data models, and enums
used throughout the cache invalidation system.

Generated by CC (Claude Code)
"""

from abc import ABC, abstractmethod
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Optional

from app.core.logging import get_logger
from app.services.caching.redis_cache import RedisCache

logger = get_logger(__name__)


class InvalidationTrigger(Enum):
    """Types of events that can trigger cache invalidation"""

    USER_LOGIN = "user_login"
    USER_LOGOUT = "user_logout"
    USER_CONTEXT_CHANGE = "user_context_change"
    USER_ROLE_CHANGE = "user_role_change"
    USER_PERMISSION_CHANGE = "user_permission_change"
    CLIENT_ACCESS_CHANGE = "client_access_change"
    ENGAGEMENT_CHANGE = "engagement_change"
    DATA_MODIFICATION = "data_modification"
    SYSTEM_EVENT = "system_event"
    SECURITY_EVENT = "security_event"
    MANUAL_INVALIDATION = "manual_invalidation"
    TTL_EXPIRATION = "ttl_expiration"
    BACKGROUND_REFRESH = "background_refresh"


class InvalidationPriority(Enum):
    """Priority levels for invalidation operations"""

    CRITICAL = 1  # Security events, login/logout
    HIGH = 2  # Context changes, role changes
    MEDIUM = 3  # Data modifications, engagement changes
    LOW = 4  # Analytics, background refresh
    BACKGROUND = 5  # Cleanup, optimization


@dataclass
class InvalidationEvent:
    """Represents a cache invalidation event"""

    trigger: InvalidationTrigger
    priority: InvalidationPriority
    entity_type: str
    entity_id: str
    client_account_id: str
    user_id: Optional[str] = None
    engagement_id: Optional[str] = None
    metadata: Dict[str, Any] = field(default_factory=dict)
    timestamp: datetime = field(default_factory=datetime.utcnow)
    correlation_id: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary for serialization"""
        return {
            "trigger": self.trigger.value,
            "priority": self.priority.value,
            "entity_type": self.entity_type,
            "entity_id": self.entity_id,
            "client_account_id": str(self.client_account_id),
            "user_id": str(self.user_id) if self.user_id else None,
            "engagement_id": str(self.engagement_id) if self.engagement_id else None,
            "metadata": self.metadata,
            "timestamp": self.timestamp.isoformat(),
            "correlation_id": self.correlation_id,
        }


@dataclass
class InvalidationResult:
    """Result of an invalidation operation"""

    success: bool
    keys_invalidated: int
    execution_time_ms: float
    strategy_used: str
    errors: List[str] = field(default_factory=list)
    metadata: Dict[str, Any] = field(default_factory=dict)

    def __post_init__(self):
        if not self.metadata:
            self.metadata = {}


class BaseInvalidationStrategy(ABC):
    """Base class for all cache invalidation strategies"""

    def __init__(self, redis_cache: RedisCache):
        self.redis_cache = redis_cache
        self.stats = {
            "total_invalidations": 0,
            "successful_invalidations": 0,
            "failed_invalidations": 0,
            "keys_invalidated": 0,
            "total_execution_time_ms": 0,
        }

    @abstractmethod
    async def invalidate(self, event: InvalidationEvent) -> InvalidationResult:
        """Execute invalidation strategy for the given event"""
        pass

    @abstractmethod
    def can_handle(self, event: InvalidationEvent) -> bool:
        """Check if this strategy can handle the given event"""
        pass

    def get_strategy_name(self) -> str:
        """Get the name of this strategy"""
        return self.__class__.__name__

    def update_stats(self, result: InvalidationResult) -> None:
        """Update strategy statistics"""
        self.stats["total_invalidations"] += 1
        if result.success:
            self.stats["successful_invalidations"] += 1
        else:
            self.stats["failed_invalidations"] += 1
        self.stats["keys_invalidated"] += result.keys_invalidated
        self.stats["total_execution_time_ms"] += result.execution_time_ms


__all__ = [
    "InvalidationTrigger",
    "InvalidationPriority",
    "InvalidationEvent",
    "InvalidationResult",
    "BaseInvalidationStrategy",
]
