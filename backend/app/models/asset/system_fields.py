"""
System and audit field definitions for the Asset model.

These fields track internal system state, flow coordination, and audit trails.
Generated by CC (Claude Code)
"""

from sqlalchemy import Column, DateTime, Integer, String, JSON, ForeignKey
from sqlalchemy.dialects.postgresql import UUID as PostgresUUID
from sqlalchemy.sql import func

from .base import (
    SMALL_STRING_LENGTH,
    DEFAULT_CURRENT_PHASE,
    DEFAULT_SOURCE_PHASE,
)


class SystemFieldsMixin:
    """Mixin providing system, flow coordination, and audit fields for Asset model."""

    # Flow-based tracking (migrated from session_id)
    flow_id = Column(
        PostgresUUID(as_uuid=True),
        ForeignKey("migration.discovery_flows.flow_id", ondelete="CASCADE"),
        nullable=True,
        index=True,
        comment="Legacy field. Use master_flow_id.",
        info={
            "display_name": "Flow ID (Legacy)",
            "short_hint": "Legacy flow reference",
            "category": "system",
        },
    )
    migration_id = Column(
        PostgresUUID(as_uuid=True),
        ForeignKey("migration.migrations.id"),
        nullable=True,
        comment="Migration activity ID.",
        info={
            "display_name": "Migration ID",
            "short_hint": "Migration activity reference",
            "category": "system",
        },
    )

    # Master Flow Coordination (Phase 2)
    master_flow_id = Column(
        PostgresUUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="Master flow ID processing this asset.",
        info={
            "display_name": "Master Flow ID",
            "short_hint": "MFO coordination ID",
            "category": "system",
        },
    )
    discovery_flow_id = Column(
        PostgresUUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="Discovery flow that created/updated this.",
        info={
            "display_name": "Discovery Flow ID",
            "short_hint": "Discovery flow reference",
            "category": "system",
        },
    )
    assessment_flow_id = Column(
        PostgresUUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="Assessment flow that analyzed this.",
        info={
            "display_name": "Assessment Flow ID",
            "short_hint": "Assessment flow reference",
            "category": "system",
        },
    )
    planning_flow_id = Column(
        PostgresUUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="The planning flow that has included this asset.",
        info={
            "display_name": "Planning Flow ID",
            "short_hint": "Planning flow reference",
            "category": "system",
        },
    )
    execution_flow_id = Column(
        PostgresUUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="The execution flow that is migrating this asset.",
        info={
            "display_name": "Execution Flow ID",
            "short_hint": "Execution flow reference",
            "category": "system",
        },
    )

    # Multi-Phase Tracking (Phase 2)
    source_phase = Column(
        String(SMALL_STRING_LENGTH),
        default=DEFAULT_SOURCE_PHASE,
        index=True,
        comment="The phase in which the asset was originally created (e.g., 'discovery').",
        info={
            "display_name": "Source Phase",
            "short_hint": "Original creation phase",
            "category": "system",
        },
    )
    current_phase = Column(
        String(SMALL_STRING_LENGTH),
        default=DEFAULT_CURRENT_PHASE,
        index=True,
        comment="The current workflow phase this asset is in (e.g., 'assessment', 'planning').",
        info={
            "display_name": "Current Phase",
            "short_hint": "Current workflow phase",
            "category": "system",
        },
    )
    phase_context = Column(
        JSON,
        default=dict,
        comment="A JSON blob for storing phase-specific data or state about the asset.",
        info={
            "display_name": "Phase Context",
            "short_hint": "Phase-specific state data",
            "category": "system",
        },
    )

    # AI Gap Analysis Tracking (Migration 093)
    ai_gap_analysis_status = Column(
        Integer,
        nullable=False,
        default=0,
        comment=(
            "AI gap analysis status: 0 = not started, 1 = in progress, "
            "2 = completed. Per-asset, shared across all collection flows."
        ),
        info={
            "display_name": "AI Gap Analysis Status",
            "short_hint": "0=Not Started, 1=In Progress, 2=Completed",
            "category": "system",
        },
    )
    ai_gap_analysis_timestamp = Column(
        DateTime(timezone=True),
        nullable=True,
        comment=(
            "Timestamp when AI gap analysis completed (status = 2). "
            "Used to detect stale analysis when compared with asset.updated_at."
        ),
        info={
            "display_name": "AI Gap Analysis Timestamp",
            "short_hint": "Analysis completion time",
            "category": "system",
        },
    )


class AuditFieldsMixin:
    """Mixin providing audit trail fields for the Asset model."""

    # Audit fields
    created_at = Column(
        DateTime(timezone=True),
        server_default=func.now(),
        comment="Timestamp of when the asset record was created.",
        info={
            "display_name": "Created At",
            "short_hint": "Record creation timestamp",
            "category": "audit",
        },
    )
    updated_at = Column(
        DateTime(timezone=True),
        onupdate=func.now(),
        comment="Timestamp of the last update to the asset record.",
        info={
            "display_name": "Updated At",
            "short_hint": "Last update timestamp",
            "category": "audit",
        },
    )
    created_by = Column(
        PostgresUUID(as_uuid=True),
        ForeignKey("migration.users.id"),
        nullable=True,
        comment="The user who originally created this asset record.",
        info={
            "display_name": "Created By",
            "short_hint": "User who created record",
            "category": "audit",
        },
    )
    updated_by = Column(
        PostgresUUID(as_uuid=True),
        ForeignKey("migration.users.id"),
        nullable=True,
        comment="The user who last updated this asset record.",
        info={
            "display_name": "Updated By",
            "short_hint": "User who last updated",
            "category": "audit",
        },
    )

    # Soft Delete Fields (Issue #912)
    deleted_at = Column(
        DateTime(timezone=True),
        nullable=True,
        default=None,
        comment="Timestamp when the asset was soft deleted (NULL if active).",
        info={
            "display_name": "Deleted At",
            "short_hint": "Soft delete timestamp",
            "category": "audit",
        },
    )
    deleted_by = Column(
        PostgresUUID(as_uuid=True),
        ForeignKey("migration.users.id"),
        nullable=True,
        default=None,
        comment="User ID who performed the soft delete.",
        info={
            "display_name": "Deleted By",
            "short_hint": "User who deleted",
            "category": "audit",
        },
    )
