"""
Cache Configuration Model

Configuration settings for cache behavior per client account.
Allows customization of TTLs, eviction policies, and feature flags.

Generated by CC (Claude Code)
"""

from __future__ import annotations

from typing import Optional

from sqlalchemy import (
    JSON,
    Boolean,
    Column,
    Float,
    ForeignKey,
    Integer,
    String,
    UniqueConstraint,
)
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship

from app.core.database import Base
from app.models.base import TimestampMixin


class CacheConfiguration(Base, TimestampMixin):
    """
    Configuration settings for cache behavior per client account.
    Allows customization of TTLs, eviction policies, and feature flags.
    """

    __tablename__ = "cache_configurations"
    __table_args__ = (
        UniqueConstraint("client_account_id", name="uq_cache_config_client"),
        {"schema": "migration"},
    )

    id = Column(
        Integer,
        primary_key=True,
        comment="Unique identifier for the cache configuration",
    )

    client_account_id = Column(
        UUID(as_uuid=True),
        ForeignKey("client_accounts.id", ondelete="CASCADE"),
        nullable=False,
        unique=True,
        comment="Client account this configuration applies to",
    )

    # Feature flags
    cache_enabled = Column(
        Boolean,
        nullable=False,
        default=True,
        comment="Whether caching is enabled for this client",
    )

    distributed_cache_enabled = Column(
        Boolean,
        nullable=False,
        default=True,
        comment="Whether distributed caching features are enabled",
    )

    cache_analytics_enabled = Column(
        Boolean,
        nullable=False,
        default=True,
        comment="Whether cache analytics and logging are enabled",
    )

    # TTL overrides (in seconds, null means use defaults)
    user_context_ttl = Column(
        Integer, nullable=True, comment="Custom TTL for user context cache entries"
    )

    field_mapping_ttl = Column(
        Integer, nullable=True, comment="Custom TTL for field mapping cache entries"
    )

    flow_state_ttl = Column(
        Integer, nullable=True, comment="Custom TTL for flow state cache entries"
    )

    agent_results_ttl = Column(
        Integer, nullable=True, comment="Custom TTL for agent execution results"
    )

    # Performance settings
    max_cache_size_mb = Column(
        Integer, nullable=True, comment="Maximum cache size for this client in MB"
    )

    eviction_policy = Column(
        String(20),
        nullable=False,
        default="LRU",
        comment="Cache eviction policy (LRU, LFU, TTL)",
    )

    # Security settings
    encryption_enabled = Column(
        Boolean,
        nullable=False,
        default=False,
        comment="Whether sensitive cache data should be encrypted",
    )

    pii_cache_enabled = Column(
        Boolean, nullable=False, default=False, comment="Whether PII data can be cached"
    )

    # Custom settings
    custom_settings = Column(
        JSON,
        nullable=True,
        default=dict,
        comment="Client-specific custom cache settings",
    )

    # Monitoring thresholds
    alert_hit_ratio_threshold = Column(
        Float,
        nullable=True,
        default=0.7,
        comment="Alert when hit ratio falls below this threshold",
    )

    alert_response_time_threshold_ms = Column(
        Float,
        nullable=True,
        default=100.0,
        comment="Alert when average response time exceeds this threshold",
    )

    # Relationships
    client_account = relationship("ClientAccount", lazy="select")

    def __repr__(self):
        return (
            f"<CacheConfiguration(id={self.id}, client_account_id={self.client_account_id}, "
            f"cache_enabled={self.cache_enabled})>"
        )

    def get_ttl_for_key_type(self, key_type: str) -> Optional[int]:
        """Get custom TTL for a specific key type, or None to use defaults."""
        ttl_map = {
            "user_context": self.user_context_ttl,
            "field_mappings": self.field_mapping_ttl,
            "flow_state": self.flow_state_ttl,
            "agent_results": self.agent_results_ttl,
        }
        return ttl_map.get(key_type)
