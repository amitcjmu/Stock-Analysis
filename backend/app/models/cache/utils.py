"""
Cache Model Utilities

Helper functions for cache model initialization and constraint management.

Generated by CC (Claude Code)
"""

from sqlalchemy import CheckConstraint
from sqlalchemy.orm import relationship


def add_cache_relationships_to_client_account():
    """
    Helper function to add cache-related relationships to ClientAccount.
    This should be called during model initialization or added directly to the ClientAccount model.
    """
    try:
        from app.models.client_account import ClientAccount

        # Add relationships if they don't exist
        if not hasattr(ClientAccount, "cache_metadata"):
            ClientAccount.cache_metadata = relationship(
                "CacheMetadata",
                back_populates="client_account",
                cascade="all, delete-orphan",
                lazy="select",
            )

        if not hasattr(ClientAccount, "cache_configuration"):
            ClientAccount.cache_configuration = relationship(
                "CacheConfiguration",
                uselist=False,  # One-to-one relationship
                cascade="all, delete-orphan",
                lazy="select",
            )

    except ImportError:
        # Models not available during initial setup
        pass


def get_model_constraints():
    """Get additional constraints that should be added via migration."""
    return [
        # Cache metadata constraints
        CheckConstraint("ttl_seconds > 0", name="ck_cache_metadata_positive_ttl"),
        CheckConstraint(
            "access_count >= 0", name="ck_cache_metadata_positive_access_count"
        ),
        CheckConstraint("hit_count >= 0", name="ck_cache_metadata_positive_hit_count"),
        CheckConstraint(
            "miss_count >= 0", name="ck_cache_metadata_positive_miss_count"
        ),
        CheckConstraint(
            "compression_ratio >= 0.0 AND compression_ratio <= 1.0",
            name="ck_cache_metadata_valid_compression_ratio",
        ),
        # Performance log constraints
        CheckConstraint(
            "response_time_ms >= 0", name="ck_cache_perf_positive_response_time"
        ),
        CheckConstraint(
            "operation_type IN ('GET', 'SET', 'DELETE', 'INVALIDATE', 'EXISTS')",
            name="ck_cache_perf_valid_operation_type",
        ),
        # Invalidation log constraints
        CheckConstraint(
            "keys_invalidated_count > 0", name="ck_cache_invalidation_positive_count"
        ),
        CheckConstraint(
            "cascade_depth >= 0", name="ck_cache_invalidation_positive_cascade_depth"
        ),
        CheckConstraint(
            "invalidation_type IN ('EXPLICIT', 'CASCADE', 'EXPIRATION', 'MANUAL', 'BATCH')",
            name="ck_cache_invalidation_valid_type",
        ),
        # Configuration constraints
        CheckConstraint(
            "max_cache_size_mb > 0", name="ck_cache_config_positive_max_size"
        ),
        CheckConstraint(
            "eviction_policy IN ('LRU', 'LFU', 'TTL', 'RANDOM')",
            name="ck_cache_config_valid_eviction_policy",
        ),
        CheckConstraint(
            "alert_hit_ratio_threshold >= 0.0 AND alert_hit_ratio_threshold <= 1.0",
            name="ck_cache_config_valid_hit_ratio_threshold",
        ),
    ]
