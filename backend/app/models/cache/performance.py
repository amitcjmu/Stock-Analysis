"""
Cache Performance Log Model

Detailed performance logging for cache operations.
Used for analytics, optimization, and troubleshooting.

Generated by CC (Claude Code)
"""

from __future__ import annotations

from sqlalchemy import (
    JSON,
    Boolean,
    Column,
    Float,
    ForeignKey,
    Index,
    Integer,
    String,
    Text,
)
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship

from app.core.database import Base
from app.models.base import TimestampMixin


class CachePerformanceLog(Base, TimestampMixin):
    """
    Detailed performance logging for cache operations.
    Used for analytics, optimization, and troubleshooting.
    """

    __tablename__ = "cache_performance_logs"
    __table_args__ = (
        # Indexes for time-series analytics
        Index("ix_cache_perf_time_series", "created_at", "operation_type"),
        Index("ix_cache_perf_metadata_lookup", "cache_metadata_id", "created_at"),
        Index("ix_cache_perf_tenant_analytics", "client_account_id", "created_at"),
        {"schema": "migration"},
    )

    id = Column(
        Integer,
        primary_key=True,
        comment="Unique identifier for the performance log entry",
    )

    cache_metadata_id = Column(
        Integer,
        ForeignKey("migration.cache_metadata.id", ondelete="CASCADE"),
        nullable=False,
        comment="Reference to the cache metadata entry",
    )

    client_account_id = Column(
        UUID(as_uuid=True),
        ForeignKey("migration.client_accounts.id", ondelete="CASCADE"),
        nullable=False,
        comment="Client account for tenant isolation",
    )

    # Operation details
    operation_type = Column(
        String(20),
        nullable=False,
        comment="Type of cache operation (GET, SET, DELETE, INVALIDATE)",
    )

    was_hit = Column(
        Boolean, nullable=False, comment="Whether the cache operation resulted in a hit"
    )

    response_time_ms = Column(
        Float,
        nullable=False,
        comment="Response time for the cache operation in milliseconds",
    )

    data_size_bytes = Column(
        Integer, nullable=True, comment="Size of data involved in the operation"
    )

    # Context information
    endpoint = Column(
        String(200),
        nullable=True,
        comment="API endpoint that triggered the cache operation",
    )

    user_id = Column(
        UUID(as_uuid=True),
        ForeignKey("migration.users.id", ondelete="SET NULL"),
        nullable=True,
        comment="User who initiated the operation",
    )

    session_id = Column(
        String(100), nullable=True, comment="Session identifier for request correlation"
    )

    # Error tracking
    error_message = Column(
        Text, nullable=True, comment="Error message if operation failed"
    )

    error_code = Column(
        String(50), nullable=True, comment="Error code for categorization"
    )

    # Additional metrics
    redis_memory_usage_mb = Column(
        Float, nullable=True, comment="Redis memory usage at time of operation"
    )

    concurrent_operations = Column(
        Integer, nullable=True, comment="Number of concurrent cache operations"
    )

    operation_metadata = Column(
        JSON, nullable=True, default=dict, comment="Additional operation metadata"
    )

    # Relationships
    cache_metadata = relationship("CacheMetadata", back_populates="performance_logs")
    client_account = relationship("ClientAccount", lazy="select")
    user = relationship("User", lazy="select")

    def __repr__(self):
        return (
            f"<CachePerformanceLog(id={self.id}, operation='{self.operation_type}', "
            f"hit={self.was_hit}, response_time={self.response_time_ms}ms)>"
        )
