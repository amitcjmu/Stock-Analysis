"""
Cache Invalidation Log Model

Audit log for cache invalidation operations.
Tracks what was invalidated, why, and the cascade effects.

Generated by CC (Claude Code)
"""

from __future__ import annotations

from sqlalchemy import (
    JSON,
    Column,
    Float,
    ForeignKey,
    Index,
    Integer,
    String,
    Text,
)
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship

from app.core.database import Base
from app.models.base import TimestampMixin


class CacheInvalidationLog(Base, TimestampMixin):
    """
    Audit log for cache invalidation operations.
    Tracks what was invalidated, why, and the cascade effects.
    """

    __tablename__ = "cache_invalidation_logs"
    __table_args__ = (
        Index("ix_cache_invalidation_time_series", "created_at", "invalidation_type"),
        Index("ix_cache_invalidation_metadata", "cache_metadata_id", "created_at"),
        Index(
            "ix_cache_invalidation_trigger", "trigger_entity_type", "trigger_entity_id"
        ),
        {"schema": "migration"},
    )

    id = Column(
        Integer,
        primary_key=True,
        comment="Unique identifier for the invalidation log entry",
    )

    cache_metadata_id = Column(
        Integer,
        ForeignKey("migration.cache_metadata.id", ondelete="CASCADE"),
        nullable=True,
        comment="Reference to the cache metadata entry that was invalidated",
    )

    client_account_id = Column(
        UUID(as_uuid=True),
        ForeignKey("client_accounts.id", ondelete="CASCADE"),
        nullable=False,
        comment="Client account for tenant isolation",
    )

    # Invalidation details
    invalidation_type = Column(
        String(30),
        nullable=False,
        comment="Type of invalidation (EXPLICIT, CASCADE, EXPIRATION, MANUAL)",
    )

    cache_key_pattern = Column(
        String(500),
        nullable=False,
        comment="The cache key or pattern that was invalidated",
    )

    keys_invalidated_count = Column(
        Integer,
        nullable=False,
        default=1,
        comment="Number of cache keys invalidated by this operation",
    )

    # Trigger information
    trigger_entity_type = Column(
        String(50),
        nullable=True,
        comment="Type of entity that triggered the invalidation",
    )

    trigger_entity_id = Column(
        String(100),
        nullable=True,
        comment="ID of entity that triggered the invalidation",
    )

    trigger_operation = Column(
        String(50),
        nullable=True,
        comment="Operation that triggered invalidation (CREATE, UPDATE, DELETE)",
    )

    # User and context
    user_id = Column(
        UUID(as_uuid=True),
        ForeignKey("users.id", ondelete="SET NULL"),
        nullable=True,
        comment="User who initiated the operation that caused invalidation",
    )

    endpoint = Column(
        String(200),
        nullable=True,
        comment="API endpoint that triggered the invalidation",
    )

    # Performance impact
    invalidation_time_ms = Column(
        Float,
        nullable=True,
        comment="Time taken to complete the invalidation in milliseconds",
    )

    cascade_depth = Column(
        Integer,
        nullable=False,
        default=0,
        comment="Depth of cascade invalidation (0 for direct invalidation)",
    )

    # Metadata
    reason = Column(
        Text, nullable=True, comment="Human-readable reason for the invalidation"
    )

    invalidation_metadata = Column(
        JSON, nullable=True, default=dict, comment="Additional invalidation metadata"
    )

    # Relationships
    cache_metadata = relationship("CacheMetadata", back_populates="invalidation_logs")
    client_account = relationship("ClientAccount", lazy="select")
    user = relationship("User", lazy="select")

    def __repr__(self):
        return (
            f"<CacheInvalidationLog(id={self.id}, type='{self.invalidation_type}', "
            f"pattern='{self.cache_key_pattern}', count={self.keys_invalidated_count})>"
        )
