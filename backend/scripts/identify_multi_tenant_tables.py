#!/usr/bin/env python3
"""
Identify Multi-Tenant Tables Script - Generated by CC

This script identifies all tables that have client_account_id columns and thus
need Row-Level Security policies for multi-tenant isolation.

Usage:
    python scripts/identify_multi_tenant_tables.py
"""

import re
import sys
from pathlib import Path
from typing import List, Tuple

# Add the parent directory to sys.path
sys.path.append(str(Path(__file__).parent.parent))


def extract_table_info_from_model(file_path: Path) -> Tuple[str, bool]:
    """Extract table name and check if it has client_account_id from a model file"""
    with open(file_path, "r") as f:
        content = f.read()

    # Extract table name
    table_match = re.search(r'__tablename__\s*=\s*["\']([^"\']+)["\']', content)
    if not table_match:
        return None, False

    table_name = table_match.group(1)

    # Check if has client_account_id
    has_client_account = bool(
        re.search(r"client_account_id.*=.*Column", content)
        or re.search(r"Column.*client_account_id", content)
    )

    return table_name, has_client_account


def find_multi_tenant_tables() -> List[str]:
    """Find all tables that need RLS policies"""
    models_dir = Path(__file__).parent.parent / "app" / "models"
    multi_tenant_tables = []

    # Process all Python files in models directory
    for py_file in models_dir.rglob("*.py"):
        if py_file.name.startswith("__") or py_file.name == "base.py":
            continue

        table_name, has_client_account = extract_table_info_from_model(py_file)
        if table_name and has_client_account:
            multi_tenant_tables.append(table_name)
            print(f"‚úì {table_name} (from {py_file.relative_to(models_dir)})")

    return sorted(set(multi_tenant_tables))


def main():
    """Main entry point"""
    print("üîç Scanning for multi-tenant tables...\n")

    tables = find_multi_tenant_tables()

    print(f"\nüìä Found {len(tables)} multi-tenant tables that need RLS policies:")
    for table in tables:
        print(f"  - {table}")

    # Generate SQL for migration
    print("\nüìù SQL for RLS migration:")
    print("-- Enable RLS on all multi-tenant tables")
    for table in tables:
        print(f"ALTER TABLE migration.{table} ENABLE ROW LEVEL SECURITY;")

    print("\n-- Create RLS policies")
    for table in tables:
        policy_name = f"rls_{table}_tenant_isolation"
        print(
            f"""
CREATE POLICY {policy_name} ON migration.{table}
FOR ALL TO application_role
USING (client_account_id = current_setting('app.client_id')::uuid);"""
        )


if __name__ == "__main__":
    main()
