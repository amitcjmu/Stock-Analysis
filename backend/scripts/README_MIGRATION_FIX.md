# Migration State Fix Script

This directory contains scripts to fix common Alembic migration state issues that occur during deployment across different environments.

## Problem

When deploying the application in different environments, you may encounter:

1. **DuplicateTableError**: Database has tables but `alembic_version` is empty
2. **Missing migration files**: `alembic_version` references migrations that don't exist
3. **Version mismatch**: Database state doesn't match the expected migration version

## Solution

The migration fix script intelligently detects and resolves these issues without data loss.

## Usage

### Python Script (Direct)

```bash
# Set up environment
export DATABASE_URL="postgresql+asyncpg://user:pass@host:port/db"

# Run the fix
python scripts/fix_migration_state.py
```

### Shell Wrapper (Recommended)

```bash
# Basic usage
./scripts/fix_migration_state.sh

# Check migration state without fixing
./scripts/fix_migration_state.sh --check-only

# Get help
./scripts/fix_migration_state.sh --help
```

### Environment Variables

The script supports multiple ways to configure database connection:

```bash
# Option 1: Full DATABASE_URL
DATABASE_URL="postgresql+asyncpg://postgres:password@localhost:5432/migration_db"

# Option 2: Individual components
POSTGRES_HOST="localhost"
POSTGRES_PORT="5432" 
POSTGRES_USER="postgres"
POSTGRES_PASSWORD="password"
POSTGRES_DB="migration_db"
```

## Integration

### Docker Entrypoint

The script is automatically called by the updated `entrypoint.sh`:

```bash
# Fix migration state issues intelligently
echo "üîß Checking and fixing migration state..."
if python scripts/fix_migration_state.py; then
    echo "‚úÖ Migration state validated/fixed successfully"
else
    echo "‚ùå Migration state fix failed, continuing with standard migration process..."
fi
```

### Manual Deployment

For manual deployments, run before starting the application:

```bash
cd backend
./scripts/fix_migration_state.sh
python start.py
```

## How It Works

The script performs these checks and fixes:

1. **Database Connection**: Verifies connectivity to PostgreSQL
2. **Table Detection**: Lists existing tables in the database
3. **Core Table Validation**: Ensures required tables are present
4. **Alembic Version Check**: Reads current migration version
5. **Migration File Validation**: Confirms migration files exist
6. **Intelligent Fix**: Applies appropriate fix strategy:
   - **Tables exist, no version**: Stamps with current migration
   - **Tables exist, wrong version**: Updates to correct version
   - **Tables exist, missing files**: Resets to current schema version
   - **Fresh database**: Allows normal migration process

## Fix Strategies

### Case 1: Tables Exist, No Version Recorded
- **Symptom**: DuplicateTableError during initial migration
- **Fix**: Stamp database with `001_comprehensive_initial_schema`

### Case 2: Tables Exist, Migration Files Missing  
- **Symptom**: Migration references non-existent files (e.g., `002_*`)
- **Fix**: Reset version to current comprehensive schema

### Case 3: Version Mismatch
- **Symptom**: Database version doesn't match expected version
- **Fix**: Update to correct version without schema changes

### Case 4: Fresh Database
- **Symptom**: No tables exist
- **Fix**: Allow normal Alembic upgrade process

## Safety Features

- **Non-destructive**: Never drops tables or data
- **Idempotent**: Can be run multiple times safely
- **Validation**: Checks database state before making changes
- **Logging**: Detailed output for troubleshooting
- **Graceful failure**: Continues with deployment even if fix fails

## Troubleshooting

### Common Issues

1. **Connection Failed**
   ```
   ‚ùå Database connection failed: connection to server failed
   ```
   - Check DATABASE_URL or POSTGRES_* environment variables
   - Verify database server is running and accessible

2. **Missing Tables**
   ```
   Missing core tables: {'client_accounts', 'users', ...}
   ```
   - Database may be truly fresh - allow normal migration
   - Or tables may be in different schema

3. **Permission Denied**
   ```
   Failed to set migration version: permission denied
   ```
   - Ensure database user has CREATE/INSERT permissions
   - Check if `alembic_version` table exists and is writable

### Debug Mode

For detailed debugging, check the logs:

```bash
# Enable detailed logging
export DEBUG=true
./scripts/fix_migration_state.sh
```

## Files

- `fix_migration_state.py` - Main Python script with migration logic
- `fix_migration_state.sh` - Shell wrapper with environment setup
- `README_MIGRATION_FIX.md` - This documentation

## Generated by

This script was created by CC (Claude Code) to resolve migration conflicts during deployment.