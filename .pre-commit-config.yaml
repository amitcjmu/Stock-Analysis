# Optimized pre-commit hooks - runs only on staged files
# Install: pip install pre-commit && pre-commit install

repos:
  # Secret Detection - Fast, runs only on staged files
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.28.0
    hooks:
      - id: gitleaks

  # Python Security Linting - Only on staged Python files
  - repo: https://github.com/pycqa/bandit
    rev: 1.8.6
    hooks:
      - id: bandit
        args: ['-ll', '--skip', 'B108,B110,B301,B314,B324,B403,B608', '--exclude', '**/tests/**,**/seeding/**,**/scripts/deployment/**,**/scripts/development/**,test_*.py,simple_*.py,monitor_*.py,railway_*.py,setup.py,start.py,flow_analysis_*.py']
        exclude: ^(backend/tests/|backend/seeding/|.*test_.*\.py|.*simple_.*\.py|.*monitor_.*\.py|.*railway_.*\.py|setup\.py|start\.py|.*flow_analysis.*\.py)$

  # Security Vulnerabilities in Dependencies
  # Temporarily disabled due to hook manifest issues
  # - repo: https://github.com/pyupio/safety
  #   rev: 3.6.0
  #   hooks:
  #     - id: safety
  #       args: ['check', '--json', '-r', 'backend/requirements.txt']

  # Python Code Formatting - Only on staged files
  - repo: https://github.com/psf/black
    rev: 25.1.0
    hooks:
      - id: black
        language_version: python3.9
        files: ^backend/.*\.py$

  # Python Linting - Only on staged files
  - repo: https://github.com/pycqa/flake8
    rev: 7.3.0
    hooks:
      - id: flake8
        args: ['--max-line-length=120', '--extend-ignore=E203,W503']
        files: ^backend/.*\.py$

  # Type Checking - Only on staged files using local hook for better control
  - repo: local
    hooks:
      - id: mypy-staged
        name: mypy type checking (staged files only)
        entry: sh -c 'files=$(git diff --staged --name-only --diff-filter=AM | grep "^backend/.*\.py$"); [ -n "$files" ] && echo "$files" | xargs mypy --ignore-missing-imports --no-strict-optional || true'
        language: system
        files: ^backend/.*\.py$
        pass_filenames: false

  # Dockerfile Security
  - repo: https://github.com/hadolint/hadolint
    rev: v2.13.1-beta
    hooks:
      - id: hadolint
        args: ['--ignore', 'DL3008', '--ignore', 'DL3009']

  # Basic file checks - Very fast
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-yaml
        args: ['--unsafe']
      - id: check-json
      - id: check-toml
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: detect-private-key
      - id: end-of-file-fixer
      - id: trailing-whitespace
      - id: mixed-line-ending
      - id: check-added-large-files
        args: ['--maxkb=500']

  # SQL checks - Only on staged SQL files (not Python files)
  - repo: https://github.com/sqlfluff/sqlfluff
    rev: 3.4.2  # Updated to fix deprecated option error
    hooks:
      - id: sqlfluff-lint
        files: \.sql$  # Only actual SQL files, not Python
        args: ['--dialect', 'postgres']

  # Cache Security Validation - CC DevSecOps Requirements (Disabled for development workflow)
  # These checks are too strict for development and should be run separately during security audits
  # Uncomment when doing security reviews or before production deployment
  # - repo: local
  #   hooks:
  #     - id: cache-security-check
  #       name: Cache Security Check
  #       entry: /opt/homebrew/bin/python3.11 scripts/check_cache_security.py
  #       language: system
  #       files: '.*\.(py|ts|tsx)$'
  #       pass_filenames: false
  #
  #     - id: redis-security-audit
  #       name: Redis Security Audit
  #       entry: /opt/homebrew/bin/python3.11 scripts/security/redis_security_audit.py
  #       language: system
  #       files: '(redis\.conf|users\.acl|docker-compose.*\.yml)$'
  #       pass_filenames: false
  #
  #     - id: redis-config-validation
  #       name: Redis Configuration Validation
  #       entry: sh -c 'if [ -f redis/redis.conf ]; then redis-server redis/redis.conf --test-config || exit 1; fi; exit 0'
  #       language: system
  #       files: 'redis/redis\.conf$'
  #       pass_filenames: false
  #
  #     - id: cache-key-validation
  #       name: Cache Key Validation
  #       entry: /opt/homebrew/bin/python3.11 scripts/validate_cache_keys.py
  #       language: system
  #       files: '.*cache.*\.(py|ts)$'
  #       pass_filenames: false
  #
  #     - id: sensitive-data-check
  #       name: Sensitive Data in Cache Check
  #       entry: /opt/homebrew/bin/python3.11 scripts/check_sensitive_cache.py
  #       language: system
  #       files: '.*\.(py|ts|tsx)$'
  #       pass_filenames: false
  #
  #     - id: upstash-rate-limit-check
  #       name: Upstash Rate Limit Check
  #       entry: scripts/check_upstash_rate_limits.sh
  #       language: system
  #       pass_filenames: false

  # Lightweight security checks (faster versions)
  - repo: local
    hooks:
      # Only check staged files for credentials (expanded patterns)
      - id: check-credentials-staged
        name: Check for hardcoded credentials in staged files
        entry: sh -c 'files=$(git diff --staged --name-only | grep -E "\.(py|yml|yaml|json|env|txt)$"); if [ -n "$files" ]; then echo "$files" | xargs -I {} grep -lE "(password|secret|token|api_key|private_key)\s*[:=]\s*[\"'\''][^\"'\'']{8,}[\"'\'']" {} 2>/dev/null && echo "Found hardcoded credentials!" && exit 1; fi; exit 0'
        language: system
        pass_filenames: false

      # Check for AWS/cloud service keys in staged files only
      - id: check-cloud-keys-staged
        name: Check for exposed cloud service keys in staged files
        entry: scripts/check-cloud-keys.sh
        language: system
        pass_filenames: false

      # Architectural Policy Enforcement (replaces GitHub CI)
      - id: policy-enforcement
        name: Enforce architectural policies
        entry: scripts/policy-checks.sh
        language: system
        pass_filenames: false
        stages: [pre-commit]

      # File Length Check - Enforce modularization (400 line limit)
      - id: check-file-length
        name: Check Python file length (max 400 lines)
        entry: /opt/homebrew/bin/python3.11 scripts/check-file-length.py
        language: system
        pass_filenames: false
        stages: [pre-commit]
        types: [python]

# Exclude patterns
exclude: |
  (?x)^(
    backend/venv/.*|
    backend/migrations/.*|
    backend/tests/fixtures/.*|
    .*\.egg-info/.*|
    docs/.*\.md|
    scripts/archive/.*|
    node_modules/.*|
    build/.*|
    dist/.*
  )$

# Don't fail on first error - see all issues at once
fail_fast: false
default_stages: [pre-commit]
