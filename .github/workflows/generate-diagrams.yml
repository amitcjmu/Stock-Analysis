name: Generate Architecture Diagrams

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'docs/architecture/**/*.mmd'
      - 'docs/architecture/**/*.mermaid'
      - '.github/workflows/generate-diagrams.yml'
  workflow_dispatch:

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mermaid CLI
        run: |
          npm install -g @mermaid-js/mermaid-cli

      - name: Create Puppeteer config file
        run: |
          mkdir -p .github
          echo '{"args":["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage"]}' > .github/puppeteer-config.json

      - name: Generate diagrams
        run: |
          mkdir -p docs/architecture/generated

          # Find all .mmd and .mermaid files and generate PNG/SVG
          find docs/architecture -name "*.mmd" -o -name "*.mermaid" | while read file; do
            filename=$(basename "$file" .mmd)
            filename=$(basename "$filename" .mermaid)
            echo "Generating diagram from $file"

            # Generate PNG with Puppeteer config for GitHub Actions
            mmdc -i "$file" -o "docs/architecture/generated/${filename}.png" -b transparent -p .github/puppeteer-config.json || \
            mmdc -i "$file" -o "docs/architecture/generated/${filename}.png" -b transparent --puppeteerConfigFile .github/puppeteer-config.json || \
            PUPPETEER_ARGS="--no-sandbox --disable-setuid-sandbox" mmdc -i "$file" -o "docs/architecture/generated/${filename}.png" -b transparent

            # Generate SVG with Puppeteer config for GitHub Actions
            mmdc -i "$file" -o "docs/architecture/generated/${filename}.svg" -p .github/puppeteer-config.json || \
            mmdc -i "$file" -o "docs/architecture/generated/${filename}.svg" --puppeteerConfigFile .github/puppeteer-config.json || \
            PUPPETEER_ARGS="--no-sandbox --disable-setuid-sandbox" mmdc -i "$file" -o "docs/architecture/generated/${filename}.svg"
          done

      - name: Commit generated diagrams
        if: github.event_name == 'pull_request'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Get the branch name
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Ensure we're on the PR branch (not detached HEAD)
          git checkout -B "$BRANCH_NAME" || git checkout "$BRANCH_NAME"
          
          git add docs/architecture/generated/
          if ! git diff --staged --quiet; then
            git commit -m "docs: Auto-generate architecture diagrams [skip ci]"
            git push origin "$BRANCH_NAME"
          fi

      - name: Comment on PR with diagrams
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find generated diagrams
            const diagramsDir = 'docs/architecture/generated';
            if (fs.existsSync(diagramsDir)) {
              const files = fs.readdirSync(diagramsDir);
              const diagramFiles = files.filter(f => f.endsWith('.png') || f.endsWith('.svg'));

              if (diagramFiles.length > 0) {
                const prNumber = context.issue.number;
                const prBranch = context.payload.pull_request.head.ref;

                // Reference images from the PR branch (will be available after commit)
                const baseUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/${prBranch}`;

                let comment = '## ðŸ“Š Architecture Diagrams\n\n';
                comment += 'The following architecture diagrams have been generated and committed to this PR:\n\n';

                for (const file of diagramFiles) {
                  const ext = path.extname(file);
                  const name = path.basename(file, ext);
                  const imagePath = `${baseUrl}/docs/architecture/generated/${file}`;

                  if (ext === '.png' || ext === '.svg') {
                    comment += `### ${name}\n\n`;
                    comment += `![${name}](${imagePath})\n\n`;
                  }
                }

                comment += '---\n';
                comment += `*Diagrams are automatically generated from \`.mmd\` files in \`docs/architecture/\`*\n`;
                comment += `*View the generated files in: \`docs/architecture/generated/\`*\n`;

                // Post comment on PR (images will be available after the commit is pushed)
                github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }
