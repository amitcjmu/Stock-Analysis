name: Enforce Code Policies

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  policy-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Block legacy discovery endpoint usage in app code
        run: |
          echo "ðŸ” Checking for legacy discovery endpoints..."
          if grep -r "/api/v1/discovery" backend/app/ --exclude-dir=__pycache__ --exclude-dir="discovery" 2>/dev/null | grep -v README | grep -v tests | grep -v middleware/legacy_endpoint_guard.py; then
            echo "âŒ Legacy discovery endpoints found in application code. Use /api/v1/flows or /unified-discovery." >&2
            exit 1
          fi
          echo "âœ… No legacy discovery endpoints found in application code"

      - name: Block deprecated repository base imports
        run: |
          echo "ðŸ” Checking for deprecated repository imports..."
          if grep -r "from app\.repositories\.base import ContextAwareRepository" backend/ 2>/dev/null | grep -v README; then
            echo "âŒ Deprecated ContextAwareRepository import detected. Use app.repositories.context_aware_repository." >&2
            exit 1
          fi
          echo "âœ… No deprecated repository imports found"
