name: Enforce Code Policies

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  policy-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Block legacy discovery endpoint usage in app code
        run: |
          set -euo pipefail
          if rg -n "/api/v1/discovery" backend/app 2>/dev/null | grep -v README | grep -v tests | grep -v middleware/legacy_endpoint_guard.py; then
            echo "Legacy discovery endpoints found in application code. Use /api/v1/flows or /unified-discovery." >&2
            exit 1
          fi

      - name: Block deprecated repository base imports
        run: |
          set -euo pipefail
          if rg -n "from app\.repositories\.base import ContextAwareRepository" backend 2>/dev/null | grep -v README; then
            echo "Deprecated ContextAwareRepository import detected. Use app.repositories.context_aware_repository." >&2
            exit 1
          fi
