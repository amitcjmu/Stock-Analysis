#version: '3.8'
# Local development Docker Compose file that doesn't require BuildKit
# Use this file with: docker-compose -f docker-compose.local.yml up

services:
  # PostgreSQL Database with pgvector
  postgres:
    image: postgres:16-alpine
    container_name: migration_postgres
    environment:
      POSTGRES_DB: migration_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432" # Use port 5433 externally to avoid conflict with other services
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - migration_network

  # FastAPI Backend - Using local Dockerfile without BuildKit
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend.local
    image: migrate-platform-backend-local:latest
    env_file:
      - ./backend/.env
    container_name: migration_backend
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/migration_db
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=migration_db
      - PYTHONUNBUFFERED=1
      - FRONTEND_URL=http://localhost:8081
      - ENVIRONMENT=development
      - DEBUG=true
      - PYTHONPATH=/app

      # Assessment Flow Configuration
      - ASSESSMENT_FLOW_ENABLED=true
      - ASSESSMENT_CREW_PARALLELISM=3
      - ASSESSMENT_TIMEOUT_MINUTES=30

      # CrewAI Configuration for Assessment
      - CREWAI_ASSESSMENT_AGENTS_ENABLED=true
      - DEEPINFRA_ASSESSMENT_MODEL=meta-llama/Meta-Llama-3.1-70B-Instruct

      # Real-time Updates
      - SSE_ENABLED=true
      - SSE_HEARTBEAT_INTERVAL=30

      # Performance Configuration
      - ASSESSMENT_MAX_CONCURRENT_FLOWS=5
      - ASSESSMENT_COMPONENT_BATCH_SIZE=10

      # Discovery Flow Configuration
      - USE_FAST_DISCOVERY_MODE=false

      # Disable OpenTelemetry to prevent connection errors
      - OTEL_SDK_DISABLED=true
      - OTEL_TRACES_EXPORTER=none
      - OTEL_METRICS_EXPORTER=none
      - OTEL_LOGS_EXPORTER=none
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=
      - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=
      - OTEL_EXPORTER_OTLP_LOGS_ENDPOINT=
      - OTEL_PYTHON_DISABLED_INSTRUMENTATIONS=all
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend:/app
    working_dir: /app
    networks:
      - migration_network

  # Frontend (for development)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: migration_frontend
    working_dir: /app
    environment:
      # Docker environment indicator
      - DOCKER_ENV=true
      - VITE_WS_BASE_URL=ws://localhost:8000/ws
      - NODE_ENV=development
      # NPM configuration to prevent null path errors
      - NPM_CONFIG_CACHE=/tmp/.npm
      - NPM_CONFIG_PREFIX=/tmp/.npm-global
      - NPM_CONFIG_UPDATE_NOTIFIER=false
      - NPM_CONFIG_FUND=false
      - NPM_CONFIG_AUDIT=false
      - HOME=/tmp
    ports:
      - "8081:8081"
    volumes:
      - ./src:/app/src
      - ./public:/app/public
      - ./index.html:/app/index.html
      - ./vite.config.ts:/app/vite.config.ts
      - ./tsconfig.json:/app/tsconfig.json
      - ./tsconfig.app.json:/app/tsconfig.app.json
      - ./tsconfig.node.json:/app/tsconfig.node.json
      - ./package.json:/app/package.json
      - ./package-lock.json:/app/package-lock.json
      - ./tailwind.config.ts:/app/tailwind.config.ts
      - ./postcss.config.js:/app/postcss.config.js
      - ./components.json:/app/components.json
      - ./vitest.config.ts:/app/vitest.config.ts
      - ./tests:/app/tests
      # Use named volume for node_modules to prevent conflicts
      - frontend_node_modules:/app/node_modules
    command: sh -c "npm install --legacy-peer-deps && npm run dev -- --host 0.0.0.0 --port 8081"
    networks:
      - migration_network
    depends_on:
      - backend

  # Redis for task queuing and caching with security configuration
  redis:
    image: redis:7-alpine
    container_name: migration_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis-simple.conf:/usr/local/etc/redis/redis.conf:ro
      - ./data/redis/logs:/var/log/redis
    command: redis-server /usr/local/etc/redis/redis.conf
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-default_redis_password_change_in_production}
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD:-default_redis_password_change_in_production}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - migration_network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    restart: unless-stopped
    user: "999:999"  # Run as non-root user

  # Assessment Flow Worker (optional for heavy workloads) - Using local Dockerfile
  assessment-worker:
    build:
      context: .
      dockerfile: Dockerfile.backend.local
    env_file:
      - ./backend/.env
    container_name: migration_assessment_worker
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/migration_db
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=migration_db
      - DEEPINFRA_API_KEY=${DEEPINFRA_API_KEY}
      - WORKER_TYPE=assessment_flow
      - REDIS_URL=redis://:${REDIS_PASSWORD:-default_redis_password_change_in_production}@redis:6379
      - PYTHONPATH=/app

      # Assessment worker configuration
      - ASSESSMENT_FLOW_ENABLED=true
      - CREWAI_ASSESSMENT_AGENTS_ENABLED=true
      - ASSESSMENT_WORKER_CONCURRENCY=2
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./backend:/app
    working_dir: /app
    command: ["python", "-m", "app.workers.assessment_worker"]
    networks:
      - migration_network
    profiles:
      - worker  # Only run with docker-compose --profile worker

volumes:
  postgres_data:
  redis_data:
  frontend_node_modules:

networks:
  migration_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16