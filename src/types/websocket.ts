/**
 * WebSocket Type Definitions for Cache Invalidation
 *
 * Provides strongly-typed WebSocket message interfaces for the
 * cache invalidation system.
 *
 * Generated by CC (Claude Code)
 */

// Cache event types as const for better type safety
export const CACHE_EVENT_TYPES = {
  CACHE_INVALIDATION: 'cache_invalidation',
  USER_CONTEXT_CHANGED: 'user_context_changed',
  FIELD_MAPPINGS_UPDATED: 'field_mappings_updated',
  FLOW_STATE_CHANGED: 'flow_state_changed',
  ENGAGEMENT_MODIFIED: 'engagement_modified',
  ASSET_INVENTORY_UPDATED: 'asset_inventory_updated'
} as const;

export type CacheEventType = typeof CACHE_EVENT_TYPES[keyof typeof CACHE_EVENT_TYPES];

// Entity types
export const ENTITY_TYPES = {
  USER: 'user',
  CLIENT: 'client',
  ENGAGEMENT: 'engagement',
  FLOW: 'flow',
  FIELD_MAPPING: 'field_mapping',
  ASSET: 'asset',
  IMPORT: 'import'
} as const;

export type EntityType = typeof ENTITY_TYPES[keyof typeof ENTITY_TYPES];

// Base cache invalidation event
export interface BaseCacheInvalidationEvent {
  event_type: CacheEventType;
  entity_type: EntityType;
  entity_id: string;
  client_account_id: string;
  engagement_id?: string;
  timestamp: string;
}

// Specific event metadata types
export interface UserContextMetadata {
  user_id: string;
  role?: string;
  permissions_changed?: boolean;
}

export interface FieldMappingMetadata {
  import_id: string;
  field_count?: number;
  mapping_status?: 'pending' | 'approved' | 'rejected';
}

export interface FlowStateMetadata {
  flow_id: string;
  phase?: string;
  status?: string;
  progress?: number;
}

export interface EngagementMetadata {
  engagement_id: string;
  name?: string;
  client_id?: string;
}

export interface AssetInventoryMetadata {
  asset_id?: string;
  asset_type?: string;
  operation?: 'created' | 'updated' | 'deleted';
  total_assets?: number;
}

// Specific event types with their metadata
export interface UserContextChangedEvent extends BaseCacheInvalidationEvent {
  event_type: typeof CACHE_EVENT_TYPES.USER_CONTEXT_CHANGED;
  entity_type: typeof ENTITY_TYPES.USER;
  metadata: UserContextMetadata;
}

export interface FieldMappingsUpdatedEvent extends BaseCacheInvalidationEvent {
  event_type: typeof CACHE_EVENT_TYPES.FIELD_MAPPINGS_UPDATED;
  entity_type: typeof ENTITY_TYPES.FIELD_MAPPING;
  metadata: FieldMappingMetadata;
}

export interface FlowStateChangedEvent extends BaseCacheInvalidationEvent {
  event_type: typeof CACHE_EVENT_TYPES.FLOW_STATE_CHANGED;
  entity_type: typeof ENTITY_TYPES.FLOW;
  metadata: FlowStateMetadata;
}

export interface EngagementModifiedEvent extends BaseCacheInvalidationEvent {
  event_type: typeof CACHE_EVENT_TYPES.ENGAGEMENT_MODIFIED;
  entity_type: typeof ENTITY_TYPES.ENGAGEMENT;
  metadata: EngagementMetadata;
}

export interface AssetInventoryUpdatedEvent extends BaseCacheInvalidationEvent {
  event_type: typeof CACHE_EVENT_TYPES.ASSET_INVENTORY_UPDATED;
  entity_type: typeof ENTITY_TYPES.ASSET;
  metadata: AssetInventoryMetadata;
}

// Generic cache invalidation event (fallback)
export interface GenericCacheInvalidationEvent extends BaseCacheInvalidationEvent {
  event_type: typeof CACHE_EVENT_TYPES.CACHE_INVALIDATION;
  metadata?: Record<string, unknown>;
}

// Union type for all cache invalidation events
export type CacheInvalidationEvent =
  | UserContextChangedEvent
  | FieldMappingsUpdatedEvent
  | FlowStateChangedEvent
  | EngagementModifiedEvent
  | AssetInventoryUpdatedEvent
  | GenericCacheInvalidationEvent;

// WebSocket message types
export const WS_MESSAGE_TYPES = {
  WELCOME: 'welcome',
  CACHE_INVALIDATION: 'cache_invalidation',
  PING: 'ping',
  PONG: 'pong',
  STATS: 'stats',
  SUBSCRIPTION_UPDATED: 'subscription_updated',
  ERROR: 'error'
} as const;

export type WebSocketMessageType = typeof WS_MESSAGE_TYPES[keyof typeof WS_MESSAGE_TYPES];

// Welcome message data
export interface WelcomeData {
  connection_id: string;
  client_account_id: string;
  engagement_id?: string;
  subscribed_events: CacheEventType[];
  server_time: string;
}

// Stats message data
export interface StatsData {
  connections: number;
  events_sent: number;
  cache_hits: number;
  cache_misses: number;
  uptime_seconds: number;
}

// Subscription update data
export interface SubscriptionUpdateData {
  subscribed_events: CacheEventType[];
  added?: CacheEventType[];
  removed?: CacheEventType[];
}

// Error message data
export interface ErrorData {
  code: string;
  message: string;
  details?: Record<string, unknown>;
}

// Ping/Pong data
export interface PingPongData {
  timestamp: string;
}

// WebSocket message types with specific data
export interface WelcomeMessage {
  type: typeof WS_MESSAGE_TYPES.WELCOME;
  data: WelcomeData;
  sent_at: string;
}

export interface CacheInvalidationMessage {
  type: typeof WS_MESSAGE_TYPES.CACHE_INVALIDATION;
  data: CacheInvalidationEvent;
  sent_at: string;
}

export interface PingMessage {
  type: typeof WS_MESSAGE_TYPES.PING;
  data: PingPongData;
  sent_at: string;
}

export interface PongMessage {
  type: typeof WS_MESSAGE_TYPES.PONG;
  data: PingPongData;
  sent_at: string;
}

export interface StatsMessage {
  type: typeof WS_MESSAGE_TYPES.STATS;
  data: StatsData;
  sent_at: string;
}

export interface SubscriptionUpdatedMessage {
  type: typeof WS_MESSAGE_TYPES.SUBSCRIPTION_UPDATED;
  data: SubscriptionUpdateData;
  sent_at: string;
}

export interface ErrorMessage {
  type: typeof WS_MESSAGE_TYPES.ERROR;
  data: ErrorData;
  sent_at: string;
}

// Union type for all WebSocket messages
export type WebSocketCacheMessage =
  | WelcomeMessage
  | CacheInvalidationMessage
  | PingMessage
  | PongMessage
  | StatsMessage
  | SubscriptionUpdatedMessage
  | ErrorMessage;

// Type guards
export function isWelcomeMessage(msg: WebSocketCacheMessage): msg is WelcomeMessage {
  return msg.type === WS_MESSAGE_TYPES.WELCOME;
}

export function isCacheInvalidationMessage(msg: WebSocketCacheMessage): msg is CacheInvalidationMessage {
  return msg.type === WS_MESSAGE_TYPES.CACHE_INVALIDATION;
}

export function isPingMessage(msg: WebSocketCacheMessage): msg is PingMessage {
  return msg.type === WS_MESSAGE_TYPES.PING;
}

export function isPongMessage(msg: WebSocketCacheMessage): msg is PongMessage {
  return msg.type === WS_MESSAGE_TYPES.PONG;
}

export function isStatsMessage(msg: WebSocketCacheMessage): msg is StatsMessage {
  return msg.type === WS_MESSAGE_TYPES.STATS;
}

export function isSubscriptionUpdatedMessage(msg: WebSocketCacheMessage): msg is SubscriptionUpdatedMessage {
  return msg.type === WS_MESSAGE_TYPES.SUBSCRIPTION_UPDATED;
}

export function isErrorMessage(msg: WebSocketCacheMessage): msg is ErrorMessage {
  return msg.type === WS_MESSAGE_TYPES.ERROR;
}

// Specific cache event type guards
export function isUserContextChangedEvent(event: CacheInvalidationEvent): event is UserContextChangedEvent {
  return event.event_type === CACHE_EVENT_TYPES.USER_CONTEXT_CHANGED;
}

export function isFieldMappingsUpdatedEvent(event: CacheInvalidationEvent): event is FieldMappingsUpdatedEvent {
  return event.event_type === CACHE_EVENT_TYPES.FIELD_MAPPINGS_UPDATED;
}

export function isFlowStateChangedEvent(event: CacheInvalidationEvent): event is FlowStateChangedEvent {
  return event.event_type === CACHE_EVENT_TYPES.FLOW_STATE_CHANGED;
}

export function isEngagementModifiedEvent(event: CacheInvalidationEvent): event is EngagementModifiedEvent {
  return event.event_type === CACHE_EVENT_TYPES.ENGAGEMENT_MODIFIED;
}

export function isAssetInventoryUpdatedEvent(event: CacheInvalidationEvent): event is AssetInventoryUpdatedEvent {
  return event.event_type === CACHE_EVENT_TYPES.ASSET_INVENTORY_UPDATED;
}
