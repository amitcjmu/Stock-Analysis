/**
 * FinOps Budget Management Types
 * 
 * Type definitions for budget creation, tracking, forecasting, and variance analysis.
 * Covers budget allocation, thresholds, approvals, and spending monitoring.
 * 
 * Generated by CC (Claude Code) - Modularized from finops.ts
 */

import {
  BaseApiRequest,
  BaseApiResponse,
  MultiTenantContext,
  CreateRequest,
  CreateResponse,
  UpdateRequest,
  UpdateResponse,
  GetRequest,
  GetResponse
} from '../shared';
import { CostAmount } from './cost-analysis';

// Budget Management APIs
export interface CreateBudgetRequest extends CreateRequest<BudgetData> {
  flowId: string;
  data: BudgetData;
  budgetType: 'operational' | 'project' | 'department' | 'service' | 'resource';
  period: BudgetPeriod;
  allocation: BudgetAllocation[];
  thresholds: BudgetThreshold[];
  approvals: BudgetApproval[];
  alerts: BudgetAlert[];
}

export interface CreateBudgetResponse extends CreateResponse<Budget> {
  data: Budget;
  budgetId: string;
  approvalStatus: BudgetApprovalStatus;
  trackingEnabled: boolean;
  alertsConfigured: boolean;
}

export interface GetBudgetStatusRequest extends GetRequest {
  budgetId: string;
  includeSpending?: boolean;
  includeForecasts?: boolean;
  includeVariance?: boolean;
  includeAlerts?: boolean;
  timeRange?: {
    start: string;
    end: string;
  };
}

export interface GetBudgetStatusResponse extends GetResponse<BudgetStatus> {
  data: BudgetStatus;
  spending: BudgetSpending;
  forecasts: BudgetForecast[];
  variance: BudgetVariance;
  alerts: BudgetAlert[];
  recommendations: BudgetRecommendation[];
}

export interface UpdateBudgetRequest extends UpdateRequest<Partial<BudgetData>> {
  budgetId: string;
  data: Partial<BudgetData>;
  updateType: 'allocation' | 'thresholds' | 'approvals' | 'alerts';
  reason?: string;
  approvalRequired?: boolean;
}

export interface UpdateBudgetResponse extends UpdateResponse<Budget> {
  data: Budget;
  changesApproved: boolean;
  impactAnalysis: BudgetImpactAnalysis;
  notifications: BudgetNotification[];
}

export interface ForecastBudgetRequest extends BaseApiRequest {
  budgetId: string;
  forecastHorizon: 'month' | 'quarter' | 'year';
  forecastMethod: 'linear' | 'exponential' | 'seasonal' | 'ml_based';
  includeScenarios?: boolean;
  confidence?: number;
  context: MultiTenantContext;
}

export interface ForecastBudgetResponse extends BaseApiResponse<BudgetForecast> {
  data: BudgetForecast;
  forecastId: string;
  scenarios: ForecastScenario[];
  confidence: number;
  methodology: string;
  assumptions: string[];
}

// Supporting Data Types
export interface BudgetData {
  id: string;
  flowId: string;
  name: string;
  description?: string;
  budgetType: string;
  period: BudgetPeriod;
  totalAmount: CostAmount;
  allocation: BudgetAllocation[];
  thresholds: BudgetThreshold[];
  approvals: BudgetApproval[];
  alerts: BudgetAlert[];
  tags: Record<string, string>;
  metadata: Record<string, any>;
}

export interface Budget extends BudgetData {
  budgetId: string;
  status: BudgetStatus;
  approvalStatus: BudgetApprovalStatus;
  currentSpending: CostAmount;
  remainingAmount: CostAmount;
  utilizationPercentage: number;
  createdAt: string;
  updatedAt: string;
  approvedAt?: string;
  approvedBy?: string;
}

export interface BudgetPeriod {
  type: 'monthly' | 'quarterly' | 'annually' | 'custom';
  startDate: string;
  endDate: string;
  fiscalYear?: string;
  recurring: boolean;
  autoRenewal?: boolean;
}

export interface BudgetAllocation {
  id: string;
  name: string;
  description?: string;
  amount: CostAmount;
  percentage: number;
  category: 'service' | 'project' | 'department' | 'cost_center' | 'tag';
  target: string;
  constraints: AllocationConstraint[];
  priority: number;
}

export interface AllocationConstraint {
  type: 'min_amount' | 'max_amount' | 'percentage' | 'dependency';
  value: any;
  description: string;
  mandatory: boolean;
}

export interface BudgetThreshold {
  id: string;
  name: string;
  type: 'warning' | 'critical' | 'hard_limit';
  value: number;
  unit: 'amount' | 'percentage';
  condition: 'greater_than' | 'greater_equal' | 'equal';
  actions: ThresholdAction[];
  notifications: ThresholdNotification[];
}

export interface ThresholdAction {
  type: 'alert' | 'restrict' | 'approve' | 'escalate';
  description: string;
  automated: boolean;
  parameters: Record<string, any>;
}

export interface ThresholdNotification {
  method: 'email' | 'slack' | 'webhook' | 'dashboard';
  recipients: string[];
  template: string;
  frequency: 'immediate' | 'daily' | 'weekly';
}

export interface BudgetApproval {
  id: string;
  type: 'creation' | 'modification' | 'extension' | 'override';
  status: 'pending' | 'approved' | 'rejected' | 'expired';
  requiredApprovers: string[];
  actualApprovers: string[];
  reason?: string;
  requestedAt: string;
  approvedAt?: string;
  rejectedAt?: string;
  expiresAt?: string;
}

export interface BudgetAlert {
  id: string;
  type: 'threshold' | 'variance' | 'forecast' | 'anomaly';
  severity: 'info' | 'warning' | 'error' | 'critical';
  message: string;
  triggered: boolean;
  triggeredAt?: string;
  acknowledged: boolean;
  acknowledgedBy?: string;
  acknowledgedAt?: string;
  resolvedAt?: string;
}

export interface BudgetStatus {
  budgetId: string;
  status: 'active' | 'inactive' | 'exceeded' | 'completed' | 'suspended';
  currentPeriod: BudgetPeriod;
  totalAllocated: CostAmount;
  totalSpent: CostAmount;
  totalRemaining: CostAmount;
  utilizationPercentage: number;
  projectedSpend: CostAmount;
  projectedVariance: CostAmount;
  thresholdStatus: ThresholdStatus[];
  lastUpdated: string;
}

export interface ThresholdStatus {
  thresholdId: string;
  name: string;
  triggered: boolean;
  value: number;
  currentValue: number;
  triggeredAt?: string;
}

export interface BudgetSpending {
  totalSpent: CostAmount;
  spendingByPeriod: PeriodSpending[];
  spendingByAllocation: AllocationSpending[];
  spendingByCategory: CategorySpending[];
  spendingTrend: SpendingTrend;
  topSpenders: TopSpender[];
}

export interface PeriodSpending {
  period: string;
  amount: CostAmount;
  budgetedAmount: CostAmount;
  variance: CostAmount;
  utilizationPercentage: number;
}

export interface AllocationSpending {
  allocationId: string;
  name: string;
  budgetedAmount: CostAmount;
  spentAmount: CostAmount;
  remainingAmount: CostAmount;
  utilizationPercentage: number;
  variance: CostAmount;
}

export interface CategorySpending {
  category: string;
  amount: CostAmount;
  percentage: number;
  change: CostAmount;
}

export interface SpendingTrend {
  direction: 'increasing' | 'decreasing' | 'stable';
  rate: number;
  confidence: number;
  factors: string[];
}

export interface TopSpender {
  id: string;
  name: string;
  type: 'service' | 'resource' | 'project' | 'user';
  amount: CostAmount;
  percentage: number;
}

export interface BudgetForecast {
  id: string;
  budgetId: string;
  forecastType: 'monthly' | 'quarterly' | 'annual';
  method: string;
  projectedSpend: CostAmount;
  projectedVariance: CostAmount;
  confidence: number;
  scenarios: ForecastScenario[];
  assumptions: string[];
  generatedAt: string;
  validUntil: string;
}

export interface ForecastScenario {
  name: string;
  type: 'optimistic' | 'realistic' | 'pessimistic' | 'custom';
  projectedSpend: CostAmount;
  probability: number;
  assumptions: string[];
  drivers: string[];
}

export interface BudgetVariance {
  totalVariance: CostAmount;
  variancePercentage: number;
  type: 'favorable' | 'unfavorable' | 'neutral';
  varianceByAllocation: AllocationVariance[];
  varianceByPeriod: PeriodVariance[];
  causes: VarianceCause[];
  trends: VarianceTrend[];
}

export interface AllocationVariance {
  allocationId: string;
  name: string;
  variance: CostAmount;
  variancePercentage: number;
  type: 'favorable' | 'unfavorable' | 'neutral';
  explanation: string;
}

export interface PeriodVariance {
  period: string;
  variance: CostAmount;
  variancePercentage: number;
  cumulative: boolean;
}

export interface VarianceCause {
  type: 'volume' | 'rate' | 'timing' | 'scope' | 'efficiency';
  description: string;
  impact: CostAmount;
  controllable: boolean;
}

export interface VarianceTrend {
  direction: 'improving' | 'worsening' | 'stable';
  magnitude: number;
  periods: number;
}

export interface BudgetRecommendation {
  id: string;
  type: 'reallocation' | 'threshold_adjustment' | 'period_extension' | 'increase' | 'decrease';
  priority: 'low' | 'medium' | 'high';
  title: string;
  description: string;
  impact: CostAmount;
  effort: 'low' | 'medium' | 'high';
  risk: 'low' | 'medium' | 'high';
  implementation: RecommendationImplementation;
}

export interface RecommendationImplementation {
  steps: string[];
  prerequisites: string[];
  tools: string[];
  approvals: string[];
  timeline: string;
}

export interface BudgetImpactAnalysis {
  changedAllocations: string[];
  affectedThresholds: string[];
  impactedStakeholders: string[];
  riskAssessment: RiskAssessment;
  rollbackPlan: string;
}

export interface RiskAssessment {
  level: 'low' | 'medium' | 'high' | 'critical';
  factors: string[];
  mitigation: string[];
  monitoring: string[];
}

export interface BudgetNotification {
  id: string;
  type: 'threshold' | 'approval' | 'update' | 'alert';
  recipients: string[];
  message: string;
  channel: 'email' | 'slack' | 'webhook' | 'dashboard';
  sentAt: string;
  acknowledged: boolean;
}

export type BudgetApprovalStatus = 
  | 'draft' | 'pending_approval' | 'approved' | 'rejected' 
  | 'conditional_approval' | 'expired' | 'withdrawn';