/**
 * FinOps Flow Management Types
 * 
 * Type definitions for FinOps flow initialization, status tracking, and lifecycle management.
 * Covers flow creation, state management, and monitoring operations.
 * 
 * Generated by CC (Claude Code) - Modularized from finops.ts
 */

import type { BaseMetadata, AuditableMetadata } from '../../shared/metadata-types';
import type {
  BaseApiRequest,
  BaseApiResponse,
  MultiTenantContext,
  ListRequest,
  ListResponse,
  GetRequest,
  GetResponse
} from '../shared';
import type { ConfigurationValue, TypedConstraint } from '../../shared/config-types';
import type { AnalysisResult, CostAnalysis as BaseCostAnalysis, RiskAnalysis } from '../../shared/analysis-types';

// FinOps Flow Management APIs
export interface InitializeFinOpsFlowRequest extends BaseApiRequest {
  flowName: string;
  flowDescription?: string;
  context: MultiTenantContext;
  finOpsScope: FinOpsScope;
  objectives: FinOpsObjective[];
  constraints: FinOpsConstraint[];
  governanceFramework: FinOpsGovernance;
  parentFlowId?: string;
  configuration?: FinOpsFlowConfiguration;
  metadata?: BaseMetadata;
}

export interface InitializeFinOpsFlowResponse extends BaseApiResponse<FinOpsFlowData> {
  data: FinOpsFlowData;
  flowId: string;
  initialState: FinOpsState;
  recommendedActions: FinOpsAction[];
  costBaseline: CostBaseline;
  optimizationOpportunities: OptimizationOpportunity[];
}

export interface GetFinOpsFlowStatusRequest extends GetRequest {
  flowId: string;
  includeDetails?: boolean;
  includeCostAnalysis?: boolean;
  includeOptimizations?: boolean;
  includeBudgetStatus?: boolean;
  includeForecasts?: boolean;
  includeAlerts?: boolean;
}

export interface GetFinOpsFlowStatusResponse extends BaseApiResponse<FinOpsStatusDetail> {
  data: FinOpsStatusDetail;
  costAnalysis: CostAnalysis;
  optimizations: ActiveOptimization[];
  budgetStatus: BudgetStatus;
  forecasts: CostForecast[];
  alerts: FinOpsAlert[];
}

export interface ListFinOpsFlowsRequest extends ListRequest {
  finOpsTypes?: string[];
  status?: FinOpsStatus[];
  costCategories?: string[];
  optimizationTypes?: string[];
  clientAccountIds?: string[];
  engagementIds?: string[];
  dateRange?: {
    start: string;
    end: string;
    field: 'created' | 'updated' | 'cost_period_start' | 'cost_period_end';
  };
  includeArchived?: boolean;
  includeMetrics?: boolean;
}

export interface ListFinOpsFlowsResponse {
  data: FinOpsFlowSummary[];
  total: number;
  page: number;
  pageSize: number;
  hasMore: boolean;
  aggregations?: FinOpsAggregation[];
  trends?: FinOpsTrend[];
  benchmarks?: FinOpsBenchmark[];
  portfolioMetrics?: FinOpsPortfolioMetrics;
}

// Supporting Data Types
export interface FinOpsFlowData {
  id: string;
  flowId: string;
  flowName: string;
  flowDescription?: string;
  finOpsType: string;
  status: FinOpsStatus;
  priority: 'low' | 'medium' | 'high' | 'critical';
  scope: FinOpsScope;
  objectives: FinOpsObjective[];
  constraints: FinOpsConstraint[];
  governance: FinOpsGovernance;
  progress: number;
  phases: FinOpsPhases;
  currentPhase: string;
  clientAccountId: string;
  engagementId: string;
  userId: string;
  createdAt: string;
  updatedAt: string;
  completedAt?: string;
  metadata: AuditableMetadata;
}

export interface FinOpsScope {
  accounts: string[];
  services: string[];
  resources: string[];
  regions: string[];
  costCenters: string[];
  projects: string[];
  environments: string[];
  timeframe: {
    start: string;
    end: string;
  };
  budget: {
    amount: number;
    currency: string;
  };
  exclusions?: string[];
  tags?: Record<string, string>;
}

export interface FinOpsObjective {
  id: string;
  name: string;
  description: string;
  type: 'cost_reduction' | 'budget_compliance' | 'resource_optimization' | 'governance';
  target: ObjectiveTarget;
  priority: number;
  deadline?: string;
  measurable: boolean;
  kpis: string[];
}

export interface FinOpsConstraint extends Omit<TypedConstraint, 'type' | 'impact'> {
  id: string;
  type: 'budget' | 'performance' | 'compliance' | 'operational';
  operator: string;
  mandatory: boolean;
  exceptions?: string[];
}

export interface FinOpsGovernance {
  framework: string;
  policies: string[];
  approvalWorkflows: ApprovalWorkflow[];
  complianceRequirements: string[];
  auditFrequency: string;
  reportingCadence: string;
  stakeholders: Stakeholder[];
  escalationPaths: EscalationPath[];
}

export interface FinOpsFlowConfiguration {
  automation: FinOpsAutomation;
  monitoring: FinOpsMonitoring;
  alerting: FinOpsAlerting;
  reporting: FinOpsReporting;
  optimization: FinOpsOptimization;
  governance: FinOpsGovernanceConfig;
  integration: FinOpsIntegration;
}

export interface FinOpsState {
  flowId: string;
  status: FinOpsStatus;
  currentPhase: string;
  phaseStates: Record<string, PhaseState>;
  costBaseline: CostBaseline;
  budgetStatus: BudgetStatus;
  optimizationStatus: OptimizationStatus;
  governanceStatus: GovernanceStatus;
  kpis: FinOpsKPI[];
  alerts: FinOpsAlert[];
  recommendations: FinOpsRecommendation[];
  decisions: FinOpsDecision[];
  createdAt: string;
  updatedAt: string;
}

export type FinOpsStatus = 
  | 'planning' | 'baseline_analysis' | 'budget_setup' | 'optimization_identification'
  | 'implementation' | 'monitoring' | 'governance' | 'reporting'
  | 'completed' | 'paused' | 'failed' | 'cancelled';

// Forward declarations for types used from other modules
export interface FinOpsAction {
  id: string;
  type: 'cost_optimization' | 'budget_adjustment' | 'resource_scaling' | 'policy_enforcement';
  name: string;
  description: string;
  impact: ActionImpact;
  effort: 'low' | 'medium' | 'high';
  priority: number;
  status: 'pending' | 'in_progress' | 'completed' | 'failed';
  assignee?: string;
  dueDate?: string;
}

export interface ActionImpact {
  costSavings?: number;
  performanceImpact?: string;
  riskReduction?: string;
  complianceImprovement?: string;
}

export interface OptimizationOpportunity {
  id: string;
  type: 'rightsizing' | 'reserved_instances' | 'spot_instances' | 'resource_termination' | 'service_optimization';
  name: string;
  description: string;
  potentialSavings: CostSavings;
  implementation: ImplementationDetails;
  risk: RiskAssessment;
  confidence: number;
  recommendedAction: string;
}

export interface CostSavings {
  monthly: number;
  annual: number;
  percentage: number;
  currency: string;
}

export interface ImplementationDetails {
  steps: string[];
  timeline: string;
  effort: 'low' | 'medium' | 'high';
  automatable: boolean;
  dependencies: string[];
}

export interface RiskAssessment {
  level: 'low' | 'medium' | 'high';
  factors: string[];
  mitigations: string[];
}

export interface CostBaseline {
  period: string;
  totalCost: number;
  currency: string;
  byService: ServiceCost[];
  byAccount: AccountCost[];
  byRegion: RegionCost[];
  byCostCenter: CostCenterCost[];
  trends: CostTrend[];
  anomalies: CostAnomaly[];
}

export interface ServiceCost {
  service: string;
  cost: number;
  percentage: number;
  change: number;
}

export interface AccountCost {
  accountId: string;
  accountName: string;
  cost: number;
  percentage: number;
}

export interface RegionCost {
  region: string;
  cost: number;
  percentage: number;
}

export interface CostCenterCost {
  costCenter: string;
  cost: number;
  budget: number;
  variance: number;
}

export interface CostTrend {
  metric: string;
  direction: 'up' | 'down' | 'stable';
  percentage: number;
  period: string;
}

export interface CostAnomaly {
  id: string;
  service: string;
  amount: number;
  deviation: number;
  reason?: string;
  detected: string;
}

export interface FinOpsStatusDetail {
  flowId: string;
  status: FinOpsStatus;
  phase: PhaseDetail;
  progress: ProgressMetrics;
  health: HealthIndicators;
  timeline: TimelineStatus;
  blockers: Blocker[];
  nextSteps: NextStep[];
}

export interface PhaseDetail {
  current: string;
  completed: string[];
  remaining: string[];
  phaseProgress: number;
}

export interface ProgressMetrics {
  overall: number;
  byObjective: Record<string, number>;
  byPhase: Record<string, number>;
  milestones: MilestoneProgress[];
}

export interface MilestoneProgress {
  milestone: string;
  status: 'pending' | 'in_progress' | 'completed' | 'delayed';
  completedDate?: string;
  targetDate: string;
}

export interface HealthIndicators {
  overall: 'healthy' | 'at_risk' | 'critical';
  cost: HealthStatus;
  optimization: HealthStatus;
  compliance: HealthStatus;
  governance: HealthStatus;
}

export interface HealthStatus {
  status: 'healthy' | 'warning' | 'critical';
  score: number;
  issues: string[];
}

export interface TimelineStatus {
  startDate: string;
  endDate: string;
  currentDate: string;
  daysElapsed: number;
  daysRemaining: number;
  onTrack: boolean;
}

export interface Blocker {
  id: string;
  type: string;
  description: string;
  impact: string;
  resolution: string;
  owner?: string;
}

export interface NextStep {
  action: string;
  description: string;
  dueDate?: string;
  owner?: string;
}

export interface CostAnalysis extends BaseCostAnalysis {
  period: string;
  actualCost: number;
  budgetedCost: number;
  variance: number;
  forecast: number;
  breakdown: CostBreakdown;
  drivers: CostDriver[];
  recommendations: string[];
}

export interface CostBreakdown {
  byService: Record<string, number>;
  byAccount: Record<string, number>;
  byRegion: Record<string, number>;
  byTag: Record<string, number>;
  byResource: Record<string, number>;
}

export interface CostDriver {
  factor: string;
  impact: number;
  trend: 'increasing' | 'decreasing' | 'stable';
  action: string;
}

export interface ActiveOptimization {
  id: string;
  type: string;
  status: 'planning' | 'implementing' | 'monitoring' | 'completed';
  startDate: string;
  targetSavings: number;
  actualSavings?: number;
  progress: number;
  tasks: OptimizationTask[];
}

export interface OptimizationTask {
  id: string;
  name: string;
  status: 'pending' | 'in_progress' | 'completed' | 'blocked';
  assignee?: string;
  dueDate?: string;
  blockers?: string[];
}

export interface BudgetStatus {
  budget: BudgetDetails;
  consumption: ConsumptionMetrics;
  forecast: BudgetForecast;
  alerts: BudgetAlert[];
  recommendations: BudgetRecommendation[];
}

export interface BudgetDetails {
  total: number;
  allocated: number;
  remaining: number;
  period: string;
  currency: string;
}

export interface ConsumptionMetrics {
  current: number;
  percentage: number;
  runRate: number;
  trend: string;
  byCategory: Record<string, number>;
}

export interface BudgetForecast {
  endOfPeriod: number;
  overUnder: number;
  confidence: number;
  scenarios: ForecastScenario[];
}

export interface ForecastScenario {
  name: string;
  probability: number;
  amount: number;
  variance: number;
}

export interface BudgetAlert {
  id: string;
  type: 'threshold' | 'anomaly' | 'forecast';
  severity: 'info' | 'warning' | 'critical';
  message: string;
  threshold?: number;
  actual?: number;
}

export interface BudgetRecommendation {
  action: string;
  impact: number;
  effort: string;
  priority: number;
}

export interface CostForecast {
  period: string;
  forecast: number;
  confidence: number;
  methodology: string;
  assumptions: string[];
  range: { min: number; max: number };
  drivers: ForecastDriver[];
}
export interface FinOpsAlert {
  id: string;
  type: string;
  severity: string;
  message: string;
  triggeredAt: string;
}
export interface FinOpsFlowSummary {
  id: string;
  name: string;
  status: string;
  progress: number;
  cost: CostSummary;
}

export interface CostSummary {
  current: number;
  budget: number;
  forecast: number;
  savings: number;
  currency: string;
}
export interface FinOpsAggregation {
  name: string;
  type: string;
  field: string;
  value: AggregationValue;
}

export interface AggregationValue {
  sum?: number;
  average?: number;
  count?: number;
  min?: number;
  max?: number;
  distribution?: Record<string, number>;
}
export interface FinOpsTrend {
  metric: string;
  direction: string;
  value: number;
}
export interface FinOpsBenchmark {
  metric: string;
  value: number;
  percentile: number;
}
export interface ForecastDriver {
  factor: string;
  impact: number;
  trend: string;
}

export interface FinOpsPortfolioMetrics {
  totalCost: number;
  totalBudget: number;
  totalSavings: number;
  flowCount: number;
  activeOptimizations: number;
  complianceScore: number;
  efficiencyRatio: number;
  trends: PortfolioTrend[];
}

export interface PortfolioTrend {
  metric: string;
  current: number;
  previous: number;
  change: number;
  trend: 'improving' | 'declining' | 'stable';
}

export interface ObjectiveTarget {
  metric: string;
  value: ConfigurationValue;
  unit: string;
  baseline?: ConfigurationValue;
  deadline?: string;
}

export interface ApprovalWorkflow {
  id: string;
  name: string;
  type: 'sequential' | 'parallel' | 'conditional';
  thresholds: ApprovalThreshold[];
  approvers: Approver[];
  escalation: EscalationRule[];
}

export interface ApprovalThreshold {
  metric: string;
  operator: string;
  value: number;
  level: string;
}

export interface Approver {
  role: string;
  userId?: string;
  delegateId?: string;
  level: number;
}

export interface EscalationRule {
  condition: string;
  escalateTo: string;
  timeframe: string;
}

export interface Stakeholder {
  id: string;
  name: string;
  role: string;
  email: string;
  responsibility: string;
  notificationPreferences: NotificationPreference[];
}

export interface NotificationPreference {
  type: string;
  channel: 'email' | 'sms' | 'slack' | 'teams';
  frequency: string;
  enabled: boolean;
}

export interface EscalationPath {
  level: number;
  role: string;
  threshold: string;
  timeframe: string;
  action: string;
}

export interface FinOpsAutomation {
  enabled: boolean;
  rules: AutomationRule[];
  actions: AutomationAction[];
  schedule: AutomationSchedule;
  limits: AutomationLimits;
}

export interface AutomationRule {
  id: string;
  name: string;
  condition: string;
  action: string;
  enabled: boolean;
}

export interface AutomationAction {
  type: string;
  parameters: Record<string, ConfigurationValue>;
  approval?: string;
}

export interface AutomationSchedule {
  frequency: string;
  timezone: string;
  blackoutPeriods: string[];
}

export interface AutomationLimits {
  maxActionsPerDay: number;
  maxCostImpact: number;
  requireApprovalAbove: number;
}

export interface FinOpsMonitoring {
  metrics: MonitoringMetric[];
  dashboards: DashboardConfig[];
  alerts: AlertConfig[];
  reports: ReportConfig[];
}

export interface MonitoringMetric {
  name: string;
  type: string;
  source: string;
  calculation: string;
  frequency: string;
}

export interface DashboardConfig {
  name: string;
  widgets: WidgetConfig[];
  refresh: string;
  access: string[];
}

export interface WidgetConfig {
  type: string;
  metric: string;
  visualization: string;
  position: { x: number; y: number; w: number; h: number };
}

export interface AlertConfig {
  name: string;
  metric: string;
  condition: string;
  threshold: number;
  severity: string;
  channels: string[];
}

export interface ReportConfig {
  name: string;
  type: string;
  schedule: string;
  recipients: string[];
  format: string;
}

export interface FinOpsAlerting {
  rules: AlertRule[];
  channels: AlertChannel[];
  suppression: SuppressionRule[];
  escalation: AlertEscalation[];
}

export interface AlertRule {
  id: string;
  name: string;
  metric: string;
  condition: string;
  threshold: ConfigurationValue;
  severity: 'info' | 'warning' | 'critical';
  enabled: boolean;
}

export interface AlertChannel {
  type: 'email' | 'sms' | 'slack' | 'webhook';
  config: Record<string, string>;
  enabled: boolean;
}

export interface SuppressionRule {
  condition: string;
  duration: string;
  reason: string;
}

export interface AlertEscalation {
  severity: string;
  timeframe: string;
  escalateTo: string;
}

export interface FinOpsReporting {
  templates: ReportTemplate[];
  schedule: ReportSchedule[];
  distribution: ReportDistribution[];
  retention: ReportRetention;
}

export interface ReportTemplate {
  id: string;
  name: string;
  type: string;
  sections: ReportSection[];
  format: string[];
}

export interface ReportSection {
  name: string;
  type: string;
  metrics: string[];
  visualization?: string;
}

export interface ReportSchedule {
  reportId: string;
  frequency: string;
  time: string;
  timezone: string;
}

export interface ReportDistribution {
  reportId: string;
  recipients: string[];
  method: string;
}

export interface ReportRetention {
  duration: string;
  archiveLocation: string;
  compressionEnabled: boolean;
}

export interface FinOpsOptimization {
  strategies: OptimizationStrategy[];
  priorities: OptimizationPriority[];
  constraints: OptimizationConstraint[];
  targets: OptimizationTarget[];
}

export interface OptimizationStrategy {
  type: string;
  enabled: boolean;
  parameters: Record<string, ConfigurationValue>;
  exclusions: string[];
}

export interface OptimizationPriority {
  factor: string;
  weight: number;
  constraint?: string;
}

export interface OptimizationConstraint {
  type: string;
  value: ConfigurationValue;
  enforcement: 'hard' | 'soft';
}

export interface OptimizationTarget {
  metric: string;
  target: number;
  timeframe: string;
}

export interface FinOpsGovernanceConfig {
  policies: GovernancePolicy[];
  controls: GovernanceControl[];
  auditing: AuditConfig;
  compliance: ComplianceConfig;
}

export interface GovernancePolicy {
  id: string;
  name: string;
  type: string;
  rules: PolicyRule[];
  enforcement: string;
}

export interface PolicyRule {
  condition: string;
  action: string;
  exceptions: string[];
}

export interface GovernanceControl {
  type: string;
  implementation: string;
  validation: string;
  frequency: string;
}

export interface AuditConfig {
  enabled: boolean;
  events: string[];
  retention: string;
  storage: string;
}

export interface ComplianceConfig {
  frameworks: string[];
  requirements: ComplianceRequirement[];
  reporting: ComplianceReporting;
}

export interface ComplianceRequirement {
  id: string;
  framework: string;
  control: string;
  implementation: string;
}

export interface ComplianceReporting {
  frequency: string;
  format: string;
  recipients: string[];
}

export interface FinOpsIntegration {
  cloudProviders: CloudProviderIntegration[];
  tools: ToolIntegration[];
  apis: ApiIntegration[];
  webhooks: WebhookIntegration[];
}

export interface CloudProviderIntegration {
  provider: string;
  accounts: string[];
  regions: string[];
  services: string[];
  credentials: string;
}

export interface ToolIntegration {
  name: string;
  type: string;
  endpoint: string;
  authentication: string;
  syncFrequency: string;
}

export interface ApiIntegration {
  name: string;
  endpoint: string;
  version: string;
  authentication: string;
  rateLimit: number;
}

export interface WebhookIntegration {
  name: string;
  url: string;
  events: string[];
  authentication: string;
  retry: RetryConfig;
}

export interface RetryConfig {
  attempts: number;
  backoff: string;
  maxDelay: number;
}

export interface PhaseState {
  phase: string;
  status: 'pending' | 'in_progress' | 'completed' | 'skipped';
  startDate?: string;
  endDate?: string;
  progress: number;
  blockers: string[];
  outputs: Record<string, ConfigurationValue>;
}

export interface OptimizationStatus {
  active: number;
  completed: number;
  totalSavings: number;
  successRate: number;
  topOpportunities: OptimizationOpportunity[];
}

export interface GovernanceStatus {
  complianceScore: number;
  policyViolations: number;
  openAudits: number;
  lastAuditDate: string;
  issues: GovernanceIssue[];
}

export interface GovernanceIssue {
  id: string;
  type: string;
  severity: string;
  description: string;
  remediation: string;
}

export interface FinOpsKPI {
  name: string;
  value: number;
  target: number;
  unit: string;
  trend: 'improving' | 'declining' | 'stable';
  status: 'on_track' | 'at_risk' | 'off_track';
}

export interface FinOpsRecommendation {
  id: string;
  type: string;
  title: string;
  description: string;
  impact: RecommendationImpact;
  effort: 'low' | 'medium' | 'high';
  priority: number;
  actions: string[];
}

export interface RecommendationImpact {
  cost: number;
  performance: string;
  risk: string;
  compliance: string;
}

export interface FinOpsDecision {
  id: string;
  type: string;
  description: string;
  options: DecisionOption[];
  selectedOption?: string;
  rationale?: string;
  decidedBy?: string;
  decidedAt?: string;
}

export interface DecisionOption {
  id: string;
  name: string;
  pros: string[];
  cons: string[];
  impact: Record<string, ConfigurationValue>;
}

export interface FinOpsPhases {
  planning: PhaseDefinition;
  baseline: PhaseDefinition;
  optimization: PhaseDefinition;
  implementation: PhaseDefinition;
  monitoring: PhaseDefinition;
  governance: PhaseDefinition;
}

export interface PhaseDefinition {
  name: string;
  description: string;
  objectives: string[];
  deliverables: string[];
  duration: string;
  dependencies: string[];
}