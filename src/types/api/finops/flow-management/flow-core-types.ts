/**
 * FinOps Flow Core Types
 *
 * Core type definitions for FinOps flow data, state, scope, objectives, and constraints.
 * These are the fundamental building blocks of FinOps flows.
 *
 * Generated by CC - Modularized from flow-management.ts
 */

import type { AuditableMetadata } from '../../../shared/metadata-types';
import type { ConfigurationValue, TypedConstraint } from '../../../shared/config-types';

// Core Flow Types
export interface FinOpsFlowData {
  id: string;
  flowId: string;
  flowName: string;
  flowDescription?: string;
  finOpsType: string;
  status: FinOpsStatus;
  priority: 'low' | 'medium' | 'high' | 'critical';
  scope: FinOpsScope;
  objectives: FinOpsObjective[];
  constraints: FinOpsConstraint[];
  governance: FinOpsGovernance;
  progress: number;
  phases: FinOpsPhases;
  currentPhase: string;
  clientAccountId: string;
  engagementId: string;
  userId: string;
  createdAt: string;
  updatedAt: string;
  completedAt?: string;
  metadata: AuditableMetadata;
}

export interface FinOpsScope {
  accounts: string[];
  services: string[];
  resources: string[];
  regions: string[];
  costCenters: string[];
  projects: string[];
  environments: string[];
  timeframe: {
    start: string;
    end: string;
  };
  budget: {
    amount: number;
    currency: string;
  };
  exclusions?: string[];
  tags?: Record<string, string>;
}

export interface FinOpsObjective {
  id: string;
  name: string;
  description: string;
  type: 'cost_reduction' | 'budget_compliance' | 'resource_optimization' | 'governance';
  target: ObjectiveTarget;
  priority: number;
  deadline?: string;
  measurable: boolean;
  kpis: string[];
}

export interface ObjectiveTarget {
  metric: string;
  value: ConfigurationValue;
  unit: string;
  baseline?: ConfigurationValue;
  deadline?: string;
}

export interface FinOpsConstraint extends Omit<TypedConstraint, 'type' | 'impact'> {
  id: string;
  type: 'budget' | 'performance' | 'compliance' | 'operational';
  operator: string;
  mandatory: boolean;
  exceptions?: string[];
}

export interface FinOpsGovernance {
  framework: string;
  policies: string[];
  approvalWorkflows: ApprovalWorkflow[];
  complianceRequirements: string[];
  auditFrequency: string;
  reportingCadence: string;
  stakeholders: Stakeholder[];
  escalationPaths: EscalationPath[];
}

// Import from governance-types (will be created)
export interface ApprovalWorkflow {
  id: string;
  name: string;
  type: 'sequential' | 'parallel' | 'conditional';
  thresholds: ApprovalThreshold[];
  approvers: Approver[];
  escalation: EscalationRule[];
}

export interface ApprovalThreshold {
  metric: string;
  operator: string;
  value: number;
  level: string;
}

export interface Approver {
  role: string;
  userId?: string;
  delegateId?: string;
  level: number;
}

export interface EscalationRule {
  condition: string;
  escalateTo: string;
  timeframe: string;
}

export interface Stakeholder {
  id: string;
  name: string;
  role: string;
  email: string;
  responsibility: string;
  notificationPreferences: NotificationPreference[];
}

export interface NotificationPreference {
  type: string;
  channel: 'email' | 'sms' | 'slack' | 'teams';
  frequency: string;
  enabled: boolean;
}

export interface EscalationPath {
  level: number;
  role: string;
  threshold: string;
  timeframe: string;
  action: string;
}

// State Management Types
export interface FinOpsState {
  flowId: string;
  status: FinOpsStatus;
  currentPhase: string;
  phaseStates: Record<string, PhaseState>;
  costBaseline: CostBaseline;
  budgetStatus: BudgetStatus;
  optimizationStatus: OptimizationStatus;
  governanceStatus: GovernanceStatus;
  kpis: FinOpsKPI[];
  alerts: FinOpsAlert[];
  recommendations: FinOpsRecommendation[];
  decisions: FinOpsDecision[];
  createdAt: string;
  updatedAt: string;
}

export type FinOpsStatus =
  | 'planning' | 'baseline_analysis' | 'budget_setup' | 'optimization_identification'
  | 'implementation' | 'monitoring' | 'governance' | 'reporting'
  | 'completed' | 'paused' | 'failed' | 'cancelled';

export interface PhaseState {
  phase: string;
  status: 'pending' | 'in_progress' | 'completed' | 'skipped';
  startDate?: string;
  endDate?: string;
  progress: number;
  blockers: string[];
  outputs: Record<string, ConfigurationValue>;
}

export interface FinOpsPhases {
  planning: PhaseDefinition;
  baseline: PhaseDefinition;
  optimization: PhaseDefinition;
  implementation: PhaseDefinition;
  monitoring: PhaseDefinition;
  governance: PhaseDefinition;
}

export interface PhaseDefinition {
  name: string;
  description: string;
  objectives: string[];
  deliverables: string[];
  duration: string;
  dependencies: string[];
}

// Forward declarations (will be imported from other modules)
export interface CostBaseline {
  period: string;
  totalCost: number;
  currency: string;
  byService: ServiceCost[];
  byAccount: AccountCost[];
  byRegion: RegionCost[];
  byCostCenter: CostCenterCost[];
  trends: CostTrend[];
  anomalies: CostAnomaly[];
}

export interface ServiceCost {
  service: string;
  cost: number;
  percentage: number;
  change: number;
}

export interface AccountCost {
  accountId: string;
  accountName: string;
  cost: number;
  percentage: number;
}

export interface RegionCost {
  region: string;
  cost: number;
  percentage: number;
}

export interface CostCenterCost {
  costCenter: string;
  cost: number;
  budget: number;
  variance: number;
}

export interface CostTrend {
  metric: string;
  direction: 'up' | 'down' | 'stable';
  percentage: number;
  period: string;
}

export interface CostAnomaly {
  id: string;
  service: string;
  amount: number;
  deviation: number;
  reason?: string;
  detected: string;
}

export interface BudgetStatus {
  budget: BudgetDetails;
  consumption: ConsumptionMetrics;
  forecast: BudgetForecast;
  alerts: BudgetAlert[];
  recommendations: BudgetRecommendation[];
}

export interface BudgetDetails {
  total: number;
  allocated: number;
  remaining: number;
  period: string;
  currency: string;
}

export interface ConsumptionMetrics {
  current: number;
  percentage: number;
  runRate: number;
  trend: string;
  byCategory: Record<string, number>;
}

export interface BudgetForecast {
  endOfPeriod: number;
  overUnder: number;
  confidence: number;
  scenarios: ForecastScenario[];
}

export interface ForecastScenario {
  name: string;
  probability: number;
  amount: number;
  variance: number;
}

export interface BudgetAlert {
  id: string;
  type: 'threshold' | 'anomaly' | 'forecast';
  severity: 'info' | 'warning' | 'critical';
  message: string;
  threshold?: number;
  actual?: number;
}

export interface BudgetRecommendation {
  action: string;
  impact: number;
  effort: string;
  priority: number;
}

export interface OptimizationStatus {
  active: number;
  completed: number;
  totalSavings: number;
  successRate: number;
  topOpportunities: OptimizationOpportunity[];
}

export interface OptimizationOpportunity {
  id: string;
  type: 'rightsizing' | 'reserved_instances' | 'spot_instances' | 'resource_termination' | 'service_optimization';
  name: string;
  description: string;
  potentialSavings: CostSavings;
  implementation: ImplementationDetails;
  risk: RiskAssessment;
  confidence: number;
  recommendedAction: string;
}

export interface CostSavings {
  monthly: number;
  annual: number;
  percentage: number;
  currency: string;
}

export interface ImplementationDetails {
  steps: string[];
  timeline: string;
  effort: 'low' | 'medium' | 'high';
  automatable: boolean;
  dependencies: string[];
}

export interface RiskAssessment {
  level: 'low' | 'medium' | 'high';
  factors: string[];
  mitigations: string[];
}

export interface GovernanceStatus {
  complianceScore: number;
  policyViolations: number;
  openAudits: number;
  lastAuditDate: string;
  issues: GovernanceIssue[];
}

export interface GovernanceIssue {
  id: string;
  type: string;
  severity: string;
  description: string;
  remediation: string;
}

export interface FinOpsKPI {
  name: string;
  value: number;
  target: number;
  unit: string;
  trend: 'improving' | 'declining' | 'stable';
  status: 'on_track' | 'at_risk' | 'off_track';
}

export interface FinOpsAlert {
  id: string;
  type: string;
  severity: string;
  message: string;
  triggeredAt: string;
}

export interface FinOpsRecommendation {
  id: string;
  type: string;
  title: string;
  description: string;
  impact: RecommendationImpact;
  effort: 'low' | 'medium' | 'high';
  priority: number;
  actions: string[];
}

export interface RecommendationImpact {
  cost: number;
  performance: string;
  risk: string;
  compliance: string;
}

export interface FinOpsDecision {
  id: string;
  type: string;
  description: string;
  options: DecisionOption[];
  selectedOption?: string;
  rationale?: string;
  decidedBy?: string;
  decidedAt?: string;
}

export interface DecisionOption {
  id: string;
  name: string;
  pros: string[];
  cons: string[];
  impact: Record<string, ConfigurationValue>;
}
