/**
 * Traces and Spans Types
 * 
 * Core trace and span data structures, retrieval, and search functionality.
 * 
 * Generated by CC - Claude Code
 */

import type { BaseMetadata, AuditableMetadata } from '../../../shared/metadata-types';
import {
  BaseApiRequest,
  BaseApiResponse,
  GetRequest,
  GetResponse,
  MultiTenantContext
} from '../../shared';

// Trace Retrieval APIs
export interface GetTraceRequest extends GetRequest {
  traceId: string;
  includeSpans?: boolean;
  includeMetrics?: boolean;
  includeLogs?: boolean;
  includeAnalysis?: boolean;
}

export interface GetTraceResponse extends GetResponse<Trace> {
  data: Trace;
  spans: Span[];
  metrics: TraceMetrics;
  logs: TraceLog[];
  analysis: TraceAnalysis;
}

export interface SearchTracesRequest extends BaseApiRequest {
  flowId?: string;
  query?: string;
  timeRange: {
    start: string;
    end: string;
  };
  services?: string[];
  operations?: string[];
  minDuration?: number;
  maxDuration?: number;
  tags?: Record<string, string>;
  limit?: number;
  context: MultiTenantContext;
}

export interface SearchTracesResponse extends BaseApiResponse<TraceSearchResult> {
  data: TraceSearchResult;
  searchId: string;
  totalTraces: number;
  traces: TraceSummary[];
  statistics: TraceStatistics;
}

// Core Trace and Span Types
export interface Trace {
  traceId: string;
  spanCount: number;
  duration: number;
  startTime: string;
  endTime: string;
  rootService: string;
  rootOperation: string;
  services: string[];
  tags: BaseMetadata;
  processes: Record<string, TraceProcess>;
  warnings: string[];
  errors: TraceError[];
}

export interface Span {
  spanId: string;
  traceId: string;
  parentSpanId?: string;
  operationName: string;
  service: string;
  startTime: string;
  duration: number;
  tags: BaseMetadata;
  logs: SpanLog[];
  references: SpanReference[];
  status: SpanStatus;
  kind: SpanKind;
  attributes: BaseMetadata;
  events: SpanEvent[];
  links: SpanLink[];
}

export interface TraceProcess {
  serviceName: string;
  tags: BaseMetadata;
}

export interface TraceError {
  spanId: string;
  message: string;
  type: string;
  stack?: string;
  tags: BaseMetadata;
}

export interface TraceMetrics {
  duration: number;
  spanCount: number;
  errorRate: number;
  serviceCount: number;
  criticalPath: CriticalPathMetrics;
  bottlenecks: BottleneckMetrics[];
  performance: TracePerformanceMetrics;
}

export interface TraceLog {
  timestamp: string;
  level: 'trace' | 'debug' | 'info' | 'warn' | 'error' | 'fatal';
  message: string;
  spanId: string;
  service: string;
  fields: BaseMetadata;
}

export interface TraceAnalysis {
  summary: TraceAnalysisSummary;
  criticalPath: CriticalPath;
  performance: PerformanceAnalysis;
  errors: ErrorAnalysis;
  dependencies: DependencyAnalysis;
  recommendations: TraceRecommendation[];
}

// Span Supporting Types
export type SpanStatus = 'ok' | 'error' | 'timeout' | 'cancelled';
export type SpanKind = 'internal' | 'server' | 'client' | 'producer' | 'consumer';

export interface SpanLog {
  timestamp: string;
  fields: BaseMetadata;
}

export interface SpanReference {
  type: 'child_of' | 'follows_from';
  traceId: string;
  spanId: string;
}

export interface SpanEvent {
  name: string;
  timestamp: string;
  attributes: BaseMetadata;
}

export interface SpanLink {
  traceId: string;
  spanId: string;
  traceState?: string;
  attributes: BaseMetadata;
}

// Search and Statistics
export interface TraceSearchResult {
  query?: string;
  totalTraces: number;
  took: number;
  maxScore: number;
}

export interface TraceSummary {
  traceId: string;
  duration: number;
  spanCount: number;
  startTime: string;
  rootService: string;
  rootOperation: string;
  errorCount: number;
  services: string[];
  tags: BaseMetadata;
  score?: number;
}

export interface TraceStatistics {
  totalTraces: number;
  averageDuration: number;
  errorRate: number;
  serviceBreakdown: ServiceBreakdown[];
  operationBreakdown: OperationBreakdown[];
  durationDistribution: DurationDistribution[];
}

export interface ServiceBreakdown {
  service: string;
  count: number;
  percentage: number;
  averageDuration: number;
  errorRate: number;
}

export interface OperationBreakdown {
  operation: string;
  service: string;
  count: number;
  percentage: number;
  averageDuration: number;
  errorRate: number;
}

export interface DurationDistribution {
  bucket: string;
  count: number;
  percentage: number;
}

// Metrics and Performance
export interface CriticalPathMetrics {
  duration: number;
  spans: string[];
  bottlenecks: string[];
  parallelization: number;
}

export interface BottleneckMetrics {
  spanId: string;
  service: string;
  operation: string;
  duration: number;
  percentage: number;
  type: 'cpu' | 'io' | 'network' | 'database' | 'external';
}

export interface TracePerformanceMetrics {
  totalDuration: number;
  networkTime: number;
  processingTime: number;
  waitTime: number;
  concurrency: number;
  efficiency: number;
}

export interface TraceAnalysisSummary {
  traceId: string;
  overallHealth: 'healthy' | 'warning' | 'critical';
  performanceScore: number;
  errorCount: number;
  bottleneckCount: number;
  anomalies: number;
}

export interface CriticalPath {
  spans: CriticalPathSpan[];
  totalDuration: number;
  bottlenecks: CriticalPathBottleneck[];
  optimizationOpportunities: OptimizationOpportunity[];
}

export interface CriticalPathSpan {
  spanId: string;
  service: string;
  operation: string;
  duration: number;
  startTime: string;
  critical: boolean;
}

export interface CriticalPathBottleneck {
  spanId: string;
  service: string;
  operation: string;
  bottleneckType: string;
  impact: number;
  recommendation: string;
}

export interface OptimizationOpportunity {
  type: 'parallelization' | 'caching' | 'optimization' | 'elimination';
  description: string;
  estimatedGain: number;
  effort: 'low' | 'medium' | 'high';
}

export interface PerformanceAnalysis {
  overallScore: number;
  latencyAnalysis: {
    average: number;
    p50: number;
    p95: number;
    p99: number;
    unit: 'ms' | 's';
  };
  throughputAnalysis: {
    requestsPerSecond: number;
    peakRps: number;
    averageRps: number;
    period: string;
  };
  errorAnalysis: {
    totalErrors: number;
    errorRate: number;
    errorsByType: Record<string, number>;
    topErrors: string[];
  };
  recommendations: {
    category: 'performance' | 'reliability' | 'cost';
    message: string;
    priority: 'low' | 'medium' | 'high';
  }[];
}

export interface ErrorAnalysis {
  totalErrors: number;
  errorRate: number;
  errorsByService: Record<string, number>;
  errorsByType: Record<string, number>;
  topErrors: TopTraceError[];
}

export interface TopTraceError {
  message: string;
  count: number;
  services: string[];
  operations: string[];
  lastOccurrence: string;
}

export interface DependencyAnalysis {
  serviceMap: ServiceDependencyMap;
  criticalPaths: DependencyCriticalPath[];
  failures: DependencyFailure[];
  recommendations: DependencyRecommendation[];
}

export interface ServiceDependencyMap {
  nodes: ServiceMapNode[];
  edges: ServiceMapEdge[];
  clusters: ServiceCluster[];
}

export interface ServiceMapNode {
  id: string;
  name: string;
  type: string;
  metadata: BaseMetadata;
}

export interface ServiceMapEdge {
  from: string;
  to: string;
  weight: number;
  metadata: BaseMetadata;
}

export interface ServiceCluster {
  id: string;
  name: string;
  services: string[];
  type: string;
}

export interface DependencyCriticalPath {
  path: string[];
  duration: number;
  bottlenecks: string[];
  risk: 'low' | 'medium' | 'high';
}

export interface DependencyFailure {
  from: string;
  to: string;
  type: string;
  frequency: number;
  impact: 'low' | 'medium' | 'high';
  lastOccurrence: string;
}

export interface DependencyRecommendation {
  type: 'redundancy' | 'circuit_breaker' | 'retry' | 'timeout' | 'fallback';
  description: string;
  services: string[];
  priority: number;
}

export interface TraceRecommendation {
  id: string;
  type: 'performance' | 'reliability' | 'cost' | 'observability';
  title: string;
  description: string;
  impact: 'low' | 'medium' | 'high';
  effort: 'low' | 'medium' | 'high';
  priority: number;
}