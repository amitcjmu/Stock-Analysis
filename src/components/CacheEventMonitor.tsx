/**
 * Cache Event Monitor Component
 *
 * Example component demonstrating the use of the type-safe WebSocket hook
 * for monitoring cache invalidation events in real-time.
 *
 * Generated by CC (Claude Code)
 */

import React, { useState, useEffect } from 'react';
import { useWebSocket, CACHE_EVENT_TYPES, type CacheInvalidationEvent } from '@/hooks/useWebSocket';
import {
  isUserContextChangedEvent,
  isFieldMappingsUpdatedEvent,
  isFlowStateChangedEvent,
  isEngagementModifiedEvent,
  isAssetInventoryUpdatedEvent
} from '@/types/websocket';

interface CacheEventMonitorProps {
  clientAccountId?: string;
  engagementId?: string;
}

export const CacheEventMonitor: React.FC<CacheEventMonitorProps> = ({
  clientAccountId,
  engagementId
}) => {
  const [events, setEvents] = useState<CacheInvalidationEvent[]>([]);
  const [filter, setFilter] = useState<string>('all');

  const {
    isConnected,
    isConnecting,
    error,
    connectionId,
    subscribe,
    lastEvent
  } = useWebSocket({
    clientAccountId,
    engagementId,
    onConnect: () => console.log('âœ… Cache event monitor connected'),
    onDisconnect: () => console.log('âŒ Cache event monitor disconnected'),
    onError: (err) => console.error('ðŸš¨ Cache event monitor error:', err)
  });

  // Subscribe to specific event types with type-safe handlers
  useEffect(() => {
    // Subscribe to user context changes
    const unsubUser = subscribe(CACHE_EVENT_TYPES.USER_CONTEXT_CHANGED, (event) => {
      if (isUserContextChangedEvent(event)) {
        console.log('User context changed:', {
          userId: event.metadata.user_id,
          role: event.metadata.role,
          permissionsChanged: event.metadata.permissions_changed
        });
        setEvents(prev => [event, ...prev].slice(0, 50)); // Keep last 50 events
      }
    });

    // Subscribe to field mapping updates
    const unsubField = subscribe(CACHE_EVENT_TYPES.FIELD_MAPPINGS_UPDATED, (event) => {
      if (isFieldMappingsUpdatedEvent(event)) {
        console.log('Field mappings updated:', {
          importId: event.metadata.import_id,
          fieldCount: event.metadata.field_count,
          status: event.metadata.mapping_status
        });
        setEvents(prev => [event, ...prev].slice(0, 50));
      }
    });

    // Subscribe to flow state changes
    const unsubFlow = subscribe(CACHE_EVENT_TYPES.FLOW_STATE_CHANGED, (event) => {
      if (isFlowStateChangedEvent(event)) {
        console.log('Flow state changed:', {
          flowId: event.metadata.flow_id,
          phase: event.metadata.phase,
          status: event.metadata.status,
          progress: event.metadata.progress
        });
        setEvents(prev => [event, ...prev].slice(0, 50));
      }
    });

    // Subscribe to all events with wildcard
    const unsubAll = subscribe('*', (event) => {
      console.log('Any cache event:', event);
    });

    // Cleanup subscriptions
    return () => {
      unsubUser();
      unsubField();
      unsubFlow();
      unsubAll();
    };
  }, [subscribe]);

  // Filter events based on selected type
  const filteredEvents = filter === 'all'
    ? events
    : events.filter(e => e.event_type === filter);

  return (
    <div className="cache-event-monitor p-4 bg-gray-50 rounded-lg">
      <div className="mb-4">
        <h3 className="text-lg font-semibold mb-2">Cache Event Monitor</h3>

        {/* Connection Status */}
        <div className="flex items-center gap-2 mb-3">
          <div className={`w-3 h-3 rounded-full ${
            isConnected ? 'bg-green-500' : isConnecting ? 'bg-yellow-500' : 'bg-red-500'
          }`} />
          <span className="text-sm text-gray-600">
            {isConnected ? `Connected (${connectionId})` : isConnecting ? 'Connecting...' : 'Disconnected'}
          </span>
        </div>

        {/* Error Display */}
        {error && (
          <div className="bg-red-100 text-red-700 p-2 rounded text-sm mb-3">
            {error}
          </div>
        )}

        {/* Event Type Filter */}
        <select
          value={filter}
          onChange={(e) => setFilter(e.target.value)}
          className="border rounded px-2 py-1 text-sm"
        >
          <option value="all">All Events</option>
          <option value={CACHE_EVENT_TYPES.USER_CONTEXT_CHANGED}>User Context</option>
          <option value={CACHE_EVENT_TYPES.FIELD_MAPPINGS_UPDATED}>Field Mappings</option>
          <option value={CACHE_EVENT_TYPES.FLOW_STATE_CHANGED}>Flow State</option>
          <option value={CACHE_EVENT_TYPES.ENGAGEMENT_MODIFIED}>Engagement</option>
          <option value={CACHE_EVENT_TYPES.ASSET_INVENTORY_UPDATED}>Asset Inventory</option>
        </select>
      </div>

      {/* Event List */}
      <div className="space-y-2 max-h-96 overflow-y-auto">
        {filteredEvents.length === 0 ? (
          <p className="text-gray-500 text-sm">No events received yet...</p>
        ) : (
          filteredEvents.map((event, index) => (
            <div
              key={`${event.timestamp}-${index}`}
              className="bg-white p-3 rounded border border-gray-200 text-sm"
            >
              <div className="flex justify-between items-start mb-1">
                <span className="font-medium text-gray-700">
                  {event.event_type.replace(/_/g, ' ').toUpperCase()}
                </span>
                <span className="text-xs text-gray-500">
                  {new Date(event.timestamp).toLocaleTimeString()}
                </span>
              </div>

              <div className="text-xs text-gray-600 space-y-1">
                <div>Entity: {event.entity_type} ({event.entity_id})</div>
                {event.client_account_id && (
                  <div>Client: {event.client_account_id}</div>
                )}
                {event.engagement_id && (
                  <div>Engagement: {event.engagement_id}</div>
                )}

                {/* Type-specific metadata */}
                {isUserContextChangedEvent(event) && (
                  <div className="mt-2 p-2 bg-blue-50 rounded">
                    <div>User ID: {event.metadata.user_id}</div>
                    {event.metadata.role && <div>Role: {event.metadata.role}</div>}
                    {event.metadata.permissions_changed && (
                      <div>Permissions Changed: Yes</div>
                    )}
                  </div>
                )}

                {isFieldMappingsUpdatedEvent(event) && (
                  <div className="mt-2 p-2 bg-purple-50 rounded">
                    <div>Import ID: {event.metadata.import_id}</div>
                    {event.metadata.field_count !== undefined && (
                      <div>Field Count: {event.metadata.field_count}</div>
                    )}
                    {event.metadata.mapping_status && (
                      <div>Status: {event.metadata.mapping_status}</div>
                    )}
                  </div>
                )}

                {isFlowStateChangedEvent(event) && (
                  <div className="mt-2 p-2 bg-green-50 rounded">
                    <div>Flow ID: {event.metadata.flow_id}</div>
                    {event.metadata.phase && <div>Phase: {event.metadata.phase}</div>}
                    {event.metadata.status && <div>Status: {event.metadata.status}</div>}
                    {event.metadata.progress !== undefined && (
                      <div>Progress: {event.metadata.progress}%</div>
                    )}
                  </div>
                )}
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
};

export default CacheEventMonitor;
