/**
 * Wave Dashboard Component with Drag-Drop Support
 *
 * Displays migration waves in a grid layout with drag-drop application assignment.
 * Uses @dnd-kit for drag and drop functionality between waves.
 *
 * Features:
 * - Display all waves from wave_plan_data
 * - Drag applications between waves
 * - Real-time wave metadata updates
 * - Persistent changes via API
 *
 * Uses snake_case field names per CLAUDE.md.
 *
 * Generated by CC - Claude Code
 */

import React, { useState, useCallback } from 'react';
import type {
  DragStartEvent,
  DragEndEvent} from '@dnd-kit/core';
import {
  DndContext,
  DragOverlay,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors
} from '@dnd-kit/core';
import {
  SortableContext,
  sortableKeyboardCoordinates,
} from '@dnd-kit/sortable';
import type { Wave } from '@/lib/api/planningFlowService';
import WaveCard, { type WaveApplication } from './WaveCard';
import { Package } from 'lucide-react';

interface WaveDashboardProps {
  /** Array of waves to display */
  waves: Wave[];
  /** Map of application IDs to application details */
  applications?: Map<string, { id: string; name: string }>;
  /** Callback when user clicks edit on a wave */
  onEditWave: (wave: Wave) => void;
  /** Callback when user clicks delete on a wave */
  onDeleteWave: (wave: Wave) => void;
  /** Callback when an application is moved between waves */
  onApplicationMoved?: (appId: string, fromWave: number, toWave: number) => Promise<void>;
  /** Whether drag-drop is enabled */
  isDragEnabled?: boolean;
}

/**
 * Wave Dashboard Component with drag-drop support.
 */
export default function WaveDashboard({
  waves,
  applications = new Map(),
  onEditWave,
  onDeleteWave,
  onApplicationMoved,
  isDragEnabled = true,
}: WaveDashboardProps): JSX.Element {
  const [activeId, setActiveId] = useState<string | null>(null);
  const [isMoving, setIsMoving] = useState(false);

  // Configure drag sensors
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Require 8px movement before drag starts
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  /**
   * Handle drag start event.
   */
  const handleDragStart = useCallback((event: DragStartEvent) => {
    setActiveId(event.active.id as string);
  }, []);

  /**
   * Handle drag end event - move application between waves.
   */
  const handleDragEnd = useCallback(
    async (event: DragEndEvent) => {
      const { active, over } = event;

      setActiveId(null);

      if (!over || !onApplicationMoved) {
        return;
      }

      // Extract data from drag event
      const activeData = active.data.current;
      const overData = over.data.current;

      // Validate this is an application being dropped on a wave
      if (
        activeData?.type !== 'application' ||
        overData?.type !== 'wave'
      ) {
        return;
      }

      const appId = activeData.app_id;
      const sourceWave = activeData.source_wave;
      const targetWave = overData.wave_number;

      // Don't move if dropped on the same wave
      if (sourceWave === targetWave) {
        return;
      }

      // Call the callback to persist the change
      setIsMoving(true);
      try {
        await onApplicationMoved(appId, sourceWave, targetWave);
      } catch (error) {
        console.error('Failed to move application:', error);
        // TODO: Show error toast
      } finally {
        setIsMoving(false);
      }
    },
    [onApplicationMoved]
  );

  /** Agent application format with full metadata */
  interface AgentApplication {
    application_id: string;
    application_name: string;
    rationale?: string;
    criticality?: string;
    complexity?: string;
    dependency_depth?: number;
    /** 6R migration strategy (Rehost, Replatform, Refactor, etc.) */
    migration_strategy?: string;
  }

  /**
   * Get applications assigned to a specific wave.
   * Handles both legacy format (string IDs) and new agent format (objects with rationale).
   */
  const getWaveApplications = useCallback(
    (wave: Wave): WaveApplication[] => {
      if (!wave.applications || wave.applications.length === 0) {
        return [];
      }

      return wave.applications
        .map((app: string | AgentApplication) => {
          // New format: app is an object with application_id and rationale
          if (typeof app === 'object' && app !== null && 'application_id' in app) {
            return {
              id: app.application_id,
              name: app.application_name || `App ${app.application_id.substring(0, 8)}...`,
              rationale: app.rationale,
              criticality: app.criticality,
              complexity: app.complexity,
              migration_strategy: app.migration_strategy,
            };
          }
          // Legacy format: app is a string (UUID)
          if (typeof app === 'string') {
            const legacyApp = applications.get(app);
            if (legacyApp) {
              return {
                id: legacyApp.id,
                name: legacyApp.name,
              };
            }
          }
          return undefined;
        })
        .filter((app): app is WaveApplication => app !== undefined);
    },
    [applications]
  );

  // Collect all application IDs for sortable context
  // Handles both legacy format (string IDs) and new agent format (objects)
  const allAppIds = waves.flatMap((wave) =>
    (wave.applications || []).map((app: string | { application_id: string }) => {
      const appId = typeof app === 'object' && 'application_id' in app ? app.application_id : app;
      return `app-${appId}`;
    })
  );

  // Empty state
  if (waves.length === 0) {
    return (
      <div className="border-2 border-dashed border-slate-200 rounded-xl p-12 text-center bg-gradient-to-br from-slate-50 via-white to-slate-50">
        <div className="max-w-md mx-auto space-y-4">
          <div className="p-4 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-2xl w-fit mx-auto">
            <Package className="h-10 w-10 text-white" />
          </div>
          <div>
            <h3 className="text-xl font-semibold text-slate-800 mb-2">No waves created yet</h3>
            <p className="text-slate-500">
              Click "Create Wave" to organize applications into migration waves for phased execution
            </p>
          </div>
        </div>
      </div>
    );
  }

  // Render active drag overlay
  const activeApp = activeId
    ? applications.get(activeId.replace('app-', ''))
    : null;

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragStart={handleDragStart}
      onDragEnd={handleDragEnd}
    >
      <SortableContext items={allAppIds}>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {waves.map((wave) => (
            <WaveCard
              key={wave.wave_number}
              wave={wave}
              applications={getWaveApplications(wave)}
              onEdit={onEditWave}
              onDelete={onDeleteWave}
              isDragEnabled={isDragEnabled && !isMoving}
            />
          ))}
        </div>

        {/* Drag Overlay */}
        <DragOverlay>
          {activeApp ? (
            <div className="flex items-center gap-2 p-3 bg-white rounded-lg border-2 border-blue-500 shadow-2xl ring-4 ring-blue-100">
              <div className="p-1.5 bg-blue-50 rounded">
                <Package className="h-4 w-4 text-blue-500" />
              </div>
              <span className="text-sm font-medium text-slate-700">{activeApp.name}</span>
            </div>
          ) : null}
        </DragOverlay>
      </SortableContext>

      {/* Moving Indicator */}
      {isMoving && (
        <div className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-6 border border-slate-200">
            <div className="flex items-center gap-4">
              <div className="relative">
                <div className="w-10 h-10 border-4 border-blue-200 rounded-full animate-pulse" />
                <div className="absolute inset-0 flex items-center justify-center">
                  <Package className="h-5 w-5 text-blue-600 animate-bounce" />
                </div>
              </div>
              <span className="text-slate-700 font-medium">Moving application...</span>
            </div>
          </div>
        </div>
      )}
    </DndContext>
  );
}
