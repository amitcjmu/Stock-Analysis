/**
 * Mapping Source Indicator Component
 *
 * Visual component that displays the source of a field mapping (AI-suggested, learned, manual, etc.)
 * with appropriate colors, icons, and confidence indicators.
 */

import React from 'react';
import { Brain, Zap, User, Star, TrendingUp, AlertTriangle, CheckCircle2 } from 'lucide-react';
import type { FieldMapping } from '../../../../../types/api/discovery/field-mapping-types';

interface MappingSourceIndicatorProps {
  mapping: FieldMapping;
  showConfidence?: boolean;
  showDetails?: boolean;
  compact?: boolean;
}

interface SourceConfig {
  icon: React.ComponentType<{ className?: string }>;
  label: string;
  color: string;
  bgColor: string;
  borderColor: string;
  description: string;
}

const SOURCE_CONFIGS: Record<string, SourceConfig> = {
  // Learned mappings (highest priority)
  learned_approval: {
    icon: Brain,
    label: 'Learned',
    color: 'text-blue-700',
    bgColor: 'bg-blue-100',
    borderColor: 'border-blue-300',
    description: 'Learned from previous user approvals'
  },

  // AI-generated mappings
  ai_suggested: {
    icon: Zap,
    label: 'AI Suggested',
    color: 'text-purple-700',
    bgColor: 'bg-purple-100',
    borderColor: 'border-purple-300',
    description: 'Generated by AI mapping algorithms'
  },

  // Manual/user-created mappings
  manual: {
    icon: User,
    label: 'Manual',
    color: 'text-green-700',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-300',
    description: 'Manually created by user'
  },

  // Approved mappings
  approved: {
    icon: CheckCircle2,
    label: 'Approved',
    color: 'text-emerald-700',
    bgColor: 'bg-emerald-100',
    borderColor: 'border-emerald-300',
    description: 'Approved by user'
  }
};

const getSourceType = (mapping: FieldMapping): string => {
  // Check mapping status first
  if (mapping.status === 'approved') {
    return 'approved';
  }

  // Check if it's a learned mapping (has learning metadata)
  if (mapping.metadata?.learned_from_approval || mapping.metadata?.pattern_matched) {
    return 'learned_approval';
  }

  // Check mapping type
  if (mapping.mapping_type === 'manual') {
    return 'manual';
  }

  // Default to AI suggested
  return 'ai_suggested';
};

const getConfidenceLevel = (score: number): { level: string; color: string; icon: React.ComponentType<{ className?: string }> } => {
  if (score >= 0.8) {
    return {
      level: 'High',
      color: 'text-green-600',
      icon: TrendingUp
    };
  } else if (score >= 0.5) {
    return {
      level: 'Medium',
      color: 'text-yellow-600',
      icon: Star
    };
  } else {
    return {
      level: 'Low',
      color: 'text-red-600',
      icon: AlertTriangle
    };
  }
};

const MappingSourceIndicator: React.FC<MappingSourceIndicatorProps> = ({
  mapping,
  showConfidence = true,
  showDetails = false,
  compact = false
}) => {
  const sourceType = getSourceType(mapping);
  const config = SOURCE_CONFIGS[sourceType];
  const confidence = getConfidenceLevel(mapping.confidence_score);

  if (compact) {
    return (
      <div className="flex items-center gap-2">
        <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs ${config.bgColor} ${config.color}`}>
          <config.icon className="h-3 w-3" />
          <span>{config.label}</span>
        </div>

        {showConfidence && (
          <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-gray-100 ${confidence.color}`}>
            <confidence.icon className="h-3 w-3" />
            <span>{(mapping.confidence_score * 100).toFixed(0)}%</span>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <div className="flex items-center gap-3">
        {/* Source Type Badge */}
        <div className={`flex items-center gap-2 px-3 py-2 rounded-lg border ${config.bgColor} ${config.borderColor}`}>
          <config.icon className={`h-4 w-4 ${config.color}`} />
          <span className={`text-sm font-medium ${config.color}`}>
            {config.label}
          </span>
        </div>

        {/* Confidence Score */}
        {showConfidence && (
          <div className="flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 bg-gray-50">
            <confidence.icon className={`h-4 w-4 ${confidence.color}`} />
            <span className="text-sm text-gray-700">
              {confidence.level} ({(mapping.confidence_score * 100).toFixed(0)}%)
            </span>
          </div>
        )}
      </div>

      {/* Additional Details */}
      {showDetails && (
        <div className="text-xs text-gray-600 pl-1">
          <p>{config.description}</p>

          {/* Learning-specific details */}
          {sourceType === 'learned_approval' && mapping.metadata?.learned_patterns && (
            <p className="mt-1 text-blue-600">
              Matched {Array.isArray(mapping.metadata.learned_patterns)
                ? mapping.metadata.learned_patterns.length
                : 1} learned pattern(s)
            </p>
          )}

          {/* AI-specific details */}
          {sourceType === 'ai_suggested' && mapping.ai_reasoning && (
            <p className="mt-1 text-purple-600">
              {mapping.ai_reasoning.length > 60
                ? `${mapping.ai_reasoning.substring(0, 60)}...`
                : mapping.ai_reasoning}
            </p>
          )}

          {/* Manual mapping details */}
          {sourceType === 'manual' && mapping.metadata?.created_by && (
            <p className="mt-1 text-green-600">
              Created by {mapping.metadata.created_by}
            </p>
          )}
        </div>
      )}
    </div>
  );
};

export default MappingSourceIndicator;
