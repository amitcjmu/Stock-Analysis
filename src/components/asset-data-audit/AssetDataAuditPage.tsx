/**
 * Asset Data Audit Page
 *
 * Comprehensive view of all data associated with an asset including
 * main table columns, enrichment tables, and JSONB contents.
 *
 * Generated by CC (Claude Code) for Asset Data Review feature
 */

import React, { useState } from 'react';
import {
  useAssetListForAudit,
  useAssetDataAudit,
  formatCategoryName,
  getCompletenessColor,
  getCompletenessBgColor,
  getEnrichmentDisplayName,
  type AssetListItem,
  type CategoryStats,
  type EnrichmentTableInfo,
  type FieldInfo,
} from '@/services/assetDataAuditService';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Progress } from '@/components/ui/progress';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Search,
  Database,
  AlertTriangle,
  CheckCircle2,
  XCircle,
  ChevronRight,
  RefreshCw,
  Filter,
  Eye,
  EyeOff,
} from 'lucide-react';

// Summary Card Component
const SummaryCard: React.FC<{
  title: string;
  populated: number;
  total: number;
  completeness: number;
}> = ({ title, populated, total, completeness }) => (
  <Card>
    <CardHeader className="pb-2">
      <CardTitle className="text-sm font-medium">{title}</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="flex items-center justify-between">
        <span className={`text-2xl font-bold ${getCompletenessColor(completeness)}`}>
          {completeness.toFixed(1)}%
        </span>
        <span className="text-sm text-muted-foreground">
          {populated}/{total} fields
        </span>
      </div>
      <Progress value={completeness} className="mt-2" />
    </CardContent>
  </Card>
);

// Category Section Component
const CategorySection: React.FC<{
  category: string;
  data: CategoryStats;
  filterMode: 'all' | 'populated' | 'empty';
}> = ({ category, data, filterMode }) => {
  const filteredFields = data.fields.filter((field) => {
    if (filterMode === 'populated') return field.populated;
    if (filterMode === 'empty') return !field.populated;
    return true;
  });

  if (filteredFields.length === 0) return null;

  return (
    <AccordionItem value={category}>
      <AccordionTrigger className="hover:no-underline">
        <div className="flex items-center justify-between w-full pr-4">
          <span className="font-medium">{formatCategoryName(category)}</span>
          <div className="flex items-center gap-2">
            <Badge
              variant="outline"
              className={getCompletenessBgColor(data.completeness_pct)}
            >
              {data.completeness_pct.toFixed(1)}%
            </Badge>
            <span className="text-sm text-muted-foreground">
              {data.populated}/{data.total}
            </span>
          </div>
        </div>
      </AccordionTrigger>
      <AccordionContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-[30px]"></TableHead>
              <TableHead>Field</TableHead>
              <TableHead>Value</TableHead>
              <TableHead className="w-[100px]">Type</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {filteredFields.map((field) => (
              <TableRow key={field.name}>
                <TableCell>
                  {field.populated ? (
                    <CheckCircle2 className="h-4 w-4 text-green-500" />
                  ) : (
                    <XCircle className="h-4 w-4 text-red-400" />
                  )}
                </TableCell>
                <TableCell>
                  <div>
                    <span className="font-medium">{field.display_name}</span>
                    <span className="text-xs text-muted-foreground ml-2">
                      ({field.name})
                    </span>
                  </div>
                  {field.hint && (
                    <p className="text-xs text-muted-foreground">{field.hint}</p>
                  )}
                </TableCell>
                <TableCell className="max-w-[300px]">
                  {field.value !== null && field.value !== undefined ? (
                    <span className="text-sm break-all">
                      {(() => {
                        const valueStr =
                          typeof field.value === 'object'
                            ? JSON.stringify(field.value)
                            : String(field.value);
                        return (
                          valueStr.slice(0, 100) +
                          (valueStr.length > 100 ? '...' : '')
                        );
                      })()}
                    </span>
                  ) : (
                    <span className="text-muted-foreground italic">null</span>
                  )}
                </TableCell>
                <TableCell>
                  <Badge variant="secondary" className="text-xs">
                    {field.type.split('(')[0]}
                  </Badge>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </AccordionContent>
    </AccordionItem>
  );
};

// Enrichment Section Component
const EnrichmentSection: React.FC<{
  enrichments: Record<string, EnrichmentTableInfo>;
}> = ({ enrichments }) => (
  <div className="space-y-4">
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
      {Object.entries(enrichments).map(([key, data]) => (
        <Card
          key={key}
          className={data.exists ? 'border-green-200' : 'border-red-200'}
        >
          <CardContent className="pt-4">
            <div className="flex items-center gap-2">
              {data.exists ? (
                <CheckCircle2 className="h-4 w-4 text-green-500" />
              ) : (
                <XCircle className="h-4 w-4 text-red-400" />
              )}
              <span className="text-sm font-medium">
                {getEnrichmentDisplayName(key)}
              </span>
            </div>
            <p className="text-xs text-muted-foreground mt-1">
              {data.exists ? `${data.record_count} record(s)` : 'No data'}
            </p>
          </CardContent>
        </Card>
      ))}
    </div>

    {/* Show enrichment records if they exist */}
    <Accordion type="multiple" className="mt-4">
      {Object.entries(enrichments)
        .filter(([, data]) => data.exists && data.records.length > 0)
        .map(([key, data]) => (
          <AccordionItem key={key} value={key}>
            <AccordionTrigger className="hover:no-underline">
              <span className="font-medium">{getEnrichmentDisplayName(key)}</span>
              <Badge variant="outline" className="ml-2">
                {data.record_count} records
              </Badge>
            </AccordionTrigger>
            <AccordionContent>
              <div className="overflow-x-auto">
                <pre className="text-xs bg-muted p-4 rounded-md overflow-auto max-h-64">
                  {JSON.stringify(data.records, null, 2)}
                </pre>
              </div>
            </AccordionContent>
          </AccordionItem>
        ))}
    </Accordion>
  </div>
);

// JSONB Content Section
const JsonbSection: React.FC<{
  jsonbData: Record<string, unknown>;
}> = ({ jsonbData }) => {
  if (Object.keys(jsonbData).length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        <Database className="h-12 w-12 mx-auto mb-2 opacity-50" />
        <p>No JSONB data found for this asset</p>
      </div>
    );
  }

  return (
    <Accordion type="multiple">
      {Object.entries(jsonbData).map(([key, value]) => (
        <AccordionItem key={key} value={key}>
          <AccordionTrigger className="hover:no-underline">
            <span className="font-medium">{formatCategoryName(key)}</span>
            <Badge variant="outline" className="ml-2">
              {typeof value === 'object' && value !== null
                ? `${Object.keys(value).length} keys`
                : typeof value}
            </Badge>
          </AccordionTrigger>
          <AccordionContent>
            <pre className="text-xs bg-muted p-4 rounded-md overflow-auto max-h-96">
              {JSON.stringify(value, null, 2)}
            </pre>
          </AccordionContent>
        </AccordionItem>
      ))}
    </Accordion>
  );
};

// Data Gaps Alert Component
const DataGapsAlert: React.FC<{
  gaps: {
    empty_categories: string[];
    low_completeness_categories: { category: string; completeness_pct: number }[];
    missing_enrichments: string[];
  };
}> = ({ gaps }) => {
  const hasGaps =
    gaps.empty_categories.length > 0 ||
    gaps.low_completeness_categories.length > 0 ||
    gaps.missing_enrichments.length > 0;

  if (!hasGaps) {
    return (
      <Card className="border-green-200 bg-green-50">
        <CardContent className="pt-4">
          <div className="flex items-center gap-2">
            <CheckCircle2 className="h-5 w-5 text-green-600" />
            <span className="font-medium text-green-800">
              No significant data gaps detected
            </span>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="border-yellow-200 bg-yellow-50">
      <CardHeader className="pb-2">
        <div className="flex items-center gap-2">
          <AlertTriangle className="h-5 w-5 text-yellow-600" />
          <CardTitle className="text-sm text-yellow-800">
            Data Gaps Identified
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="space-y-3">
        {gaps.empty_categories.length > 0 && (
          <div>
            <p className="text-sm font-medium text-yellow-800">Empty Categories:</p>
            <div className="flex flex-wrap gap-1 mt-1">
              {gaps.empty_categories.map((cat) => (
                <Badge key={cat} variant="destructive" className="text-xs">
                  {formatCategoryName(cat)}
                </Badge>
              ))}
            </div>
          </div>
        )}
        {gaps.low_completeness_categories.length > 0 && (
          <div>
            <p className="text-sm font-medium text-yellow-800">
              Low Completeness Categories:
            </p>
            <div className="flex flex-wrap gap-1 mt-1">
              {gaps.low_completeness_categories.map((cat) => (
                <Badge
                  key={cat.category}
                  variant="outline"
                  className="text-xs bg-orange-100"
                >
                  {formatCategoryName(cat.category)}: {cat.completeness_pct.toFixed(1)}%
                </Badge>
              ))}
            </div>
          </div>
        )}
        {gaps.missing_enrichments.length > 0 && (
          <div>
            <p className="text-sm font-medium text-yellow-800">
              Missing Enrichment Tables:
            </p>
            <div className="flex flex-wrap gap-1 mt-1">
              {gaps.missing_enrichments.map((enr) => (
                <Badge key={enr} variant="secondary" className="text-xs">
                  {getEnrichmentDisplayName(enr)}
                </Badge>
              ))}
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
};

// Asset Selector Component
const AssetSelector: React.FC<{
  onSelect: (assetId: string) => void;
  selectedId: string | null;
}> = ({ onSelect, selectedId }) => {
  const [search, setSearch] = useState('');
  const [phase, setPhase] = useState<string>('all');

  const { data, isLoading, refetch } = useAssetListForAudit({
    limit: 50,
    search: search || undefined,
    phase: phase && phase !== 'all' ? phase : undefined,
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">Select Asset to Audit</CardTitle>
        <CardDescription>
          Choose an asset to view its complete data profile
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="flex gap-2 mb-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search assets..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>
          <Select value={phase} onValueChange={setPhase}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="All Phases" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Phases</SelectItem>
              <SelectItem value="discovery">Discovery</SelectItem>
              <SelectItem value="assessment">Assessment</SelectItem>
              <SelectItem value="planning">Planning</SelectItem>
            </SelectContent>
          </Select>
          <Button variant="outline" size="icon" onClick={() => refetch()}>
            <RefreshCw className="h-4 w-4" />
          </Button>
        </div>

        {isLoading ? (
          <div className="text-center py-4 text-muted-foreground">Loading...</div>
        ) : (
          <div className="space-y-2 max-h-64 overflow-y-auto">
            {data?.assets.map((asset) => (
              <div
                key={asset.id}
                className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition-colors ${
                  selectedId === asset.id
                    ? 'border-primary bg-primary/5'
                    : 'hover:bg-muted'
                }`}
                onClick={() => onSelect(asset.id)}
              >
                <div>
                  <p className="font-medium">{asset.name}</p>
                  <div className="flex items-center gap-2 text-xs text-muted-foreground">
                    {asset.current_phase && (
                      <Badge variant="outline" className="text-xs">
                        {asset.current_phase}
                      </Badge>
                    )}
                    {asset.assessment_flow_id && (
                      <span className="text-green-600">Assessed</span>
                    )}
                  </div>
                </div>
                <ChevronRight className="h-4 w-4 text-muted-foreground" />
              </div>
            ))}
            {data?.assets.length === 0 && (
              <div className="text-center py-4 text-muted-foreground">
                No assets found
              </div>
            )}
          </div>
        )}
        {data && (
          <p className="text-xs text-muted-foreground mt-2">
            Showing {data.assets.length} of {data.total} assets
          </p>
        )}
      </CardContent>
    </Card>
  );
};

// Main Page Component
export const AssetDataAuditPage: React.FC = () => {
  const [selectedAssetId, setSelectedAssetId] = useState<string | null>(null);
  const [filterMode, setFilterMode] = useState<'all' | 'populated' | 'empty'>('all');

  const { data: auditData, isLoading, error, refetch } = useAssetDataAudit(
    selectedAssetId,
    !!selectedAssetId
  );

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Asset Data Review</h1>
          <p className="text-muted-foreground">
            Comprehensive view of all asset data, enrichments, and gap analysis
          </p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Asset Selector */}
        <div className="lg:col-span-1">
          <AssetSelector
            onSelect={setSelectedAssetId}
            selectedId={selectedAssetId}
          />
        </div>

        {/* Audit Results */}
        <div className="lg:col-span-2">
          {!selectedAssetId ? (
            <Card className="h-full flex items-center justify-center">
              <CardContent className="text-center py-12">
                <Database className="h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50" />
                <p className="text-lg font-medium">Select an Asset</p>
                <p className="text-muted-foreground">
                  Choose an asset from the list to view its complete data profile
                </p>
              </CardContent>
            </Card>
          ) : isLoading ? (
            <Card className="h-full flex items-center justify-center">
              <CardContent className="text-center py-12">
                <RefreshCw className="h-8 w-8 mx-auto mb-4 animate-spin text-primary" />
                <p>Loading asset data...</p>
              </CardContent>
            </Card>
          ) : error ? (
            <Card className="border-red-200">
              <CardContent className="text-center py-12">
                <AlertTriangle className="h-8 w-8 mx-auto mb-4 text-red-500" />
                <p className="text-red-600">Failed to load asset data</p>
                <Button
                  variant="outline"
                  className="mt-4"
                  onClick={() => refetch()}
                >
                  Retry
                </Button>
              </CardContent>
            </Card>
          ) : auditData ? (
            <div className="space-y-6">
              {/* Header */}
              <Card>
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <div>
                      <CardTitle>{auditData.asset_name}</CardTitle>
                      <CardDescription className="font-mono text-xs">
                        {auditData.asset_id}
                      </CardDescription>
                    </div>
                    <Button variant="outline" size="sm" onClick={() => refetch()}>
                      <RefreshCw className="h-4 w-4 mr-2" />
                      Refresh
                    </Button>
                  </div>
                </CardHeader>
              </Card>

              {/* Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <SummaryCard
                  title="Main Table"
                  populated={auditData.summary.main_table.populated_fields}
                  total={auditData.summary.main_table.total_fields}
                  completeness={auditData.summary.main_table.completeness_pct}
                />
                <SummaryCard
                  title="Enrichments"
                  populated={auditData.summary.enrichments.populated_fields}
                  total={auditData.summary.enrichments.total_fields}
                  completeness={auditData.summary.enrichments.completeness_pct}
                />
                <SummaryCard
                  title="Overall"
                  populated={auditData.summary.overall.populated_fields}
                  total={auditData.summary.overall.total_fields}
                  completeness={auditData.summary.overall.completeness_pct}
                />
              </div>

              {/* Data Gaps Alert */}
              <DataGapsAlert gaps={auditData.data_gaps} />

              {/* Tabbed Content */}
              <Tabs defaultValue="categories">
                <div className="flex items-center justify-between mb-4">
                  <TabsList>
                    <TabsTrigger value="categories">Categories</TabsTrigger>
                    <TabsTrigger value="enrichments">Enrichments</TabsTrigger>
                    <TabsTrigger value="jsonb">JSONB Data</TabsTrigger>
                  </TabsList>

                  {/* Filter for Categories tab */}
                  <div className="flex items-center gap-2">
                    <Filter className="h-4 w-4 text-muted-foreground" />
                    <Select
                      value={filterMode}
                      onValueChange={(v) =>
                        setFilterMode(v as 'all' | 'populated' | 'empty')
                      }
                    >
                      <SelectTrigger className="w-[150px]">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">
                          <div className="flex items-center gap-2">
                            <Eye className="h-4 w-4" />
                            All Fields
                          </div>
                        </SelectItem>
                        <SelectItem value="populated">
                          <div className="flex items-center gap-2">
                            <CheckCircle2 className="h-4 w-4 text-green-500" />
                            Populated
                          </div>
                        </SelectItem>
                        <SelectItem value="empty">
                          <div className="flex items-center gap-2">
                            <EyeOff className="h-4 w-4 text-red-400" />
                            Empty
                          </div>
                        </SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <TabsContent value="categories">
                  <Card>
                    <CardContent className="pt-4">
                      <Accordion type="multiple">
                        {Object.entries(auditData.categories)
                          .sort(([, a], [, b]) => b.total - a.total)
                          .map(([category, data]) => (
                            <CategorySection
                              key={category}
                              category={category}
                              data={data}
                              filterMode={filterMode}
                            />
                          ))}
                      </Accordion>
                    </CardContent>
                  </Card>
                </TabsContent>

                <TabsContent value="enrichments">
                  <Card>
                    <CardContent className="pt-4">
                      <EnrichmentSection enrichments={auditData.enrichments} />
                    </CardContent>
                  </Card>
                </TabsContent>

                <TabsContent value="jsonb">
                  <Card>
                    <CardContent className="pt-4">
                      <JsonbSection jsonbData={auditData.jsonb_expanded} />
                    </CardContent>
                  </Card>
                </TabsContent>
              </Tabs>
            </div>
          ) : null}
        </div>
      </div>
    </div>
  );
};

export default AssetDataAuditPage;
