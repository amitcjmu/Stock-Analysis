/**
 * Asset Data Audit Service
 *
 * Provides API calls and React Query hooks for the Asset Data Review feature.
 * Allows comprehensive auditing of asset data including main table columns,
 * enrichment tables, and JSONB contents.
 *
 * Generated by CC (Claude Code) for Asset Data Review feature
 */

import { useQuery } from '@tanstack/react-query';
import api from './api';
import { useAuth } from '@/contexts/AuthContext';

// Types matching backend Pydantic schemas
export interface FieldInfo {
  name: string;
  display_name: string;
  value: unknown;
  populated: boolean;
  type: string;
  hint: string | null;
  comment: string | null;
}

export interface CategoryStats {
  fields: FieldInfo[];
  populated: number;
  total: number;
  completeness_pct: number;
}

export interface EnrichmentTableInfo {
  exists: boolean;
  record_count: number;
  records: Record<string, unknown>[];
  error?: string;
}

export interface SummaryStats {
  total_fields: number;
  populated_fields: number;
  completeness_pct: number;
}

export interface OverallSummary {
  main_table: SummaryStats;
  enrichments: SummaryStats;
  overall: SummaryStats;
}

export interface LowCompletenessCategory {
  category: string;
  completeness_pct: number;
}

export interface DataGaps {
  empty_categories: string[];
  low_completeness_categories: LowCompletenessCategory[];
  missing_enrichments: string[];
}

export interface AssetDataAuditResponse {
  asset_id: string;
  asset_name: string;
  summary: OverallSummary;
  categories: Record<string, CategoryStats>;
  enrichments: Record<string, EnrichmentTableInfo>;
  jsonb_expanded: Record<string, unknown>;
  data_gaps: DataGaps;
}

export interface AssetListItem {
  id: string;
  name: string;
  current_phase: string | null;
  assessment_flow_id: string | null;
  completeness_pct?: number;
}

export interface AssetListResponse {
  assets: AssetListItem[];
  total: number;
}

export interface AssetAuditSummary {
  asset_id: string;
  asset_name: string;
  summary: OverallSummary;
  data_gaps: DataGaps;
  category_summaries: Record<
    string,
    { populated: number; total: number; completeness_pct: number }
  >;
  enrichment_status: Record<
    string,
    { exists: boolean; record_count: number }
  >;
}

// API calls
const fetchAssetList = async (params: {
  limit?: number;
  offset?: number;
  search?: string;
  phase?: string;
}): Promise<AssetListResponse> => {
  const queryParams = new URLSearchParams();
  if (params.limit) queryParams.append('limit', params.limit.toString());
  if (params.offset) queryParams.append('offset', params.offset.toString());
  if (params.search) queryParams.append('search', params.search);
  if (params.phase) queryParams.append('phase', params.phase);

  // api.get returns the parsed JSON directly (not wrapped in { data: ... })
  const data = await api.get(
    `/api/v1/asset-data-audit/assets?${queryParams.toString()}`
  );
  return data as AssetListResponse;
};

const fetchAssetDataAudit = async (
  assetId: string
): Promise<AssetDataAuditResponse> => {
  // api.get returns the parsed JSON directly (not wrapped in { data: ... })
  const data = await api.get(`/api/v1/asset-data-audit/${assetId}`);
  return data as AssetDataAuditResponse;
};

const fetchAssetAuditSummary = async (
  assetId: string
): Promise<AssetAuditSummary> => {
  // api.get returns the parsed JSON directly (not wrapped in { data: ... })
  const data = await api.get(`/api/v1/asset-data-audit/${assetId}/summary`);
  return data as AssetAuditSummary;
};

// React Query Hooks

/**
 * Hook to fetch list of assets for audit selection
 */
export const useAssetListForAudit = (params: {
  limit?: number;
  offset?: number;
  search?: string;
  phase?: string;
  enabled?: boolean;
}) => {
  const { client, engagement } = useAuth();

  return useQuery({
    queryKey: [
      'assetListForAudit',
      params.limit,
      params.offset,
      params.search,
      params.phase,
    ],
    queryFn: () => fetchAssetList(params),
    enabled:
      (params.enabled ?? true) &&
      !!client?.id &&
      !!engagement?.id,
    staleTime: 30 * 1000, // 30 seconds
  });
};

/**
 * Hook to fetch comprehensive asset data audit
 */
export const useAssetDataAudit = (assetId: string | null, enabled = true) => {
  const { client, engagement } = useAuth();

  return useQuery({
    queryKey: ['assetDataAudit', assetId],
    queryFn: () => fetchAssetDataAudit(assetId!),
    enabled:
      enabled &&
      !!assetId &&
      !!client?.id &&
      !!engagement?.id,
    staleTime: 60 * 1000, // 1 minute
  });
};

/**
 * Hook to fetch quick summary of asset data completeness
 */
export const useAssetAuditSummary = (
  assetId: string | null,
  enabled = true
) => {
  const { client, engagement } = useAuth();

  return useQuery({
    queryKey: ['assetAuditSummary', assetId],
    queryFn: () => fetchAssetAuditSummary(assetId!),
    enabled:
      enabled &&
      !!assetId &&
      !!client?.id &&
      !!engagement?.id,
    staleTime: 60 * 1000, // 1 minute
  });
};

// Utility functions for UI

/**
 * Get color class based on completeness percentage
 */
export const getCompletenessColor = (percentage: number): string => {
  if (percentage >= 75) return 'text-green-600';
  if (percentage >= 50) return 'text-yellow-600';
  if (percentage >= 25) return 'text-orange-600';
  return 'text-red-600';
};

/**
 * Get background color class based on completeness percentage
 */
export const getCompletenessBgColor = (percentage: number): string => {
  if (percentage >= 75) return 'bg-green-100';
  if (percentage >= 50) return 'bg-yellow-100';
  if (percentage >= 25) return 'bg-orange-100';
  return 'bg-red-100';
};

/**
 * Format category name for display
 */
export const formatCategoryName = (category: string): string => {
  return category
    .split('_')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

/**
 * Get enrichment table display name
 */
export const getEnrichmentDisplayName = (key: string): string => {
  const displayNames: Record<string, string> = {
    resilience: 'Resilience (RTO/RPO)',
    compliance_flags: 'Compliance Flags',
    vulnerabilities: 'Vulnerabilities',
    tech_debt: 'Technical Debt',
    dependencies: 'Dependencies',
    performance_metrics: 'Performance Metrics',
    cost_optimization: 'Cost Optimization',
    licenses: 'Licenses',
    contacts: 'Contacts',
    custom_attributes_table: 'Custom Attributes',
    eol_assessments: 'EOL Assessments',
    product_links: 'Product Links',
  };
  return displayNames[key] || formatCategoryName(key);
};
