/**
 * Resource Planning Page
 *
 * Displays team resource allocation, utilization metrics, and recommendations
 * for migration planning. Uses gradient stat cards for visual consistency
 * with other Plan pages.
 *
 * Generated by CC - Claude Code
 */

import type React from 'react';
import { useSearchParams } from 'react-router-dom';
import {
  Users,
  Loader2,
  AlertTriangle,
  UserPlus,
  BarChart,
  Calendar,
  Briefcase,
  TrendingUp,
  Target,
  Clock
} from 'lucide-react';
import { useResource } from '@/hooks/useResource';
import Sidebar from '@/components/Sidebar';
import { SidebarProvider } from '@/components/ui/sidebar';
import { Alert } from '@/components/ui/alert';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Table, TableHeader, TableRow, TableHead, TableBody, TableCell } from '@/components/ui/table';
import ContextBreadcrumbs from '@/components/context/ContextBreadcrumbs';
import PlanNavigation from '@/components/plan/PlanNavigation';

const Resource = (): JSX.Element => {
  // Extract planning_flow_id from URL search params for 6R-based resource estimation
  const [searchParams] = useSearchParams();
  const planningFlowId = searchParams.get('planning_flow_id') || undefined;

  const { data, isLoading, isError, error } = useResource(planningFlowId);

  if (isLoading) {
    return (
      <SidebarProvider>
        <div className="min-h-screen bg-gray-50 flex">
          <Sidebar />
          <div className="flex-1 ml-64 flex items-center justify-center">
            <div className="flex flex-col items-center space-y-4">
              <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
              <p className="text-gray-600">Loading resource data...</p>
            </div>
          </div>
        </div>
      </SidebarProvider>
    );
  }

  if (isError) {
    return (
      <SidebarProvider>
        <div className="min-h-screen bg-gray-50 flex">
          <Sidebar />
          <div className="flex-1 ml-64 p-8">
            <Alert variant="destructive">
              <AlertTriangle className="h-4 w-4" />
              <p>Error loading resource data: {error?.message}</p>
            </Alert>
          </div>
        </div>
      </SidebarProvider>
    );
  }

  const getUtilizationColor = (utilization: number): string => {
    if (utilization > 90) return 'text-red-600';
    if (utilization > 75) return 'text-yellow-600';
    return 'text-green-600';
  };

  const getUtilizationBarColor = (utilization: number): string => {
    if (utilization > 90) return 'bg-red-500';
    if (utilization > 75) return 'bg-yellow-500';
    return 'bg-emerald-500';
  };

  const getImpactColor = (impact: string): string => {
    const colors: Record<string, string> = {
      'High': 'bg-red-100 text-red-800 border-red-200',
      'Medium': 'bg-yellow-100 text-yellow-800 border-yellow-200',
      'Low': 'bg-green-100 text-green-800 border-green-200'
    };
    return colors[impact] || 'bg-gray-100 text-gray-800 border-gray-200';
  };

  return (
    <SidebarProvider>
      <div className="min-h-screen bg-gray-50 flex">
        <Sidebar />
        <div className="flex-1 ml-64">
          <main className="p-8">
            {/* Context Breadcrumbs */}
            <ContextBreadcrumbs showContextSelector={true} />

            {/* Plan Navigation Tabs */}
            <PlanNavigation />

            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="mb-8">
                <div className="flex items-center justify-between">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">Resource Planning</h1>
                    <p className="text-lg text-gray-600">
                      Manage and optimize team resources for migration projects
                    </p>
                  </div>
                  <div className="flex space-x-3">
                    <Button variant="outline" className="bg-white">
                      <BarChart className="h-5 w-5 mr-2" />
                      Resource Report
                    </Button>
                    <Button>
                      <UserPlus className="h-5 w-5 mr-2" />
                      Add Team
                    </Button>
                  </div>
                </div>
              </div>

              {/* Gradient Statistics Cards */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                {/* Total Teams - Blue Gradient */}
                <Card className="relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-br from-blue-500 to-blue-600" />
                  <div className="relative p-6 text-white">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-blue-100 text-sm font-medium">Total Teams</p>
                        <p className="text-3xl font-bold mt-1">{data.metrics.total_teams}</p>
                        <p className="text-blue-100 text-sm mt-1">active</p>
                      </div>
                      <div className="bg-white/20 rounded-full p-3">
                        <Users className="h-8 w-8 text-white" />
                      </div>
                    </div>
                  </div>
                </Card>

                {/* Total Resources - Orange Gradient */}
                <Card className="relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-br from-orange-400 to-orange-500" />
                  <div className="relative p-6 text-white">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-orange-100 text-sm font-medium">Total Resources</p>
                        <p className="text-3xl font-bold mt-1">{data.metrics.total_resources}</p>
                        <p className="text-orange-100 text-sm mt-1">members</p>
                      </div>
                      <div className="bg-white/20 rounded-full p-3">
                        <Briefcase className="h-8 w-8 text-white" />
                      </div>
                    </div>
                  </div>
                </Card>

                {/* Avg Utilization - Green/Yellow based on value */}
                <Card className="relative overflow-hidden">
                  <div className={`absolute inset-0 ${
                    data.metrics.average_utilization > 90
                      ? 'bg-gradient-to-br from-red-500 to-red-600'
                      : data.metrics.average_utilization > 75
                        ? 'bg-gradient-to-br from-amber-500 to-amber-600'
                        : 'bg-gradient-to-br from-emerald-500 to-emerald-600'
                  }`} />
                  <div className="relative p-6 text-white">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-white/80 text-sm font-medium">Avg. Utilization</p>
                        <p className="text-3xl font-bold mt-1">{data.metrics.average_utilization}%</p>
                        <p className="text-white/80 text-sm mt-1">capacity</p>
                      </div>
                      <div className="bg-white/20 rounded-full p-3">
                        <TrendingUp className="h-8 w-8 text-white" />
                      </div>
                    </div>
                  </div>
                </Card>

                {/* Available Capacity - Purple Gradient */}
                <Card className="relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-br from-violet-500 to-purple-600" />
                  <div className="relative p-6 text-white">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-violet-100 text-sm font-medium">Available</p>
                        <p className="text-3xl font-bold mt-1">{100 - data.metrics.average_utilization}%</p>
                        <p className="text-violet-100 text-sm mt-1">capacity</p>
                      </div>
                      <div className="bg-white/20 rounded-full p-3">
                        <Target className="h-8 w-8 text-white" />
                      </div>
                    </div>
                  </div>
                </Card>
              </div>

              {/* Recommendations */}
              <Card className="mb-8">
                <div className="p-6">
                  <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <AlertTriangle className="h-5 w-5 text-amber-500" />
                    Resource Recommendations
                  </h2>
                  <div className="space-y-3">
                    {data.recommendations.map((rec, index) => (
                      <div
                        key={index}
                        className="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-white rounded-lg border border-slate-200"
                      >
                        <p className="text-sm text-gray-700 flex-1">{rec.description}</p>
                        <Badge className={`ml-4 ${getImpactColor(rec.impact)}`}>
                          {rec.impact} Impact
                        </Badge>
                      </div>
                    ))}
                  </div>
                </div>
              </Card>

              {/* Team Allocation Table */}
              <Card className="mb-8">
                <div className="p-6">
                  <h2 className="text-lg font-semibold text-gray-900 mb-6 flex items-center gap-2">
                    <Users className="h-5 w-5 text-blue-500" />
                    Team Allocation
                  </h2>
                  <Table>
                    <TableHeader>
                      <TableRow className="bg-slate-50">
                        <TableHead className="font-semibold">Team</TableHead>
                        <TableHead className="font-semibold">Size</TableHead>
                        <TableHead className="font-semibold">Skills</TableHead>
                        <TableHead className="font-semibold">Utilization</TableHead>
                        <TableHead className="font-semibold">Current Assignments</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {data.teams.map((team) => (
                        <TableRow key={team.id} className="hover:bg-slate-50">
                          <TableCell>
                            <div>
                              <div className="font-medium text-gray-900">{team.name}</div>
                              <div className="text-xs text-gray-500 font-mono">{team.id}</div>
                            </div>
                          </TableCell>
                          <TableCell>
                            <div className="flex items-center gap-2">
                              <Users className="h-4 w-4 text-gray-400" />
                              <span>{team.size} members</span>
                            </div>
                          </TableCell>
                          <TableCell>
                            <div className="flex flex-wrap gap-1 max-w-xs">
                              {team.skills.map((skill, index) => (
                                <Badge
                                  key={index}
                                  variant="outline"
                                  className="text-xs bg-slate-50"
                                >
                                  {skill}
                                </Badge>
                              ))}
                            </div>
                          </TableCell>
                          <TableCell>
                            <div className="w-32">
                              <div className="flex justify-between text-sm mb-1">
                                <span className={`font-semibold ${getUtilizationColor(team.utilization)}`}>
                                  {team.utilization}%
                                </span>
                              </div>
                              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${getUtilizationBarColor(team.utilization)} transition-all`}
                                  style={{ width: `${team.utilization}%` }}
                                />
                              </div>
                            </div>
                          </TableCell>
                          <TableCell>
                            <div className="space-y-2">
                              {team.assignments.map((assignment, index) => (
                                <div key={index} className="text-sm bg-slate-50 p-2 rounded-lg">
                                  <div className="font-medium text-gray-900">{assignment.project}</div>
                                  <div className="text-gray-500 flex items-center text-xs mt-1">
                                    <Calendar className="h-3 w-3 mr-1" />
                                    {new Date(assignment.start_date).toLocaleDateString()} - {new Date(assignment.end_date).toLocaleDateString()}
                                  </div>
                                  <div className="text-blue-600 text-xs mt-1 font-medium">{assignment.allocation}% allocated</div>
                                </div>
                              ))}
                            </div>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </Card>

              {/* Upcoming Resource Needs */}
              <Card>
                <div className="p-6">
                  <h2 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Clock className="h-5 w-5 text-purple-500" />
                    Upcoming Resource Needs
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {data.upcoming_needs.map((need, index) => (
                      <Card
                        key={index}
                        className="p-4 bg-gradient-to-br from-slate-50 to-white border border-slate-200 hover:shadow-md transition-shadow"
                      >
                        <h3 className="font-semibold text-gray-900">{need.skill}</h3>
                        <p className="text-sm text-gray-600 mt-2">
                          <span className="font-medium text-gray-900">{need.demand}</span> resources needed
                        </p>
                        <div className="flex items-center gap-1 text-sm text-purple-600 mt-2">
                          <Calendar className="h-4 w-4" />
                          <span className="font-medium">{need.timeline}</span>
                        </div>
                      </Card>
                    ))}
                  </div>
                </div>
              </Card>
            </div>
          </main>
        </div>
      </div>
    </SidebarProvider>
  );
};

export default Resource;
