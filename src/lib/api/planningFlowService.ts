/**
 * Planning Flow API Service
 *
 * API client for Wave Planning Flow endpoints using MFO integration.
 * All field names use snake_case per CLAUDE.md field naming convention.
 *
 * Endpoints:
 * - POST /api/v1/master-flows/planning/initialize - Create planning flow
 * - POST /api/v1/master-flows/planning/execute-phase - Execute planning phase
 * - GET /api/v1/master-flows/planning/status/{planning_flow_id} - Get status
 * - PUT /api/v1/master-flows/planning/update-wave-plan - Update wave plan
 * - GET /api/v1/master-flows/planning/export/{planning_flow_id} - Export data
 *
 * Generated by CC - Claude Code
 */

import { apiClient } from './apiClient';

// =============================================================================
// Request/Response Types (Using snake_case per CLAUDE.md)
// =============================================================================

/**
 * Request to initialize a new planning flow.
 *
 * CRITICAL: All field names use snake_case (NOT camelCase).
 * Note: engagement_id comes from X-Engagement-ID header, not request body.
 */
export interface InitializePlanningFlowRequest {
  /** Array of selected application UUID strings */
  selected_application_ids: string[];
  /** Optional planning configuration */
  planning_config?: {
    /** Maximum applications per wave */
    max_apps_per_wave?: number;
    /** Wave duration limit in days */
    wave_duration_limit_days?: number;
    /** Contingency percentage (e.g., 20 for 20%) */
    contingency_percentage?: number;
  };
}

/**
 * Response when creating planning flow.
 */
export interface PlanningFlowResponse {
  /** Master flow_id from crewai_flow_state_extensions */
  master_flow_id: string;
  /** Child planning_flow_id from planning_flows */
  planning_flow_id: string;
  /** Current planning phase */
  current_phase: string;
  /** Phase status */
  phase_status: string;
  /** Overall flow status */
  status: string;
}

/**
 * Detailed planning flow status response.
 */
export interface PlanningStatus {
  /** Planning flow identifier */
  planning_flow_id: string;
  /** Current phase name */
  current_phase: string;
  /** Status of current phase */
  phase_status: string;
  /** Wave plan data (if generated) */
  wave_plan_data?: WavePlanData;
  /** Resource allocation data */
  resource_allocation_data?: any;
  /** Timeline data */
  timeline_data?: any;
  /** Cost estimation data */
  cost_estimation_data?: any;
  /** Progress percentage (0-100) */
  progress_percentage: number;
  /** Warning messages */
  warnings: string[];
}

/**
 * Wave plan data containing all waves.
 */
export interface WavePlanData {
  /** Array of waves */
  waves: Wave[];
  /** Total number of waves */
  total_waves: number;
  /** Additional planning metadata */
  planning_metadata?: Record<string, any>;
}

/**
 * Single wave definition.
 */
export interface Wave {
  /** Wave number (1-based) */
  wave_number: number;
  /** Human-readable wave name */
  wave_name: string;
  /** Number of applications in this wave */
  application_count: number;
  /** Optional start date (ISO format) */
  start_date?: string;
  /** Optional end date (ISO format) */
  end_date?: string;
  /** Wave status */
  status: 'planned' | 'in_progress' | 'completed' | 'blocked';
  /** Optional wave description */
  description?: string;
  /** Optional dependencies on other waves */
  dependencies?: number[];
}

// =============================================================================
// Planning Flow API Client
// =============================================================================

/**
 * API client for Planning Flow endpoints.
 *
 * All methods use HTTP polling (NOT WebSockets) per coding-agent-guide.md.
 * All field names use snake_case to match backend (NO transformation needed).
 */
export class PlanningFlowApiClient {
  /**
   * Initialize a new planning flow through MFO.
   *
   * Flow:
   * 1. Validates applications have 6R strategies assigned
   * 2. Creates master flow in crewai_flow_state_extensions
   * 3. Creates child flow in planning_flows
   * 4. Links via flow_id
   * 5. Starts background planning process
   *
   * Headers (REQUIRED):
   * - X-Client-Account-ID: Client UUID (e.g., 11111111-1111-1111-1111-111111111111)
   * - X-Engagement-ID: Engagement UUID (e.g., 22222222-2222-2222-2222-222222222222)
   *
   * @param request - Planning flow initialization request
   * @returns Planning flow response with IDs
   *
   * @example
   * const result = await planningFlowApi.initializePlanningFlow({
   *   selected_application_ids: ['uuid1', 'uuid2', 'uuid3'],
   *   planning_config: {
   *     max_apps_per_wave: 5,
   *     wave_duration_limit_days: 90
   *   }
   * });
   */
  async initializePlanningFlow(
    request: InitializePlanningFlowRequest
  ): Promise<PlanningFlowResponse> {
    try {
      console.log('Initializing planning flow:', request);

      // CRITICAL: Use request body for POST (NOT query parameters)
      // Per /docs/guidelines/API_REQUEST_PATTERNS.md
      const response = await apiClient.post<PlanningFlowResponse>(
        '/master-flows/planning/initialize',
        request
      );

      return response;
    } catch (error) {
      console.error('Failed to initialize planning flow:', error);
      throw error;
    }
  }

  /**
   * Execute a specific planning phase.
   *
   * Planning phases:
   * - wave_planning: Generate initial wave assignments
   * - resource_allocation: Allocate resources to waves
   * - timeline_generation: Create migration timeline
   * - cost_estimation: Estimate migration costs
   *
   * @param planning_flow_id - Planning flow identifier
   * @param phase - Phase name to execute
   * @param manual_override - Whether to override automatic phase progression
   * @returns Phase execution result
   *
   * @example
   * await planningFlowApi.executePlanningPhase(
   *   'planning-flow-uuid',
   *   'wave_planning'
   * );
   */
  async executePlanningPhase(
    planning_flow_id: string,
    phase: string,
    manual_override: boolean = false
  ): Promise<any> {
    try {
      // CRITICAL: Use request body for POST
      const response = await apiClient.post(
        '/master-flows/planning/execute-phase',
        {
          planning_flow_id,
          phase,
          manual_override,
        }
      );

      return response;
    } catch (error) {
      console.error('Failed to execute planning phase:', error);
      throw error;
    }
  }

  /**
   * Get current status and progress of planning flow.
   *
   * Uses MFO integration to query both:
   * - Master flow (crewai_flow_state_extensions): lifecycle status
   * - Child flow (planning_flows): phase data and operational state
   *
   * @param planning_flow_id - Planning flow identifier
   * @returns Detailed planning status with wave data
   *
   * @example
   * const status = await planningFlowApi.getPlanningStatus('flow-uuid');
   * console.log(`Progress: ${status.progress_percentage}%`);
   * console.log(`Waves: ${status.wave_plan_data?.total_waves}`);
   */
  async getPlanningStatus(planning_flow_id: string): Promise<PlanningStatus> {
    try {
      const response = await apiClient.get<PlanningStatus>(
        `/master-flows/planning/status/${planning_flow_id}`
      );

      return response;
    } catch (error) {
      console.error('Failed to get planning status:', error);
      throw error;
    }
  }

  /**
   * Update wave plan with manual modifications.
   *
   * Allows users to:
   * - Modify wave assignments
   * - Change wave dates
   * - Adjust wave names and descriptions
   * - Reorder applications between waves
   *
   * CRITICAL: Updates planning_flows.wave_plan_data field.
   *
   * @param planning_flow_id - Planning flow identifier
   * @param wave_plan_data - Updated wave plan data
   * @returns Updated planning response
   *
   * @example
   * await planningFlowApi.updateWavePlan('flow-uuid', {
   *   waves: [
   *     {
   *       wave_number: 1,
   *       wave_name: 'Pilot Wave',
   *       applications: ['app1', 'app2'],
   *       status: 'planned'
   *     }
   *   ],
   *   total_waves: 1
   * });
   */
  async updateWavePlan(
    planning_flow_id: string,
    wave_plan_data: WavePlanData
  ): Promise<any> {
    try {
      // CRITICAL: Use request body for PUT (NOT query parameters)
      const response = await apiClient.put(
        '/master-flows/planning/update-wave-plan',
        {
          planning_flow_id,
          wave_plan_data,
        }
      );

      return response;
    } catch (error) {
      console.error('Failed to update wave plan:', error);
      throw error;
    }
  }

  /**
   * Export planning data in various formats.
   *
   * Supported formats:
   * - json: JSON data export
   * - pdf: PDF report
   * - excel: Excel spreadsheet
   *
   * @param planning_flow_id - Planning flow identifier
   * @param format - Export format
   * @returns Exported data (format-dependent)
   *
   * @example
   * const jsonData = await planningFlowApi.exportPlanningData(
   *   'flow-uuid',
   *   'json'
   * );
   */
  async exportPlanningData(
    planning_flow_id: string,
    format: 'json' | 'pdf' | 'excel' = 'json'
  ): Promise<any> {
    try {
      // Use query parameter for GET request (format is read-only filter)
      const response = await apiClient.get(
        `/master-flows/planning/export/${planning_flow_id}?format=${format}`
      );

      return response;
    } catch (error) {
      console.error('Failed to export planning data:', error);
      throw error;
    }
  }
}

// =============================================================================
// Export Singleton Instance
// =============================================================================

/**
 * Singleton instance of Planning Flow API client.
 *
 * Usage:
 * ```typescript
 * import { planningFlowApi } from '@/lib/api/planningFlowService';
 *
 * // Headers are automatically added by apiClient from context
 * // (X-Client-Account-ID, X-Engagement-ID)
 * const result = await planningFlowApi.initializePlanningFlow({
 *   selected_application_ids: ['uuid1', 'uuid2']
 * });
 * ```
 */
export const planningFlowApi = new PlanningFlowApiClient();
