#!/bin/bash

# Collection Gap Analysis Test - Environment Validation Script
# This script validates that the Docker environment is ready for E2E testing
# Generated by CC (Claude Code)

set -e

echo "ðŸ” Validating Test Environment for Collection Gap Analysis E2E Test"
echo "=================================================================="
echo ""

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check 1: Docker is running
echo "ðŸ“¦ Checking Docker daemon..."
if ! docker info > /dev/null 2>&1; then
    echo -e "${RED}âŒ Docker daemon is not running${NC}"
    echo "   Please start Docker Desktop and try again"
    exit 1
fi
echo -e "${GREEN}âœ… Docker daemon is running${NC}"
echo ""

# Check 2: Required containers are running
echo "ðŸ³ Checking Docker containers..."
REQUIRED_CONTAINERS=("migration_backend" "migration_frontend" "migration_postgres")

for container in "${REQUIRED_CONTAINERS[@]}"; do
    if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        STATUS=$(docker ps --format '{{.Names}}\t{{.Status}}' | grep "^${container}" | awk '{print $2, $3}')
        echo -e "${GREEN}âœ… ${container}${NC} - ${STATUS}"
    else
        echo -e "${RED}âŒ ${container}${NC} - NOT RUNNING"
        echo "   Start with: cd config/docker && docker-compose up -d"
        exit 1
    fi
done
echo ""

# Check 3: Frontend is accessible
echo "ðŸŒ Checking frontend accessibility..."
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8081 | grep -q "200\|301\|302"; then
    echo -e "${GREEN}âœ… Frontend is accessible at http://localhost:8081${NC}"
else
    echo -e "${RED}âŒ Frontend is not accessible at http://localhost:8081${NC}"
    echo "   Check frontend logs: docker logs migration_frontend"
    exit 1
fi
echo ""

# Check 4: Backend is accessible
echo "ðŸ”§ Checking backend accessibility..."
if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    HEALTH_STATUS=$(curl -s http://localhost:8000/health | jq -r '.status' 2>/dev/null || echo "unknown")
    echo -e "${GREEN}âœ… Backend is accessible at http://localhost:8000 (status: ${HEALTH_STATUS})${NC}"
else
    echo -e "${RED}âŒ Backend is not accessible at http://localhost:8000${NC}"
    echo "   Check backend logs: docker logs migration_backend"
    exit 1
fi
echo ""

# Check 5: Database is accessible
echo "ðŸ—„ï¸  Checking database accessibility..."
if docker exec migration_postgres psql -U postgres -d migration_db -c "SELECT 1;" > /dev/null 2>&1; then
    echo -e "${GREEN}âœ… Database is accessible${NC}"
else
    echo -e "${RED}âŒ Database is not accessible${NC}"
    echo "   Check postgres logs: docker logs migration_postgres"
    exit 1
fi
echo ""

# Check 6: Verify collection_data_gaps table exists
echo "ðŸ“Š Checking collection_data_gaps table..."
TABLE_EXISTS=$(docker exec migration_postgres psql -U postgres -d migration_db -t -c \
    "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = 'migration' AND table_name = 'collection_data_gaps');" \
    | xargs)

if [ "$TABLE_EXISTS" = "t" ]; then
    ROW_COUNT=$(docker exec migration_postgres psql -U postgres -d migration_db -t -c \
        "SELECT COUNT(*) FROM migration.collection_data_gaps;" | xargs)
    echo -e "${GREEN}âœ… collection_data_gaps table exists${NC} (${ROW_COUNT} rows)"
else
    echo -e "${YELLOW}âš ï¸  collection_data_gaps table does not exist${NC}"
    echo "   This may be expected if migrations haven't run yet"
fi
echo ""

# Check 7: Verify assets exist for selection
echo "ðŸ¢ Checking available assets..."
ASSET_COUNT=$(docker exec migration_postgres psql -U postgres -d migration_db -t -c \
    "SELECT COUNT(*) FROM migration.assets WHERE is_deleted = false;" 2>/dev/null | xargs || echo "0")

if [ "$ASSET_COUNT" -gt 0 ]; then
    echo -e "${GREEN}âœ… ${ASSET_COUNT} assets available for testing${NC}"
else
    echo -e "${YELLOW}âš ï¸  No assets found in database${NC}"
    echo "   Test may fail during asset selection phase"
    echo "   Consider seeding test data before running E2E tests"
fi
echo ""

# Check 8: Check for incomplete collection flows
echo "ðŸ”„ Checking for incomplete collection flows..."
INCOMPLETE_COUNT=$(docker exec migration_postgres psql -U postgres -d migration_db -t -c \
    "SELECT COUNT(*) FROM migration.collection_flows WHERE status NOT IN ('completed', 'failed', 'cancelled');" \
    2>/dev/null | xargs || echo "0")

if [ "$INCOMPLETE_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  ${INCOMPLETE_COUNT} incomplete collection flow(s) found${NC}"
    echo "   These will be cleaned up automatically by the test"
else
    echo -e "${GREEN}âœ… No incomplete flows (clean state)${NC}"
fi
echo ""

# Check 9: Playwright dependencies
echo "ðŸŽ­ Checking Playwright installation..."
if command -v npx > /dev/null 2>&1; then
    echo -e "${GREEN}âœ… npx is available${NC}"

    # Check if playwright is installed
    if npx playwright --version > /dev/null 2>&1; then
        PW_VERSION=$(npx playwright --version | awk '{print $2}')
        echo -e "${GREEN}âœ… Playwright is installed (version: ${PW_VERSION})${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Playwright is not installed${NC}"
        echo "   Install with: npx playwright install"
    fi
else
    echo -e "${RED}âŒ npx is not available${NC}"
    echo "   Install Node.js and npm first"
    exit 1
fi
echo ""

# Check 10: Test artifacts directory
echo "ðŸ“ Checking test artifacts directory..."
if [ -d "test-results" ]; then
    echo -e "${GREEN}âœ… test-results directory exists${NC}"
else
    echo -e "${YELLOW}âš ï¸  test-results directory does not exist (will be created automatically)${NC}"
fi
echo ""

# Summary
echo "=================================================================="
echo -e "${GREEN}âœ… Environment validation complete!${NC}"
echo ""
echo "ðŸ“ Next steps:"
echo "   1. Run the test:"
echo "      npx playwright test tests/e2e/collection-gap-analysis-new.spec.ts --headed"
echo ""
echo "   2. Or run with UI mode:"
echo "      npx playwright test tests/e2e/collection-gap-analysis-new.spec.ts --ui"
echo ""
echo "   3. Or run with debugging:"
echo "      npx playwright test tests/e2e/collection-gap-analysis-new.spec.ts --debug"
echo ""
echo "   4. View results after test:"
echo "      npx playwright show-report"
echo ""

# Optional: Show recent backend logs
echo "ðŸ“‹ Recent backend logs (last 5 lines):"
docker logs migration_backend --tail 5 2>&1 | sed 's/^/   /'
echo ""

exit 0
