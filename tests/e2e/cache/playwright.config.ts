/**
 * Playwright Configuration for Cache Testing
 *
 * Specialized configuration for comprehensive cache testing including:
 * - Performance benchmarking settings
 * - Security testing configurations
 * - Multi-browser cache validation
 * - Parallel execution optimization
 * - Test reporting and artifacts
 *
 * Generated by CC (Claude Code)
 */

import { defineConfig, devices } from '@playwright/test';
import path from 'path';

export default defineConfig({
  // Test directory
  testDir: '.',

  // Global test timeout
  timeout: 60000, // 60 seconds for cache tests

  // Test configuration
  fullyParallel: false, // Cache tests may interfere with each other
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 1,
  workers: process.env.CI ? 2 : 3, // Limited workers to avoid cache conflicts

  // Reporting
  reporter: [
    ['html', {
      outputFolder: 'cache-test-results',
      open: process.env.CI ? 'never' : 'on-failure'
    }],
    ['json', { outputFile: 'cache-test-results.json' }],
    ['junit', { outputFile: 'cache-junit-results.xml' }],
    ['line']
  ],

  // Global test settings
  use: {
    // Base URL for the application
    baseURL: process.env.TEST_URL || 'http://localhost:3000',

    // Browser settings optimized for cache testing
    headless: process.env.CI ? true : false,
    viewport: { width: 1280, height: 720 },
    ignoreHTTPSErrors: true,

    // Performance testing settings
    launchOptions: {
      slowMo: process.env.SLOW_MO ? parseInt(process.env.SLOW_MO) : 0,
    },

    // Request/response tracking for cache analysis
    trace: 'retain-on-failure',
    video: 'retain-on-failure',
    screenshot: 'only-on-failure',

    // Extra HTTP headers for cache testing
    extraHTTPHeaders: {
      'X-Test-Mode': 'cache-testing',
      'Accept': 'application/json',
    },

    // Action timeout for cache operations
    actionTimeout: 15000,
    navigationTimeout: 30000,
  },

  // Test projects for different scenarios
  projects: [
    // Desktop Chrome - Primary cache testing
    {
      name: 'cache-chrome',
      use: {
        ...devices['Desktop Chrome'],
        contextOptions: {
          // Disable browser cache to test server-side caching only
          extraHTTPHeaders: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache',
          }
        }
      },
      testMatch: ['cache-operations.spec.ts', 'performance.spec.ts'],
    },

    // Desktop Firefox - Cross-browser cache validation
    {
      name: 'cache-firefox',
      use: {
        ...devices['Desktop Firefox'],
      },
      testMatch: ['cache-operations.spec.ts'],
    },

    // Security testing with Chrome
    {
      name: 'cache-security',
      use: {
        ...devices['Desktop Chrome'],
        contextOptions: {
          // Isolate security tests
          permissions: [],
        }
      },
      testMatch: ['security.spec.ts'],
    },

    // WebSocket cache events testing
    {
      name: 'cache-websocket',
      use: {
        ...devices['Desktop Chrome'],
        launchOptions: {
          args: [
            '--enable-web-socket',
            '--allow-running-insecure-content'
          ]
        }
      },
      testMatch: ['websocket-cache.spec.ts'],
    },

    // Integration testing
    {
      name: 'cache-integration',
      use: {
        ...devices['Desktop Chrome'],
      },
      testMatch: ['integration.spec.ts'],
    },

    // Mobile testing for cache performance
    {
      name: 'cache-mobile',
      use: {
        ...devices['iPhone 12'],
      },
      testMatch: ['performance.spec.ts'],
    },

    // Performance testing with network throttling
    {
      name: 'cache-performance-slow',
      use: {
        ...devices['Desktop Chrome'],
        launchOptions: {
          args: [
            '--enable-features=NetworkService',
            '--force-effective-connection-type=slow-2g'
          ]
        }
      },
      testMatch: ['performance.spec.ts'],
    },
  ],

  // Web server for testing
  webServer: {
    command: process.env.CI
      ? 'npm run build && npm run preview'
      : 'npm run dev',
    port: 3000,
    reuseExistingServer: !process.env.CI,
    timeout: 120000, // 2 minutes for server startup
    env: {
      // Environment variables for cache testing
      REDIS_ENABLED: 'true',
      CACHE_ANALYTICS_ENABLED: 'true',
      TEST_MODE: 'true',
    }
  },

  // Global setup and teardown
  globalSetup: path.resolve(__dirname, 'global-setup.ts'),
  globalTeardown: path.resolve(__dirname, 'global-teardown.ts'),

  // Test metadata
  metadata: {
    testType: 'cache-validation',
    environment: process.env.NODE_ENV || 'test',
    buildId: process.env.BUILD_ID || 'local',
  },

  // Expect settings for cache testing
  expect: {
    // Performance assertions
    timeout: 10000,

    // Custom matchers for cache testing
    toHaveValidCacheHeaders: async (response) => {
      const headers = response.headers();
      const hasETag = 'etag' in headers;
      const hasCacheControl = 'cache-control' in headers;
      const hasVary = 'vary' in headers;

      return {
        pass: hasETag && hasCacheControl,
        message: () => `Expected response to have cache headers. Has ETag: ${hasETag}, Has Cache-Control: ${hasCacheControl}, Has Vary: ${hasVary}`
      };
    },

    toBeWithinPerformanceThreshold: async (actualTime, expectedTime, threshold = 0.1) => {
      const withinThreshold = Math.abs(actualTime - expectedTime) / expectedTime <= threshold;
      return {
        pass: withinThreshold,
        message: () => `Expected ${actualTime}ms to be within ${threshold * 100}% of ${expectedTime}ms`
      };
    }
  },
});

// Performance test configuration
export const performanceConfig = {
  // API call reduction target
  apiCallReductionTarget: 0.7, // 70%

  // Page load improvement target
  pageLoadImprovementTarget: 0.5, // 50%

  // Cache response time target
  cacheResponseTimeTarget: 50, // 50ms

  // Cache hit ratio target
  cacheHitRatioTarget: 0.8, // 80%

  // Concurrent users for load testing
  concurrentUsers: 10,

  // Test duration for sustained load
  loadTestDuration: 30000, // 30 seconds
};

// Security test configuration
export const securityConfig = {
  // Tenant isolation test accounts
  tenantAccounts: [
    { email: 'tenant1@company1.com', clientId: 'client-1' },
    { email: 'tenant2@company2.com', clientId: 'client-2' },
    { email: 'tenant3@company3.com', clientId: 'client-3' },
  ],

  // Malicious payloads for cache poisoning tests
  maliciousPayloads: [
    { user: { id: 'admin', role: 'super_admin' } },
    { script: '<script>alert("xss")</script>' },
    { sql: "'; DROP TABLE users; --" },
  ],

  // Admin endpoints to test for unauthorized access
  adminEndpoints: [
    '/api/v1/admin/cache/clear',
    '/api/v1/admin/cache/keys',
    '/api/v1/admin/cache/stats',
    '/api/v1/admin/cache/inspect/{key}',
  ],
};

// WebSocket test configuration
export const websocketConfig = {
  // Connection timeout
  connectionTimeout: 5000,

  // Event types to test
  eventTypes: [
    'cache_invalidation',
    'user_context_changed',
    'field_mappings_updated',
    'flow_state_changed',
    'engagement_modified',
  ],

  // Keep-alive settings
  pingInterval: 30000, // 30 seconds
  pongTimeout: 5000, // 5 seconds
};

// Test environment validation
if (!process.env.TEST_URL && !process.env.CI) {
  console.warn('TEST_URL not set, using default http://localhost:3000');
}

if (process.env.CI && !process.env.ADMIN_TOKEN) {
  console.warn('ADMIN_TOKEN not set for CI environment - admin tests may fail');
}
