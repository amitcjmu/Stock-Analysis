/**
 * Global Setup for Cache Tests
 *
 * Prepares the test environment for comprehensive cache testing including:
 * - Redis connection validation
 * - Test data preparation
 * - Authentication setup
 * - Performance baseline establishment
 *
 * Generated by CC (Claude Code)
 */

import { chromium, FullConfig } from '@playwright/test';

async function globalSetup(config: FullConfig) {
  console.log('üöÄ Setting up cache test environment...');

  const browser = await chromium.launch();
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // Wait for server to be ready
    const baseURL = config.projects[0].use.baseURL || 'http://localhost:3000';
    console.log(`Waiting for server at ${baseURL}...`);

    await page.goto(baseURL, { timeout: 60000 });
    console.log('‚úÖ Server is ready');

    // Validate Redis connection
    try {
      const healthResponse = await page.request.get('/api/v1/health');
      if (healthResponse.ok()) {
        const health = await healthResponse.json();
        if (health.redis?.status === 'healthy') {
          console.log('‚úÖ Redis connection validated');
        } else {
          console.warn('‚ö†Ô∏è  Redis may not be available - tests will run in degraded mode');
        }
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è  Health check failed - continuing with tests');
    }

    // Clear any existing test data/cache
    try {
      await page.request.post('/api/v1/admin/cache/clear', {
        headers: { 'X-Admin-Token': process.env.ADMIN_TOKEN || 'test-admin-token' },
        data: { reason: 'test-setup', force: true }
      });
      console.log('‚úÖ Cache cleared for testing');
    } catch (error) {
      console.warn('‚ö†Ô∏è  Could not clear cache - may not affect tests');
    }

    // Set up test authentication
    try {
      await page.goto('/login');
      await page.fill('[data-testid="email-input"]', 'demo@example.com');
      await page.fill('[data-testid="password-input"]', 'demo123');
      await page.click('[data-testid="login-button"]');
      await page.waitForURL('**/dashboard', { timeout: 10000 });

      // Store authentication state
      await context.storageState({ path: 'tests/auth/cache-test-user.json' });
      console.log('‚úÖ Test authentication setup complete');
    } catch (error) {
      console.warn('‚ö†Ô∏è  Authentication setup failed - tests may need to handle login');
    }

    // Establish performance baseline
    try {
      const startTime = Date.now();
      await page.goto('/dashboard');
      await page.waitForLoadState('networkidle');
      const baselineLoadTime = Date.now() - startTime;

      // Store baseline metrics
      process.env.BASELINE_LOAD_TIME = baselineLoadTime.toString();
      console.log(`‚úÖ Baseline page load time: ${baselineLoadTime}ms`);
    } catch (error) {
      console.warn('‚ö†Ô∏è  Could not establish performance baseline');
    }

    // Validate critical endpoints
    const criticalEndpoints = [
      '/api/v1/context/me',
      '/api/v1/cached-context/me',
      '/api/v1/cached-context/clients',
    ];

    let endpointIssues = 0;
    for (const endpoint of criticalEndpoints) {
      try {
        const response = await page.request.get(endpoint, {
          headers: { 'X-Client-Account-ID': 'demo-client' }
        });
        if (response.ok()) {
          console.log(`‚úÖ Endpoint validated: ${endpoint}`);
        } else {
          console.warn(`‚ö†Ô∏è  Endpoint issue: ${endpoint} (${response.status()})`);
          endpointIssues++;
        }
      } catch (error) {
        console.warn(`‚ö†Ô∏è  Endpoint error: ${endpoint}`);
        endpointIssues++;
      }
    }

    if (endpointIssues === 0) {
      console.log('‚úÖ All critical endpoints validated');
    } else {
      console.warn(`‚ö†Ô∏è  ${endpointIssues} endpoint issues detected`);
    }

    // Set up WebSocket connection validation
    try {
      const wsConnected = await page.evaluate(() => {
        return new Promise((resolve) => {
          const ws = new WebSocket('ws://localhost:3000/api/v1/ws-cache/events?client_account_id=demo-client&token=demo-token');
          ws.onopen = () => {
            ws.close();
            resolve(true);
          };
          ws.onerror = () => resolve(false);
          setTimeout(() => resolve(false), 5000);
        });
      });

      if (wsConnected) {
        console.log('‚úÖ WebSocket connection validated');
      } else {
        console.warn('‚ö†Ô∏è  WebSocket connection may not be available');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è  WebSocket validation failed');
    }

    console.log('üéØ Cache test environment setup complete!');

  } catch (error) {
    console.error('‚ùå Global setup failed:', error);
    throw error;
  } finally {
    await browser.close();
  }
}

export default globalSetup;
