# AI Migration Orchestrator E2E Test Suite

Comprehensive end-to-end testing for the AI-powered Migration Orchestrator application with Playwright.

Generated by CC

## Overview

This test suite provides comprehensive coverage of the three main application flows:

- **Discovery Flow** - Complete data discovery workflow from CSV upload to asset inventory creation
- **Collection Flow** - Adaptive forms, automated collection, and gap analysis workflows
- **Assessment Flow** - Risk assessment and modernization recommendations using 6R strategies

## Test Coverage

### Discovery Flow Tests (`discovery-flow-e2e.spec.ts`)
- ✅ Complete workflow from login to asset inventory
- ✅ File upload and processing validation
- ✅ Field mapping configuration and validation
- ✅ Data cleansing phase completion
- ✅ Asset inventory creation and verification
- ✅ Flow completion status and new flow capability
- ✅ Error handling for invalid files and network failures
- ✅ Data persistence across browser sessions
- ✅ Performance benchmarking and loading states
- ✅ Persistent agent verification (ADR-015 compliance)

### Collection Flow Tests (`collection-flow-e2e.spec.ts`)
- ✅ Adaptive forms workflow and validation
- ✅ Automated collection monitoring
- ✅ Gap analysis accuracy and completeness
- ✅ Multiple rows issue regression testing (HTTP 500 fix)
- ✅ Form validation and data integrity checks
- ✅ Error recovery and network resilience
- ✅ Database constraint violation prevention
- ✅ Persistent agent integration testing

### Assessment Flow Tests (`assessment-flow-e2e.spec.ts`)
- ✅ Application selection and validation
- ✅ Risk assessment calculation accuracy
- ✅ 6R strategy recommendations (Rehost, Refactor, Replatform, etc.)
- ✅ Recommendation quality and confidence scoring
- ✅ Report generation capabilities
- ✅ Error handling for edge cases and invalid inputs
- ✅ Performance testing with large datasets
- ✅ Assessment flow completion verification

## Prerequisites

1. **Docker Environment**: Application containers must be running
   ```bash
   docker-compose up -d
   ```

2. **Service Accessibility**:
   - Frontend: http://localhost:8081
   - Backend: http://localhost:8000

3. **Node Dependencies**:
   ```bash
   npm install
   npx playwright install
   ```

## Running Tests

### Quick Start - Run All Tests
```bash
./tests/e2e/run-comprehensive-tests.sh
```

### Run Individual Test Suites
```bash
# Discovery Flow only
./tests/e2e/run-comprehensive-tests.sh discovery

# Collection Flow only
./tests/e2e/run-comprehensive-tests.sh collection

# Assessment Flow only
./tests/e2e/run-comprehensive-tests.sh assessment
```

### Manual Test Execution
```bash
# Run with HTML reporter
npx playwright test tests/e2e/discovery-flow-e2e.spec.ts --reporter=html

# Run in headed mode for debugging
npx playwright test tests/e2e/collection-flow-e2e.spec.ts --headed

# Run specific test by name
npx playwright test -g "Complete Assessment Flow - Happy Path"
```

## Test Data and Fixtures

### Automatic Test Data Generation
- CSV files with realistic asset data are generated dynamically
- Test applications for assessment loaded from `fixtures/assessment-test-applications.json`
- Enterprise CMDB data available in `fixtures/enterprise-cmdb-data.csv`

### Test Data Locations
```
tests/
├── e2e/
│   ├── test-data/           # Generated test files (auto-cleanup)
│   ├── screenshots/         # Test failure screenshots
│   └── test-results/        # HTML reports and artifacts
└── fixtures/
    ├── test-discovery-data.csv
    ├── enterprise-cmdb-data.csv
    └── assessment-test-applications.json
```

## Test Results and Artifacts

### Generated Artifacts
- **Screenshots**: Captured at key workflow points and on test failures
- **HTML Reports**: Detailed test execution reports with timelines
- **Console Logs**: Comprehensive error tracking and network monitoring
- **Performance Metrics**: Load times and response benchmarks

### Accessing Results
```bash
# View HTML reports
open tests/e2e/test-results/index.html

# View screenshots
ls tests/e2e/screenshots/

# Check test logs
cat tests/e2e/test-results/test-info.json
```

## Key Features

### Persistent Agent Testing (ADR-015)
Tests verify that the system properly uses persistent agents without fallback patterns:
- Agent pool initialization verification
- Tenant isolation validation
- No fallback to service patterns
- Proper error handling when agents unavailable

### Bug Regression Testing
- **Discovery Flow Completion**: Ensures flows are properly marked as completed
- **Multiple Rows Issue**: Validates the HTTP 500 collection API fix
- **Field Mapping**: Tests the field mapping trigger fix
- **Flow State Bridge**: Verifies data format compatibility fixes

### Error Scenario Coverage
- Network failures and retry mechanisms
- Invalid data handling and validation
- Browser session persistence
- Performance under load
- Edge case input validation

## Configuration

### Environment Variables
```bash
export BASE_URL="http://localhost:8081"  # Frontend URL
export API_URL="http://localhost:8000"   # Backend API URL
```

### Playwright Configuration
Test configuration in `playwright.config.ts`:
- Timeout: 30 seconds per test
- Retries: 1 retry on failure in CI
- Workers: 1 for consistency
- Browsers: Chrome, Firefox, Safari

### Test Helper Configuration
`helpers/test-helpers.ts` provides:
- Standardized login procedures
- Navigation helpers for each flow
- File upload utilities
- Screenshot capture
- Error monitoring
- Agent verification

## Troubleshooting

### Common Issues

**Docker Containers Not Running**
```bash
docker-compose up -d
# Wait for services to be healthy
docker-compose ps
```

**Frontend/Backend Not Accessible**
```bash
# Check service health
curl http://localhost:8081/health
curl http://localhost:8000/health

# Check container logs
docker-compose logs frontend
docker-compose logs backend
```

**Test Timeout Issues**
```bash
# Increase timeout in playwright.config.ts
timeout: 60 * 1000  # 60 seconds

# Or run with longer timeout
npx playwright test --timeout=60000
```

**Persistent Agent Issues**
```bash
# Verify ADR-015 compliance
python backend/test_adr015_no_fallback.py

# Test agent pool creation
python backend/test_persistent_agents_fix.py
```

### Debug Mode
```bash
# Run tests with debug info
DEBUG=1 ./tests/e2e/run-comprehensive-tests.sh

# Run single test with full debugging
npx playwright test tests/e2e/discovery-flow-e2e.spec.ts --debug
```

## Performance Benchmarks

### Expected Performance
- **Navigation**: < 10 seconds per page
- **File Upload**: < 15 seconds for test CSV files
- **Assessment Calculation**: < 20 seconds
- **Flow Completion**: < 60 seconds end-to-end

### Load Testing
Tests validate performance with:
- 15+ asset records for discovery
- Multiple form submissions for collection
- Complex assessment scenarios
- Large dataset simulations

## Best Practices

### Test Isolation
- Each test creates fresh test data
- Browser context is cleaned between tests
- Tests can run in parallel (configured for 1 worker for stability)

### Error Handling
- Comprehensive console error monitoring
- Network error tracking with response bodies
- Screenshot capture on failures
- Graceful fallbacks for missing UI elements

### Maintainability
- Centralized test helpers and utilities
- Page object model for common operations
- Configurable timeouts and retry logic
- Clear test documentation and logging

## Contributing

When adding new tests:

1. **Use Test Helpers**: Leverage existing utilities in `test-helpers.ts`
2. **Add Screenshots**: Capture screenshots at key verification points
3. **Monitor Errors**: Track both console and network errors
4. **Test Edge Cases**: Include error scenarios and invalid inputs
5. **Document Changes**: Update this README with new test coverage

### Test Structure Template
```typescript
test('New Feature Test', async ({ page }) => {
  console.log('\\n=== TEST DESCRIPTION ===');

  // Setup
  await login(page, TEST_USERS.demo);

  // Test steps with logging
  console.log('Step 1: Action description');
  await takeScreenshot(page, 'step-name');

  // Assertions
  expect(result).toBeTruthy();

  // Cleanup handled automatically
});
```

## Support

For test-related issues:
1. Check the HTML reports for detailed failure information
2. Review screenshots for UI state at failure
3. Examine console logs for JavaScript errors
4. Verify Docker containers are healthy
5. Ensure database migrations are current

The test suite is designed to be reliable and maintainable, providing confidence in the application's core functionality across all major workflows.
